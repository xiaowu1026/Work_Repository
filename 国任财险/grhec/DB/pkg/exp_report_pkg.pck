CREATE OR REPLACE PACKAGE exp_report_pkg IS

  -- Author  : BOBO
  -- Created : 2009-5-19 14:20:42
  -- Purpose :

  --Ver:1.14
  --2009.08.19 By bobo
  --for mantis:0025672: 报销单类型定义显示字段自审核和可支付标志，并对报销单保存逻辑做相应修改
  --及其他一些逻辑修正

  --Ver: 1.24
  --2009.09.15 By bobo
  --for mantis:[HEC标准产品项目 0026206]: 增加费用报销反冲的事件

  --Ver:1.20
  --Modify by bobo 0026376: 在报销单和申请单头上增加来源字段 SOURCE_TYPE='MANUAL'

  --Ver:1.35
  --Modify by Razgriz @2009-10-12
  --for mantis:0026630 报销单审核时需更新对应预付款核销记录的核销日期及汇率

  --Ver:1.40
  --Modify by zhanglei 2009-11-12
  --删除报销单是增加调用删除工作流

  --Ver:1.45
  --Modify by Razgriz @2010-01-14
  --增加函数exists_unwrite_off_amount
  --判断报销单是否未完全核销并且报销单收款方存在未完全核销的预付款

  --Ver:1.49
  --Modify by zhanglei @2010-01-28
  --插入exp_document_histories统一调用exp_document_history_pkg.insert_exp_document_histories。 operation_code统一使用exp_document_history_pkg中预设的常量

  --Ver:1.51
  --Modify by Bobo 2010.02.23 Mantis:0028818: 费用报销单审核时添加核销预付款的头事件
  --audit_exp_report过程中，增加事件触发：EXP_REPORT_POST_AUDIT_PREPAYMENT_EXPENSE_REPORT

  --Ver:1.52
  --Modify by Bobo 2010.03.08 Mantis:0028970
  --修改reverse_exp_requisitions过程

  --Ver:1.74
  --Modify by ZhouHao 2011年12月15日 12:54:49
  --修改 exp_write_off_prepayment 过程，添加了本次核销金额超过未核销金额的判断处理

  --ver:1.76
  --Modify by ZhouHao 2012年4月6日 09:39:46
  --修改了 update_exp_report_accounts 过程，添加了EXP_REPORT_JE_LINE_UPDATE_ACCOUNT 事件的触发，用于凭证行上的科目更新时候触发科目段相关程序

  --ver:1.77
  --Modify by Robin 2012年4月16日
  --报销单行表添加了四个字段，添加insert update 操作的参数，并修改自动生成计划付款行的逻辑。

  --ver:1.78
  --Modify by ldd 2012年6月8日
  --修改报销单计划付款行insert update delete操作，取消自动生成计划付款行的逻辑。

  --ver:1.78
  --Modify by ldd 2012年8月2日
  --修改报销单反冲重新新生成凭证逻辑，新建过程reverse_exp_rep_pay_accounts，修改过程reverse_exp_report_accounts，reverse_exp_report_dists，reverse_report_pmt_schedules。

  --ver:1.79
  --Modify by sqh 2013年2月25日
  --计划付款行添加默认现金流量项字段
  --若不作为segment段，则需要在exp_report_pmt_schedule表中，增加现金流量项字段cash_flow_code。根据计划付款行上所填付款用途usedes_code,从csh_default_flowitems表中，默认出现金流量项值。前台费用报销单创建/维护/查询页面，现金流量项字段隐藏。

  --ver:1.80
  --Modify by sqh 2013年2月25日
  --增加 update_exp_rep_pmt_sch_adjust 报销单凭证调整时候 维护计划付款行的现金流量项

  --ver:1.81
  --Modify by sqh 2013年3月12日
  --修改 create_exp_rep_pmt_schedule  报销单创建页面，如果报销单头上收款方没有银行账号，或报销单没有配置付款用途，导致保存后不能自动生成计划付款行，需要更改为生成计划付款行，未配置值字段为空即可

  --ver:1.82
  --Modify by sqh 2013年3月18日
  --添加：write_off_check_status  报销单核销借款时 判断单据状态 防止并发操作

  --ver:1.83
  --Modify  by sqh 2013年4月1日
  --添加：update_exp_rep_pmt_sch_bank  计划付款行可以维护银行等信息  计划付款行上加个按钮“账户修改”，放在“冻结”后面。点击后单独弹出小窗口，可手工调整“账号

  c_exp_report      CONSTANT VARCHAR2(30) := 'EXP_REPORT';
  c_acc_costs       CONSTANT VARCHAR2(30) := 'EXP_REPORT'; --住宿费用
  c_transport_costs CONSTANT VARCHAR2(30) := 'EXP_REPORT'; --交通费用
  /*c_exp_report CONSTANT VARCHAR2(30) := 'EXP_REPORT';
  c_exp_report CONSTANT VARCHAR2(30) := 'EXP_REPORT';
  c_exp_report CONSTANT VARCHAR2(30) := 'EXP_REPORT';*/

  c_exp_report_rt_account_sc CONSTANT VARCHAR2(30) := 'EXPENSE_REPORT_ROLL_OUT'; --报销单转出凭证来源代码

  FUNCTION get_exp_report_header_id RETURN NUMBER;

  FUNCTION get_exp_report_line_id RETURN NUMBER;

  FUNCTION get_exp_report_dists_id RETURN NUMBER;

  FUNCTION get_payment_schedule_line_id RETURN NUMBER;

  FUNCTION get_document_id(p_exp_report_line_id NUMBER) RETURN NUMBER;

  FUNCTION get_exp_report_number(p_document_type     VARCHAR2,
                                 p_company_id        NUMBER,
                                 p_operation_unit_id NUMBER,
                                 p_operation_date    DATE,
                                 p_created_by        NUMBER) RETURN VARCHAR2;

  --获取起始行号、步长
  PROCEDURE get_line_number(p_expense_report_type_id NUMBER,
                            p_line_number_beginning  OUT NUMBER,
                            p_step_length            OUT NUMBER);

  --计划付款行号
  FUNCTION get_schedule_line_number(p_exp_report_header_id NUMBER)
    RETURN NUMBER;

  FUNCTION get_expense_budget_item_id(p_expense_item_id NUMBER) RETURN NUMBER;

  FUNCTION get_partner_type_id(p_partner_category VARCHAR2,
                               p_company_id       NUMBER,
                               p_partner_id       NUMBER) RETURN NUMBER;

  -- 检查所勾选的报销单计划付款行上是否存在未核销的借款
  PROCEDURE check_pmt_schedule_ln_unwf_amt(p_exp_report_head_id NUMBER,
                                           p_check_flag         OUT VARCHAR2);

  --检查当前的计划付款行的收款方是否有未核销的借款

  FUNCTION check_pmt_schedule_ln_unwf_fun(p_payment_schedule_line_id NUMBER,
                                          p_company_id               NUMBER)
    RETURN VARCHAR2;

  PROCEDURE report_pmt_schedules_check(p_exp_report_header_id NUMBER,
                                       p_user_id              NUMBER);
  --是否调整报销单
  FUNCTION get_report_tye_adjustment(p_exp_report_type_id NUMBER)
    RETURN VARCHAR2;

  --数字正负校验
  PROCEDURE sign_check(p_exp_report_type_id NUMBER,
                       p_number             NUMBER,
                       p_user_id            NUMBER);

  --并发校验
  FUNCTION update_status_check(p_exp_report_header_id NUMBER,
                               p_user_id              NUMBER) RETURN VARCHAR2;

  PROCEDURE insert_exp_report_headers(p_exp_report_header_id NUMBER,
                                      p_company_id           NUMBER,
                                      --p_operation_unit_id        number,
                                      --p_exp_report_number  varchar2,
                                      p_exp_report_barcode VARCHAR2,
                                      p_employee_id        NUMBER,
                                      p_position_id        NUMBER,
                                      --p_unit_id                  number,
                                      p_payee_category          VARCHAR2,
                                      p_payee_id                NUMBER,
                                      p_exp_report_type_id      NUMBER,
                                      p_expense_user_group_id   NUMBER,
                                      p_currency_code           VARCHAR2,
                                      p_exchange_rate_type      VARCHAR2,
                                      p_exchange_rate_quotation VARCHAR2,
                                      p_exchange_rate           NUMBER,
                                      p_report_date             DATE,
                                      p_period_name             VARCHAR2,
                                      p_report_status           VARCHAR2,
                                      --p_je_creation_status       varchar2 default 'N',
                                      --p_audit_flag               varchar2 default 'N',
                                      --p_audit_date               date,
                                      p_gld_interface_flag          VARCHAR2 DEFAULT 'N',
                                      p_attachment_num              NUMBER,
                                      p_description                 VARCHAR2,
                                      p_write_off_status            VARCHAR2 DEFAULT 'N',
                                      p_write_off_completed_date    DATE,
                                      p_reversed_flag               VARCHAR2,
                                      p_source_exp_rep_header_id    NUMBER,
                                      p_created_by                  NUMBER,
                                      p_operation_date              DATE DEFAULT NULL,
                                      p_source_type                 VARCHAR2 DEFAULT 'MANUAL',
                                      p_payment_method_id           NUMBER,
                                      p_vat_special_invoice_include VARCHAR2 DEFAULT NULL,
                                      p_consistent_invoice_amount   VARCHAR2 DEFAULT 'N',
                                      p_pay_company_id              VARCHAR2 DEFAULT NULL,
                                      p_contract_header_id          NUMBER DEFAULT NULL,
                                      p_associated_oasign           VARCHAR2 DEFAULT NULL,
                                      p_metting_type_code           VARCHAR2 DEFAULT NULL,
                                      p_special_situation           VARCHAR2 DEFAULT NULL);

  PROCEDURE update_exp_report_headers(p_exp_report_header_id NUMBER,
                                      p_exp_report_barcode   VARCHAR2,
                                      p_employee_id          NUMBER,
                                      p_position_id          NUMBER,
                                      --p_unit_id                  number,
                                      p_payee_category        VARCHAR2,
                                      p_payee_id              NUMBER,
                                      p_exp_report_type_id    NUMBER,
                                      p_expense_user_group_id NUMBER,
                                      p_report_date           DATE,
                                      p_period_name           VARCHAR2,
                                      p_report_status         VARCHAR2,
                                      --p_je_creation_status       varchar2,
                                      --p_audit_flag               varchar2,
                                      --p_audit_date               date,
                                      p_gld_interface_flag          VARCHAR2,
                                      p_attachment_num              NUMBER,
                                      p_description                 VARCHAR2,
                                      p_write_off_status            VARCHAR2,
                                      p_write_off_completed_date    DATE,
                                      p_reversed_flag               VARCHAR2,
                                      p_source_exp_rep_header_id    NUMBER,
                                      p_last_updated_by             NUMBER,
                                      p_source_type                 VARCHAR2 DEFAULT 'MANUAL',
                                      p_payment_method_id           NUMBER,
                                      p_user_id                     NUMBER,
                                      p_vat_special_invoice_include VARCHAR2 DEFAULT NULL,
                                      p_consistent_invoice_amount   VARCHAR2 DEFAULT 'N',
                                      p_pay_company_id              VARCHAR2 DEFAULT NULL,
                                      p_contract_header_id          NUMBER DEFAULT NULL,
                                      p_associated_oasign           VARCHAR2 DEFAULT NULL,
                                      p_metting_type_code           VARCHAR2 DEFAULT NULL,
                                      p_special_situation           VARCHAR2 DEFAULT NULL);

  PROCEDURE delete_exp_report_headers(p_exp_report_header_id NUMBER,
                                      p_created_by           NUMBER);

  -->> 1.0 Modify Tagin/2015.06.17 增加交通工具
  PROCEDURE insert_exp_report_lines(p_exp_report_header_id     NUMBER,
                                    p_line_number              NUMBER,
                                    p_city                     VARCHAR2,
                                    p_description              VARCHAR2,
                                    p_date_from                DATE,
                                    p_date_to                  DATE,
                                    p_period_name              VARCHAR2,
                                    p_currency_code            VARCHAR2,
                                    p_exchange_rate_type       VARCHAR2,
                                    p_exchange_rate_quotation  VARCHAR2,
                                    p_exchange_rate            NUMBER,
                                    p_expense_type_id          NUMBER,
                                    p_expense_item_id          NUMBER,
                                    p_budget_item_id           NUMBER,
                                    p_price                    NUMBER,
                                    p_primary_quantity         NUMBER,
                                    p_primary_uom              VARCHAR2,
                                    p_secondary_quantity       NUMBER,
                                    p_secondary_uom            VARCHAR2,
                                    p_report_amount            NUMBER,
                                    p_report_functional_amount NUMBER,
                                    p_distribution_set_id      NUMBER,
                                    p_company_id               NUMBER,
                                    p_unit_id                  NUMBER,
                                    p_position_id              NUMBER,
                                    p_responsibility_center_id NUMBER,
                                    p_employee_id              NUMBER,
                                    p_payee_category           VARCHAR2,
                                    p_payee_id                 NUMBER,
                                    p_partner_id               NUMBER,
                                    p_payment_flag             VARCHAR2,
                                    p_report_status            VARCHAR2,
                                    p_write_off_status         VARCHAR2,
                                    p_write_off_comleted_date  DATE,
                                    p_attachment_num           NUMBER,
                                    p_dimension1_id            NUMBER,
                                    p_dimension2_id            NUMBER,
                                    p_dimension3_id            NUMBER,
                                    p_dimension4_id            NUMBER,
                                    p_dimension5_id            NUMBER,
                                    p_dimension6_id            NUMBER,
                                    p_dimension7_id            NUMBER,
                                    p_dimension8_id            NUMBER,
                                    p_dimension9_id            NUMBER,
                                    p_dimension10_id           NUMBER,
                                    p_account_name             VARCHAR2,
                                    p_account_number           VARCHAR2,
                                    p_payment_type_id          NUMBER,
                                    p_payment_type             VARCHAR2,
                                    p_created_by               NUMBER,
                                    p_exp_report_line_id       OUT NUMBER,
                                    p_place_type_id            NUMBER,
                                    p_place_id                 NUMBER,
                                    p_tax_type_id              NUMBER,
                                    p_transportation           IN VARCHAR2 DEFAULT NULL,
                                    p_place_to_id              IN NUMBER DEFAULT NULL,
                                    
                                    p_invoice_type                VARCHAR2 DEFAULT NULL,
                                    p_invoice_number              VARCHAR2 DEFAULT NULL,
                                    p_invoice_status              VARCHAR2 DEFAULT NULL,
                                    p_tax_amount                  NUMBER DEFAULT NULL,
                                    p_sale_amount                 NUMBER DEFAULT NULL,
                                    p_tax_rate                    NUMBER DEFAULT NULL,
                                    p_usage_type                  VARCHAR2 DEFAULT NULL,
                                    p_invoice_code                VARCHAR2 DEFAULT NULL,
                                    p_invoice_date                DATE DEFAULT NULL,
                                    p_input_tax_structure_detail  VARCHAR2 DEFAULT NULL,
                                    p_ref_pay_num                 VARCHAR2 DEFAULT NULL,
                                    p_ref_gather_num              VARCHAR2 DEFAULT NULL,
                                    p_invoice_item                VARCHAR2 DEFAULT NULL,
                                    p_deduction_rules             NUMBER,
                                    p_adjusted_full_deductions    NUMBER,
                                    p_adjusted_partial_deductions NUMBER,
                                    p_adjustable_tax_deductible   NUMBER,
                                    p_invoice_amount              NUMBER,
                                    p_invoice_tax_amount          NUMBER,
                                    p_associated_oasign           VARCHAR2,
                                    p_meetting_name               VARCHAR2 DEFAULT NULL,
                                    p_expenseve_company_id        NUMBER DEFAULT NULL,
                                    p_exp_company_id              NUMBER DEFAULT NULL,
                                    p_special_sales               VARCHAR2 DEFAULT NULL,
                                    p_invoice_sum_amount          NUMBER DEFAULT NULL,
                                    p_invoice_tax_amount_bak      NUMBER DEFAULT NULL,
                                    p_person_number               NUMBER DEFAULT NULL,
                                    p_day_number                  NUMBER DEFAULT NULL,
                                    p_average_cost                NUMBER DEFAULT NULL,
                                    p_employee_levels_id          NUMBER DEFAULT NULL,
                                    p_invoice_check_code          VARCHAR2 DEFAULT NULL,
                                    p_special_situation           VARCHAR2 DEFAULT NULL,
                                    p_invoice_sales_amount        NUMBER DEFAULT NULL);

  -->> 1.0 Modify Tagin/2015.06.17 d增加交通工具
  PROCEDURE update_exp_report_lines(p_exp_report_line_id       NUMBER,
                                    p_exp_report_header_id     NUMBER,
                                    p_line_number              VARCHAR2,
                                    p_city                     VARCHAR2,
                                    p_description              VARCHAR2,
                                    p_date_from                DATE,
                                    p_date_to                  DATE,
                                    p_expense_type_id          NUMBER,
                                    p_expense_item_id          NUMBER,
                                    p_budget_item_id           NUMBER,
                                    p_price                    NUMBER,
                                    p_primary_quantity         NUMBER,
                                    p_primary_uom              VARCHAR2,
                                    p_secondary_quantity       NUMBER,
                                    p_secondary_uom            VARCHAR2,
                                    p_report_amount            NUMBER,
                                    p_report_functional_amount NUMBER,
                                    p_distribution_set_id      NUMBER,
                                    p_company_id               NUMBER,
                                    p_unit_id                  NUMBER,
                                    p_position_id              NUMBER,
                                    p_responsibility_center_id NUMBER,
                                    p_employee_id              NUMBER,
                                    p_payee_category           VARCHAR2,
                                    p_payee_id                 NUMBER,
                                    p_partner_id               NUMBER,
                                    p_payment_flag             VARCHAR2,
                                    p_attachment_num           NUMBER,
                                    p_dimension1_id            NUMBER,
                                    p_dimension2_id            NUMBER,
                                    p_dimension3_id            NUMBER,
                                    p_dimension4_id            NUMBER,
                                    p_dimension5_id            NUMBER,
                                    p_dimension6_id            NUMBER,
                                    p_dimension7_id            NUMBER,
                                    p_dimension8_id            NUMBER,
                                    p_dimension9_id            NUMBER,
                                    p_dimension10_id           NUMBER,
                                    p_account_name             VARCHAR2,
                                    p_account_number           VARCHAR2,
                                    p_payment_type_id          NUMBER,
                                    p_payment_type             VARCHAR2,
                                    p_last_updated_by          NUMBER,
                                    p_exchange_rate            NUMBER,
                                    p_currency_code            VARCHAR2,
                                    p_period_name              VARCHAR2,
                                    p_exchange_rate_type       VARCHAR2,
                                    p_exchange_rate_quotation  VARCHAR2,
                                    p_place_type_id            NUMBER,
                                    p_place_id                 NUMBER,
                                    --add wgf 2012/12/26
                                    p_contract_header_id          NUMBER,
                                    p_payment_schedule_line_id    NUMBER,
                                    p_tax_type_id                 NUMBER,
                                    p_transportation              IN VARCHAR2 DEFAULT NULL,
                                    p_place_to_id                 IN NUMBER DEFAULT NULL,
                                    p_invoice_type                VARCHAR2 DEFAULT NULL,
                                    p_invoice_number              VARCHAR2 DEFAULT NULL,
                                    p_invoice_status              VARCHAR2 DEFAULT NULL,
                                    p_tax_amount                  NUMBER DEFAULT NULL,
                                    p_sale_amount                 NUMBER DEFAULT NULL,
                                    p_tax_rate                    NUMBER DEFAULT NULL,
                                    p_usage_type                  VARCHAR2 DEFAULT NULL,
                                    p_invoice_code                VARCHAR2 DEFAULT NULL,
                                    p_invoice_date                DATE DEFAULT NULL,
                                    p_input_tax_structure_detail  VARCHAR2 DEFAULT NULL,
                                    p_ref_pay_num                 VARCHAR2 DEFAULT NULL,
                                    p_ref_gather_num              VARCHAR2 DEFAULT NULL,
                                    p_invoice_item                VARCHAR2 DEFAULT NULL,
                                    p_deduction_rules             NUMBER,
                                    p_adjusted_full_deductions    NUMBER,
                                    p_adjusted_partial_deductions NUMBER,
                                    p_adjustable_tax_deductible   NUMBER,
                                    p_invoice_amount              NUMBER,
                                    p_invoice_tax_amount          NUMBER,
                                    p_associated_oasign           VARCHAR2,
                                    p_meetting_name               VARCHAR2 DEFAULT NULL,
                                    p_expenseve_company_id        NUMBER DEFAULT NULL,
                                    p_exp_company_id              NUMBER DEFAULT NULL,
                                    p_special_sales               VARCHAR2 DEFAULT NULL,
                                    p_invoice_sum_amount          NUMBER DEFAULT NULL,
                                    p_invoice_tax_amount_bak      NUMBER DEFAULT NULL,
                                    p_person_number               NUMBER DEFAULT NULL,
                                    p_day_number                  NUMBER DEFAULT NULL,
                                    p_average_cost                NUMBER DEFAULT NULL,
                                    p_employee_levels_id          NUMBER DEFAULT NULL,
                                    p_invoice_check_code          VARCHAR2 DEFAULT NULL,
                                    p_special_situation           VARCHAR2 DEFAULT NULL,
                                    p_invoice_sales_amount        NUMBER DEFAULT NULL);

  PROCEDURE delete_exp_report_lines(p_exp_report_line_id   NUMBER,
                                    p_created_by           NUMBER,
                                    p_exp_report_header_id NUMBER);

  --重新设置行号
  PROCEDURE resert_exp_rep_line_number(p_exp_report_header_id NUMBER,
                                       p_last_updated_by      NUMBER);
  --是否占用预算
  FUNCTION exp_rpt_reserve_budget_check(p_exp_rpt_header_id NUMBER)
    RETURN VARCHAR2;

  --分配行
  PROCEDURE insert_exp_report_dists(p_exchange_rate            NUMBER,
                                    p_created_by               NUMBER,
                                    p_report_func_amount       NUMBER,
                                    p_responsibility_center_id NUMBER,
                                    p_report_amount            NUMBER,
                                    p_exp_report_line_id       NUMBER,
                                    p_currency_code            VARCHAR2,
                                    p_dimension2_id            NUMBER DEFAULT NULL,
                                    p_dimension4_id            NUMBER DEFAULT NULL,
                                    p_dimension3_id            NUMBER DEFAULT NULL,
                                    --p_audit_flag               varchar2 default null,
                                    --p_report_status            varchar2 default null,
                                    --p_audit_date             date default null,
                                    p_dimension1_id          NUMBER DEFAULT NULL,
                                    p_attachment_num         NUMBER DEFAULT NULL,
                                    p_exceed_budget_strategy VARCHAR2 DEFAULT NULL,
                                    p_dimension10_id         NUMBER DEFAULT NULL,
                                    p_close_date             DATE DEFAULT NULL,
                                    p_close_flag             VARCHAR2 DEFAULT NULL,
                                    p_dimension9_id          NUMBER DEFAULT NULL,
                                    p_dimension6_id          NUMBER DEFAULT NULL,
                                    p_dimension5_id          NUMBER DEFAULT NULL,
                                    p_dimension8_id          NUMBER DEFAULT NULL,
                                    p_dimension7_id          NUMBER DEFAULT NULL,
                                    --p_budget_item_id           number default null,
                                    p_expense_item_id         NUMBER DEFAULT NULL,
                                    p_price                   NUMBER DEFAULT NULL,
                                    p_primary_uom             VARCHAR2 DEFAULT NULL,
                                    p_primary_quantity        NUMBER DEFAULT NULL,
                                    p_period_name             VARCHAR2 DEFAULT NULL,
                                    p_description             VARCHAR2 DEFAULT NULL,
                                    p_exchange_rate_type      VARCHAR2 DEFAULT NULL,
                                    p_expense_type_id         NUMBER DEFAULT NULL,
                                    p_exchange_rate_quotation VARCHAR2 DEFAULT NULL,
                                    p_secondary_quantity      NUMBER DEFAULT NULL,
                                    p_payee_category          VARCHAR2 DEFAULT NULL,
                                    p_employee_id             NUMBER DEFAULT NULL,
                                    p_payee_id                NUMBER DEFAULT NULL,
                                    --p_payment_flag             varchar2 default null,
                                    p_partner_id    NUMBER DEFAULT NULL,
                                    p_company_id    NUMBER DEFAULT NULL,
                                    p_secondary_uom VARCHAR2 DEFAULT NULL,
                                    --p_operation_unit_id        number default null,
                                    p_position_id                 NUMBER DEFAULT NULL,
                                    p_unit_id                     NUMBER DEFAULT NULL,
                                    p_exp_report_dists_id         OUT NUMBER,
                                    p_sale_amount                 NUMBER DEFAULT NULL,
                                    p_tax_amount                  NUMBER DEFAULT NULL,
                                    p_tax_rate                    NUMBER DEFAULT NULL,
                                    p_input_tax_structure_detail  VARCHAR2,
                                    p_deduction_rules             NUMBER,
                                    p_adjusted_full_deductions    NUMBER,
                                    p_adjusted_partial_deductions NUMBER,
                                    p_adjustable_tax_deductible   NUMBER,
                                    p_invoice_amount              NUMBER,
                                    p_invoice_tax_amount          NUMBER,
                                    p_usage_type                  VARCHAR2 DEFAULT NULL);

  PROCEDURE update_exp_report_dists(p_exp_report_dists_id         NUMBER,
                                    p_description                 VARCHAR2,
                                    p_period_name                 VARCHAR2,
                                    p_price                       NUMBER,
                                    p_primary_quantity            NUMBER,
                                    p_report_amount               NUMBER,
                                    p_rep_functional_amount       NUMBER,
                                    p_company_id                  NUMBER,
                                    p_unit_id                     NUMBER,
                                    p_responsibility_center_id    NUMBER,
                                    p_employee_id                 NUMBER,
                                    p_payee_category              VARCHAR2,
                                    p_payee_id                    NUMBER,
                                    p_dimension1_id               NUMBER,
                                    p_dimension2_id               NUMBER,
                                    p_dimension3_id               NUMBER,
                                    p_dimension4_id               NUMBER,
                                    p_dimension5_id               NUMBER,
                                    p_dimension6_id               NUMBER,
                                    p_dimension7_id               NUMBER,
                                    p_dimension8_id               NUMBER,
                                    p_dimension9_id               NUMBER,
                                    p_dimension10_id              NUMBER,
                                    p_user_id                     NUMBER,
                                    p_position_id                 NUMBER,
                                    p_budget_item_id              NUMBER,
                                    p_expense_item_id             NUMBER,
                                    p_expense_type_id             NUMBER,
                                    p_sale_amount                 NUMBER DEFAULT NULL,
                                    p_tax_amount                  NUMBER DEFAULT NULL,
                                    p_tax_rate                    NUMBER DEFAULT NULL,
                                    p_input_tax_structure_detail  VARCHAR2,
                                    p_deduction_rules             NUMBER,
                                    p_adjusted_full_deductions    NUMBER,
                                    p_adjusted_partial_deductions NUMBER,
                                    p_adjustable_tax_deductible   NUMBER,
                                    p_invoice_amount              NUMBER,
                                    p_invoice_tax_amount          NUMBER,
                                    p_associated_oasign           VARCHAR2,
                                    p_usage_type                  VARCHAR2 DEFAULT NULL);

  --获取分配行总金额
  FUNCTION get_dists_report_amount(p_exp_report_line_id NUMBER) RETURN NUMBER;

  FUNCTION get_exp_report_type_id(p_exp_report_header_id NUMBER)
    RETURN NUMBER;

  /* --获取费用类型的审批方式
  function get_auto_approve_flag(p_exp_rep_type_id number) return varchar2;*/

  -- 一次性申请单已关闭校验
  FUNCTION exp_requisition_dists_closed(p_exp_requisition_header_id NUMBER)
    RETURN BOOLEAN;

  --提交费用申请
  PROCEDURE submit_exp_report(p_exp_report_header_id NUMBER,
                              p_last_updated_by      NUMBER);

  --获取资金计划行的已核销金额
  FUNCTION get_rep_pmt_tot_write_off_amt(p_exp_report_header_id NUMBER,
                                         p_pmt_schedule_line_id NUMBER)
    RETURN NUMBER;

  --判断报销单计划付款行是否存在关联合同， 0： 关联 ； -1： 没有关联
  FUNCTION rep_pmt_contract_exists(p_payment_schedule_line_id NUMBER)
    RETURN NUMBER;

  --判断现金事务行是否存在关联合同， 0： 关联 ； -1： 没有关联
  FUNCTION csh_trx_contract_exists(p_csh_transaction_line_id NUMBER)
    RETURN NUMBER;

  --工作流运行完毕后，设置状态
  PROCEDURE update_reports_post_workflow(p_wfl_instance_id NUMBER,
                                         p_wfl_status      NUMBER,
                                         p_user_id         NUMBER);

  --收回费用申请
  PROCEDURE taken_back_exp_report(p_exp_report_header_id NUMBER,
                                  p_last_updated_by      NUMBER);

  --保存当前 维度布局
  PROCEDURE insert_exp_rep_dim_layouts(p_exp_report_header_id NUMBER,
                                       p_layout_position      VARCHAR2,
                                       p_layout_priority      NUMBER,
                                       p_dimension_id         NUMBER,
                                       p_default_dim_vlaue_id NUMBER,
                                       p_created_by           NUMBER);

  --保存当前 费用对象布局
  PROCEDURE insert_exp_rep_objects_layouts(p_exp_report_header_id   NUMBER,
                                           p_layout_position        VARCHAR2,
                                           p_layout_priority        NUMBER,
                                           p_expense_object_type_id NUMBER,
                                           p_default_object_id      NUMBER,
                                           p_created_by             NUMBER);

  --保存当前费用对象值
  PROCEDURE insert_exp_report_objects(p_exp_report_header_id      NUMBER,
                                      p_exp_report_line_id        NUMBER,
                                      p_exp_report_travel_line_id NUMBER,
                                      p_expense_object_type_id    NUMBER,
                                      p_expense_object_id         NUMBER,
                                      p_created_by                NUMBER,
                                      p_desc                      VARCHAR2);

  --更新当前费用对象值
  PROCEDURE update_exp_report_objects(p_exp_report_header_id      NUMBER,
                                      p_exp_report_line_id        NUMBER,
                                      p_exp_report_travel_line_id NUMBER,
                                      p_expense_object_type_id    NUMBER,
                                      p_expense_object_id         NUMBER,
                                      p_created_by                NUMBER,
                                      p_desc                      VARCHAR2);
  --删除分配行
  PROCEDURE delete_exp_report_dists(p_line_id NUMBER,
                                    p_dist_id NUMBER,
                                    p_user_id NUMBER);

  PROCEDURE create_csh_doc_payment_company(p_exp_report_header_id NUMBER,
                                           p_user_id              NUMBER);

  --行金额校验
  PROCEDURE report_line_amount_check(p_exp_report_header_id     NUMBER,
                                     p_flag                     OUT VARCHAR2,
                                     p_default_standard_subsidy NUMBER,
                                     p_user_id                  NUMBER);

  FUNCTION check_report_pmt_line(p_exp_report_header_id NUMBER)
    RETURN VARCHAR2;

  --计划付款行金额校验
  PROCEDURE report_pmt_check(p_exp_report_header_id NUMBER,
                             p_flag                 OUT VARCHAR2,
                             p_user_id              NUMBER);
  --删除计划付款行相关
  FUNCTION delete_rep_pmt_schedule(p_exp_report_header_id NUMBER,
                                   p_user_id              NUMBER)
    RETURN VARCHAR2;

  PROCEDURE get_payment_schedule_date(p_period_name       VARCHAR2,
                                      p_company_id        NUMBER,
                                      p_schedule_due_date OUT VARCHAR2);
  --重建计划付款行
  /*PROCEDURE insert_exp_report_pmt_schedule
  (
    p_exp_report_header_id NUMBER,
    p_user_id              NUMBER,
    p_message              OUT VARCHAR2
  );*/
  PROCEDURE insert_rep_pmt_schedules(p_payment_schedule_line_id OUT NUMBER,
                                     p_exp_report_header_id     NUMBER,
                                     p_description              VARCHAR2,
                                     p_currency                 VARCHAR2,
                                     p_payee_category           VARCHAR2,
                                     p_payee_id                 NUMBER,
                                     p_account_number           VARCHAR2,
                                     p_account_name             VARCHAR2,
                                     p_payment_type_id          NUMBER,
                                     p_schedule_start_date      DATE,
                                     p_schedule_due_date        DATE,
                                     p_due_amount               NUMBER,
                                     p_bank_code                VARCHAR2,
                                     p_bank_name                VARCHAR2,
                                     p_bank_location_code       VARCHAR2,
                                     p_bank_location            VARCHAR2,
                                     p_province_code            VARCHAR2,
                                     p_province_name            VARCHAR2,
                                     p_city_code                VARCHAR2,
                                     p_city_name                VARCHAR2,
                                     p_usedes                   VARCHAR2,
                                     p_document_id              NUMBER,
                                     p_document_line_id         NUMBER,
                                     p_user_id                  NUMBER,
                                     p_company_id               NUMBER,
                                     --modify 增加是否冻结字段
                                     p_frozen_flag VARCHAR2,
                                     --modify by Qu yuanyuan 增加托收账户字段
                                     p_collection_account_id NUMBER,
                                     p_gather_flag           VARCHAR2 DEFAULT 1);

  PROCEDURE update_exp_rep_pmt_schedules(p_exp_report_header_id     NUMBER,
                                         p_payment_schedule_line_id NUMBER,
                                         p_schedule_start_date      DATE,
                                         p_schedule_due_date        DATE,
                                         p_payee_category           VARCHAR2,
                                         p_payee_id                 NUMBER,
                                         p_due_amount               NUMBER,
                                         p_account_number           VARCHAR2,
                                         p_account_name             VARCHAR2,
                                         p_payment_type_id          NUMBER,
                                         p_bank_code                VARCHAR2,
                                         p_bank_name                VARCHAR2,
                                         p_bank_location_code       VARCHAR2,
                                         p_bank_location_name       VARCHAR2,
                                         p_province_code            VARCHAR2,
                                         p_province_name            VARCHAR2,
                                         p_city_code                VARCHAR2,
                                         p_city_name                VARCHAR2,
                                         p_usedes                   VARCHAR2,
                                         p_document_id              NUMBER,
                                         p_document_line_id         NUMBER,
                                         p_user_id                  NUMBER,
                                         --modify 修改操作时的frozen_flag
                                         p_frozen_flag VARCHAR2,
                                         --add wgf 2012/12/28
                                         p_description VARCHAR2,
                                         --modify by Qu yuanyuan 增加托收账户字段
                                         p_collection_account_id NUMBER,
                                         p_gather_flag           VARCHAR2 DEFAULT 1);

  PROCEDURE update_exp_rep_pmt_sch_adjust(p_exp_report_header_id     NUMBER,
                                          p_payment_schedule_line_id NUMBER,
                                          --add sqh 20130225 添加凭证调整时，维护现金流量项
                                          p_cash_flow_item_id NUMBER,
                                          p_user_id           NUMBER);
  -- ver 1.83  sqh 计划付款行可以修改银行账号信息
  PROCEDURE update_exp_rep_pmt_sch_bank(p_exp_report_header_id     NUMBER,
                                        p_payment_schedule_line_id NUMBER,
                                        p_account_number           VARCHAR2,
                                        p_account_name             VARCHAR2,
                                        
                                        p_bank_code          VARCHAR2,
                                        p_bank_name          VARCHAR2,
                                        p_bank_location_code VARCHAR2,
                                        p_bank_location_name VARCHAR2,
                                        p_province_code      VARCHAR2,
                                        p_province_name      VARCHAR2,
                                        p_city_code          VARCHAR2,
                                        p_city_name          VARCHAR2,
                                        p_user_id            NUMBER);

  --删除计划付款行
  PROCEDURE delete_exp_rep_pmt_schedules(p_payment_schedule_line_id NUMBER,
                                         p_exp_report_header_id     NUMBER,
                                         p_user_id                  NUMBER);

  --校验发票
  PROCEDURE check_invoice(p_exp_report_header_id NUMBER,
                          p_user_id              NUMBER,
                          p_raise_error          VARCHAR2 DEFAULT 'Y');

  --工作台审核，调整凭证
  PROCEDURE update_audit_exp_report_acc(p_je_line_id               NUMBER,
                                        p_description              VARCHAR2,
                                        p_responsibility_center_id NUMBER,
                                        p_account_id               NUMBER,
                                        p_account_segment2         VARCHAR2,
                                        p_account_segment3         VARCHAR2,
                                        p_user_id                  NUMBER);

  -- 审核
  PROCEDURE audit_exp_report(p_exp_report_header_id NUMBER,
                             p_user_id              NUMBER,
                             p_journal_date         VARCHAR2,
                             p_report_status        VARCHAR2 DEFAULT 'COMPLETELY_APPROVED',
                             p_audit_opinion        VARCHAR2 DEFAULT NULL);

  --审核（复核）
  PROCEDURE audit_exp_report_recheck(p_exp_report_header_id NUMBER,
                                     p_user_id              NUMBER,
                                     p_report_status        VARCHAR2 DEFAULT 'COMPLETELY_APPROVED',
                                     p_recheck_opinion      VARCHAR2 DEFAULT NULL);
  --报销单审核 - 条码调用
  PROCEDURE get_other_parameter(p_exp_report_number VARCHAR2,
                                p_company_id        NUMBER,
                                p_user_id           NUMBER,
                                p_employee_code     OUT VARCHAR2,
                                p_name              OUT VARCHAR2,
                                p_currency_code     OUT VARCHAR2,
                                p_report_amount     OUT VARCHAR2);

  --审核拒绝
  PROCEDURE audit_reject_expense_report(p_expense_report_header_id NUMBER,
                                        p_user_id                  NUMBER,
                                        p_description              VARCHAR2,
                                        p_report_status            VARCHAR2 DEFAULT 'COMPLETELY_APPROVED');

  FUNCTION get_batch_id RETURN NUMBER;

  PROCEDURE delete_exp_report_accounts_tmp(p_batch_id NUMBER);

  PROCEDURE insert_exp_report_accounts_tmp(p_batch_id                 NUMBER,
                                           p_expense_report_header_id NUMBER,
                                           p_amortization_flag        VARCHAR2);

  FUNCTION get_exp_report_je_line_id RETURN NUMBER;

  --创建凭证时需要的临时表
  PROCEDURE create_currency_code_tmp(p_batch_id   NUMBER,
                                     p_company_id NUMBER,
                                     p_user_id    NUMBER);

  PROCEDURE update_currency_code_tmp(p_batch_id                NUMBER,
                                     p_currency_code           VARCHAR2,
                                     p_exchange_rate_type      VARCHAR2,
                                     p_exchange_rate           NUMBER,
                                     p_exchange_rate_quotation VARCHAR2);

  --EXP5240 费用凭证调整
  PROCEDURE update_exp_report_accounts(p_exp_report_je_line_id    NUMBER,
                                       p_description              VARCHAR2,
                                       p_company_id               NUMBER,
                                       p_responsibility_center_id NUMBER,
                                       p_account_id               NUMBER,
                                       p_entered_amount_dr        NUMBER,
                                       p_entered_amount_cr        NUMBER,
                                       p_functional_amount_dr     NUMBER,
                                       p_functional_amount_cr     NUMBER,
                                       p_seg_je_category          VARCHAR2,
                                       p_segment1                 VARCHAR2,
                                       p_segment2                 VARCHAR2,
                                       p_segment3                 VARCHAR2,
                                       p_segment4                 VARCHAR2,
                                       p_segment5                 VARCHAR2,
                                       p_segment6                 VARCHAR2,
                                       p_segment7                 VARCHAR2,
                                       p_segment8                 VARCHAR2,
                                       p_segment9                 VARCHAR2,
                                       p_segment10                VARCHAR2,
                                       p_segment11                VARCHAR2,
                                       p_segment12                VARCHAR2,
                                       p_segment13                VARCHAR2,
                                       p_segment14                VARCHAR2,
                                       p_segment15                VARCHAR2,
                                       p_segment16                VARCHAR2,
                                       p_segment17                VARCHAR2,
                                       p_segment18                VARCHAR2,
                                       p_segment19                VARCHAR2,
                                       p_segment20                VARCHAR2,
                                       p_user_id                  NUMBER);
  --EXP5240 生成凭证界面新建
  PROCEDURE insert_exp_accounts_save(p_exp_report_header_id     NUMBER,
                                     p_description              VARCHAR2,
                                     p_company_id               NUMBER,
                                     p_responsibility_center_id NUMBER,
                                     p_journal_date             DATE,
                                     p_period_name              VARCHAR2,
                                     p_account_id               NUMBER,
                                     p_entered_amount_dr        NUMBER,
                                     p_entered_amount_cr        NUMBER,
                                     p_functional_amount_dr     NUMBER,
                                     p_functional_amount_cr     NUMBER,
                                     p_segment1                 VARCHAR2,
                                     p_segment2                 VARCHAR2,
                                     p_segment3                 VARCHAR2,
                                     p_segment4                 VARCHAR2,
                                     p_segment5                 VARCHAR2,
                                     p_segment6                 VARCHAR2,
                                     p_segment7                 VARCHAR2,
                                     p_segment8                 VARCHAR2,
                                     p_segment9                 VARCHAR2,
                                     p_segment10                VARCHAR2,
                                     p_segment11                VARCHAR2,
                                     p_segment12                VARCHAR2,
                                     p_segment13                VARCHAR2,
                                     p_segment14                VARCHAR2,
                                     p_segment15                VARCHAR2,
                                     p_segment16                VARCHAR2,
                                     p_segment17                VARCHAR2,
                                     p_segment18                VARCHAR2,
                                     p_segment19                VARCHAR2,
                                     p_segment20                VARCHAR2,
                                     p_user_id                  NUMBER);
  --EXP5240 删除凭证
  PROCEDURE delete_exp_report_accounts_je(p_exp_report_header_id  NUMBER,
                                          p_exp_report_je_line_id NUMBER,
                                          p_user_id               NUMBER);

  --EXPM/PUBLIC 删除凭证
  PROCEDURE wfl_delete_exp_report_accounts(p_exp_report_header_id  NUMBER,
                                           p_exp_report_je_line_id NUMBER,
                                           p_user_id               NUMBER);
  FUNCTION get_employee_type_id(p_employee_id NUMBER) RETURN NUMBER;

  PROCEDURE report_pmt_amount_check(p_exp_report_header_id NUMBER,
                                    p_user_id              NUMBER);

  PROCEDURE insert_exp_report_accounts(p_exp_report_dists_id      NUMBER,
                                       p_exp_report_header_id     NUMBER,
                                       p_exp_report_je_line_id    NUMBER,
                                       p_description              VARCHAR2,
                                       p_journal_date             DATE,
                                       p_period_name              VARCHAR2,
                                       p_source_code              VARCHAR2,
                                       p_company_id               NUMBER,
                                       p_company_segment          VARCHAR2 DEFAULT NULL,
                                       p_responsibility_center_id NUMBER,
                                       p_account_id               NUMBER,
                                       p_account_segment1         VARCHAR2 DEFAULT NULL,
                                       p_account_segment2         VARCHAR2 DEFAULT NULL,
                                       p_account_segment3         VARCHAR2 DEFAULT NULL,
                                       p_account_segment4         VARCHAR2 DEFAULT NULL,
                                       p_account_segment5         VARCHAR2 DEFAULT NULL,
                                       p_account_segment6         VARCHAR2 DEFAULT NULL,
                                       p_account_segment7         VARCHAR2 DEFAULT NULL,
                                       p_account_segment8         VARCHAR2 DEFAULT NULL,
                                       p_account_segment9         VARCHAR2 DEFAULT NULL,
                                       p_account_segment10        VARCHAR2 DEFAULT NULL,
                                       p_dimension1_id            NUMBER DEFAULT NULL,
                                       p_dimension2_id            NUMBER DEFAULT NULL,
                                       p_dimension3_id            NUMBER DEFAULT NULL,
                                       p_dimension4_id            NUMBER DEFAULT NULL,
                                       p_dimension5_id            NUMBER DEFAULT NULL,
                                       p_dimension6_id            NUMBER DEFAULT NULL,
                                       p_dimension7_id            NUMBER DEFAULT NULL,
                                       p_dimension8_id            NUMBER DEFAULT NULL,
                                       p_dimension9_id            NUMBER DEFAULT NULL,
                                       p_dimension10_id           NUMBER DEFAULT NULL,
                                       p_currency_code            VARCHAR2,
                                       p_exchange_rate_type       VARCHAR2,
                                       p_exchange_rate_quotation  VARCHAR2,
                                       p_exchange_rate            NUMBER,
                                       p_entered_amount_dr        NUMBER,
                                       p_entered_amount_cr        NUMBER,
                                       p_functional_amount_dr     NUMBER,
                                       p_functional_amount_cr     NUMBER,
                                       p_gld_interface_flag       VARCHAR2,
                                       p_user_id                  NUMBER,
                                       p_usage_code               VARCHAR2);

  --插入贷方凭证
  PROCEDURE insert_exp_report_accounts_c(p_payment_schedule_line_id NUMBER,
                                         p_exp_report_header_id     NUMBER,
                                         p_exp_report_je_line_id    NUMBER,
                                         p_description              VARCHAR2,
                                         p_journal_date             DATE,
                                         p_period_name              VARCHAR2,
                                         p_source_code              VARCHAR2,
                                         p_company_id               NUMBER,
                                         p_company_segment          VARCHAR2 DEFAULT NULL,
                                         p_responsibility_center_id NUMBER,
                                         p_account_id               NUMBER,
                                         p_account_segment1         VARCHAR2 DEFAULT NULL,
                                         p_account_segment2         VARCHAR2 DEFAULT NULL,
                                         p_account_segment3         VARCHAR2 DEFAULT NULL,
                                         p_account_segment4         VARCHAR2 DEFAULT NULL,
                                         p_account_segment5         VARCHAR2 DEFAULT NULL,
                                         p_account_segment6         VARCHAR2 DEFAULT NULL,
                                         p_account_segment7         VARCHAR2 DEFAULT NULL,
                                         p_account_segment8         VARCHAR2 DEFAULT NULL,
                                         p_account_segment9         VARCHAR2 DEFAULT NULL,
                                         p_account_segment10        VARCHAR2 DEFAULT NULL,
                                         p_dimension1_id            NUMBER DEFAULT NULL,
                                         p_dimension2_id            NUMBER DEFAULT NULL,
                                         p_dimension3_id            NUMBER DEFAULT NULL,
                                         p_dimension4_id            NUMBER DEFAULT NULL,
                                         p_dimension5_id            NUMBER DEFAULT NULL,
                                         p_dimension6_id            NUMBER DEFAULT NULL,
                                         p_dimension7_id            NUMBER DEFAULT NULL,
                                         p_dimension8_id            NUMBER DEFAULT NULL,
                                         p_dimension9_id            NUMBER DEFAULT NULL,
                                         p_dimension10_id           NUMBER DEFAULT NULL,
                                         p_currency_code            VARCHAR2,
                                         p_exchange_rate_type       VARCHAR2,
                                         p_exchange_rate_quotation  VARCHAR2,
                                         p_exchange_rate            NUMBER,
                                         p_entered_amount_dr        NUMBER,
                                         p_entered_amount_cr        NUMBER,
                                         p_functional_amount_dr     NUMBER,
                                         p_functional_amount_cr     NUMBER,
                                         p_gld_interface_flag       VARCHAR2,
                                         p_user_id                  NUMBER,
                                         p_usage_code               VARCHAR2);

  --开始创建报销凭证
  --add by lq 工作流维护界面重新生成凭证
  PROCEDURE create_expense_report_account(p_batch_id     NUMBER,
                                          p_journal_date DATE,
                                          p_company_id   NUMBER,
                                          p_user_id      NUMBER,
                                          p_wfl_flag     VARCHAR DEFAULT NULL);

  /**-----------------------------------------
  -- 费用报销单提交时,预生成凭证
  -- 校验CCID
  ------------------------------------------*/
  PROCEDURE pre_create_er_accounts(p_exp_rep_header_id NUMBER,
                                   p_user_id           NUMBER);

  --删除报销凭证
  PROCEDURE delete_exp_report_accounts(p_exp_report_header_id NUMBER,
                                       p_user_id              NUMBER);

  --删除报销凭证 复核
  PROCEDURE delete_exp_report_rec_accounts(p_exp_report_header_id NUMBER,
                                           p_user_id              NUMBER);
  --反冲报销单
  PROCEDURE reverse_expense_report(p_exp_report_header_id NUMBER,
                                   p_reverse_date         DATE,
                                   p_user_id              NUMBER,
                                   p_company_id           NUMBER);

  --历史记录
  PROCEDURE insert_exp_document_histories(p_document_type  VARCHAR2,
                                          p_document_id    NUMBER,
                                          p_operation_code VARCHAR2,
                                          p_user_id        NUMBER,
                                          p_operation_time DATE,
                                          p_description    VARCHAR2);

  --报销单，指定申请单分配行
  PROCEDURE create_manual_exp_req_relation(p_exp_req_dist_id    NUMBER,
                                           p_exp_report_line_id NUMBER,
                                           p_user_id            NUMBER);

  --====报销单，指定差旅计划分配行
  --====add by  fanqihua
  --====20150723
  PROCEDURE create_manual_exp_tp_relation(p_exp_tp_dist_id     NUMBER,
                                          p_exp_report_line_id NUMBER,
                                          p_user_id            NUMBER);

  --报销单核销预付款
  PROCEDURE exp_write_off_prepayment(p_session_id               NUMBER,
                                     p_company_id               NUMBER,
                                     p_exp_pmt_schedule_line_id NUMBER,
                                     p_transaction_header_id    NUMBER,
                                     p_write_off_date           DATE,
                                     p_write_off_amount         NUMBER,
                                     p_user_id                  NUMBER);

  --Mantis 0026793: 费用报销单维护-计划付款行-借款核销界面--核销历史TAB增加删除工具按钮
  PROCEDURE delete_csh_write_off(p_write_off_id NUMBER, p_user_id NUMBER);

  FUNCTION exists_unwrite_off_amount(p_exp_report_header_id NUMBER,
                                     p_user_id              NUMBER)
    RETURN VARCHAR2;

  PROCEDURE create_exp_rep_pmt_schedule(p_exp_report_header_id NUMBER,
                                        p_created_by           NUMBER);
  --Mantis 0032203:报销单提交、反冲、拒绝、回收、时，重置申请单对应的预算保留
  PROCEDURE reset_req_bgt_reserve(p_exp_report_header_id NUMBER,
                                  p_user_id              NUMBER);
  PROCEDURE exp_report_header_save(p_exp_report_header_id        IN OUT NUMBER,
                                   p_exp_report_number           IN OUT VARCHAR2,
                                   p_company_id                  NUMBER,
                                   p_exp_report_barcode          VARCHAR2,
                                   p_employee_id                 NUMBER,
                                   p_position_id                 NUMBER,
                                   p_payee_category              VARCHAR2,
                                   p_payee_id                    NUMBER,
                                   p_exp_report_type_id          NUMBER,
                                   p_expense_user_group_id       NUMBER,
                                   p_currency_code               VARCHAR2,
                                   p_exchange_rate_type          VARCHAR2,
                                   p_exchange_rate_quotation     VARCHAR2,
                                   p_exchange_rate               NUMBER,
                                   p_report_date                 DATE,
                                   p_period_name                 VARCHAR2,
                                   p_report_status               VARCHAR2,
                                   p_gld_interface_flag          VARCHAR2 DEFAULT 'N',
                                   p_attachment_num              NUMBER,
                                   p_description                 VARCHAR2,
                                   p_write_off_status            VARCHAR2 DEFAULT 'N',
                                   p_write_off_completed_date    DATE,
                                   p_reversed_flag               VARCHAR2,
                                   p_source_exp_rep_header_id    NUMBER,
                                   p_created_by                  NUMBER,
                                   p_operation_date              DATE DEFAULT NULL,
                                   p_source_type                 VARCHAR2 DEFAULT 'MANUAL',
                                   p_payment_method_id           NUMBER,
                                   p_vat_special_invoice_include VARCHAR2 DEFAULT NULL,
                                   p_consistent_invoice_amount   VARCHAR2 DEFAULT 'N',
                                   p_pay_company_id              VARCHAR2 DEFAULT NULL,
                                   p_contract_header_id          NUMBER DEFAULT NULL,
                                   p_associated_oasign           VARCHAR2 DEFAULT NULL,
                                   p_metting_type_code           VARCHAR2 DEFAULT NULL,
                                   p_special_situation           VARCHAR2 DEFAULT NULL);

  PROCEDURE exp_report_header_save(p_exp_report_header_id        IN OUT NUMBER,
                                   p_exp_report_number           IN OUT VARCHAR2,
                                   p_company_id                  NUMBER,
                                   p_exp_report_barcode          VARCHAR2,
                                   p_employee_id                 NUMBER,
                                   p_position_id                 NUMBER,
                                   p_payee_category              VARCHAR2,
                                   p_payee_id                    NUMBER,
                                   p_exp_report_type_id          NUMBER,
                                   p_expense_user_group_id       NUMBER,
                                   p_currency_code               VARCHAR2,
                                   p_exchange_rate_type          VARCHAR2,
                                   p_exchange_rate_quotation     VARCHAR2,
                                   p_exchange_rate               NUMBER,
                                   p_report_date                 DATE,
                                   p_period_name                 VARCHAR2,
                                   p_report_status               VARCHAR2,
                                   p_gld_interface_flag          VARCHAR2 DEFAULT 'N',
                                   p_attachment_num              NUMBER,
                                   p_description                 VARCHAR2,
                                   p_write_off_status            VARCHAR2 DEFAULT 'N',
                                   p_write_off_completed_date    DATE,
                                   p_reversed_flag               VARCHAR2,
                                   p_source_exp_rep_header_id    NUMBER,
                                   p_created_by                  NUMBER,
                                   p_operation_date              DATE DEFAULT NULL,
                                   p_source_type                 VARCHAR2 DEFAULT 'MANUAL',
                                   p_payment_method_id           NUMBER,
                                   p_contract_header_id          NUMBER,
                                   p_eam_asset_id                NUMBER,
                                   p_vat_special_invoice_include VARCHAR2 DEFAULT NULL,
                                   p_consistent_invoice_amount   VARCHAR2 DEFAULT 'N',
                                   p_pay_company_id              VARCHAR2 DEFAULT NULL,
                                   p_associated_oasign           VARCHAR2 DEFAULT NULL,
                                   p_sign_id                     NUMBER DEFAULT NULL,
                                   p_metting_type_code           VARCHAR2 DEFAULT NULL,
                                   p_special_situation           VARCHAR2 DEFAULT NULL);

  /*************************************************
  -- Author  : MOUSE
  -- Created : 2014/10/11 15:19:34
  -- Ver     : 1.1
  -- Purpose : test专用，创建费用报销单凭证
  **************************************************/
  FUNCTION create_exp_report_accounts(p_exp_rep_header_id NUMBER,
                                      p_journal_date      DATE,
                                      p_user_id           NUMBER,
                                      p_batch_id          NUMBER,
                                      p_period_name       VARCHAR2)
    RETURN VARCHAR2;

  /*************************************************
  -- Author  : MOUSE
  -- Created : 2015/2/11 19:11:48
  -- Ver     : 1.1
  -- Purpose : 报销单差旅行插入
  -- In Para :
        p_exp_report_line_id          报销单行ID
        p_travel_plan_line_id         差旅行ID
        p_travel_line_category        差旅行类别（TRANSPORTATION,ACCOMMODATION,OTHER）
        p_transportation              交通工具
        p_departure_place             出发地
        p_departure_place_id          出发地ID
        p_departure_date              出发日期
        p_arrival_place               到达地
        p_arrival_place_id            到达地ID
        p_arrival_date                到达日期
        p_accommodation_date_from     住宿日期从
        p_accommodation_date_to       住宿日期到
        p_accommodation_days          住宿天数
        p_user_id                     操作用户
  **************************************************/
  PROCEDURE insert_exp_report_travel_lines(p_exp_report_line_id      NUMBER,
                                           p_travel_plan_line_id     NUMBER,
                                           p_travel_line_category    VARCHAR2,
                                           p_transportation          VARCHAR2,
                                           p_departure_place         VARCHAR2,
                                           p_departure_place_id      NUMBER,
                                           p_departure_date          DATE,
                                           p_arrival_place           VARCHAR2,
                                           p_arrival_place_id        NUMBER,
                                           p_arrival_date            DATE,
                                           p_accommodation_date_from DATE,
                                           p_accommodation_date_to   DATE,
                                           p_accommodation_days      NUMBER,
                                           p_user_id                 NUMBER);

  /*************************************************
  -- Author  : MOUSE
  -- Created : 2015/2/11 19:11:48
  -- Ver     : 1.1
  -- Purpose : 报销单差旅行更新
  -- In Para :
        p_exp_report_line_id          报销单行ID
        p_travel_plan_line_id         差旅行ID
        p_travel_line_category        差旅行类别（TRANSPORTATION,ACCOMMODATION,OTHER）
        p_transportation              交通工具
        p_departure_place             出发地
        p_departure_place_id          出发地ID
        p_departure_date              出发日期
        p_arrival_place               到达地
        p_arrival_place_id            到达地ID
        p_arrival_date                到达日期
        p_accommodation_date_from     住宿日期从
        p_accommodation_date_to       住宿日期到
        p_accommodation_days          住宿天数
        p_user_id                     操作用户
  **************************************************/
  PROCEDURE update_exp_report_travel_lines(p_exp_report_line_id      NUMBER,
                                           p_travel_plan_line_id     NUMBER,
                                           p_travel_line_category    VARCHAR2,
                                           p_transportation          VARCHAR2,
                                           p_departure_place         VARCHAR2,
                                           p_departure_place_id      NUMBER,
                                           p_departure_date          DATE,
                                           p_arrival_place           VARCHAR2,
                                           p_arrival_place_id        NUMBER,
                                           p_arrival_date            DATE,
                                           p_accommodation_date_from DATE,
                                           p_accommodation_date_to   DATE,
                                           p_accommodation_days      NUMBER,
                                           p_user_id                 NUMBER);

  /*************************************************
  -- Author  : majianjian
  -- Created : 2015/3/25 10:05:28
  -- Ver     : 1.1
  -- Purpose : 差旅计划预算释放
  **************************************************/
  PROCEDURE travel_plan_reserves_release(p_travel_plan_line_id IN NUMBER,
                                         p_exp_report_line_id  IN NUMBER,
                                         p_user_id             IN NUMBER);
  FUNCTION get_schedule_usedes_code(p_exp_report_header_id NUMBER,
                                    p_expense_item_id      NUMBER)
    RETURN VARCHAR2;
  --add by Qu yuanyuan 2015-11-25 报销单工作流审批页面调整计划付款行付款用途
  PROCEDURE update_exp_pmt_adjust_payment(p_exp_report_header_id     NUMBER,
                                          p_payment_schedule_line_id NUMBER,
                                          p_payment_type_id          NUMBER,
                                          p_gather_flag              VARCHAR2,
                                          p_user_id                  NUMBER,
                                          p_usedes_code              VARCHAR2 DEFAULT NULL);
  --end by Qu yuanyuan

  /*************************************************
  -- Author  : MOUSE
  -- Created : 2015/12/7 14:37:19
  -- Ver     : 1.1
  -- Purpose : 验证报销单对应的合同金额是否超出合同的资金计划金额
  **************************************************/
  FUNCTION get_con_line_amount(p_exp_report_header_id NUMBER,
                               p_pmt_line_id          NUMBER) RETURN NUMBER;

  /*************************************************
  -- Author  : MOUSE
  -- Created : 2015/12/7 14:37:19
  -- Ver     : 1.1
  -- Purpose : 验证报销单对应的合同金额是否超出合同的资金计划金额
  **************************************************/
  FUNCTION get_con_amount(p_exp_report_header_id NUMBER,
                          p_pmt_line_id          NUMBER) RETURN NUMBER;

  /*************************************************
  -- Author  : MOUSE
  -- Created : 2015/12/7 14:37:19
  -- Ver     : 1.1
  -- Purpose : 验证报销单对应的合同金额是否超出合同的资金计划金额
  **************************************************/
  PROCEDURE validate_con_amount(p_exp_report_header_id NUMBER);

  /*************************************************
  -- Author  : MOUSE
  -- Created : 2015/12/7 18:46:18
  -- Ver     : 1.1
  -- Purpose : 验证报销关联的申请关联的借款是否已经支付，如果未支付，则可能存在报销与借款重复支付的风险，不允许提交
  **************************************************/
  PROCEDURE validate_req_ref_pay_req(p_exp_report_header_id NUMBER);

  --待摊
  FUNCTION create_exp_amortization_acc(p_exp_report_header_id NUMBER,
                                       p_user_id              NUMBER)
    RETURN VARCHAR2;

  FUNCTION exp_report_amt_balance_check(p_exp_report_header_id NUMBER,
                                        p_user_id              NUMBER)
    RETURN NUMBER;

  /*************************************************
  -- Author  : HM
  -- Created : 2016/05/20 14:04:09
  -- Ver     : 1.0
  -- Purpose : 营改增――报销单复核校验，只有报销单所有行发票认证状态为无需认证和已认证，才可以复核通过
  **************************************************/
  FUNCTION exp_report_recheck_check_vms(p_exp_report_header_id NUMBER)
    RETURN VARCHAR2;

  /*************************************************
  -- Author  : HM
  -- Created : 2016/11/1 11:55:09
  -- Purpose : 提交费用报销单校验 
  **************************************************/
  PROCEDURE submit_exp_report_check(p_exp_report_header_id NUMBER,
                                    p_user_id              NUMBER);

  /*************************************************
  -- Author  : HM
  -- Created : 2016/12/5 17:49:01
  -- Purpose : 开始创建报销转出凭证
  **************************************************/
  PROCEDURE create_expense_report_acc_rt(p_exp_report_line_id NUMBER,
                                         --p_batch_id     NUMBER,
                                         p_journal_date DATE,
                                         p_company_id   NUMBER,
                                         p_user_id      NUMBER);

  /*************************************************
  -- Author  : HM
  -- Created : 2016/12/5 17:49:01
  -- Purpose : 报销单转出
  **************************************************/
  PROCEDURE exp_report_roll_out(p_exp_report_line_id NUMBER,
                                p_user_id            NUMBER,
                                p_roll_out_per       NUMBER DEFAULT NULL);

  PROCEDURE exp_report_roll_out_submit(p_exp_report_line_id NUMBER,
                                       p_user_id            NUMBER);

  /*************************************************
  -- Author  : HM
  -- Created : 2016/12/5 17:49:01
  -- Purpose : 报销单转出金额保存
  **************************************************/
  PROCEDURE exp_report_roll_out_save(p_exp_report_line_id NUMBER,
                                     p_roll_out_per       NUMBER, --转出金额
                                     p_user_id            NUMBER);

  /*************************************************
  -- Author  : HM
  -- Created : 2016/12/5 17:49:01
  -- Purpose : 报销单转出复核
  **************************************************/
  PROCEDURE exp_report_roll_out_recheck(p_exp_report_line_id NUMBER,
                                        p_roll_out_status    VARCHAR2, --复核意见：Y:同意，N:拒绝
                                        p_user_id            NUMBER);
  /*************************************************
  -- Author  : lyh
  -- Created : 2017/7/19 17:18:01
  -- Purpose : 合同维护的供应商，在保存后，如果公司级供应商中没有，则分配,并插入维护表
  **************************************************/
  PROCEDURE insert_exp_report_vender(p_payee_id   NUMBER,
                                     p_company_id NUMBER,
                                     p_user_id    NUMBER);
  /*************************************************
  -- Author  : lyh
  -- Created : 2018/3/23 14:57:02
  -- Purpose : 报销单提交的时候进行发票连号校验
  **************************************************/
  PROCEDURE invoice_number_check(p_exp_report_header_id NUMBER,
                                 p_user_id              NUMBER,
                                 p_invoice_number       OUT VARCHAR2,
                                 p_exp_report_number    OUT VARCHAR2);

  PROCEDURE save_exp_invoice_authentic(p_exp_report_header_id        NUMBER,
                                       p_exp_report_line_id          NUMBER,
                                       p_usage_type                  VARCHAR2,
                                       p_adjusted_full_deductions    NUMBER,
                                       p_adjusted_partial_deductions NUMBER,
                                       p_adjustable_tax_deductible   NUMBER,
                                       p_input_tax_struc_detail      VARCHAR2,
                                       p_invoice_status              VARCHAR2,
                                       p_deductions_remark           VARCHAR2,
                                       p_user_id                     NUMBER);
  PROCEDURE confirm_deductions(p_exp_report_header_id NUMBER,
                               p_exp_report_line_id   NUMBER,
                               p_user_id              NUMBER);
  PROCEDURE cancel_deductions(p_exp_report_header_id NUMBER,
                              p_exp_report_line_id   NUMBER,
                              p_user_id              NUMBER);
  PROCEDURE reject_exp_invoice_authentic(p_exp_report_header_id NUMBER,
                                         p_exp_report_line_id   NUMBER,
                                         p_user_id              NUMBER);
  PROCEDURE exp_report_roll_out_usage_save(p_exp_report_line_id          NUMBER,
                                           p_usage_type                  VARCHAR2,
                                           p_adjusted_full_deductions    NUMBER,
                                           p_adjusted_partial_deductions NUMBER,
                                           p_adjustable_tax_deductible   NUMBER,
                                           p_user_id                     NUMBER);
  PROCEDURE update_header_dynamic(p_exp_report_header_id NUMBER,
                                  p_dynamic_id           NUMBER,
                                  p_user_id              NUMBER);
  FUNCTION exp_req_amount_check(p_exp_report_header_id NUMBER)
    RETURN VARCHAR2;

  PROCEDURE tax_audit(p_exp_report_header_id NUMBER,
                      p_exp_report_line_id   NUMBER,
                      p_user_id              NUMBER);

  PROCEDURE create_exp_rep_pmt_schd_intf(p_exp_report_header_id NUMBER,
                                         p_created_by           NUMBER);
  PROCEDURE exp_report_header_save_intf(p_exp_report_header_id        IN OUT NUMBER,
                                        p_exp_report_number           IN OUT VARCHAR2,
                                        p_company_id                  NUMBER,
                                        p_exp_report_barcode          VARCHAR2,
                                        p_employee_id                 NUMBER,
                                        p_position_id                 NUMBER,
                                        p_payee_category              VARCHAR2,
                                        p_payee_id                    NUMBER,
                                        p_exp_report_type_id          NUMBER,
                                        p_expense_user_group_id       NUMBER,
                                        p_currency_code               VARCHAR2,
                                        p_exchange_rate_type          VARCHAR2,
                                        p_exchange_rate_quotation     VARCHAR2,
                                        p_exchange_rate               NUMBER,
                                        p_report_date                 DATE,
                                        p_period_name                 VARCHAR2,
                                        p_report_status               VARCHAR2,
                                        p_gld_interface_flag          VARCHAR2 DEFAULT 'N',
                                        p_attachment_num              NUMBER,
                                        p_description                 VARCHAR2,
                                        p_write_off_status            VARCHAR2 DEFAULT 'N',
                                        p_write_off_completed_date    DATE,
                                        p_reversed_flag               VARCHAR2,
                                        p_source_exp_rep_header_id    NUMBER,
                                        p_created_by                  NUMBER,
                                        p_operation_date              DATE DEFAULT NULL,
                                        p_source_type                 VARCHAR2 DEFAULT 'MANUAL',
                                        p_payment_method_id           NUMBER,
                                        p_contract_header_id          NUMBER,
                                        p_eam_asset_id                NUMBER,
                                        p_vat_special_invoice_include VARCHAR2 DEFAULT NULL,
                                        p_create_type                 VARCHAR2 DEFAULT NULL,
                                        p_related_transactions        NUMBER,
                                        p_meeting_type_id             VARCHAR2 DEFAULT NULL,
                                        p_pay_company_id              VARCHAR2 DEFAULT NULL);
  --app插入和更新计划付款行 mody by lqy-20180504
  PROCEDURE save_rep_pmt_schedules_intf(p_payment_schedule_line_id IN OUT NUMBER,
                                        p_exp_report_header_id     NUMBER,
                                        p_description              VARCHAR2,
                                        p_currency                 VARCHAR2,
                                        p_payee_category           VARCHAR2,
                                        p_payee_id                 NUMBER,
                                        p_account_number           VARCHAR2,
                                        p_account_name             VARCHAR2,
                                        p_payment_type_id          NUMBER,
                                        p_schedule_start_date      DATE,
                                        p_schedule_due_date        DATE,
                                        p_due_amount               NUMBER,
                                        p_bank_code                VARCHAR2,
                                        p_bank_name                VARCHAR2,
                                        p_bank_location_code       VARCHAR2,
                                        p_bank_location            VARCHAR2,
                                        p_province_code            VARCHAR2,
                                        p_province_name            VARCHAR2,
                                        p_city_code                VARCHAR2,
                                        p_city_name                VARCHAR2,
                                        p_usedes                   VARCHAR2, --付款用途代码
                                        p_document_id              NUMBER,
                                        p_document_line_id         NUMBER,
                                        p_user_id                  NUMBER,
                                        p_company_id               NUMBER,
                                        --modify 增加是否冻结字段
                                        p_frozen_flag VARCHAR2,
                                        --modify by Qu yuanyuan 增加托收账户字段
                                        p_collection_account_id NUMBER,
                                        p_gather_flag           VARCHAR2 DEFAULT 1);
  --校验报销单行机构是否有效  add by lqy@20180508
  PROCEDURE check_exp_report_lines_company(p_exp_report_header_id NUMBER,
                                           p_user_id              NUMBER);
  --add by lqy
  --报销单行保存更新 for app
  PROCEDURE save_exp_rep_lines_intf(p_exp_report_header_id     NUMBER,
                                    p_line_number              NUMBER,
                                    p_city                     VARCHAR2,
                                    p_description              VARCHAR2,
                                    p_date_from                DATE,
                                    p_date_to                  DATE,
                                    p_period_name              VARCHAR2,
                                    p_currency_code            VARCHAR2,
                                    p_exchange_rate_type       VARCHAR2,
                                    p_exchange_rate_quotation  VARCHAR2,
                                    p_exchange_rate            NUMBER,
                                    p_expense_type_id          NUMBER,
                                    p_expense_item_id          NUMBER,
                                    p_budget_item_id           NUMBER,
                                    p_price                    NUMBER,
                                    p_primary_quantity         NUMBER,
                                    p_primary_uom              VARCHAR2,
                                    p_secondary_quantity       NUMBER,
                                    p_secondary_uom            VARCHAR2,
                                    p_report_amount            NUMBER,
                                    p_report_functional_amount NUMBER,
                                    p_distribution_set_id      NUMBER,
                                    p_company_id               NUMBER,
                                    p_unit_id                  NUMBER,
                                    p_position_id              NUMBER,
                                    p_responsibility_center_id NUMBER,
                                    p_employee_id              NUMBER,
                                    p_payee_category           VARCHAR2,
                                    p_payee_id                 NUMBER,
                                    p_partner_id               NUMBER,
                                    p_payment_flag             VARCHAR2,
                                    p_report_status            VARCHAR2,
                                    p_write_off_status         VARCHAR2,
                                    p_write_off_comleted_date  DATE,
                                    p_attachment_num           NUMBER,
                                    p_dimension1_id            NUMBER,
                                    p_dimension2_id            NUMBER,
                                    p_dimension3_id            NUMBER,
                                    p_dimension4_id            NUMBER,
                                    p_dimension5_id            NUMBER,
                                    p_dimension6_id            NUMBER,
                                    p_dimension7_id            NUMBER,
                                    p_dimension8_id            NUMBER,
                                    p_dimension9_id            NUMBER,
                                    p_dimension10_id           NUMBER,
                                    p_account_name             VARCHAR2,
                                    p_account_number           VARCHAR2,
                                    p_payment_type_id          NUMBER,
                                    p_payment_type             VARCHAR2,
                                    p_created_by               NUMBER,
                                    p_exp_report_line_id       IN OUT NUMBER,
                                    p_place_type_id            NUMBER,
                                    p_place_id                 NUMBER,
                                    p_tax_type_id              NUMBER,
                                    --更新部分添加字段
                                    p_last_updated_by            NUMBER,
                                    p_contract_header_id         NUMBER,
                                    p_payment_schedule_line_id   NUMBER,
                                    p_transportation             IN VARCHAR2 DEFAULT NULL,
                                    p_place_to_id                IN NUMBER DEFAULT NULL,
                                    p_invoice_type               VARCHAR2 DEFAULT NULL,
                                    p_special_invoice            VARCHAR2 DEFAULT NULL,
                                    p_invoice_number             VARCHAR2 DEFAULT NULL,
                                    p_invoice_status             VARCHAR2 DEFAULT NULL,
                                    p_tax_amount                 NUMBER DEFAULT NULL,
                                    p_sale_amount                NUMBER DEFAULT NULL,
                                    p_tax_rate                   NUMBER DEFAULT NULL,
                                    p_usage_type                 VARCHAR2 DEFAULT NULL,
                                    p_invoice_code               VARCHAR2 DEFAULT NULL,
                                    p_invoice_date               DATE DEFAULT NULL,
                                    p_input_tax_structure_detail VARCHAR2 DEFAULT NULL,
                                    --add by HJ
                                    p_income_period_from DATE DEFAULT NULL,
                                    p_income_period_to   DATE DEFAULT NULL,
                                    --SYX begin3
                                    p_vat_invoice_type VARCHAR2 DEFAULT NULL,
                                    --SYX end3
                                    p_exp_company_id         NUMBER DEFAULT NULL,
                                    p_special_sales          VARCHAR2 DEFAULT NULL,
                                    p_invoice_sum_amount     NUMBER DEFAULT NULL,
                                    p_invoice_tax_amount_bak NUMBER DEFAULT NULL,
                                    p_person_number          NUMBER DEFAULT NULL,
                                    p_day_number             NUMBER DEFAULT NULL,
                                    p_average_cost           NUMBER DEFAULT NULL,
                                    p_employee_levels_id     NUMBER DEFAULT NULL);
  PROCEDURE create_exp_report_from_req(p_exp_requisition_dists_id NUMBER,
                                       p_exp_requisition_line_id  NUMBER,
                                       p_exp_report_header_id     NUMBER,
                                       p_user_id                  NUMBER);
  FUNCTION exp_write_off_amount_check(p_exp_report_header_id NUMBER)
    RETURN VARCHAR2;

  FUNCTION get_auto_audit_flag(p_exp_rep_type_id NUMBER) RETURN VARCHAR2;
END exp_report_pkg;
/
CREATE OR REPLACE PACKAGE BODY "EXP_REPORT_PKG" IS

  g_user_id                  NUMBER;
  g_batch_id                 NUMBER;
  g_exp_report_number        VARCHAR2(30);
  g_line_number              NUMBER;
  g_exp_report_dists_id      NUMBER;
  g_operation_code           VARCHAR2(30);
  g_responsibility_center_id NUMBER;

  e_sub_program_error     EXCEPTION;
  e_delete_error          EXCEPTION;
  e_lock_table            EXCEPTION;
  e_dimension_value_error EXCEPTION;
  PRAGMA EXCEPTION_INIT(e_lock_table, -54);
  e_con_amount_error      EXCEPTION;
  e_req_ref_pay_req_error EXCEPTION;

  FUNCTION get_exp_report_header_id RETURN NUMBER IS
    v_exp_report_header_id exp_report_headers.exp_report_header_id%TYPE;
  BEGIN
    SELECT exp_report_headers_s.nextval
      INTO v_exp_report_header_id
      FROM dual;
    RETURN v_exp_report_header_id;
  END get_exp_report_header_id;

  FUNCTION get_exp_report_line_id RETURN NUMBER IS
    v_exp_report_line_id exp_report_lines.exp_report_line_id%TYPE;
  BEGIN
    SELECT exp_report_lines_s.nextval INTO v_exp_report_line_id FROM dual;
    RETURN v_exp_report_line_id;
  END get_exp_report_line_id;

  FUNCTION get_exp_report_dists_id RETURN NUMBER IS
    v_exp_report_dists_id exp_report_dists.exp_report_dists_id%TYPE;
  BEGIN
    SELECT exp_report_dists_s.nextval INTO v_exp_report_dists_id FROM dual;
    RETURN v_exp_report_dists_id;
  END get_exp_report_dists_id;

  FUNCTION get_payment_schedule_line_id RETURN NUMBER IS
    v_payment_schedule_line_id exp_report_pmt_schedules.payment_schedule_line_id%TYPE;
  BEGIN
    SELECT exp_report_pmt_schedules_s.nextval
      INTO v_payment_schedule_line_id
      FROM dual;
    RETURN v_payment_schedule_line_id;
  END get_payment_schedule_line_id;

  FUNCTION get_document_id(p_exp_report_line_id NUMBER) RETURN NUMBER IS
    v_exp_report_header_id exp_report_lines.exp_report_header_id%TYPE;
  BEGIN
    SELECT l.exp_report_header_id
      INTO v_exp_report_header_id
      FROM exp_report_lines l
     WHERE l.exp_report_line_id = p_exp_report_line_id;
    RETURN v_exp_report_header_id;
  EXCEPTION
    WHEN no_data_found THEN
      RETURN NULL;
  END get_document_id;

  FUNCTION get_retpor_date(p_exp_report_header_id NUMBER) RETURN DATE IS
    v_report_date exp_report_headers.report_date%TYPE;
  BEGIN
    SELECT report_date
      INTO v_report_date
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
    RETURN v_report_date;
  END get_retpor_date;

  --获取费用类型的审批方式
  FUNCTION get_auto_approve_flag(p_exp_rep_type_id NUMBER) RETURN VARCHAR2 IS
    v_auto_approve_flag exp_expense_report_types.auto_approve_flag%TYPE;
  BEGIN
    SELECT nvl(t.auto_approve_flag, 'N')
      INTO v_auto_approve_flag
      FROM exp_expense_report_types t
     WHERE t.expense_report_type_id = p_exp_rep_type_id;
  
    RETURN v_auto_approve_flag;
  END get_auto_approve_flag;

  --审核
  FUNCTION get_auto_audit_flag(p_exp_rep_type_id NUMBER) RETURN VARCHAR2 IS
    v_auto_audit_flag exp_expense_report_types.auto_audit_flag%TYPE;
  BEGIN
    SELECT nvl(t.auto_audit_flag, 'N')
      INTO v_auto_audit_flag
      FROM exp_expense_report_types t
     WHERE t.expense_report_type_id = p_exp_rep_type_id;
    RETURN v_auto_audit_flag;
  END get_auto_audit_flag;

  FUNCTION check_exists_doc_number(p_doc_number VARCHAR2,
                                   p_company_id NUMBER) RETURN VARCHAR2 IS
    v_exsit VARCHAR2(1);
  BEGIN
  
    SELECT decode(COUNT(0), 0, 'N', 1, 'Y', 'Y')
      INTO v_exsit
      FROM exp_report_headers t
     WHERE t.company_id = p_company_id
       AND t.exp_report_number = p_doc_number;
  
    RETURN v_exsit;
  EXCEPTION
    WHEN OTHERS THEN
      RETURN fnd_code_rule_pkg.c_error;
  END check_exists_doc_number;

  -- 检查所勾选的报销单计划付款行上是否存在未核销的借款
  -- 检查所勾选的报销单计划付款行上是否存在未核销的借款
  PROCEDURE check_pmt_schedule_ln_unwf_amt(p_exp_report_head_id NUMBER,
                                           p_check_flag         OUT VARCHAR2) AS
    v_count            NUMBER;
    v_write_off_status VARCHAR2(10);
  BEGIN
  
    SELECT h.write_off_status
      INTO v_write_off_status
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_head_id;
  
    IF v_write_off_status = 'C' THEN
      p_check_flag := 'Y';
      RETURN;
    
    END IF;
  
    SELECT COUNT(*)
      INTO v_count
      FROM csh_transaction_headers  th,
           csh_transaction_lines    tl,
           exp_report_headers       rh,
           exp_report_pmt_schedules ps
     WHERE th.transaction_header_id = tl.transaction_header_id
       AND tl.partner_category = ps.payee_category
       AND tl.partner_id = ps.payee_id
       AND rh.exp_report_header_id = ps.exp_report_header_id
       AND th.transaction_type = 'PREPAYMENT'
       AND th.returned_flag IN ('N', 'Y')
       AND th.reversed_flag IS NULL
       AND tl.currency_code = ps.currency
       AND (tl.transaction_amount -
           (SELECT nvl(SUM(cwo.csh_write_off_amount), 0)
               FROM csh_write_off cwo
              WHERE cwo.csh_transaction_line_id = tl.transaction_line_id
                AND cwo.write_off_type = 'PREPAYMENT_EXPENSE_REPORT') -
           (SELECT nvl(SUM(ctl2.transaction_amount), 0)
               FROM csh_transaction_headers cth1,
                    csh_transaction_lines   ctl1,
                    csh_transaction_headers cth2,
                    csh_transaction_lines   ctl2
              WHERE ctl1.transaction_line_id = tl.transaction_line_id
                AND ctl1.transaction_header_id = cth1.transaction_header_id
                AND cth2.source_header_id = cth1.transaction_header_id
                AND cth2.transaction_header_id = ctl2.transaction_header_id
                AND cth2.reversed_flag IS NULL)) > 0
          
       AND rh.exp_report_header_id = p_exp_report_head_id;
  
    IF v_count = 0 THEN
      p_check_flag := 'Y';
    ELSE
      p_check_flag := 'N';
    
    END IF;
  END check_pmt_schedule_ln_unwf_amt;

  --检查当前的计划付款行的收款方是否有未核销的借款
  --当返回Y时说明不存在未核销的借款，当返回N时说明存在未核销的借款
  FUNCTION check_pmt_schedule_ln_unwf_fun(p_payment_schedule_line_id NUMBER,
                                          p_company_id               NUMBER)
    RETURN VARCHAR2 AS
    v_count            NUMBER;
    v_check_flag       VARCHAR2(1);
    v_write_off_amount NUMBER;
    v_due_amount       NUMBER;
    v_employee_id      NUMBER;
    v_payee_id         NUMBER;
  BEGIN
    SELECT eh.employee_id
      INTO v_employee_id
      FROM exp_report_headers eh, exp_report_pmt_schedules erp
     WHERE eh.exp_report_header_id = erp.exp_report_header_id
       AND erp.payment_schedule_line_id = p_payment_schedule_line_id;
  
    SELECT erp.payee_id
      INTO v_payee_id
      FROM exp_report_pmt_schedules erp
     WHERE erp.payment_schedule_line_id = p_payment_schedule_line_id;
  
    SELECT COUNT(*)
      INTO v_count
      FROM csh_transaction_headers  th,
           csh_transaction_lines    tl,
           exp_report_pmt_schedules ps
     WHERE th.transaction_header_id = tl.transaction_header_id
       AND tl.partner_category = ps.payee_category
       AND tl.partner_id = ps.payee_id
       AND th.returned_flag IN ('N', 'Y')
       AND th.reversed_flag IS NULL
       AND tl.currency_code = ps.currency
       AND th.transaction_type = 'PREPAYMENT'
       AND th.posted_flag = 'Y'
       AND (tl.transaction_amount -
           (SELECT nvl(SUM(cwo.csh_write_off_amount), 0)
               FROM csh_write_off cwo
              WHERE cwo.csh_transaction_line_id = tl.transaction_line_id
                AND cwo.write_off_type = 'PREPAYMENT_EXPENSE_REPORT') -
           (SELECT nvl(SUM(ctl2.transaction_amount), 0)
               FROM csh_transaction_headers cth1,
                    csh_transaction_lines   ctl1,
                    csh_transaction_headers cth2,
                    csh_transaction_lines   ctl2
              WHERE ctl1.transaction_line_id = tl.transaction_line_id
                AND ctl1.transaction_header_id = cth1.transaction_header_id
                AND cth2.source_header_id = cth1.transaction_header_id
                AND cth2.transaction_header_id = ctl2.transaction_header_id
                AND cth2.reversed_flag IS NULL) -- -
           --再减去本次报销单核销金额
           -------------------begin ------------------
           /*nvl((SELECT SUM(cwo.csh_write_off_amount)
             FROM csh_write_off cwo
            WHERE cwo.document_line_id IN
                  (SELECT es.payment_schedule_line_id
                     FROM exp_report_pmt_schedules es
                    WHERE es.exp_report_header_id =
                          ps.exp_report_header_id)
              AND cwo.document_header_id = ps.exp_report_header_id
              AND cwo.document_source = 'EXPENSE_REPORT'
              AND cwo.write_off_type = 'PREPAYMENT_EXPENSE_REPORT'
              AND cwo.csh_transaction_line_id = tl.transaction_line_id),
           0)*/
           -------------------end ------------------  
           ) > 0
       AND ps.payment_schedule_line_id = p_payment_schedule_line_id
       AND th.company_id = p_company_id
    --借款单申请人需要与报销单申请人一致
    /*AND EXISTS
    (SELECT 1
             FROM csh_transaction_headers      th,
                  csh_transaction_headers      ph,
                  csh_transaction_lines        pl,
                  csh_payment_requisition_refs ef,
                  csh_payment_requisition_lns  cprl,
                  csh_payment_requisition_hds  cprh
            WHERE tl.transaction_header_id = th.transaction_header_id
              AND th.source_payment_header_id = ph.transaction_header_id
              AND ph.transaction_header_id = pl.transaction_header_id
              AND ef.csh_transaction_line_id = pl.transaction_line_id
              AND ef.payment_requisition_line_id =
                  cprl.payment_requisition_line_id
              AND cprh.payment_requisition_header_id =
                  cprl.payment_requisition_header_id
                 -- AND cprh.employee_id = v_employee_id
                 --国任收款方相同才能核销
              AND cprl.partner_id = v_payee_id)*/
    ;
  
    IF v_count = 0 THEN
      v_check_flag := 'Y';
    ELSE
      v_check_flag := 'N';
      -- 计划付款行上的金额是否已完全核销
      SELECT SUM(cwo.csh_write_off_amount)
        INTO v_write_off_amount
        FROM csh_write_off            cwo,
             exp_report_pmt_schedules es,
             exp_report_headers       s
       WHERE cwo.document_line_id = es.payment_schedule_line_id
         AND cwo.document_header_id = es.exp_report_header_id
         AND cwo.document_source = 'EXPENSE_REPORT'
         AND cwo.write_off_type = 'PREPAYMENT_EXPENSE_REPORT'
         AND es.exp_report_header_id = s.exp_report_header_id
         AND es.payment_schedule_line_id = p_payment_schedule_line_id;
    
      SELECT es.due_amount
        INTO v_due_amount
        FROM exp_report_pmt_schedules es
       WHERE es.payment_schedule_line_id = p_payment_schedule_line_id;
    
      IF (v_write_off_amount >= v_due_amount) THEN
        v_check_flag := 'Y';
      ELSE
        v_check_flag := 'N';
      END IF;
    END IF;
    RETURN v_check_flag;
  END;

  -- 校验报销单计划支付行是否发生核销，没有发生返回‘Y’，否则返回'N'
  FUNCTION check_pmt_schedule_ln_occur_wf(p_payment_schedule_line_id NUMBER)
    RETURN VARCHAR2 AS
    v_count NUMBER;
  BEGIN
    SELECT COUNT(*)
      INTO v_count
      FROM csh_write_off            cwo,
           exp_report_pmt_schedules es,
           exp_report_headers       s
     WHERE cwo.document_line_id = es.payment_schedule_line_id
       AND cwo.document_header_id = es.exp_report_header_id
       AND cwo.document_source = 'EXPENSE_REPORT'
       AND cwo.write_off_type = 'PREPAYMENT_EXPENSE_REPORT'
       AND es.exp_report_header_id = s.exp_report_header_id
       AND es.payment_schedule_line_id = p_payment_schedule_line_id;
  
    IF v_count = 0 THEN
      RETURN 'Y';
    
    ELSE
      RETURN 'N';
    END IF;
  
  END check_pmt_schedule_ln_occur_wf;

  --added by Zealot at 20140702 报销单行金额维护后重置报销单核销状态
  PROCEDURE reset_exp_rpt_write_off_flag(p_exp_report_header_id NUMBER,
                                         p_created_by           NUMBER) IS
    v_report_amount    NUMBER := 0;
    v_write_off_amount NUMBER := 0;
    v_write_off_flag   VARCHAR2(10);
  BEGIN
    SELECT (SELECT nvl(SUM(l.report_amount), 0)
              FROM exp_report_lines l
             WHERE l.exp_report_header_id = h.exp_report_header_id),
           (SELECT nvl(SUM(cwo.csh_write_off_amount), 0)
              FROM csh_write_off cwo, exp_report_pmt_schedules ps
             WHERE h.exp_report_header_id = ps.exp_report_header_id
               AND cwo.document_line_id = ps.payment_schedule_line_id
               AND cwo.document_header_id = ps.exp_report_header_id
               AND cwo.document_source = 'EXPENSE_REPORT')
      INTO v_report_amount, v_write_off_amount
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
    IF v_write_off_amount > 0 THEN
      IF v_report_amount - v_write_off_amount > 0 THEN
        v_write_off_flag := 'Y';
      ELSIF v_report_amount - v_write_off_amount <= 0 THEN
        v_write_off_flag := 'C';
      END IF;
    ELSE
      v_write_off_flag := 'N';
    END IF;
  
    UPDATE exp_report_headers h
       SET h.write_off_status = v_write_off_flag
     WHERE h.exp_report_header_id = p_exp_report_header_id;
  EXCEPTION
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_created_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'reset_exp_rpt_write_off_flag');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END reset_exp_rpt_write_off_flag;

  FUNCTION get_exp_report_number(p_document_type     VARCHAR2,
                                 p_company_id        NUMBER,
                                 p_operation_unit_id NUMBER,
                                 p_operation_date    DATE,
                                 p_created_by        NUMBER) RETURN VARCHAR2 IS
  
    c_coding_usage_code CONSTANT VARCHAR2(30) := '02';
  
    v_start_doc_number exp_report_headers.exp_report_number%TYPE;
    v_document_number  exp_report_headers.exp_report_number%TYPE;
  
    v_count NUMBER;
  BEGIN
    v_start_doc_number := fnd_code_rule_pkg.get_rule_next_auto_num(p_document_category => c_coding_usage_code,
                                                                   p_document_type     => p_document_type,
                                                                   p_company_id        => p_company_id,
                                                                   p_operation_unit_id => p_operation_unit_id,
                                                                   p_operation_date    => p_operation_date,
                                                                   p_created_by        => p_created_by);
    IF fnd_code_rule_pkg.c_error = v_start_doc_number THEN
      RETURN fnd_code_rule_pkg.c_error;
    END IF;
    v_document_number := v_start_doc_number;
    v_count           := 1;
  
    IF check_exists_doc_number(v_document_number, p_company_id) = 'Y' THEN
      LOOP
        v_document_number := fnd_code_rule_pkg.get_rule_next_auto_num(p_document_category => c_coding_usage_code,
                                                                      p_document_type     => p_document_type,
                                                                      p_company_id        => p_company_id,
                                                                      p_operation_unit_id => p_operation_unit_id,
                                                                      p_operation_date    => p_operation_date,
                                                                      p_created_by        => p_created_by);
        IF v_start_doc_number = v_document_number AND v_count > 1 THEN
          RETURN fnd_code_rule_pkg.c_error;
        END IF;
        IF check_exists_doc_number(v_document_number, p_company_id) = 'N' THEN
          RETURN v_document_number;
        END IF;
        v_count := v_count + 1;
      END LOOP;
    ELSE
      RETURN v_document_number;
    END IF;
  
  END get_exp_report_number;

  --获取起始行号、步长
  PROCEDURE get_line_number(p_expense_report_type_id NUMBER,
                            p_line_number_beginning  OUT NUMBER,
                            p_step_length            OUT NUMBER) IS
  BEGIN
    SELECT t.line_number_beginning, t.step_length
      INTO p_line_number_beginning, p_step_length
      FROM exp_expense_report_types t
     WHERE t.expense_report_type_id = p_expense_report_type_id;
  
    -- 万联证券修改规则
    p_line_number_beginning := 1;
    p_step_length           := 1;
  END get_line_number;

  --计划付款行号
  FUNCTION get_schedule_line_number(p_exp_report_header_id NUMBER)
    RETURN NUMBER IS
    v_line_num NUMBER;
  BEGIN
    SELECT nvl(MAX(l.schedule_line_number), 0)
      INTO v_line_num
      FROM exp_report_pmt_schedules l
     WHERE l.exp_report_header_id = p_exp_report_header_id;
    RETURN v_line_num + 10;
  
  EXCEPTION
    WHEN no_data_found THEN
      RETURN 10;
  END get_schedule_line_number;

  --是否调整报销单
  FUNCTION get_report_tye_adjustment(p_exp_report_type_id NUMBER)
    RETURN VARCHAR2 IS
    v_adjustment_flag exp_expense_report_types.adjustment_flag%TYPE;
  BEGIN
    SELECT nvl(adjustment_flag, 'N')
      INTO v_adjustment_flag
      FROM exp_expense_report_types t
     WHERE t.expense_report_type_id = p_exp_report_type_id;
    RETURN v_adjustment_flag;
  END get_report_tye_adjustment;

  --是否模板类报销单
  FUNCTION get_report_type_template_flag(p_exp_report_type_id NUMBER)
    RETURN VARCHAR2 IS
    v_template_flag exp_expense_report_types.template_flag%TYPE;
  BEGIN
    SELECT nvl(template_flag, 'N')
      INTO v_template_flag
      FROM exp_expense_report_types t
     WHERE t.expense_report_type_id = p_exp_report_type_id;
    RETURN v_template_flag;
  END get_report_type_template_flag;

  --数字正负校验
  PROCEDURE sign_check(p_exp_report_type_id NUMBER,
                       p_number             NUMBER,
                       p_user_id            NUMBER) IS
    e_sign_error EXCEPTION;
    e_zero_error EXCEPTION;
  BEGIN
    IF get_report_type_template_flag(p_exp_report_type_id) = 'N' THEN
      IF get_report_tye_adjustment(p_exp_report_type_id) = 'N' THEN
        /* IF p_number <= 0 THEN
          RAISE e_sign_error;
        END IF;*/
        IF p_number < 0 THEN
          RAISE e_sign_error;
        END IF;
      END IF;
    
      /* IF p_number = 0 THEN
        RAISE e_zero_error;
      END IF;*/
    END IF;
  EXCEPTION
    WHEN e_zero_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_ZERO_CHECK_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'update_status_check');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_sign_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_POSITIVE_NUMBER_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'update_status_check');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END sign_check;

  FUNCTION get_expense_budget_item_id(p_expense_item_id NUMBER) RETURN NUMBER IS
    v_budget_item_id exp_expense_items.budget_item_id%TYPE;
    v_req_item_id    exp_expense_items.req_item_id%TYPE;
  BEGIN
    SELECT budget_item_id, req_item_id
      INTO v_budget_item_id, v_req_item_id
      FROM exp_expense_items i
     WHERE i.expense_item_id = p_expense_item_id
       AND i.enabled_flag = 'Y';
  
    IF v_budget_item_id IS NULL THEN
      IF v_req_item_id IS NOT NULL THEN
        SELECT r.budget_item_id
          INTO v_budget_item_id
          FROM exp_req_items r
         WHERE r.req_item_id = v_req_item_id;
      END IF;
    END IF;
  
    RETURN v_budget_item_id;
  EXCEPTION
    WHEN no_data_found THEN
      RETURN NULL;
  END get_expense_budget_item_id;

  FUNCTION update_status_check(p_exp_report_header_id NUMBER,
                               p_user_id              NUMBER) RETURN VARCHAR2 IS
  
    v_exp_report_header_id exp_report_headers.exp_report_header_id%TYPE;
  BEGIN
    SELECT exp_report_header_id
      INTO v_exp_report_header_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id
       AND h.report_status IN ('GENERATE',
                               'TAKEN_BACK',
                               'REJECTED',
                               'COMPLETELY_APPROVED', --modified by HM 2016-05-20 工作台审核也可以保存
                               'SUBMITTED' --modified by HM 2016-07-28 工作台审核也可以保存
                               )
       FOR UPDATE NOWAIT;
  
    RETURN 'Y';
  EXCEPTION
    WHEN e_lock_table THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_LOCK_RECORD_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'update_status_check');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN no_data_found THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_UPDATE_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'update_status_check');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END update_status_check;
  --20130318 sqh 报销单核销时判断单据状态
  FUNCTION write_off_check_status(p_exp_report_header_id NUMBER,
                                  p_user_id              NUMBER)
    RETURN VARCHAR2 IS
  
    v_exp_report_header_id exp_report_headers.exp_report_header_id%TYPE;
  BEGIN
    SELECT exp_report_header_id
      INTO v_exp_report_header_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id
       AND h.report_status != 'SUBMITTED'
       FOR UPDATE NOWAIT;
  
    RETURN 'Y';
  EXCEPTION
    WHEN e_lock_table THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_LOCK_RECORD_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'update_status_check');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN no_data_found THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_UPDATE_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'update_status_check');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END write_off_check_status;
  FUNCTION delete_data_check(p_exp_report_header_id NUMBER) RETURN VARCHAR2 IS
  
    /* Remind :
    return Y : means can be delete
    return N : means cannot be delete*/
  
    v_exp_report_header_id exp_report_headers.exp_report_header_id%TYPE;
  BEGIN
    SELECT exp_report_header_id
      INTO v_exp_report_header_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id
       AND h.report_status IN
           ('GENERATE', 'REJECTED' /*, 'SUBMITTED'*/, 'TAKEN_BACK')
       FOR UPDATE NOWAIT;
    RETURN 'Y';
  EXCEPTION
    WHEN e_lock_table THEN
      RAISE e_lock_table;
    WHEN no_data_found THEN
      RAISE e_delete_error;
  END delete_data_check;

  FUNCTION delete_write_off_check(p_exp_report_header_id NUMBER)
    RETURN VARCHAR2 IS
  
    /* Remind :
    return Y : means can be delete
    return N : means cannot be delete*/
  
    v_exp_report_header_id exp_report_headers.exp_report_header_id%TYPE;
  BEGIN
    SELECT exp_report_header_id
      INTO v_exp_report_header_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id
       AND h.report_status IN ('GENERATE',
                               'REJECTED' /*, 'SUBMITTED'*/,
                               'TAKEN_BACK',
                               'COMPLETELY_APPROVED')
       FOR UPDATE NOWAIT;
    RETURN 'Y';
  EXCEPTION
    WHEN e_lock_table THEN
      RAISE e_lock_table;
    WHEN no_data_found THEN
      RAISE e_delete_error;
  END delete_write_off_check;

  --删除报销单与申请单相关
  PROCEDURE del_released_budget_reserves(p_document_id      NUMBER,
                                         p_document_line_id NUMBER,
                                         p_document_dist_id NUMBER,
                                         p_user_id          NUMBER) IS
    TYPE requisition_dists IS TABLE OF NUMBER INDEX BY BINARY_INTEGER;
    v_req_dists             requisition_dists;
    v_num                   NUMBER := 0;
    v_requisition_header_id NUMBER;
  BEGIN
    IF p_document_dist_id IS NOT NULL THEN
      DELETE FROM bgt_budget_reserves br
       WHERE br.release_id IN
             (SELECT DISTINCT r.release_id
                FROM exp_requisition_release r
               WHERE r.document_type = c_exp_report
                 AND r.document_dist_id = p_document_dist_id);
    
      FOR v_req_dists_id IN (SELECT DISTINCT r.exp_requisition_dist_id,
                                             r.exp_requisition_header_id
                               FROM exp_requisition_release r
                              WHERE r.document_type = c_exp_report
                                AND r.document_dist_id = p_document_dist_id) LOOP
        v_num := v_num + 1;
        v_req_dists(v_num) := v_req_dists_id.exp_requisition_dist_id;
        v_requisition_header_id := v_req_dists_id.exp_requisition_header_id;
      END LOOP;
    
      DELETE FROM exp_requisition_release r
       WHERE r.document_type = c_exp_report
         AND r.document_dist_id = p_document_dist_id;
    
      FOR i IN 1 .. v_req_dists.count LOOP
        exp_requisitions_release_pkg.set_requisition_dists_release(p_exp_requisition_dist_id => v_req_dists(i),
                                                                   p_user_id                 => p_user_id);
      END LOOP;
    
    ELSIF p_document_line_id IS NOT NULL THEN
      DELETE FROM bgt_budget_reserves br
       WHERE br.release_id IN
             (SELECT DISTINCT r.release_id
                FROM exp_requisition_release r
               WHERE r.document_type = c_exp_report
                 AND r.document_line_id = p_document_line_id);
    
      FOR v_req_dists_id IN (SELECT DISTINCT r.exp_requisition_dist_id,
                                             r.exp_requisition_header_id
                               FROM exp_requisition_release r
                              WHERE r.document_type = c_exp_report
                                AND r.document_line_id = p_document_line_id) LOOP
        v_num := v_num + 1;
        v_req_dists(v_num) := v_req_dists_id.exp_requisition_dist_id;
        v_requisition_header_id := v_req_dists_id.exp_requisition_header_id;
      END LOOP;
    
      DELETE FROM exp_requisition_release r
       WHERE r.document_type = c_exp_report
         AND r.document_line_id = p_document_line_id;
    
      FOR i IN 1 .. v_req_dists.count LOOP
        exp_requisitions_release_pkg.set_requisition_dists_release(p_exp_requisition_dist_id => v_req_dists(i),
                                                                   p_user_id                 => p_user_id);
      END LOOP;
    
    ELSIF p_document_id IS NOT NULL THEN
      DELETE FROM bgt_budget_reserves br
       WHERE br.release_id IN
             (SELECT DISTINCT r.release_id
                FROM exp_requisition_release r
               WHERE r.document_type = c_exp_report
                 AND r.document_id = p_document_id);
    
      FOR v_req_dists_id IN (SELECT DISTINCT r.exp_requisition_dist_id,
                                             r.exp_requisition_header_id
                               FROM exp_requisition_release r
                              WHERE r.document_type = c_exp_report
                                AND r.document_id = p_document_id) LOOP
        v_num := v_num + 1;
        v_req_dists(v_num) := v_req_dists_id.exp_requisition_dist_id;
        v_requisition_header_id := v_req_dists_id.exp_requisition_header_id;
      END LOOP;
    
      DELETE FROM exp_requisition_release r
       WHERE r.document_type = c_exp_report
         AND r.document_id = p_document_id;
    
      FOR i IN 1 .. v_req_dists.count LOOP
        exp_requisitions_release_pkg.set_requisition_dists_release(p_exp_requisition_dist_id => v_req_dists(i),
                                                                   p_user_id                 => p_user_id);
      END LOOP;
    END IF;
  
    IF exp_requisition_dists_closed(v_requisition_header_id) THEN
      --申请单已被关闭，调整保留额
      exp_requisitions_release_pkg.closed_exp_req_bgt_reserve_adj(p_exp_req_header_id => v_requisition_header_id,
                                                                  p_user_id           => p_user_id);
    END IF;
  END del_released_budget_reserves;

  --删除报销单与差旅计划相关
  PROCEDURE del_tp_released_reserves(p_document_id      NUMBER,
                                     p_document_line_id NUMBER,
                                     p_document_dist_id NUMBER,
                                     p_user_id          NUMBER) IS
    TYPE tp_dists IS TABLE OF NUMBER INDEX BY BINARY_INTEGER;
    v_tp_dists     tp_dists;
    v_num          NUMBER := 0;
    v_tp_header_id NUMBER;
  BEGIN
    IF p_document_dist_id IS NOT NULL THEN
      DELETE FROM bgt_budget_reserves br
       WHERE br.release_id IN
             (SELECT DISTINCT r.release_id
                FROM exp_travel_plan_release r
               WHERE r.document_type = c_exp_report
                 AND r.document_dist_id = p_document_dist_id);
    
      FOR v_tp_dists_id IN (SELECT DISTINCT r.exp_travel_plan_dist_id,
                                            r.exp_travel_plan_header_id
                              FROM exp_travel_plan_release r
                             WHERE r.document_type = c_exp_report
                               AND r.document_dist_id = p_document_dist_id) LOOP
        v_num := v_num + 1;
        v_tp_dists(v_num) := v_tp_dists_id.exp_travel_plan_dist_id;
        v_tp_header_id := v_tp_dists_id.exp_travel_plan_header_id;
      END LOOP;
    
      DELETE FROM exp_travel_plan_release r
       WHERE r.document_type = c_exp_report
         AND r.document_dist_id = p_document_dist_id;
    
      FOR i IN 1 .. v_tp_dists.count LOOP
        exp_travel_plan_release_pkg.set_tp_dists_release(p_exp_tp_dist_id => v_tp_dists(i),
                                                         p_user_id        => p_user_id);
      END LOOP;
    
    ELSIF p_document_line_id IS NOT NULL THEN
      DELETE FROM bgt_budget_reserves br
       WHERE br.release_id IN
             (SELECT DISTINCT r.release_id
                FROM exp_travel_plan_release r
               WHERE r.document_type = c_exp_report
                 AND r.document_line_id = p_document_line_id);
    
      FOR v_tp_dists_id IN (SELECT DISTINCT r.exp_travel_plan_dist_id,
                                            r.exp_travel_plan_header_id
                              FROM exp_travel_plan_release r
                             WHERE r.document_type = c_exp_report
                               AND r.document_line_id = p_document_line_id) LOOP
        v_num := v_num + 1;
        v_tp_dists(v_num) := v_tp_dists_id.exp_travel_plan_dist_id;
        v_tp_header_id := v_tp_dists_id.exp_travel_plan_header_id;
      END LOOP;
    
      DELETE FROM exp_travel_plan_release r
       WHERE r.document_type = c_exp_report
         AND r.document_line_id = p_document_line_id;
    
      FOR i IN 1 .. v_tp_dists.count LOOP
        exp_travel_plan_release_pkg.set_tp_dists_release(p_exp_tp_dist_id => v_tp_dists(i),
                                                         p_user_id        => p_user_id);
      END LOOP;
    
    ELSIF p_document_id IS NOT NULL THEN
      DELETE FROM bgt_budget_reserves br
       WHERE br.release_id IN
             (SELECT DISTINCT r.release_id
                FROM exp_travel_plan_release r
               WHERE r.document_type = c_exp_report
                 AND r.document_id = p_document_id);
    
      FOR v_tp_dists_id IN (SELECT DISTINCT r.exp_travel_plan_dist_id,
                                            r.exp_travel_plan_header_id
                              FROM exp_travel_plan_release r
                             WHERE r.document_type = c_exp_report
                               AND r.document_id = p_document_id) LOOP
        v_num := v_num + 1;
        v_tp_dists(v_num) := v_tp_dists_id.exp_travel_plan_dist_id;
        v_tp_header_id := v_tp_dists_id.exp_travel_plan_header_id;
      END LOOP;
    
      DELETE FROM exp_travel_plan_release r
       WHERE r.document_type = c_exp_report
         AND r.document_id = p_document_id;
    
      FOR i IN 1 .. v_tp_dists.count LOOP
        exp_travel_plan_release_pkg.set_tp_dists_release(p_exp_tp_dist_id => v_tp_dists(i),
                                                         p_user_id        => p_user_id);
      END LOOP;
    END IF;
  
  END del_tp_released_reserves;

  /*************************************************
  -- Author  : majianjian
  -- Created : 2015/3/25 15:21:49
  -- Ver     : 1.1
  -- Purpose : 删除报销单对应差旅计划的预算释放
  **************************************************/
  PROCEDURE del_tra_plan_reserves_release(p_exp_report_header_id IN NUMBER,
                                          p_exp_report_line_id   IN NUMBER) IS
  
  BEGIN
    IF p_exp_report_line_id IS NOT NULL THEN
      DELETE FROM bgt_budget_reserves r
       WHERE r.business_type = 'EXP_TRAVEL_PLAN'
         AND r.release_id = p_exp_report_line_id;
    ELSIF p_exp_report_header_id IS NOT NULL THEN
      DELETE FROM bgt_budget_reserves r
       WHERE r.business_type = 'EXP_TRAVEL_PLAN'
         AND EXISTS
       (SELECT 1
                FROM exp_report_lines l
               WHERE l.exp_report_header_id = p_exp_report_header_id
                 AND l.exp_report_line_id = r.release_id);
    END IF;
  END;

  /*procedure get_employee_info(p_employee_id     number,
                              p_company_id      number,
                              p_unit_id         number,
                              p_operate_unit_id out number,
                              p_position_id     out number) is
  begin
    if p_employee_id is not null then
      begin
        select e.position_id
          into p_position_id
          from exp_employee_assigns e
         where e.employee_id = p_employee_id
           and e.company_id = p_company_id
           and e.primary_position_flag = 'Y'
           and e.enabled_flag = 'Y';
      exception
        when no_data_found then
          p_position_id := '';
      end;
    end if;
  
    if p_unit_id is not null then
      begin
        select operate_unit_id
          into p_operate_unit_id
          from exp_org_unit o
         where o.unit_id = p_unit_id;
      exception
        when no_data_found then
          p_operate_unit_id := '';
      end;
    end if;
  
  end get_employee_info;*/

  --0025672: 报销单类型定义显示字段自审核和可支付标志，并对报销单保存逻辑做相应修改
  PROCEDURE auto_audit_flag_check(p_exp_report_type_id NUMBER,
                                  p_je_creation_status OUT VARCHAR2,
                                  p_audit_flag         OUT VARCHAR2,
                                  p_audit_date         OUT DATE) IS
  BEGIN
    IF get_auto_audit_flag(p_exp_report_type_id) = 'Y' THEN
      p_je_creation_status := 'NEVER';
      p_audit_flag         := 'Y';
      p_audit_date         := SYSDATE;
    ELSE
      p_je_creation_status := 'N';
      p_audit_flag         := 'N';
      p_audit_date         := NULL;
    END IF;
  END auto_audit_flag_check;

  PROCEDURE insert_exp_report_headers(p_exp_report_header_id NUMBER,
                                      p_company_id           NUMBER,
                                      --p_operation_unit_id        number,
                                      --p_exp_report_number  varchar2,
                                      p_exp_report_barcode VARCHAR2,
                                      p_employee_id        NUMBER,
                                      p_position_id        NUMBER,
                                      --p_unit_id                  number,
                                      p_payee_category          VARCHAR2,
                                      p_payee_id                NUMBER,
                                      p_exp_report_type_id      NUMBER,
                                      p_expense_user_group_id   NUMBER,
                                      p_currency_code           VARCHAR2,
                                      p_exchange_rate_type      VARCHAR2,
                                      p_exchange_rate_quotation VARCHAR2,
                                      p_exchange_rate           NUMBER,
                                      p_report_date             DATE,
                                      p_period_name             VARCHAR2,
                                      p_report_status           VARCHAR2,
                                      --p_je_creation_status       varchar2 default 'N',
                                      -- p_audit_flag               varchar2 default 'N',
                                      --p_audit_date               date,
                                      p_gld_interface_flag          VARCHAR2 DEFAULT 'N',
                                      p_attachment_num              NUMBER,
                                      p_description                 VARCHAR2,
                                      p_write_off_status            VARCHAR2 DEFAULT 'N',
                                      p_write_off_completed_date    DATE,
                                      p_reversed_flag               VARCHAR2,
                                      p_source_exp_rep_header_id    NUMBER,
                                      p_created_by                  NUMBER,
                                      p_operation_date              DATE DEFAULT NULL,
                                      p_source_type                 VARCHAR2 DEFAULT 'MANUAL',
                                      p_payment_method_id           NUMBER,
                                      p_vat_special_invoice_include VARCHAR2 DEFAULT NULL,
                                      p_consistent_invoice_amount   VARCHAR2 DEFAULT 'N',
                                      p_pay_company_id              VARCHAR2 DEFAULT NULL,
                                      p_contract_header_id          NUMBER DEFAULT NULL,
                                      p_associated_oasign           VARCHAR2 DEFAULT NULL,
                                      p_metting_type_code           VARCHAR2 DEFAULT NULL,
                                      p_special_situation           VARCHAR2 DEFAULT NULL) IS
    v_operation_unit_id exp_report_headers.operation_unit_id%TYPE;
    --v_position_id       exp_report_headers.position_id%type;
    v_unit_id exp_report_headers.unit_id%TYPE;
  
    v_exp_report_number  exp_report_headers.exp_report_number%TYPE;
    v_je_creation_status exp_report_headers.je_creation_status%TYPE;
    v_audit_flag         exp_report_headers.audit_flag%TYPE;
    v_audit_date         exp_report_headers.audit_date%TYPE;
    v_amortization_flag  exp_report_headers.amortization_flag%TYPE;
  
    e_doc_number_error EXCEPTION;
  BEGIN
  
    exp_requisition_pkg.get_head_unit_id(p_position_id     => p_position_id,
                                         p_unit_id         => v_unit_id,
                                         p_operate_unit_id => v_operation_unit_id);
  
    v_exp_report_number := get_exp_report_number(p_document_type     => p_exp_report_type_id,
                                                 p_company_id        => p_company_id,
                                                 p_operation_unit_id => v_operation_unit_id,
                                                 p_operation_date    => p_report_date,
                                                 p_created_by        => p_created_by);
  
    IF v_exp_report_number = fnd_code_rule_pkg.c_error THEN
      RAISE e_doc_number_error;
    END IF;
  
    /*auto_audit_flag_check(p_exp_report_type_id => p_exp_report_type_id,
    p_je_creation_status => v_je_creation_status,
    p_audit_flag         => v_audit_flag,
    p_audit_date         => v_audit_date);*/
  
    v_je_creation_status := 'N';
    v_audit_flag         := 'N';
    v_audit_date         := NULL;
  
    SELECT tt.amortization_flag
      INTO v_amortization_flag
      FROM exp_expense_report_types tt
     WHERE tt.expense_report_type_id = p_exp_report_type_id;
  
    INSERT INTO exp_report_headers
      (exp_report_header_id,
       company_id,
       operation_unit_id,
       exp_report_number,
       exp_report_barcode,
       employee_id,
       position_id,
       unit_id,
       payee_category,
       payee_id,
       exp_report_type_id,
       expense_user_group_id,
       currency_code,
       exchange_rate_type,
       exchange_rate_quotation,
       exchange_rate,
       report_date,
       period_name,
       report_status,
       je_creation_status,
       audit_flag,
       audit_date,
       gld_interface_flag,
       attachment_num,
       description,
       write_off_status,
       write_off_completed_date,
       reversed_flag,
       source_exp_rep_header_id,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date,
       amortization_flag,
       source_type,
       payment_method_id,
       vat_special_invoice_include,
       consistent_invoice_amount,
       pay_company_id,
       contract_header_id,
       associated_oasign,
       metting_type_code,
       special_situation)
    VALUES
      (p_exp_report_header_id,
       p_company_id,
       v_operation_unit_id,
       v_exp_report_number,
       p_exp_report_barcode,
       p_employee_id,
       p_position_id,
       v_unit_id,
       p_payee_category,
       p_payee_id,
       p_exp_report_type_id,
       p_expense_user_group_id,
       p_currency_code,
       p_exchange_rate_type,
       p_exchange_rate_quotation,
       p_exchange_rate,
       p_report_date,
       p_period_name,
       p_report_status,
       v_je_creation_status,
       v_audit_flag,
       v_audit_date,
       p_gld_interface_flag,
       p_attachment_num,
       p_description,
       p_write_off_status,
       p_write_off_completed_date,
       p_reversed_flag,
       p_source_exp_rep_header_id,
       p_created_by,
       SYSDATE,
       p_created_by,
       SYSDATE,
       v_amortization_flag,
       p_source_type,
       p_payment_method_id,
       p_vat_special_invoice_include,
       p_consistent_invoice_amount,
       p_pay_company_id,
       p_contract_header_id,
       p_associated_oasign,
       p_metting_type_code,
       p_special_situation);
    FOR cur_lan IN (SELECT *
                      FROM exp_rep_ref_dimensions s
                     WHERE s.expense_report_type_id = p_exp_report_type_id) LOOP
      insert_exp_rep_dim_layouts(p_exp_report_header_id,
                                 cur_lan.layout_position,
                                 cur_lan.layout_priority,
                                 cur_lan.dimension_id,
                                 cur_lan.default_dim_value_id,
                                 p_created_by);
    
    END LOOP;
    FOR cur_obj IN (SELECT *
                      FROM exp_report_ref_object_types s
                     WHERE s.expense_report_type_id = p_exp_report_type_id) LOOP
      insert_exp_rep_objects_layouts(p_exp_report_header_id,
                                     cur_obj.layout_position,
                                     cur_obj.layout_priority,
                                     cur_obj.expense_object_type_id,
                                     cur_obj.default_object_id,
                                     p_created_by);
    END LOOP;
  
    insert_exp_document_histories(p_document_type  => c_exp_report,
                                  p_document_id    => p_exp_report_header_id,
                                  p_operation_code => exp_document_history_pkg.c_generate, --'GENERATE',
                                  p_user_id        => p_created_by,
                                  p_operation_time => SYSDATE,
                                  p_description    => p_description);
  
    /*    IF v_audit_flag = 'Y' THEN
      --创建报销单历史--自审核
      insert_exp_document_histories(p_document_type  => c_exp_report,
                                    p_document_id    => p_exp_report_header_id,
                                    p_operation_code => exp_document_history_pkg.c_audit, --'AUDIT',
                                    p_user_id        => p_created_by,
                                    p_operation_time => SYSDATE,
                                    p_description    => '');
    END IF;*/
  EXCEPTION
    WHEN e_doc_number_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_CODING_RULE_ERROR',
                                                      p_created_by              => p_created_by,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'insert_exp_report_headers');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_created_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'insert_exp_report_headers');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END insert_exp_report_headers;

  PROCEDURE update_exp_report_headers(p_exp_report_header_id NUMBER,
                                      p_exp_report_barcode   VARCHAR2,
                                      p_employee_id          NUMBER,
                                      p_position_id          NUMBER,
                                      --p_unit_id                  number,
                                      p_payee_category        VARCHAR2,
                                      p_payee_id              NUMBER,
                                      p_exp_report_type_id    NUMBER,
                                      p_expense_user_group_id NUMBER,
                                      p_report_date           DATE,
                                      p_period_name           VARCHAR2,
                                      p_report_status         VARCHAR2,
                                      --p_je_creation_status       varchar2,
                                      --p_audit_flag               varchar2,
                                      --p_audit_date               date,
                                      p_gld_interface_flag          VARCHAR2,
                                      p_attachment_num              NUMBER,
                                      p_description                 VARCHAR2,
                                      p_write_off_status            VARCHAR2,
                                      p_write_off_completed_date    DATE,
                                      p_reversed_flag               VARCHAR2,
                                      p_source_exp_rep_header_id    NUMBER,
                                      p_last_updated_by             NUMBER,
                                      p_source_type                 VARCHAR2 DEFAULT 'MANUAL',
                                      p_payment_method_id           NUMBER,
                                      p_user_id                     NUMBER,
                                      p_vat_special_invoice_include VARCHAR2 DEFAULT NULL,
                                      p_consistent_invoice_amount   VARCHAR2 DEFAULT 'N',
                                      p_pay_company_id              VARCHAR2 DEFAULT NULL,
                                      p_contract_header_id          NUMBER DEFAULT NULL,
                                      p_associated_oasign           VARCHAR2 DEFAULT NULL,
                                      p_metting_type_code           VARCHAR2 DEFAULT NULL,
                                      p_special_situation           VARCHAR2 DEFAULT NULL) IS
    v_operation_unit_id exp_report_headers.operation_unit_id%TYPE;
    v_position_id       exp_report_headers.position_id%TYPE;
    v_company_id        exp_report_headers.company_id%TYPE;
    v_unit_id           exp_report_headers.unit_id%TYPE;
  
  BEGIN
    IF update_status_check(p_exp_report_header_id, p_last_updated_by) = 'Y' THEN
      SELECT company_id
        INTO v_company_id
        FROM exp_report_headers
       WHERE exp_report_header_id = p_exp_report_header_id;
    
      /*exp_requisition_pkg.get_head_employee_info(p_employee_id     => p_employee_id,
      p_company_id      => v_company_id,
      p_operate_unit_id => v_operation_unit_id,
      p_unit_id         => v_unit_id,
      p_position_id     => v_position_id);*/
      exp_requisition_pkg.get_head_unit_id(p_position_id     => p_position_id,
                                           p_unit_id         => v_unit_id,
                                           p_operate_unit_id => v_operation_unit_id);
      --重置现金事务核销状态
      csh_write_off_pkg.set_exp_rep_write_off_status(p_exp_report_header_id => p_exp_report_header_id,
                                                     p_user_id              => p_user_id);
      UPDATE exp_report_headers
         SET exp_report_barcode    = p_exp_report_barcode,
             employee_id           = p_employee_id,
             position_id           = p_position_id,
             operation_unit_id     = v_operation_unit_id,
             unit_id               = v_unit_id,
             payee_category        = p_payee_category,
             payee_id              = p_payee_id,
             exp_report_type_id    = p_exp_report_type_id,
             expense_user_group_id = p_expense_user_group_id,
             report_date           = p_report_date,
             period_name           = p_period_name,
             report_status         = p_report_status,
             --je_creation_status       = p_je_creation_status,
             --audit_flag               = p_audit_flag,
             --audit_date               = p_audit_date,
             gld_interface_flag = p_gld_interface_flag,
             attachment_num     = p_attachment_num,
             description        = p_description,
             --ModifiedBy:ZhouHao
             --Purpose:报销单先进行核销，再保存，会出现核销状态被重置的情况
             --write_off_status         = p_write_off_status,
             --write_off_completed_date = p_write_off_completed_date,
             reversed_flag               = p_reversed_flag,
             source_exp_rep_header_id    = p_source_exp_rep_header_id,
             last_updated_by             = p_last_updated_by,
             last_update_date            = SYSDATE,
             source_type                 = p_source_type,
             payment_method_id           = p_payment_method_id,
             vat_special_invoice_include = p_vat_special_invoice_include,
             consistent_invoice_amount   = p_consistent_invoice_amount,
             pay_company_id              = p_pay_company_id,
             contract_header_id          = p_contract_header_id,
             associated_oasign           = p_associated_oasign,
             metting_type_code           = p_metting_type_code,
             special_situation           = p_special_situation
       WHERE exp_report_header_id = p_exp_report_header_id;
    
      --modify wgf 2012/12/28
      /*UPDATE exp_report_pmt_schedules s
        SET s.last_updated_by  = p_last_updated_by,
            s.last_update_date = SYSDATE,
            s.description      = p_description
      WHERE s.exp_report_header_id = p_exp_report_header_id;*/
    END IF;
  
  END update_exp_report_headers;

  PROCEDURE delete_exp_report_headers(p_exp_report_header_id NUMBER,
                                      p_created_by           NUMBER) IS
    v_delete_check VARCHAR2(1);
    v_msg          VARCHAR2(2000);
  BEGIN
    v_delete_check := delete_data_check(p_exp_report_header_id);
    IF v_delete_check = 'Y' THEN
    
      --Mantis 0028573: 报销单提交工作流，审批拒绝后，整单删除报销单报错
      --把workflow_instance_delete提前调用即可
      --删除对应的工作流数据
      wfl_core_pkg.workflow_instance_delete(p_transaction_category => c_exp_report,
                                            p_instance_param       => p_exp_report_header_id);
    
      delete_exp_report_lines(p_exp_report_line_id   => '',
                              p_created_by           => p_created_by,
                              p_exp_report_header_id => p_exp_report_header_id);
      --删除费用报销单核算凭证信息 add by Ace 20131126
      DELETE FROM exp_report_accounts o
       WHERE o.exp_report_header_id = p_exp_report_header_id;
    
      DELETE FROM exp_report_objects o
       WHERE o.exp_report_header_id = p_exp_report_header_id;
      DELETE FROM exp_rep_dimension_layouts l
       WHERE l.exp_report_header_id = p_exp_report_header_id;
      DELETE FROM exp_report_objects_layouts ol
       WHERE ol.exp_report_header_id = p_exp_report_header_id;
      DELETE FROM exp_report_headers h
       WHERE h.exp_report_header_id = p_exp_report_header_id;
      DELETE FROM exp_report_pmt_schedules s
       WHERE s.exp_report_header_id = p_exp_report_header_id;
      DELETE FROM bgt_budget_reserves t
       WHERE t.business_type = c_exp_report
         AND t.document_id = p_exp_report_header_id;
      DELETE FROM exp_document_histories h
       WHERE h.document_type = c_exp_report
         AND h.document_id = p_exp_report_header_id;
    
      /*--删除报销单与申请单相关
      del_released_budget_reserves(p_document_id      => p_exp_report_header_id,
                                   p_document_line_id => '',
                                   p_document_dist_id => '',
                                   p_user_id          => p_created_by);
      
      -- added by majianjian at 2015/3/25 15:39:37
      -- purpose:
      del_tra_plan_reserves_release(p_exp_report_header_id => p_exp_report_header_id,
                                    p_exp_report_line_id   => '');
      -- end add.*/
    
      --删除事件
      exp_evt_pkg.delete_workflow_event(p_document_id   => p_exp_report_header_id,
                                        p_source_module => c_exp_report,
                                        p_event_type    => 'EXP_EXPENSE_POLICY',
                                        p_user_id       => p_created_by);
    
      --删除合同
      DELETE FROM con_document_flows f
       WHERE f.source_document_type = 'EXP_REPORT_LINES'
         AND f.source_document_id = p_exp_report_header_id
         AND f.document_type = 'CON_CONTRACT';
    
      DELETE FROM csh_doc_payment_company a
       WHERE a.document_type = c_exp_report
         AND a.document_id = p_exp_report_header_id;
    
      --删除资金计划行相关
      v_msg := delete_rep_pmt_schedule(p_exp_report_header_id, p_created_by);
    
      fnd_fileupload.delete_all_attachment(p_table_name => 'EXP_REPORT_HEADERS',
                                           p_pk_value   => p_exp_report_header_id);
    
      --OA签报逻辑
      UPDATE con_sign_oa cos
         SET cos.hec_doc_id = NULL
       WHERE cos.hec_doc_type = 'EXP_REPORT'
         AND cos.hec_doc_id = p_exp_report_header_id;
    
      DELETE FROM cux_oa_exp_ref coe
       WHERE coe.exp_report_header_id = p_exp_report_header_id;
    
    END IF;
  EXCEPTION
    WHEN e_lock_table THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_LOCK_RECORD_ERROR',
                                                      p_created_by              => p_created_by,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'delete_exp_report_headers');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_delete_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_DELETE_ERROR',
                                                      p_created_by              => p_created_by,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'delete_exp_report_headers');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END delete_exp_report_headers;

  --更新报销单行，影响分配行信息
  PROCEDURE reset_exp_report_dists(p_exp_report_line_id NUMBER,
                                   --p_city                     varchar2,
                                   p_description VARCHAR2,
                                   --p_date_from                date,
                                   --p_date_to                  date,
                                   p_expense_type_id          NUMBER,
                                   p_expense_item_id          NUMBER,
                                   p_price                    NUMBER,
                                   p_primary_quantity         NUMBER,
                                   p_primary_uom              VARCHAR2,
                                   p_secondary_quantity       NUMBER,
                                   p_secondary_uom            VARCHAR2,
                                   p_report_amount            NUMBER,
                                   p_report_functional_amount NUMBER,
                                   p_distribution_set_id      NUMBER,
                                   p_company_id               NUMBER,
                                   p_operation_unit_id        NUMBER,
                                   p_position_id              NUMBER,
                                   p_responsibility_center_id NUMBER,
                                   p_employee_id              NUMBER,
                                   p_payee_category           VARCHAR2,
                                   p_payee_id                 NUMBER,
                                   --p_partner_id               number,
                                   --p_payment_flag             varchar2,
                                   --p_report_status            varchar2,
                                   --p_audit_flag               varchar2,
                                   --p_audit_date               date,
                                   --p_write_off_status         varchar2,
                                   --p_write_off_comleted_date  date,
                                   --p_attachment_num          number,
                                   p_dimension1_id           NUMBER,
                                   p_dimension2_id           NUMBER,
                                   p_dimension3_id           NUMBER,
                                   p_dimension4_id           NUMBER,
                                   p_dimension5_id           NUMBER,
                                   p_dimension6_id           NUMBER,
                                   p_dimension7_id           NUMBER,
                                   p_dimension8_id           NUMBER,
                                   p_dimension9_id           NUMBER,
                                   p_dimension10_id          NUMBER,
                                   p_user_id                 NUMBER,
                                   p_exchange_rate           NUMBER,
                                   p_currency_code           VARCHAR2,
                                   p_period_name             VARCHAR2,
                                   p_exchange_rate_type      VARCHAR2,
                                   p_exchange_rate_quotation VARCHAR2,
                                   p_unit_id                 NUMBER,
                                   p_budget_item_id          NUMBER,
                                   
                                   p_sale_amount                 NUMBER DEFAULT NULL,
                                   p_tax_amount                  NUMBER DEFAULT NULL,
                                   p_tax_rate                    NUMBER DEFAULT NULL,
                                   p_input_tax_structure_detail  VARCHAR2,
                                   p_deduction_rules             NUMBER,
                                   p_adjusted_full_deductions    NUMBER,
                                   p_adjusted_partial_deductions NUMBER,
                                   p_adjustable_tax_deductible   NUMBER,
                                   p_invoice_amount              NUMBER,
                                   p_invoice_tax_amount          NUMBER,
                                   p_associated_oasign           VARCHAR2,
                                   p_usage_type                  VARCHAR2 DEFAULT NULL) IS
    v_exp_report_lines    exp_report_lines%ROWTYPE;
    v_exp_report_dists_id exp_report_dists.exp_report_dists_id%TYPE;
  BEGIN
    BEGIN
      SELECT *
        INTO v_exp_report_lines
        FROM exp_report_lines l
       WHERE l.exp_report_line_id = p_exp_report_line_id;
    EXCEPTION
      WHEN no_data_found THEN
        sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_EXPENSE_LINE_DELETED',
                                                        p_created_by              => p_user_id,
                                                        p_package_name            => 'exp_report_pkg',
                                                        p_procedure_function_name => 'reset_exp_report_dists');
        raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                sys_raise_app_error_pkg.g_err_line_id);
    END;
  
    BEGIN
      --只有一个分配行，则同步更新
      SELECT exp_report_dists_id
        INTO v_exp_report_dists_id
        FROM exp_report_dists d
       WHERE d.exp_report_line_id = p_exp_report_line_id;
    
      IF (nvl(p_description, '-1') <>
         nvl(v_exp_report_lines.description, '-1') OR
         nvl(p_price, -0.999) <> nvl(v_exp_report_lines.price, -0.999) OR
         nvl(p_primary_quantity, -0.999) <>
         nvl(v_exp_report_lines.primary_quantity, -0.999) OR
         nvl(p_primary_uom, '-0.999') <>
         nvl(v_exp_report_lines.primary_uom, '-0.999') OR
         nvl(p_secondary_quantity, -0.999) <>
         nvl(v_exp_report_lines.secondary_quantity, -0.999) OR
         nvl(p_secondary_uom, '-0.999') <>
         nvl(v_exp_report_lines.secondary_uom, '-0.999') OR
         nvl(p_report_amount, -0.999) <>
         nvl(v_exp_report_lines.report_amount, -0.999) OR
         nvl(p_report_functional_amount, -0.999) <>
         nvl(v_exp_report_lines.report_functional_amount, -0.999) OR
         nvl(p_distribution_set_id, -0.999) <>
         nvl(v_exp_report_lines.distribution_set_id, -0.999) OR
         nvl(p_company_id, -0.999) <>
         nvl(v_exp_report_lines.company_id, -0.999) OR
         nvl(p_operation_unit_id, -0.999) <>
         nvl(v_exp_report_lines.operation_unit_id, -0.999) OR
         nvl(p_position_id, -0.999) <>
         nvl(v_exp_report_lines.position_id, -0.999) OR
         nvl(p_responsibility_center_id, -0.999) <>
         nvl(v_exp_report_lines.responsibility_center_id, -0.999) OR
         nvl(p_employee_id, -0.999) <>
         nvl(v_exp_report_lines.employee_id, -0.999) OR
         --nvl(p_partner_id, -0.999) <> nvl(v_exp_report_lines.partner_id,-0.999) or
         --nvl(p_payment_flag,'-0.999') <> nvl(v_exp_report_lines.payment_flag,'-0.999') or
         --nvl(p_report_status,'-0.999') <> nvl(v_exp_report_lines.report_status, '-0.999') or
         --nvl(p_audit_flag,'-0.999') <> nvl(v_exp_report_lines.audit_flag, '-0.999') or
         --nvl(p_audit_date,  sysdate) <> nvl(v_exp_report_lines.audit_date,  sysdate) or
         --nvl(p_write_off_status,'-0.999') <> nvl(v_exp_report_lines.write_off_status,'-0.999') or
         --nvl(p_write_off_comleted_date, sysdate) <> nvl(v_exp_report_lines.write_off_comleted_date, sysdate) or
         --nvl(p_attachment_num, -0.999) <> nvl(v_exp_report_lines.attachment_num, -0.999) or
         nvl(p_dimension1_id, -0.999) <>
         nvl(v_exp_report_lines.dimension1_id, -0.999) OR
         nvl(p_dimension2_id, -0.999) <>
         nvl(v_exp_report_lines.dimension2_id, -0.999) OR
         nvl(p_dimension3_id, -0.999) <>
         nvl(v_exp_report_lines.dimension3_id, -0.999) OR
         nvl(p_dimension4_id, -0.999) <>
         nvl(v_exp_report_lines.dimension4_id, -0.999) OR
         nvl(p_dimension5_id, -0.999) <>
         nvl(v_exp_report_lines.dimension5_id, -0.999) OR
         nvl(p_dimension6_id, -0.999) <>
         nvl(v_exp_report_lines.dimension6_id, -0.999) OR
         nvl(p_dimension7_id, -0.999) <>
         nvl(v_exp_report_lines.dimension7_id, -0.999) OR
         nvl(p_dimension8_id, -0.999) <>
         nvl(v_exp_report_lines.dimension8_id, -0.999) OR
         nvl(p_dimension9_id, -0.999) <>
         nvl(v_exp_report_lines.dimension9_id, -0.999) OR
         nvl(p_dimension10_id, -0.999) <>
         nvl(v_exp_report_lines.dimension10_id, -0.999) OR
         p_exchange_rate <> v_exp_report_lines.exchange_rate OR
         p_currency_code <> v_exp_report_lines.currency_code OR
         nvl(p_period_name, '-1') <>
         nvl(v_exp_report_lines.period_name, '-1') OR
         --nvl(p_exchange_rate_type,'-1') <> nvl(v_exp_report_lines.exchange_rate_type, '-1') or
         nvl(p_exchange_rate_quotation, '-1') <>
         nvl(v_exp_report_lines.exchange_rate_quotation, '-1') OR
         nvl(p_unit_id, -0.999) <> nvl(v_exp_report_lines.unit_id, -0.999) OR
         nvl(p_expense_type_id, -0.999) <>
         nvl(v_exp_report_lines.expense_type_id, -0.999) OR
         nvl(p_budget_item_id, -0.999) <>
         nvl(v_exp_report_lines.budget_item_id, -0.999) OR
         --or nvl(p_expense_item_id,-0.999) <> nvl(v_exp_report_lines.expense_item_id,-0.999) or
         -- nvl(p_payee_category,'-0.999') <> nvl(v_exp_report_lines.payee_category,'-0.999') or
         --抵扣规则废弃字段，原用途类型定义为抵扣规则，此字段为新增后多余字段 
         nvl(p_deduction_rules, '-0.999') <>
         nvl(v_exp_report_lines.deduction_rules, '-0.999') OR
         --本币金额 
         nvl(p_report_functional_amount, '-0.999') <>
         nvl(v_exp_report_lines.report_functional_amount, '-0.999') OR
         --不含税金额 
         nvl(p_sale_amount, -0.999) <>
         nvl(v_exp_report_lines.sale_amount, -0.999) OR
         --税率 
         nvl(p_tax_rate, '-0.999') <>
         nvl(v_exp_report_lines.tax_rate, '-0.999') OR
         --关联OA单据
         nvl(p_associated_oasign, -0.999) <>
         nvl(v_exp_report_lines.associated_oasign, -0.999) OR
         --抵扣规则（用途类型） 
         nvl(p_usage_type, -0.999) <>
         nvl(v_exp_report_lines.usage_type, -0.999) OR
         --调整后全额抵扣税额  
         nvl(p_adjusted_full_deductions, -0.999) <>
         nvl(v_exp_report_lines.adjusted_full_deductions, -0.999) OR
         --调整后部分抵扣税额 
         nvl(p_adjusted_partial_deductions, -0.999) <>
         nvl(v_exp_report_lines.adjusted_partial_deductions, -0.999) OR
         --调整后不可抵扣税额 
         nvl(p_adjustable_tax_deductible, -0.999) <>
         nvl(v_exp_report_lines.adjustable_tax_deductible, -0.999) OR
         --发票金额
         nvl(p_invoice_amount, '-0.999') <>
         nvl(v_exp_report_lines.invoice_amount, '-0.999') OR
         --发票税额
         nvl(p_invoice_tax_amount, -0.999) <>
         nvl(v_exp_report_lines.invoice_tax_amount, -0.999) OR
         --税额         
         nvl(p_tax_amount, -0.999) <>
         nvl(v_exp_report_lines.tax_amount, -0.999) OR
         --进项分类
         nvl(p_input_tax_structure_detail, -0.999) <>
         nvl(v_exp_report_lines.input_tax_structure_detail, -0.999)) THEN
      
        update_exp_report_dists(p_exp_report_dists_id         => v_exp_report_dists_id,
                                p_description                 => p_description,
                                p_period_name                 => p_period_name,
                                p_price                       => p_price,
                                p_primary_quantity            => p_primary_quantity,
                                p_report_amount               => p_report_amount,
                                p_rep_functional_amount       => p_report_functional_amount,
                                p_company_id                  => p_company_id,
                                p_unit_id                     => p_unit_id,
                                p_responsibility_center_id    => p_responsibility_center_id,
                                p_employee_id                 => p_employee_id,
                                p_payee_category              => p_payee_category,
                                p_payee_id                    => p_payee_id,
                                p_dimension1_id               => p_dimension1_id,
                                p_dimension2_id               => p_dimension2_id,
                                p_dimension3_id               => p_dimension3_id,
                                p_dimension4_id               => p_dimension4_id,
                                p_dimension5_id               => p_dimension5_id,
                                p_dimension6_id               => p_dimension6_id,
                                p_dimension7_id               => p_dimension7_id,
                                p_dimension8_id               => p_dimension8_id,
                                p_dimension9_id               => p_dimension9_id,
                                p_dimension10_id              => p_dimension10_id,
                                p_user_id                     => p_user_id,
                                p_position_id                 => p_position_id,
                                p_budget_item_id              => p_budget_item_id,
                                p_expense_item_id             => p_expense_item_id,
                                p_expense_type_id             => p_expense_type_id,
                                p_sale_amount                 => p_sale_amount,
                                p_tax_amount                  => p_tax_amount,
                                p_tax_rate                    => p_tax_rate,
                                p_input_tax_structure_detail  => p_input_tax_structure_detail,
                                p_deduction_rules             => p_deduction_rules,
                                p_adjusted_full_deductions    => p_adjusted_full_deductions,
                                p_adjusted_partial_deductions => p_adjusted_partial_deductions,
                                p_adjustable_tax_deductible   => p_adjustable_tax_deductible,
                                p_invoice_amount              => p_invoice_amount,
                                p_invoice_tax_amount          => p_invoice_tax_amount,
                                p_associated_oasign           => p_associated_oasign,
                                p_usage_type                  => p_usage_type);
      
        /*delete from bgt_budget_reserves t
         where t.business_type = c_exp_report
           and t.document_id = get_document_id(p_exp_report_line_id)
           and t.document_line_id in
               (select d.exp_report_dists_id
                  from exp_report_dists d
                 where d.exp_report_line_id = p_exp_report_line_id);
        
        --删除旧分配行信息
        delete from exp_report_dists d
         where d.exp_report_line_id = p_exp_report_line_id;
        
        --新建分配行信息
        insert_exp_report_dists(p_exchange_rate            => p_exchange_rate,
                                p_created_by               => p_user_id,
                                p_report_func_amount       => p_report_functional_amount,
                                p_responsibility_center_id => p_responsibility_center_id,
                                p_report_amount            => p_report_amount,
                                p_exp_report_line_id       => p_exp_report_line_id,
                                p_currency_code            => p_currency_code,
                                p_dimension2_id            => p_dimension2_id,
                                p_dimension4_id            => p_dimension4_id,
                                p_dimension3_id            => p_dimension3_id,
                                --p_audit_flag               => 'N',
                                --p_report_status            => 'GENERATE',
                                p_audit_date             => '',
                                p_dimension1_id          => p_dimension1_id,
                                p_attachment_num         => p_attachment_num,
                                p_exceed_budget_strategy => '',
                                p_dimension10_id         => p_dimension10_id,
                                p_close_date             => '',
                                p_close_flag             => 'N',
                                p_dimension9_id          => p_dimension9_id,
                                p_dimension6_id          => p_dimension6_id,
                                p_dimension5_id          => p_dimension5_id,
                                p_dimension8_id          => p_dimension8_id,
                                p_dimension7_id          => p_dimension7_id,
                                --p_budget_item_id           => '',
                                p_expense_item_id         => p_expense_item_id,
                                p_price                   => p_price,
                                p_primary_uom             => p_primary_uom,
                                p_primary_quantity        => p_primary_quantity,
                                p_period_name             => p_period_name,
                                p_description             => p_description,
                                p_exchange_rate_type      => p_exchange_rate_type,
                                p_expense_type_id         => p_expense_type_id,
                                p_exchange_rate_quotation => p_exchange_rate_quotation,
                                p_secondary_quantity      => p_secondary_quantity,
                                p_payee_category          => p_payee_category,
                                p_employee_id             => p_employee_id,
                                p_payee_id                => p_payee_id,
                                --p_payment_flag             => p_payment_flag,
                                p_partner_id          => p_partner_id,
                                p_company_id          => p_company_id,
                                p_secondary_uom       => p_secondary_uom,
                                p_unit_id             => p_unit_id,
                                p_exp_report_dists_id => v_exp_report_dists_id,
                                p_position_id         => p_position_id);*/
      ELSIF (nvl(p_expense_type_id, -0.999) <>
            nvl(v_exp_report_lines.expense_type_id, -0.999) OR
            nvl(p_expense_item_id, -0.999) <>
            nvl(v_exp_report_lines.expense_item_id, -0.999) OR
            nvl(p_payee_category, '-0.999') <>
            nvl(v_exp_report_lines.payee_category, '-0.999') OR
            nvl(p_payee_id, -0.999) <>
            nvl(v_exp_report_lines.payee_id, -0.999)) THEN
        FOR v_dists IN (SELECT *
                          FROM exp_report_dists d
                         WHERE d.exp_report_line_id = p_exp_report_line_id) LOOP
        
          update_exp_report_dists(p_exp_report_dists_id         => v_dists.exp_report_dists_id,
                                  p_description                 => v_dists.description,
                                  p_period_name                 => v_dists.period_name,
                                  p_price                       => v_dists.price,
                                  p_primary_quantity            => v_dists.primary_quantity,
                                  p_report_amount               => v_dists.report_amount,
                                  p_rep_functional_amount       => v_dists.report_functional_amount,
                                  p_company_id                  => v_dists.company_id,
                                  p_unit_id                     => v_dists.unit_id,
                                  p_responsibility_center_id    => v_dists.responsibility_center_id,
                                  p_employee_id                 => v_dists.employee_id,
                                  p_payee_category              => p_payee_category,
                                  p_payee_id                    => p_payee_id,
                                  p_dimension1_id               => v_dists.dimension1_id,
                                  p_dimension2_id               => v_dists.dimension2_id,
                                  p_dimension3_id               => v_dists.dimension3_id,
                                  p_dimension4_id               => v_dists.dimension4_id,
                                  p_dimension5_id               => v_dists.dimension5_id,
                                  p_dimension6_id               => v_dists.dimension6_id,
                                  p_dimension7_id               => v_dists.dimension7_id,
                                  p_dimension8_id               => v_dists.dimension8_id,
                                  p_dimension9_id               => v_dists.dimension9_id,
                                  p_dimension10_id              => v_dists.dimension10_id,
                                  p_user_id                     => p_user_id,
                                  p_position_id                 => v_dists.position_id,
                                  p_budget_item_id              => v_dists.budget_item_id,
                                  p_expense_item_id             => p_expense_item_id,
                                  p_expense_type_id             => p_expense_type_id,
                                  p_sale_amount                 => v_dists.sale_amount,
                                  p_tax_amount                  => v_dists.tax_amount,
                                  p_tax_rate                    => v_dists.tax_rate,
                                  p_input_tax_structure_detail  => v_dists.input_tax_structure_detail,
                                  p_deduction_rules             => v_dists.deduction_rules,
                                  p_adjusted_full_deductions    => v_dists.adjusted_full_deductions,
                                  p_adjusted_partial_deductions => v_dists.adjusted_partial_deductions,
                                  p_adjustable_tax_deductible   => v_dists.adjustable_tax_deductible,
                                  p_invoice_amount              => p_invoice_amount,
                                  p_invoice_tax_amount          => p_invoice_tax_amount,
                                  p_associated_oasign           => p_associated_oasign);
        END LOOP;
      END IF;
    
    EXCEPTION
      WHEN too_many_rows THEN
        IF (nvl(p_expense_type_id, -0.999) <>
           nvl(v_exp_report_lines.expense_type_id, -0.999) OR
           nvl(p_expense_item_id, -0.999) <>
           nvl(v_exp_report_lines.expense_item_id, -0.999) OR
           nvl(p_payee_category, '-0.999') <>
           nvl(v_exp_report_lines.payee_category, '-0.999') OR
           nvl(p_payee_id, -0.999) <>
           nvl(v_exp_report_lines.payee_id, -0.999)) THEN
          FOR v_dists IN (SELECT *
                            FROM exp_report_dists d
                           WHERE d.exp_report_line_id = p_exp_report_line_id) LOOP
          
            update_exp_report_dists(p_exp_report_dists_id         => v_dists.exp_report_dists_id,
                                    p_description                 => v_dists.description,
                                    p_period_name                 => v_dists.period_name,
                                    p_price                       => v_dists.price,
                                    p_primary_quantity            => v_dists.primary_quantity,
                                    p_report_amount               => v_dists.report_amount,
                                    p_rep_functional_amount       => v_dists.report_functional_amount,
                                    p_company_id                  => v_dists.company_id,
                                    p_unit_id                     => v_dists.unit_id,
                                    p_responsibility_center_id    => v_dists.responsibility_center_id,
                                    p_employee_id                 => v_dists.employee_id,
                                    p_payee_category              => p_payee_category,
                                    p_payee_id                    => p_payee_id,
                                    p_dimension1_id               => v_dists.dimension1_id,
                                    p_dimension2_id               => v_dists.dimension2_id,
                                    p_dimension3_id               => v_dists.dimension3_id,
                                    p_dimension4_id               => v_dists.dimension4_id,
                                    p_dimension5_id               => v_dists.dimension5_id,
                                    p_dimension6_id               => v_dists.dimension6_id,
                                    p_dimension7_id               => v_dists.dimension7_id,
                                    p_dimension8_id               => v_dists.dimension8_id,
                                    p_dimension9_id               => v_dists.dimension9_id,
                                    p_dimension10_id              => v_dists.dimension10_id,
                                    p_user_id                     => p_user_id,
                                    p_position_id                 => v_dists.position_id,
                                    p_budget_item_id              => v_dists.budget_item_id,
                                    p_expense_item_id             => p_expense_item_id,
                                    p_expense_type_id             => p_expense_type_id,
                                    p_sale_amount                 => v_dists.sale_amount,
                                    p_tax_amount                  => v_dists.tax_amount,
                                    p_tax_rate                    => v_dists.tax_rate,
                                    p_input_tax_structure_detail  => v_dists.input_tax_structure_detail,
                                    p_deduction_rules             => v_dists.deduction_rules,
                                    p_adjusted_full_deductions    => v_dists.adjusted_full_deductions,
                                    p_adjusted_partial_deductions => v_dists.adjusted_partial_deductions,
                                    p_adjustable_tax_deductible   => v_dists.adjustable_tax_deductible,
                                    p_invoice_amount              => p_invoice_amount,
                                    p_invoice_tax_amount          => p_invoice_tax_amount,
                                    p_associated_oasign           => p_associated_oasign);
          END LOOP;
        END IF;
      WHEN no_data_found THEN
        NULL;
    END;
  END reset_exp_report_dists;

  /*  --0025672: 报销单类型定义显示字段自审核和可支付标志，并对报销单保存逻辑做相应修改
  --当报销单类型的payment_flag='N'时，报销单保存时，EXP_REPORT_LINES.PAYMENT_FLAG='N',且不产生计划付款行；
  --当此标志为null或Y时，EXP_REPORT_LINES.PAYMENT_FLAG='Y',且产生计划付款行.
  function get_payment_flag(p_exp_report_header_id number) return varchar2 is
    v_payment_flag exp_expense_report_types.payment_flag%type;
  begin
    select nvl(payment_flag,
               'Y')
      into v_payment_flag
      from exp_expense_report_types t
     where t.expense_report_type_id =
           (select expense_report_type_id
              from exp_report_headers h
             where h.exp_report_header_id = p_exp_report_header_id);
    return v_payment_flag;
  end get_payment_flag;*/

  -- 审核复核 v_audit_date := get_journal_date(p_exp_report_header_id);
  --20130225 插入时，根据付款用途代码查询出默认现金流量项
  PROCEDURE insert_rep_pmt_schedules(p_payment_schedule_line_id OUT NUMBER,
                                     p_exp_report_header_id     NUMBER,
                                     p_description              VARCHAR2,
                                     p_currency                 VARCHAR2,
                                     p_payee_category           VARCHAR2,
                                     p_payee_id                 NUMBER,
                                     p_account_number           VARCHAR2,
                                     p_account_name             VARCHAR2,
                                     p_payment_type_id          NUMBER,
                                     p_schedule_start_date      DATE,
                                     p_schedule_due_date        DATE,
                                     p_due_amount               NUMBER,
                                     p_bank_code                VARCHAR2,
                                     p_bank_name                VARCHAR2,
                                     p_bank_location_code       VARCHAR2,
                                     p_bank_location            VARCHAR2,
                                     p_province_code            VARCHAR2,
                                     p_province_name            VARCHAR2,
                                     p_city_code                VARCHAR2,
                                     p_city_name                VARCHAR2,
                                     p_usedes                   VARCHAR2, --付款用途代码
                                     p_document_id              NUMBER,
                                     p_document_line_id         NUMBER,
                                     p_user_id                  NUMBER,
                                     p_company_id               NUMBER,
                                     --modify 增加是否冻结字段
                                     p_frozen_flag VARCHAR2,
                                     --modify by Qu yuanyuan 增加托收账户字段
                                     p_collection_account_id NUMBER,
                                     p_gather_flag           VARCHAR2 DEFAULT 1) IS
    v_schedule_line_number NUMBER;
    v_cash_flow_code       VARCHAR2(30);
    v_cash_flow_item_id    NUMBER;
  
    v_pur_system_venders pur_system_venders%ROWTYPE;
    v_pur_wlzq_venders   pur_wlzq_venders%ROWTYPE;
    v_count              NUMBER;
    --报销头关联的合同
    v_contract_header_id NUMBER;
    e_different_con exception;
  BEGIN
    p_payment_schedule_line_id := get_payment_schedule_line_id;
    v_schedule_line_number     := get_schedule_line_number(p_exp_report_header_id);
    BEGIN
      IF p_usedes IS NOT NULL THEN
      
        SELECT cdf.cash_flow_item_id
          INTO v_cash_flow_item_id
          FROM csh_default_flowitems cdf
         WHERE cdf.default_code = p_usedes
           AND cdf.default_flag = 'Y'
           AND cdf.default_type = 'PAYMENT_USEDES';
      
      ELSE
        v_cash_flow_item_id := '';
      END IF;
    EXCEPTION
      WHEN no_data_found THEN
        v_cash_flow_item_id := '';
    END;
  
    --added by lyh  2017.5.25
    --合同维护的供应商，在提交后，如果公司级供应商中没有，则分配,并插入维护表
  
    /*IF (p_payee_category = 'VENDER') THEN
      insert_exp_report_vender(p_payee_id   => p_payee_id,
                               p_company_id => p_company_id,
                               p_user_id    => p_user_id);
    END IF;*/
  
    --报销头关联合同
    BEGIN
      SELECT ei.contract_header_id
        INTO v_contract_header_id
        FROM exp_report_headers ei
       WHERE ei.exp_report_header_id = p_exp_report_header_id;
    EXCEPTION
      WHEN no_data_found THEN
        NULL;
    END;
  
    INSERT INTO exp_report_pmt_schedules
      (exp_report_header_id,
       payment_schedule_line_id,
       description,
       currency,
       payee_category,
       payee_id,
       account_number,
       account_name,
       payment_type_id,
       schedule_start_date,
       schedule_due_date,
       due_amount,
       bank_code,
       bank_name,
       bank_location_code,
       bank_location_name,
       province_code,
       province_name,
       city_code,
       city_name,
       usedes,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date,
       company_id,
       schedule_line_number,
       --modify 插入是否冻结值
       frozen_flag,
       cash_flow_code, --Modify by 添加现金流量项
       collection_account_id,
       gather_flag)
    VALUES
      (p_exp_report_header_id,
       p_payment_schedule_line_id,
       p_description,
       p_currency,
       p_payee_category,
       p_payee_id,
       p_account_number,
       p_account_name,
       p_payment_type_id,
       p_schedule_start_date,
       p_schedule_due_date,
       p_due_amount,
       p_bank_code,
       p_bank_name,
       p_bank_location_code,
       p_bank_location,
       p_province_code,
       p_province_name,
       p_city_code,
       p_city_name,
       p_usedes,
       p_user_id,
       SYSDATE,
       p_user_id,
       SYSDATE,
       p_company_id,
       v_schedule_line_number,
       --modify 是否冻结
       p_frozen_flag,
       v_cash_flow_item_id,
       --modify by Qu yuanyuan 增加托收账户字段
       p_collection_account_id,
       p_gather_flag);
  
    IF (v_contract_header_id IS NOT NULL OR p_document_id IS NOT NULL) THEN
    
      con_contract_maintenance_pkg.insert_con_document_flows(p_document_type           => 'CON_CONTRACT',
                                                             p_document_id             => nvl(v_contract_header_id,
                                                                                              p_document_id),
                                                             p_document_line_id        => p_document_line_id,
                                                             p_source_document_type    => 'EXP_REPORT_PMT_SCHEDULES',
                                                             p_source_document_id      => p_exp_report_header_id,
                                                             p_source_document_line_id => p_payment_schedule_line_id,
                                                             p_user_id                 => p_user_id);
      --更新头合同
      update exp_report_headers h
         set h.contract_header_id = nvl(v_contract_header_id, p_document_id),
             h.last_updated_by    = p_user_id,
             h.last_update_date   = sysdate
       where h.exp_report_header_id = p_exp_report_header_id;
    END IF;
  
    --重置现金事务核销状态
    csh_write_off_pkg.set_exp_rep_write_off_status(p_exp_report_header_id => p_exp_report_header_id,
                                                   p_user_id              => p_user_id);
  
    create_csh_doc_payment_company(p_exp_report_header_id => p_exp_report_header_id,
                                   p_user_id              => p_user_id);
  exception
    when e_different_con then
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => '同一报销单下，合同唯一！',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'insert_rep_pmt_schedules');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END insert_rep_pmt_schedules;
  --add by Qu yuanyuan
  --根据单据类型，费用项目在二开表取付款用途
  FUNCTION get_schedule_usedes_code(p_exp_report_header_id NUMBER,
                                    p_expense_item_id      NUMBER)
    RETURN VARCHAR2 IS
    c_cur_usedes_code exp_report_pmt_schedules.usedes%TYPE;
  BEGIN
    /*SELECT u.usedes_code
        INTO c_cur_usedes_code
        FROM exp_com_rep_pay_items_ref f,
             csh_payment_usedes        u,
             exp_report_headers        h
       WHERE f.usedes_id = u.usedes_id
         AND h.exp_report_header_id = p_exp_report_header_id
         AND NOT EXISTS
       (SELECT p.payment_schedule_line_id
                FROM exp_report_pmt_schedules p
               WHERE p.exp_report_header_id = p_exp_report_header_id)
         AND f.expense_item_id = p_expense_item_id
         AND h.exp_report_type_id = f.expense_report_type_id;
      RETURN c_cur_usedes_code;
    EXCEPTION
      WHEN no_data_found THEN
        BEGIN
          SELECT nvl(u.usedes_code, NULL)
            INTO c_cur_usedes_code
            FROM csh_payment_usedes         u,
                 exp_rep_ref_payment_usedes e,
                 exp_report_headers         h
           WHERE u.usedes_id = e.usedes_id
             AND e.expense_report_type_id = h.exp_report_type_id
             AND h.exp_report_header_id = p_exp_report_header_id
             AND e.primary_flag = 'Y'
             AND NOT EXISTS
           (SELECT p.payment_schedule_line_id
                    FROM exp_report_pmt_schedules p
                   WHERE p.exp_report_header_id = p_exp_report_header_id);
          RETURN c_cur_usedes_code;*/
    BEGIN
      SELECT nvl(v.usedes_code, NULL)
        INTO c_cur_usedes_code
        FROM csh_payment_usedes_vl v, exp_rep_ref_payment_usedes u
       WHERE v.usedes_id = u.usedes_id
         AND v.enabled_flag = 'Y'
         AND u.primary_flag = 'Y'
         AND u.expense_report_type_id =
             (SELECT hh.exp_report_type_id
                FROM exp_report_headers hh
               WHERE hh.exp_report_header_id = p_exp_report_header_id);
      RETURN c_cur_usedes_code;
    EXCEPTION
      WHEN OTHERS THEN
        c_cur_usedes_code := NULL;
        NULL;
        RETURN c_cur_usedes_code;
    END;
    --end by Qu yuanyuan
  END get_schedule_usedes_code;
  --end by Qu yuanyuan
  --是否重建计划付款行
  PROCEDURE create_exp_rep_pmt_schedule(p_exp_report_header_id NUMBER,
                                        p_created_by           NUMBER) IS
    v_exp_report_head          exp_report_headers%ROWTYPE;
    v_line_amount              NUMBER;
    v_usedes_code              VARCHAR2(20);
    v_bank_code                VARCHAR2(20);
    v_bank_name                VARCHAR2(200);
    v_bank_location_code       VARCHAR2(20);
    v_bank_location_name       VARCHAR2(200);
    v_province_code            VARCHAR2(20);
    v_province_name            VARCHAR2(200);
    v_city_code                VARCHAR2(20);
    v_city_name                VARCHAR2(200);
    v_account_number           VARCHAR2(50);
    v_account_name             VARCHAR2(200);
    v_payment_schedule_line_id NUMBER;
  
    v_count            NUMBER;
    v_contract_id      NUMBER;
    v_document_line_id NUMBER;
    v_line_count       NUMBER;
    v_adjustment_flag  VARCHAR2(3);
  
    c_cur_usedes_code       VARCHAR2(30);
    c_cur_currency_code     VARCHAR2(30);
    c_cur_payee_category    VARCHAR2(30);
    c_cur_payee_id          NUMBER;
    c_cur_payment_method_id NUMBER;
    c_cur_report_date       DATE;
    c_cur_company_id        NUMBER;
  
    CURSOR cur_rec IS
      SELECT cdf.document_id,
             cdf.document_line_id,
             SUM(erl.report_amount) rep_amount,
             get_schedule_usedes_code(p_exp_report_header_id,
                                      erl.expense_item_id) c_cur_usedes_code
        FROM con_document_flows cdf, exp_report_lines erl
       WHERE erl.exp_report_header_id = p_exp_report_header_id
         AND erl.exp_report_header_id = cdf.source_document_id(+)
         AND erl.exp_report_line_id = cdf.source_document_line_id(+)
         AND cdf.document_type(+) = 'CON_CONTRACT'
         AND cdf.source_document_type(+) = 'EXP_REPORT_LINES'
       GROUP BY cdf.document_id,
                cdf.document_line_id,
                get_schedule_usedes_code(p_exp_report_header_id,
                                         erl.expense_item_id);
  
  BEGIN
  
    --add wgf 2012/12/25
    SELECT COUNT(1)
      INTO v_count
      FROM exp_report_pmt_schedules erps
     WHERE erps.exp_report_header_id = p_exp_report_header_id;
  
    --add wgf 2013/1/24 是否调整单，是则不创建
    BEGIN
      SELECT eert.adjustment_flag
        INTO v_adjustment_flag
        FROM exp_report_headers erh, exp_expense_report_types eert
       WHERE erh.exp_report_header_id = p_exp_report_header_id
         AND erh.exp_report_type_id = eert.expense_report_type_id;
    EXCEPTION
      WHEN OTHERS THEN
        v_adjustment_flag := 'N';
    END;
  
    --按合同、合同资金计划分组
    SELECT COUNT(1)
      INTO v_line_count
      FROM (SELECT cdf.document_id, cdf.document_line_id
              FROM exp_report_lines erl, con_document_flows cdf
             WHERE erl.exp_report_header_id = p_exp_report_header_id
               AND erl.exp_report_header_id = cdf.source_document_id(+)
               AND erl.exp_report_line_id = cdf.source_document_line_id(+)
               AND cdf.document_type(+) = 'CON_CONTRACT'
               AND cdf.source_document_type(+) = 'EXP_REPORT_LINES'
             GROUP BY cdf.document_id, cdf.document_line_id);
  
    /*  FOR c_cur IN (SELECT u.usedes_code, h.*
     FROM csh_payment_usedes         u,
          exp_rep_ref_payment_usedes e,
          exp_report_headers         h
    WHERE u.usedes_id = e.usedes_id
      AND e.expense_report_type_id = h.exp_report_type_id
      AND h.exp_report_header_id = p_exp_report_header_id
      AND e.primary_flag = 'Y'
      AND NOT EXISTS
    (SELECT p.payment_schedule_line_id
             FROM exp_report_pmt_schedules p
            WHERE p.exp_report_header_id =
                  p_exp_report_header_id)) LOOP*/
    --add by sqh
    SELECT h.currency_code,
           h.payee_category,
           h.payee_id,
           h.payment_method_id,
           h.report_date,
           h.company_id
      INTO c_cur_currency_code,
           c_cur_payee_category,
           c_cur_payee_id,
           c_cur_payment_method_id,
           c_cur_report_date,
           c_cur_company_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id
       AND NOT EXISTS
     (SELECT p.payment_schedule_line_id
              FROM exp_report_pmt_schedules p
             WHERE p.exp_report_header_id = p_exp_report_header_id);
  
    --20130312 add 异常
    BEGIN
      --  IF c_cur.payee_category = 'VENDER' THEN
      IF c_cur_payee_category = 'VENDER' THEN
        SELECT v.bank_code,
               v.bank_name,
               v.bank_location_code,
               v.bank_location,
               v.province_code,
               v.province_name,
               v.city_code,
               v.city_name,
               v.account_number,
               v.account_name
          INTO v_bank_code,
               v_bank_name,
               v_bank_location_code,
               v_bank_location_name,
               v_province_code,
               v_province_name,
               v_city_code,
               v_city_name,
               v_account_number,
               v_account_name
          FROM pur_vender_accounts v
         WHERE v.vender_id = c_cur_payee_id
              -- c_cur.payee_id
           AND v.primary_flag = 'Y'
           AND v.enabled_flag = 'Y';
        -- ELSIF c_cur.payee_category = 'EMPLOYEE' THEN
      ELSIF c_cur_payee_category = 'EMPLOYEE' THEN
        SELECT v.bank_code,
               v.bank_name,
               v.bank_location_code,
               v.bank_location,
               v.province_code,
               v.province_name,
               v.city_code,
               v.city_name,
               v.account_number,
               v.account_name
          INTO v_bank_code,
               v_bank_name,
               v_bank_location_code,
               v_bank_location_name,
               v_province_code,
               v_province_name,
               v_city_code,
               v_city_name,
               v_account_number,
               v_account_name
          FROM exp_employee_accounts v
         WHERE v.employee_id = c_cur_payee_id --c_cur.payee_id
           AND v.primary_flag = 'Y'
           AND v.enabled_flag = 'Y';
      ELSE
        SELECT v.bank_code,
               v.bank_name,
               v.bank_location_code,
               v.bank_location,
               v.province_code,
               v.province_name,
               v.city_code,
               v.city_name,
               v.account_number,
               v.account_name
          INTO v_bank_code,
               v_bank_name,
               v_bank_location_code,
               v_bank_location_name,
               v_province_code,
               v_province_name,
               v_city_code,
               v_city_name,
               v_account_number,
               v_account_name
          FROM ord_customer_accounts v
         WHERE v.customer_id = c_cur_payee_id -- c_cur.payee_id
           AND v.primary_flag = 'Y'
           AND v.enabled_flag = 'Y';
      END IF;
    EXCEPTION
      WHEN OTHERS THEN
        NULL;
    END;
  
    /* SELECT SUM(e.report_amount)
     INTO v_line_amount
     FROM exp_report_lines e
    WHERE e.exp_report_header_id = p_exp_report_header_id;*/
    IF v_count = 0 AND v_adjustment_flag = 'N' THEN
      --add wgf 2012/12/24 报销单行若有合同则计划付款行带出
      FOR l_rec IN cur_rec LOOP
      
        insert_rep_pmt_schedules(v_payment_schedule_line_id,
                                 p_exp_report_header_id,
                                 NULL,
                                 c_cur_currency_code,
                                 c_cur_payee_category,
                                 c_cur_payee_id,
                                 --modify by liubo 20180417 客户要求，默认带出付款对象、账号等Start
                                 v_account_number,
                                 v_account_name,
                                 --modify by liubo 20180417 客户要求，默认带出付款对象、账号等End
                                 c_cur_payment_method_id,
                                 c_cur_report_date,
                                 c_cur_report_date,
                                 l_rec.rep_amount, --add 2012/12/25
                                 v_bank_code,
                                 v_bank_name,
                                 v_bank_location_code,
                                 v_bank_location_name,
                                 v_province_code,
                                 v_province_name,
                                 v_city_code,
                                 v_city_name,
                                 l_rec.c_cur_usedes_code,
                                 --add 2012/12/25
                                 l_rec.document_id,
                                 l_rec.document_line_id,
                                 p_created_by,
                                 c_cur_company_id,
                                 --frozen_flag默认为不冻结
                                 'N',
                                 NULL,
                                 1);
      END LOOP;
    END IF;
    -- END LOOP;
  
    --add wgf 2012/12/26
    --当报销单行按合同、合同资金计划分组后如为一行，且属于该报销单计划付款行也只有一行时更新金额
    IF v_count = 1 AND v_line_count = 1 AND v_adjustment_flag = 'N' THEN
      UPDATE exp_report_pmt_schedules erps
         SET erps.due_amount      =
             (SELECT SUM(nvl(erl.report_amount, 0))
                FROM exp_report_lines erl
               WHERE erl.exp_report_header_id = p_exp_report_header_id),
             erps.last_updated_by  = p_created_by,
             erps.last_update_date = SYSDATE
       WHERE erps.exp_report_header_id = p_exp_report_header_id;
    END IF;
  
    --若付款计划有一条，且按合同、合同资金计划分组后得到的行数>=2时
    IF v_count = 1 AND v_line_count >= 2 AND v_adjustment_flag = 'N' THEN
      BEGIN
        SELECT cdf.document_id, cdf.document_line_id
          INTO v_contract_id, v_document_line_id
          FROM con_document_flows cdf, exp_report_pmt_schedules ers
         WHERE ers.exp_report_header_id = p_exp_report_header_id
           AND ers.exp_report_header_id = cdf.source_document_id(+)
           AND ers.payment_schedule_line_id =
               cdf.source_document_line_id(+)
           AND cdf.document_type(+) = 'CON_CONTRACT'
           AND cdf.source_document_type(+) = 'EXP_REPORT_PMT_SCHEDULES'
         GROUP BY cdf.document_id, cdf.document_line_id;
      EXCEPTION
        WHEN OTHERS THEN
          v_contract_id      := NULL;
          v_document_line_id := NULL;
      END;
      --add by sqh
      /*begin
        select nvl(u.usedes_code, null)
          into c_cur_usedes_code
          from csh_payment_usedes         u,
               exp_rep_ref_payment_usedes e,
               exp_report_headers         h
         where u.usedes_id = e.usedes_id
           and e.expense_report_type_id = h.exp_report_type_id
           and h.exp_report_header_id = p_exp_report_header_id
           and e.primary_flag = 'Y'
           and not exists
         (select p.payment_schedule_line_id
                  from exp_report_pmt_schedules p
                 where p.exp_report_header_id = p_exp_report_header_id);
      exception
        when others then
          c_cur_usedes_code := null;
          null;
      end;*/
      SELECT h.currency_code,
             h.payee_category,
             h.payee_id,
             h.payment_method_id,
             h.report_date,
             h.company_id
        INTO c_cur_currency_code,
             c_cur_payee_category,
             c_cur_payee_id,
             c_cur_payment_method_id,
             c_cur_report_date,
             c_cur_company_id
        FROM exp_report_headers h
       WHERE h.exp_report_header_id = p_exp_report_header_id
         AND NOT EXISTS
       (SELECT p.payment_schedule_line_id
                FROM exp_report_pmt_schedules p
               WHERE p.exp_report_header_id = p_exp_report_header_id);
    
      IF c_cur_payee_category = 'VENDER' THEN
        SELECT v.bank_code,
               v.bank_name,
               v.bank_location_code,
               v.bank_location,
               v.province_code,
               v.province_name,
               v.city_code,
               v.city_name,
               v.account_number,
               v.account_name
          INTO v_bank_code,
               v_bank_name,
               v_bank_location_code,
               v_bank_location_name,
               v_province_code,
               v_province_name,
               v_city_code,
               v_city_name,
               v_account_number,
               v_account_name
          FROM pur_vender_accounts v
         WHERE v.vender_id = c_cur_payee_id
           AND v.primary_flag = 'Y'
           AND v.enabled_flag = 'Y';
      ELSIF c_cur_payee_category = 'EMPLOYEE' THEN
        SELECT v.bank_code,
               v.bank_name,
               v.bank_location_code,
               v.bank_location,
               v.province_code,
               v.province_name,
               v.city_code,
               v.city_name,
               v.account_number,
               v.account_name
          INTO v_bank_code,
               v_bank_name,
               v_bank_location_code,
               v_bank_location_name,
               v_province_code,
               v_province_name,
               v_city_code,
               v_city_name,
               v_account_number,
               v_account_name
          FROM exp_employee_accounts v
         WHERE v.employee_id = c_cur_payee_id
           AND v.primary_flag = 'Y'
           AND v.enabled_flag = 'Y';
      ELSE
        SELECT v.bank_code,
               v.bank_name,
               v.bank_location_code,
               v.bank_location,
               v.province_code,
               v.province_name,
               v.city_code,
               v.city_name,
               v.account_number,
               v.account_name
          INTO v_bank_code,
               v_bank_name,
               v_bank_location_code,
               v_bank_location_name,
               v_province_code,
               v_province_name,
               v_city_code,
               v_city_name,
               v_account_number,
               v_account_name
          FROM ord_customer_accounts v
         WHERE v.customer_id = c_cur_payee_id
           AND v.primary_flag = 'Y'
           AND v.enabled_flag = 'Y';
      END IF;
      FOR l_rec IN cur_rec LOOP
      
        IF nvl(l_rec.document_id, 0) <> nvl(v_contract_id, 0) OR
           nvl(l_rec.document_line_id, 0) <> nvl(v_document_line_id, 0) THEN
        
          insert_rep_pmt_schedules(v_payment_schedule_line_id,
                                   p_exp_report_header_id,
                                   NULL,
                                   c_cur_currency_code,
                                   c_cur_payee_category,
                                   c_cur_payee_id,
                                   v_account_number,
                                   v_account_name,
                                   c_cur_payment_method_id,
                                   c_cur_report_date,
                                   c_cur_report_date,
                                   l_rec.rep_amount, --add 2012/12/25
                                   v_bank_code,
                                   v_bank_name,
                                   v_bank_location_code,
                                   v_bank_location_name,
                                   v_province_code,
                                   v_province_name,
                                   v_city_code,
                                   v_city_name,
                                   l_rec.c_cur_usedes_code,
                                   --add 2012/12/25
                                   l_rec.document_id,
                                   l_rec.document_line_id,
                                   p_created_by,
                                   c_cur_company_id,
                                   --frozen_flag默认为不冻结
                                   'N',
                                   NULL);
        END IF;
      END LOOP;
      --  END LOOP;
    END IF;
    --and
  
    --重置核销状态
    reset_exp_rpt_write_off_flag(p_exp_report_header_id => p_exp_report_header_id,
                                 p_created_by           => p_created_by);
  EXCEPTION
    WHEN OTHERS THEN
      RETURN;
  END;
  --add by wxq 报销单保存时，与导入的发票进行匹配,匹配成功返回1，否则返回0

  FUNCTION match_invoice(p_invoice_code       VARCHAR2,
                         p_invoice_number     VARCHAR2,
                         p_exp_report_line_id NUMBER) RETURN NUMBER AS
    v_match_invoice_flag NUMBER;
    v_invoice_true_flag  VARCHAR2(10);
    v_invoice_code       VARCHAR2(30);
    v_invoice_amount     NUMBER;
    v_report_lines       exp_report_lines%ROWTYPE;
  BEGIN
  
    SELECT l.*
      INTO v_report_lines
      FROM exp_report_lines l
     WHERE l.exp_report_line_id = p_exp_report_line_id;
  
    --分公司专票若只是和专票库进行匹配，同时需要校验发票金额
    SELECT f.invoice_true_flag
      INTO v_invoice_true_flag
      FROM exp_report_headers h, fnd_companies f
     WHERE h.exp_report_header_id = v_report_lines.exp_report_header_id
       AND h.company_id = f.company_id;
  
    IF v_invoice_true_flag = 'N' THEN
      v_invoice_amount := v_report_lines.invoice_sum_amount;
    END IF;
  
    SELECT eii.invoice_code
      INTO v_invoice_code
      FROM exp_invoice_info eii
     WHERE eii.invoice_code = p_invoice_code
       AND eii.invoice_number = p_invoice_number
       AND eii.amount = nvl(v_invoice_amount, eii.amount);
    v_match_invoice_flag := 1;
    RETURN v_match_invoice_flag;
  EXCEPTION
    WHEN no_data_found THEN
      v_match_invoice_flag := 0;
      RETURN v_match_invoice_flag;
  END match_invoice;

  -->> 1.0 Modify Tagin/2015.06.17 增加交通工具
  PROCEDURE insert_exp_report_lines(p_exp_report_header_id        NUMBER,
                                    p_line_number                 NUMBER,
                                    p_city                        VARCHAR2,
                                    p_description                 VARCHAR2,
                                    p_date_from                   DATE,
                                    p_date_to                     DATE,
                                    p_period_name                 VARCHAR2,
                                    p_currency_code               VARCHAR2,
                                    p_exchange_rate_type          VARCHAR2,
                                    p_exchange_rate_quotation     VARCHAR2,
                                    p_exchange_rate               NUMBER,
                                    p_expense_type_id             NUMBER,
                                    p_expense_item_id             NUMBER,
                                    p_budget_item_id              NUMBER,
                                    p_price                       NUMBER,
                                    p_primary_quantity            NUMBER,
                                    p_primary_uom                 VARCHAR2,
                                    p_secondary_quantity          NUMBER,
                                    p_secondary_uom               VARCHAR2,
                                    p_report_amount               NUMBER,
                                    p_report_functional_amount    NUMBER,
                                    p_distribution_set_id         NUMBER,
                                    p_company_id                  NUMBER,
                                    p_unit_id                     NUMBER,
                                    p_position_id                 NUMBER,
                                    p_responsibility_center_id    NUMBER,
                                    p_employee_id                 NUMBER,
                                    p_payee_category              VARCHAR2,
                                    p_payee_id                    NUMBER,
                                    p_partner_id                  NUMBER,
                                    p_payment_flag                VARCHAR2,
                                    p_report_status               VARCHAR2,
                                    p_write_off_status            VARCHAR2,
                                    p_write_off_comleted_date     DATE,
                                    p_attachment_num              NUMBER,
                                    p_dimension1_id               NUMBER,
                                    p_dimension2_id               NUMBER,
                                    p_dimension3_id               NUMBER,
                                    p_dimension4_id               NUMBER,
                                    p_dimension5_id               NUMBER,
                                    p_dimension6_id               NUMBER,
                                    p_dimension7_id               NUMBER,
                                    p_dimension8_id               NUMBER,
                                    p_dimension9_id               NUMBER,
                                    p_dimension10_id              NUMBER,
                                    p_account_name                VARCHAR2,
                                    p_account_number              VARCHAR2,
                                    p_payment_type_id             NUMBER,
                                    p_payment_type                VARCHAR2,
                                    p_created_by                  NUMBER,
                                    p_exp_report_line_id          OUT NUMBER,
                                    p_place_type_id               NUMBER,
                                    p_place_id                    NUMBER,
                                    p_tax_type_id                 NUMBER,
                                    p_transportation              IN VARCHAR2 DEFAULT NULL,
                                    p_place_to_id                 IN NUMBER DEFAULT NULL,
                                    p_invoice_type                VARCHAR2 DEFAULT NULL,
                                    p_invoice_number              VARCHAR2 DEFAULT NULL,
                                    p_invoice_status              VARCHAR2 DEFAULT NULL,
                                    p_tax_amount                  NUMBER DEFAULT NULL,
                                    p_sale_amount                 NUMBER DEFAULT NULL,
                                    p_tax_rate                    NUMBER DEFAULT NULL,
                                    p_usage_type                  VARCHAR2 DEFAULT NULL,
                                    p_invoice_code                VARCHAR2 DEFAULT NULL,
                                    p_invoice_date                DATE DEFAULT NULL,
                                    p_input_tax_structure_detail  VARCHAR2 DEFAULT NULL,
                                    p_ref_pay_num                 VARCHAR2 DEFAULT NULL,
                                    p_ref_gather_num              VARCHAR2 DEFAULT NULL,
                                    p_invoice_item                VARCHAR2 DEFAULT NULL,
                                    p_deduction_rules             NUMBER,
                                    p_adjusted_full_deductions    NUMBER,
                                    p_adjusted_partial_deductions NUMBER,
                                    p_adjustable_tax_deductible   NUMBER,
                                    p_invoice_amount              NUMBER,
                                    p_invoice_tax_amount          NUMBER,
                                    p_associated_oasign           VARCHAR2,
                                    p_meetting_name               VARCHAR2 DEFAULT NULL,
                                    p_expenseve_company_id        NUMBER DEFAULT NULL,
                                    p_exp_company_id              NUMBER DEFAULT NULL,
                                    p_special_sales               VARCHAR2 DEFAULT NULL,
                                    p_invoice_sum_amount          NUMBER DEFAULT NULL,
                                    p_invoice_tax_amount_bak      NUMBER DEFAULT NULL,
                                    p_person_number               NUMBER DEFAULT NULL,
                                    p_day_number                  NUMBER DEFAULT NULL,
                                    p_average_cost                NUMBER DEFAULT NULL,
                                    p_employee_levels_id          NUMBER DEFAULT NULL,
                                    p_invoice_check_code          VARCHAR2 DEFAULT NULL,
                                    p_special_situation           VARCHAR2 DEFAULT NULL,
                                    p_invoice_sales_amount        NUMBER DEFAULT NULL) IS
  
    v_exp_report_line_id NUMBER;
    v_budget_item_id     NUMBER;
    v_set_of_books_id    NUMBER;
  
    v_operation_unit_id exp_report_lines.operation_unit_id%TYPE;
    --v_payment_flag      exp_report_lines.payment_flag%type;
    --v_position_id         exp_report_lines.position_id%type;
    v_exp_report_dists_id exp_report_dists.exp_report_dists_id%TYPE;
    v_audit_flag          exp_report_headers.audit_flag%TYPE;
    v_audit_date          exp_report_headers.audit_date%TYPE;
  
    v_default_flag          exp_expense_policies.default_flag%TYPE;
    v_expense_standard      exp_expense_policies.expense_standard%TYPE;
    v_upper_limit           exp_expense_policies.upper_limit%TYPE;
    v_lower_limit           exp_expense_policies.lower_limit%TYPE;
    v_event_name            exp_expense_policies.event_name%TYPE;
    v_changeable_flag       exp_expense_policies.changeable_flag%TYPE;
    v_commit_flag           exp_expense_policies.commit_flag%TYPE;
    v_upper_std_event_name  VARCHAR2(100);
    v_count                 NUMBER;
    v_pmt_count             NUMBER;
    v_expense_policies_id   NUMBER;
    v_dimension_value_count NUMBER := 0;
    TYPE dtable IS TABLE OF NUMBER INDEX BY BINARY_INTEGER;
    dts                          dtable;
    i                            NUMBER;
    v_transportation             VARCHAR2(50);
    v_match_invoice_flag         NUMBER; --add by wxq 20180329
    v_input_tax_structure_detail VARCHAR2(30);
    v_price                      NUMBER;
  BEGIN
  
    IF p_person_number IS NOT NULL AND p_day_number IS NOT NULL THEN
      v_price := p_report_amount / p_person_number / p_day_number;
    ELSE
      v_price := p_price;
    END IF;
  
    --非“调整”类型的报销单，金额必须为正
    sign_check(p_exp_report_type_id => get_exp_report_type_id(p_exp_report_header_id),
               p_number             => /*p_price*/ v_price,
               p_user_id            => p_created_by);
  
    sign_check(p_exp_report_type_id => get_exp_report_type_id(p_exp_report_header_id),
               p_number             => p_primary_quantity,
               p_user_id            => p_created_by);
  
    v_exp_report_line_id := get_exp_report_line_id;
    v_operation_unit_id  := exp_requisition_pkg.get_default_operate_unit_id(p_unit_id);
  
    --Modify bobo 2010.09.29
    v_budget_item_id := bgt_budget_item_mapping_pkg.get_priority_budget_item_id(p_business_type              => bgt_budget_item_mapping_pkg.c_exp_rpt,
                                                                                p_company_id                 => p_company_id,
                                                                                p_company_level_id           => exp_report_common_pkg.get_company_level_id(p_company_id),
                                                                                p_operation_unit_id          => v_operation_unit_id,
                                                                                p_document_type_code         => exp_report_common_pkg.get_document_type_code(p_exp_report_header_id,
                                                                                                                                                             c_exp_report),
                                                                                p_expense_type_code          => exp_report_common_pkg.get_expense_type_code(p_expense_type_id),
                                                                                p_exp_item_id                => p_expense_item_id,
                                                                                p_responsibility_center_code => exp_report_common_pkg.get_resp_center_code(p_responsibility_center_id),
                                                                                p_account_id                 => NULL,
                                                                                p_org_unit_level_id          => exp_report_common_pkg.get_org_unit_level_id(p_unit_id),
                                                                                p_org_unit_code              => exp_report_common_pkg.get_org_unit_code(p_unit_id),
                                                                                p_position_code              => exp_report_common_pkg.get_position_code(p_position_id),
                                                                                p_employee_type_id           => exp_report_common_pkg.get_employee_type_id(p_employee_id),
                                                                                p_employee_levels_id         => exp_report_common_pkg.get_employee_levels_id(p_employee_id),
                                                                                p_employee_id                => p_employee_id,
                                                                                p_payee_category             => p_payee_category,
                                                                                p_payee_id                   => p_payee_id,
                                                                                p_dimension1_id              => p_dimension1_id,
                                                                                p_dimension2_id              => p_dimension2_id,
                                                                                p_dimension3_id              => p_dimension3_id,
                                                                                p_dimension4_id              => p_dimension4_id,
                                                                                p_dimension5_id              => p_dimension5_id,
                                                                                p_dimension6_id              => p_dimension6_id,
                                                                                p_dimension7_id              => p_dimension7_id,
                                                                                p_dimension8_id              => p_dimension8_id,
                                                                                p_dimension9_id              => p_dimension9_id,
                                                                                p_dimension10_id             => p_dimension10_id);
    IF v_budget_item_id IS NULL THEN
      v_budget_item_id := get_expense_budget_item_id(p_expense_item_id);
    END IF;
  
    v_set_of_books_id := gld_common_pkg.get_set_of_books_id(p_company_id);
  
    SELECT audit_flag, audit_date
      INTO v_audit_flag, v_audit_date
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
  
    --v_payment_flag := get_payment_flag(p_exp_report_header_id => p_exp_report_header_id);
    SELECT p_dimension1_id INTO dts(1) FROM dual;
    SELECT p_dimension2_id INTO dts(2) FROM dual;
    SELECT p_dimension3_id INTO dts(3) FROM dual;
    SELECT p_dimension4_id INTO dts(4) FROM dual;
    SELECT p_dimension5_id INTO dts(5) FROM dual;
    SELECT p_dimension6_id INTO dts(6) FROM dual;
    SELECT p_dimension7_id INTO dts(7) FROM dual;
    SELECT p_dimension8_id INTO dts(8) FROM dual;
    SELECT p_dimension9_id INTO dts(9) FROM dual;
    SELECT p_dimension10_id INTO dts(10) FROM dual;
    FOR i IN 1 .. 10 LOOP
      IF dts(i) IS NOT NULL THEN
        SELECT COUNT(1)
          INTO v_dimension_value_count
          FROM fnd_dimensions_vl fdv, fnd_dimension_values_vl fdvv
         WHERE fdv.dimension_id = fdvv.dimension_id
           AND fdv.dimension_sequence = i
           AND fdvv.dimension_value_id = dts(i);
        IF v_dimension_value_count = 1 THEN
          v_dimension_value_count := 0;
        ELSE
          RAISE e_dimension_value_error;
        END IF;
      END IF;
    END LOOP;
  
    --进项明细，根据税率获取
    BEGIN
      SELECT ed.type_code
        INTO v_input_tax_structure_detail
        FROM exp_ygz_input_tax_struc_dtl ed
       WHERE ed.tax_rate = nvl(p_tax_rate, 0)
         AND ed.default_flag = 'Y'
         AND rownum = 1;
    EXCEPTION
      WHEN no_data_found THEN
        v_input_tax_structure_detail := NULL;
    END;
  
    INSERT INTO exp_report_lines
      (exp_report_header_id,
       exp_report_line_id,
       line_number,
       city,
       description,
       date_from,
       date_to,
       period_name,
       currency_code,
       exchange_rate_type,
       exchange_rate_quotation,
       exchange_rate,
       expense_type_id,
       expense_item_id,
       budget_item_id,
       price,
       primary_quantity,
       primary_uom,
       secondary_quantity,
       secondary_uom,
       report_amount,
       report_functional_amount,
       distribution_set_id,
       company_id,
       operation_unit_id,
       unit_id,
       position_id,
       responsibility_center_id,
       employee_id,
       payee_category,
       payee_id,
       partner_id,
       payment_flag,
       report_status,
       audit_flag,
       audit_date,
       write_off_status,
       write_off_comleted_date,
       attachment_num,
       dimension1_id,
       dimension2_id,
       dimension3_id,
       dimension4_id,
       dimension5_id,
       dimension6_id,
       dimension7_id,
       dimension8_id,
       dimension9_id,
       dimension10_id,
       account_name,
       account_number,
       payment_type_id,
       payment_type,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date,
       place_type_id,
       place_id,
       tax_type_id,
       transportation,
       place_to_id,
       invoice_type, --update by robin 2016-04-12 
       invoice_number,
       invoice_status,
       tax_amount,
       sale_amount,
       tax_rate,
       usage_type,
       invoice_code, --added by HM @2016-05-05
       invoice_date,
       input_tax_structure_detail,
       ref_pay_num,
       ref_gather_num,
       invoice_item,
       deduction_rules,
       adjusted_full_deductions,
       adjusted_partial_deductions,
       adjustable_tax_deductible,
       invoice_amount,
       invoice_tax_amount,
       associated_oasign,
       meetting_name,
       expenseve_company_id,
       exp_company_id,
       special_sales,
       invoice_sum_amount,
       invoice_tax_amount_bak,
       person_number,
       day_number,
       average_cost,
       employee_levels_id,
       invoice_check_code,
       special_situation,
       invoice_sales_amount)
    VALUES
      (p_exp_report_header_id,
       v_exp_report_line_id,
       p_line_number,
       p_city,
       p_description,
       p_date_from,
       p_date_to,
       p_period_name,
       p_currency_code,
       p_exchange_rate_type,
       p_exchange_rate_quotation,
       p_exchange_rate,
       p_expense_type_id,
       p_expense_item_id,
       v_budget_item_id,
       /*p_price*/
       v_price,
       p_primary_quantity,
       p_primary_uom,
       p_secondary_quantity,
       p_secondary_uom,
       fnd_format_mask_pkg.get_gld_amount(p_currency_code,
                                          p_report_amount,
                                          v_set_of_books_id),
       fnd_format_mask_pkg.get_gld_amount(p_currency_code,
                                          p_report_functional_amount,
                                          v_set_of_books_id),
       p_distribution_set_id,
       p_company_id,
       v_operation_unit_id,
       p_unit_id,
       p_position_id,
       p_responsibility_center_id,
       p_employee_id,
       p_payee_category,
       p_payee_id,
       p_partner_id,
       p_payment_flag,
       p_report_status,
       v_audit_flag,
       v_audit_date,
       p_write_off_status,
       p_write_off_comleted_date,
       p_attachment_num,
       p_dimension1_id,
       p_dimension2_id,
       p_dimension3_id,
       p_dimension4_id,
       p_dimension5_id,
       p_dimension6_id,
       p_dimension7_id,
       p_dimension8_id,
       p_dimension9_id,
       p_dimension10_id,
       p_account_name,
       p_account_number,
       p_payment_type_id,
       p_payment_type,
       p_created_by,
       SYSDATE,
       p_created_by,
       SYSDATE,
       p_place_type_id,
       p_place_id,
       p_tax_type_id,
       p_transportation,
       p_place_to_id,
       p_invoice_type,
       p_invoice_number,
       p_invoice_status,
       fnd_format_mask_pkg.get_gld_amount(p_currency_code,
                                          p_tax_amount,
                                          v_set_of_books_id),
       fnd_format_mask_pkg.get_gld_amount(p_currency_code,
                                          p_sale_amount,
                                          v_set_of_books_id),
       
       p_tax_rate,
       p_usage_type,
       p_invoice_code,
       p_invoice_date,
       v_input_tax_structure_detail,
       p_ref_pay_num,
       p_ref_gather_num,
       p_invoice_item,
       p_deduction_rules,
       p_adjusted_full_deductions,
       p_adjusted_partial_deductions,
       p_adjustable_tax_deductible,
       p_invoice_amount,
       p_invoice_tax_amount,
       p_associated_oasign,
       p_meetting_name,
       p_expenseve_company_id,
       p_exp_company_id,
       p_special_sales,
       p_invoice_sum_amount,
       p_invoice_tax_amount_bak,
       p_person_number,
       p_day_number,
       p_average_cost,
       p_employee_levels_id,
       p_invoice_check_code,
       p_special_situation,
       p_invoice_sales_amount);
    p_exp_report_line_id := v_exp_report_line_id;
  
    --add by wxq 20180329报销单保存时，与导入的发票进行匹配，匹配成功修改发票状态为验真成功 code:30
    /* v_match_invoice_flag := match_invoice(p_invoice_code,
    p_invoice_number,
    v_exp_report_line_id);*/
    /* IF v_match_invoice_flag = 1 THEN
    UPDATE exp_report_lines l
       SET l.invoice_status = '20' --代验真
     WHERE l.exp_report_line_id = v_exp_report_line_id;*/
    /*UPDATE exp_invoice_info eii
      SET eii.invoice_status   = '30',
          eii.authentic_date   = SYSDATE,
          eii.last_update_by   = p_created_by,
          eii.last_update_time = SYSDATE
    WHERE eii.invoice_code = p_invoice_code;*/
    /*END IF;*/
    ---end
  
    exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_LINES_POST_MODIFY',
                                    p_document_id      => p_exp_report_header_id,
                                    p_document_line_id => v_exp_report_line_id,
                                    p_source_module    => c_exp_report,
                                    p_event_type       => 'EXP_REPORT_LINES_POST_MODIFY',
                                    p_user_id          => p_created_by);
  
    --0031425: 费用政策定义增加超标准事件定义  2010.08.26 Bobo
    /*exp_expense_policies_pkg.get_policy_info(p_company_id           => p_company_id,
                                             p_employee_id          => p_employee_id,
                                             p_expense_item_id      => p_expense_item_id,
                                             p_city                 => p_city,
                                             p_place_type_id        => p_place_type_id,
                                             p_place_id             => p_place_id,
                                             p_transportation       => p_transportation,
                                             p_currency_code        => p_currency_code,
                                             p_position_id          => p_position_id,
                                             p_rep_date             => get_retpor_date(p_exp_report_header_id),
                                             p_default_flag         => v_default_flag,
                                             p_expense_standard     => v_expense_standard,
                                             p_upper_limit          => v_upper_limit,
                                             p_lower_limit          => v_lower_limit,
                                             p_event_name           => v_event_name,
                                             p_changeable_flag      => v_changeable_flag,
                                             p_commit_flag          => v_commit_flag,
                                             p_count                => v_count,
                                             p_expense_policies_id  => v_expense_policies_id,
                                             p_upper_std_event_name => v_upper_std_event_name);
    
    IF v_expense_policies_id IS NOT NULL THEN
      SELECT eep.transportation
        INTO v_transportation
        FROM exp_expense_policies eep
       WHERE eep.expense_policies_id = v_expense_policies_id;
    END IF;
    --超上下限
    IF v_commit_flag = 'Y' AND p_price IS NOT NULL THEN
      IF (p_price < nvl(v_lower_limit, p_price - 1) OR
         p_price > nvl(v_upper_limit, p_price + 1)) THEN
        BEGIN
          exp_evt_pkg.fire_workflow_event(p_event_name       => v_event_name,
                                          p_document_id      => p_exp_report_header_id,
                                          p_document_line_id => v_exp_report_line_id,
                                          p_source_module    => c_exp_report,
                                          p_event_type       => 'EXP_EXPENSE_POLICY',
                                          p_user_id          => p_created_by,
                                          p_param2           => v_expense_standard,
                                          p_param3           => v_upper_limit,
                                          p_param4           => v_lower_limit,
                                          p_param5           => v_event_name,
                                          p_param6           => v_upper_std_event_name,
                                          p_param7           => v_changeable_flag,
                                          p_param8           => v_transportation);
        
        EXCEPTION
          WHEN OTHERS THEN
            RAISE e_sub_program_error;
        END;
      END IF;
    END IF;
    
    IF (v_commit_flag = 'N' AND p_price IS NOT NULL) THEN
      IF (p_price < nvl(v_lower_limit, p_price - 1)) THEN
        sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '金额' ||
                                                                                    p_report_amount ||
                                                                                    '超下限',
                                                       p_created_by              => p_created_by,
                                                       p_package_name            => 'exp_report_pkg',
                                                       p_procedure_function_name => 'insert_exp_report_lines');
      
        raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                sys_raise_app_error_pkg.g_err_line_id);
      
      ELSIF (p_price > nvl(v_upper_limit, p_price + 1)) THEN
        sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '金额' ||
                                                                                    p_report_amount ||
                                                                                    '超上限',
                                                       p_created_by              => p_created_by,
                                                       p_package_name            => 'exp_report_pkg',
                                                       p_procedure_function_name => 'insert_exp_report_lines');
      
        raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                sys_raise_app_error_pkg.g_err_line_id);
      
      END IF;
    END IF;
    
    --超标准
    IF p_price > v_expense_standard AND v_upper_std_event_name IS NOT NULL THEN
      exp_evt_pkg.fire_workflow_event(p_event_name       => v_upper_std_event_name,
                                      p_document_id      => p_exp_report_header_id,
                                      p_document_line_id => v_exp_report_line_id,
                                      p_source_module    => c_exp_report,
                                      p_event_type       => 'EXP_EXPENSE_STANDARD_POLICY',
                                      p_user_id          => p_created_by,
                                      p_param2           => v_expense_standard,
                                      p_param3           => v_upper_limit,
                                      p_param4           => v_lower_limit,
                                      p_param5           => v_event_name,
                                      p_param6           => v_upper_std_event_name,
                                      p_param7           => v_changeable_flag,
                                      p_param8           => v_transportation);
    END IF;*/
  
    --自动插入分配集
    insert_exp_report_dists(p_exchange_rate               => p_exchange_rate,
                            p_created_by                  => p_created_by,
                            p_report_func_amount          => p_report_functional_amount,
                            p_responsibility_center_id    => p_responsibility_center_id,
                            p_report_amount               => p_report_amount,
                            p_exp_report_line_id          => p_exp_report_line_id,
                            p_currency_code               => p_currency_code,
                            p_dimension2_id               => p_dimension2_id,
                            p_dimension4_id               => p_dimension4_id,
                            p_dimension3_id               => p_dimension3_id,
                            p_dimension1_id               => p_dimension1_id,
                            p_attachment_num              => p_attachment_num,
                            p_exceed_budget_strategy      => '',
                            p_dimension10_id              => p_dimension10_id,
                            p_close_date                  => '',
                            p_close_flag                  => 'N',
                            p_dimension9_id               => p_dimension9_id,
                            p_dimension6_id               => p_dimension6_id,
                            p_dimension5_id               => p_dimension5_id,
                            p_dimension8_id               => p_dimension8_id,
                            p_dimension7_id               => p_dimension7_id,
                            p_expense_item_id             => p_expense_item_id,
                            p_price                       => /*p_price*/ v_price,
                            p_primary_uom                 => p_primary_uom,
                            p_primary_quantity            => p_primary_quantity,
                            p_period_name                 => p_period_name,
                            p_description                 => p_description,
                            p_exchange_rate_type          => p_exchange_rate_type,
                            p_expense_type_id             => p_expense_type_id,
                            p_exchange_rate_quotation     => p_exchange_rate_quotation,
                            p_secondary_quantity          => p_secondary_quantity,
                            p_payee_category              => p_payee_category,
                            p_employee_id                 => p_employee_id,
                            p_payee_id                    => p_payee_id,
                            p_partner_id                  => p_partner_id,
                            p_company_id                  => p_company_id,
                            p_secondary_uom               => p_secondary_uom,
                            p_position_id                 => p_position_id,
                            p_unit_id                     => p_unit_id,
                            p_exp_report_dists_id         => v_exp_report_dists_id,
                            p_sale_amount                 => p_sale_amount,
                            p_tax_amount                  => p_tax_amount,
                            p_tax_rate                    => p_tax_rate,
                            p_input_tax_structure_detail  => p_input_tax_structure_detail,
                            p_deduction_rules             => p_deduction_rules,
                            p_adjusted_full_deductions    => p_adjusted_full_deductions,
                            p_adjusted_partial_deductions => p_adjusted_partial_deductions,
                            p_adjustable_tax_deductible   => p_adjustable_tax_deductible,
                            p_invoice_amount              => p_invoice_amount,
                            p_invoice_tax_amount          => p_invoice_tax_amount,
                            p_usage_type                  => p_usage_type);
  
  EXCEPTION
    WHEN dup_val_on_index THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_LINE_NUMBER_ERROR',
                                                      p_created_by              => p_created_by,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'insert_exp_report_lines');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
      --捕获维值错误
    WHEN e_dimension_value_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'DIMENSION_VALUE_ERROR',
                                                      p_created_by              => p_created_by,
                                                      p_package_name            => 'exp_requisition_pkg',
                                                      p_procedure_function_name => 'insert_exp_requisition_lines');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_created_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'insert_exp_report_lines');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END insert_exp_report_lines;

  -->> 1.0 Modify Tagin/2015.06.17 增加交通工具
  PROCEDURE update_exp_report_lines(p_exp_report_line_id       NUMBER,
                                    p_exp_report_header_id     NUMBER,
                                    p_line_number              VARCHAR2,
                                    p_city                     VARCHAR2,
                                    p_description              VARCHAR2,
                                    p_date_from                DATE,
                                    p_date_to                  DATE,
                                    p_expense_type_id          NUMBER,
                                    p_expense_item_id          NUMBER,
                                    p_budget_item_id           NUMBER,
                                    p_price                    NUMBER,
                                    p_primary_quantity         NUMBER,
                                    p_primary_uom              VARCHAR2,
                                    p_secondary_quantity       NUMBER,
                                    p_secondary_uom            VARCHAR2,
                                    p_report_amount            NUMBER,
                                    p_report_functional_amount NUMBER,
                                    p_distribution_set_id      NUMBER,
                                    p_company_id               NUMBER,
                                    p_unit_id                  NUMBER,
                                    p_position_id              NUMBER,
                                    p_responsibility_center_id NUMBER,
                                    p_employee_id              NUMBER,
                                    p_payee_category           VARCHAR2,
                                    p_payee_id                 NUMBER,
                                    p_partner_id               NUMBER,
                                    p_payment_flag             VARCHAR2,
                                    p_attachment_num           NUMBER,
                                    p_dimension1_id            NUMBER,
                                    p_dimension2_id            NUMBER,
                                    p_dimension3_id            NUMBER,
                                    p_dimension4_id            NUMBER,
                                    p_dimension5_id            NUMBER,
                                    p_dimension6_id            NUMBER,
                                    p_dimension7_id            NUMBER,
                                    p_dimension8_id            NUMBER,
                                    p_dimension9_id            NUMBER,
                                    p_dimension10_id           NUMBER,
                                    p_account_name             VARCHAR2,
                                    p_account_number           VARCHAR2,
                                    p_payment_type_id          NUMBER,
                                    p_payment_type             VARCHAR2,
                                    p_last_updated_by          NUMBER,
                                    p_exchange_rate            NUMBER,
                                    p_currency_code            VARCHAR2,
                                    p_period_name              VARCHAR2,
                                    p_exchange_rate_type       VARCHAR2,
                                    p_exchange_rate_quotation  VARCHAR2,
                                    p_place_type_id            NUMBER,
                                    p_place_id                 NUMBER,
                                    --add wgf 2012/12/26
                                    p_contract_header_id          NUMBER,
                                    p_payment_schedule_line_id    NUMBER,
                                    p_tax_type_id                 NUMBER,
                                    p_transportation              IN VARCHAR2 DEFAULT NULL,
                                    p_place_to_id                 IN NUMBER DEFAULT NULL,
                                    p_invoice_type                VARCHAR2 DEFAULT NULL,
                                    p_invoice_number              VARCHAR2 DEFAULT NULL,
                                    p_invoice_status              VARCHAR2 DEFAULT NULL,
                                    p_tax_amount                  NUMBER DEFAULT NULL,
                                    p_sale_amount                 NUMBER DEFAULT NULL,
                                    p_tax_rate                    NUMBER DEFAULT NULL,
                                    p_usage_type                  VARCHAR2 DEFAULT NULL,
                                    p_invoice_code                VARCHAR2 DEFAULT NULL,
                                    p_invoice_date                DATE DEFAULT NULL,
                                    p_input_tax_structure_detail  VARCHAR2 DEFAULT NULL,
                                    p_ref_pay_num                 VARCHAR2 DEFAULT NULL,
                                    p_ref_gather_num              VARCHAR2 DEFAULT NULL,
                                    p_invoice_item                VARCHAR2 DEFAULT NULL,
                                    p_deduction_rules             NUMBER,
                                    p_adjusted_full_deductions    NUMBER,
                                    p_adjusted_partial_deductions NUMBER,
                                    p_adjustable_tax_deductible   NUMBER,
                                    p_invoice_amount              NUMBER,
                                    p_invoice_tax_amount          NUMBER,
                                    p_associated_oasign           VARCHAR2,
                                    p_meetting_name               VARCHAR2 DEFAULT NULL,
                                    p_expenseve_company_id        NUMBER DEFAULT NULL,
                                    p_exp_company_id              NUMBER DEFAULT NULL,
                                    p_special_sales               VARCHAR2 DEFAULT NULL,
                                    p_invoice_sum_amount          NUMBER DEFAULT NULL,
                                    p_invoice_tax_amount_bak      NUMBER DEFAULT NULL,
                                    p_person_number               NUMBER DEFAULT NULL,
                                    p_day_number                  NUMBER DEFAULT NULL,
                                    p_average_cost                NUMBER DEFAULT NULL,
                                    p_employee_levels_id          NUMBER DEFAULT NULL,
                                    p_invoice_check_code          VARCHAR2 DEFAULT NULL,
                                    p_special_situation           VARCHAR2 DEFAULT NULL,
                                    p_invoice_sales_amount        NUMBER DEFAULT NULL) IS
    v_budget_item_id           NUMBER;
    v_set_of_books_id          NUMBER;
    v_report_amount            NUMBER;
    v_report_functional_amount NUMBER;
  
    v_operation_unit_id exp_report_headers.operation_unit_id%TYPE;
    --v_position_id       exp_report_headers.position_id%type;
    v_default_flag         exp_expense_policies.default_flag%TYPE;
    v_expense_standard     exp_expense_policies.expense_standard%TYPE;
    v_upper_limit          exp_expense_policies.upper_limit%TYPE;
    v_lower_limit          exp_expense_policies.lower_limit%TYPE;
    v_event_name           exp_expense_policies.event_name%TYPE;
    v_changeable_flag      exp_expense_policies.changeable_flag%TYPE;
    v_commit_flag          exp_expense_policies.commit_flag%TYPE;
    v_upper_std_event_name VARCHAR2(100);
    v_count                NUMBER;
    v_expense_policies_id  NUMBER;
  
    --add 2012/12/25
    v_num                NUMBER;
    v_line_count         NUMBER;
    v_schedule_line_id   NUMBER;
    v_transportation     VARCHAR2(50);
    v_match_invoice_flag NUMBER; --add by wxq 20180329
  
    v_input_tax_structure_detail VARCHAR2(30);
    v_price                      NUMBER;
  BEGIN
  
    IF p_person_number IS NOT NULL AND p_day_number IS NOT NULL THEN
      v_price := p_report_amount / p_person_number / p_day_number;
    ELSE
      v_price := p_price;
    END IF;
  
    --非“调整”类型的报销单，金额必须为正
    sign_check(p_exp_report_type_id => get_exp_report_type_id(p_exp_report_header_id),
               p_number             => /*p_price*/ v_price,
               p_user_id            => p_last_updated_by);
  
    sign_check(p_exp_report_type_id => get_exp_report_type_id(p_exp_report_header_id),
               p_number             => p_primary_quantity,
               p_user_id            => p_last_updated_by);
  
    IF update_status_check(p_exp_report_header_id, p_last_updated_by) = 'Y' THEN
      --Modify bobo 2010.09.29
      v_budget_item_id := bgt_budget_item_mapping_pkg.get_priority_budget_item_id(p_business_type              => bgt_budget_item_mapping_pkg.c_exp_rpt,
                                                                                  p_company_id                 => p_company_id,
                                                                                  p_company_level_id           => exp_report_common_pkg.get_company_level_id(p_company_id),
                                                                                  p_operation_unit_id          => v_operation_unit_id,
                                                                                  p_document_type_code         => exp_report_common_pkg.get_document_type_code(p_exp_report_header_id,
                                                                                                                                                               c_exp_report),
                                                                                  p_expense_type_code          => exp_report_common_pkg.get_expense_type_code(p_expense_type_id),
                                                                                  p_exp_item_id                => p_expense_item_id,
                                                                                  p_responsibility_center_code => exp_report_common_pkg.get_resp_center_code(p_responsibility_center_id),
                                                                                  p_account_id                 => NULL,
                                                                                  p_org_unit_level_id          => exp_report_common_pkg.get_org_unit_level_id(p_unit_id),
                                                                                  p_org_unit_code              => exp_report_common_pkg.get_org_unit_code(p_unit_id),
                                                                                  p_position_code              => exp_report_common_pkg.get_position_code(p_position_id),
                                                                                  p_employee_type_id           => exp_report_common_pkg.get_employee_type_id(p_employee_id),
                                                                                  p_employee_levels_id         => exp_report_common_pkg.get_employee_levels_id(p_employee_id),
                                                                                  p_employee_id                => p_employee_id,
                                                                                  p_payee_category             => p_payee_category,
                                                                                  p_payee_id                   => p_payee_id,
                                                                                  p_dimension1_id              => p_dimension1_id,
                                                                                  p_dimension2_id              => p_dimension2_id,
                                                                                  p_dimension3_id              => p_dimension3_id,
                                                                                  p_dimension4_id              => p_dimension4_id,
                                                                                  p_dimension5_id              => p_dimension5_id,
                                                                                  p_dimension6_id              => p_dimension6_id,
                                                                                  p_dimension7_id              => p_dimension7_id,
                                                                                  p_dimension8_id              => p_dimension8_id,
                                                                                  p_dimension9_id              => p_dimension9_id,
                                                                                  p_dimension10_id             => p_dimension10_id);
    
      IF v_budget_item_id IS NULL THEN
        v_budget_item_id := get_expense_budget_item_id(p_expense_item_id);
      END IF;
    
      v_operation_unit_id := exp_requisition_pkg.get_default_operate_unit_id(p_unit_id);
    
      v_set_of_books_id          := gld_common_pkg.get_set_of_books_id(p_company_id);
      v_report_amount            := fnd_format_mask_pkg.get_gld_amount(p_currency_code,
                                                                       p_report_amount,
                                                                       v_set_of_books_id);
      v_report_functional_amount := fnd_format_mask_pkg.get_gld_amount(p_currency_code,
                                                                       p_report_functional_amount,
                                                                       v_set_of_books_id);
    
      reset_exp_report_dists(p_exp_report_line_id          => p_exp_report_line_id,
                             p_description                 => p_description,
                             p_expense_type_id             => p_expense_type_id,
                             p_expense_item_id             => p_expense_item_id,
                             p_price                       => /*p_price*/ v_price,
                             p_primary_quantity            => p_primary_quantity,
                             p_primary_uom                 => p_primary_uom,
                             p_secondary_quantity          => p_secondary_quantity,
                             p_secondary_uom               => p_secondary_uom,
                             p_report_amount               => v_report_amount,
                             p_report_functional_amount    => v_report_functional_amount,
                             p_distribution_set_id         => p_distribution_set_id,
                             p_company_id                  => p_company_id,
                             p_operation_unit_id           => v_operation_unit_id,
                             p_position_id                 => p_position_id,
                             p_responsibility_center_id    => p_responsibility_center_id,
                             p_employee_id                 => p_employee_id,
                             p_payee_category              => p_payee_category,
                             p_payee_id                    => p_payee_id,
                             p_dimension1_id               => p_dimension1_id,
                             p_dimension2_id               => p_dimension2_id,
                             p_dimension3_id               => p_dimension3_id,
                             p_dimension4_id               => p_dimension4_id,
                             p_dimension5_id               => p_dimension5_id,
                             p_dimension6_id               => p_dimension6_id,
                             p_dimension7_id               => p_dimension7_id,
                             p_dimension8_id               => p_dimension8_id,
                             p_dimension9_id               => p_dimension9_id,
                             p_dimension10_id              => p_dimension10_id,
                             p_user_id                     => p_last_updated_by,
                             p_exchange_rate               => p_exchange_rate,
                             p_currency_code               => p_currency_code,
                             p_period_name                 => p_period_name,
                             p_exchange_rate_type          => p_exchange_rate_type,
                             p_exchange_rate_quotation     => p_exchange_rate_quotation,
                             p_unit_id                     => p_unit_id,
                             p_budget_item_id              => v_budget_item_id,
                             p_sale_amount                 => p_sale_amount,
                             p_tax_amount                  => p_tax_amount,
                             p_tax_rate                    => p_tax_rate,
                             p_input_tax_structure_detail  => p_input_tax_structure_detail,
                             p_deduction_rules             => p_deduction_rules,
                             p_adjusted_full_deductions    => p_adjusted_full_deductions,
                             p_adjusted_partial_deductions => p_adjusted_partial_deductions,
                             p_adjustable_tax_deductible   => p_adjustable_tax_deductible,
                             p_invoice_amount              => p_invoice_amount,
                             p_invoice_tax_amount          => p_invoice_tax_amount,
                             p_associated_oasign           => p_associated_oasign,
                             p_usage_type                  => p_usage_type);
    
      --进项明细，根据税率获取
      BEGIN
        SELECT ed.type_code
          INTO v_input_tax_structure_detail
          FROM exp_ygz_input_tax_struc_dtl ed
         WHERE ed.tax_rate = nvl(p_tax_rate, 0)
           AND ed.default_flag = 'Y'
           AND rownum = 1;
      EXCEPTION
        WHEN no_data_found THEN
          v_input_tax_structure_detail := NULL;
      END;
    
      UPDATE exp_report_lines l
         SET city                          = p_city,
             description                   = p_description,
             line_number                   = p_line_number,
             date_from                     = p_date_from,
             date_to                       = p_date_to,
             expense_type_id               = p_expense_type_id,
             expense_item_id               = p_expense_item_id,
             budget_item_id                = v_budget_item_id,
             price                         = /*p_price*/ v_price,
             primary_quantity              = p_primary_quantity,
             primary_uom                   = p_primary_uom,
             secondary_quantity            = p_secondary_quantity,
             secondary_uom                 = p_secondary_uom,
             report_amount                 = v_report_amount,
             report_functional_amount      = v_report_functional_amount,
             distribution_set_id           = p_distribution_set_id,
             company_id                    = p_company_id,
             unit_id                       = p_unit_id,
             responsibility_center_id      = p_responsibility_center_id,
             employee_id                   = p_employee_id,
             payee_category                = p_payee_category,
             payee_id                      = p_payee_id,
             partner_id                    = p_partner_id,
             payment_flag                  = p_payment_flag,
             attachment_num                = p_attachment_num,
             dimension1_id                 = p_dimension1_id,
             dimension2_id                 = p_dimension2_id,
             dimension3_id                 = p_dimension3_id,
             dimension4_id                 = p_dimension4_id,
             dimension5_id                 = p_dimension5_id,
             dimension6_id                 = p_dimension6_id,
             dimension7_id                 = p_dimension7_id,
             dimension8_id                 = p_dimension8_id,
             dimension9_id                 = p_dimension9_id,
             dimension10_id                = p_dimension10_id,
             account_name                  = p_account_name,
             account_number                = p_account_number,
             payment_type_id               = p_payment_type_id,
             payment_type                  = p_payment_type,
             last_updated_by               = p_last_updated_by,
             last_update_date              = SYSDATE,
             operation_unit_id             = v_operation_unit_id,
             position_id                   = p_position_id,
             period_name                   = p_period_name,
             l.place_type_id               = p_place_type_id,
             l.place_id                    = p_place_id,
             l.tax_type_id                 = p_tax_type_id,
             l.transportation              = p_transportation,
             l.place_to_id                 = p_place_to_id,
             invoice_type                  = p_invoice_type, --update by robin 2016-04-12
             invoice_number                = p_invoice_number,
             l.invoice_status              = p_invoice_status,
             tax_amount                    = p_tax_amount,
             sale_amount                   = p_sale_amount,
             tax_rate                      = p_tax_rate,
             usage_type                    = p_usage_type,
             l.invoice_code                = p_invoice_code, --added by HM @2016-05-05
             l.invoice_date                = p_invoice_date,
             l.input_tax_structure_detail  = v_input_tax_structure_detail,
             l.ref_pay_num                 = p_ref_pay_num,
             l.ref_gather_num              = p_ref_gather_num,
             l.invoice_item                = p_invoice_item,
             l.deduction_rules             = p_deduction_rules,
             l.adjusted_full_deductions    = p_adjusted_full_deductions,
             l.adjusted_partial_deductions = p_adjusted_partial_deductions,
             l.adjustable_tax_deductible   = p_adjustable_tax_deductible,
             l.invoice_amount              = p_invoice_amount,
             l.invoice_tax_amount          = p_invoice_tax_amount,
             l.associated_oasign           = p_associated_oasign,
             l.meetting_name               = p_meetting_name,
             l.expenseve_company_id        = p_expenseve_company_id,
             l.exp_company_id              = p_exp_company_id,
             l.special_sales               = p_special_sales,
             l.invoice_sum_amount          = p_invoice_sum_amount,
             l.invoice_tax_amount_bak      = p_invoice_tax_amount_bak,
             l.person_number               = p_person_number,
             l.day_number                  = p_day_number,
             l.average_cost                = p_average_cost,
             l.employee_levels_id          = p_employee_levels_id,
             l.invoice_check_code          = p_invoice_check_code,
             l.special_situation           = p_special_situation,
             l.invoice_sales_amount        = p_invoice_sales_amount
       WHERE exp_report_line_id = p_exp_report_line_id;
    
      --add by wxq 20180329报销单保存时，与导入的发票进行匹配，匹配成功修改发票状态为验真成功 code:30
      /* v_match_invoice_flag := match_invoice(p_invoice_code,
                                            p_invoice_number,
                                            p_exp_report_line_id);
      IF v_match_invoice_flag = 1 THEN*/
      /*UPDATE exp_report_lines l
         SET l.invoice_status = '30'
       WHERE l.exp_report_line_id = p_exp_report_line_id;
      UPDATE exp_invoice_info eii
         SET eii.invoice_status   = '30',
             eii.authentic_date   = SYSDATE,
             eii.last_update_by   = p_last_updated_by,
             eii.last_update_time = SYSDATE
       WHERE eii.invoice_code = p_invoice_code
         AND eii.invoice_number = p_invoice_number;*/
    
      /* UPDATE exp_report_lines l
           SET l.invoice_status = '20'
         WHERE l.exp_report_line_id = p_exp_report_line_id;
      ELSE
        -- 匹配失败时将发票状态修改为待验真 code ：20 modify by wxq 20180409
        \*IF (p_invoice_status = '30' OR p_invoice_status = '40' OR
        p_invoice_status = '50') AND p_invoice_code IS NOT NULL AND
        p_invoice_number IS NOT NULL THEN*\
        UPDATE exp_report_lines l
           SET l.invoice_status = '20'
         WHERE l.exp_report_line_id = p_exp_report_line_id;
        \*END IF;*\
      END IF;*/
      ---end
    
      --add wgf 2012/12/26 更新合同
      IF p_contract_header_id IS NOT NULL OR
         p_payment_schedule_line_id IS NOT NULL THEN
      
        SELECT COUNT(1)
          INTO v_num
          FROM con_document_flows cdf
         WHERE cdf.document_type = 'CON_CONTRACT'
           AND cdf.source_document_type = 'EXP_REPORT_LINES'
           AND cdf.source_document_id = p_exp_report_header_id
           AND cdf.source_document_line_id = p_exp_report_line_id
           AND (p_contract_header_id IS NULL OR
               cdf.document_id = p_contract_header_id)
           AND (p_payment_schedule_line_id IS NULL OR
               cdf.document_line_id = p_payment_schedule_line_id);
        IF v_num = 0 THEN
          con_contract_maintenance_pkg.insert_con_document_flows('CON_CONTRACT',
                                                                 p_contract_header_id,
                                                                 p_payment_schedule_line_id,
                                                                 'EXP_REPORT_LINES',
                                                                 p_exp_report_header_id,
                                                                 p_exp_report_line_id,
                                                                 p_last_updated_by);
        END IF;
      END IF;
    
      --add wgf 2012/12/25 当更新报销单行金额时，且属于此报销单头的计划付款行只有一条时更新
    
      SELECT COUNT(1)
        INTO v_num
        FROM exp_report_pmt_schedules erps
       WHERE erps.exp_report_header_id = p_exp_report_header_id;
    
      SELECT COUNT(1)
        INTO v_line_count
        FROM (SELECT cdf.document_id, cdf.document_line_id
                FROM exp_report_lines erl, con_document_flows cdf
               WHERE erl.exp_report_header_id = p_exp_report_header_id
                 AND erl.exp_report_header_id = cdf.source_document_id(+)
                 AND erl.exp_report_line_id = cdf.source_document_line_id(+)
                 AND cdf.document_type(+) = 'CON_CONTRACT'
                 AND cdf.source_document_type(+) = 'EXP_REPORT_LINES'
               GROUP BY cdf.document_id, cdf.document_line_id);
      IF v_num = 0 OR (v_num = 1 AND v_line_count >= 2) THEN
        create_exp_rep_pmt_schedule(p_exp_report_header_id => p_exp_report_header_id,
                                    p_created_by           => p_last_updated_by);
      END IF;
    
      IF v_num = 1 AND v_line_count < 2 THEN
        BEGIN
          SELECT ers.payment_schedule_line_id
            INTO v_schedule_line_id
            FROM exp_report_pmt_schedules ers
           WHERE ers.exp_report_header_id = p_exp_report_header_id
             FOR UPDATE NOWAIT;
        EXCEPTION
          WHEN OTHERS THEN
            RETURN;
        END;
      
        UPDATE exp_report_pmt_schedules erps
           SET erps.due_amount      =
               (SELECT SUM(nvl(erl.report_amount, 0))
                  FROM exp_report_lines erl, con_document_flows cdf
                 WHERE erl.exp_report_header_id = p_exp_report_header_id
                   AND erl.exp_report_header_id = cdf.source_document_id(+)
                   AND erl.exp_report_line_id =
                       cdf.source_document_line_id(+)
                   AND cdf.document_type(+) = 'CON_CONTRACT'
                   AND cdf.source_document_type(+) = 'EXP_REPORT_LINES'
                 GROUP BY cdf.document_id, cdf.document_line_id),
               erps.last_updated_by  = p_last_updated_by,
               erps.last_update_date = SYSDATE
         WHERE erps.exp_report_header_id = p_exp_report_header_id;
      END IF;
      --end
      exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_LINES_POST_MODIFY',
                                      p_document_id      => p_exp_report_header_id,
                                      p_document_line_id => p_exp_report_line_id,
                                      p_source_module    => c_exp_report,
                                      p_event_type       => 'EXP_REPORT_LINES_POST_MODIFY',
                                      p_user_id          => p_last_updated_by);
    
      --0031425: 费用政策定义增加超标准事件定义  2010.08.26 Bobo
      exp_evt_pkg.delete_workflow_event(p_document_id      => p_exp_report_header_id,
                                        p_source_module    => c_exp_report,
                                        p_event_type       => 'EXP_EXPENSE_STANDARD_POLICY',
                                        p_user_id          => p_last_updated_by,
                                        p_document_line_id => p_exp_report_line_id);
      exp_evt_pkg.delete_workflow_event(p_document_id      => p_exp_report_header_id,
                                        p_source_module    => c_exp_report,
                                        p_event_type       => 'EXP_EXPENSE_POLICY',
                                        p_user_id          => p_last_updated_by,
                                        p_document_line_id => p_exp_report_line_id);
      exp_expense_policies_pkg.get_policy_info(p_company_id           => p_company_id,
                                               p_employee_id          => p_employee_id,
                                               p_expense_item_id      => p_expense_item_id,
                                               p_city                 => p_city,
                                               p_place_type_id        => p_place_type_id,
                                               p_place_id             => p_place_id,
                                               p_transportation       => p_transportation,
                                               p_currency_code        => p_currency_code,
                                               p_position_id          => p_position_id,
                                               p_rep_date             => get_retpor_date(p_exp_report_header_id),
                                               p_default_flag         => v_default_flag,
                                               p_expense_standard     => v_expense_standard,
                                               p_upper_limit          => v_upper_limit,
                                               p_lower_limit          => v_lower_limit,
                                               p_event_name           => v_event_name,
                                               p_changeable_flag      => v_changeable_flag,
                                               p_commit_flag          => v_commit_flag,
                                               p_count                => v_count,
                                               p_expense_policies_id  => v_expense_policies_id,
                                               p_upper_std_event_name => v_upper_std_event_name);
    
      IF v_expense_policies_id IS NOT NULL THEN
        SELECT eep.transportation
          INTO v_transportation
          FROM exp_expense_policies eep
         WHERE eep.expense_policies_id = v_expense_policies_id;
      END IF;
      IF v_commit_flag = 'Y' AND p_price IS NOT NULL THEN
        IF (p_price < nvl(v_lower_limit, p_price - 1) OR
           p_price > nvl(v_upper_limit, p_price + 1)) THEN
          BEGIN
            exp_evt_pkg.fire_workflow_event(p_event_name       => v_event_name,
                                            p_document_id      => p_exp_report_header_id,
                                            p_document_line_id => p_exp_report_line_id,
                                            p_source_module    => c_exp_report,
                                            p_event_type       => 'EXP_EXPENSE_POLICY',
                                            p_user_id          => p_last_updated_by,
                                            p_param2           => v_expense_standard,
                                            p_param3           => v_upper_limit,
                                            p_param4           => v_lower_limit,
                                            p_param5           => v_event_name,
                                            p_param6           => v_upper_std_event_name,
                                            p_param7           => v_changeable_flag,
                                            p_param8           => v_transportation);
          
          EXCEPTION
            WHEN OTHERS THEN
              RAISE e_sub_program_error;
          END;
        END IF;
      END IF;
    
      IF (v_commit_flag = 'N' AND p_price IS NOT NULL) THEN
        IF (p_price < nvl(v_lower_limit, p_price - 1)) THEN
          sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '金额' ||
                                                                                      p_report_amount ||
                                                                                      '超下限',
                                                         p_created_by              => p_last_updated_by,
                                                         p_package_name            => 'exp_report_pkg',
                                                         p_procedure_function_name => 'update_exp_report_lines');
        
          raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                  sys_raise_app_error_pkg.g_err_line_id);
        
        ELSIF (p_price > nvl(v_upper_limit, p_price + 1)) THEN
          sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '金额' ||
                                                                                      p_report_amount ||
                                                                                      '超上限',
                                                         p_created_by              => p_last_updated_by,
                                                         p_package_name            => 'exp_report_pkg',
                                                         p_procedure_function_name => 'update_exp_report_lines');
        
          raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                  sys_raise_app_error_pkg.g_err_line_id);
        
        END IF;
      END IF;
    
      IF p_price > v_expense_standard AND
         v_upper_std_event_name IS NOT NULL THEN
        exp_evt_pkg.fire_workflow_event(p_event_name       => v_upper_std_event_name,
                                        p_document_id      => p_exp_report_header_id,
                                        p_document_line_id => p_exp_report_line_id,
                                        p_source_module    => c_exp_report,
                                        p_event_type       => 'EXP_EXPENSE_STANDARD_POLICY',
                                        p_user_id          => p_last_updated_by,
                                        p_param2           => v_expense_standard,
                                        p_param3           => v_upper_limit,
                                        p_param4           => v_lower_limit,
                                        p_param5           => v_event_name,
                                        p_param6           => v_upper_std_event_name,
                                        p_param7           => v_changeable_flag,
                                        p_param8           => v_transportation);
      END IF;
    
    END IF;
  EXCEPTION
    WHEN dup_val_on_index THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_LINE_NUMBER_ERROR',
                                                      p_created_by              => p_last_updated_by,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'update_exp_report_lines');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_last_updated_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'update_exp_report_lines');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END update_exp_report_lines;

  PROCEDURE delete_exp_report_lines(p_exp_report_line_id   NUMBER,
                                    p_created_by           NUMBER,
                                    p_exp_report_header_id NUMBER) IS
  
  BEGIN
    IF p_exp_report_line_id IS NOT NULL AND
       p_exp_report_header_id IS NOT NULL THEN
      --单行删除
      --是否可删除校验
      IF delete_data_check(p_exp_report_header_id) = 'Y' THEN
      
        DELETE FROM exp_report_accounts a
         WHERE EXISTS
         (SELECT 1
                  FROM exp_report_dists d
                 WHERE d.exp_report_dists_id = a.exp_report_dists_id
                   AND d.exp_report_line_id = p_exp_report_line_id);
      
        DELETE FROM bgt_budget_reserves t
         WHERE t.business_type = c_exp_report
           AND t.document_id = p_exp_report_header_id
           AND t.document_line_id IN
               (SELECT rd.exp_report_dists_id
                  FROM exp_report_dists rd
                 WHERE rd.exp_report_line_id = p_exp_report_line_id);
      
        FOR v_dists IN (SELECT d.exp_report_dists_id
                          FROM exp_report_dists d
                         WHERE d.exp_report_line_id = p_exp_report_line_id) LOOP
          delete_exp_report_dists(p_line_id => p_exp_report_line_id,
                                  p_dist_id => v_dists.exp_report_dists_id,
                                  p_user_id => p_created_by);
        END LOOP;
      
        DELETE FROM exp_report_objects o
         WHERE o.exp_report_line_id = p_exp_report_line_id;
      
        DELETE FROM exp_report_lines l
         WHERE l.exp_report_line_id = p_exp_report_line_id;
      
        /*--删除报销单与申请单相关
        del_released_budget_reserves(p_document_id      => '',
                                     p_document_line_id => p_exp_report_line_id,
                                     p_document_dist_id => '',
                                     p_user_id          => p_created_by);*/
      
        -- added by majianjian at 2015/3/25 15:30:50
        -- purpose: 删除报销单差旅行
        DELETE FROM exp_report_travel_lines l
         WHERE l.exp_report_line_id = p_exp_report_line_id;
        -- end add.
      
        /*-- added by majianjian at 2015/3/25 15:32:28
        -- purpose: 删除该行对应的差旅计划预算预留释放
        del_tra_plan_reserves_release(p_exp_report_header_id => '',
                                      p_exp_report_line_id   => p_exp_report_line_id);
        -- end add.*/
      
        --删除合同
        DELETE FROM con_document_flows f
         WHERE f.source_document_type = 'EXP_REPORT_LINES'
           AND f.source_document_id = p_exp_report_header_id
           AND f.source_document_line_id = p_exp_report_line_id
           AND f.document_type = 'CON_CONTRACT';
      
        --删除费用政策相关事件
        exp_evt_pkg.delete_workflow_event(p_document_id      => p_exp_report_header_id,
                                          p_source_module    => c_exp_report,
                                          p_event_type       => 'EXP_EXPENSE_STANDARD_POLICY',
                                          p_user_id          => p_created_by,
                                          p_document_line_id => p_exp_report_line_id);
        exp_evt_pkg.delete_workflow_event(p_document_id      => p_exp_report_header_id,
                                          p_source_module    => c_exp_report,
                                          p_event_type       => 'EXP_EXPENSE_POLICY',
                                          p_user_id          => p_created_by,
                                          p_document_line_id => p_exp_report_line_id);
      END IF;
    
    ELSIF p_exp_report_line_id IS NULL AND
          p_exp_report_header_id IS NOT NULL THEN
      --删除所有行
      FOR cur_exp_line IN (SELECT l.exp_report_line_id line_id
                             FROM exp_report_lines l
                            WHERE l.exp_report_header_id =
                                  p_exp_report_header_id) LOOP
        DELETE FROM exp_report_accounts a
         WHERE EXISTS
         (SELECT 1
                  FROM exp_report_dists d
                 WHERE d.exp_report_dists_id = a.exp_report_dists_id
                   AND d.exp_report_line_id = cur_exp_line.line_id);
      
        FOR v_dists IN (SELECT d.exp_report_dists_id
                          FROM exp_report_dists d
                         WHERE d.exp_report_line_id = cur_exp_line.line_id) LOOP
          delete_exp_report_dists(p_line_id => cur_exp_line.line_id,
                                  p_dist_id => v_dists.exp_report_dists_id,
                                  p_user_id => p_created_by);
        END LOOP;
      
        DELETE FROM exp_report_lines l
         WHERE l.exp_report_line_id = cur_exp_line.line_id;
      
        -- added by majianjian at 2015/3/25 15:30:50
        -- purpose: 删除报销单差旅行
        DELETE FROM exp_report_travel_lines l
         WHERE l.exp_report_line_id = cur_exp_line.line_id;
        -- end add.
      
        -- added by majianjian at 2015/3/25 15:32:28
        -- purpose: 删除该行对应的差旅计划预算预留释放
        del_tra_plan_reserves_release(p_exp_report_header_id => '',
                                      p_exp_report_line_id   => cur_exp_line.line_id);
        -- end add.
      
      END LOOP;
    END IF;
  EXCEPTION
    WHEN e_lock_table THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_LOCK_RECORD_ERROR',
                                                      p_created_by              => p_created_by,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'delete_exp_report_lines');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_delete_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_DELETE_ERROR',
                                                      p_created_by              => p_created_by,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'delete_exp_report_lines');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_created_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'delete_exp_report_lines');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END delete_exp_report_lines;

  --重新设置行号
  PROCEDURE resert_exp_rep_line_number(p_exp_report_header_id NUMBER,
                                       p_last_updated_by      NUMBER) IS
  
    CURSOR cur_line_num IS
      SELECT l.line_number
        FROM exp_report_lines l
       WHERE l.exp_report_header_id = p_exp_report_header_id
       ORDER BY l.line_number
         FOR UPDATE NOWAIT;
  
    v_line_number_beginning exp_report_lines.line_number%TYPE;
    v_step_length           exp_expense_report_types.step_length%TYPE;
    v_cur_line_num          exp_report_lines.line_number%TYPE;
    v_exp_report_type_id    exp_report_headers.exp_report_type_id%TYPE;
  
    e_lock_table EXCEPTION;
    PRAGMA EXCEPTION_INIT(e_lock_table, -54);
  BEGIN
    --取申请类型
    SELECT h.exp_report_type_id
      INTO v_exp_report_type_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
  
    OPEN cur_line_num; --锁表
  
    get_line_number(p_expense_report_type_id => v_exp_report_type_id,
                    p_line_number_beginning  => v_line_number_beginning,
                    p_step_length            => v_step_length);
  
    --为防止line_number重复错误，先更新源数据
    UPDATE exp_report_lines l
       SET l.line_number      = l.line_number + 50000,
           l.last_updated_by  = p_last_updated_by,
           l.last_update_date = SYSDATE
     WHERE l.exp_report_header_id = p_exp_report_header_id;
  
    --按行号生成规则，重新生成行号
    FOR cur_num IN (SELECT l.line_number, l.exp_report_line_id
                      FROM exp_report_lines l
                     WHERE l.exp_report_header_id = p_exp_report_header_id
                     ORDER BY l.line_number) LOOP
      IF v_cur_line_num IS NULL THEN
        v_cur_line_num := v_line_number_beginning;
      ELSE
        v_cur_line_num := v_cur_line_num + v_step_length;
      END IF;
    
      UPDATE exp_report_lines l
         SET l.line_number      = v_cur_line_num,
             l.last_updated_by  = p_last_updated_by,
             l.last_update_date = SYSDATE
       WHERE l.exp_report_line_id = cur_num.exp_report_line_id;
    END LOOP;
  
    -- 设置关联流水
    cux_bank_details_spe_pkg.update_pay_gather_ref_info(p_exp_report_header_id,
                                                        p_last_updated_by);
  
    CLOSE cur_line_num;
  EXCEPTION
    WHEN e_lock_table THEN
      IF cur_line_num%ISOPEN THEN
        CLOSE cur_line_num;
      END IF;
    
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_LOCK_REPORT_LINES_ERROR',
                                                      p_created_by              => p_last_updated_by,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'resert_exp_rep_line_number');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      IF cur_line_num%ISOPEN THEN
        CLOSE cur_line_num;
      END IF;
    
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_last_updated_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'resert_exp_rep_line_number');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END resert_exp_rep_line_number;

  /*  procedure get_report_line_city(p_exp_report_line_id number,
                                 p_city               out varchar2,
                                 p_place_type_id      out number,
                                 p_place_id           out number) is
  begin
    select city,
           l.place_type_id,
           l.place_id
      into p_city,
           p_place_type_id,
           p_place_id
      from exp_report_lines l
     where exp_report_line_id = p_exp_report_line_id;
  exception
    when no_data_found then
      null;
  end;*/

  --是否占用预算
  FUNCTION exp_rpt_reserve_budget_check(p_exp_rpt_header_id NUMBER)
    RETURN VARCHAR2 IS
    v_flag VARCHAR2(1);
  BEGIN
    SELECT nvl(t.reserve_budget, 'Y')
      INTO v_flag
      FROM exp_report_headers h, exp_expense_report_types t
     WHERE h.exp_report_header_id = p_exp_rpt_header_id
       AND h.exp_report_type_id = t.expense_report_type_id;
    RETURN v_flag;
  EXCEPTION
    WHEN no_data_found THEN
      RETURN NULL;
  END;

  --分配行
  PROCEDURE insert_exp_report_dists(p_exchange_rate            NUMBER,
                                    p_created_by               NUMBER,
                                    p_report_func_amount       NUMBER,
                                    p_responsibility_center_id NUMBER,
                                    p_report_amount            NUMBER,
                                    p_exp_report_line_id       NUMBER,
                                    p_currency_code            VARCHAR2,
                                    p_dimension2_id            NUMBER DEFAULT NULL,
                                    p_dimension4_id            NUMBER DEFAULT NULL,
                                    p_dimension3_id            NUMBER DEFAULT NULL,
                                    --p_audit_flag               varchar2 default null,
                                    --p_report_status            varchar2 default null,
                                    --p_audit_date             date default null,
                                    p_dimension1_id          NUMBER DEFAULT NULL,
                                    p_attachment_num         NUMBER DEFAULT NULL,
                                    p_exceed_budget_strategy VARCHAR2 DEFAULT NULL,
                                    p_dimension10_id         NUMBER DEFAULT NULL,
                                    p_close_date             DATE DEFAULT NULL,
                                    p_close_flag             VARCHAR2 DEFAULT NULL,
                                    p_dimension9_id          NUMBER DEFAULT NULL,
                                    p_dimension6_id          NUMBER DEFAULT NULL,
                                    p_dimension5_id          NUMBER DEFAULT NULL,
                                    p_dimension8_id          NUMBER DEFAULT NULL,
                                    p_dimension7_id          NUMBER DEFAULT NULL,
                                    --p_budget_item_id           number default null,
                                    p_expense_item_id         NUMBER DEFAULT NULL,
                                    p_price                   NUMBER DEFAULT NULL,
                                    p_primary_uom             VARCHAR2 DEFAULT NULL,
                                    p_primary_quantity        NUMBER DEFAULT NULL,
                                    p_period_name             VARCHAR2 DEFAULT NULL,
                                    p_description             VARCHAR2 DEFAULT NULL,
                                    p_exchange_rate_type      VARCHAR2 DEFAULT NULL,
                                    p_expense_type_id         NUMBER DEFAULT NULL,
                                    p_exchange_rate_quotation VARCHAR2 DEFAULT NULL,
                                    p_secondary_quantity      NUMBER DEFAULT NULL,
                                    p_payee_category          VARCHAR2 DEFAULT NULL,
                                    p_employee_id             NUMBER DEFAULT NULL,
                                    p_payee_id                NUMBER DEFAULT NULL,
                                    --p_payment_flag             varchar2 default null,
                                    p_partner_id    NUMBER DEFAULT NULL,
                                    p_company_id    NUMBER DEFAULT NULL,
                                    p_secondary_uom VARCHAR2 DEFAULT NULL,
                                    --p_operation_unit_id        number default null,
                                    p_position_id                 NUMBER DEFAULT NULL,
                                    p_unit_id                     NUMBER DEFAULT NULL,
                                    p_exp_report_dists_id         OUT NUMBER,
                                    p_sale_amount                 NUMBER DEFAULT NULL,
                                    p_tax_amount                  NUMBER DEFAULT NULL,
                                    p_tax_rate                    NUMBER DEFAULT NULL,
                                    p_input_tax_structure_detail  VARCHAR2,
                                    p_deduction_rules             NUMBER,
                                    p_adjusted_full_deductions    NUMBER,
                                    p_adjusted_partial_deductions NUMBER,
                                    p_adjustable_tax_deductible   NUMBER,
                                    p_invoice_amount              NUMBER,
                                    p_invoice_tax_amount          NUMBER,
                                    p_usage_type                  VARCHAR2 DEFAULT NULL) IS
    --v_position_id            exp_report_dists.position_id%type;
    v_operation_unit_id      exp_report_dists.operation_unit_id%TYPE;
    v_budget_item_id         exp_report_dists.budget_item_id%TYPE;
    v_exp_report_dists_id    exp_report_dists.exp_report_dists_id%TYPE;
    v_budget_reserve_line_id NUMBER;
    v_set_of_books_id        NUMBER;
    v_report_amount          NUMBER;
    v_report_func_amount     NUMBER;
  
    /* v_default_flag         exp_expense_policies.default_flag%type;
    v_expense_standard     exp_expense_policies.expense_standard%type;
    v_upper_limit          exp_expense_policies.upper_limit%type;
    v_lower_limit          exp_expense_policies.lower_limit%type;
    v_event_name           exp_expense_policies.event_name%type;
    v_changeable_flag      exp_expense_policies.changeable_flag%type;
    v_commit_flag          exp_expense_policies.commit_flag%type;
    v_city                 exp_report_lines.city%type;
    v_count                number;
    v_expense_policies_id  number;*/
    v_document_id NUMBER;
    /* v_place_type_id        number;
    v_place_id             number;
    v_upper_std_event_name varchar2(100);*/
  
    --v_payee_category exp_report_dists.payee_category%type;
    v_payment_flag  exp_report_dists.payment_flag%TYPE;
    v_audit_flag    exp_report_dists.audit_flag%TYPE;
    v_report_status exp_report_dists.report_status%TYPE;
    v_audit_date    exp_report_dists.audit_date%TYPE;
  BEGIN
    v_document_id := get_document_id(p_exp_report_line_id);
    --非“调整”类型的报销单，金额必须为正
    sign_check(p_exp_report_type_id => get_exp_report_type_id(v_document_id),
               p_number             => p_price,
               p_user_id            => p_created_by);
  
    sign_check(p_exp_report_type_id => get_exp_report_type_id(v_document_id),
               p_number             => p_primary_quantity,
               p_user_id            => p_created_by);
  
    IF update_status_check(v_document_id, p_created_by) = 'Y' THEN
      v_operation_unit_id := exp_requisition_pkg.get_default_operate_unit_id(p_unit_id);
      /* exp_requisition_pkg.get_line_employee_info(p_employee_id     => p_employee_id,
      p_company_id      => p_company_id,
      p_operate_unit_id => v_operation_unit_id,
      p_unit_id         => p_unit_id,
      p_position_id     => v_position_id);*/
    
      --2009.08.06 马超界面上不好传值，直接从行表中取
      SELECT c.report_status, c.payment_flag, c.audit_flag, audit_date
        INTO v_report_status, v_payment_flag, v_audit_flag, v_audit_date
        FROM exp_report_lines c
       WHERE c.exp_report_line_id = p_exp_report_line_id;
    
      --Modify bobo 2010.09.29
      v_budget_item_id := bgt_budget_item_mapping_pkg.get_priority_budget_item_id(p_business_type              => bgt_budget_item_mapping_pkg.c_exp_rpt,
                                                                                  p_company_id                 => p_company_id,
                                                                                  p_company_level_id           => exp_report_common_pkg.get_company_level_id(p_company_id),
                                                                                  p_operation_unit_id          => v_operation_unit_id,
                                                                                  p_document_type_code         => exp_report_common_pkg.get_document_type_code(v_document_id,
                                                                                                                                                               c_exp_report),
                                                                                  p_expense_type_code          => exp_report_common_pkg.get_expense_type_code(p_expense_type_id),
                                                                                  p_exp_item_id                => p_expense_item_id,
                                                                                  p_responsibility_center_code => exp_report_common_pkg.get_resp_center_code(p_responsibility_center_id),
                                                                                  p_account_id                 => NULL,
                                                                                  p_org_unit_level_id          => exp_report_common_pkg.get_org_unit_level_id(p_unit_id),
                                                                                  p_org_unit_code              => exp_report_common_pkg.get_org_unit_code(p_unit_id),
                                                                                  p_position_code              => exp_report_common_pkg.get_position_code(p_position_id),
                                                                                  p_employee_type_id           => exp_report_common_pkg.get_employee_type_id(p_employee_id),
                                                                                  p_employee_levels_id         => exp_report_common_pkg.get_employee_levels_id(p_employee_id),
                                                                                  p_employee_id                => p_employee_id,
                                                                                  p_payee_category             => p_payee_category,
                                                                                  p_payee_id                   => p_payee_id,
                                                                                  p_dimension1_id              => p_dimension1_id,
                                                                                  p_dimension2_id              => p_dimension2_id,
                                                                                  p_dimension3_id              => p_dimension3_id,
                                                                                  p_dimension4_id              => p_dimension4_id,
                                                                                  p_dimension5_id              => p_dimension5_id,
                                                                                  p_dimension6_id              => p_dimension6_id,
                                                                                  p_dimension7_id              => p_dimension7_id,
                                                                                  p_dimension8_id              => p_dimension8_id,
                                                                                  p_dimension9_id              => p_dimension9_id,
                                                                                  p_dimension10_id             => p_dimension10_id);
      IF v_budget_item_id IS NULL THEN
        v_budget_item_id := get_expense_budget_item_id(p_expense_item_id);
      END IF;
    
      v_exp_report_dists_id := get_exp_report_dists_id;
      p_exp_report_dists_id := v_exp_report_dists_id;
    
      v_set_of_books_id    := gld_common_pkg.get_set_of_books_id(p_company_id);
      v_report_amount      := fnd_format_mask_pkg.get_gld_amount(p_currency_code,
                                                                 p_report_amount,
                                                                 v_set_of_books_id);
      v_report_func_amount := fnd_format_mask_pkg.get_gld_amount(p_currency_code,
                                                                 p_report_func_amount,
                                                                 v_set_of_books_id);
    
      INSERT INTO exp_report_dists
        (exp_report_line_id,
         exp_report_dists_id,
         description,
         period_name,
         currency_code,
         exchange_rate_type,
         exchange_rate_quotation,
         exchange_rate,
         expense_type_id,
         expense_item_id,
         budget_item_id,
         price,
         primary_quantity,
         primary_uom,
         secondary_quantity,
         secondary_uom,
         report_amount,
         report_functional_amount,
         company_id,
         operation_unit_id,
         unit_id,
         position_id,
         responsibility_center_id,
         employee_id,
         payee_category,
         payee_id,
         partner_id,
         payment_flag,
         report_status,
         audit_flag,
         audit_date,
         attachment_num,
         dimension1_id,
         dimension2_id,
         dimension3_id,
         dimension4_id,
         dimension5_id,
         dimension6_id,
         dimension7_id,
         dimension8_id,
         dimension9_id,
         dimension10_id,
         exceed_budget_strategy,
         close_flag,
         close_date,
         created_by,
         creation_date,
         last_updated_by,
         last_update_date,
         sale_amount,
         tax_amount,
         tax_rate,
         input_tax_structure_detail,
         deduction_rules,
         adjusted_full_deductions,
         adjusted_partial_deductions,
         adjustable_tax_deductible,
         invoice_amount,
         invoice_tax_amount,
         used_type)
      VALUES
        (p_exp_report_line_id,
         v_exp_report_dists_id,
         p_description,
         p_period_name,
         p_currency_code,
         p_exchange_rate_type,
         p_exchange_rate_quotation,
         p_exchange_rate,
         p_expense_type_id,
         p_expense_item_id,
         v_budget_item_id,
         p_price,
         p_primary_quantity,
         p_primary_uom,
         p_secondary_quantity,
         p_secondary_uom,
         v_report_amount,
         v_report_func_amount,
         p_company_id,
         v_operation_unit_id,
         p_unit_id,
         p_position_id,
         p_responsibility_center_id,
         p_employee_id,
         p_payee_category,
         p_payee_id,
         p_partner_id,
         v_payment_flag,
         v_report_status,
         v_audit_flag,
         v_audit_date,
         p_attachment_num,
         p_dimension1_id,
         p_dimension2_id,
         p_dimension3_id,
         p_dimension4_id,
         p_dimension5_id,
         p_dimension6_id,
         p_dimension7_id,
         p_dimension8_id,
         p_dimension9_id,
         p_dimension10_id,
         p_exceed_budget_strategy,
         p_close_flag,
         p_close_date,
         p_created_by,
         SYSDATE,
         p_created_by,
         SYSDATE,
         fnd_format_mask_pkg.get_gld_amount(p_currency_code,
                                            p_sale_amount,
                                            v_set_of_books_id),
         fnd_format_mask_pkg.get_gld_amount(p_currency_code,
                                            p_tax_amount,
                                            v_set_of_books_id),
         
         p_tax_rate,
         p_input_tax_structure_detail,
         p_deduction_rules,
         p_adjusted_full_deductions,
         p_adjusted_partial_deductions,
         p_adjustable_tax_deductible,
         p_invoice_amount,
         p_invoice_tax_amount,
         p_usage_type);
    
      --保存分配行，触发事件
      exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_DISTS_POST_MODIFY',
                                      p_document_id      => p_exp_report_line_id,
                                      p_document_line_id => v_exp_report_dists_id,
                                      p_source_module    => c_exp_report,
                                      p_event_type       => 'EXP_REPORT_DISTS_POST_MODIFY',
                                      p_user_id          => p_created_by);
    
      --触发事件
      /* get_report_line_city(p_exp_report_line_id => p_exp_report_line_id,
      p_city               => v_city,
      p_place_type_id      => v_place_type_id,
      p_place_id           => v_place_id);*/
    
      /* exp_expense_policies_pkg.get_policy_info(p_company_id           => p_company_id,
                                               p_employee_id          => p_employee_id,
                                               p_expense_item_id      => p_expense_item_id,
                                               p_city                 => v_city,
                                               p_place_type_id        => v_place_type_id,
                                               p_place_id             => v_place_id,
                                               p_currency_code        => p_currency_code,
                                               p_position_id          => p_position_id,
                                               p_rep_date             => get_retpor_date(v_document_id),
                                               p_default_flag         => v_default_flag,
                                               p_expense_standard     => v_expense_standard,
                                               p_upper_limit          => v_upper_limit,
                                               p_lower_limit          => v_lower_limit,
                                               p_event_name           => v_event_name,
                                               p_changeable_flag      => v_changeable_flag,
                                               p_commit_flag          => v_commit_flag,
                                               p_count                => v_count,
                                               p_expense_policies_id  => v_expense_policies_id,
                                               p_upper_std_event_name => v_upper_std_event_name);
      
      if v_commit_flag = 'Y' and
         p_price is not null then
        if (p_price < nvl(v_lower_limit,
                          p_price - 1) or p_price > nvl(v_upper_limit,
                                                         p_price + 1)) then
          begin
            exp_evt_pkg.fire_workflow_event(p_event_name       => v_event_name,
                                            p_document_id      => v_document_id,
                                            p_document_line_id => v_exp_report_dists_id,
                                            p_source_module    => c_exp_report,
                                            p_event_type       => 'EXP_EXPENSE_POLICY',
                                            p_user_id          => p_created_by);
      
          exception
            when others then
              raise e_sub_program_error;
          end;
        end if;
      end if;*/
    
      --为空，暂时不处理保留表，以后可能会修改
      IF v_budget_item_id IS NOT NULL THEN
        IF exp_rpt_reserve_budget_check(v_document_id) = 'Y' THEN
          --“调整”类型的报销单不占预算
          --if get_report_tye_adjustment(get_exp_report_type_id(v_document_id)) = 'N' then
          bgt_budget_reserves_pkg.insert_bgt_budget_reserves(p_reserve_company_id        => p_company_id,
                                                             p_reserve_operation_unit_id => v_operation_unit_id,
                                                             p_bgt_org_id                => bgt_common_pkg.get_bgt_org_id(p_company_id),
                                                             p_period_name               => p_period_name,
                                                             p_business_type             => c_exp_report,
                                                             p_document_id               => v_document_id,
                                                             p_document_line_id          => v_exp_report_dists_id,
                                                             p_currency                  => p_currency_code,
                                                             p_budget_item_id            => v_budget_item_id,
                                                             p_responsibility_center_id  => p_responsibility_center_id,
                                                             p_exchange_rate_type        => p_exchange_rate_type,
                                                             p_exchange_rate_quotation   => p_exchange_rate_quotation,
                                                             p_exchange_rate             => p_exchange_rate,
                                                             p_amount                    => v_report_amount,
                                                             p_functional_amount         => v_report_func_amount,
                                                             /*p_amount                 => p_sale_amount,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               p_functio
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        nal_amount      => p_sale_amount,*/
                                                             p_quantity               => p_primary_quantity,
                                                             p_uom                    => p_primary_uom,
                                                             p_company_id             => p_company_id,
                                                             p_operation_unit_id      => v_operation_unit_id,
                                                             p_unit_id                => p_unit_id,
                                                             p_position_id            => p_position_id,
                                                             p_employee_id            => p_employee_id,
                                                             p_dimension1_id          => p_dimension1_id,
                                                             p_dimension2_id          => p_dimension2_id,
                                                             p_dimension3_id          => p_dimension3_id,
                                                             p_dimension4_id          => p_dimension4_id,
                                                             p_dimension5_id          => p_dimension5_id,
                                                             p_dimension6_id          => p_dimension6_id,
                                                             p_dimension7_id          => p_dimension7_id,
                                                             p_dimension8_id          => p_dimension8_id,
                                                             p_dimension9_id          => p_dimension9_id,
                                                             p_dimension10_id         => p_dimension10_id,
                                                             p_created_by             => p_created_by,
                                                             p_budget_reserve_line_id => v_budget_reserve_line_id,
                                                             p_reserve_flag           => 'U',
                                                             p_status                 => 'N');
          --end if;
        END IF;
      END IF;
    END IF;
  EXCEPTION
    WHEN e_sub_program_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_created_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'insert_exp_report_dists');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_created_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'insert_exp_report_dists');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END insert_exp_report_dists;

  PROCEDURE update_exp_report_dists(p_exp_report_dists_id         NUMBER,
                                    p_description                 VARCHAR2,
                                    p_period_name                 VARCHAR2,
                                    p_price                       NUMBER,
                                    p_primary_quantity            NUMBER,
                                    p_report_amount               NUMBER,
                                    p_rep_functional_amount       NUMBER,
                                    p_company_id                  NUMBER,
                                    p_unit_id                     NUMBER,
                                    p_responsibility_center_id    NUMBER,
                                    p_employee_id                 NUMBER,
                                    p_payee_category              VARCHAR2,
                                    p_payee_id                    NUMBER,
                                    p_dimension1_id               NUMBER,
                                    p_dimension2_id               NUMBER,
                                    p_dimension3_id               NUMBER,
                                    p_dimension4_id               NUMBER,
                                    p_dimension5_id               NUMBER,
                                    p_dimension6_id               NUMBER,
                                    p_dimension7_id               NUMBER,
                                    p_dimension8_id               NUMBER,
                                    p_dimension9_id               NUMBER,
                                    p_dimension10_id              NUMBER,
                                    p_user_id                     NUMBER,
                                    p_position_id                 NUMBER,
                                    p_budget_item_id              NUMBER,
                                    p_expense_item_id             NUMBER,
                                    p_expense_type_id             NUMBER,
                                    p_sale_amount                 NUMBER DEFAULT NULL,
                                    p_tax_amount                  NUMBER DEFAULT NULL,
                                    p_tax_rate                    NUMBER DEFAULT NULL,
                                    p_input_tax_structure_detail  VARCHAR2,
                                    p_deduction_rules             NUMBER,
                                    p_adjusted_full_deductions    NUMBER,
                                    p_adjusted_partial_deductions NUMBER,
                                    p_adjustable_tax_deductible   NUMBER,
                                    p_invoice_amount              NUMBER,
                                    p_invoice_tax_amount          NUMBER,
                                    p_associated_oasign           VARCHAR2,
                                    p_usage_type                  VARCHAR2 DEFAULT NULL) IS
    v_exp_report_header_id NUMBER;
    --v_position_id             exp_report_dists.position_id%type;
    v_operation_unit_id exp_report_dists.operation_unit_id%TYPE;
    --v_budget_item_id          exp_report_dists.budget_item_id%type;
    v_exp_report_line_id      exp_report_dists.exp_report_line_id%TYPE;
    v_currency_code           exp_report_dists.currency_code%TYPE;
    v_exchange_rate_type      exp_report_dists.exchange_rate_type%TYPE;
    v_exchange_rate_quotation exp_report_dists.exchange_rate_quotation%TYPE;
    v_exchange_rate           exp_report_dists.exchange_rate%TYPE;
    v_primary_uom             exp_requisition_dists.primary_uom%TYPE;
    v_release_id              exp_requisition_release.release_id%TYPE;
    v_budget_item_id          exp_report_dists.budget_item_id%TYPE;
  
    v_set_of_books_id    NUMBER;
    v_report_amount      NUMBER;
    v_report_func_amount NUMBER;
  
    /*v_default_flag         exp_expense_policies.default_flag%type;
    v_expense_standard     exp_expense_policies.expense_standard%type;
    v_upper_limit          exp_expense_policies.upper_limit%type;
    v_lower_limit          exp_expense_policies.lower_limit%type;
    v_event_name           exp_expense_policies.event_name%type;
    v_changeable_flag      exp_expense_policies.changeable_flag%type;
    v_commit_flag          exp_expense_policies.commit_flag%type;
    v_upper_std_event_name varchar2(100);
    v_count                number;
    v_expense_policies_id  number;
    v_city                 exp_report_lines.city%type;*/
    -- v_expense_item_id     exp_report_lines.expense_item_id%type;
    v_document_id       NUMBER;
    v_exp_req_header_id NUMBER;
    v_exp_req_dist_id   NUMBER;
    v_exp_tp_header_id  NUMBER;
    v_exp_tp_dist_id    NUMBER;
    --v_expense_type_id     number;
    v_exists                 NUMBER;
    v_budget_reserve_line_id NUMBER;
    /*v_place_type_id          number;
    v_place_id               number;*/
  BEGIN
    SELECT exp_report_line_id,
           currency_code,
           exchange_rate_type,
           exchange_rate_quotation,
           exchange_rate,
           primary_uom
      INTO v_exp_report_line_id,
           v_currency_code,
           v_exchange_rate_type,
           v_exchange_rate_quotation,
           v_exchange_rate,
           v_primary_uom
      FROM exp_report_dists d
     WHERE d.exp_report_dists_id = p_exp_report_dists_id;
  
    SELECT l.exp_report_header_id
      INTO v_exp_report_header_id
      FROM exp_report_lines l
     WHERE l.exp_report_line_id = v_exp_report_line_id;
  
    v_document_id := v_exp_report_header_id;
  
    --非“调整”类型的报销单，金额必须为正
    sign_check(p_exp_report_type_id => get_exp_report_type_id(v_document_id),
               p_number             => p_price,
               p_user_id            => p_user_id);
  
    sign_check(p_exp_report_type_id => get_exp_report_type_id(v_document_id),
               p_number             => p_primary_quantity,
               p_user_id            => p_user_id);
  
    IF update_status_check(v_exp_report_header_id, p_user_id) = 'Y' THEN
      --v_budget_item_id := get_expense_budget_item_id(p_expense_item_id);
    
      v_operation_unit_id := exp_requisition_pkg.get_default_operate_unit_id(p_unit_id);
      /*exp_requisition_pkg.get_line_employee_info(p_employee_id     => p_employee_id,
      p_company_id      => p_company_id,
      p_operate_unit_id => v_operation_unit_id,
      p_unit_id         => p_unit_id,
      p_position_id     => v_position_id);*/
    
      v_set_of_books_id    := gld_common_pkg.get_set_of_books_id(p_company_id);
      v_report_amount      := fnd_format_mask_pkg.get_gld_amount(v_currency_code,
                                                                 p_report_amount,
                                                                 v_set_of_books_id);
      v_report_func_amount := fnd_format_mask_pkg.get_gld_amount(v_currency_code,
                                                                 p_rep_functional_amount,
                                                                 v_set_of_books_id);
    
      --Modify bobo 2010.09.29
      v_budget_item_id := bgt_budget_item_mapping_pkg.get_priority_budget_item_id(p_business_type              => bgt_budget_item_mapping_pkg.c_exp_rpt,
                                                                                  p_company_id                 => p_company_id,
                                                                                  p_company_level_id           => exp_report_common_pkg.get_company_level_id(p_company_id),
                                                                                  p_operation_unit_id          => v_operation_unit_id,
                                                                                  p_document_type_code         => exp_report_common_pkg.get_document_type_code(v_document_id,
                                                                                                                                                               c_exp_report),
                                                                                  p_expense_type_code          => exp_report_common_pkg.get_expense_type_code(p_expense_type_id),
                                                                                  p_exp_item_id                => p_expense_item_id,
                                                                                  p_responsibility_center_code => exp_report_common_pkg.get_resp_center_code(p_responsibility_center_id),
                                                                                  p_account_id                 => NULL,
                                                                                  p_org_unit_level_id          => exp_report_common_pkg.get_org_unit_level_id(p_unit_id),
                                                                                  p_org_unit_code              => exp_report_common_pkg.get_org_unit_code(p_unit_id),
                                                                                  p_position_code              => exp_report_common_pkg.get_position_code(p_position_id),
                                                                                  p_employee_type_id           => exp_report_common_pkg.get_employee_type_id(p_employee_id),
                                                                                  p_employee_levels_id         => exp_report_common_pkg.get_employee_levels_id(p_employee_id),
                                                                                  p_employee_id                => p_employee_id,
                                                                                  p_payee_category             => p_payee_category,
                                                                                  p_payee_id                   => p_payee_id,
                                                                                  p_dimension1_id              => p_dimension1_id,
                                                                                  p_dimension2_id              => p_dimension2_id,
                                                                                  p_dimension3_id              => p_dimension3_id,
                                                                                  p_dimension4_id              => p_dimension4_id,
                                                                                  p_dimension5_id              => p_dimension5_id,
                                                                                  p_dimension6_id              => p_dimension6_id,
                                                                                  p_dimension7_id              => p_dimension7_id,
                                                                                  p_dimension8_id              => p_dimension8_id,
                                                                                  p_dimension9_id              => p_dimension9_id,
                                                                                  p_dimension10_id             => p_dimension10_id);
      IF v_budget_item_id IS NULL THEN
        v_budget_item_id := get_expense_budget_item_id(p_expense_item_id);
      END IF;
    
      UPDATE exp_report_dists d
         SET description              = p_description,
             period_name              = p_period_name,
             price                    = p_price,
             primary_quantity         = p_primary_quantity,
             report_amount            = v_report_amount,
             report_functional_amount = v_report_func_amount,
             
             company_id                    = p_company_id,
             unit_id                       = p_unit_id,
             responsibility_center_id      = p_responsibility_center_id,
             employee_id                   = p_employee_id,
             payee_category                = p_payee_category,
             payee_id                      = p_payee_id,
             dimension1_id                 = p_dimension1_id,
             dimension2_id                 = p_dimension2_id,
             dimension3_id                 = p_dimension3_id,
             dimension4_id                 = p_dimension4_id,
             dimension5_id                 = p_dimension5_id,
             dimension6_id                 = p_dimension6_id,
             dimension7_id                 = p_dimension7_id,
             dimension8_id                 = p_dimension8_id,
             dimension9_id                 = p_dimension9_id,
             dimension10_id                = p_dimension10_id,
             d.last_updated_by             = p_user_id,
             d.last_update_date            = SYSDATE,
             d.operation_unit_id           = v_operation_unit_id,
             d.position_id                 = p_position_id,
             d.budget_item_id              = v_budget_item_id,
             d.expense_item_id             = p_expense_item_id,
             d.expense_type_id             = p_expense_type_id,
             d.sale_amount                 = fnd_format_mask_pkg.get_gld_amount(v_currency_code,
                                                                                p_sale_amount,
                                                                                v_set_of_books_id),
             d.tax_amount                  = fnd_format_mask_pkg.get_gld_amount(v_currency_code,
                                                                                p_tax_amount,
                                                                                v_set_of_books_id),
             d.tax_rate                    = p_tax_rate,
             d.invoice_amount              = p_invoice_amount,
             d.invoice_tax_amount          = p_invoice_tax_amount,
             d.used_type                   = p_usage_type,
             d.input_tax_structure_detail  = p_input_tax_structure_detail,
             d.adjusted_full_deductions    = p_adjusted_full_deductions,
             d.adjusted_partial_deductions = p_adjusted_partial_deductions,
             d.adjustable_tax_deductible   = p_adjustable_tax_deductible,
             d.associated_oasign           = p_associated_oasign,
             d.deduction_rules             = p_deduction_rules
       WHERE d.exp_report_dists_id = p_exp_report_dists_id;
    
      --保存分配行，触发事件
      exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_DISTS_POST_MODIFY',
                                      p_document_id      => v_exp_report_line_id,
                                      p_document_line_id => p_exp_report_dists_id,
                                      p_source_module    => c_exp_report,
                                      p_event_type       => 'EXP_REPORT_DISTS_POST_MODIFY',
                                      p_user_id          => p_user_id);
    
      --触发事件
      /*exp_evt_pkg.delete_workflow_event(p_document_id      => v_document_id,
      p_source_module    => c_exp_report,
      p_event_type       => 'EXP_EXPENSE_POLICY',
      p_user_id          => p_user_id,
      p_document_line_id => p_exp_report_dists_id);*/
      /*get_report_line_city(p_exp_report_line_id => v_exp_report_line_id,
      p_city               => v_city,
      p_place_type_id      => v_place_type_id,
      p_place_id           => v_place_id);*/
    
      /* exp_expense_policies_pkg.get_policy_info(p_company_id           => p_company_id,
      p_employee_id          => p_employee_id,
      p_expense_item_id      => p_expense_item_id,
      p_city                 => v_city,
      p_place_type_id        => v_place_type_id,
      p_place_id             => v_place_id,
      p_currency_code        => v_currency_code,
      p_position_id          => p_position_id,
      p_rep_date             => get_retpor_date(v_document_id),
      p_default_flag         => v_default_flag,
      p_expense_standard     => v_expense_standard,
      p_upper_limit          => v_upper_limit,
      p_lower_limit          => v_lower_limit,
      p_event_name           => v_event_name,
      p_changeable_flag      => v_changeable_flag,
      p_commit_flag          => v_commit_flag,
      p_count                => v_count,
      p_expense_policies_id  => v_expense_policies_id,
      p_upper_std_event_name => v_upper_std_event_name);*/
      --0030716: 费用政策问题 Modify By bobo 删除原先触发的事件
      /* exp_evt_pkg.delete_workflow_event(p_document_id      => v_document_id,
                                        p_source_module    => c_exp_report,
                                        p_event_type       => 'EXP_EXPENSE_POLICY',
                                        p_user_id          => p_user_id,
                                        p_document_line_id => p_exp_report_dists_id);
      
      if v_commit_flag = 'Y' and
         p_price is not null then
        if (p_price < nvl(v_lower_limit,
                          p_price - 1) or p_price > nvl(v_upper_limit,
                                                         p_price + 1)) then
          begin
            exp_evt_pkg.fire_workflow_event(p_event_name       => v_event_name,
                                            p_document_id      => v_document_id,
                                            p_document_line_id => p_exp_report_dists_id,
                                            p_source_module    => c_exp_report,
                                            p_event_type       => 'EXP_EXPENSE_POLICY',
                                            p_user_id          => p_user_id);
      
          exception
            when others then
              raise e_sub_program_error;
          end;
        end if;
      end if;*/
    
      BEGIN
        --只有一行关系，则更新
        SELECT release_id,
               rr.exp_requisition_header_id,
               rr.exp_requisition_dist_id
          INTO v_release_id, v_exp_req_header_id, v_exp_req_dist_id
          FROM exp_requisition_release rr
         WHERE rr.document_type = c_exp_report
           AND rr.document_dist_id = p_exp_report_dists_id;
      
        exp_requisitions_release_pkg.update_exp_requisition_release(p_release_id           => v_release_id,
                                                                    p_doc_release_amount   => v_report_amount,
                                                                    p_doc_release_quantity => p_primary_quantity,
                                                                    p_user_id              => p_user_id,
                                                                    p_report_dist_id       => p_exp_report_dists_id);
      
      EXCEPTION
        WHEN no_data_found OR too_many_rows THEN
          NULL;
      END;
    
      BEGIN
        --更新关联的差旅计划分配行
        --===add by fanqihua
        --===20150723
        SELECT release_id,
               rr.exp_travel_plan_header_id,
               rr.exp_travel_plan_dist_id
          INTO v_release_id, v_exp_tp_header_id, v_exp_tp_dist_id
          FROM exp_travel_plan_release rr
         WHERE rr.document_type = c_exp_report
           AND rr.document_dist_id = p_exp_report_dists_id;
      
        exp_travel_plan_release_pkg.update_exp_tp_release(p_release_id           => v_release_id,
                                                          p_doc_release_amount   => v_report_amount,
                                                          p_doc_release_quantity => p_primary_quantity,
                                                          p_user_id              => p_user_id,
                                                          p_report_dist_id       => p_exp_report_dists_id);
      
      EXCEPTION
        WHEN no_data_found OR too_many_rows THEN
          NULL;
      END;
    
      ----为空，暂时不处理保留表，以后可能会修改
      IF (v_budget_item_id IS NOT NULL AND
         exp_rpt_reserve_budget_check(v_document_id) = 'Y') THEN
        BEGIN
          SELECT 1
            INTO v_exists
            FROM dual
           WHERE EXISTS
           (SELECT 1
                    FROM bgt_budget_reserves r
                   WHERE r.business_type = c_exp_report
                     AND r.document_id = v_document_id
                     AND r.document_line_id = p_exp_report_dists_id);
          --“调整”类型的报销单不占预算
          --if get_report_tye_adjustment(get_exp_report_type_id(v_document_id)) = 'N' then
          bgt_budget_reserves_pkg.update_bgt_budget_reserves(p_business_type             => c_exp_report,
                                                             p_document_id               => v_document_id,
                                                             p_document_line_id          => p_exp_report_dists_id,
                                                             p_reserve_company_id        => p_company_id,
                                                             p_reserve_operation_unit_id => v_operation_unit_id,
                                                             p_bgt_org_id                => bgt_common_pkg.get_bgt_org_id(p_company_id),
                                                             p_period_name               => p_period_name,
                                                             p_currency                  => v_currency_code,
                                                             p_budget_item_id            => v_budget_item_id,
                                                             p_responsibility_center_id  => p_responsibility_center_id,
                                                             p_exchange_rate_type        => v_exchange_rate_type,
                                                             p_exchange_rate_quotation   => v_exchange_rate_quotation,
                                                             p_exchange_rate             => v_exchange_rate,
                                                             --按不含税金额占用预算
                                                             p_amount            => v_report_amount,
                                                             p_functional_amount => v_report_func_amount,
                                                             --p_amount            => p_sale_amount,
                                                             --p_functional_amount => p_sale_amount,
                                                             p_quantity          => p_primary_quantity,
                                                             p_uom               => v_primary_uom,
                                                             p_company_id        => p_company_id,
                                                             p_operation_unit_id => v_operation_unit_id,
                                                             p_unit_id           => p_unit_id,
                                                             p_position_id       => p_position_id,
                                                             p_employee_id       => p_employee_id,
                                                             p_dimension1_id     => p_dimension1_id,
                                                             p_dimension2_id     => p_dimension2_id,
                                                             p_dimension3_id     => p_dimension3_id,
                                                             p_dimension4_id     => p_dimension4_id,
                                                             p_dimension5_id     => p_dimension5_id,
                                                             p_dimension6_id     => p_dimension6_id,
                                                             p_dimension7_id     => p_dimension7_id,
                                                             p_dimension8_id     => p_dimension8_id,
                                                             p_dimension9_id     => p_dimension9_id,
                                                             p_dimension10_id    => p_dimension10_id,
                                                             p_last_updated_by   => p_user_id);
          -- end if;
        
        EXCEPTION
          WHEN no_data_found THEN
            bgt_budget_reserves_pkg.insert_bgt_budget_reserves(p_reserve_company_id        => p_company_id,
                                                               p_reserve_operation_unit_id => v_operation_unit_id,
                                                               p_bgt_org_id                => bgt_common_pkg.get_bgt_org_id(p_company_id),
                                                               p_period_name               => p_period_name,
                                                               p_business_type             => c_exp_report,
                                                               p_document_id               => v_document_id,
                                                               p_document_line_id          => p_exp_report_dists_id,
                                                               p_currency                  => v_currency_code,
                                                               p_budget_item_id            => v_budget_item_id,
                                                               p_responsibility_center_id  => p_responsibility_center_id,
                                                               p_exchange_rate_type        => v_exchange_rate_type,
                                                               p_exchange_rate_quotation   => v_exchange_rate_quotation,
                                                               p_exchange_rate             => v_exchange_rate,
                                                               p_amount                    => v_report_amount,
                                                               p_functional_amount         => v_report_func_amount,
                                                               /*p_amount                 => p_sale_amount,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     p_functional_amount      => p_s
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ale_amount,*/
                                                               p_quantity               => p_primary_quantity,
                                                               p_uom                    => v_primary_uom,
                                                               p_company_id             => p_company_id,
                                                               p_operation_unit_id      => v_operation_unit_id,
                                                               p_unit_id                => p_unit_id,
                                                               p_position_id            => p_position_id,
                                                               p_employee_id            => p_employee_id,
                                                               p_dimension1_id          => p_dimension1_id,
                                                               p_dimension2_id          => p_dimension2_id,
                                                               p_dimension3_id          => p_dimension3_id,
                                                               p_dimension4_id          => p_dimension4_id,
                                                               p_dimension5_id          => p_dimension5_id,
                                                               p_dimension6_id          => p_dimension6_id,
                                                               p_dimension7_id          => p_dimension7_id,
                                                               p_dimension8_id          => p_dimension8_id,
                                                               p_dimension9_id          => p_dimension9_id,
                                                               p_dimension10_id         => p_dimension10_id,
                                                               p_created_by             => p_user_id,
                                                               p_budget_reserve_line_id => v_budget_reserve_line_id,
                                                               p_reserve_flag           => 'U',
                                                               p_status                 => 'N');
        END;
      ELSE
        bgt_budget_reserves_pkg.delete_bgt_budget_reserves(p_business_type    => c_exp_report,
                                                           p_document_id      => v_document_id,
                                                           p_document_line_id => p_exp_report_dists_id,
                                                           p_user_id          => p_user_id);
      END IF;
    
    END IF;
  
  EXCEPTION
    WHEN no_data_found THEN
      NULL;
    WHEN e_sub_program_error THEN
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_requisition_pkg',
                                                     p_procedure_function_name => 'update_exp_report_dists');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    
  END update_exp_report_dists;

  FUNCTION submit_data_check(p_exp_report_header_id NUMBER) RETURN VARCHAR2 IS
  
    /* Remind :
    return Y : means can be delete
    return N : means cannot be delete*/
  
    v_exp_report_header_id exp_report_headers.exp_report_header_id%TYPE;
  BEGIN
    SELECT exp_report_header_id
      INTO v_exp_report_header_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id
       AND h.report_status IN ('GENERATE', 'REJECTED', 'TAKEN_BACK')
       FOR UPDATE NOWAIT;
    RETURN 'Y';
  EXCEPTION
    WHEN OTHERS THEN
      RETURN 'N';
  END submit_data_check;

  --获取分配行总金额
  FUNCTION get_dists_report_amount(p_exp_report_line_id NUMBER) RETURN NUMBER IS
    v_amount NUMBER;
  BEGIN
    SELECT nvl(SUM(d.report_amount), 0)
      INTO v_amount
      FROM exp_report_dists d
     WHERE d.exp_report_line_id = p_exp_report_line_id;
  
    RETURN v_amount;
  END get_dists_report_amount;

  --报销单类型是否必须申请
  FUNCTION get_req_required_flag(p_exp_rep_type_id NUMBER) RETURN VARCHAR2 IS
    v_req_required_flag exp_expense_report_types.req_required_flag%TYPE;
  BEGIN
    SELECT nvl(t.req_required_flag, 'N')
      INTO v_req_required_flag
      FROM exp_expense_report_types t
     WHERE t.expense_report_type_id = p_exp_rep_type_id;
  
    RETURN v_req_required_flag;
  END get_req_required_flag;

  --把预算保留表状态重置回来
  PROCEDURE set_budget_reserves(p_document_id NUMBER, p_user_id NUMBER) IS
    PRAGMA AUTONOMOUS_TRANSACTION;
  
    v_header_id NUMBER;
  BEGIN
    --for mantis:29185  报销单是下面三种状态时，才需要重置bgt_budget_reserves表状态
    --提交时，多次点击《提交》按钮 ，会触发此bug
    SELECT exp_report_header_id
      INTO v_header_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_document_id
       AND h.report_status IN ('GENERATE', 'REJECTED', 'TAKEN_BACK')
       FOR UPDATE;
    UPDATE bgt_budget_reserves t
       SET t.status         = 'N',
           last_update_date = SYSDATE,
           last_updated_by  = p_user_id
     WHERE t.release_id IN
           (SELECT DISTINCT r.release_id
              FROM exp_requisition_release r
             WHERE r.document_type = c_exp_report
               AND r.document_id = p_document_id)
       AND t.business_type = 'EXP_REQUISITION';
  
    UPDATE bgt_budget_reserves t
       SET t.status         = 'N',
           last_update_date = SYSDATE,
           last_updated_by  = p_user_id
     WHERE t.business_type = c_exp_report
       AND t.document_id = p_document_id;
    COMMIT;
  EXCEPTION
    WHEN no_data_found THEN
      NULL;
      ROLLBACK;
  END set_budget_reserves;

  -- 一次性申请单已关闭校验
  FUNCTION exp_requisition_dists_closed(p_exp_requisition_header_id NUMBER)
    RETURN BOOLEAN IS
    v_exists NUMBER;
  BEGIN
    SELECT 1
      INTO v_exists
      FROM dual
     WHERE EXISTS (SELECT 1
              FROM exp_requisition_dists d
             WHERE d.close_flag = 'Y'
               AND d.exp_requisition_line_id IN
                   (SELECT l.exp_requisition_line_id
                      FROM exp_requisition_lines l
                     WHERE l.exp_requisition_header_id =
                           p_exp_requisition_header_id));
    RETURN TRUE;
  EXCEPTION
    WHEN no_data_found THEN
      RETURN FALSE;
  END exp_requisition_dists_closed;

  -- 一次性差旅计划已关闭校验
  FUNCTION exp_tp_dists_closed(p_exp_tp_header_id NUMBER) RETURN BOOLEAN IS
    v_exists NUMBER;
  BEGIN
    SELECT 1
      INTO v_exists
      FROM dual
     WHERE EXISTS
     (SELECT 1
              FROM exp_travel_plan_dists d
             WHERE d.close_flag = 'Y'
               AND d.travel_plan_line_id IN
                   (SELECT l.travel_plan_line_id
                      FROM exp_travel_plan_lines l
                     WHERE l.travel_plan_header_id = p_exp_tp_header_id));
    RETURN TRUE;
  EXCEPTION
    WHEN no_data_found THEN
      RETURN FALSE;
  END exp_tp_dists_closed;

  FUNCTION get_total_exp_relation_amount(p_exp_report_header_id NUMBER,
                                         p_exp_report_dists_id  NUMBER)
    RETURN NUMBER IS
    v_amount NUMBER;
  BEGIN
    SELECT nvl(SUM(doc_release_amount), 0)
      INTO v_amount
      FROM (SELECT r.doc_release_amount
              FROM exp_requisition_release r
             WHERE r.document_type = c_exp_report
               AND r.document_id = p_exp_report_header_id
               AND r.document_dist_id = p_exp_report_dists_id
            UNION
            SELECT r.doc_release_amount
              FROM exp_travel_plan_release r
             WHERE r.document_type = c_exp_report
               AND r.document_id = p_exp_report_header_id
               AND r.document_dist_id = p_exp_report_dists_id);
    RETURN v_amount;
  END get_total_exp_relation_amount;

  --若关联申请单，则需要处理是否是一次性申请单、是否必须申请、关联金额校验
  PROCEDURE set_requisition_relation(p_exp_report_header_id NUMBER,
                                     p_exp_report_type_id   NUMBER,
                                     p_user_id              NUMBER) IS
    v_requisition_header_id   NUMBER;
    v_tp_header_id            NUMBER;
    v_exp_requisition_type_id NUMBER;
    v_exp_tp_type_id          NUMBER;
    v_exp_dist_id             NUMBER;
    v_dist_amount             NUMBER;
    v_total_relation_amount   NUMBER;
    v_error_flag              VARCHAR2(1) := 'N';
    v_header_id               NUMBER;
    v_doc_type                VARCHAR2(20);
  
    CURSOR cur_req_headers IS
      SELECT DISTINCT r.exp_requisition_header_id, 'EXP_REQ' doc_type
        FROM exp_requisition_release r
       WHERE r.document_type = c_exp_report
         AND r.document_id = p_exp_report_header_id
      UNION
      SELECT DISTINCT er.exp_travel_plan_header_id, 'EXP_TP' doc_type
        FROM exp_travel_plan_release er
       WHERE er.document_type = c_exp_report
         AND er.document_id = p_exp_report_header_id;
  
    CURSOR cur_report_dists IS
      SELECT a.exp_report_dists_id, a.report_amount
        FROM exp_report_dists a
       WHERE a.exp_report_line_id IN
             (SELECT b.exp_report_line_id
                FROM exp_report_lines b
               WHERE b.exp_report_header_id = p_exp_report_header_id)
         AND EXISTS
       (SELECT 1
                FROM exp_requisition_release c
               WHERE c.document_type = c_exp_report
                 AND c.document_id = p_exp_report_header_id
                 AND c.document_dist_id = a.exp_report_dists_id
              UNION
              SELECT 1
                FROM exp_travel_plan_release c
               WHERE c.document_type = c_exp_report
                 AND c.document_id = p_exp_report_header_id
                 AND c.document_dist_id = a.exp_report_dists_id);
  
    e_exp_requisition_closed    EXCEPTION;
    e_exp_relation_amount_error EXCEPTION;
  BEGIN
    --若必须关联申请，则每个分配行必须都关联申请
    IF get_req_required_flag(p_exp_report_type_id) = 'Y' THEN
      FOR v_dists IN (SELECT a.exp_report_dists_id
                        FROM exp_report_dists a
                       WHERE a.exp_report_line_id IN
                             (SELECT b.exp_report_line_id
                                FROM exp_report_lines b
                               WHERE b.exp_report_header_id =
                                     p_exp_report_header_id
                                 AND b.exp_report_line_id NOT IN
                                     (SELECT etl.exp_report_line_id
                                        FROM exp_report_travel_lines etl
                                       WHERE etl.exp_report_line_id =
                                             b.exp_report_line_id
                                         AND etl.travel_plan_line_id IS NOT NULL))) LOOP
        BEGIN
          SELECT *
            INTO v_requisition_header_id
            FROM (SELECT r.exp_requisition_header_id header_id
                    FROM exp_requisition_release r
                   WHERE r.document_type = c_exp_report
                     AND r.document_id = p_exp_report_header_id
                     AND r.document_dist_id = v_dists.exp_report_dists_id
                  UNION
                  SELECT r.exp_travel_plan_header_id header_id
                    FROM exp_travel_plan_release r
                   WHERE r.document_type = c_exp_report
                     AND r.document_id = p_exp_report_header_id
                     AND r.document_dist_id = v_dists.exp_report_dists_id)
           WHERE rownum = 1;
        EXCEPTION
          WHEN no_data_found THEN
            v_error_flag := 'Y';
            EXIT;
        END;
      END LOOP;
    
      IF v_error_flag = 'Y' THEN
        sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_REQ_RELATION_NULL',
                                                        p_created_by              => p_user_id,
                                                        p_package_name            => 'exp_report_pkg',
                                                        p_procedure_function_name => 'set_requisition_relation');
        raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                sys_raise_app_error_pkg.g_err_line_id);
      END IF;
    END IF;
  
    OPEN cur_req_headers;
    LOOP
      FETCH cur_req_headers
        INTO v_header_id, v_doc_type;
      EXIT WHEN cur_req_headers%NOTFOUND;
    
      IF v_doc_type = 'EXP_TP' THEN
        --锁表
        SELECT qh.travel_plan_header_id
          INTO v_tp_header_id
          FROM exp_travel_plan_headers qh
         WHERE qh.travel_plan_header_id = v_header_id
           FOR UPDATE NOWAIT;
      
        --判断是否一次性申请单
        SELECT eh.travel_plan_type_id
          INTO v_exp_tp_type_id
          FROM exp_travel_plan_headers eh
         WHERE eh.travel_plan_header_id = v_header_id;
      
        --校验对应申请单是否已关闭
        IF exp_tp_dists_closed(v_tp_header_id) THEN
        
          --申请单已被关闭，调整保留额
          exp_travel_plan_release_pkg.closed_exp_tp_bgt_reserve_adj(p_exp_tp_header_id => v_tp_header_id,
                                                                    p_user_id          => p_user_id);
        ELSE
          IF exp_travel_plan_release_pkg.get_tp_types_one_off_flag(v_exp_tp_type_id) = 'Y' THEN
            --一次性申请单，整单关闭
            exp_travel_plan_release_pkg.close_one_off_exp_tp(p_exp_tp_header_id => v_tp_header_id,
                                                             p_user_id          => p_user_id,
                                                             p_source_type      => 'TP_CLOSE');
          END IF;
        END IF;
      ELSE
      
        --锁表
        SELECT qh.exp_requisition_header_id
          INTO v_requisition_header_id
          FROM exp_requisition_headers qh
         WHERE qh.exp_requisition_header_id = v_header_id
           FOR UPDATE NOWAIT;
      
        --判断是否一次性申请单
        v_exp_requisition_type_id := exp_requisition_pkg.get_exp_requisition_type_id(v_requisition_header_id);
      
        --校验对应申请单是否已关闭
        IF exp_requisition_dists_closed(v_requisition_header_id) THEN
        
          --申请单已被关闭，调整保留额
          exp_requisitions_release_pkg.closed_exp_req_bgt_reserve_adj(p_exp_req_header_id => v_requisition_header_id,
                                                                      p_user_id           => p_user_id);
        ELSE
          IF exp_requisitions_release_pkg.get_req_types_one_off_flag(v_exp_requisition_type_id) = 'Y' THEN
            --一次性申请单，整单关闭
            exp_requisitions_release_pkg.close_one_off_exp_requisition(p_exp_req_header_id => v_requisition_header_id,
                                                                       p_user_id           => p_user_id,
                                                                       p_source_type       => 'REQ_CLOSE');
          END IF;
        END IF;
      
      END IF;
    END LOOP;
    CLOSE cur_req_headers;
  
    --sum(关联金额) = 分配行金额
    OPEN cur_report_dists;
    LOOP
      FETCH cur_report_dists
        INTO v_exp_dist_id, v_dist_amount;
      EXIT WHEN cur_report_dists%NOTFOUND;
      v_total_relation_amount := get_total_exp_relation_amount(p_exp_report_header_id => p_exp_report_header_id,
                                                               p_exp_report_dists_id  => v_exp_dist_id);
      IF v_total_relation_amount <> v_dist_amount THEN
        CLOSE cur_report_dists;
        RAISE e_exp_relation_amount_error;
      END IF;
    END LOOP;
    CLOSE cur_report_dists;
  
  EXCEPTION
    WHEN e_lock_table THEN
      IF cur_req_headers%ISOPEN THEN
        CLOSE cur_req_headers;
      END IF;
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_LOCK_RELATION_REQUISITION_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'set_requisition_relation');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_exp_requisition_closed THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_RELATION_REQUISITION_CLOSED',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'set_requisition_relation');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_exp_relation_amount_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_RELATION_AMOUNT_UNBALANCE',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'set_requisition_relation');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END set_requisition_relation;

  PROCEDURE report_pmt_schedules_check(p_exp_report_header_id NUMBER,
                                       p_user_id              NUMBER) IS
    v_contract_header_id NUMBER;
    v_exists             NUMBER;
  
    e_payee_category_check_error EXCEPTION;
    v_count NUMBER;
  BEGIN
  
    -- 不能存在多个供应商
    --建信需求，不校验 lqy-2018-5-30
  
    /*SELECT COUNT(1)
      INTO v_count
      FROM (SELECT erps.payee_id
              FROM exp_report_pmt_schedules erps
             WHERE erps.exp_report_header_id = p_exp_report_header_id
               AND erps.payee_category = 'VENDER'
             GROUP BY erps.payee_id);
    
    IF (v_count > 1) THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '计划付款行不能存在多个供应商',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'report_pmt_schedules_check');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    END IF;*/
  
    select h.contract_header_id
      into v_contract_header_id
      from exp_report_headers h
     where h.exp_report_header_id = p_exp_report_header_id;
  
    if v_contract_header_id is null then
      return;
    end if;
  
    /* BEGIN
      SELECT f.document_id
        INTO v_contract_header_id
        FROM con_document_flows f
       WHERE f.document_type = 'CON_CONTRACT_HEADERS'
         AND f.source_document_type = 'EXP_REPORT_HEADERS'
         AND f.source_document_id = p_exp_report_header_id;
    EXCEPTION
      WHEN no_data_found THEN
        RETURN;
    END;
    
    BEGIN
      SELECT 1
        INTO v_exists
        FROM dual
       WHERE EXISTS
       (SELECT *
                FROM exp_report_pmt_schedules p
               WHERE p.exp_report_header_id = p_exp_report_header_id
                 AND EXISTS
               (SELECT l.partner_category
                        FROM con_contract_partner_lines l
                       WHERE l.contract_header_id = v_contract_header_id
                         AND p.payee_category <> l.partner_category
                         AND p.payee_id <> l.partner_id));
    
      RAISE e_payee_category_check_error;
    EXCEPTION
      WHEN no_data_found THEN
        NULL;
    END;*/
  
    --报销单的收款方必须与合同资金计划行的收款方一致
    select count(*)
      into v_exists
      from con_payment_schedules cps, exp_report_pmt_schedules erp
     where erp.exp_report_header_id = p_exp_report_header_id
       and erp.payee_category != cps.partner_category
       and erp.payee_id != cps.partner_id
       and cps.contract_header_id = v_contract_header_id;
    if v_exists > 0 then
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '报销单的收款方必须与合同资金计划行的收款方一致!',
                                                     p_created_by              => -1,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'report_pmt_schedules_check');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    end if;
  
    -- 如果合同有受益期，则一定要分配才能提交
    select count(*)
      into v_exists
      from con_contract_return_periods t
     where t.contract_header_id = v_contract_header_id;
    if v_exists > 0 then
      -- 校验要分配
      select count(*)
        into v_exists
        from cux_exp_report_line_periods r
       where r.exp_report_header_id = p_exp_report_header_id;
      if v_exists = 0 then
        sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '请先分配受益期!',
                                                       p_created_by              => -1,
                                                       p_package_name            => 'exp_report_pkg',
                                                       p_procedure_function_name => 'report_pmt_schedules_check');
        raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                sys_raise_app_error_pkg.g_err_line_id);
      end if;
    end if;
  
  EXCEPTION
    WHEN e_payee_category_check_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_PMT_SCHEDULE_PAYEE_CATEGORY_ERR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'report_pmt_schedules_check');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END report_pmt_schedules_check;

  --校验申请行[申请金额]是否= SUM（对应分配行[申请金额]）
  FUNCTION exp_report_amt_balance_check(p_exp_report_header_id NUMBER,
                                        p_user_id              NUMBER)
    RETURN NUMBER IS
  
    v_report_amount               NUMBER;
    v_dists_amount                NUMBER;
    v_vat_special_invoice_include VARCHAR2(10);
    v_tax_amount                  NUMBER;
    v_sale_amount                 NUMBER;
  BEGIN
    SELECT nvl(t.vat_special_invoice_include, 'N')
      INTO v_vat_special_invoice_include
      FROM exp_report_headers t
     WHERE t.exp_report_header_id = p_exp_report_header_id;
    FOR exp_lines IN (SELECT l.exp_report_line_id,
                             l.line_number,
                             report_amount,
                             l.tax_amount,
                             l.sale_amount -- update by robin 2016-04-14 营改增更改
                        FROM exp_report_lines l
                       WHERE l.exp_report_header_id = p_exp_report_header_id) LOOP
    
      SELECT nvl(SUM(d.report_amount), 0),
             nvl(SUM(d.tax_amount), 0),
             nvl(SUM(d.sale_amount), 0)
        INTO v_dists_amount, v_tax_amount, v_sale_amount
        FROM exp_report_dists d
       WHERE d.exp_report_line_id = exp_lines.exp_report_line_id;
      IF (exp_lines.report_amount - v_dists_amount <> 0) THEN
        sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_LINES_REPORT_AMOUNT_ERROR',
                                                        p_created_by              => p_user_id,
                                                        p_token_1                 => '#LINE_NUM',
                                                        p_token_value_1           => exp_lines.line_number,
                                                        p_package_name            => 'exp_report_pkg',
                                                        p_procedure_function_name => 'exp_report_amt_balance_check');
        raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                sys_raise_app_error_pkg.g_err_line_id);
      END IF;
    
      IF v_vat_special_invoice_include = 'Y' THEN
        IF (exp_lines.tax_amount - v_tax_amount <> 0) OR
           (exp_lines.sale_amount - v_sale_amount <> 0) THEN
        
          sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_LINES_REPORT_AMOUNT_ERROR',
                                                          p_created_by              => p_user_id,
                                                          p_token_1                 => '#LINE_NUM',
                                                          p_token_value_1           => exp_lines.line_number,
                                                          p_package_name            => 'exp_report_pkg',
                                                          p_procedure_function_name => 'exp_report_amt_balance_check');
          raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                  sys_raise_app_error_pkg.g_err_line_id);
        END IF;
      END IF;
    END LOOP;
  
    SELECT SUM(l.report_amount)
      INTO v_report_amount
      FROM exp_report_lines l
     WHERE l.exp_report_header_id = p_exp_report_header_id;
  
    RETURN v_report_amount;
  
  END exp_report_amt_balance_check;

  --add wgf 2012/12/26 校验报销单行和计划付款行的金额
  PROCEDURE report_pmt_amount_check(p_exp_report_header_id NUMBER,
                                    p_user_id              NUMBER) IS
    v_line_amount     NUMBER;
    v_schedule_amount NUMBER;
  
    e_contract_total_amount_error EXCEPTION;
  
    CURSOR cur_rec IS
      SELECT cdf.document_id,
             cdf.document_line_id,
             SUM(erl.report_amount) rep_amount
        FROM con_document_flows cdf, exp_report_lines erl
       WHERE erl.exp_report_header_id = p_exp_report_header_id
         AND erl.exp_report_header_id = cdf.source_document_id(+)
         AND erl.exp_report_line_id = cdf.source_document_line_id(+)
         AND cdf.document_type(+) = 'CON_CONTRACT'
         AND cdf.source_document_type(+) = 'EXP_REPORT_LINES'
       GROUP BY cdf.document_id, cdf.document_line_id;
  
  BEGIN
  
    FOR l_rec IN cur_rec LOOP
      BEGIN
        SELECT SUM(nvl(erps.due_amount, 0))
          INTO v_schedule_amount
          FROM con_document_flows cdf, exp_report_pmt_schedules erps
         WHERE erps.exp_report_header_id = p_exp_report_header_id
           AND erps.exp_report_header_id = cdf.source_document_id(+)
           AND erps.payment_schedule_line_id =
               cdf.source_document_line_id(+)
           AND cdf.document_type(+) = 'CON_CONTRACT'
           AND cdf.source_document_type(+) = 'EXP_REPORT_PMT_SCHEDULES'
           AND nvl(cdf.document_id, -999) = nvl(l_rec.document_id, -999)
           AND nvl(cdf.document_line_id, -999) =
               nvl(l_rec.document_line_id, -999);
      EXCEPTION
        WHEN OTHERS THEN
          v_schedule_amount := 0;
      END;
      IF l_rec.rep_amount <> v_schedule_amount THEN
        RAISE e_contract_total_amount_error;
      END IF;
    
    END LOOP;
  
  EXCEPTION
    WHEN e_contract_total_amount_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_PMT_CONTRACT_TOTAL_AMOUNT_ERR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'report_pmt_amount_check');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => SQLERRM,
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'report_pmt_amount_check');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END report_pmt_amount_check;

  --提交时 资金计划行校验
  PROCEDURE submit_rep_pmt_schedules_check(p_exp_report_header_id NUMBER,
                                           p_user_id              NUMBER,
                                           p_company_id           NUMBER) IS
    v_csh_unwrite_off_amt NUMBER; --预付款未核销金额
    v_rep_unwrite_off_amt NUMBER; --报销单的未核销金额
    v_error_flag          VARCHAR2(1);
    v_due_amount          NUMBER;
    v_write_off_amount    NUMBER;
    v_line_number         NUMBER;
  BEGIN
    --报销单必须核销全部借款
    IF sys_parameter_pkg.value('EXP_REPORT_COMPLETELY_WRITE_OFF',
                               '',
                               '',
                               p_company_id) = 'Y' THEN
      SELECT SUM(p.due_amount -
                 exp_report_pkg.get_rep_pmt_tot_write_off_amt(p.exp_report_header_id,
                                                              p.payment_schedule_line_id))
        INTO v_rep_unwrite_off_amt
        FROM exp_report_pmt_schedules p
       WHERE p.exp_report_header_id = p_exp_report_header_id;
    
      IF v_rep_unwrite_off_amt > 0 THEN
        SELECT SUM(l.transaction_amount -
                   (SELECT nvl(SUM(cwo.document_write_off_amount), 0)
                      FROM csh_write_off cwo
                     WHERE cwo.write_off_type = 'PREPAYMENT_EXPENSE_REPORT'
                       AND cwo.csh_transaction_line_id =
                           l.transaction_line_id
                       AND cwo.source_csh_trx_line_id IS NULL))
          INTO v_csh_unwrite_off_amt
          FROM csh_transaction_headers  h,
               csh_transaction_lines    l,
               exp_report_pmt_schedules p
         WHERE h.transaction_type = 'PREPAYMENT'
           AND h.transaction_header_id = l.transaction_header_id
           AND h.returned_flag <> 'C'
           AND h.reversed_flag IS NULL
           AND h.write_off_flag <> 'C'
           AND h.enabled_write_off_flag = 'Y'
           AND p.payee_category = l.partner_category
           AND p.payee_id = l.partner_id
           AND p.currency = l.currency_code
           AND p.company_id = h.company_id
           AND p.exp_report_header_id = p_exp_report_header_id
           AND p.due_amount -
               exp_report_pkg.get_rep_pmt_tot_write_off_amt(p.exp_report_header_id,
                                                            p.payment_schedule_line_id) > 0
              
              --若报销单计划付款行或者现金事务行存在合同，则合同信息必须一致
           AND (((exp_report_pkg.rep_pmt_contract_exists(p.payment_schedule_line_id) = 0 OR
               exp_report_pkg.csh_trx_contract_exists(l.transaction_line_id) = 0) AND
               EXISTS
                (SELECT 1
                    FROM con_cash_trx_pmt_schedule_lns cl,
                         con_document_flows            d
                   WHERE 1 = 1
                     AND cl.csh_transaction_line_id = l.transaction_line_id
                     AND d.document_type = 'CON_CONTRACT'
                     AND d.source_document_type = 'EXP_REPORT_PMT_SCHEDULES'
                     AND d.source_document_id = p.exp_report_header_id
                     AND d.source_document_line_id =
                         p.payment_schedule_line_id
                     AND (d.document_id = cl.contract_header_id)
                     AND (d.document_line_id = cl.payment_schedule_line_id OR
                         (d.document_line_id IS NULL AND
                         cl.payment_schedule_line_id IS NULL)))) OR
               (exp_report_pkg.rep_pmt_contract_exists(p.payment_schedule_line_id) = -1 AND
               exp_report_pkg.csh_trx_contract_exists(l.transaction_line_id) = -1));
      
        IF v_csh_unwrite_off_amt > 0 THEN
          sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_CSH_WRITE_OFF_ASK',
                                                          p_created_by              => p_user_id,
                                                          p_package_name            => 'exp_report_pkg',
                                                          p_procedure_function_name => 'submit_rep_pmt_schedules_check');
          raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                  sys_raise_app_error_pkg.g_err_line_id);
        END IF;
      END IF;
    END IF;
  
    --已核销借款金额是否>计划付款行到期金额
    v_error_flag := 'N';
    FOR cur_pmt IN (SELECT l.due_amount,
                           l.payment_schedule_line_id pmt_line_id,
                           l.payment_schedule_line_id
                      FROM exp_report_pmt_schedules l
                     WHERE l.exp_report_header_id = p_exp_report_header_id) LOOP
      v_line_number      := cur_pmt.payment_schedule_line_id;
      v_due_amount       := cur_pmt.due_amount;
      v_write_off_amount := exp_report_pkg.get_rep_pmt_tot_write_off_amt(p_exp_report_header_id,
                                                                         cur_pmt.pmt_line_id);
      IF v_due_amount - v_write_off_amount < 0 THEN
        v_error_flag := 'Y';
        EXIT;
      END IF;
    END LOOP;
  
    IF v_error_flag = 'Y' THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_PMT_WRITE_OFF_AMT_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_token_1                 => '#LINE_NUM',
                                                      p_token_value_1           => v_line_number,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'submit_rep_pmt_schedules_check');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    END IF;
  
  END submit_rep_pmt_schedules_check;

  FUNCTION get_dim_code_id(p_dim_value_id NUMBER, p_dim_desc OUT VARCHAR2)
    RETURN NUMBER IS
    v_dimension_id NUMBER;
  BEGIN
    SELECT v.dimension_id
      INTO v_dimension_id
      FROM fnd_dimension_values v
     WHERE v.dimension_value_id = p_dim_value_id;
  
    SELECT d.description
      INTO p_dim_desc
      FROM fnd_dimensions_vl d
     WHERE d.dimension_id = v_dimension_id;
  
    RETURN v_dimension_id;
  EXCEPTION
    WHEN no_data_found THEN
      RETURN NULL;
  END get_dim_code_id;

  --提交时 校验维度控制
  PROCEDURE exp_dim_matching_control_check(p_exp_report_header_id NUMBER,
                                           p_user_id              NUMBER) IS
    CURSOR cur_dists IS
      SELECT a.exp_report_dists_id,
             dimension1_id,
             dimension2_id,
             dimension3_id,
             dimension4_id,
             dimension5_id,
             dimension6_id,
             dimension7_id,
             dimension8_id,
             dimension9_id,
             dimension10_id,
             a.company_id
        FROM exp_report_dists a
       WHERE a.exp_report_line_id IN
             (SELECT b.exp_report_line_id
                FROM exp_report_lines b
               WHERE b.exp_report_header_id = p_exp_report_header_id);
    v_dist cur_dists%ROWTYPE;
  
    CURSOR cur_req_dists(p_rpt_dist_id NUMBER) IS
      SELECT dimension1_id,
             dimension2_id,
             dimension3_id,
             dimension4_id,
             dimension5_id,
             dimension6_id,
             dimension7_id,
             dimension8_id,
             dimension9_id,
             dimension10_id,
             rd.company_id
        FROM exp_requisition_dists rd, exp_requisition_release r
       WHERE r.exp_requisition_dist_id = rd.exp_requisition_dists_id
         AND r.exp_requisition_line_id = rd.exp_requisition_line_id
         AND r.document_type = 'EXP_REPORT'
         AND r.document_dist_id = p_rpt_dist_id
         AND r.document_id = p_exp_report_header_id;
    v_req_dists cur_req_dists%ROWTYPE;
  
    v_exists NUMBER;
    TYPE dim_number IS TABLE OF NUMBER INDEX BY BINARY_INTEGER;
    v_exp_rpt_dim dim_number;
    v_exp_req_dim dim_number;
    v_dim_code_id NUMBER;
    v_dim_desc    VARCHAR2(1000);
  BEGIN
    OPEN cur_dists;
    LOOP
      FETCH cur_dists
        INTO v_dist;
      EXIT WHEN cur_dists%NOTFOUND;
      v_exp_rpt_dim(1) := v_dist.dimension1_id;
      v_exp_rpt_dim(2) := v_dist.dimension2_id;
      v_exp_rpt_dim(3) := v_dist.dimension3_id;
      v_exp_rpt_dim(4) := v_dist.dimension4_id;
      v_exp_rpt_dim(5) := v_dist.dimension5_id;
      v_exp_rpt_dim(6) := v_dist.dimension6_id;
      v_exp_rpt_dim(7) := v_dist.dimension7_id;
      v_exp_rpt_dim(8) := v_dist.dimension8_id;
      v_exp_rpt_dim(9) := v_dist.dimension9_id;
      v_exp_rpt_dim(10) := v_dist.dimension10_id;
    
      FOR i IN 1 .. 10 LOOP
        IF v_exp_rpt_dim(i) IS NOT NULL THEN
          BEGIN
            v_dim_code_id := get_dim_code_id(p_dim_value_id => v_exp_rpt_dim(i),
                                             p_dim_desc     => v_dim_desc);
            SELECT 1
              INTO v_exists
              FROM dual
             WHERE EXISTS (SELECT *
                      FROM exp_dim_matching_controls t
                     WHERE t.set_of_books_id =
                           gld_common_pkg.get_set_of_books_id(v_dist.company_id)
                       AND t.dimension_id = v_dim_code_id
                       AND t.control_flag = 'Y');
          
            --启用维度控制，去找对应的申请单分配行
            OPEN cur_req_dists(v_dist.exp_report_dists_id);
            LOOP
              FETCH cur_req_dists
                INTO v_req_dists;
              EXIT WHEN cur_req_dists%NOTFOUND;
              v_exp_req_dim(1) := v_req_dists.dimension1_id;
              v_exp_req_dim(2) := v_req_dists.dimension2_id;
              v_exp_req_dim(3) := v_req_dists.dimension3_id;
              v_exp_req_dim(4) := v_req_dists.dimension4_id;
              v_exp_req_dim(5) := v_req_dists.dimension5_id;
              v_exp_req_dim(6) := v_req_dists.dimension6_id;
              v_exp_req_dim(7) := v_req_dists.dimension7_id;
              v_exp_req_dim(8) := v_req_dists.dimension8_id;
              v_exp_req_dim(9) := v_req_dists.dimension9_id;
              v_exp_req_dim(10) := v_req_dists.dimension10_id;
            
              --考虑下为空
              IF v_exp_rpt_dim(i) <> nvl(v_exp_req_dim(i), -0.1) THEN
                CLOSE cur_req_dists;
                CLOSE cur_dists;
                sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_DIMENSION_CONTROL',
                                                                p_created_by              => p_user_id,
                                                                p_token_1                 => '#NUM',
                                                                p_token_value_1           => v_dim_desc,
                                                                p_package_name            => 'exp_report_pkg',
                                                                p_procedure_function_name => 'exp_dim_matching_control_check');
                raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                        sys_raise_app_error_pkg.g_err_line_id);
              END IF;
            
            END LOOP;
            CLOSE cur_req_dists;
          EXCEPTION
            WHEN no_data_found THEN
              NULL;
          END;
        END IF;
      END LOOP;
    
    END LOOP;
    CLOSE cur_dists;
  END exp_dim_matching_control_check;

  -- 检查创建的费用报销单与引用的费用申请单“报销类型”是否一致
  FUNCTION submit_rep_req_exp_type_same(p_exp_report_header_id NUMBER)
    RETURN BOOLEAN IS
  BEGIN
    FOR v_report_lines IN (SELECT rl.expense_type_id  rep_exp_type_id,
                                  erl.expense_type_id req_exp_type_id
                             FROM exp_report_lines        rl,
                                  exp_requisition_release rr,
                                  exp_requisition_lines   erl
                            WHERE rl.exp_report_header_id =
                                  p_exp_report_header_id
                              AND rr.document_type = 'EXP_REPORT'
                              AND rr.document_id = rl.exp_report_header_id
                              AND rr.document_line_id =
                                  rl.exp_report_line_id
                              AND rr.exp_requisition_line_id =
                                  erl.exp_requisition_line_id) LOOP
      IF v_report_lines.rep_exp_type_id <> v_report_lines.req_exp_type_id THEN
        RETURN FALSE;
      END IF;
    END LOOP;
  
    RETURN TRUE;
  END submit_rep_req_exp_type_same;

  -- 检查创建的费用报销单分配行与引用的费用申请单分配行“公司”是否一致
  FUNCTION submit_rep_req_company_same(p_exp_report_header_id NUMBER)
    RETURN BOOLEAN IS
  BEGIN
    FOR v_report_lines IN (SELECT rd.company_id  rep_company_id,
                                  erd.company_id req_company_id
                             FROM exp_report_lines        rl,
                                  exp_requisition_release rr,
                                  exp_report_dists        rd,
                                  exp_requisition_dists   erd
                            WHERE rl.exp_report_header_id =
                                  p_exp_report_header_id
                              AND rr.document_type = 'EXP_REPORT'
                              AND rr.document_id = rl.exp_report_header_id
                              AND rr.document_line_id =
                                  rl.exp_report_line_id
                              AND rr.exp_requisition_dist_id =
                                  erd.exp_requisition_dists_id
                              AND rr.document_dist_id =
                                  rd.exp_report_dists_id) LOOP
      IF v_report_lines.rep_company_id <> v_report_lines.req_company_id THEN
        RETURN FALSE;
      END IF;
    END LOOP;
  
    RETURN TRUE;
  END submit_rep_req_company_same;

  /*************************************************
  -- Author  : Qu yuanyuan
  -- Created : 2015/1/25 20:56:06
  -- Ver     : 1.1
  -- Purpose : 月底限制提交报销单校验
  **************************************************/
  PROCEDURE validate_submit_exp_rpt IS
    v_date_num  NUMBER;
    v_last_date DATE;
  
    e_is_submit_exp_rpt_error EXCEPTION;
  BEGIN
    SELECT nvl(sys_parameter_pkg.value('IS_EXP_RPT_SUBMIT'), 0)
      INTO v_date_num
      FROM dual;
    SELECT last_day(SYSDATE) INTO v_last_date FROM dual;
    IF v_last_date - SYSDATE < v_date_num THEN
      RAISE e_is_submit_exp_rpt_error;
    END IF;
  EXCEPTION
    WHEN e_is_submit_exp_rpt_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '月底关闭期间,不允许提交报销单!',
                                                     p_created_by              => -1,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'validate_submit_exp_rpt');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END validate_submit_exp_rpt;

  /*************************************************
  -- Author  : Rick
  -- Created : 2017-5-5 16:51:44
  -- Ver     : 1.1
  -- Purpose : 校验发票号码、发票代码重复校验
  **************************************************/
  PROCEDURE validate_invoice_number(p_exp_report_header_id NUMBER,
                                    p_user_id              NUMBER) IS
    v_count NUMBER;
  BEGIN
  
    FOR c1 IN (SELECT l.*
                 FROM exp_report_lines l, exp_ygz_invoice_types tp
                WHERE l.exp_report_header_id = p_exp_report_header_id
                  AND tp.type_code = l.invoice_type) LOOP
      FOR c2 IN (SELECT c2h.exp_report_number, c2l.line_number
                   FROM exp_report_headers c2h, exp_report_lines c2l
                  WHERE c2h.exp_report_header_id = c2l.exp_report_header_id
                    AND c2h.report_status IN
                        ('COMPLETELY_APPROVED', 'SUBMITTED')
                    AND c2l.invoice_number = c1.invoice_number
                    AND c2l.invoice_code = c1.invoice_code
                    AND nvl(c2h.reversed_flag, '-') <> 'W') LOOP
        sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '存在相同的发票代码和发票号码【' ||
                                                                                    c2.exp_report_number || '-' ||
                                                                                    c2.line_number || '】',
                                                       p_created_by              => p_user_id,
                                                       p_package_name            => 'exp_report_pkg',
                                                       p_procedure_function_name => 'validate_invoice_number');
        raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                sys_raise_app_error_pkg.g_err_line_id);
      END LOOP;
    END LOOP;
  
    --发票号码,发票代码相同,发票金额也必须一致
    FOR c_invoice IN (SELECT l.invoice_code, l.invoice_number
                        FROM exp_report_lines l
                       WHERE l.exp_report_header_id = p_exp_report_header_id
                         AND EXISTS
                       (SELECT 1
                                FROM exp_report_lines l1
                               WHERE l1.exp_report_header_id =
                                     p_exp_report_header_id
                                 AND l1.invoice_code = l.invoice_code
                                 AND l1.invoice_number = l.invoice_number
                                 AND l1.invoice_sum_amount <>
                                     l.invoice_sum_amount)) LOOP
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '发票号码,发票代码相同,但是发票金额不同【' ||
                                                                                  c_invoice.invoice_code || '-' ||
                                                                                  c_invoice.invoice_number || '】',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'validate_invoice_number');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    END LOOP;
  
    --发票金额校验
    FOR c_invoice IN (SELECT l.invoice_code,
                             l.invoice_number,
                             SUM(l.report_amount) report_amount,
                             SUM(l.invoice_sum_amount) / COUNT(1) invoice_sum_amount
                        FROM exp_report_lines l
                       WHERE l.exp_report_header_id = p_exp_report_header_id
                         AND l.invoice_code IS NOT NULL
                         AND l.invoice_number IS NOT NULL
                       GROUP BY l.invoice_code, l.invoice_number) LOOP
      IF (c_invoice.report_amount > c_invoice.invoice_sum_amount) THEN
      
        sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '报销金额大于发票金额【' ||
                                                                                    c_invoice.invoice_code || '-' ||
                                                                                    c_invoice.invoice_number || '】',
                                                       p_created_by              => p_user_id,
                                                       p_package_name            => 'exp_report_pkg',
                                                       p_procedure_function_name => 'validate_invoice_number');
        raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                sys_raise_app_error_pkg.g_err_line_id);
      END IF;
    END LOOP;
  
    --本报销单校验
    /*    FOR cc IN (SELECT l.invoice_code, l.invoice_number, COUNT(1)
                 FROM exp_report_lines l, exp_ygz_invoice_types tp
                WHERE l.exp_report_header_id = p_exp_report_header_id
                  AND tp.type_code = l.invoice_type
                  AND tp.einvoice_flag = 'Y'
                GROUP BY l.invoice_code, l.invoice_number
               HAVING COUNT(1) > 1
               
               ) LOOP
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '当前报销单存在相同的发票代码和发票号码【' ||
                                                                                  cc.invoice_code || '-' ||
                                                                                  cc.invoice_number || '】',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'validate_invoice_number');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    END LOOP;*/
  END validate_invoice_number;

  --校验是否关联OA签报
  PROCEDURE check_exp_oa_ref(p_exp_report_header_id NUMBER,
                             p_user_id              NUMBER) IS
    v_need_ref_flag VARCHAR2(1) := 'N';
    v_count         NUMBER;
  BEGIN
    SELECT et.oa_sign_flag
      INTO v_need_ref_flag
      FROM exp_expense_report_types et, exp_report_headers h
     WHERE et.expense_report_type_id = h.exp_report_type_id
       AND h.exp_report_header_id = p_exp_report_header_id;
  
    v_need_ref_flag := nvl(v_need_ref_flag, 'N');
  
    IF (v_need_ref_flag = 'N') THEN
      SELECT COUNT(1)
        INTO v_count
        FROM exp_report_lines l, exp_expense_types eet
       WHERE l.exp_report_header_id = p_exp_report_header_id
         AND l.expense_type_id = eet.expense_type_id
         AND nvl(eet.oa_sign_flag, 'N') = 'Y';
    
      IF (v_count > 0) THEN
        v_need_ref_flag := 'Y';
      END IF;
    END IF;
  
    IF (v_need_ref_flag = 'Y') THEN
      SELECT COUNT(1)
        INTO v_count
        FROM cux_oa_exp_ref cr, con_sign_oa cso
       WHERE cr.sign_id = cso.sign_id
         AND cr.exp_report_header_id = p_exp_report_header_id;
    
      IF (v_count = 0) THEN
        sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '该报销单需关联OA签报',
                                                       p_created_by              => p_user_id,
                                                       p_package_name            => 'exp_report_pkg',
                                                       p_procedure_function_name => 'check_exp_oa_ref');
        raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                sys_raise_app_error_pkg.g_err_line_id);
      END IF;
    END IF;
  
  END check_exp_oa_ref;

  --合同唯一校验
  procedure validate_con_only(p_exp_report_header_id number,
                              p_user_id              number) is
    e_different_error exception;
    v_count number;
  begin
  
    select count(distinct c.document_id)
      into v_count
      from con_document_flows c
     where c.source_document_id = p_exp_report_header_id
       and c.document_type = 'CON_CONTRACT'
       AND c.source_document_type = 'EXP_REPORT_PMT_SCHEDULES';
  
    if v_count > 1 then
      raise e_different_error;
    end if;
  exception
    when e_different_error then
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '关联合同不唯一!',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'validate_con_only');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  end validate_con_only;

  --提交费用申请
  PROCEDURE submit_exp_report(p_exp_report_header_id NUMBER,
                              p_last_updated_by      NUMBER) IS
    e_submit_error               EXCEPTION;
    e_adjustment_zero_error      EXCEPTION;
    e_req_rep_exp_type_must_same EXCEPTION;
    e_req_rep_company_must_same  EXCEPTION;
    e_coa_validate_error         EXCEPTION;
    e_usage_type_validate_error  EXCEPTION;
    e_invoice_exist_exception    EXCEPTION;
    e_invoice_true_exception     EXCEPTION;
  
    v_instance_id          NUMBER;
    v_report_amount        NUMBER;
    v_exists               NUMBER;
    v_company_id           NUMBER;
    v_exp_rep_type_id      exp_report_headers.exp_report_type_id%TYPE;
    v_coa_validate_message VARCHAR2(2000);
    v_coa_session_id       NUMBER;
    v_coa_company_id       NUMBER;
    v_coa_user_id          NUMBER;
    e_period_not_open EXCEPTION;
    v_report_date        DATE;
    v_period_name        VARCHAR2(100);
    v_match_invoice_flag NUMBER;
  
    e_exp_req_rel_exception EXCEPTION;
    v_document_page_type VARCHAR2(10);
    v_flag               VARCHAR2(1);
    v_verification_flag  VARCHAR2(10);
    v_invoice_true_flag  VARCHAR2(10);
    v_auto_audit_flag    VARCHAR2(10);
    v_count              NUMBER;
  BEGIN
    SELECT MAX(l.session_id) * -1
      INTO v_coa_session_id
      FROM sys_user_logins l
     WHERE l.user_id = p_last_updated_by;
  
    v_coa_user_id := p_last_updated_by;
  
    SELECT company_id, h.report_date
      INTO v_coa_company_id, v_report_date
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
  
    --提交报销单时，系统校验当前报销单的期间必须是打开的，否则提交失败  add by Shen Jinan 20171224 start
    BEGIN
      SELECT f.period_name
        INTO v_period_name
        FROM fnd_sob_period_status f
       WHERE f.period_name = to_char(v_report_date, 'yyyy-mm')
         AND f.period_status_code = 'O';
    EXCEPTION
      WHEN no_data_found THEN
        RAISE e_period_not_open;
    END;
  
    --如果是差旅类报销单，校验是否关联费用申请单 add by liubo
    /*select er.document_page_type
      into v_document_page_type
      from exp_report_headers       h,
           exp_expense_report_types et,
           exp_sob_report_types     er
     where h.exp_report_type_id = et.expense_report_type_id
       and et.expense_report_type_code = er.expense_report_type_code
       and h.exp_report_header_id = p_exp_report_header_id
       and rownum = 1;
    
    if (v_document_page_type = 'TRAVEL') then
      begin
        select 'Y'
          into v_flag
          from dual
         where exists
         (select 1
                  from exp_requisition_release er
                 where er.document_id = p_exp_report_header_id);
      exception
        when no_data_found then
          raise e_exp_req_rel_exception;
      end;
    end if;*/
    --提交报销单时，系统校验当前报销单的期间必须是打开的，否则提交失败  add by Shen Jinan 20171224 end
  
    /*if sys_parameter_pkg.value(p_parameter_code => 'EXP_COA_VALIDATE',
                             p_user_id        => null,
                             p_role_id        => null,
                             p_company_id     => v_coa_company_id) = 'Y' then
    cux_exp_report_pkg.validate_coa(p_exp_report_header_id => p_exp_report_header_id,
                                    p_company_id           => v_coa_company_id,
                                    p_user_id              => v_coa_user_id,
                                    p_session_id           => v_coa_session_id,
                                    p_validate_message     => v_coa_validate_message);
    
    if v_coa_validate_message is not null then
      raise e_coa_validate_error;
    end if;*/
  
    --add by pqs 20181010
    --报销单提交，对增值税专票、增值税普票、增值税电子发票需先判断是否已第三验真 
    FOR c_temp1 IN (SELECT l.exp_report_line_id,
                           l.invoice_code,
                           l.invoice_number,
                           l.invoice_status,
                           l.invoice_type,
                           l.invoice_true_status,
                           l.company_id
                      FROM exp_report_lines l
                     WHERE l.exp_report_header_id = p_exp_report_header_id
                       AND l.invoice_type IN ('INV001', 'INV002', 'INV003')) LOOP
      --获取发票类型是否验真标识
      SELECT e.verification_flag
        INTO v_verification_flag
        FROM exp_ygz_invoice_types e
       WHERE e.type_code = c_temp1.invoice_type;
    
      --获取报销行机构发票验真标识
      SELECT f.invoice_true_flag
        INTO v_invoice_true_flag
        FROM fnd_companies f
       WHERE f.company_id = c_temp1.company_id;
    
      IF v_verification_flag = 'Y' AND v_invoice_true_flag = 'Y' THEN
        IF (c_temp1.invoice_true_status <> '2' OR
           c_temp1.invoice_true_status IS NULL) THEN
        
          SELECT COUNT(*)
            INTO v_count
            FROM exp_report_invoice_true t
           WHERE t.invoice_code = c_temp1.invoice_code
             AND t.invoice_number = c_temp1.invoice_number
             AND t.invoice_true_status = '2'; --发票已验真
        
          IF v_count = 0 THEN
            v_coa_validate_message := '发票号码' || c_temp1.invoice_number ||
                                      '发票代码' || c_temp1.invoice_code ||
                                      '未传送第三方验真或验真失败,需先发票验真!';
            RAISE e_invoice_true_exception;
            -- EXIT;
          END IF;
        END IF;
      END IF;
    END LOOP;
  
    --增值税专票INV001与专票库（增值税同步）匹配
    FOR c_temp IN (SELECT l.exp_report_line_id,
                          l.invoice_code,
                          l.invoice_number,
                          l.invoice_status,
                          l.invoice_type
                     FROM exp_report_lines l
                    WHERE l.exp_report_header_id = p_exp_report_header_id
                      AND l.invoice_type = 'INV001') LOOP
    
      v_match_invoice_flag := match_invoice(c_temp.invoice_code,
                                            c_temp.invoice_number,
                                            c_temp.exp_report_line_id);
      IF v_match_invoice_flag = 1 THEN
        NULL;
        -- 匹配成功时将发票状态已抵扣
        /*UPDATE exp_report_lines l
          SET l.invoice_status = '30'
        WHERE l.exp_report_line_id = c_temp.exp_report_line_id;*/
      ELSE
        /*IF (c_temp.invoice_status = '30' OR c_temp.invoice_status = '40' OR
        c_temp.invoice_status = '50') AND
        c_temp.invoice_code IS NOT NULL AND
        c_temp.invoice_number IS NOT NULL THEN*/
        -- 匹配失败时将发票状态抵扣失败
        UPDATE exp_report_lines l
           SET l.invoice_status = '40'
         WHERE l.exp_report_line_id = c_temp.exp_report_line_id;
        v_coa_validate_message := '发票号码' || c_temp.invoice_number || '发票代码' ||
                                  c_temp.invoice_code || '在增值税专票库不存在！';
        RAISE e_invoice_exist_exception;
        --  EXIT;
        /*END IF;*/
      END IF;
    END LOOP;
    ---end
  
    --发票类型为为INV001 增值税专用发票时，校验发票号码+发票代码一致的所有报销行
    --搭配的抵扣规则是否一致
    FOR c_check IN (SELECT l.invoice_code, l.invoice_number, l.usage_type
                      FROM exp_report_lines l
                     WHERE l.exp_report_header_id = p_exp_report_header_id
                       AND l.invoice_type = 'INV001') LOOP
    
      FOR c_check2 IN (SELECT l.usage_type
                         FROM exp_report_lines l
                        WHERE l.exp_report_header_id =
                              p_exp_report_header_id
                          AND l.invoice_type = 'INV001'
                          AND l.invoice_number = c_check.invoice_number
                          AND l.invoice_code = c_check.invoice_code) LOOP
        IF c_check.usage_type <> c_check2.usage_type THEN
          v_coa_validate_message := '发票号码' || c_check.invoice_number ||
                                    '发票代码' || c_check.invoice_code ||
                                    '的费用用途搭配不一致,请修改';
          RAISE e_usage_type_validate_error;
          --  EXIT;
        END IF;
      END LOOP;
    END LOOP;
  
    IF submit_data_check(p_exp_report_header_id) = 'N' THEN
      RAISE e_submit_error;
    END IF;
    /*end if;*/
  
    /*************************************************
    -- Author  : Qu yuanyuan
    -- Created : 2015/1/25 20:56:06
    -- Ver     : 1.1
    -- Purpose : 月底限制提交报销单校验
    **************************************************/
    validate_submit_exp_rpt;
  
    /*************************************************
    -- Author  : MOUSE
    -- Created : 2015/12/7 20:56:06
    -- Ver     : 1.1
    -- Purpose : 合同可用金额校验
    **************************************************/
    validate_con_amount(p_exp_report_header_id => p_exp_report_header_id);
  
    /*************************************************
    -- Author  : pqs
    -- Created : 2018/11/21 16:05:06
    -- Ver     : 1.1
    -- Purpose : 关联合同唯一校验
    **************************************************/
    validate_con_only(p_exp_report_header_id => p_exp_report_header_id,
                      p_user_id              => p_last_updated_by);
  
    /*************************************************
    -- Author  : Rick
    -- Created : 2018-11-1 11:53:30
    -- Ver     : 1.1
    -- Purpose : 校验是否关联OA
    **************************************************/
    check_exp_oa_ref(p_exp_report_header_id => p_exp_report_header_id,
                     p_user_id              => p_last_updated_by);
  
    /*************************************************
    -- Author  : MOUSE
    -- Created : 2015/12/7 20:56:06
    -- Ver     : 1.1
    -- Purpose : 报销单关联申请单关联的借款单是否已支付校验
    **************************************************/
    validate_req_ref_pay_req(p_exp_report_header_id => p_exp_report_header_id);
  
    /*************************************************
    -- Author  : Rick
    -- Created : 2017-5-5 16:49:40
    -- Ver     : 1.1
    -- Purpose : 报销单行发票号码、发票代码校验
    **************************************************/
    validate_invoice_number(p_exp_report_header_id => p_exp_report_header_id,
                            p_user_id              => p_last_updated_by);
  
    /*************************************************
    -- Author  : Rick
    -- Created : 2017-11-1 20:46:49
    -- Ver     : 1.1
    -- Purpose : 差旅政策校验
    **************************************************/
    /*cux_exp_policy_pkg.check_policy(p_exp_report_header_id => p_exp_report_header_id,
    p_user_id              => p_last_updated_by);*/
  
    --专票报销单行,发票状态设置为待认证  --提交不修改发票状态modify by wxq 20180409               
    /*UPDATE exp_report_lines l
         SET l.invoice_status = '20'
       WHERE l.exp_report_header_id = p_exp_report_header_id
         AND EXISTS (SELECT 1
                FROM exp_ygz_invoice_types eyi
               WHERE eyi.type_code = l.invoice_type
                 AND eyi.special_invoice = 'Y');
    */
    --Mantis 0030982: 2010.07.28 by bobo
    con_contract_maintenance_pkg.contract_schedule_check(p_source_document_type => 'EXP_REPORT_LINES',
                                                         p_source_document_id   => p_exp_report_header_id);
  
    -- 判断费用报销单与引用的费用申请单“报销类型”是否一致
    IF NOT (submit_rep_req_exp_type_same(p_exp_report_header_id)) THEN
      RAISE e_req_rep_exp_type_must_same;
    END IF;
  
    -- 判断费用报销单与引用的费用申请单“行公司”是否一致
    IF NOT (submit_rep_req_company_same(p_exp_report_header_id)) THEN
      RAISE e_req_rep_company_must_same;
    END IF;
  
    --至少需要存在一条分配行
    BEGIN
      SELECT 1
        INTO v_exists
        FROM dual
       WHERE EXISTS
       (SELECT *
                FROM exp_report_lines l, exp_report_dists d
               WHERE l.exp_report_line_id = d.exp_report_line_id
                 AND l.exp_report_header_id = p_exp_report_header_id);
    EXCEPTION
      WHEN no_data_found THEN
        sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_DISTS_NULL',
                                                        p_created_by              => p_last_updated_by,
                                                        p_package_name            => 'exp_report_pkg',
                                                        p_procedure_function_name => 'submit_exp_report');
        raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                sys_raise_app_error_pkg.g_err_line_id);
    END;
  
    --1 校验申请行[申请金额]是否= SUM（对应分配行[申请金额]）
    v_report_amount := exp_report_amt_balance_check(p_exp_report_header_id => p_exp_report_header_id,
                                                    p_user_id              => p_last_updated_by);
  
    SELECT h.exp_report_type_id, h.company_id
      INTO v_exp_rep_type_id, v_company_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
  
    --调整类型报销单校验
    IF get_report_tye_adjustment(v_exp_rep_type_id) = 'Y' THEN
      IF v_report_amount <> 0 THEN
        RAISE e_adjustment_zero_error;
      END IF;
    END IF;
  
    --判断计划付款行中的收款方是否在合同对象范围内
    report_pmt_schedules_check(p_exp_report_header_id => p_exp_report_header_id,
                               p_user_id              => p_last_updated_by);
  
    --提交时 资金计划行校验
    submit_rep_pmt_schedules_check(p_exp_report_header_id => p_exp_report_header_id,
                                   p_user_id              => p_last_updated_by,
                                   p_company_id           => v_company_id);
  
    --add wgf 2012/12/26 校验报销单行金额和计划付款行金额
    -- 万联证券去掉校验,对后边的影响未知
    /*    report_pmt_amount_check(p_exp_report_header_id => p_exp_report_header_id,
    p_user_id              => p_last_updated_by);*/
    --end
  
    --处理相关联的申请单
    set_requisition_relation(p_exp_report_header_id => p_exp_report_header_id,
                             p_exp_report_type_id   => v_exp_rep_type_id,
                             p_user_id              => p_last_updated_by);
  
    --提交时 校验维度控制
    exp_dim_matching_control_check(p_exp_report_header_id => p_exp_report_header_id,
                                   p_user_id              => p_last_updated_by);
  
    --提交时，插入预置事件
    exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_SUBMIT',
                                    p_document_id      => p_exp_report_header_id,
                                    p_document_line_id => NULL,
                                    p_source_module    => c_exp_report,
                                    p_event_type       => 'EXP_REPORT_SUBMIT',
                                    p_user_id          => p_last_updated_by);
    --预生成凭证,校验ccid                               
    pre_create_er_accounts(p_exp_rep_header_id => p_exp_report_header_id,
                           p_user_id           => p_last_updated_by);
  
    --插历史记录
    insert_exp_document_histories(p_document_type  => c_exp_report,
                                  p_document_id    => p_exp_report_header_id,
                                  p_operation_code => exp_document_history_pkg.c_submit, --'SUBMIT',
                                  p_user_id        => p_last_updated_by,
                                  p_operation_time => SYSDATE,
                                  p_description    => '');
    /*--added by lyh  2017.5.25
    --合同维护的供应商，在提交后，如果公司级供应商中没有，则分配,并插入维护表
    FOR cur_ptm IN (SELECT e.payment_schedule_line_id,
                           e.payee_id,
                           e.company_id,
                           payee_category
                      FROM exp_report_pmt_schedules e
                     WHERE e.exp_report_header_id = p_exp_report_header_id) LOOP
      IF (cur_ptm.payee_category = 'VENDER') THEN
        insert_exp_report_vender(p_payee_id   => cur_ptm.payee_id,
                                 p_company_id => cur_ptm.company_id,
                                 p_user_id    => p_last_updated_by);
      END IF;
    END LOOP;*/
    IF get_auto_approve_flag(v_exp_rep_type_id) = 'Y' THEN
    
      --自审核
      v_auto_audit_flag := get_auto_audit_flag(v_exp_rep_type_id);
    
      --自审批
      UPDATE exp_report_headers h
         SET h.report_status    = 'COMPLETELY_APPROVED',
             h.audit_flag       = v_auto_audit_flag,
             h.last_updated_by  = p_last_updated_by,
             h.last_update_date = SYSDATE
       WHERE h.exp_report_header_id = p_exp_report_header_id;
    
      UPDATE exp_report_lines l
         SET l.report_status    = 'COMPLETELY_APPROVED',
             l.audit_flag       = v_auto_audit_flag,
             l.last_updated_by  = p_last_updated_by,
             l.last_update_date = SYSDATE
       WHERE l.exp_report_header_id = p_exp_report_header_id;
    
      UPDATE exp_report_dists d
         SET d.report_status    = 'COMPLETELY_APPROVED',
             d.last_updated_by  = p_last_updated_by,
             d.last_update_date = SYSDATE
       WHERE d.exp_report_line_id IN
             (SELECT l.exp_report_line_id
                FROM exp_report_lines l
               WHERE l.exp_report_header_id = p_exp_report_header_id);
    
      --插历史记录
      insert_exp_document_histories(p_document_type  => c_exp_report,
                                    p_document_id    => p_exp_report_header_id,
                                    p_operation_code => exp_document_history_pkg.c_approve, --'APPROVE',
                                    p_user_id        => p_last_updated_by,
                                    p_operation_time => SYSDATE,
                                    p_description    => '');
    
      --自审核
      --Modified by Rick 2018-10-10 15:40:05
      IF (v_auto_audit_flag = 'Y') THEN
        audit_exp_report(p_exp_report_header_id,
                         p_last_updated_by,
                         to_char(SYSDATE, 'yyyy-mm-dd'));
      END IF;
      --触发报销单审批通过事件（EXP_REPORT_COMPLETELY_APPROVED）
      /*exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_COMPLETELY_APPROVED',
      p_document_id      => p_exp_report_header_id,
      p_document_line_id => NULL,
      p_source_module    => 'exp_report_successfully_approved',
      p_event_type       => 'put_document_into_pool',
      p_user_id          => p_last_updated_by);*/
    
    ELSE
    
      --提交状态，启动工作流
      UPDATE exp_report_headers h
         SET h.report_status    = 'SUBMITTED',
             h.last_updated_by  = p_last_updated_by,
             h.last_update_date = SYSDATE
       WHERE h.exp_report_header_id = p_exp_report_header_id;
    
      UPDATE exp_report_lines l
         SET l.report_status    = 'SUBMITTED',
             l.last_updated_by  = p_last_updated_by,
             l.last_update_date = SYSDATE
       WHERE l.exp_report_header_id = p_exp_report_header_id;
    
      UPDATE exp_report_dists d
         SET d.report_status    = 'SUBMITTED',
             d.last_updated_by  = p_last_updated_by,
             d.last_update_date = SYSDATE
       WHERE d.exp_report_line_id IN
             (SELECT l.exp_report_line_id
                FROM exp_report_lines l
               WHERE l.exp_report_header_id = p_exp_report_header_id);
    
      --调用工作流流程
      BEGIN
        v_instance_id := wfl_core_pkg.workflow_start(p_transaction_category => c_exp_report,
                                                     p_transaction_type_id  => v_exp_rep_type_id,
                                                     p_instance_param       => p_exp_report_header_id,
                                                     p_user_id              => p_last_updated_by);
      EXCEPTION
        WHEN wfl_core_pkg.e_workflow_start_error THEN
          RAISE e_sub_program_error;
      END;
    END IF;
  
    IF get_report_type_template_flag(v_exp_rep_type_id) <> 'Y' THEN
      UPDATE bgt_budget_reserves t
         SET t.status         = 'P',
             last_update_date = SYSDATE,
             last_updated_by  = p_last_updated_by
       WHERE t.release_id IN
             (SELECT DISTINCT r.release_id
                FROM exp_requisition_release r
               WHERE r.document_type = c_exp_report
                 AND r.document_id = p_exp_report_header_id)
         AND t.business_type = 'EXP_REQUISITION';
      -- added by majianjian at 2015/3/30 14:48:21
      -- purpose: 当报销单提交时，占用预算。
      UPDATE bgt_budget_reserves t
         SET t.status           = 'P',
             t.last_update_date = SYSDATE,
             t.last_updated_by  = p_last_updated_by
       WHERE t.release_id IN
             (SELECT DISTINCT l.exp_report_line_id
                FROM exp_report_lines l
               WHERE l.exp_report_header_id = p_exp_report_header_id)
         AND t.business_type = 'EXP_TRAVEL_PLAN';
      -- end add.
      UPDATE bgt_budget_reserves t
         SET t.status         = 'P',
             last_update_date = SYSDATE,
             last_updated_by  = p_last_updated_by
       WHERE t.document_id = p_exp_report_header_id
         AND t.business_type = c_exp_report;
    END IF;
    --Modify 2010.10.27 Mantis:0032203 Bobo
    reset_req_bgt_reserve(p_exp_report_header_id => p_exp_report_header_id,
                          p_user_id              => p_last_updated_by);
  EXCEPTION
    WHEN e_invoice_true_exception THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => v_coa_validate_message,
                                                     p_created_by              => p_last_updated_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'submit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_invoice_exist_exception THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => v_coa_validate_message,
                                                     p_created_by              => p_last_updated_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'submit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_usage_type_validate_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => v_coa_validate_message,
                                                     p_created_by              => p_last_updated_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'submit_exp_report');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_exp_req_rel_exception THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '差旅类型的报销单至少有一行必须关联申请单!',
                                                     p_created_by              => p_last_updated_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'submit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_req_ref_pay_req_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '当前报销单关联的申请单所关联的借款申请单尚未完成支付,请等待借款单支付完成后再提交该报销单!',
                                                     p_created_by              => p_last_updated_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'submit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    
    WHEN e_con_amount_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '合同金额校验失败,当前计划付款行引用的合同金额超过合同可用金额!',
                                                     p_created_by              => p_last_updated_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'submit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_coa_validate_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => v_coa_validate_message,
                                                     p_created_by              => p_last_updated_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'submit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_adjustment_zero_error THEN
      ROLLBACK;
      set_budget_reserves(p_document_id => p_exp_report_header_id,
                          p_user_id     => p_last_updated_by);
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_ADJUSTMENT_ZERO_ERROR',
                                                      p_created_by              => p_last_updated_by,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'submit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_sub_program_error THEN
      ROLLBACK;
      set_budget_reserves(p_document_id => p_exp_report_header_id,
                          p_user_id     => p_last_updated_by);
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_submit_error THEN
      -- ROLLBACK;
      set_budget_reserves(p_document_id => p_exp_report_header_id,
                          p_user_id     => p_last_updated_by);
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_HEADER_SUBMIT_ERROR',
                                                      p_created_by              => p_last_updated_by,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'submit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_req_rep_exp_type_must_same THEN
      ROLLBACK;
      set_budget_reserves(p_document_id => p_exp_report_header_id,
                          p_user_id     => p_last_updated_by);
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REQ_REP_EXP_TYPE_MUST_SAME',
                                                      p_created_by              => p_last_updated_by,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'submit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_req_rep_company_must_same THEN
      ROLLBACK;
      set_budget_reserves(p_document_id => p_exp_report_header_id,
                          p_user_id     => p_last_updated_by);
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REQ_REP_COMPANY_MUST_SAME',
                                                      p_created_by              => p_last_updated_by,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'submit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_period_not_open THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '报销日期所在的期间未打开，不能提交报销单!',
                                                     p_created_by              => p_last_updated_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'submit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    
    WHEN OTHERS THEN
      ROLLBACK;
      set_budget_reserves(p_document_id => p_exp_report_header_id,
                          p_user_id     => p_last_updated_by);
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_last_updated_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'submit_exp_report');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END submit_exp_report;

  --获取资金计划行的已核销金额
  FUNCTION get_rep_pmt_tot_write_off_amt(p_exp_report_header_id NUMBER,
                                         p_pmt_schedule_line_id NUMBER)
    RETURN NUMBER IS
    v_amount NUMBER;
  BEGIN
    SELECT nvl(SUM(w.document_write_off_amount), 0)
      INTO v_amount
      FROM csh_write_off w
     WHERE w.document_source = 'EXPENSE_REPORT'
       AND w.document_header_id = p_exp_report_header_id
       AND w.document_line_id = p_pmt_schedule_line_id;
    RETURN v_amount;
  END get_rep_pmt_tot_write_off_amt;

  --判断报销单计划付款行是否存在关联合同， 0： 关联 ； -1： 没有关联
  FUNCTION rep_pmt_contract_exists(p_payment_schedule_line_id NUMBER)
    RETURN NUMBER IS
    v_exists NUMBER;
  BEGIN
    SELECT 1
      INTO v_exists
      FROM dual
     WHERE EXISTS
     (SELECT 1
              FROM con_document_flows d
             WHERE d.document_type = 'CON_CONTRACT'
               AND d.source_document_type = 'EXP_REPORT_PMT_SCHEDULES'
               AND d.source_document_line_id = p_payment_schedule_line_id);
    RETURN 0;
  
  EXCEPTION
    WHEN no_data_found THEN
      RETURN - 1;
  END rep_pmt_contract_exists;

  --判断现金事务行是否存在关联合同， 0： 关联 ； -1： 没有关联
  FUNCTION csh_trx_contract_exists(p_csh_transaction_line_id NUMBER)
    RETURN NUMBER IS
    v_exists NUMBER;
  BEGIN
    SELECT 1
      INTO v_exists
      FROM dual
     WHERE EXISTS
     (SELECT 1
              FROM con_cash_trx_pmt_schedule_lns cl
             WHERE cl.csh_transaction_line_id = p_csh_transaction_line_id);
    RETURN 0;
  
  EXCEPTION
    WHEN no_data_found THEN
      RETURN - 1;
  END csh_trx_contract_exists;

  FUNCTION get_exp_report_type_id(p_exp_report_header_id NUMBER)
    RETURN NUMBER IS
    v_exp_rep_type_id exp_report_headers.exp_report_type_id%TYPE;
  BEGIN
    SELECT h.exp_report_type_id
      INTO v_exp_rep_type_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
    RETURN v_exp_rep_type_id;
  EXCEPTION
    WHEN no_data_found THEN
      RETURN NULL;
  END get_exp_report_type_id;

  --打开相关的申请单
  PROCEDURE open_exp_requisition(p_exp_rep_header_id NUMBER,
                                 p_user_id           NUMBER) IS
  BEGIN
    FOR v_exp_reqs IN (SELECT DISTINCT r.exp_requisition_header_id exp_req_header_id
                         FROM exp_requisition_release r
                        WHERE r.document_type = c_exp_report
                          AND r.document_id = p_exp_rep_header_id) LOOP
      exp_requisition_pkg.open_exp_requisition(p_exp_req_header_id => v_exp_reqs.exp_req_header_id,
                                               p_user_id           => p_user_id);
    END LOOP;
  END open_exp_requisition;

  PROCEDURE wfl_update_document_check(p_workflow_id NUMBER,
                                      p_user_id     NUMBER) IS
    v_exists NUMBER;
  BEGIN
    SELECT 1
      INTO v_exists
      FROM wfl_workflow w
     WHERE w.workflow_id = p_workflow_id
       AND w.workflow_category = c_exp_report;
  EXCEPTION
    WHEN no_data_found THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'WFL_WORKFLOW_UPDATE_DOCUMENT_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'wfl_update_document_check');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END;

  --2013.10.08 bobo 报销单拒绝、回收、时，重置申请单对应的预算保留
  PROCEDURE reset_other_req_bgt_reserve(p_exp_report_header_id NUMBER,
                                        p_user_id              NUMBER) IS
    v_rexp_report_header_id NUMBER;
  BEGIN
    --找到该申请单关联的最新的状态是P的报销单记录，找到其对应的申请单释放金额，按提交时的算法做个重算更新。
    SELECT a.document_id
      INTO v_rexp_report_header_id
      FROM exp_requisition_release a, bgt_budget_reserves br
     WHERE a.exp_requisition_header_id IN
           (SELECT DISTINCT r.exp_requisition_header_id
              FROM exp_requisition_release r
             WHERE r.document_type = c_exp_report
               AND r.document_id = p_exp_report_header_id)
       AND a.document_type = c_exp_report
       AND a.document_id = br.document_id
       AND br.business_type = a.document_type
       AND br.status = 'P'
       AND br.business_type = c_exp_report
       AND rownum = 1;
  
    FOR v_release IN (SELECT r.release_id
                        FROM exp_requisition_release r
                       WHERE r.document_type = c_exp_report
                         AND r.document_id = v_rexp_report_header_id) LOOP
      exp_requisitions_release_pkg.released_bgt_reserve_balance(p_release_id => v_release.release_id,
                                                                p_user_id    => p_user_id);
    END LOOP;
  EXCEPTION
    WHEN no_data_found THEN
      NULL;
  END;

  --工作流运行完毕后，设置状态
  PROCEDURE update_reports_post_workflow(p_wfl_instance_id NUMBER,
                                         p_wfl_status      NUMBER,
                                         p_user_id         NUMBER) IS
    r_instance wfl_workflow_instance%ROWTYPE;
  
    v_auto_audit_flag  exp_expense_report_types.auto_audit_flag%TYPE;
    v_exp_rep_type_id  exp_report_headers.exp_report_type_id%TYPE;
    v_error_level_code VARCHAR2(100);
    v_message_code     VARCHAR2(100);
  BEGIN
    SELECT *
      INTO r_instance
      FROM wfl_workflow_instance
     WHERE instance_id = p_wfl_instance_id;
  
    --单据类型匹配校验
    wfl_update_document_check(p_workflow_id => r_instance.workflow_id,
                              p_user_id     => p_user_id);
  
    v_exp_rep_type_id := get_exp_report_type_id(r_instance.instance_param);
    IF v_exp_rep_type_id IS NULL THEN
      RETURN;
    END IF;
    v_auto_audit_flag := get_auto_audit_flag(v_exp_rep_type_id);
  
    --审批通过
    IF p_wfl_status = wfl_core_pkg.c_workflow_finished THEN
    
      --发票认证 审批不改变发票状态modify by wxq 20180409
      /* check_invoice(p_exp_report_header_id => r_instance.instance_param,
      p_user_id              => p_user_id,
      p_raise_error          => 'N');*/
    
      UPDATE exp_report_headers h
         SET h.report_status    = 'COMPLETELY_APPROVED',
             h.last_updated_by  = p_user_id,
             h.last_update_date = SYSDATE,
             h.audit_flag       = v_auto_audit_flag
       WHERE h.exp_report_header_id = r_instance.instance_param;
    
      UPDATE exp_report_lines l
         SET l.report_status    = 'COMPLETELY_APPROVED',
             l.last_updated_by  = p_user_id,
             l.last_update_date = SYSDATE,
             audit_flag         = v_auto_audit_flag
       WHERE l.exp_report_header_id = r_instance.instance_param;
    
      UPDATE exp_report_dists d
         SET d.report_status    = 'COMPLETELY_APPROVED',
             d.last_updated_by  = p_user_id,
             d.last_update_date = SYSDATE
       WHERE d.exp_report_line_id IN
             (SELECT l.exp_report_line_id
                FROM exp_report_lines l
               WHERE l.exp_report_header_id = r_instance.instance_param);
      --Update 2013-10-28 Silen Xia
      --modify by pqs 报销单不进入派工池,在费用报销单审核处制证审核
      /*exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_COMPLETELY_APPROVED',
      p_document_id      => r_instance.instance_param,
      p_document_line_id => NULL,
      p_source_module    => 'exp_report_successfully_approved',
      p_event_type       => 'PUT_EXP_REPORT_INTO_POOL',
      p_user_id          => p_user_id);*/
    
      --2013.10.08 bobo
      reset_req_bgt_reserve(p_exp_report_header_id => r_instance.instance_param,
                            p_user_id              => p_user_id);
    
      --Modified by Rick 2018-10-10 15:40:05
      IF (v_auto_audit_flag = 'Y') THEN
        audit_exp_report(r_instance.instance_param,
                         p_user_id,
                         to_char(SYSDATE, 'yyyy-mm-dd'));
      END IF;
    END IF;
  
    --审批拒绝
    IF p_wfl_status = wfl_core_pkg.c_workflow_terminated THEN
    
      UPDATE bgt_budget_reserves t
         SET t.status         = 'N',
             last_update_date = SYSDATE,
             last_updated_by  = p_user_id
       WHERE t.release_id IN
             (SELECT DISTINCT r.release_id
                FROM exp_requisition_release r
               WHERE r.document_type = c_exp_report
                 AND r.document_id = r_instance.instance_param)
         AND t.business_type IN (c_exp_report, 'EXP_REQUISITION');
      -- added by majianjian at 2015/3/31 15:15:41
      -- purpose: 工作流审批拒绝后，将差旅计划释放预算的状态值为“N”，用来取消释放预算。
      UPDATE bgt_budget_reserves t
         SET t.status           = 'N',
             t.last_update_date = SYSDATE,
             t.last_updated_by  = p_user_id
       WHERE t.release_id IN
             (SELECT DISTINCT l.exp_report_line_id
                FROM exp_report_lines l
               WHERE l.exp_report_header_id = r_instance.instance_param)
         AND t.business_type = 'EXP_TRAVEL_PLAN';
      -- end add.
      UPDATE bgt_budget_reserves r
         SET r.status           = 'N',
             r.last_update_date = SYSDATE,
             r.last_updated_by  = p_user_id
       WHERE r.business_type = c_exp_report
         AND r.document_id = r_instance.instance_param;
    
      UPDATE exp_report_headers h
         SET h.report_status    = 'REJECTED',
             h.scan_status      = 'N',
             h.last_updated_by  = p_user_id,
             h.last_update_date = SYSDATE
       WHERE h.exp_report_header_id = r_instance.instance_param;
    
      UPDATE exp_report_lines l
         SET l.report_status    = 'REJECTED',
             l.last_updated_by  = p_user_id,
             l.last_update_date = SYSDATE
       WHERE l.exp_report_header_id = r_instance.instance_param;
    
      --发票状态 审批不修改发票状态 modify by wxq 20180409
      /*UPDATE exp_report_lines l
        SET l.invoice_status = '20'
      WHERE l.exp_report_header_id = r_instance.instance_param
        AND l.invoice_status IN ('30', '50');*/
    
      UPDATE exp_report_dists d
         SET d.report_status    = 'REJECTED',
             d.last_updated_by  = p_user_id,
             d.last_update_date = SYSDATE
       WHERE d.exp_report_line_id IN
             (SELECT l.exp_report_line_id
                FROM exp_report_lines l
               WHERE l.exp_report_header_id = r_instance.instance_param);
    
      --打开关联的申请单
      open_exp_requisition(p_exp_rep_header_id => r_instance.instance_param,
                           p_user_id           => p_user_id);
    
      --2013.10.08 bobo
      reset_other_req_bgt_reserve(p_exp_report_header_id => r_instance.instance_param,
                                  p_user_id              => p_user_id);
    END IF;
  
    --收回
    IF p_wfl_status = wfl_core_pkg.c_workflow_canceled THEN
    
      UPDATE bgt_budget_reserves t
         SET t.status         = 'N',
             last_update_date = SYSDATE,
             last_updated_by  = p_user_id
       WHERE t.release_id IN
             (SELECT DISTINCT r.release_id
                FROM exp_requisition_release r
               WHERE r.document_type = c_exp_report
                 AND r.document_id = r_instance.instance_param)
         AND t.business_type IN (c_exp_report, 'EXP_REQUISITION');
      -- added by majianjian at 2015/3/31 15:15:41
      -- purpose: 工作流审批拒绝后，将差旅计划释放预算的状态值为“N”，用来取消释放预算。
      UPDATE bgt_budget_reserves t
         SET t.status           = 'N',
             t.last_update_date = SYSDATE,
             t.last_updated_by  = p_user_id
       WHERE t.release_id IN
             (SELECT DISTINCT l.exp_report_line_id
                FROM exp_report_lines l
               WHERE l.exp_report_header_id = r_instance.instance_param)
         AND t.business_type = 'EXP_TRAVEL_PLAN';
      -- end add.
      UPDATE bgt_budget_reserves r
         SET r.status           = 'N',
             r.last_update_date = SYSDATE,
             r.last_updated_by  = p_user_id
       WHERE r.business_type = c_exp_report
         AND r.document_id = r_instance.instance_param;
    
      UPDATE exp_report_headers h
         SET h.report_status    = 'TAKEN_BACK',
             h.last_updated_by  = p_user_id,
             h.last_update_date = SYSDATE
       WHERE h.exp_report_header_id = r_instance.instance_param;
    
      UPDATE exp_report_lines l
         SET l.report_status    = 'TAKEN_BACK',
             l.last_updated_by  = p_user_id,
             l.last_update_date = SYSDATE
       WHERE l.exp_report_header_id = r_instance.instance_param;
    
      --发票状态 modify by wxq 20180409
      /* UPDATE exp_report_lines l
        SET l.invoice_status = '20'
      WHERE l.exp_report_header_id = r_instance.instance_param
        AND l.invoice_status IN ('30', '50');*/
    
      UPDATE exp_report_dists d
         SET d.report_status    = 'TAKEN_BACK',
             d.last_updated_by  = p_user_id,
             d.last_update_date = SYSDATE
       WHERE d.exp_report_line_id IN
             (SELECT l.exp_report_line_id
                FROM exp_report_lines l
               WHERE l.exp_report_header_id = r_instance.instance_param);
    
      --打开关联的申请单
      open_exp_requisition(p_exp_rep_header_id => r_instance.instance_param,
                           p_user_id           => p_user_id);
    
      --2013.10.08 bobo
      reset_other_req_bgt_reserve(p_exp_report_header_id => r_instance.instance_param,
                                  p_user_id              => p_user_id);
    END IF;
  
    /*--0031142: 单据审批结束后删除预算检查log表  2010.08.10 by Bobo 
    delete from bgt_check_logs a
     where a.document_id = r_instance.instance_param
           and a.document_type = c_exp_report;*/
  
    --2013.10.08 bobo 提交时，预算重置方式要修改
    /*    --Modify 2010.10.27 Mantis:0032203 Bobo
    reset_req_bgt_reserve(p_exp_report_header_id => r_instance.instance_param,
                          p_user_id              => p_user_id);*/
  
  END update_reports_post_workflow;

  --收回费用申请
  PROCEDURE taken_back_exp_report(p_exp_report_header_id NUMBER,
                                  p_last_updated_by      NUMBER) IS
    e_taken_back_error EXCEPTION;
  
    v_exists NUMBER;
  BEGIN
  
    BEGIN
      SELECT 1
        INTO v_exists
        FROM dual
       WHERE EXISTS (SELECT 1
                FROM exp_report_headers h
               WHERE h.exp_report_header_id = p_exp_report_header_id
                 AND h.report_status = 'SUBMITTED');
    EXCEPTION
      WHEN no_data_found THEN
        RAISE e_taken_back_error;
    END;
  
    -- 删除BGT_BUDGET_EXCESS表对应记录，删除预算保留表中对应记录，并清空分配行的超预算策略
    NULL;
  EXCEPTION
    WHEN e_taken_back_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_HEADER_TAKEN_BACK_ERROR',
                                                      p_created_by              => p_last_updated_by,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'taken_back_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_last_updated_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'taken_back_exp_report');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END taken_back_exp_report;

  --保存当前 维度布局
  PROCEDURE insert_exp_rep_dim_layouts(p_exp_report_header_id NUMBER,
                                       p_layout_position      VARCHAR2,
                                       p_layout_priority      NUMBER,
                                       p_dimension_id         NUMBER,
                                       p_default_dim_vlaue_id NUMBER,
                                       p_created_by           NUMBER) IS
  BEGIN
    INSERT INTO exp_rep_dimension_layouts
      (exp_report_header_id,
       layout_position,
       layout_priority,
       dimension_id,
       default_dim_value_id,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date)
    VALUES
      (p_exp_report_header_id,
       p_layout_position,
       p_layout_priority,
       p_dimension_id,
       p_default_dim_vlaue_id,
       p_created_by,
       SYSDATE,
       p_created_by,
       SYSDATE);
  END insert_exp_rep_dim_layouts;

  --保存当前 费用对象布局
  PROCEDURE insert_exp_rep_objects_layouts(p_exp_report_header_id   NUMBER,
                                           p_layout_position        VARCHAR2,
                                           p_layout_priority        NUMBER,
                                           p_expense_object_type_id NUMBER,
                                           p_default_object_id      NUMBER,
                                           p_created_by             NUMBER) IS
  BEGIN
    INSERT INTO exp_report_objects_layouts
      (exp_report_header_id,
       layout_position,
       layout_priority,
       expense_object_type_id,
       default_object_id,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date)
    VALUES
      (p_exp_report_header_id,
       p_layout_position,
       p_layout_priority,
       p_expense_object_type_id,
       p_default_object_id,
       p_created_by,
       SYSDATE,
       p_created_by,
       SYSDATE);
  END insert_exp_rep_objects_layouts;

  --保存当前费用对象值
  PROCEDURE insert_exp_report_objects(p_exp_report_header_id      NUMBER,
                                      p_exp_report_line_id        NUMBER,
                                      p_exp_report_travel_line_id NUMBER,
                                      p_expense_object_type_id    NUMBER,
                                      p_expense_object_id         NUMBER,
                                      p_created_by                NUMBER,
                                      p_desc                      VARCHAR2) IS
  BEGIN
    INSERT INTO exp_report_objects
      (exp_report_header_id,
       exp_report_line_id,
       exp_report_travel_line_id,
       expense_object_type_id,
       expense_object_id,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date,
       expense_object_desc)
    VALUES
      (p_exp_report_header_id,
       p_exp_report_line_id,
       p_exp_report_travel_line_id,
       p_expense_object_type_id,
       p_expense_object_id,
       p_created_by,
       SYSDATE,
       p_created_by,
       SYSDATE,
       p_desc);
  END insert_exp_report_objects;

  --更新当前费用对象值
  PROCEDURE update_exp_report_objects(p_exp_report_header_id      NUMBER,
                                      p_exp_report_line_id        NUMBER,
                                      p_exp_report_travel_line_id NUMBER,
                                      p_expense_object_type_id    NUMBER,
                                      p_expense_object_id         NUMBER,
                                      p_created_by                NUMBER,
                                      p_desc                      VARCHAR2) IS
  BEGIN
    IF update_status_check(p_exp_report_header_id, p_created_by) = 'Y' THEN
      UPDATE exp_report_objects a
         SET a.last_updated_by     = p_created_by,
             a.last_update_date    = SYSDATE,
             a.expense_object_id   = p_expense_object_id,
             a.expense_object_desc = p_desc
       WHERE a.exp_report_header_id = p_exp_report_header_id
         AND (a.exp_report_line_id = p_exp_report_line_id OR
             (a.exp_report_line_id IS NULL AND
             p_exp_report_line_id IS NULL))
         AND (a.exp_report_travel_line_id = p_exp_report_travel_line_id OR
             (a.exp_report_travel_line_id IS NULL AND
             p_exp_report_travel_line_id IS NULL))
         AND a.expense_object_type_id = p_expense_object_type_id;
    END IF;
  END update_exp_report_objects;

  PROCEDURE get_payment_schedule_date(p_period_name       VARCHAR2,
                                      p_company_id        NUMBER,
                                      p_schedule_due_date OUT VARCHAR2) IS
  BEGIN
    SELECT to_char(p.end_date, 'yyyy-mm-dd')
      INTO p_schedule_due_date
      FROM gld_periods p
     WHERE p.period_set_code =
           (SELECT s.period_set_code
              FROM gld_period_sets s, gld_set_of_books b
             WHERE s.period_set_code = b.period_set_code
               AND b.set_of_books_id =
                   gld_common_pkg.get_set_of_books_id(p_company_id))
       AND p.period_name = p_period_name;
  EXCEPTION
    WHEN no_data_found THEN
      p_schedule_due_date := NULL;
  END;

  PROCEDURE get_schedule_date(p_exp_report_header_id NUMBER,
                              p_schedule_start_date  OUT DATE,
                              p_schedule_due_date    OUT DATE) IS
    v_company_id  exp_report_headers.company_id%TYPE;
    v_period_name exp_report_headers.period_name%TYPE;
  BEGIN
    SELECT h.report_date, h.company_id, period_name
      INTO p_schedule_start_date, v_company_id, v_period_name
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
  
    SELECT p.end_date
      INTO p_schedule_due_date
      FROM gld_periods p
     WHERE p.period_set_code =
           (SELECT s.period_set_code
              FROM gld_period_sets s, gld_set_of_books b
             WHERE s.period_set_code = b.period_set_code
               AND b.set_of_books_id =
                   gld_common_pkg.get_set_of_books_id(v_company_id))
       AND p.period_name = v_period_name;
  EXCEPTION
    WHEN no_data_found THEN
      p_schedule_due_date := NULL;
  END get_schedule_date;

  PROCEDURE create_csh_doc_payment_company(p_exp_report_header_id NUMBER,
                                           p_user_id              NUMBER) IS
    v_payment_company_id csh_pmt_company_mp_conds.payment_company_id%TYPE;
    v_sql                VARCHAR2(1000);
    v_payment_status     VARCHAR2(30);
    v_exists             NUMBER;
    v_frozen_flag        VARCHAR2(1);
    v_payment_flag       VARCHAR2(1);
    v_pay_method_code    VARCHAR2(30);
    v_count              NUMBER;
    CURSOR cur_rep_pmt IS
      SELECT p.payment_schedule_line_id,
             nvl(h.pay_company_id, h.company_id) company_id, --支付公司取头上支付公司
             h.exp_report_type_id,
             h.operation_unit_id,
             p.payment_type_id,
             c_exp_report duc_category
        FROM exp_report_pmt_schedules p, exp_report_headers h
       WHERE p.exp_report_header_id = p_exp_report_header_id
         AND p.exp_report_header_id = h.exp_report_header_id;
  
    c_rep_pmt cur_rep_pmt%ROWTYPE;
  
    CURSOR cur_cm_conds IS
      SELECT *
        FROM csh_pmt_company_mp_conds c
       WHERE c.set_of_books_id =
             gld_common_pkg.get_set_of_books_id(c_rep_pmt.company_id)
       ORDER BY c.priorty;
    c_cm_conds cur_cm_conds%ROWTYPE;
  
    e_user_exit_procedure_error EXCEPTION;
  BEGIN
    SELECT eert.payment_flag
      INTO v_payment_flag
      FROM exp_expense_report_types eert, exp_report_headers h
     WHERE eert.expense_report_type_id = h.exp_report_type_id
       AND h.exp_report_header_id = p_exp_report_header_id;
  
    DELETE FROM csh_doc_payment_company p
     WHERE p.document_type = c_exp_report
       AND p.document_id = p_exp_report_header_id
       AND p.document_line_id NOT IN
           (SELECT s.payment_schedule_line_id
              FROM exp_report_pmt_schedules s
             WHERE s.exp_report_header_id = p_exp_report_header_id);
  
    OPEN cur_rep_pmt;
    LOOP
      FETCH cur_rep_pmt
        INTO c_rep_pmt;
      EXIT WHEN cur_rep_pmt%NOTFOUND;
    
      v_payment_company_id := NULL;
      v_payment_status     := NULL;
    
      OPEN cur_cm_conds;
      LOOP
        FETCH cur_cm_conds
          INTO c_cm_conds;
        EXIT WHEN cur_cm_conds%NOTFOUND;
      
        IF (c_rep_pmt.company_id =
           nvl(c_cm_conds.company_id, c_rep_pmt.company_id) OR
           c_cm_conds.company_id IS NULL) AND
           (c_rep_pmt.duc_category =
           nvl(c_cm_conds.ducument_category, c_rep_pmt.duc_category) OR
           c_cm_conds.ducument_category IS NULL) AND
           (c_rep_pmt.exp_report_type_id =
           nvl(c_cm_conds.ducument_type_id, c_rep_pmt.exp_report_type_id) OR
           c_cm_conds.ducument_type_id IS NULL) THEN
        
          IF c_cm_conds.type = '10' THEN
            v_payment_company_id := c_cm_conds.payment_company_id;
          ELSIF c_cm_conds.type = '20' THEN
            v_sql := 'begin :1 := ' || c_cm_conds.user_exit_procedure ||
                     '( :2); end;';
          
            EXECUTE IMMEDIATE v_sql
              USING OUT v_payment_company_id, p_exp_report_header_id;
          END IF;
        
        END IF;
      
        IF v_payment_company_id IS NOT NULL THEN
          EXIT;
        END IF;
      END LOOP;
      CLOSE cur_cm_conds;
    
      IF v_payment_company_id IS NULL THEN
        v_payment_company_id := c_rep_pmt.company_id;
      END IF;
      --modify 增加逻辑判断，根据frozen_flag的值来判断,frozen_flag的优先级最高
      SELECT t.frozen_flag
        INTO v_frozen_flag
        FROM exp_report_pmt_schedules t
       WHERE t.payment_schedule_line_id =
             c_rep_pmt.payment_schedule_line_id;
      IF v_frozen_flag = 'Y' THEN
        v_payment_status := 'FROZEN';
      ELSIF v_payment_flag = 'N' THEN
        v_payment_status := 'NEVER';
      ELSE
        IF nvl(sys_parameter_pkg.value('DOCUMENT_PENDING_CONFIRM',
                                       '',
                                       '',
                                       c_rep_pmt.company_id),
               'N') = 'N' THEN
          v_payment_status := 'ALLOWED';
        ELSE
          IF v_payment_company_id = c_rep_pmt.company_id THEN
            v_payment_status := 'ALLOWED';
          ELSE
            v_payment_status := 'PENDING';
          END IF;
        END IF;
      END IF;
    
      --add by lyh 2017.5.22
      --当用户选择付款方式为营业部本级支付时，付款公司依据配置取值，
      --当付款方式为总部集中支付时，插入的付款公司为万联证券总部
      SELECT c.payment_method_code
        INTO v_pay_method_code
        FROM csh_payment_methods c
       WHERE c.payment_method_id = c_rep_pmt.payment_type_id;
    
      SELECT COUNT(1)
        INTO v_count
        FROM sys_code_values_vl s, sys_codes s1
       WHERE s.code_id = s1.code_id
         AND s1.code = 'WLZQ_PARENT_PAYMENT'
         AND s.code_value = v_pay_method_code
         AND s1.enabled_flag = 'Y'
         AND s.enabled_flag = 'Y';
    
      IF v_count > 0 THEN
        --总公司就一个，级别为'10'
        SELECT f.company_id
          INTO v_payment_company_id
          FROM fnd_companies f, fnd_company_levels fs
         WHERE f.company_level_id = fs.company_level_id
           AND fs.company_level_code = '10';
        /*ELSE
        v_payment_company_id := c_cm_conds.payment_company_id;*/
      END IF;
    
      BEGIN
        SELECT 1
          INTO v_exists
          FROM dual
         WHERE EXISTS (SELECT *
                  FROM csh_doc_payment_company cd
                 WHERE cd.document_type = c_rep_pmt.duc_category
                   AND cd.document_id = p_exp_report_header_id
                   AND cd.document_line_id =
                       c_rep_pmt.payment_schedule_line_id);
        --增加修改操作
        UPDATE csh_doc_payment_company c
           SET c.payment_status     = v_payment_status,
               c.payment_company_id = v_payment_company_id
         WHERE c.document_line_id = c_rep_pmt.payment_schedule_line_id
           AND c.document_type = c_exp_report;
      EXCEPTION
        WHEN no_data_found THEN
          csh_doc_payment_company_pkg.insert_csh_doc_payment_company(p_document_type              => c_rep_pmt.duc_category,
                                                                     p_document_id                => p_exp_report_header_id,
                                                                     p_document_line_id           => c_rep_pmt.payment_schedule_line_id,
                                                                     p_document_company_id        => c_rep_pmt.company_id,
                                                                     p_document_operation_unit_id => c_rep_pmt.operation_unit_id,
                                                                     p_payment_company_id         => v_payment_company_id,
                                                                     p_payment_operation_unit_id  => '',
                                                                     p_payment_status             => v_payment_status,
                                                                     p_user_id                    => p_user_id);
      END;
    
    END LOOP;
    CLOSE cur_rep_pmt;
  
  EXCEPTION
    WHEN OTHERS THEN
      IF cur_cm_conds%ISOPEN THEN
        CLOSE cur_cm_conds;
      END IF;
      IF cur_rep_pmt%ISOPEN THEN
        CLOSE cur_rep_pmt;
      END IF;
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'create_csh_doc_payment_company');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END create_csh_doc_payment_company;

  --获取收款方银行信息
  PROCEDURE get_payee_bank_message(p_exp_report_header_id NUMBER,
                                   p_user_id              NUMBER,
                                   p_payee_category       VARCHAR2,
                                   p_payee_id             NUMBER,
                                   v_bank_code            OUT VARCHAR2,
                                   v_bank_name            OUT VARCHAR2,
                                   v_account_number       OUT VARCHAR2,
                                   v_account_name         OUT VARCHAR2,
                                   v_bank_location_code   OUT VARCHAR2,
                                   v_bank_location_name   OUT VARCHAR2,
                                   v_province_code        OUT VARCHAR2,
                                   v_province_name        OUT VARCHAR2,
                                   v_city_code            OUT VARCHAR2,
                                   v_city_name            OUT VARCHAR2,
                                   v_usedes               OUT VARCHAR2) IS
  BEGIN
    IF (p_payee_category = 'VENDER') THEN
      SELECT v.bank_code,
             v.bank_name,
             v.account_number,
             v.account_name,
             v.bank_location_code,
             v.bank_location,
             v.province_code,
             v.province_name,
             v.city_code,
             v.city_name
        INTO v_bank_code,
             v_bank_name,
             v_account_number,
             v_account_name,
             v_bank_location_code,
             v_bank_location_name,
             v_province_code,
             v_province_name,
             v_city_code,
             v_city_name
        FROM pur_vender_accounts v
       WHERE v.vender_id = p_payee_id
         AND v.primary_flag = 'Y';
    ELSIF (p_payee_category = 'CUSTOMER') THEN
      SELECT o.bank_code,
             o.bank_name,
             o.account_number,
             o.account_name,
             o.bank_location_code,
             o.bank_location,
             o.province_code,
             o.province_name,
             o.city_code,
             o.city_name
        INTO v_bank_code,
             v_bank_name,
             v_account_number,
             v_account_name,
             v_bank_location_code,
             v_bank_location_name,
             v_province_code,
             v_province_name,
             v_city_code,
             v_city_name
        FROM ord_customer_accounts o
       WHERE o.customer_id = p_payee_id
         AND o.primary_flag = 'Y';
    ELSE
      SELECT e.bank_code,
             e.bank_name,
             e.account_number,
             e.account_name,
             e.bank_location_code,
             e.bank_location,
             e.province_code,
             e.province_name,
             e.city_code,
             e.city_name
        INTO v_bank_code,
             v_bank_name,
             v_account_number,
             v_account_name,
             v_bank_location_code,
             v_bank_location_name,
             v_province_code,
             v_province_name,
             v_city_code,
             v_city_name
        FROM exp_employee_accounts e
       WHERE e.employee_id = p_payee_id
         AND e.primary_flag = 'Y';
    END IF;
    FOR c_cur IN (SELECT u.usedes_id
                    FROM exp_rep_ref_payment_usedes u, exp_report_headers e
                   WHERE u.expense_report_type_id = e.exp_report_type_id
                     AND e.exp_report_header_id = p_exp_report_header_id
                     AND u.primary_flag = 'Y') LOOP
      SELECT u.usedes_code
        INTO v_usedes
        FROM csh_payment_usedes u
       WHERE u.usedes_id = c_cur.usedes_id;
    END LOOP;
  EXCEPTION
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'get_payee_bank_message');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END;

  PROCEDURE delete_exp_rep_pmt_schedules(p_payment_schedule_line_id NUMBER,
                                         p_exp_report_header_id     NUMBER,
                                         p_user_id                  NUMBER) IS
  BEGIN
    DELETE FROM exp_report_pmt_schedules t
     WHERE t.payment_schedule_line_id = p_payment_schedule_line_id;
    DELETE FROM con_document_flows d
     WHERE d.document_type = 'CON_CONTRACT'
       AND d.source_document_type = 'EXP_REPORT_PMT_SCHEDULES'
       AND d.source_document_id = p_exp_report_header_id
       AND d.source_document_line_id NOT IN
           (SELECT s.payment_schedule_line_id
              FROM exp_report_pmt_schedules s
             WHERE s.exp_report_header_id = p_exp_report_header_id);
  
    FOR v_write_off IN (SELECT w.write_off_id
                          FROM csh_write_off w
                         WHERE w.document_source = 'EXPENSE_REPORT'
                           AND w.document_header_id = p_exp_report_header_id
                           AND w.document_line_id NOT IN
                               (SELECT s.payment_schedule_line_id
                                  FROM exp_report_pmt_schedules s
                                 WHERE s.exp_report_header_id =
                                       p_exp_report_header_id)) LOOP
      delete_csh_write_off(p_write_off_id => v_write_off.write_off_id,
                           p_user_id      => p_user_id);
    END LOOP;
  END;

  --行金额校验
  PROCEDURE report_line_amount_check(p_exp_report_header_id     NUMBER,
                                     p_flag                     OUT VARCHAR2,
                                     p_default_standard_subsidy NUMBER,
                                     p_user_id                  NUMBER) IS
    v_line_amount NUMBER;
    /*v_pmt_amount  NUMBER;*/
    v_date_total      NUMBER;
    v_acc_costs       NUMBER;
    v_transport_costs NUMBER;
    v_other_costs     NUMBER;
    v_amount          NUMBER;
  BEGIN
  
    NULL;
  END;

  -- 校验报销单每行行金额，是否与行的合同和合同资金行对应的  计划付款行金额是否相等 add by dzc
  /*function check_report_pmt_line(p_exp_report_header_id number)
          return varchar2 as
  
          v_line_total_amt number;
          v_total_pmt_amt  number;
  
          cursor cur_rec is
              select cdf.document_id,
                     cdf.document_line_id,
                     sum(erl.report_amount) rep_amount
                from con_document_flows cdf, exp_report_lines erl
               where erl.exp_report_header_id = p_exp_report_header_id
                 and erl.exp_report_header_id = cdf.source_document_id(+)
                 and erl.exp_report_line_id = cdf.source_document_line_id(+)
                 and cdf.document_type(+) = 'CON_CONTRACT'
                 and cdf.source_document_type(+) = 'EXP_REPORT_LINES'
               group by cdf.document_id, cdf.document_line_id;
  
      begin
  
          for rec in cur_rec loop
              if rec.document_id is null then
                  select sum(nvl(ps.due_amount, 0))
                    into v_total_pmt_amt
                    from exp_report_pmt_schedules ps
                   where ps.exp_report_header_id = p_exp_report_header_id
                     and not exists
                   (select 1
                            from con_document_flows df
                           where df.source_document_type =
                                 'EXP_REPORT_PMT_SCHEDULES'
                             and df.document_type = 'CON_CONTRACT'
                             and df.source_document_line_id =
                                 ps.payment_schedule_line_id
                             and df.source_document_id =
                                 p_exp_report_header_id);
  
                  if nvl(rec.rep_amount, 0) <> nvl(v_total_pmt_amt, 0) then
                      return 'N';
  
                  end if;
  
              else
                  if rec.document_line_id is not null then
                      select sum(nvl(ps.due_amount, 0))
                        into v_total_pmt_amt
                        from exp_report_pmt_schedules ps
                       where ps.payment_schedule_line_id in
                             (select df.source_document_line_id
                                from con_document_flows df
                               where df.document_id = rec.document_id
                                 and df.document_line_id =
                                     rec.document_line_id
                                 and df.source_document_type =
                                     'EXP_REPORT_PMT_SCHEDULES'
                                 and df.source_document_id =
                                     p_exp_report_header_id
                                 and df.document_type = 'CON_CONTRACT');
  
                  else
                      select sum(nvl(ps.due_amount, 0))
                        into v_total_pmt_amt
                        from exp_report_pmt_schedules ps
                       where ps.payment_schedule_line_id in
                             (select df.source_document_line_id
                                from con_document_flows df
                               where df.document_id = rec.document_id
                                 and df.source_document_type =
                                     'EXP_REPORT_PMT_SCHEDULES'
                                 and df.source_document_id =
                                     p_exp_report_header_id
                                 and df.document_type = 'CON_CONTRACT');
  
                  end if;
  
                  if nvl(rec.rep_amount, 0) <> nvl(v_total_pmt_amt, 0) then
                      return 'N';
  
                  end if;
  
              end if;
  
          end loop;
  
          return 'Y';
  
      end check_report_pmt_line;
  */
  FUNCTION check_report_pmt_line(p_exp_report_header_id NUMBER)
    RETURN VARCHAR2 AS
    v_rep_pmt_amount  NUMBER;
    v_rep_line_amount NUMBER;
  BEGIN
    --当前报销单存在合同信息的行的金额进行比对
    FOR cons IN (SELECT cdf.document_id,
                        cdf.document_line_id,
                        SUM(l.report_amount) AS sum_amount
                   FROM con_document_flows cdf, exp_report_lines l
                  WHERE cdf.source_document_type = 'EXP_REPORT_LINES'
                    AND cdf.source_document_id = p_exp_report_header_id
                    AND l.exp_report_header_id = p_exp_report_header_id
                    AND cdf.source_document_line_id = l.exp_report_line_id
                  GROUP BY cdf.document_id, cdf.document_line_id) LOOP
      SELECT nvl(SUM(ps.due_amount), 0)
        INTO v_rep_pmt_amount
        FROM con_document_flows df, exp_report_pmt_schedules ps
       WHERE df.source_document_type = 'EXP_REPORT_PMT_SCHEDULES'
         AND df.source_document_id = p_exp_report_header_id
         AND df.source_document_line_id = ps.payment_schedule_line_id
         AND ps.exp_report_header_id = p_exp_report_header_id
         AND df.document_id = cons.document_id
         AND ((cons.document_line_id IS NOT NULL AND
             df.document_line_id = cons.document_line_id) OR
             (cons.document_line_id IS NULL AND
             df.document_line_id IS NULL));
    
      IF cons.sum_amount != v_rep_pmt_amount THEN
        RETURN 'N';
      END IF;
    END LOOP;
  
    --当前报销单不存在合同信息的行的金额进行比对
    SELECT nvl(SUM(l.report_amount), 0)
      INTO v_rep_line_amount
      FROM exp_report_lines l
     WHERE l.exp_report_header_id = p_exp_report_header_id
       AND l.exp_report_line_id NOT IN
           (SELECT cdf.document_line_id
              FROM con_document_flows cdf
             WHERE cdf.source_document_id = p_exp_report_header_id
               AND cdf.source_document_type = 'EXP_REPORT_LINES');
  
    SELECT nvl(SUM(s.due_amount), 0)
      INTO v_rep_pmt_amount
      FROM exp_report_pmt_schedules s
     WHERE s.exp_report_header_id = p_exp_report_header_id
       AND s.payment_schedule_line_id NOT IN
           (SELECT cdf.document_line_id
              FROM con_document_flows cdf
             WHERE cdf.source_document_id = p_exp_report_header_id
               AND cdf.source_document_type = 'EXP_REPORT_PMT_SCHEDULES');
  
    IF v_rep_line_amount != v_rep_pmt_amount THEN
      RETURN 'N';
    END IF;
  
    RETURN 'Y';
  
  END check_report_pmt_line;

  --计划付款行金额校验
  PROCEDURE report_pmt_check(p_exp_report_header_id NUMBER,
                             p_flag                 OUT VARCHAR2,
                             p_user_id              NUMBER) IS
    v_line_amount NUMBER;
    v_pmt_amount  NUMBER(38, 2);
    v_check_flag  VARCHAR2(1);
  BEGIN
    SELECT nvl(SUM(e.report_amount), 0)
      INTO v_line_amount
      FROM exp_report_lines e
     WHERE e.exp_report_header_id = p_exp_report_header_id;
    SELECT nvl(SUM(e.due_amount), 0)
      INTO v_pmt_amount
      FROM exp_report_pmt_schedules e
     WHERE e.exp_report_header_id = p_exp_report_header_id;
    IF (v_line_amount != v_pmt_amount) THEN
      p_flag := 'N';
    ELSE
      p_flag := 'Y';
      -- 校验报销单每行行金额，是否与行的合同和合同资金行对应的  计划付款行金额是否相等 add by dzc
      /*v_check_flag := check_report_pmt_line(p_exp_report_header_id => p_exp_report_header_id);
      
      if v_check_flag = 'N' then
        p_flag := 'N';
      else
        
        p_flag := 'Y';      
      end if;*/ --Qu yuanyuan注释合同金额相关校验
    
    END IF;
  
  EXCEPTION
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'report_pmt_check');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END;

  --删除计划付款行相关
  FUNCTION delete_rep_pmt_schedule(p_exp_report_header_id NUMBER,
                                   p_user_id              NUMBER)
    RETURN VARCHAR2 IS
    v_old_pmt_schedule_line_id NUMBER;
    v_document_id              NUMBER;
    v_document_line_id         NUMBER;
    v_exists                   NUMBER;
    v_del_flag                 VARCHAR2(1);
  BEGIN
    DELETE FROM exp_report_pmt_schedules s
     WHERE s.exp_report_header_id = p_exp_report_header_id
       AND NOT EXISTS
     (SELECT 1
              FROM (SELECT h.exp_report_header_id,
                           h.currency_code,
                           e.account_number,
                           e.account_name,
                           h.payment_method_id,
                           SUM(l.report_amount) report_amount,
                           h.company_id,
                           h.description,
                           h.payee_category,
                           h.payee_id,
                           d.document_id,
                           d.document_line_id
                      FROM exp_report_lines         l,
                           exp_report_headers       h,
                           con_document_flows       d,
                           exp_report_pmt_schedules e
                     WHERE h.exp_report_header_id = p_exp_report_header_id
                       AND l.payment_flag = 'Y'
                       AND h.exp_report_header_id = l.exp_report_header_id
                       AND d.document_type(+) = 'CON_CONTRACT'
                       AND d.source_document_type(+) = 'EXP_REPORT_LINES'
                       AND d.source_document_id(+) = l.exp_report_header_id
                       AND d.source_document_line_id(+) =
                           l.exp_report_line_id
                       AND e.exp_report_header_id(+) = l.exp_report_header_id
                     GROUP BY h.exp_report_header_id,
                              h.currency_code,
                              e.account_number,
                              e.account_name,
                              h.payment_method_id,
                              h.description,
                              h.company_id,
                              h.payee_category,
                              h.payee_id,
                              d.document_id,
                              d.document_line_id) t
             WHERE t.currency_code = s.currency
               AND t.payee_category = s.payee_category
               AND t.payee_id = s.payee_id
               AND t.payment_method_id = s.payment_type_id
               AND t.account_number = s.account_number
               AND t.account_name = s.account_name
               AND t.company_id = s.company_id);
  
    FOR v_pmt_lines IN (SELECT *
                          FROM exp_report_pmt_schedules p
                         WHERE p.exp_report_header_id =
                               p_exp_report_header_id) LOOP
      --取原计划付款关联的合同
      BEGIN
        SELECT d.document_id, d.document_line_id
          INTO v_document_id, v_document_line_id
          FROM con_document_flows d
         WHERE d.document_type = 'CON_CONTRACT'
           AND d.source_document_type = 'EXP_REPORT_PMT_SCHEDULES'
           AND d.source_document_id = p_exp_report_header_id
           AND d.source_document_line_id =
               v_pmt_lines.payment_schedule_line_id;
      EXCEPTION
        WHEN no_data_found THEN
          v_document_id      := NULL;
          v_document_line_id := NULL;
      END;
    
      BEGIN
        SELECT 1
          INTO v_exists
          FROM dual
         WHERE EXISTS
         (SELECT 1
                  FROM (SELECT h.exp_report_header_id,
                               h.currency_code,
                               e.account_number,
                               e.account_name,
                               h.payment_method_id,
                               SUM(l.report_amount) report_amount,
                               h.company_id,
                               h.description,
                               h.payee_category,
                               h.payee_id,
                               d.document_id,
                               d.document_line_id
                          FROM exp_report_lines         l,
                               exp_report_headers       h,
                               con_document_flows       d,
                               exp_report_pmt_schedules e
                         WHERE h.exp_report_header_id =
                               p_exp_report_header_id
                           AND l.payment_flag = 'Y'
                           AND h.exp_report_header_id =
                               l.exp_report_header_id
                           AND d.document_type(+) = 'CON_CONTRACT'
                           AND d.source_document_type(+) = 'EXP_REPORT_LINES'
                           AND d.source_document_id(+) =
                               l.exp_report_header_id
                           AND d.source_document_line_id(+) =
                               l.exp_report_line_id
                           AND e.exp_report_header_id(+) =
                               l.exp_report_header_id
                         GROUP BY h.exp_report_header_id,
                                  h.currency_code,
                                  e.account_number,
                                  e.account_name,
                                  h.payment_method_id,
                                  h.description,
                                  h.company_id,
                                  h.payee_category,
                                  h.payee_id,
                                  d.document_id,
                                  d.document_line_id) nt
                 WHERE 1 = 1
                   AND v_pmt_lines.currency = nt.currency_code
                   AND v_pmt_lines.payee_category = nt.payee_category
                   AND v_pmt_lines.payee_id = nt.payee_id
                   AND v_pmt_lines.payment_type_id = nt.payment_method_id
                   AND v_pmt_lines.account_number = nt.account_number
                   AND v_pmt_lines.account_name = nt.account_name
                   AND v_pmt_lines.company_id = nt.company_id
                   AND nvl(v_document_id, -0.99) =
                       nvl(nt.document_id, -0.99)
                   AND nvl(v_document_line_id, -0.99) =
                       nvl(nt.document_line_id, -0.99));
      
      EXCEPTION
        WHEN no_data_found THEN
          DELETE FROM exp_report_pmt_schedules p
           WHERE p.payment_schedule_line_id =
                 v_pmt_lines.payment_schedule_line_id;
      END;
    
    END LOOP;
  
    DELETE FROM con_document_flows d
     WHERE d.document_type = 'CON_CONTRACT'
       AND d.source_document_type = 'EXP_REPORT_PMT_SCHEDULES'
       AND d.source_document_id = p_exp_report_header_id
       AND d.source_document_line_id NOT IN
           (SELECT s.payment_schedule_line_id
              FROM exp_report_pmt_schedules s
             WHERE s.exp_report_header_id = p_exp_report_header_id);
  
    v_del_flag := NULL;
    FOR v_write_off IN (SELECT w.write_off_id
                          FROM csh_write_off w
                         WHERE w.document_source = 'EXPENSE_REPORT'
                           AND w.document_header_id = p_exp_report_header_id
                           AND w.document_line_id NOT IN
                               (SELECT s.payment_schedule_line_id
                                  FROM exp_report_pmt_schedules s
                                 WHERE s.exp_report_header_id =
                                       p_exp_report_header_id)) LOOP
      delete_csh_write_off(p_write_off_id => v_write_off.write_off_id,
                           p_user_id      => p_user_id);
      v_del_flag := 'Y';
    END LOOP;
  
    IF v_del_flag = 'Y' THEN
      RETURN(sys_message_pkg.get_string('EXP_REP_DEL_CSH_WRITE_OFF_CLEW'));
    ELSE
      RETURN NULL;
    END IF;
  
  END delete_rep_pmt_schedule;

  PROCEDURE update_exp_rep_pmt_schedules(p_exp_report_header_id     NUMBER,
                                         p_payment_schedule_line_id NUMBER,
                                         p_schedule_start_date      DATE,
                                         p_schedule_due_date        DATE,
                                         p_payee_category           VARCHAR2,
                                         p_payee_id                 NUMBER,
                                         p_due_amount               NUMBER,
                                         p_account_number           VARCHAR2,
                                         p_account_name             VARCHAR2,
                                         p_payment_type_id          NUMBER,
                                         p_bank_code                VARCHAR2,
                                         p_bank_name                VARCHAR2,
                                         p_bank_location_code       VARCHAR2,
                                         p_bank_location_name       VARCHAR2,
                                         p_province_code            VARCHAR2,
                                         p_province_name            VARCHAR2,
                                         p_city_code                VARCHAR2,
                                         p_city_name                VARCHAR2,
                                         p_usedes                   VARCHAR2,
                                         p_document_id              NUMBER,
                                         p_document_line_id         NUMBER,
                                         p_user_id                  NUMBER,
                                         --modify 修改操作时的frozen_flag
                                         p_frozen_flag VARCHAR2,
                                         --add wgf 2012/12/28
                                         p_description VARCHAR2,
                                         --modify by Qu yuanyuan 增加托收账户字段
                                         p_collection_account_id NUMBER,
                                         p_gather_flag           VARCHAR2 DEFAULT 1) IS
  
    /*v_bank_code            varchar2(30);
    v_bank_name            varchar2(200);
    v_account_number       varchar2(200);
    v_account_name         varchar2(200);
    v_bank_location_code   varchar2(30);
    v_bank_location_name   varchar2(200);
    v_province_code        varchar2(30);
    v_province_name        varchar2(200);
    v_city_code            varchar2(30);
    v_city_name            varchar2(200);
    v_usedes               varchar2(30);*/
    --modify 增加局部变量
    v_frozen_flag_before       VARCHAR2(1);
    v_frozen_flag_update       VARCHAR2(1);
    v_check_flag               VARCHAR2(1);
    v_exp_report_pmt_schedules exp_report_pmt_schedules%ROWTYPE;
    e_pmt_sch_ln_occur_wf_error EXCEPTION;
  
    v_count_s            NUMBER;
    v_cash_flow_item_id  NUMBER;
    v_pur_system_venders pur_system_venders%ROWTYPE;
    --v_company_id         NUMBER;
    v_count NUMBER;
    e_different_con exception;
  BEGIN
  
    SELECT *
      INTO v_exp_report_pmt_schedules
      FROM exp_report_pmt_schedules s
     WHERE s.payment_schedule_line_id = p_payment_schedule_line_id;
  
    --如果计划付款行发生核销收款方信息不允许改变
    v_check_flag := check_pmt_schedule_ln_occur_wf(p_payment_schedule_line_id => p_payment_schedule_line_id);
  
    IF v_check_flag = 'N' THEN
      IF (v_exp_report_pmt_schedules.payee_category <> p_payee_category) OR
         (v_exp_report_pmt_schedules.payee_id <> p_payee_id) THEN
        RAISE e_pmt_sch_ln_occur_wf_error;
      END IF;
    
    END IF;
  
    --added by lyh  2017.5.25
    --合同维护的供应商，在提交后，如果公司级供应商中没有，则分配,并插入维护表
    /*FOR cur_ptm IN (SELECT e.company_id
                      FROM exp_report_pmt_schedules e
                     WHERE e.exp_report_header_id = p_exp_report_header_id) LOOP
      IF (p_payee_category = 'VENDER') THEN
        insert_exp_report_vender(p_payee_id   => p_payee_id,
                                 p_company_id => cur_ptm.company_id,
                                 p_user_id    => p_user_id);
      END IF;
    END LOOP;*/
  
    BEGIN
      IF p_usedes IS NOT NULL THEN
      
        SELECT cdf.cash_flow_item_id
          INTO v_cash_flow_item_id
          FROM csh_default_flowitems cdf
         WHERE cdf.default_code = p_usedes
           AND cdf.default_flag = 'Y'
           AND cdf.default_type = 'PAYMENT_USEDES';
      ELSE
        v_cash_flow_item_id := '';
      END IF;
    EXCEPTION
      WHEN no_data_found THEN
        v_cash_flow_item_id := '';
    END;
  
    --Modify by Sandy 20130225  注释 update_status_check
    --目的：报销单凭证调整页面 可以修改计划付款行
    -- IF update_status_check(p_exp_report_header_id, p_user_id) = 'Y' THEN
    --存取未修改前的frozen_flag的值
    SELECT nvl(t.frozen_flag, 'N')
      INTO v_frozen_flag_before
      FROM exp_report_pmt_schedules t
     WHERE t.payment_schedule_line_id = p_payment_schedule_line_id;
    --存当前要修改的frozen_flag的值
    v_frozen_flag_update := nvl(p_frozen_flag, 'N');
    UPDATE exp_report_pmt_schedules s
       SET s.last_updated_by     = p_user_id,
           s.last_update_date    = SYSDATE,
           s.schedule_start_date = p_schedule_start_date,
           s.schedule_due_date   = p_schedule_due_date,
           s.payee_category      = p_payee_category,
           s.payee_id            = p_payee_id,
           s.due_amount          = p_due_amount,
           s.account_number      = p_account_number,
           s.account_name        = p_account_name,
           s.payment_type_id     = p_payment_type_id,
           s.bank_code           = p_bank_code,
           s.bank_name           = p_bank_name,
           s.bank_location_code  = p_bank_location_code,
           s.bank_location_name  = p_bank_location_name,
           s.province_code       = p_province_code,
           s.province_name       = p_province_name,
           s.city_code           = p_city_code,
           s.city_name           = p_city_name,
           s.usedes              = p_usedes,
           --modify  修改frozen_flag字段
           s.frozen_flag = p_frozen_flag,
           --add wgf 2012/12/28
           s.description           = p_description,
           s.cash_flow_code        = v_cash_flow_item_id, --Modify by 20130225 添加现金流量项
           s.collection_account_id = p_collection_account_id, --modify by Qu yuanyuan 增加托收账户字段
           s.gather_flag           = p_gather_flag
     WHERE s.payment_schedule_line_id = p_payment_schedule_line_id;
  
    --Modify By zhouhao 2014年10月14日15:45:21
    --报销单计划付款行修改后重置核销状态，重置核销状态的代码如果在更改金额之前，那么判断计付金额会以原金额判断，逻辑错误
    --重置现金事务核销状态
    csh_write_off_pkg.set_exp_rep_write_off_status(p_exp_report_header_id => p_exp_report_header_id,
                                                   p_user_id              => p_user_id);
  
    DELETE FROM con_document_flows d
     WHERE d.document_type = 'CON_CONTRACT'
       AND d.source_document_type = 'EXP_REPORT_PMT_SCHEDULES'
       AND d.source_document_id = p_exp_report_header_id
       AND d.source_document_line_id NOT IN
           (SELECT s.payment_schedule_line_id
              FROM exp_report_pmt_schedules s
             WHERE s.exp_report_header_id = p_exp_report_header_id);
  
    --add wgf 2013/1/9 计划付款行合同信息的更新
    SELECT COUNT(1)
      INTO v_count
      FROM con_document_flows cdf
     WHERE cdf.document_type = 'CON_CONTRACT'
       AND cdf.source_document_type = 'EXP_REPORT_PMT_SCHEDULES'
       AND cdf.source_document_id = p_exp_report_header_id
       AND cdf.source_document_line_id = p_payment_schedule_line_id;
  
    IF v_count = 1 AND p_document_id IS NULL THEN
      DELETE con_document_flows cdf
       WHERE cdf.source_document_id = p_exp_report_header_id
         AND cdf.source_document_line_id = p_payment_schedule_line_id;
    END IF;
  
    IF v_count = 0 AND p_document_id IS NOT NULL THEN
    
      con_contract_maintenance_pkg.insert_con_document_flows(p_document_type           => 'CON_CONTRACT',
                                                             p_document_id             => p_document_id,
                                                             p_document_line_id        => p_document_line_id,
                                                             p_source_document_type    => 'EXP_REPORT_PMT_SCHEDULES',
                                                             p_source_document_id      => p_exp_report_header_id,
                                                             p_source_document_line_id => p_payment_schedule_line_id,
                                                             p_user_id                 => p_user_id);
      --更新头合同
      update exp_report_headers h
         set h.contract_header_id = p_document_id,
             h.last_updated_by    = p_user_id,
             h.last_update_date   = sysdate
       where h.exp_report_header_id = p_exp_report_header_id;
    END IF;
  
    IF v_count = 1 AND p_document_id IS NOT NULL THEN
    
      UPDATE con_document_flows cdf
         SET cdf.document_id      = p_document_id,
             cdf.document_line_id = p_document_line_id,
             cdf.last_updated_by  = p_user_id,
             cdf.last_update_date = SYSDATE
       WHERE cdf.source_document_id = p_exp_report_header_id
         AND cdf.source_document_line_id = p_payment_schedule_line_id;
       
       --更新头合同
      update exp_report_headers h
         set h.contract_header_id = p_document_id,
             h.last_updated_by    = p_user_id,
             h.last_update_date   = sysdate
       where h.exp_report_header_id = p_exp_report_header_id;  
    END IF;
    --end
    /*IF p_document_id IS NOT NULL THEN
      con_contract_maintenance_pkg.insert_con_document_flows(p_document_type           => 'CON_CONTRACT',
                                                             p_document_id             => p_document_id,
                                                             p_document_line_id        => p_document_line_id,
                                                             p_source_document_type    => 'EXP_REPORT_PMT_SCHEDULES',
                                                             p_source_document_id      => p_exp_report_header_id,
                                                             p_source_document_line_id => p_payment_schedule_line_id,
                                                             p_user_id                 => p_user_id);
    END IF;*/
    --Modify by Sandy 20130225  注释 update_status_check
    --目的：报销单凭证调整页面 可以修改计划付款行
    --  END IF;
    --如果frozen_flag变动，修改当前单据状态
    --IF v_frozen_flag_before != v_frozen_flag_update THEN
    create_csh_doc_payment_company(p_exp_report_header_id => p_exp_report_header_id,
                                   p_user_id              => p_user_id);
  
    --END IF;
  EXCEPTION
    WHEN e_different_con THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => '同一报销单下，合同唯一！',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'update_exp_rep_pmt_schedules');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    
    WHEN e_pmt_sch_ln_occur_wf_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'PMT_SCHEDULE_LN_OCCUR_WF_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'update_exp_rep_pmt_schedules');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'update_exp_rep_pmt_schedules');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    
  END update_exp_rep_pmt_schedules;

  PROCEDURE update_exp_rep_pmt_sch_adjust(p_exp_report_header_id     NUMBER,
                                          p_payment_schedule_line_id NUMBER,
                                          p_cash_flow_item_id        NUMBER,
                                          p_user_id                  NUMBER) IS
  
  BEGIN
  
    UPDATE exp_report_pmt_schedules es
       SET es.last_updated_by  = p_user_id,
           es.last_update_date = SYSDATE,
           es.cash_flow_code   = p_cash_flow_item_id --Modify by 20130225 添加现金流量项
     WHERE es.exp_report_header_id = p_exp_report_header_id
       AND es.payment_schedule_line_id = p_payment_schedule_line_id;
  EXCEPTION
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'update_exp_rep_pmt_sch_adjust');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    
  END update_exp_rep_pmt_sch_adjust;
  -- sqh 20140401 计划付款行银行账号信息可维护
  PROCEDURE update_exp_rep_pmt_sch_bank(p_exp_report_header_id     NUMBER,
                                        p_payment_schedule_line_id NUMBER,
                                        p_account_number           VARCHAR2,
                                        p_account_name             VARCHAR2,
                                        
                                        p_bank_code          VARCHAR2,
                                        p_bank_name          VARCHAR2,
                                        p_bank_location_code VARCHAR2,
                                        p_bank_location_name VARCHAR2,
                                        p_province_code      VARCHAR2,
                                        p_province_name      VARCHAR2,
                                        p_city_code          VARCHAR2,
                                        p_city_name          VARCHAR2,
                                        p_user_id            NUMBER) IS
  
  BEGIN
  
    UPDATE exp_report_pmt_schedules es
       SET es.last_updated_by    = p_user_id,
           es.last_update_date   = SYSDATE,
           es.account_number     = p_account_number,
           es.account_name       = p_account_name,
           es.bank_code          = p_bank_code,
           es.bank_name          = p_bank_name,
           es.bank_location_code = p_bank_location_code,
           es.bank_location_name = p_bank_location_name,
           es.province_code      = p_province_code,
           es.province_name      = p_province_name,
           es.city_code          = p_city_code,
           es.city_name          = p_city_name
     WHERE es.exp_report_header_id = p_exp_report_header_id
       AND es.payment_schedule_line_id = p_payment_schedule_line_id;
  EXCEPTION
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'update_exp_rep_pmt_sch_bank');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    
  END update_exp_rep_pmt_sch_bank;

  PROCEDURE delete_exp_report_dists(p_line_id NUMBER,
                                    p_dist_id NUMBER,
                                    p_user_id NUMBER) IS
    v_document_id NUMBER;
  BEGIN
    v_document_id := get_document_id(p_line_id);
  
    IF delete_data_check(v_document_id) = 'Y' THEN
      DELETE FROM exp_report_dists ds
       WHERE ds.exp_report_line_id = p_line_id
         AND exp_report_dists_id = p_dist_id;
    
      DELETE FROM bgt_budget_reserves t
       WHERE t.business_type = c_exp_report
         AND t.document_id = v_document_id
         AND t.document_line_id = p_dist_id;
    
      DELETE FROM con_document_flows t
       WHERE t.document_type = 'CON_CONTRACT'
         AND t.source_document_type = 'EXP_REPORT_DISTS'
         AND t.source_document_id = v_document_id
         AND t.source_document_line_id = p_line_id
         AND t.source_document_dists_id = p_dist_id;
    
      --删除报销单与申请单相关
      del_released_budget_reserves(p_document_id      => '',
                                   p_document_line_id => '',
                                   p_document_dist_id => p_dist_id,
                                   p_user_id          => p_user_id);
    
      --删除政策相关事件
      del_tp_released_reserves(p_document_id      => '',
                               p_document_line_id => '',
                               p_document_dist_id => p_dist_id,
                               p_user_id          => p_user_id);
    
    END IF;
  
  EXCEPTION
    WHEN e_lock_table THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_LOCK_RECORD_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'delete_exp_report_dists');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_delete_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_DELETE_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'delete_exp_report_dists');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END delete_exp_report_dists;

  PROCEDURE error_log(p_log_text_code VARCHAR2) IS
    PRAGMA AUTONOMOUS_TRANSACTION;
  BEGIN
    INSERT INTO exp_expense_report_error_logs t
      (batch_id,
       exp_report_number,
       line_number,
       exp_report_dists_id,
       operation_code,
       log_text_code,
       created_by,
       creation_date)
    VALUES
      (g_batch_id,
       g_exp_report_number,
       g_line_number,
       g_exp_report_dists_id,
       g_operation_code,
       p_log_text_code,
       g_user_id,
       SYSDATE);
    COMMIT;
  END error_log;

  PROCEDURE delete_error_log IS
    PRAGMA AUTONOMOUS_TRANSACTION;
  BEGIN
    DELETE FROM exp_expense_report_error_logs t
     WHERE t.batch_id = g_batch_id;
    COMMIT;
  END delete_error_log;

  FUNCTION get_journal_date(p_expense_report_header_id NUMBER) RETURN DATE IS
    v_journal_date DATE;
  BEGIN
    SELECT v.journal_date
      INTO v_journal_date
      FROM exp_report_accounts v
     WHERE v.exp_report_dists_id =
           (SELECT d.exp_report_dists_id
              FROM exp_report_lines t, exp_report_dists d
             WHERE t.exp_report_line_id = d.exp_report_line_id
               AND t.exp_report_header_id = p_expense_report_header_id
               AND rownum = 1)
       AND rownum = 1;
    RETURN v_journal_date;
  END get_journal_date;

  --借代平衡校验
  PROCEDURE exp_report_dists_balance_check(p_exp_report_header_id NUMBER,
                                           p_user_id              NUMBER) IS
    v_entered_amount    NUMBER;
    v_functional_amount NUMBER;
    e_amount_balance_error EXCEPTION;
  BEGIN
    SELECT nvl(SUM(a.entered_amount_dr), 0) -
           nvl(SUM(a.entered_amount_cr), 0),
           nvl(SUM(a.functional_amount_dr), 0) -
           nvl(SUM(a.functional_amount_cr), 0)
      INTO v_entered_amount, v_functional_amount
      FROM exp_report_accounts a
     WHERE a.exp_report_header_id = p_exp_report_header_id;
  
    IF v_entered_amount <> 0 OR v_functional_amount <> 0 THEN
      RAISE e_amount_balance_error;
    END IF;
  EXCEPTION
    WHEN e_amount_balance_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_ACCOUNT_AMOUNT_BALANCE_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'exp_report_dists_balance_check');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END exp_report_dists_balance_check;

  PROCEDURE set_exp_report_recheck_flag(p_user_id              NUMBER,
                                        p_audit_date           DATE,
                                        p_sys_parameter_code   VARCHAR2,
                                        p_exp_report_header_id NUMBER) IS
  
  BEGIN
    UPDATE exp_report_lines t
       SET t.audit_flag       = 'Y',
           t.audit_date       = SYSDATE, --审核日期为当前日期，不是凭证日期
           t.last_updated_by  = p_user_id,
           t.last_update_date = SYSDATE
     WHERE t.exp_report_header_id = p_exp_report_header_id;
  
    UPDATE exp_report_headers t
       SET t.audit_flag         = 'Y',
           t.audit_date         = SYSDATE,
           t.last_updated_by    = p_user_id,
           t.last_update_date   = SYSDATE,
           t.gld_interface_flag = 'P'
     WHERE t.exp_report_header_id = p_exp_report_header_id;
  EXCEPTION
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'EXP_REPORT_PKG',
                                                     p_procedure_function_name => 'set_exp_report_recheck_flag');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    
  END;

  --校验发票
  PROCEDURE check_invoice(p_exp_report_header_id NUMBER,
                          p_user_id              NUMBER,
                          p_raise_error          VARCHAR2 DEFAULT 'Y') IS
    v_count                  NUMBER;
    v_input_certificate_id   NUMBER;
    v_vat_input_certificates vat_input_certificates%ROWTYPE;
  BEGIN
  
    -------------------------- 认证部分-------------------------------
    FOR c1 IN (SELECT SUM(l.report_amount) report_amount,
                      l.invoice_code,
                      l.invoice_number,
                      tp.special_invoice,
                      l.invoice_status
                 FROM exp_report_lines      l,
                      exp_ygz_invoice_types tp,
                      fnd_companies         fc,
                      exp_report_headers    h
                WHERE l.exp_report_header_id = p_exp_report_header_id
                  AND tp.type_code = l.invoice_type
                  AND fc.company_id = l.company_id
                  AND l.exp_report_header_id = h.exp_report_header_id
                GROUP BY l.invoice_code,
                         l.invoice_number,
                         tp.special_invoice,
                         l.invoice_status) LOOP
    
      -- 认证 2. 专票 3.未认证
      IF (c1.special_invoice = 'Y' AND c1.invoice_status IN ('20', '40')) THEN
        BEGIN
          SELECT *
            INTO v_vat_input_certificates
            FROM vat_input_certificates vi
           WHERE vi.invoice_code = c1.invoice_code
             AND vi.invoice_number = c1.invoice_number;
        
          IF (v_vat_input_certificates.total_amount = c1.report_amount) THEN
            UPDATE exp_report_lines l
               SET l.invoice_status      = '30',
                   l.authentication_time = trunc(SYSDATE),
                   l.last_updated_by     = p_user_id,
                   l.last_update_date    = SYSDATE
             WHERE l.exp_report_header_id = p_exp_report_header_id
               AND l.invoice_code = c1.invoice_code
               AND l.invoice_number = c1.invoice_number;
          
            UPDATE vat_input_certificates vi
               SET vi.match_date = trunc(SYSDATE), vi.match_status = 'Y'
             WHERE vi.input_certificate_id =
                   v_vat_input_certificates.input_certificate_id;
          
          ELSIF (v_vat_input_certificates.total_amount > c1.report_amount) THEN
            UPDATE exp_report_lines l
               SET l.invoice_status      = '50',
                   l.authentication_time = trunc(SYSDATE),
                   l.last_updated_by     = p_user_id,
                   l.last_update_date    = SYSDATE
             WHERE l.exp_report_header_id = p_exp_report_header_id
               AND l.invoice_code = c1.invoice_code
               AND l.invoice_number = c1.invoice_number;
          
            UPDATE vat_input_certificates vi
               SET vi.match_date = trunc(SYSDATE), vi.match_status = 'Y'
             WHERE vi.input_certificate_id =
                   v_vat_input_certificates.input_certificate_id;
          END IF;
        EXCEPTION
          WHEN no_data_found THEN
            NULL;
        END;
      END IF;
    
    END LOOP;
  
    ----------------------------------------- 校验部分 ------------------------------------------------
    FOR c2 IN (SELECT l.*,
                      fc.no_tax_sd_flag,
                      fc.taxpayer_flag,
                      tp.special_invoice,
                      h.exp_report_number,
                      fc.company_code
                 FROM exp_report_lines      l,
                      exp_ygz_invoice_types tp,
                      fnd_companies         fc,
                      exp_report_headers    h
                WHERE l.exp_report_header_id = p_exp_report_header_id
                  AND tp.type_code = l.invoice_type
                  AND fc.company_id = l.company_id
                  AND l.exp_report_header_id = h.exp_report_header_id) LOOP
    
      -- 校验条件 1.有税控盘的公司  2. 专票 3.未认证
      IF (nvl(c2.no_tax_sd_flag, 'N') = 'N' AND c2.special_invoice = 'Y' AND
         c2.invoice_status IN ('20', '40')) THEN
      
        IF (p_raise_error = 'Y') THEN
          sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '报销单行' ||
                                                                                      c2.line_number ||
                                                                                      '发票未认证通过!',
                                                         p_created_by              => p_user_id,
                                                         p_package_name            => 'EXP_REPORT_PKG',
                                                         p_procedure_function_name => 'check_invoice');
          raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                  sys_raise_app_error_pkg.g_err_line_id);
        ELSE
          UPDATE exp_report_lines l
             SET l.invoice_status   = '40',
                 l.last_updated_by  = p_user_id,
                 l.last_update_date = SYSDATE
           WHERE l.exp_report_line_id = c2.exp_report_line_id;
        END IF;
      END IF;
    END LOOP;
  END check_invoice;

  --工作台审核，调整凭证
  PROCEDURE update_audit_exp_report_acc(p_je_line_id               NUMBER,
                                        p_description              VARCHAR2,
                                        p_responsibility_center_id NUMBER,
                                        p_account_id               NUMBER,
                                        p_account_segment2         VARCHAR2,
                                        p_account_segment3         VARCHAR2,
                                        p_user_id                  NUMBER) IS
  BEGIN
    UPDATE exp_report_accounts e
       SET e.description              = nvl(p_description, e.description),
           e.responsibility_center_id = nvl(p_responsibility_center_id,
                                            e.responsibility_center_id),
           e.account_id               = nvl(p_account_id, e.account_id),
           e.account_segment2         = nvl(p_account_segment2,
                                            e.account_segment2),
           e.account_segment3         = nvl(p_account_segment3,
                                            e.account_segment3),
           e.last_updated_by          = p_user_id,
           e.last_update_date         = SYSDATE
     WHERE e.exp_report_je_line_id = p_je_line_id;
  END update_audit_exp_report_acc;

  -- 审核
  PROCEDURE audit_exp_report(p_exp_report_header_id NUMBER,
                             p_user_id              NUMBER,
                             p_journal_date         VARCHAR2,
                             p_report_status        VARCHAR2 DEFAULT 'COMPLETELY_APPROVED',
                             p_audit_opinion        VARCHAR2 DEFAULT NULL) IS
    v_je_creation_status          exp_report_headers.je_creation_status%TYPE;
    v_audit_flag                  exp_report_headers.audit_flag%TYPE;
    v_audit_date                  exp_report_headers.audit_date%TYPE;
    v_company_id                  NUMBER;
    v_period_name                 gld_periods.period_name%TYPE;
    v_exchange_rate_type          gld_exchange_rates.type_code%TYPE;
    v_exchange_rate               NUMBER;
    v_exchange_rate_quotation     gld_exchange_rates.exchange_rate_quotation%TYPE;
    v_exp_exchange_rate_type      VARCHAR2(30);
    v_exp_exchange_rate_quotation VARCHAR2(30);
    v_exp_exchange_rate           NUMBER;
    v_entered_amount              NUMBER;
    v_functional_amount           NUMBER;
    v_revaluation                 NUMBER;
    v_account_id                  NUMBER;
    v_write_off_je_line_id        NUMBER;
    v_write_off_account           csh_write_off_accounts%ROWTYPE;
    v_func_currency_code          VARCHAR2(30);
    v_transaction_line            csh_transaction_lines%ROWTYPE;
    v_concat_segments             VARCHAR2(2000);
    v_error_message               VARCHAR2(4000);
    v_invoice_status              VARCHAR2(10);
  
    e_ccid_error                EXCEPTION;
    e_je_creation_first         EXCEPTION;
    e_exchange_rate_type_error  EXCEPTION;
    e_revaluation_account_error EXCEPTION;
    e_period_not_open           EXCEPTION;
    v_parameter_value VARCHAR2(200);
    v_line_audit_flag exp_report_lines.audit_flag%TYPE;
    v_head_audit_flag exp_report_headers.audit_flag%TYPE;
    v_report_headers  exp_report_headers%ROWTYPE;
    e_vms_check_error EXCEPTION;
    v_vms_check_error_msg VARCHAR2(1000);
  BEGIN
    --校验发票 
    --Modified by Rick 2017-5-23 14:27:28   审核不修改发票状态 modify by wxq 20180409
    /* check_invoice(p_exp_report_header_id => p_exp_report_header_id,
    p_user_id              => p_user_id);*/
  
    /*************************************************
    -- Author  : MOUSE
    -- Created : 2015/12/17 18:10:13
    -- Ver     : 1.1
    -- Purpose : 报销单审核节点，验证CCID
    **************************************************/
    FOR je_lines IN (SELECT *
                       FROM exp_report_accounts a
                      WHERE a.exp_report_header_id = p_exp_report_header_id) LOOP
    
      gl_log_pkg.log(p_log_text => 'ccid为:' || je_lines.account_segment1 || '.' ||
                                   je_lines.account_segment2 || '.' ||
                                   je_lines.account_segment3 || '.' ||
                                   je_lines.account_segment4 || '.' ||
                                   je_lines.account_segment5 || '.' ||
                                   je_lines.account_segment6 || '.' ||
                                   je_lines.account_segment7 || '.' ||
                                   je_lines.account_segment8 || '.' ||
                                   je_lines.account_segment9 || '.' ||
                                   je_lines.account_segment10 || '.' ||
                                   je_lines.account_segment11,
                     p_user_id  => -1);
      /*v_error_message := cux_gl_interface_pkg.validate_ccid(p_concat_segments => je_lines.account_segment1 || '.' ||
      je_lines.account_segment2 || '.' ||
      je_lines.account_segment3 || '.' ||
      je_lines.account_segment4 || '.' ||
      je_lines.account_segment5 || '.' ||
      je_lines.account_segment6 || '.' ||
      je_lines.account_segment7 || '.' ||
      je_lines.account_segment8 || '.' ||
      je_lines.account_segment9 || '.' ||
      je_lines.account_segment10 || '.' ||
      je_lines.account_segment11);*/
    
      IF v_error_message IS NOT NULL THEN
        RAISE e_ccid_error;
      END IF;
    END LOOP;
  
    --取得复核标志的系统参数
    v_parameter_value := sys_parameter_pkg.value('EXP_REPORT_RECHECK');
  
    SELECT t.audit_flag, t.je_creation_status, t.company_id
      INTO v_audit_flag, v_je_creation_status, v_company_id
      FROM exp_report_headers t
     WHERE t.exp_report_header_id = p_exp_report_header_id
       AND t.report_status = p_report_status
       AND (nvl(t.audit_flag, 'N') = 'N' OR
           get_auto_audit_flag(t.exp_report_type_id) = 'Y')
    
       FOR UPDATE NOWAIT;
  
    IF v_je_creation_status != 'SUCCESS' THEN
      RAISE e_je_creation_first;
    END IF;
  
    --v_audit_date := get_journal_date(p_exp_report_header_id);
  
    IF to_date(p_journal_date, 'yyyy-mm-dd') = trunc(SYSDATE) THEN
      v_audit_date := to_date(p_journal_date, 'yyyy-mm-dd');
    ELSE
      v_audit_date := trunc(SYSDATE);
    END IF;
  
    --复核环节标志修改
  
    -- 期间
    v_period_name := gld_common_pkg.get_gld_period_name(p_company_id => v_company_id,
                                                        p_date       => v_audit_date);
    IF v_period_name IS NULL THEN
      RAISE e_period_not_open;
    END IF;
  
    --added by HM @2016-05-20 营改增――校验
    v_vms_check_error_msg := exp_report_recheck_check_vms(p_exp_report_header_id);
    IF v_vms_check_error_msg IS NOT NULL THEN
      RAISE e_vms_check_error;
    END IF;
  
    --借代平衡校验
    exp_report_dists_balance_check(p_exp_report_header_id => p_exp_report_header_id,
                                   p_user_id              => p_user_id);
  
    --创建报销单历史
    insert_exp_document_histories(p_document_type  => c_exp_report,
                                  p_document_id    => p_exp_report_header_id,
                                  p_operation_code => exp_document_history_pkg.c_audit, --'AUDIT',
                                  p_user_id        => p_user_id,
                                  p_operation_time => SYSDATE,
                                  p_description    => p_audit_opinion);
    /*
    UPDATE exp_report_dists t
       SET t.audit_flag       = 'Y',
           t.audit_date       = v_audit_date,
           t.last_updated_by  = p_user_id,
           t.last_update_date = SYSDATE
     WHERE t.exp_report_line_id IN
           (SELECT exp_report_line_id
              FROM exp_report_lines l
             WHERE l.exp_report_header_id = p_exp_report_header_id);*/
  
    SELECT h.*
      INTO v_report_headers
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
  
    --标志设置
    IF v_parameter_value = 'N' THEN
    
      --修改报销单头表的状态位修改
      UPDATE exp_report_headers t
         SET t.audit_flag         = 'Y',
             t.audit_date         = v_audit_date, --审核日期为复核通过的日期
             t.last_updated_by    = p_user_id,
             t.last_update_date   = SYSDATE,
             t.gld_interface_flag = 'P'
       WHERE t.exp_report_header_id = p_exp_report_header_id;
    
      --更改行上的状态
      UPDATE exp_report_lines t
         SET t.audit_flag       = 'Y',
             t.audit_date       = v_audit_date, --审核日期为复核通过的日期
             t.last_updated_by  = p_user_id,
             t.last_update_date = SYSDATE
       WHERE t.exp_report_header_id = p_exp_report_header_id;
    
      FOR c1 IN (SELECT erl.*
                   FROM exp_report_lines erl
                  WHERE erl.exp_report_header_id = p_exp_report_header_id
                    AND erl.invoice_code IS NOT NULL
                    AND erl.invoice_number IS NOT NULL) LOOP
        --更新专票库
        UPDATE exp_invoice_info eii
           SET eii.authentic_status  = '11', --抵扣
               eii.exp_report_number = v_report_headers.exp_report_number,
               eii.authentic_date    = SYSDATE,
               eii.last_update_by    = p_user_id,
               eii.last_update_time  = SYSDATE
         WHERE eii.invoice_code = c1.invoice_code
           AND eii.invoice_number = c1.invoice_number;
      
        --专票更新为抵扣状态
        IF c1.invoice_type = 'INV001' THEN
          v_invoice_status := '30';
        ELSE
          v_invoice_status := '';
        END IF;
        --更改行上的状态
        UPDATE exp_report_lines t
           SET t.invoice_status   = nvl(v_invoice_status, t.invoice_status), --抵扣
               t.audit_flag       = 'Y',
               t.audit_date       = v_audit_date, --审核日期为复核通过的日期  
               t.last_updated_by  = p_user_id,
               t.last_update_date = SYSDATE
         WHERE t.invoice_code = c1.invoice_code
           AND t.invoice_number = c1.invoice_number
           AND t.exp_report_header_id = p_exp_report_header_id;
      END LOOP;
    
      --更改分配行上的标记
      UPDATE exp_report_dists t
         SET t.audit_flag       = 'Y',
             t.audit_date       = v_audit_date, --审核日期为复核通过的日期
             t.last_updated_by  = p_user_id,
             t.last_update_date = SYSDATE
       WHERE t.exp_report_line_id IN
             (SELECT erl.exp_report_line_id
                FROM exp_report_lines erl
               WHERE erl.exp_report_header_id = p_exp_report_header_id);
    
      --更改凭证行状态
      UPDATE exp_report_accounts era
         SET era.gld_interface_flag = 'P',
             era.period_name        = v_period_name,
             era.journal_date       = v_audit_date,
             era.last_updated_by    = p_user_id,
             era.last_update_date   = SYSDATE
       WHERE era.exp_report_header_id = p_exp_report_header_id;
    
      --  add by dzc 如果 ‘保险单复核’系统标志 为Y ,表示需要复核,在审核这一步只叫保险单审核标志变成中间标志R，不做其他动作
    ELSIF v_parameter_value = 'Y' THEN
      --修改报销单头标记
      UPDATE exp_report_headers t
         SET t.audit_flag         = 'R',
             t.audit_date         = v_audit_date, --审核日期为复核通过的日期
             t.last_updated_by    = p_user_id,
             t.last_update_date   = SYSDATE,
             t.gld_interface_flag = 'P'
       WHERE t.exp_report_header_id = p_exp_report_header_id;
    
      --修改报销单行标记
      UPDATE exp_report_lines t
         SET t.audit_flag       = 'R',
             t.audit_date       = v_audit_date, --审核日期为复核通过的日期
             t.last_updated_by  = p_user_id,
             t.last_update_date = SYSDATE
       WHERE t.exp_report_header_id = p_exp_report_header_id;
    
      --修改分配行标记
      UPDATE exp_report_dists t
         SET t.audit_flag       = 'R',
             t.audit_date       = v_audit_date, --审核日期为复核通过的日期
             t.last_updated_by  = p_user_id,
             t.last_update_date = SYSDATE
       WHERE t.exp_report_line_id IN
             (SELECT erl.exp_report_line_id
                FROM exp_report_lines erl
               WHERE erl.exp_report_header_id = p_exp_report_header_id);
      RETURN;
      --更改凭证行状态
      /*  UPDATE exp_report_accounts era
        SET era.gld_interface_flag = 'P',
            era.last_updated_by    = p_user_id,
            era.last_update_date   = SYSDATE
      WHERE era.exp_report_header_id = p_exp_report_header_id;*/
    END IF;
  
    -- 报销单是否已被预付款核销，有的话更新核销日期，凭证日期
    FOR rec_write_off IN (SELECT w.*,
                                 (SELECT ctl.transaction_header_id
                                    FROM csh_transaction_lines ctl
                                   WHERE ctl.transaction_line_id =
                                         w.csh_transaction_line_id) csh_trx_header_id
                            FROM csh_write_off w
                           WHERE w.write_off_type =
                                 'PREPAYMENT_EXPENSE_REPORT'
                             AND w.document_source = 'EXPENSE_REPORT'
                             AND w.document_header_id =
                                 p_exp_report_header_id) LOOP
      --更新核销记录
      UPDATE csh_write_off w
         SET w.write_off_date     = v_audit_date,
             w.period_name        = v_period_name,
             w.gld_interface_flag = csh_write_off_pkg.c_gld_interface_flag_p,
             w.last_updated_by    = p_user_id,
             w.last_update_date   = SYSDATE
       WHERE w.write_off_id = rec_write_off.write_off_id;
    
      --如果该报销单被完全核销，更新报销单头上的完全核销日期
      UPDATE exp_report_headers h
         SET h.write_off_completed_date = v_audit_date
       WHERE h.exp_report_header_id = p_exp_report_header_id
         AND h.write_off_status = 'C'
         AND h.write_off_completed_date IS NOT NULL;
    
      --如果那条预付款事务被完全核销，更新被核销的预付款事务的完全核销日期
      UPDATE csh_transaction_headers h
         SET h.write_off_completed_date = v_audit_date
       WHERE h.transaction_header_id = rec_write_off.csh_trx_header_id
         AND h.write_off_flag = 'C'
         AND h.write_off_completed_date IS NOT NULL;
    
      SELECT *
        INTO v_write_off_account
        FROM csh_write_off_accounts a
       WHERE a.write_off_id = rec_write_off.write_off_id
         AND a.usage_code = 'PREPAYMENT_WRITE_OFF';
    
      v_func_currency_code := gld_common_pkg.get_company_currency_code(v_company_id);
    
      IF v_func_currency_code <> v_write_off_account.currency_code THEN
        SELECT era.exchange_rate,
               era.exchange_rate_type,
               era.exchange_rate_quotation
          INTO v_exchange_rate,
               v_exchange_rate_type,
               v_exchange_rate_quotation
          FROM exp_report_accounts era
         WHERE era.exp_report_header_id = p_exp_report_header_id
           AND rownum = 1;
      ELSE
        v_exchange_rate_type      := NULL;
        v_exchange_rate           := 1;
        v_exchange_rate_quotation := NULL;
      END IF;
      SELECT *
        INTO v_transaction_line
        FROM csh_transaction_lines l
       WHERE l.transaction_line_id = rec_write_off.csh_transaction_line_id;
      -- 计算本位币金额
      IF v_exchange_rate_quotation = 'DIRECT QUOTATION' THEN
        v_functional_amount := v_write_off_account.entered_amount_cr *
                               v_exchange_rate;
      ELSIF v_exchange_rate_quotation = 'INDIRECT QUOTATION' THEN
        v_functional_amount := v_write_off_account.entered_amount_cr *
                               (1 / v_exchange_rate);
      ELSE
        v_functional_amount := v_write_off_account.entered_amount_cr *
                               v_exchange_rate;
      END IF;
      -- 汇率差异
      v_revaluation := v_functional_amount;
      -- 本位币精度
      v_functional_amount := fnd_format_mask_pkg.get_gld_amount(p_currency_code   => gld_common_pkg.get_company_currency_code(p_company_id => v_company_id),
                                                                p_amount          => v_functional_amount,
                                                                p_set_of_books_id => gld_common_pkg.get_set_of_books_id(p_comany_id => v_company_id));
    
      --更新凭证行
      UPDATE csh_write_off_accounts a
         SET a.period_name          = v_period_name,
             a.exchange_rate_type   = v_exchange_rate_type,
             a.exchange_rate        = v_exchange_rate,
             a.functional_amount_cr = v_functional_amount,
             a.journal_date         = v_audit_date,
             a.gld_interface_flag   = csh_write_off_pkg.c_gld_interface_flag_p,
             a.last_updated_by      = p_user_id,
             a.last_update_date     = SYSDATE
       WHERE a.write_off_id = rec_write_off.write_off_id
         AND a.usage_code = 'PREPAYMENT_WRITE_OFF';
    
      /*select a.exchange_rate_type,
               a.exchange_rate_quotation,
               a.exchange_rate
          into v_exp_exchange_rate_type,
               v_exp_exchange_rate_quotation,
               v_exp_exchange_rate
          from exp_report_accounts a
         where exists (select 1
                  from exp_report_dists d, exp_report_lines l
                 where d.exp_report_dists_id = a.exp_report_dists_id
                   and d.exp_report_line_id = l.exp_report_line_id
                   and l.exp_report_header_id = p_exp_report_header_id)
           and exists (select 1
                  from csh_transaction_lines tl
                 where tl.currency_code = a.currency_code
                   and tl.transaction_line_id =
                       rec_write_off.csh_transaction_line_id)
           and rownum = 1
         group by a.exchange_rate_type,
                  a.exchange_rate_quotation,
                  a.exchange_rate;
      */
      SELECT h.exchange_rate_type,
             h.exchange_rate_quotation,
             h.exchange_rate
        INTO v_exp_exchange_rate_type,
             v_exp_exchange_rate_quotation,
             v_exp_exchange_rate
        FROM exp_report_headers h
       WHERE h.exp_report_header_id = p_exp_report_header_id;
    
      SELECT *
        INTO v_write_off_account
        FROM csh_write_off_accounts a
       WHERE a.write_off_id = rec_write_off.write_off_id
         AND a.usage_code = 'EMPLOYEE_EXPENSE_WRITE_OFF';
    
      IF v_exp_exchange_rate_quotation = 'DIRECT QUOTATION' THEN
        v_functional_amount := v_write_off_account.entered_amount_dr *
                               v_exp_exchange_rate;
      ELSIF v_exp_exchange_rate_quotation = 'INDIRECT QUOTATION' THEN
        v_functional_amount := v_write_off_account.entered_amount_dr *
                               (1 / v_exp_exchange_rate);
      ELSE
        v_functional_amount := v_write_off_account.entered_amount_dr *
                               v_exp_exchange_rate;
      END IF;
    
      v_revaluation := v_revaluation - v_functional_amount;
      -- 本位币精度
      v_functional_amount := fnd_format_mask_pkg.get_gld_amount(p_currency_code   => gld_common_pkg.get_company_currency_code(p_company_id => v_company_id),
                                                                p_amount          => v_functional_amount,
                                                                p_set_of_books_id => gld_common_pkg.get_set_of_books_id(p_comany_id => v_company_id));
      --更新凭证行
      UPDATE csh_write_off_accounts a
         SET a.period_name          = v_period_name,
             a.exchange_rate_type   = v_exp_exchange_rate_type,
             a.exchange_rate        = v_exp_exchange_rate,
             a.functional_amount_dr = v_functional_amount,
             a.journal_date         = v_audit_date,
             a.gld_interface_flag   = csh_write_off_pkg.c_gld_interface_flag_p,
             a.last_updated_by      = p_user_id,
             a.last_update_date     = SYSDATE
       WHERE a.write_off_id = rec_write_off.write_off_id
         AND a.usage_code = 'EMPLOYEE_EXPENSE_WRITE_OFF';
    
      IF v_revaluation > 0 THEN
        v_account_id := csh_transaction_pkg.get_revaluation_account(p_company_id    => v_company_id,
                                                                    p_currency_code => v_write_off_account.currency_code,
                                                                    p_user_id       => p_user_id);
        IF v_account_id IS NULL THEN
          RAISE e_revaluation_account_error;
        END IF;
        -- 汇率差异精度
        v_revaluation := fnd_format_mask_pkg.get_gld_amount(p_currency_code   => gld_common_pkg.get_company_currency_code(p_company_id => v_company_id),
                                                            p_amount          => v_revaluation,
                                                            p_set_of_books_id => gld_common_pkg.get_set_of_books_id(p_comany_id => v_company_id));
        -- 创建汇率差异凭证
        v_write_off_je_line_id := csh_write_off_pkg.get_csh_write_off_je_line_id;
        csh_write_off_pkg.insert_csh_write_off_accounts(p_write_off_id             => rec_write_off.write_off_id,
                                                        p_write_off_je_line_id     => v_write_off_je_line_id,
                                                        p_description              => NULL,
                                                        p_period_name              => v_period_name,
                                                        p_source_code              => 'PREPAYMENT_EXPENSE_REPORT',
                                                        p_company_id               => v_company_id,
                                                        p_responsibility_center_id => gld_common_pkg.get_default_resp_center_id(p_company_id => v_company_id),
                                                        p_account_id               => v_account_id,
                                                        p_currency_code            => v_write_off_account.currency_code,
                                                        p_exchange_rate_type       => v_exchange_rate_type,
                                                        p_exchange_rate            => v_exchange_rate,
                                                        p_entered_amount_dr        => 0,
                                                        p_entered_amount_cr        => NULL,
                                                        p_functional_amount_dr     => v_revaluation,
                                                        p_functional_amount_cr     => NULL,
                                                        p_cash_clearing_flag       => NULL,
                                                        p_journal_date             => v_audit_date,
                                                        p_gld_interface_flag       => csh_write_off_pkg.c_gld_interface_flag_p,
                                                        p_usage_code               => 'REVALUATION',
                                                        p_user_id                  => p_user_id);
      ELSIF v_revaluation < 0 THEN
        v_account_id := csh_transaction_pkg.get_revaluation_account(p_company_id    => v_company_id,
                                                                    p_currency_code => v_write_off_account.currency_code,
                                                                    p_user_id       => p_user_id);
        IF v_account_id IS NULL THEN
          RAISE e_revaluation_account_error;
        END IF;
        -- 汇率差异精度
        v_revaluation := fnd_format_mask_pkg.get_gld_amount(p_currency_code   => gld_common_pkg.get_company_currency_code(p_company_id => v_company_id),
                                                            p_amount          => -1 *
                                                                                 v_revaluation,
                                                            p_set_of_books_id => gld_common_pkg.get_set_of_books_id(p_comany_id => v_company_id));
        -- 创建汇率差异凭证
        v_write_off_je_line_id := csh_write_off_pkg.get_csh_write_off_je_line_id;
        csh_write_off_pkg.insert_csh_write_off_accounts(p_write_off_id             => rec_write_off.write_off_id,
                                                        p_write_off_je_line_id     => v_write_off_je_line_id,
                                                        p_description              => NULL,
                                                        p_period_name              => v_period_name,
                                                        p_source_code              => 'PREPAYMENT_EXPENSE_REPORT',
                                                        p_company_id               => v_company_id,
                                                        p_responsibility_center_id => gld_common_pkg.get_default_resp_center_id(p_company_id => v_company_id),
                                                        p_account_id               => v_account_id,
                                                        p_currency_code            => v_write_off_account.currency_code,
                                                        p_exchange_rate_type       => v_exchange_rate_type,
                                                        p_exchange_rate            => v_exchange_rate,
                                                        p_entered_amount_dr        => NULL,
                                                        p_entered_amount_cr        => 0,
                                                        p_functional_amount_dr     => NULL,
                                                        p_functional_amount_cr     => v_revaluation,
                                                        p_cash_clearing_flag       => NULL,
                                                        p_journal_date             => v_audit_date,
                                                        p_gld_interface_flag       => csh_write_off_pkg.c_gld_interface_flag_p,
                                                        p_usage_code               => 'REVALUATION',
                                                        p_user_id                  => p_user_id);
      END IF;
      --Mantis: 0028818: 费用报销单审核时添加核销预付款的头事件
      --报销单审核时，，触发 已核销预付款 事件
      exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_POST_AUDIT_PREPAYMENT_EXPENSE_REPORT',
                                      p_document_id      => rec_write_off.csh_trx_header_id,
                                      p_document_line_id => '',
                                      p_source_module    => c_exp_report,
                                      p_event_type       => 'EXP_REPORT_POST_AUDIT_PREPAYMENT_EXPENSE_REPORT',
                                      p_user_id          => p_user_id);
    END LOOP;
    --报销单审核，触发事件
    /** exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_POST_AUDIT',
    p_document_id      => p_exp_report_header_id,
    p_document_line_id => '',
    p_source_module    => c_exp_report,
    p_event_type       => 'EXP_REPORT_POST_AUDIT',
    p_user_id          => p_user_id);**/
  
    IF v_parameter_value = 'N' THEN
    
      --若系统参数为Y则以下过程在‘复核审核’过程中执行，
      evt_event_core_pkg.fire_event(p_event_name   => 'EXP_REPORT_POST_AUDIT',
                                    p_event_param  => p_exp_report_header_id,
                                    p_param1       => c_exp_report,
                                    p_event_source => c_exp_report,
                                    p_event_type   => 'EXP_REPORT_POST_AUDIT',
                                    p_created_by   => p_user_id);
    
      -- 写上来源单据编号                             
      UPDATE gl_account_entry gae
         SET gae.accounting_date = v_audit_date,
             gae.period_name     = v_period_name,
             gae.attribute12    =
             (SELECT erh.exp_report_number
                FROM exp_report_headers erh
               WHERE erh.exp_report_header_id = p_exp_report_header_id)
       WHERE gae.transaction_type = 'EXP_REPORT'
         AND gae.transaction_header_id = p_exp_report_header_id;
    
      -- 核销凭证写上来源单据编号
      UPDATE gl_account_entry gae
         SET gae.attribute12 =
             (SELECT erh.exp_report_number
                FROM exp_report_headers erh
               WHERE erh.exp_report_header_id = p_exp_report_header_id)
       WHERE gae.transaction_type = 'CSH_WRITE_OFF'
         AND gae.transaction_header_id IN
             (SELECT w.write_off_id
                FROM csh_write_off w
               WHERE w.write_off_type = 'PREPAYMENT_EXPENSE_REPORT'
                 AND w.document_source = 'EXPENSE_REPORT'
                 AND w.document_header_id = p_exp_report_header_id);
    END IF;
  
    COMMIT;
  EXCEPTION
    WHEN e_ccid_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => v_error_message,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'audit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_period_not_open THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP5140_PERIOD_NOT_OPEN',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'audit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN no_data_found THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'audit_exp_report');
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP5140_AUDIT_CHECK_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'audit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_je_creation_first THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP5140_JE_CREATION_FIRST',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'audit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_lock_table THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP5140_CONCURRENT_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'audit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_exchange_rate_type_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'CSH5220_EXCHANGE_RATE_TYPE_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'audit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_revaluation_account_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'CSH5220_REVALUATION_ACCOUNT_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'audit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_vms_check_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => v_vms_check_error_msg,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'audit_exp_report_recheck');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'audit_exp_report');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END audit_exp_report;

  --报销单审核 - 条码调用
  PROCEDURE get_other_parameter(p_exp_report_number VARCHAR2,
                                p_company_id        NUMBER,
                                p_user_id           NUMBER,
                                p_employee_code     OUT VARCHAR2,
                                p_name              OUT VARCHAR2,
                                p_currency_code     OUT VARCHAR2,
                                p_report_amount     OUT VARCHAR2) IS
    v_employee_id          NUMBER;
    v_exp_report_header_id exp_report_headers.exp_report_header_id%TYPE;
  
  BEGIN
  
    SELECT exp_report_header_id
      INTO v_exp_report_header_id
      FROM exp_report_headers a
     WHERE a.exp_report_number = p_exp_report_number
       AND a.company_id = p_company_id;
  
    BEGIN
      audit_exp_report(p_exp_report_header_id => v_exp_report_header_id,
                       p_user_id              => p_user_id,
                       p_journal_date         => to_char(SYSDATE,
                                                         'yyyy-mm-dd'));
    EXCEPTION
      WHEN OTHERS THEN
        RAISE e_sub_program_error;
    END;
  
    SELECT a.employee_id, a.currency_code, SUM(b.report_amount)
      INTO v_employee_id, p_currency_code, p_report_amount
      FROM exp_report_headers a, exp_report_lines b
     WHERE a.exp_report_header_id = b.exp_report_header_id
       AND a.exp_report_header_id = v_exp_report_header_id
     GROUP BY a.employee_id, a.currency_code;
  
    IF v_employee_id IS NOT NULL THEN
      SELECT e.employee_code, e.name
        INTO p_employee_code, p_name
        FROM exp_employees e
       WHERE e.employee_id = v_employee_id;
    ELSE
      p_employee_code := '';
      p_name          := '';
    END IF;
  
  EXCEPTION
    WHEN no_data_found THEN
      p_employee_code := NULL;
      p_name          := NULL;
      p_currency_code := NULL;
      p_report_amount := NULL;
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP5190_NOT_FOUND_REPORT_NUMBER',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'audit_exp_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_sub_program_error THEN
      p_employee_code := NULL;
      p_name          := NULL;
      p_currency_code := NULL;
      p_report_amount := NULL;
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      p_employee_code := NULL;
      p_name          := NULL;
      p_currency_code := NULL;
      p_report_amount := NULL;
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'get_other_parameter');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END get_other_parameter;

  --审核 （复核）
  --modify by dzc 2013-1-17  保单复核的时候执行相关动作，不单只是变更审核标志
  PROCEDURE audit_exp_report_recheck(p_exp_report_header_id NUMBER,
                                     p_user_id              NUMBER,
                                     p_report_status        VARCHAR2 DEFAULT 'COMPLETELY_APPROVED',
                                     p_recheck_opinion      VARCHAR2 DEFAULT NULL) IS
    v_je_creation_status          exp_report_headers.je_creation_status%TYPE;
    v_audit_flag                  exp_report_headers.audit_flag%TYPE;
    v_audit_date                  exp_report_headers.audit_date%TYPE;
    v_company_id                  NUMBER;
    v_period_name                 gld_periods.period_name%TYPE;
    v_exchange_rate_type          gld_exchange_rates.type_code%TYPE;
    v_exchange_rate               NUMBER;
    v_exchange_rate_quotation     gld_exchange_rates.exchange_rate_quotation%TYPE;
    v_exp_exchange_rate_type      VARCHAR2(30);
    v_exp_exchange_rate_quotation VARCHAR2(30);
    v_exp_exchange_rate           NUMBER;
    v_entered_amount              NUMBER;
    v_functional_amount           NUMBER;
    v_revaluation                 NUMBER;
    v_account_id                  NUMBER;
    v_write_off_je_line_id        NUMBER;
    v_write_off_account           csh_write_off_accounts%ROWTYPE;
    v_func_currency_code          VARCHAR2(30);
    v_transaction_line            csh_transaction_lines%ROWTYPE;
    v_exp_rep_account             exp_report_accounts%ROWTYPE;
  
    e_je_creation_first         EXCEPTION;
    e_exchange_rate_type_error  EXCEPTION;
    e_revaluation_account_error EXCEPTION;
    e_period_not_open           EXCEPTION;
    v_parameter_value VARCHAR2(200);
    v_line_audit_flag exp_report_lines.audit_flag%TYPE;
    v_head_audit_flag exp_report_headers.audit_flag%TYPE;
  
    v_write_off_completed_date DATE;
    -- 是否需要支付
    v_payment_flag VARCHAR2(10);
  
    v_count NUMBER;
  
    v_company_code        VARCHAR2(30);
    v_bgt_budget_reserves bgt_budget_reserves%ROWTYPE;
    v_cash_flow_flag      VARCHAR2(2);
    v_expense_account     VARCHAR2(2);
    v_receivable_account  VARCHAR2(2);
    v_pay_account         VARCHAR2(2);
  BEGIN
    SELECT t.audit_flag,
           t.je_creation_status,
           t.company_id,
           ee.payment_flag
      INTO v_audit_flag, v_je_creation_status, v_company_id, v_payment_flag
      FROM exp_report_headers t, exp_expense_report_types ee
     WHERE t.exp_report_header_id = p_exp_report_header_id
       AND t.report_status = p_report_status
       AND nvl(t.audit_flag, 'N') = 'R'
       AND t.exp_report_type_id = ee.expense_report_type_id
       FOR UPDATE NOWAIT;
  
    --取得复核标志的系统参数
    v_parameter_value := sys_parameter_pkg.value('EXP_REPORT_RECHECK');
  
    v_audit_date := get_journal_date(p_exp_report_header_id);
  
    --复核环节标志修改
  
    -- 期间
    v_period_name := gld_common_pkg.get_gld_period_name(p_company_id => v_company_id,
                                                        p_date       => v_audit_date);
    IF v_period_name IS NULL THEN
      RAISE e_period_not_open;
    END IF;
  
    set_exp_report_recheck_flag(p_user_id              => p_user_id,
                                p_audit_date           => v_audit_date,
                                p_sys_parameter_code   => 'EXP_REPORT_RECHECK',
                                p_exp_report_header_id => p_exp_report_header_id);
  
    --更改凭证行状态
    UPDATE exp_report_accounts era
    -- 万联证券修改为暂挂
    --SET era.gld_interface_flag = 'P',
       SET era.gld_interface_flag = 'G',
           era.last_updated_by    = p_user_id,
           era.last_update_date   = SYSDATE
     WHERE era.exp_report_header_id = p_exp_report_header_id;
  
    --更新报销单分配行
    UPDATE exp_report_dists t
       SET t.audit_flag       = 'Y',
           t.audit_date       = SYSDATE, --审核日期为复核日期
           t.last_updated_by  = p_user_id,
           t.last_update_date = SYSDATE
     WHERE t.exp_report_line_id IN
           (SELECT exp_report_line_id
              FROM exp_report_lines l
             WHERE l.exp_report_header_id = p_exp_report_header_id);
  
    --创建报销单历史
    insert_exp_document_histories(p_document_type  => c_exp_report,
                                  p_document_id    => p_exp_report_header_id,
                                  p_operation_code => exp_document_history_pkg.c_recheck, --'REAUDIT',
                                  p_user_id        => p_user_id,
                                  p_operation_time => SYSDATE,
                                  p_description    => p_recheck_opinion);
  
    -- 报销单是否已被预付款核销，有的话更新核销日期，凭证日期
    FOR rec_write_off IN (SELECT w.*,
                                 (SELECT ctl.transaction_header_id
                                    FROM csh_transaction_lines ctl
                                   WHERE ctl.transaction_line_id =
                                         w.csh_transaction_line_id) csh_trx_header_id
                            FROM csh_write_off w
                           WHERE w.write_off_type =
                                 'PREPAYMENT_EXPENSE_REPORT'
                             AND w.document_source = 'EXPENSE_REPORT'
                             AND w.document_header_id =
                                 p_exp_report_header_id) LOOP
      --更新核销记录
      UPDATE csh_write_off w
         SET w.write_off_date     = v_audit_date,
             w.period_name        = v_period_name,
             w.gld_interface_flag = csh_write_off_pkg.c_gld_interface_flag_p,
             w.last_updated_by    = p_user_id,
             w.last_update_date   = SYSDATE
       WHERE w.write_off_id = rec_write_off.write_off_id;
    
      --如果该报销单被完全核销，更新报销单头上的完全核销日期
      UPDATE exp_report_headers h
         SET h.write_off_completed_date = v_audit_date,
             h.audit_date               = SYSDATE --审核日期为复核的日期
       WHERE h.exp_report_header_id = p_exp_report_header_id
         AND h.write_off_status = 'C'
         AND h.write_off_completed_date IS NOT NULL
      RETURNING h.write_off_completed_date INTO v_write_off_completed_date;
    
      --如果那条预付款事务被完全核销，更新被核销的预付款事务的完全核销日期
      UPDATE csh_transaction_headers h
         SET h.write_off_completed_date = v_audit_date
       WHERE h.transaction_header_id = rec_write_off.csh_trx_header_id
         AND h.write_off_flag = 'C'
         AND h.write_off_completed_date IS NOT NULL;
    
      SELECT *
        INTO v_write_off_account
        FROM csh_write_off_accounts a
       WHERE a.write_off_id = rec_write_off.write_off_id
         AND a.usage_code = 'PREPAYMENT_WRITE_OFF';
    
      v_func_currency_code := gld_common_pkg.get_company_currency_code(v_company_id);
    
      IF v_func_currency_code <> v_write_off_account.currency_code THEN
        SELECT era.exchange_rate,
               era.exchange_rate_type,
               era.exchange_rate_quotation
          INTO v_exchange_rate,
               v_exchange_rate_type,
               v_exchange_rate_quotation
          FROM exp_report_accounts era
         WHERE era.exp_report_header_id = p_exp_report_header_id
           AND rownum = 1;
      ELSE
        v_exchange_rate_type      := NULL;
        v_exchange_rate           := 1;
        v_exchange_rate_quotation := NULL;
      
      END IF;
    
      SELECT *
        INTO v_transaction_line
        FROM csh_transaction_lines l
       WHERE l.transaction_line_id = rec_write_off.csh_transaction_line_id;
      v_exp_exchange_rate_quotation := v_transaction_line.exchange_rate_quotation;
      v_exp_exchange_rate           := v_transaction_line.exchange_rate;
      v_exp_exchange_rate_type      := v_transaction_line.exchange_rate_type;
      -- 计算本位币金额
      IF v_exp_exchange_rate_quotation = 'DIRECT QUOTATION' THEN
        v_functional_amount := v_write_off_account.entered_amount_cr *
                               v_exp_exchange_rate;
      ELSIF v_exp_exchange_rate_quotation = 'INDIRECT QUOTATION' THEN
        v_functional_amount := v_write_off_account.entered_amount_cr *
                               (1 / v_exp_exchange_rate);
      ELSE
        v_functional_amount := v_write_off_account.entered_amount_cr *
                               v_exp_exchange_rate;
      END IF;
    
      -- 汇率差异
      v_revaluation := v_functional_amount;
      -- 本位币精度
      v_functional_amount := fnd_format_mask_pkg.get_gld_amount(p_currency_code   => gld_common_pkg.get_company_currency_code(p_company_id => v_company_id),
                                                                p_amount          => v_functional_amount,
                                                                p_set_of_books_id => gld_common_pkg.get_set_of_books_id(p_comany_id => v_company_id));
    
      --更新凭证行
      UPDATE csh_write_off_accounts a
         SET a.period_name          = v_period_name,
             a.exchange_rate_type   = v_exp_exchange_rate_type,
             a.exchange_rate        = v_exp_exchange_rate,
             a.functional_amount_cr = v_functional_amount,
             a.journal_date         = v_audit_date,
             a.gld_interface_flag   = csh_write_off_pkg.c_gld_interface_flag_p,
             a.last_updated_by      = p_user_id,
             a.last_update_date     = SYSDATE
       WHERE a.write_off_id = rec_write_off.write_off_id
         AND a.usage_code = 'PREPAYMENT_WRITE_OFF';
    
      /*select a.exchange_rate_type,
            a.exchange_rate_quotation,
            a.exchange_rate
       into v_exp_exchange_rate_type,
            v_exp_exchange_rate_quotation,
            v_exp_exchange_rate
       from exp_report_accounts a
      where exists (select 1
               from exp_report_dists d, exp_report_lines l
              where d.exp_report_dists_id = a.exp_report_dists_id
                and d.exp_report_line_id = l.exp_report_line_id
                and l.exp_report_header_id = p_exp_report_header_id)
        and exists (select 1
               from csh_transaction_lines tl
              where tl.currency_code = a.currency_code
                and tl.transaction_line_id =
                    rec_write_off.csh_transaction_line_id)
        and rownum = 1
      group by a.exchange_rate_type,
               a.exchange_rate_quotation,
               a.exchange_rate;*/
    
      /*select h.exchange_rate_type,
            h.exchange_rate_quotation,
            h.exchange_rate
       into v_exp_exchange_rate_type,
            v_exp_exchange_rate_quotation,
            v_exp_exchange_rate
       from exp_report_headers h
      where h.exp_report_header_id = p_exp_report_header_id;*/
    
      SELECT *
        INTO v_write_off_account
        FROM csh_write_off_accounts a
       WHERE a.write_off_id = rec_write_off.write_off_id
         AND a.usage_code = 'EMPLOYEE_EXPENSE_WRITE_OFF';
    
      IF v_exchange_rate_quotation = 'DIRECT QUOTATION' THEN
        v_functional_amount := v_write_off_account.entered_amount_dr *
                               v_exchange_rate;
      ELSIF v_exchange_rate_quotation = 'INDIRECT QUOTATION' THEN
        v_functional_amount := v_write_off_account.entered_amount_dr *
                               (1 / v_exchange_rate);
      ELSE
        v_functional_amount := v_write_off_account.entered_amount_dr *
                               v_exchange_rate;
      END IF;
    
      v_revaluation := v_revaluation - v_functional_amount;
      -- 本位币精度
      v_functional_amount := fnd_format_mask_pkg.get_gld_amount(p_currency_code   => gld_common_pkg.get_company_currency_code(p_company_id => v_company_id),
                                                                p_amount          => v_functional_amount,
                                                                p_set_of_books_id => gld_common_pkg.get_set_of_books_id(p_comany_id => v_company_id));
      --更新凭证行
      UPDATE csh_write_off_accounts a
         SET a.period_name          = v_period_name,
             a.exchange_rate_type   = v_exchange_rate_type,
             a.exchange_rate        = v_exchange_rate,
             a.functional_amount_dr = v_functional_amount,
             a.journal_date         = v_audit_date,
             a.gld_interface_flag   = csh_write_off_pkg.c_gld_interface_flag_p,
             a.last_updated_by      = p_user_id,
             a.last_update_date     = SYSDATE
       WHERE a.write_off_id = rec_write_off.write_off_id
         AND a.usage_code = 'EMPLOYEE_EXPENSE_WRITE_OFF';
    
      SELECT a.write_off_je_line_id
        INTO v_write_off_je_line_id
        FROM csh_write_off_accounts a
       WHERE a.write_off_id = rec_write_off.write_off_id
         AND a.usage_code = 'EMPLOYEE_EXPENSE_WRITE_OFF';
    
      SELECT a.*
        INTO v_exp_rep_account
        FROM exp_report_accounts a
       WHERE a.payment_schedule_line_id = rec_write_off.document_line_id;
    
      --更新凭证行的account和segment
      /*************************************************
      -- Author  : MOUSE
      -- Created : 2015/11/24 13:57:39
      -- Ver     : 1.1
      -- Purpose : 核销的借方凭证取原报销单的贷方科目和SEGMENT
      **************************************************/
      UPDATE csh_write_off_accounts a
         SET a.account_id       = v_exp_rep_account.account_id,
             a.account_segment1 = v_exp_rep_account.account_segment1,
             a.account_segment2 = v_exp_rep_account.account_segment2,
             a.account_segment3 = v_exp_rep_account.account_segment3,
             /*a.account_segment4  = v_exp_rep_account.account_segment4,需重新判断科目 */
             a.account_segment5 = v_exp_rep_account.account_segment5,
             a.account_segment6 = v_exp_rep_account.account_segment6,
             a.account_segment7 = v_exp_rep_account.account_segment7,
             a.account_segment8 = v_exp_rep_account.account_segment8,
             /*a.account_segment9  = v_exp_rep_account.account_segment9,*/
             a.account_segment10 = v_exp_rep_account.account_segment10,
             a.account_segment11 = v_exp_rep_account.account_segment11
       WHERE a.write_off_je_line_id = v_write_off_je_line_id;
    
      SELECT ga.cashflow_flag,
             ga.expense_account,
             ga.receivable_account,
             ga.pay_account
        INTO v_cash_flow_flag,
             v_expense_account,
             v_receivable_account,
             v_pay_account
        FROM gld_accounts ga
       WHERE ga.account_id = v_exp_rep_account.account_id;
    
      UPDATE gl_account_entry e
         SET e.account_id   = v_exp_rep_account.account_id,
             e.account_code = v_exp_rep_account.account_segment3,
             e.segment1     = v_exp_rep_account.account_segment1,
             e.segment2     = v_exp_rep_account.account_segment2,
             e.segment3     = v_exp_rep_account.account_segment3,
             /*e.segment4     = v_exp_rep_account.account_segment4,*/
             e.segment5 = v_exp_rep_account.account_segment5,
             e.segment6 = v_exp_rep_account.account_segment6,
             e.segment7 = v_exp_rep_account.account_segment7,
             e.segment8 = v_exp_rep_account.account_segment8,
             /*e.segment9     = v_exp_rep_account.account_segment9,*/
             e.segment10 = v_exp_rep_account.account_segment10,
             e.segment11 = v_exp_rep_account.account_segment11
       WHERE e.transaction_type = 'CSH_WRITE_OFF'
         AND e.transaction_je_line_id = v_write_off_je_line_id;
    
      IF v_cash_flow_flag <> 'Y' THEN
        --科目更新为非银行存款科目，则置为*，否则取原段值更新的值 by 15798
        UPDATE csh_write_off_accounts a
           SET a.account_segment4 = '*'
         WHERE a.write_off_je_line_id = v_write_off_je_line_id;
      
        UPDATE gl_account_entry e
           SET e.segment4 = '*'
         WHERE e.transaction_type = 'CSH_WRITE_OFF'
           AND e.transaction_je_line_id = v_write_off_je_line_id;
      END IF;
    
      IF v_cash_flow_flag <> 'Y' AND v_expense_account <> 'Y' AND
         v_receivable_account <> 'Y' AND v_pay_account <> 'Y' THEN
        --科目更新为税或往来科目，则置为*，否则取原段值更新的值 by 15798
        UPDATE csh_write_off_accounts a
           SET a.account_segment9 = '*'
         WHERE a.write_off_je_line_id = v_write_off_je_line_id;
      
        UPDATE gl_account_entry e
           SET e.segment9 = '*'
         WHERE e.transaction_type = 'CSH_WRITE_OFF'
           AND e.transaction_je_line_id = v_write_off_je_line_id;
      END IF;
    
      gl_log_pkg.log(p_log_text => '核销凭证的借方从报销单贷方凭证带出，报销单凭证行为：' ||
                                   rec_write_off.document_line_id ||
                                   '，凭证科目段为：' ||
                                   v_exp_rep_account.account_segment1 || '.' ||
                                   v_exp_rep_account.account_segment2 || '.' ||
                                   v_exp_rep_account.account_segment3 || '.' ||
                                   v_exp_rep_account.account_segment4 || '.' ||
                                   v_exp_rep_account.account_segment5 || '.' ||
                                   v_exp_rep_account.account_segment6 || '.' ||
                                   v_exp_rep_account.account_segment7 || '.' ||
                                   v_exp_rep_account.account_segment8 || '.' ||
                                   v_exp_rep_account.account_segment9 || '.' ||
                                   v_exp_rep_account.account_segment10 || '.' ||
                                   v_exp_rep_account.account_segment11,
                     p_user_id  => p_user_id);
      /*************************************************/
    
      IF v_revaluation > 0 THEN
        v_account_id := csh_transaction_pkg.get_revaluation_account(p_company_id    => v_company_id,
                                                                    p_currency_code => v_write_off_account.currency_code,
                                                                    p_user_id       => p_user_id);
        IF v_account_id IS NULL THEN
          RAISE e_revaluation_account_error;
        END IF;
      
        -- 汇率差异精度
        v_revaluation := fnd_format_mask_pkg.get_gld_amount(p_currency_code   => gld_common_pkg.get_company_currency_code(p_company_id => v_company_id),
                                                            p_amount          => v_revaluation,
                                                            p_set_of_books_id => gld_common_pkg.get_set_of_books_id(p_comany_id => v_company_id));
        -- 创建汇率差异凭证
        v_write_off_je_line_id := csh_write_off_pkg.get_csh_write_off_je_line_id;
        csh_write_off_pkg.insert_csh_write_off_accounts(p_write_off_id             => rec_write_off.write_off_id,
                                                        p_write_off_je_line_id     => v_write_off_je_line_id,
                                                        p_description              => NULL,
                                                        p_period_name              => v_period_name,
                                                        p_source_code              => 'PREPAYMENT_EXPENSE_REPORT',
                                                        p_company_id               => v_company_id,
                                                        p_responsibility_center_id => gld_common_pkg.get_default_resp_center_id(p_company_id => v_company_id),
                                                        p_account_id               => v_account_id,
                                                        p_currency_code            => v_write_off_account.currency_code,
                                                        p_exchange_rate_type       => v_exchange_rate_type,
                                                        p_exchange_rate            => v_exchange_rate,
                                                        p_entered_amount_dr        => 0,
                                                        p_entered_amount_cr        => NULL,
                                                        p_functional_amount_dr     => v_revaluation,
                                                        p_functional_amount_cr     => NULL,
                                                        p_cash_clearing_flag       => NULL,
                                                        p_journal_date             => v_audit_date,
                                                        p_gld_interface_flag       => csh_write_off_pkg.c_gld_interface_flag_p,
                                                        p_usage_code               => 'REVALUATION',
                                                        p_user_id                  => p_user_id);
      ELSIF v_revaluation < 0 THEN
        v_account_id := csh_transaction_pkg.get_revaluation_account(p_company_id    => v_company_id,
                                                                    p_currency_code => v_write_off_account.currency_code,
                                                                    p_user_id       => p_user_id);
        IF v_account_id IS NULL THEN
          RAISE e_revaluation_account_error;
        END IF;
      
        -- 汇率差异精度
        v_revaluation := fnd_format_mask_pkg.get_gld_amount(p_currency_code   => gld_common_pkg.get_company_currency_code(p_company_id => v_company_id),
                                                            p_amount          => -1 *
                                                                                 v_revaluation,
                                                            p_set_of_books_id => gld_common_pkg.get_set_of_books_id(p_comany_id => v_company_id));
        -- 创建汇率差异凭证
        v_write_off_je_line_id := csh_write_off_pkg.get_csh_write_off_je_line_id;
        csh_write_off_pkg.insert_csh_write_off_accounts(p_write_off_id             => rec_write_off.write_off_id,
                                                        p_write_off_je_line_id     => v_write_off_je_line_id,
                                                        p_description              => NULL,
                                                        p_period_name              => v_period_name,
                                                        p_source_code              => 'PREPAYMENT_EXPENSE_REPORT',
                                                        p_company_id               => v_company_id,
                                                        p_responsibility_center_id => gld_common_pkg.get_default_resp_center_id(p_company_id => v_company_id),
                                                        p_account_id               => v_account_id,
                                                        p_currency_code            => v_write_off_account.currency_code,
                                                        p_exchange_rate_type       => v_exchange_rate_type,
                                                        p_exchange_rate            => v_exchange_rate,
                                                        p_entered_amount_dr        => NULL,
                                                        p_entered_amount_cr        => 0,
                                                        p_functional_amount_dr     => NULL,
                                                        p_functional_amount_cr     => v_revaluation,
                                                        p_cash_clearing_flag       => NULL,
                                                        p_journal_date             => v_audit_date,
                                                        p_gld_interface_flag       => csh_write_off_pkg.c_gld_interface_flag_p,
                                                        p_usage_code               => 'REVALUATION',
                                                        p_user_id                  => p_user_id);
      
      END IF;
    
      --Mantis: 0028818: 费用报销单审核时添加核销预付款的头事件
      --报销单审核时，触发 已核销预付款 事件
      exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_POST_AUDIT_PREPAYMENT_EXPENSE_REPORT',
                                      p_document_id      => rec_write_off.csh_trx_header_id,
                                      p_document_line_id => '',
                                      p_source_module    => c_exp_report,
                                      p_event_type       => 'EXP_REPORT_POST_AUDIT_PREPAYMENT_EXPENSE_REPORT',
                                      p_user_id          => p_user_id);
    END LOOP;
  
    IF v_parameter_value = 'Y' THEN
    
      --若系统参数为Y则以下过程在‘复核审核’过程中执行，
      evt_event_core_pkg.fire_event(p_event_name   => 'EXP_REPORT_POST_AUDIT',
                                    p_event_param  => p_exp_report_header_id,
                                    p_param1       => c_exp_report,
                                    p_event_source => c_exp_report,
                                    p_event_type   => 'EXP_REPORT_POST_AUDIT',
                                    p_created_by   => p_user_id);
    
    END IF;
  
    -- 凭证上写来源单据编号
    -- 万联
    IF (nvl(v_payment_flag, 'N') = 'Y') THEN
    
      SELECT COUNT(1)
        INTO v_count
        FROM exp_report_lines l
       WHERE l.expense_item_id <>
             (SELECT eei.expense_item_id
                FROM exp_expense_items eei
               WHERE eei.expense_item_code = 'FYT105')
         AND l.exp_report_header_id = p_exp_report_header_id;
    
      --如果存在费用项目不是非统报的单据,则支付成功后再修改凭证状态
      IF (v_count > 0) THEN
      
        UPDATE gl_account_entry gae
           SET gae.attribute12  =
               (SELECT erh.exp_report_number
                  FROM exp_report_headers erh
                 WHERE erh.exp_report_header_id = p_exp_report_header_id),
               gae.imported_flag = 'G'
         WHERE gae.transaction_type = 'EXP_REPORT'
           AND gae.transaction_header_id = p_exp_report_header_id;
      
        -- 万联证券核销凭证写上来源单据编号
        UPDATE gl_account_entry gae
           SET gae.attribute12  =
               (SELECT erh.exp_report_number
                  FROM exp_report_headers erh
                 WHERE erh.exp_report_header_id = p_exp_report_header_id),
               gae.imported_flag = 'G'
         WHERE gae.transaction_type = 'CSH_WRITE_OFF'
           AND gae.transaction_header_id IN
               (SELECT w.write_off_id
                  FROM csh_write_off w
                 WHERE w.write_off_type = 'PREPAYMENT_EXPENSE_REPORT'
                   AND w.document_source = 'EXPENSE_REPORT'
                   AND w.document_header_id = p_exp_report_header_id);
      ELSE
      
        UPDATE gl_account_entry gae
           SET gae.attribute12  =
               (SELECT erh.exp_report_number
                  FROM exp_report_headers erh
                 WHERE erh.exp_report_header_id = p_exp_report_header_id),
               gae.imported_flag = 'P'
         WHERE gae.transaction_type = 'EXP_REPORT'
           AND gae.transaction_header_id = p_exp_report_header_id;
      
        -- 万联证券核销凭证写上来源单据编号
        UPDATE gl_account_entry gae
           SET gae.attribute12  =
               (SELECT erh.exp_report_number
                  FROM exp_report_headers erh
                 WHERE erh.exp_report_header_id = p_exp_report_header_id),
               gae.imported_flag = 'P'
         WHERE gae.transaction_type = 'CSH_WRITE_OFF'
           AND gae.transaction_header_id IN
               (SELECT w.write_off_id
                  FROM csh_write_off w
                 WHERE w.write_off_type = 'PREPAYMENT_EXPENSE_REPORT'
                   AND w.document_source = 'EXPENSE_REPORT'
                   AND w.document_header_id = p_exp_report_header_id);
      END IF;
    
    ELSE
      UPDATE gl_account_entry gae
         SET gae.attribute12  =
             (SELECT erh.exp_report_number
                FROM exp_report_headers erh
               WHERE erh.exp_report_header_id = p_exp_report_header_id),
             gae.imported_flag = 'P'
       WHERE gae.transaction_type = 'EXP_REPORT'
         AND gae.transaction_header_id = p_exp_report_header_id;
    
      -- 万联证券核销凭证写上来源单据编号
      UPDATE gl_account_entry gae
         SET gae.attribute12  =
             (SELECT erh.exp_report_number
                FROM exp_report_headers erh
               WHERE erh.exp_report_header_id = p_exp_report_header_id),
             gae.imported_flag = 'P'
       WHERE gae.transaction_type = 'CSH_WRITE_OFF'
         AND gae.transaction_header_id IN
             (SELECT w.write_off_id
                FROM csh_write_off w
               WHERE w.write_off_type = 'PREPAYMENT_EXPENSE_REPORT'
                 AND w.document_source = 'EXPENSE_REPORT'
                 AND w.document_header_id = p_exp_report_header_id);
    END IF;
  
    --如果报销单完全核销,凭证状态改成P         
    IF (v_write_off_completed_date IS NOT NULL) THEN
    
      UPDATE gl_account_entry gae
         SET gae.imported_flag = 'P'
       WHERE gae.transaction_type = 'EXP_REPORT'
         AND gae.transaction_header_id = p_exp_report_header_id;
    
      UPDATE gl_account_entry gae
         SET gae.imported_flag = 'P'
       WHERE gae.transaction_type = 'CSH_WRITE_OFF'
         AND gae.transaction_header_id IN
             (SELECT w.write_off_id
                FROM csh_write_off w
               WHERE w.write_off_type = 'PREPAYMENT_EXPENSE_REPORT'
                 AND w.document_source = 'EXPENSE_REPORT'
                 AND w.document_header_id = p_exp_report_header_id);
    END IF;
    --建信人寿
    --added by lyh 2018.3.26
    --对于报销单行抵扣规则为全额抵扣的，预算保留表插入一行负数记录（金额为税额。
    --当公司为总公司时，预算科目为999999；当公司非总公司时，预算科目为报销单行
    --费用项目对应的预算科目）
    FOR cur_lines IN (SELECT l.company_id,
                             l.exp_report_line_id,
                             h.exp_report_header_id,
                             d.exp_report_dists_id,
                             l.usage_type,
                             l.budget_item_id,
                             l.tax_amount
                        FROM exp_report_headers h,
                             exp_report_lines   l,
                             exp_report_dists   d
                       WHERE h.exp_report_header_id = l.exp_report_header_id
                         AND l.exp_report_line_id = d.exp_report_line_id
                         AND h.exp_report_header_id = p_exp_report_header_id) LOOP
      SELECT br.*
        INTO v_bgt_budget_reserves
        FROM bgt_budget_reserves br
       WHERE br.document_id = p_exp_report_header_id
         AND br.document_line_id = cur_lines.exp_report_dists_id
         AND br.business_type = 'EXP_REPORT';
      SELECT bgt_budget_reserves_s.nextval
        INTO v_bgt_budget_reserves.budget_reserve_line_id
        FROM dual;
      IF cur_lines.usage_type = 'YT001' THEN
        SELECT f.company_code
          INTO v_company_code
          FROM fnd_companies f
         WHERE f.company_id = cur_lines.company_id;
        IF v_company_code = '8600000000' THEN
          BEGIN
            SELECT t.budget_item_id
              INTO v_bgt_budget_reserves.budget_item_id
              FROM bgt_budget_items t
             WHERE t.budget_item_code = '999999';
          EXCEPTION
            WHEN no_data_found THEN
              sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => '未找到代码为999999的预算项目！',
                                                              p_created_by              => p_user_id,
                                                              p_package_name            => 'exp_report_pkg',
                                                              p_procedure_function_name => 'audit_exp_report_recheck');
              raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                      sys_raise_app_error_pkg.g_err_line_id);
          END;
        END IF;
        v_bgt_budget_reserves.amount            := -1 *
                                                   cur_lines.tax_amount;
        v_bgt_budget_reserves.functional_amount := -1 *
                                                   cur_lines.tax_amount;
        INSERT INTO bgt_budget_reserves VALUES v_bgt_budget_reserves;
      END IF;
    END LOOP;
  EXCEPTION
    WHEN e_period_not_open THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP5140_PERIOD_NOT_OPEN',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'audit_exp_report_recheck');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'audit_exp_report_recheck');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END;

  --审核拒绝
  PROCEDURE audit_reject_expense_report(p_expense_report_header_id NUMBER,
                                        p_user_id                  NUMBER,
                                        p_description              VARCHAR2,
                                        p_report_status            VARCHAR2 DEFAULT 'COMPLETELY_APPROVED') IS
    v_audit_flag     exp_report_headers.audit_flag%TYPE;
    v_recheck_flag   VARCHAR2(10);
    v_rep_audit_flag VARCHAR2(10);
  BEGIN
    v_recheck_flag := sys_parameter_pkg.value(p_parameter_code => 'EXP_REPORT_RECHECK');
  
    SELECT t.audit_flag
      INTO v_rep_audit_flag
      FROM exp_report_headers t
     WHERE t.exp_report_header_id = p_expense_report_header_id;
  
    SELECT t.audit_flag
      INTO v_audit_flag
      FROM exp_report_headers t
     WHERE t.exp_report_header_id = p_expense_report_header_id
       AND t.report_status = p_report_status
       AND nvl(t.audit_flag, 'N') IN ('N', 'R')
       FOR UPDATE NOWAIT;
  
    IF v_audit_flag = 'R' THEN
      UPDATE exp_report_headers h
         SET h.audit_flag       = 'N',
             h.return_flag      = 'Y',
             h.last_updated_by  = p_user_id,
             h.last_update_date = SYSDATE
       WHERE h.exp_report_header_id = p_expense_report_header_id;
      --创建报销单历史
      insert_exp_document_histories(p_document_type  => c_exp_report,
                                    p_document_id    => p_expense_report_header_id,
                                    p_operation_code => exp_document_history_pkg.c_recheck_reject, --'REAUDIT_REJECT',
                                    p_user_id        => p_user_id,
                                    p_operation_time => SYSDATE,
                                    p_description    => p_description);
    ELSE
      UPDATE exp_report_headers v
         SET v.report_status = 'REJECTED',
             --只有复核拒绝才置为v.return_flag        = 'Y',
             v.je_creation_status = 'N',
             v.last_updated_by    = p_user_id,
             v.last_update_date   = SYSDATE
       WHERE v.exp_report_header_id = p_expense_report_header_id;
    
      --修改报销单行审核状态 add 2013/4/25
      UPDATE exp_report_lines l
         SET l.report_status    = 'REJECTED',
             l.audit_flag       = 'N',
             l.audit_date       = NULL,
             l.last_updated_by  = p_user_id,
             l.last_update_date = SYSDATE
       WHERE l.exp_report_header_id = p_expense_report_header_id;
    
      --发票状态 审核不修改发票状态modify by wxq 20180409
      /* UPDATE exp_report_lines l
        SET l.invoice_status = '20'
      WHERE l.exp_report_header_id = p_expense_report_header_id
        AND l.invoice_status IN ('30', '50');*/
    
      --修改报销单分配行状态
      UPDATE exp_report_dists d
         SET d.report_status    = 'REJECTED',
             d.audit_flag       = 'N',
             d.audit_date       = NULL,
             d.last_updated_by  = p_user_id,
             d.last_update_date = SYSDATE
       WHERE d.exp_report_line_id IN
             (SELECT l.exp_report_line_id
                FROM exp_report_lines l
               WHERE l.exp_report_header_id = p_expense_report_header_id);
    
      --创建报销单历史
      insert_exp_document_histories(p_document_type  => c_exp_report,
                                    p_document_id    => p_expense_report_header_id,
                                    p_operation_code => exp_document_history_pkg.c_audit_reject, --'AUDIT_REJECT',
                                    p_user_id        => p_user_id,
                                    p_operation_time => SYSDATE,
                                    p_description    => p_description);
    
      DELETE FROM exp_report_accounts a
       WHERE a.exp_report_header_id = p_expense_report_header_id;
    
      --add by zhaofan 20160802 审核拒绝，释放预算 Start
      --预算保留表
      UPDATE bgt_budget_reserves t
         SET t.status         = 'N',
             last_update_date = SYSDATE,
             last_updated_by  = p_user_id
       WHERE t.release_id IN
             (SELECT DISTINCT r.release_id
                FROM exp_requisition_release r
               WHERE r.document_type = c_exp_report
                 AND r.document_id = p_expense_report_header_id)
         AND t.business_type IN (c_exp_report, 'EXP_REQUISITION');
    
      UPDATE bgt_budget_reserves t
         SET t.status         = 'N',
             last_update_date = SYSDATE,
             last_updated_by  = p_user_id
       WHERE t.document_id = p_expense_report_header_id
         AND t.business_type = c_exp_report;
      --add by zhaofan 20160802 审核拒绝，释放预算 End
    
      open_exp_requisition(p_exp_rep_header_id => p_expense_report_header_id,
                           p_user_id           => p_user_id);
    
      --报销单审核拒绝，触发事件
      exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_REJECT_AUDIT',
                                      p_document_id      => p_expense_report_header_id,
                                      p_document_line_id => '',
                                      p_source_module    => c_exp_report,
                                      p_event_type       => 'EXP_REPORT_REJECT_AUDIT',
                                      p_user_id          => p_user_id);
    
    END IF;
  
  EXCEPTION
    WHEN no_data_found THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP5140_AUDIT_CHECK_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'audit_reject_expense_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_lock_table THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP5140_CONCURRENT_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'audit_reject_expense_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END audit_reject_expense_report;

  FUNCTION get_batch_id RETURN NUMBER IS
    v_batch_id NUMBER;
  BEGIN
    SELECT exp_report_accounts_batch_s.nextval INTO v_batch_id FROM dual;
    RETURN v_batch_id;
  END get_batch_id;

  PROCEDURE delete_exp_report_accounts_tmp(p_batch_id NUMBER) IS
  BEGIN
    DELETE FROM exp_report_accounts_tmp a WHERE a.batch_id = p_batch_id;
  END delete_exp_report_accounts_tmp;

  PROCEDURE insert_exp_report_accounts_tmp(p_batch_id                 NUMBER,
                                           p_expense_report_header_id NUMBER,
                                           p_amortization_flag        VARCHAR2) IS
  BEGIN
    INSERT INTO exp_report_accounts_tmp
      (batch_id,
       expense_report_header_id,
       success_flag,
       creation_date,
       amortization_flag)
    VALUES
      (p_batch_id,
       p_expense_report_header_id,
       'N',
       SYSDATE,
       nvl(p_amortization_flag, 'N'));
  END insert_exp_report_accounts_tmp;

  --创建凭证时需要的临时表
  PROCEDURE create_currency_code_tmp(p_batch_id   NUMBER,
                                     p_company_id NUMBER,
                                     p_user_id    NUMBER) IS
    --取所有非本位币
    CURSOR cur_currency IS
      SELECT d.currency_code
        FROM exp_report_dists d
       WHERE d.exp_report_line_id IN
             (SELECT l.exp_report_line_id
                FROM exp_report_lines l, exp_report_accounts_tmp t
               WHERE t.expense_report_header_id = l.exp_report_header_id
                 AND t.batch_id = p_batch_id)
      --and d.currency_code <>gld_common_pkg.get_company_currency_code(p_company_id)
       GROUP BY d.currency_code;
  
    v_company_currency_code      VARCHAR2(30);
    v_default_exchange_rate_type VARCHAR2(30);
    v_period_name                VARCHAR(30);
    v_journal_date               DATE;
    v_exchange_rate              NUMBER;
    v_exchange_rate_quotation    gld_exchange_rates.exchange_rate_quotation%TYPE;
  
  BEGIN
  
    DELETE FROM exp_currency_code_tmp t WHERE t.batch_id = p_batch_id;
  
    FOR c_currency IN cur_currency LOOP
      v_company_currency_code := gld_common_pkg.get_company_currency_code(p_company_id => p_company_id);
      v_period_name           := gld_common_pkg.get_gld_period_name(p_company_id => p_company_id,
                                                                    p_date       => SYSDATE);
    
      --当sysdate的期间取不到时,取打开期间的最后一天
      IF v_period_name IS NULL THEN
        BEGIN
          SELECT MAX(t.end_date)
            INTO v_journal_date
            FROM gld_period_open_v t, gld_set_of_books v
           WHERE t.period_set_code = v.period_set_code
             AND v.set_of_books_id =
                 gld_common_pkg.get_set_of_books_id(p_company_id)
             AND t.adjustment_flag = 'N'
             AND t.period_status_code = 'O'
             AND t.company_id = p_company_id;
          v_period_name := gld_common_pkg.get_gld_period_name(p_company_id => p_company_id,
                                                              p_date       => v_journal_date);
        
        EXCEPTION
          WHEN no_data_found THEN
            NULL;
        END;
      ELSE
        v_journal_date := SYSDATE;
      END IF;
    
      IF c_currency.currency_code <> v_company_currency_code THEN
        IF v_period_name IS NOT NULL THEN
          v_default_exchange_rate_type := sys_parameter_pkg.value(p_parameter_code => 'DEFAULT_EXCHANGE_RATE_TYPE',
                                                                  p_company_id     => p_company_id);
        
          BEGIN
            IF v_default_exchange_rate_type IS NOT NULL THEN
              gld_exchange_rate_pkg.get_exchange_rate(p_company_id              => p_company_id,
                                                      p_from_currency           => v_company_currency_code,
                                                      p_to_currency             => c_currency.currency_code,
                                                      p_exchange_rate_type      => v_default_exchange_rate_type,
                                                      p_exchange_date           => v_journal_date,
                                                      p_exchange_period_name    => v_period_name,
                                                      p_who_id                  => p_user_id,
                                                      p_exchange_rate           => v_exchange_rate,
                                                      p_exchange_rate_quotation => v_exchange_rate_quotation);
            END IF;
          EXCEPTION
            WHEN OTHERS THEN
              v_exchange_rate           := NULL;
              v_exchange_rate_quotation := NULL;
          END;
        
          INSERT INTO exp_currency_code_tmp
            (batch_id,
             currency_code,
             exchange_rate_type,
             exchange_rate,
             exchange_rate_quotation,
             creation_date)
          VALUES
            (p_batch_id,
             c_currency.currency_code,
             v_default_exchange_rate_type,
             v_exchange_rate,
             v_exchange_rate_quotation,
             SYSDATE);
        ELSE
          INSERT INTO exp_currency_code_tmp
            (batch_id, currency_code, creation_date)
          VALUES
            (p_batch_id, c_currency.currency_code, SYSDATE);
        END IF;
      
      ELSE
        INSERT INTO exp_currency_code_tmp
          (batch_id, currency_code, creation_date, exchange_rate)
        VALUES
          (p_batch_id, c_currency.currency_code, SYSDATE, 1);
      END IF;
    
    END LOOP;
  
  END create_currency_code_tmp;

  PROCEDURE update_currency_code_tmp(p_batch_id                NUMBER,
                                     p_currency_code           VARCHAR2,
                                     p_exchange_rate_type      VARCHAR2,
                                     p_exchange_rate           NUMBER,
                                     p_exchange_rate_quotation VARCHAR2) IS
  BEGIN
    UPDATE exp_currency_code_tmp t
       SET t.exchange_rate_type      = p_exchange_rate_type,
           t.exchange_rate           = p_exchange_rate,
           t.exchange_rate_quotation = p_exchange_rate_quotation
     WHERE t.batch_id = p_batch_id
       AND t.currency_code = p_currency_code;
  END update_currency_code_tmp;

  FUNCTION get_report_employee_desc(p_employee_id NUMBER) RETURN VARCHAR2 IS
    v_employee_name VARCHAR2(1000);
    v_employee_spec VARCHAR2(1000);
  
  BEGIN
  
    SELECT t.name
      INTO v_employee_name
      FROM exp_employees t
     WHERE t.employee_id = p_employee_id;
  
    BEGIN
      SELECT v.code_value_name
        INTO v_employee_spec
        FROM sys_codes_vl t, sys_code_values_vl v
       WHERE t.code_id = v.code_id
         AND t.code = 'EXPENSE_REPORT_TITLE'
         AND v.code_value = 'EXPENSE_REPORT_TITLE';
    EXCEPTION
      WHEN OTHERS THEN
        v_employee_spec := NULL;
    END;
    v_employee_name := v_employee_name || ' ' || v_employee_spec;
  
    RETURN v_employee_name;
  EXCEPTION
    WHEN OTHERS THEN
      v_employee_name := NULL;
      RETURN v_employee_name;
  END get_report_employee_desc;

  FUNCTION get_exp_report_je_line_id RETURN NUMBER IS
    v_exp_report_je_line_id exp_report_accounts.exp_report_je_line_id%TYPE;
  BEGIN
    SELECT exp_report_accounts_s.nextval
      INTO v_exp_report_je_line_id
      FROM dual;
    RETURN v_exp_report_je_line_id;
  END get_exp_report_je_line_id;

  --科目对应的责任中心
  FUNCTION get_responsibility_center_id(p_company_id NUMBER) RETURN NUMBER IS
    v_resp_center_id NUMBER;
  BEGIN
  
    v_resp_center_id := gld_common_pkg.get_default_resp_center_id(p_company_id => p_company_id);
  
    RETURN v_resp_center_id;
  EXCEPTION
    WHEN OTHERS THEN
      RETURN NULL;
  END get_responsibility_center_id;

  FUNCTION get_functional_amount(p_currency_code           VARCHAR2,
                                 p_standard_currency       VARCHAR2,
                                 p_amount                  NUMBER,
                                 p_batch_id                NUMBER,
                                 p_company_id              NUMBER,
                                 p_exchange_rate_type      OUT VARCHAR2,
                                 p_exchange_rate_quotation OUT VARCHAR2,
                                 p_exchange_rate           OUT NUMBER)
    RETURN NUMBER IS
    v_amount                  NUMBER;
    v_exchange_rate_quotation exp_currency_code_tmp.exchange_rate_quotation%TYPE;
    v_exchange_rate           exp_currency_code_tmp.exchange_rate%TYPE;
    v_exchange_rate_type      exp_currency_code_tmp.exchange_rate_type%TYPE;
  BEGIN
    v_amount := p_amount;
  
    SELECT t.exchange_rate_quotation, t.exchange_rate, t.exchange_rate_type
      INTO v_exchange_rate_quotation, v_exchange_rate, v_exchange_rate_type
      FROM exp_currency_code_tmp t
     WHERE t.currency_code = p_currency_code
       AND t.batch_id = p_batch_id;
  
    IF p_currency_code = p_standard_currency THEN
      v_exchange_rate      := 1;
      v_exchange_rate_type := NULL;
      v_amount             := p_amount;
    ELSE
      IF v_exchange_rate_quotation = 'DIRECT QUOTATION' THEN
        --“直接法”时，（本币）借方＝付款金额*汇率
        v_amount := p_amount * v_exchange_rate;
      
      ELSIF v_exchange_rate_quotation = 'INDIRECT QUOTATION' THEN
        --“间接法”时，（本币）借方＝付款金额/汇率
        v_amount := p_amount / v_exchange_rate;
      END IF;
    
    END IF;
  
    v_amount := fnd_format_mask_pkg.get_gld_amount(p_standard_currency,
                                                   v_amount,
                                                   gld_common_pkg.get_set_of_books_id(p_company_id));
  
    p_exchange_rate_type      := v_exchange_rate_type;
    p_exchange_rate           := v_exchange_rate;
    p_exchange_rate_quotation := v_exchange_rate_quotation;
    RETURN v_amount;
  
  END get_functional_amount;

  FUNCTION get_pmt_last_fun_amount(p_exp_report_header_id NUMBER)
    RETURN NUMBER IS
    v_fun_amount NUMBER;
    v_dr_amount  NUMBER;
    v_cr_amount  NUMBER;
  BEGIN
    SELECT SUM(nvl(a.functional_amount_dr, 0))
      INTO v_dr_amount
      FROM exp_report_accounts a
     WHERE a.exp_report_header_id = p_exp_report_header_id;
  
    SELECT SUM(nvl(a.functional_amount_cr, 0))
      INTO v_cr_amount
      FROM exp_report_accounts a
     WHERE a.exp_report_header_id = p_exp_report_header_id;
  
    v_fun_amount := v_dr_amount - v_cr_amount;
  
    RETURN v_fun_amount;
  END;
  --Modify by hyb@2012/06/11,增加了p_exp_report_header_id字段
  PROCEDURE insert_exp_report_accounts(p_exp_report_dists_id      NUMBER,
                                       p_exp_report_header_id     NUMBER,
                                       p_exp_report_je_line_id    NUMBER,
                                       p_description              VARCHAR2,
                                       p_journal_date             DATE,
                                       p_period_name              VARCHAR2,
                                       p_source_code              VARCHAR2,
                                       p_company_id               NUMBER,
                                       p_company_segment          VARCHAR2 DEFAULT NULL,
                                       p_responsibility_center_id NUMBER,
                                       p_account_id               NUMBER,
                                       p_account_segment1         VARCHAR2 DEFAULT NULL,
                                       p_account_segment2         VARCHAR2 DEFAULT NULL,
                                       p_account_segment3         VARCHAR2 DEFAULT NULL,
                                       p_account_segment4         VARCHAR2 DEFAULT NULL,
                                       p_account_segment5         VARCHAR2 DEFAULT NULL,
                                       p_account_segment6         VARCHAR2 DEFAULT NULL,
                                       p_account_segment7         VARCHAR2 DEFAULT NULL,
                                       p_account_segment8         VARCHAR2 DEFAULT NULL,
                                       p_account_segment9         VARCHAR2 DEFAULT NULL,
                                       p_account_segment10        VARCHAR2 DEFAULT NULL,
                                       p_dimension1_id            NUMBER DEFAULT NULL,
                                       p_dimension2_id            NUMBER DEFAULT NULL,
                                       p_dimension3_id            NUMBER DEFAULT NULL,
                                       p_dimension4_id            NUMBER DEFAULT NULL,
                                       p_dimension5_id            NUMBER DEFAULT NULL,
                                       p_dimension6_id            NUMBER DEFAULT NULL,
                                       p_dimension7_id            NUMBER DEFAULT NULL,
                                       p_dimension8_id            NUMBER DEFAULT NULL,
                                       p_dimension9_id            NUMBER DEFAULT NULL,
                                       p_dimension10_id           NUMBER DEFAULT NULL,
                                       p_currency_code            VARCHAR2,
                                       p_exchange_rate_type       VARCHAR2,
                                       p_exchange_rate_quotation  VARCHAR2,
                                       p_exchange_rate            NUMBER,
                                       p_entered_amount_dr        NUMBER,
                                       p_entered_amount_cr        NUMBER,
                                       p_functional_amount_dr     NUMBER,
                                       p_functional_amount_cr     NUMBER,
                                       p_gld_interface_flag       VARCHAR2,
                                       p_user_id                  NUMBER,
                                       p_usage_code               VARCHAR2) IS
  BEGIN
    --万联证券更改,可能有不含税额为0的报销单行
    /*IF (nvl(p_entered_amount_dr, 0) = 0 AND nvl(p_entered_amount_cr, 0) = 0) THEN
      RETURN;
    END IF;*/
    INSERT INTO exp_report_accounts
      (exp_report_dists_id,
       exp_report_header_id,
       exp_report_je_line_id,
       description,
       journal_date,
       period_name,
       source_code,
       company_id,
       company_segment,
       responsibility_center_id,
       account_id,
       account_segment1,
       account_segment2,
       account_segment3,
       account_segment4,
       account_segment5,
       account_segment6,
       account_segment7,
       account_segment8,
       account_segment9,
       account_segment10,
       dimension1_id,
       dimension2_id,
       dimension3_id,
       dimension4_id,
       dimension5_id,
       dimension6_id,
       dimension7_id,
       dimension8_id,
       dimension9_id,
       dimension10_id,
       currency_code,
       exchange_rate_type,
       exchange_rate_quotation,
       exchange_rate,
       entered_amount_dr,
       entered_amount_cr,
       functional_amount_dr,
       functional_amount_cr,
       gld_interface_flag,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date,
       usage_code)
    VALUES
      (p_exp_report_dists_id,
       p_exp_report_header_id,
       p_exp_report_je_line_id,
       p_description,
       p_journal_date,
       p_period_name,
       p_source_code,
       p_company_id,
       p_company_segment,
       p_responsibility_center_id,
       p_account_id,
       p_account_segment1,
       p_account_segment2,
       p_account_segment3,
       p_account_segment4,
       p_account_segment5,
       p_account_segment6,
       p_account_segment7,
       p_account_segment8,
       p_account_segment9,
       p_account_segment10,
       p_dimension1_id,
       p_dimension2_id,
       p_dimension3_id,
       p_dimension4_id,
       p_dimension5_id,
       p_dimension6_id,
       p_dimension7_id,
       p_dimension8_id,
       p_dimension9_id,
       p_dimension10_id,
       p_currency_code,
       p_exchange_rate_type,
       p_exchange_rate_quotation,
       p_exchange_rate,
       p_entered_amount_dr,
       p_entered_amount_cr,
       p_functional_amount_dr,
       p_functional_amount_cr,
       p_gld_interface_flag,
       p_user_id,
       SYSDATE,
       p_user_id,
       SYSDATE,
       p_usage_code);
  
    --生成凭证后，插入预置事件
  
    exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_CREATE_ACCOUNTS',
                                    p_document_id      => p_exp_report_dists_id,
                                    p_document_line_id => p_exp_report_je_line_id,
                                    p_source_module    => c_exp_report,
                                    p_event_type       => 'EXP_REPORT_CREATE_ACCOUNTS',
                                    p_user_id          => p_user_id);
  END insert_exp_report_accounts;

  --插入贷方凭证
  PROCEDURE insert_exp_report_accounts_c(p_payment_schedule_line_id NUMBER,
                                         p_exp_report_header_id     NUMBER,
                                         p_exp_report_je_line_id    NUMBER,
                                         p_description              VARCHAR2,
                                         p_journal_date             DATE,
                                         p_period_name              VARCHAR2,
                                         p_source_code              VARCHAR2,
                                         p_company_id               NUMBER,
                                         p_company_segment          VARCHAR2 DEFAULT NULL,
                                         p_responsibility_center_id NUMBER,
                                         p_account_id               NUMBER,
                                         p_account_segment1         VARCHAR2 DEFAULT NULL,
                                         p_account_segment2         VARCHAR2 DEFAULT NULL,
                                         p_account_segment3         VARCHAR2 DEFAULT NULL,
                                         p_account_segment4         VARCHAR2 DEFAULT NULL,
                                         p_account_segment5         VARCHAR2 DEFAULT NULL,
                                         p_account_segment6         VARCHAR2 DEFAULT NULL,
                                         p_account_segment7         VARCHAR2 DEFAULT NULL,
                                         p_account_segment8         VARCHAR2 DEFAULT NULL,
                                         p_account_segment9         VARCHAR2 DEFAULT NULL,
                                         p_account_segment10        VARCHAR2 DEFAULT NULL,
                                         p_dimension1_id            NUMBER DEFAULT NULL,
                                         p_dimension2_id            NUMBER DEFAULT NULL,
                                         p_dimension3_id            NUMBER DEFAULT NULL,
                                         p_dimension4_id            NUMBER DEFAULT NULL,
                                         p_dimension5_id            NUMBER DEFAULT NULL,
                                         p_dimension6_id            NUMBER DEFAULT NULL,
                                         p_dimension7_id            NUMBER DEFAULT NULL,
                                         p_dimension8_id            NUMBER DEFAULT NULL,
                                         p_dimension9_id            NUMBER DEFAULT NULL,
                                         p_dimension10_id           NUMBER DEFAULT NULL,
                                         p_currency_code            VARCHAR2,
                                         p_exchange_rate_type       VARCHAR2,
                                         p_exchange_rate_quotation  VARCHAR2,
                                         p_exchange_rate            NUMBER,
                                         p_entered_amount_dr        NUMBER,
                                         p_entered_amount_cr        NUMBER,
                                         p_functional_amount_dr     NUMBER,
                                         p_functional_amount_cr     NUMBER,
                                         p_gld_interface_flag       VARCHAR2,
                                         p_user_id                  NUMBER,
                                         p_usage_code               VARCHAR2) IS
  BEGIN
    INSERT INTO exp_report_accounts
      (payment_schedule_line_id,
       exp_report_header_id,
       exp_report_je_line_id,
       description,
       journal_date,
       period_name,
       source_code,
       company_id,
       company_segment,
       responsibility_center_id,
       account_id,
       account_segment1,
       account_segment2,
       account_segment3,
       account_segment4,
       account_segment5,
       account_segment6,
       account_segment7,
       account_segment8,
       account_segment9,
       account_segment10,
       dimension1_id,
       dimension2_id,
       dimension3_id,
       dimension4_id,
       dimension5_id,
       dimension6_id,
       dimension7_id,
       dimension8_id,
       dimension9_id,
       dimension10_id,
       currency_code,
       exchange_rate_type,
       exchange_rate_quotation,
       exchange_rate,
       entered_amount_dr,
       entered_amount_cr,
       functional_amount_dr,
       functional_amount_cr,
       gld_interface_flag,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date,
       usage_code)
    VALUES
      (p_payment_schedule_line_id,
       p_exp_report_header_id,
       p_exp_report_je_line_id,
       p_description,
       p_journal_date,
       p_period_name,
       p_source_code,
       p_company_id,
       p_company_segment,
       p_responsibility_center_id,
       p_account_id,
       p_account_segment1,
       p_account_segment2,
       p_account_segment3,
       p_account_segment4,
       p_account_segment5,
       p_account_segment6,
       p_account_segment7,
       p_account_segment8,
       p_account_segment9,
       p_account_segment10,
       p_dimension1_id,
       p_dimension2_id,
       p_dimension3_id,
       p_dimension4_id,
       p_dimension5_id,
       p_dimension6_id,
       p_dimension7_id,
       p_dimension8_id,
       p_dimension9_id,
       p_dimension10_id,
       p_currency_code,
       p_exchange_rate_type,
       p_exchange_rate_quotation,
       p_exchange_rate,
       p_entered_amount_dr,
       p_entered_amount_cr,
       p_functional_amount_dr,
       p_functional_amount_cr,
       p_gld_interface_flag,
       p_user_id,
       SYSDATE,
       p_user_id,
       SYSDATE,
       p_usage_code);
  
    --生成凭证后，插入预置事件
  
    exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_CREATE_ACCOUNTS',
                                    p_document_id      => p_payment_schedule_line_id,
                                    p_document_line_id => p_exp_report_je_line_id,
                                    p_source_module    => c_exp_report,
                                    p_event_type       => 'EXP_REPORT_CREATE_ACCOUNTS',
                                    p_user_id          => p_user_id);
  END insert_exp_report_accounts_c;

  --EXP5240 费用凭证调整
  PROCEDURE update_exp_report_accounts(p_exp_report_je_line_id    NUMBER,
                                       p_description              VARCHAR2,
                                       p_company_id               NUMBER,
                                       p_responsibility_center_id NUMBER,
                                       p_account_id               NUMBER,
                                       p_entered_amount_dr        NUMBER,
                                       p_entered_amount_cr        NUMBER,
                                       p_functional_amount_dr     NUMBER,
                                       p_functional_amount_cr     NUMBER,
                                       p_seg_je_category          VARCHAR2,
                                       p_segment1                 VARCHAR2,
                                       p_segment2                 VARCHAR2,
                                       p_segment3                 VARCHAR2,
                                       p_segment4                 VARCHAR2,
                                       p_segment5                 VARCHAR2,
                                       p_segment6                 VARCHAR2,
                                       p_segment7                 VARCHAR2,
                                       p_segment8                 VARCHAR2,
                                       p_segment9                 VARCHAR2,
                                       p_segment10                VARCHAR2,
                                       p_segment11                VARCHAR2,
                                       p_segment12                VARCHAR2,
                                       p_segment13                VARCHAR2,
                                       p_segment14                VARCHAR2,
                                       p_segment15                VARCHAR2,
                                       p_segment16                VARCHAR2,
                                       p_segment17                VARCHAR2,
                                       p_segment18                VARCHAR2,
                                       p_segment19                VARCHAR2,
                                       p_segment20                VARCHAR2,
                                       p_user_id                  NUMBER) IS
    e_amout_null_error    EXCEPTION;
    e_amount_double_error EXCEPTION;
    is_account_changed   NUMBER := 0;
    v_exp_report_dist_id NUMBER;
    v_exp_report_account exp_report_accounts%ROWTYPE;
    v_t0_t9_changed      VARCHAR2(1);
  BEGIN
    IF (p_entered_amount_dr IS NULL AND p_entered_amount_cr IS NULL) OR
       (p_functional_amount_dr IS NULL AND p_functional_amount_cr IS NULL) THEN
      RAISE e_amout_null_error;
    ELSIF (p_entered_amount_dr IS NOT NULL AND
          p_entered_amount_cr IS NOT NULL) OR
          (p_functional_amount_dr IS NOT NULL AND
          p_functional_amount_cr IS NOT NULL) THEN
      RAISE e_amount_double_error;
    END IF;
  
    /*    BEGIN
      SELECT 1
        INTO is_account_changed
        FROM exp_report_accounts a
       WHERE a.exp_report_je_line_id = p_exp_report_je_line_id
         AND a.account_id != p_account_id;
    EXCEPTION
      WHEN no_data_found THEN
        NULL;
    END;*/
  
    SELECT *
      INTO v_exp_report_account
      FROM exp_report_accounts a
     WHERE a.exp_report_je_line_id = p_exp_report_je_line_id;
  
    IF nvl(v_exp_report_account.account_id, -0.99) <>
       nvl(p_account_id, -0.99) OR
       nvl(v_exp_report_account.responsibility_center_id, -0.99) <>
       nvl(p_responsibility_center_id, -0.99) THEN
      v_t0_t9_changed := 'Y';
    ELSE
      v_t0_t9_changed := 'N';
    
    END IF;
    UPDATE exp_report_accounts a
       SET a.company_id               = p_company_id,
           a.responsibility_center_id = p_responsibility_center_id,
           a.account_id               = p_account_id,
           a.entered_amount_dr        = p_entered_amount_dr,
           a.entered_amount_cr        = p_entered_amount_cr,
           a.functional_amount_dr     = p_functional_amount_dr,
           a.functional_amount_cr     = p_functional_amount_cr,
           a.account_segment1        =
           (SELECT fc.company_code
              FROM fnd_companies fc
             WHERE fc.company_id = p_company_id),
           a.account_segment2        =
           (SELECT frc.responsibility_center_code
              FROM fnd_responsibility_centers frc
             WHERE frc.responsibility_center_id = p_responsibility_center_id),
           a.account_segment3        =
           (SELECT ga.account_code
              FROM gld_accounts ga
             WHERE ga.account_id = p_account_id),
           a.account_segment4         = p_segment4,
           a.account_segment5         = p_segment5,
           a.account_segment6         = p_segment6,
           a.account_segment7         = p_segment7,
           a.account_segment8         = p_segment8,
           a.account_segment9         = p_segment9,
           a.account_segment10        = p_segment10,
           a.account_segment11        = p_segment11,
           a.account_segment12        = p_segment12,
           a.account_segment13        = p_segment13,
           a.account_segment14        = p_segment14,
           a.account_segment15        = p_segment15,
           a.account_segment16        = p_segment16,
           a.account_segment17        = p_segment17,
           a.account_segment18        = p_segment18,
           a.account_segment19        = p_segment19,
           a.account_segment20        = p_segment20,
           a.je_category_code         = p_seg_je_category,
           a.last_updated_by          = p_user_id,
           a.last_update_date         = SYSDATE,
           a.description              = p_description
     WHERE a.exp_report_je_line_id = p_exp_report_je_line_id;
  
    --同步更新预付款核销凭证借方科目
    BEGIN
    
      UPDATE csh_write_off_accounts cwoa
         SET cwoa.account_id = p_account_id
      --where cwoa.write_off_je_line_id =
      --modify by zhaofan [59995]BX000000160500351创建凭证时无法修改描述
       WHERE cwoa.write_off_je_line_id IN
             (SELECT cwoa.write_off_je_line_id
                FROM csh_write_off_accounts cwoa
              --where cwoa.write_off_id =
              --modify by zhaofan [59995]BX000000160500351创建凭证时无法修改描述
               WHERE cwoa.write_off_id IN
                     (SELECT cwo.write_off_id
                        FROM csh_write_off cwo
                      --where cwo.document_line_id =
                      --modify by zhaofan [59995]BX000000160500351创建凭证时无法修改描述
                       WHERE cwo.document_line_id IN
                             (SELECT erps.payment_schedule_line_id
                                FROM exp_report_pmt_schedules erps
                              --where erps.payment_schedule_line_id =
                              --modify by zhaofan [59995]BX000000160500351创建凭证时无法修改描述
                               WHERE erps.payment_schedule_line_id IN
                                     (SELECT era.payment_schedule_line_id
                                        FROM exp_report_accounts era
                                       WHERE era.exp_report_je_line_id =
                                             p_exp_report_je_line_id
                                         AND era.functional_amount_cr IS NOT NULL)))
                 AND cwoa.functional_amount_dr IS NOT NULL);
    EXCEPTION
      WHEN OTHERS THEN
        ROLLBACK;
    END;
  
    IF v_t0_t9_changed = 'Y' THEN
      --触发EXP_REPORT_JE_LINE_UPDATE_ACCOUNT事件
      --param 为 报销单凭证行ID
      SELECT a.exp_report_dists_id
        INTO v_exp_report_dist_id
        FROM exp_report_accounts a
       WHERE a.exp_report_je_line_id = p_exp_report_je_line_id;
      exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_JE_LINE_UPDATE_ACCOUNT',
                                      p_document_id      => v_exp_report_dist_id,
                                      p_document_line_id => p_exp_report_je_line_id,
                                      p_source_module    => c_exp_report,
                                      p_event_type       => 'EXP_REPORT_JE_LINE_UPDATE_ACCOUNT',
                                      p_user_id          => p_user_id);
    END IF;
  
  EXCEPTION
    WHEN e_amount_double_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_ACCOUNT_AMOUNT_DOUBLE',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'update_exp_report_accounts');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_amout_null_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_ACCOUNT_AMOUNT_NULL',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'update_exp_report_accounts');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'update_exp_report_accounts');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END update_exp_report_accounts;
  --EXP5240 生成凭证界面新建
  PROCEDURE insert_exp_accounts_save(p_exp_report_header_id     NUMBER,
                                     p_description              VARCHAR2,
                                     p_company_id               NUMBER,
                                     p_responsibility_center_id NUMBER,
                                     p_journal_date             DATE,
                                     p_period_name              VARCHAR2,
                                     p_account_id               NUMBER,
                                     p_entered_amount_dr        NUMBER,
                                     p_entered_amount_cr        NUMBER,
                                     p_functional_amount_dr     NUMBER,
                                     p_functional_amount_cr     NUMBER,
                                     p_segment1                 VARCHAR2,
                                     p_segment2                 VARCHAR2,
                                     p_segment3                 VARCHAR2,
                                     p_segment4                 VARCHAR2,
                                     p_segment5                 VARCHAR2,
                                     p_segment6                 VARCHAR2,
                                     p_segment7                 VARCHAR2,
                                     p_segment8                 VARCHAR2,
                                     p_segment9                 VARCHAR2,
                                     p_segment10                VARCHAR2,
                                     p_segment11                VARCHAR2,
                                     p_segment12                VARCHAR2,
                                     p_segment13                VARCHAR2,
                                     p_segment14                VARCHAR2,
                                     p_segment15                VARCHAR2,
                                     p_segment16                VARCHAR2,
                                     p_segment17                VARCHAR2,
                                     p_segment18                VARCHAR2,
                                     p_segment19                VARCHAR2,
                                     p_segment20                VARCHAR2,
                                     p_user_id                  NUMBER) IS
    e_amout_null_error    EXCEPTION;
    e_amount_double_error EXCEPTION;
    v_exp_report_je_line_id      NUMBER;
    v_company_code               VARCHAR2(30);
    v_responsibility_center_code VARCHAR2(30);
    v_account_code               VARCHAR2(100);
  BEGIN
    IF (p_entered_amount_dr IS NULL AND p_entered_amount_cr IS NULL) OR
       (p_functional_amount_dr IS NULL AND p_functional_amount_cr IS NULL) THEN
      RAISE e_amout_null_error;
    ELSIF (p_entered_amount_dr IS NOT NULL AND
          p_entered_amount_cr IS NOT NULL) OR
          (p_functional_amount_dr IS NOT NULL AND
          p_functional_amount_cr IS NOT NULL) THEN
      RAISE e_amount_double_error;
    END IF;
    v_exp_report_je_line_id := get_exp_report_je_line_id;
  
    SELECT fc.company_code
      INTO v_company_code
      FROM fnd_companies fc
     WHERE fc.company_id = p_company_id;
  
    SELECT frc.responsibility_center_code
      INTO v_responsibility_center_code
      FROM fnd_responsibility_centers frc
     WHERE frc.responsibility_center_id = p_responsibility_center_id;
  
    SELECT ga.account_code
      INTO v_account_code
      FROM gld_accounts ga
     WHERE ga.account_id = p_account_id;
  
    INSERT INTO exp_report_accounts
      (exp_report_header_id,
       exp_report_je_line_id,
       description,
       journal_date,
       period_name,
       source_code,
       company_id,
       responsibility_center_id,
       account_id,
       account_segment1,
       account_segment2,
       account_segment3,
       account_segment4,
       account_segment5,
       account_segment6,
       account_segment7,
       account_segment8,
       account_segment9,
       account_segment10,
       account_segment11,
       account_segment12,
       account_segment13,
       account_segment14,
       account_segment15,
       account_segment16,
       account_segment17,
       account_segment18,
       account_segment19,
       account_segment20,
       currency_code,
       exchange_rate_type,
       exchange_rate_quotation,
       exchange_rate,
       entered_amount_dr,
       entered_amount_cr,
       functional_amount_dr,
       functional_amount_cr,
       gld_interface_flag,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date)
    VALUES
      (p_exp_report_header_id,
       v_exp_report_je_line_id,
       p_description,
       p_journal_date,
       p_period_name,
       'EXPENSE_REPORT_AUDIT',
       p_company_id,
       p_responsibility_center_id,
       p_account_id,
       v_company_code,
       v_responsibility_center_code,
       v_account_code,
       p_segment4,
       p_segment5,
       p_segment6,
       p_segment7,
       p_segment8,
       p_segment9,
       p_segment10,
       p_segment11,
       p_segment12,
       p_segment13,
       p_segment14,
       p_segment15,
       p_segment16,
       p_segment17,
       p_segment18,
       p_segment19,
       p_segment20,
       'CNY',
       NULL,
       NULL,
       1,
       p_entered_amount_dr,
       p_entered_amount_cr,
       p_functional_amount_dr,
       p_functional_amount_cr,
       'N',
       p_user_id,
       SYSDATE,
       p_user_id,
       SYSDATE);
  EXCEPTION
    WHEN e_amount_double_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_ACCOUNT_AMOUNT_DOUBLE',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'update_exp_report_accounts');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_amout_null_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_ACCOUNT_AMOUNT_NULL',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'update_exp_report_accounts');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'update_exp_report_accounts');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END insert_exp_accounts_save;
  --EXP5240 删除凭证
  PROCEDURE delete_exp_report_accounts_je(p_exp_report_header_id  NUMBER,
                                          p_exp_report_je_line_id NUMBER,
                                          p_user_id               NUMBER) IS
    v_exp_report_header_id NUMBER;
    v_count_a              NUMBER;
  BEGIN
    SELECT exp_report_header_id
      INTO v_exp_report_header_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id
       AND h.report_status = 'COMPLETELY_APPROVED'
       AND h.audit_flag = 'N'
       FOR UPDATE NOWAIT;
  
    DELETE FROM exp_report_accounts a
     WHERE a.exp_report_je_line_id = p_exp_report_je_line_id;
  
    SELECT COUNT(1)
      INTO v_count_a
      FROM exp_report_accounts a
     WHERE a.exp_report_header_id = p_exp_report_header_id;
  
    IF v_count_a = 0 THEN
    
      UPDATE exp_report_headers h
         SET h.je_creation_status = 'N'
       WHERE h.exp_report_header_id = p_exp_report_header_id;
    
      --创建报销单历史
      insert_exp_document_histories(p_document_type  => c_exp_report,
                                    p_document_id    => p_exp_report_header_id,
                                    p_operation_code => exp_document_history_pkg.c_delete_je, --'DELETE_JE',
                                    p_user_id        => p_user_id,
                                    p_operation_time => SYSDATE,
                                    p_description    => '');
    END IF;
  EXCEPTION
    WHEN no_data_found THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_DELETE_ACCOUNT_STATUS_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'EXP_REPORT_PKG',
                                                      p_procedure_function_name => 'DELETE_EXP_REPORT_ACCOUNTS');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END delete_exp_report_accounts_je;

  --EXPM/PUBLIC 删除凭证
  PROCEDURE wfl_delete_exp_report_accounts(p_exp_report_header_id  NUMBER,
                                           p_exp_report_je_line_id NUMBER,
                                           p_user_id               NUMBER) IS
    v_exp_report_header_id NUMBER;
    v_count_a              NUMBER;
  BEGIN
    SELECT exp_report_header_id
      INTO v_exp_report_header_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id
       AND h.report_status = 'SUBMITTED'
       AND h.audit_flag = 'N'
       FOR UPDATE NOWAIT;
  
    DELETE FROM exp_report_accounts a
     WHERE a.exp_report_je_line_id = p_exp_report_je_line_id;
  
    SELECT COUNT(1)
      INTO v_count_a
      FROM exp_report_accounts a
     WHERE a.exp_report_header_id = p_exp_report_header_id;
  
    IF v_count_a = 0 THEN
    
      UPDATE exp_report_headers h
         SET h.je_creation_status = 'N'
       WHERE h.exp_report_header_id = p_exp_report_header_id;
    
      --创建报销单历史
      insert_exp_document_histories(p_document_type  => c_exp_report,
                                    p_document_id    => p_exp_report_header_id,
                                    p_operation_code => exp_document_history_pkg.c_delete_je, --'DELETE_JE',
                                    p_user_id        => p_user_id,
                                    p_operation_time => SYSDATE,
                                    p_description    => '');
    END IF;
  EXCEPTION
    WHEN no_data_found THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_DELETE_ACCOUNT_STATUS_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'EXP_REPORT_PKG',
                                                      p_procedure_function_name => 'DELETE_EXP_REPORT_ACCOUNTS');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END wfl_delete_exp_report_accounts;

  FUNCTION get_employee_type_id(p_employee_id NUMBER) RETURN NUMBER IS
    v_employee_type_id exp_employees.employee_type_id%TYPE;
  BEGIN
    SELECT employee_type_id
      INTO v_employee_type_id
      FROM exp_employees
     WHERE employee_id = p_employee_id;
    RETURN v_employee_type_id;
  EXCEPTION
    WHEN no_data_found THEN
      RETURN NULL;
  END get_employee_type_id;

  FUNCTION get_partner_type_id(p_partner_category VARCHAR2,
                               p_company_id       NUMBER,
                               p_partner_id       NUMBER) RETURN NUMBER IS
    v_partner_type_id csh_partner_v.partner_type_id%TYPE;
  BEGIN
    SELECT partner_type_id
      INTO v_partner_type_id
      FROM csh_partner_v v
     WHERE v.partner_category = p_partner_category
       AND v.company_id = p_company_id
       AND v.partner_id = p_partner_id;
    RETURN v_partner_type_id;
  EXCEPTION
    WHEN no_data_found THEN
      RETURN NULL;
  END get_partner_type_id;

  --取自进项分类定义中对应的进项税科目 modify by wxq 20180409
  FUNCTION get_account_by_vat_in(p_input_tax_structure_detail VARCHAR2)
    RETURN NUMBER IS
    v_account_id NUMBER;
  BEGIN
    SELECT v.account_id
      INTO v_account_id
      FROM exp_ygz_input_tax_struc_dtl dtl, gld_accounts v
     WHERE dtl.type_code = p_input_tax_structure_detail
       AND dtl.input_tax_account = v.account_code;
    RETURN v_account_id;
  EXCEPTION
    WHEN no_data_found THEN
      RETURN - 1;
  END;
  --进项税转出凭证科目的取值取自进项分类定义中对应的进项税转出科目 modify by wxq 20180409
  FUNCTION get_account_by_vat_out(p_input_tax_structure_detail VARCHAR2)
    RETURN NUMBER IS
    v_account_id NUMBER;
  BEGIN
    SELECT v.account_id
      INTO v_account_id
      FROM exp_ygz_input_tax_struc_dtl dtl, gld_accounts v
     WHERE dtl.type_code = p_input_tax_structure_detail
       AND dtl.input_tax_transfer_account = v.account_code;
    RETURN v_account_id;
  EXCEPTION
    WHEN no_data_found THEN
      RETURN - 1;
  END;

  --=====================================================
  --国任财险报销单创建凭证
  --=====================================================
  FUNCTION create_er_accounts_grcx(p_exp_rep_header_id NUMBER,
                                   p_journal_date      DATE,
                                   p_user_id           NUMBER,
                                   p_batch_id          NUMBER,
                                   p_period_name       VARCHAR2)
    RETURN VARCHAR2 IS
    CURSOR cur_line(p_rep_header_id NUMBER) IS
      SELECT d.*,
             l.line_number,
             l.tax_type_id,
             l.invoice_type AS line_invoice_type, --modified by HM @2016-04-13 增加发票类型
             ey.special_invoice,
             l.place_to_id,
             l.meetting_name
        FROM exp_report_dists      d,
             exp_report_lines      l,
             exp_ygz_invoice_types ey
       WHERE d.exp_report_line_id = l.exp_report_line_id
         AND l.exp_report_header_id = p_exp_rep_header_id
         AND l.invoice_type = ey.type_code;
  
    v_exp_report_dists    cur_line%ROWTYPE;
    v_dist                exp_report_dists%ROWTYPE;
    v_exp_report_accounts exp_report_accounts%ROWTYPE;
  
    v_header_company_id      exp_report_headers.company_id %TYPE;
    v_employee_id            exp_report_headers.employee_id %TYPE;
    v_exp_report_number      exp_report_headers.exp_report_number %TYPE;
    v_employee_type_id       exp_employees.employee_type_id%TYPE;
    v_expense_user_group_id  exp_report_headers.expense_user_group_id %TYPE;
    v_expense_report_type_id exp_report_headers.exp_report_type_id %TYPE;
    v_rep_header_desc        exp_report_headers.description %TYPE;
    v_exp_account_desc       exp_report_accounts.description%TYPE;
  
    v_exchange_rate      exp_currency_code_tmp.exchange_rate%TYPE;
    v_exchange_rate_type exp_currency_code_tmp.exchange_rate_type%TYPE;
  
    v_period_comparison    VARCHAR2(30);
    v_dists_period_num     NUMBER;
    v_operation_period_num NUMBER;
    v_standard_currency    VARCHAR2(30); --本位币
    v_partner_type_id      NUMBER;
    v_adjust_exp_dists_id  NUMBER;
    v_adjust_amount        NUMBER;
    v_usedes_id            NUMBER; --付款用途代码id
    v_tax_type_rate        NUMBER; --税率
    v_tax_category         VARCHAR2(30); --税率类别
    v_tax_amount           NUMBER; --税金金额
    v_tax_function_amount  NUMBER; --税金本位币金额
    v_currency_precision   NUMBER;
    v_pmt_count            NUMBER := 0; --计划付款行行数，用于创建贷方凭证的时候做尾差处理
    v_pmt_length           NUMBER;
  
    v_exp_header        exp_report_headers%ROWTYPE;
    v_functional_amount NUMBER;
  
    v_page_type VARCHAR2(30);
  
    e_acc_error EXCEPTION;
    --modified by HM @2016-04-07营改增改动
    v_tax_exp_report_je_line_id NUMBER;
    v_tax_account_id            NUMBER;
    v_entered_amount_dr_tax     NUMBER := 0;
    v_functional_amount_dr_tax  NUMBER := 0;
  
    v_flag       VARCHAR2(1);
    v_company_id NUMBER;
  
    v_usage_type             VARCHAR2(10); --建信人寿 抵扣规则
    v_t3_value               VARCHAR2(10); --T3映射值
    v_line_desc_flag         VARCHAR2(1); --报销类型是否使用行说明 --modify by wxq
    v_employee_name          VARCHAR2(50);
    v_expense_item_name      VARCHAR2(50);
    v_place_desc             VARCHAR2(50);
    v_desc                   VARCHAR2(200);
    v_desc1                  VARCHAR2(200);
    v_line_desc_flag1        VARCHAR2(1);
    v_line_desc              VARCHAR2(200);
    v_company_level          VARCHAR2(50);
    v_company_level2         VARCHAR2(50);
    v_special_invoice        VARCHAR2(1);
    v_default_invoice_status VARCHAR2(30);
    v_usage_type_code        VARCHAR2(30);
    v_sum_tax_amount         NUMBER;
    v_invoice_tax_amount     NUMBER;
    v_expense_item_code      VARCHAR2(30);
    v_account_code           VARCHAR2(30);
  
    v_invoice_ce NUMBER;
  BEGIN
    DELETE FROM exp_report_accounts t
     WHERE t.exp_report_header_id = p_exp_rep_header_id;
  
    SELECT nvl(v.pay_company_id, v.company_id), --修改为头上支付公司15798
           v.employee_id,
           v.expense_user_group_id,
           v.exp_report_type_id,
           v.description,
           v.exp_report_number
      INTO v_header_company_id,
           v_employee_id,
           v_expense_user_group_id,
           v_expense_report_type_id,
           v_rep_header_desc,
           v_exp_report_number
      FROM exp_report_headers v
     WHERE v.exp_report_header_id = p_exp_rep_header_id;
  
    v_exp_report_accounts.period_name := p_period_name;
    v_employee_type_id                := get_employee_type_id(v_employee_id);
  
    OPEN cur_line(p_exp_rep_header_id);
    LOOP
      FETCH cur_line
        INTO v_exp_report_dists;
      EXIT WHEN cur_line%NOTFOUND;
    
      DELETE FROM exp_report_accounts t
       WHERE t.exp_report_dists_id = v_exp_report_dists.exp_report_dists_id;
    
      g_line_number              := v_exp_report_dists.line_number;
      g_exp_report_dists_id      := v_exp_report_dists.exp_report_dists_id;
      g_responsibility_center_id := v_exp_report_dists.responsibility_center_id;
    
      SELECT gc.precision
        INTO v_currency_precision
        FROM gld_currency gc
       WHERE gc.currency_code = v_exp_report_dists.currency_code;
    
      IF v_exp_report_dists.tax_type_id IS NOT NULL THEN
        BEGIN
          SELECT c.tax_type_rate, c.tax_category
            INTO v_tax_type_rate, v_tax_category
            FROM fnd_tax_type_codes c
           WHERE c.tax_type_id = v_exp_report_dists.tax_type_id;
        EXCEPTION
          WHEN no_data_found THEN
            CLOSE cur_line;
            RETURN 'EXP5140_EXP_ACCOUNTS_TAX_ERROR';
        END;
      END IF;
    
      --modify by wxq 
      /*
       i.  如果未勾选需要加行说明，则凭证行取值规则为：报销人+‘报’+目的地+费用项目+会议（培训）名称。
      ii.  如果勾选了需要加行说明，则凭证行取值规则为：报销人+‘报’+目的地+费用项目+会议（培训）名称+行说明
      */
      SELECT t.line_desc_flag
        INTO v_line_desc_flag
        FROM exp_expense_types t
       WHERE t.expense_type_id = v_exp_report_dists.expense_type_id;
    
      SELECT e.name
        INTO v_employee_name
        FROM exp_employees e
       WHERE e.employee_id = v_employee_id;
    
      SELECT ei.description, ei.expense_item_code
        INTO v_expense_item_name, v_expense_item_code
        FROM exp_expense_items_vl ei
       WHERE ei.expense_item_id = v_exp_report_dists.expense_item_id;
      BEGIN
        SELECT p.place_desc
          INTO v_place_desc
          FROM exp_policy_places_vl p
         WHERE p.place_id = v_exp_report_dists.place_to_id;
      EXCEPTION
        WHEN no_data_found THEN
          v_place_desc := '';
      END;
      v_desc := v_employee_name || '报销【' || v_expense_item_name || '】';
    
      SELECT v_employee_name || '报' ||
             (SELECT p.place_desc
                FROM exp_policy_places_vl p
               WHERE p.place_id = l.place_to_id) ||
             (SELECT ei.description
                FROM exp_expense_items_vl ei
               WHERE ei.expense_item_id = l.expense_item_id) /* ||
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    l.meetting_name*/,
             (SELECT t.line_desc_flag
                FROM exp_expense_types t
               WHERE t.expense_type_id = l.expense_type_id),
             l.description
        INTO v_desc1, v_line_desc_flag1, v_line_desc
        FROM exp_report_lines l
       WHERE l.exp_report_header_id = p_exp_rep_header_id
         AND rownum = 1;
    
      IF v_line_desc_flag1 = 'Y' THEN
        v_desc1 := v_desc1 || v_line_desc;
      
      END IF;
    
      IF v_exp_report_dists.company_id = v_header_company_id THEN
        --分配行公司 = 报销单头公司
        v_standard_currency := gld_common_pkg.get_company_currency_code(v_header_company_id);
        ----------------借方 -------------
        -- 摘要 取报销单头说明
        --v_exp_account_desc := v_rep_header_desc;
      
        v_exp_account_desc := v_exp_report_dists.description;
      
        --业务期间
        v_dists_period_num := gld_common_pkg.get_gld_internal_period_num(v_header_company_id,
                                                                         v_exp_report_dists.period_name);
        --审核期间
        v_operation_period_num := gld_common_pkg.get_gld_internal_period_num(v_header_company_id,
                                                                             p_period_name);
        IF v_dists_period_num > v_operation_period_num THEN
          v_period_comparison := 'EARLIER';
        ELSIF v_dists_period_num = v_operation_period_num THEN
          v_period_comparison := 'IN';
        ELSE
          v_period_comparison := 'LATER';
        END IF;
      
        ---借方--------
        acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                    p_user_id    => p_user_id);
        acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                               p_expense_user_group_id  => v_expense_user_group_id,
                                                               p_expense_report_type_id => v_expense_report_type_id,
                                                               p_currency_code          => v_exp_report_dists.currency_code,
                                                               p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                               p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                               p_period_comparison      => v_period_comparison,
                                                               p_employee_type_id       => v_employee_type_id,
                                                               p_org_unit               => v_exp_report_dists.unit_id,
                                                               --add by Qu yuanyuan
                                                               p_du_id => v_exp_report_dists.dimension6_id);
      
        v_exp_report_accounts.account_id := acc_builder_employee_exp_pkg.get_account;
        IF v_exp_report_accounts.account_id = -1 THEN
          CLOSE cur_line;
          RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
        END IF;
      
        --取默认责任中心
        -- v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
        v_exp_report_accounts.responsibility_center_id := v_exp_report_dists.responsibility_center_id;
        IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
          CLOSE cur_line;
          RETURN 'EXP5140_RESP_CENTER_ERROR';
        END IF;
      
        v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
      
        IF v_exp_report_dists.special_invoice = 'Y' THEN
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.sale_amount;
        ELSE
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount;
        END IF;
      
        v_exp_report_accounts.functional_amount_dr := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                            p_amount                  => v_exp_report_accounts.entered_amount_dr,
                                                                            p_batch_id                => p_batch_id,
                                                                            p_company_id              => v_header_company_id,
                                                                            p_exchange_rate_type      => v_exchange_rate_type,
                                                                            p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                            p_exchange_rate           => v_exchange_rate,
                                                                            p_standard_currency       => v_standard_currency);
      
        v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
        v_exp_report_accounts.exchange_rate      := v_exchange_rate;
        v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
      
        insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                   p_exp_report_header_id     => p_exp_rep_header_id,
                                   p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                   p_description              => v_desc, --modify by wxq 20180418 修改费用凭证借方摘要,,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                   p_company_id               => v_header_company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_exp_report_accounts.account_id,
                                   p_currency_code            => v_exp_report_accounts.currency_code,
                                   p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                   p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                   p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                   p_entered_amount_dr        => v_exp_report_accounts.entered_amount_dr,
                                   p_functional_amount_dr     => v_exp_report_accounts.entered_amount_dr,
                                   p_entered_amount_cr        => '',
                                   p_functional_amount_cr     => '',
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'EMPLOYEE_EXPENSE');
      
        -----------------------------------------------------------------------------------------------------------
        -- 增值税修改  update  by robin 2016-04-14
      
        v_entered_amount_dr_tax    := nvl(v_exp_report_dists.tax_amount, 0);
        v_functional_amount_dr_tax := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                            p_amount                  => v_entered_amount_dr_tax,
                                                            p_batch_id                => p_batch_id,
                                                            p_company_id              => v_header_company_id,
                                                            p_exchange_rate_type      => v_exchange_rate_type,
                                                            p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                            p_exchange_rate           => v_exchange_rate,
                                                            p_standard_currency       => v_standard_currency);
      
        --当发票状态为可抵扣且视同专票标识为Y，生成进项税分录
        SELECT e.special_invoice, e.default_invoice_status
          INTO v_special_invoice, v_default_invoice_status
          FROM exp_ygz_invoice_types e
         WHERE e.type_code =
               (SELECT l.invoice_type
                  FROM exp_report_lines l
                 WHERE l.exp_report_line_id =
                       v_exp_report_dists.exp_report_line_id);
      
        BEGIN
          SELECT e.type_code
            INTO v_usage_type_code
            FROM exp_ygz_usage_types e
           WHERE e.type_code =
                 (SELECT l.usage_type
                    FROM exp_report_lines l
                   WHERE l.exp_report_line_id =
                         v_exp_report_dists.exp_report_line_id);
        EXCEPTION
          WHEN no_data_found THEN
            v_usage_type_code := NULL;
        END;
      
        --待抵扣
        --IF v_default_invoice_status = '20' THEN
        --视同专票
        IF (v_special_invoice = 'Y' AND
           substr(v_exp_report_dists.used_type, 4) = 'DEDUCT') THEN
          --取进项税科目
          acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
          --根据营改增使用的用途代码，失效相应的参数，这里只保留单据类型ID
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => NULL, --v_employee_id,
                                                                 p_expense_user_group_id  => NULL, --v_expense_user_group_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => NULL, --v_exp_report_dists.currency_code, 
                                                                 p_expense_item_id        => NULL, --v_exp_report_dists.expense_item_id,   跳过选择费用科目
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                 p_period_comparison      => NULL, --v_period_comparison,
                                                                 p_employee_type_id       => NULL, --v_employee_type_id,
                                                                 p_org_unit               => NULL, --v_exp_report_dists.unit_id
                                                                 --add by Qu yuanyuan
                                                                 p_du_id => NULL --v_exp_report_dists.dimension6_id
                                                                 );
        
          v_tax_account_id := acc_builder_employee_exp_pkg.get_account;
        
          IF v_tax_account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_dists.company_id);
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          --借
          v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_tax_account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_entered_amount_dr_tax,
                                     p_functional_amount_dr     => v_entered_amount_dr_tax,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_TAX');
        
          --不可抵扣，系统自动进项转出（发票类型视同专票标识为Y，且搭配的费用用途为TRANSFER_OUT）
        ELSIF (v_special_invoice = 'Y' AND
              substr(v_exp_report_dists.used_type, 4) = 'TRANSFER_OUT') THEN
        
          --取进项税科目
          acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
          --根据营改增使用的用途代码，失效相应的参数，这里只保留单据类型ID
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => NULL, --v_employee_id,
                                                                 p_expense_user_group_id  => NULL, --v_expense_user_group_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => NULL, --v_exp_report_dists.currency_code, 
                                                                 p_expense_item_id        => NULL, --v_exp_report_dists.expense_item_id,   跳过选择费用科目
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                 p_period_comparison      => NULL, --v_period_comparison,
                                                                 p_employee_type_id       => NULL, --v_employee_type_id,
                                                                 p_org_unit               => NULL, --v_exp_report_dists.unit_id
                                                                 --add by Qu yuanyuan
                                                                 p_du_id => NULL --v_exp_report_dists.dimension6_id
                                                                 );
        
          v_tax_account_id := acc_builder_employee_exp_pkg.get_account;
        
          IF v_tax_account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_dists.company_id);
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          --借
          v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_tax_account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_entered_amount_dr_tax,
                                     p_functional_amount_dr     => v_entered_amount_dr_tax,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_TAX');
        
          ---借方--------
          acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                                 p_expense_user_group_id  => v_expense_user_group_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => v_exp_report_dists.currency_code,
                                                                 p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                 p_period_comparison      => v_period_comparison,
                                                                 p_employee_type_id       => v_employee_type_id,
                                                                 p_org_unit               => v_exp_report_dists.unit_id,
                                                                 --add by Qu yuanyuan
                                                                 p_du_id => v_exp_report_dists.dimension6_id);
        
          v_exp_report_accounts.account_id := acc_builder_employee_exp_pkg.get_account;
          IF v_exp_report_accounts.account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          --取默认责任中心
          v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_dists.company_id);
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        
          v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
          v_exp_report_accounts.exchange_rate      := v_exchange_rate;
          v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
        
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_entered_amount_dr_tax,
                                     p_functional_amount_dr     => v_entered_amount_dr_tax,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE');
        
          ----贷方凭证----
          --取进项税转出科目
        
          acc_builder_employee_exp_pkg.set_roll_process_id(p_company_id => v_header_company_id,
                                                           p_user_id    => p_user_id);
          --进项转出，这里只保留费用用途ID
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => NULL, --v_employee_id,
                                                                 p_expense_user_group_id  => NULL, --v_expense_user_group_id,
                                                                 p_expense_report_type_id => NULL,
                                                                 p_currency_code          => NULL, --v_exp_report_dists.currency_code, 
                                                                 p_expense_item_id        => NULL, --v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => NULL,
                                                                 p_period_comparison      => NULL, --v_period_comparison,
                                                                 p_employee_type_id       => NULL, --v_employee_type_id,
                                                                 p_org_unit               => NULL, --v_exp_report_dists.unit_id
                                                                 --add by Qu yuanyuan
                                                                 p_du_id           => NULL, --v_exp_report_dists.dimension6_id
                                                                 p_usage_type_code => v_usage_type_code --费用用途代码
                                                                 );
        
          v_tax_account_id := acc_builder_employee_exp_pkg.get_roll_account;
        
          IF v_tax_account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_dists.company_id);
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          --贷
          v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_tax_account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => '',
                                     p_functional_amount_dr     => '',
                                     p_entered_amount_cr        => v_entered_amount_dr_tax,
                                     p_functional_amount_cr     => v_entered_amount_dr_tax,
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_TAX');
        
          --视同销售业务，产生视同销售销项税（费用用途为AS_SALES）
        ELSIF substr(v_exp_report_dists.used_type, 4) = 'AS_SALES' THEN
          ---借方--------
          acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                                 p_expense_user_group_id  => v_expense_user_group_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => v_exp_report_dists.currency_code,
                                                                 p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                 p_period_comparison      => v_period_comparison,
                                                                 p_employee_type_id       => v_employee_type_id,
                                                                 p_org_unit               => v_exp_report_dists.unit_id,
                                                                 --add by Qu yuanyuan
                                                                 p_du_id => v_exp_report_dists.dimension6_id);
        
          v_exp_report_accounts.account_id := acc_builder_employee_exp_pkg.get_account;
          IF v_exp_report_accounts.account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          --取默认责任中心
          v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_dists.company_id);
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        
          v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
          v_exp_report_accounts.exchange_rate      := v_exchange_rate;
          v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
        
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => 0,
                                     p_functional_amount_dr     => 0,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE');
        
          SELECT g.account_id
            INTO v_tax_account_id
            FROM gld_accounts g
           WHERE g.account_code = '2221151011'; --应付税费-应交增值税-销项税额-视同销售
        
          --贷
          v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_tax_account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => '',
                                     p_functional_amount_dr     => '',
                                     p_entered_amount_cr        => 0,
                                     p_functional_amount_cr     => 0,
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_SALES');
        
        END IF;
      
        --费用项目为低值易耗品项目，匹配系统代码中配置费用项目时，添加借贷分录
        BEGIN
          SELECT sv.code_value_name
            INTO v_account_code
            FROM sys_codes s, sys_code_values_vl sv
           WHERE s.code_id = sv.code_id
             AND s.code = 'EMPLOYEE_EXPENSE_LOW_PRICE'
             AND sv.code_value = v_expense_item_code;
        EXCEPTION
          WHEN no_data_found THEN
            NULL;
        END;
      
        IF v_account_code IS NOT NULL THEN
        
          SELECT g.account_id
            INTO v_tax_account_id
            FROM gld_accounts g
           WHERE g.account_code = TRIM(v_account_code);
        
          ---借方--------
        
          --取默认责任中心
          v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_dists.company_id);
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        
          v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
          v_exp_report_accounts.exchange_rate      := v_exchange_rate;
          v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
        
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_tax_account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_exp_report_accounts.entered_amount_dr,
                                     p_functional_amount_dr     => v_exp_report_accounts.entered_amount_dr,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_LOW_PRICE');
        
          /*SELECT g.account_id
           INTO v_tax_account_id
           FROM gld_accounts g
          WHERE g.account_code = TRIM(v_account_code);*/
        
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_tax_account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => '',
                                     p_functional_amount_dr     => '',
                                     p_entered_amount_cr        => v_exp_report_accounts.entered_amount_dr,
                                     p_functional_amount_cr     => v_exp_report_accounts.entered_amount_dr,
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_LOW_PRICE');
        END IF;
        ---------------------------------------------------------------------------------------------------------                            
      ELSE
        --分配行公司 <> 报销单头公司
        v_standard_currency := gld_common_pkg.get_company_currency_code(v_header_company_id);
      
        ----------------借方 1  -------------
        -- 摘要 取分配行说明
        v_exp_account_desc := v_exp_report_dists.description;
      
        --业务期间
        v_dists_period_num := gld_common_pkg.get_gld_internal_period_num(v_exp_report_dists.company_id,
                                                                         v_exp_report_dists.period_name);
        --审核期间
        v_operation_period_num := gld_common_pkg.get_gld_internal_period_num(v_exp_report_dists.company_id,
                                                                             p_period_name);
        IF v_dists_period_num > v_operation_period_num THEN
          v_period_comparison := 'EARLIER';
        ELSIF v_dists_period_num = v_operation_period_num THEN
          v_period_comparison := 'IN';
        ELSE
          v_period_comparison := 'LATER';
        END IF;
      
        ----借方------
        acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_exp_report_dists.company_id,
                                                    p_user_id    => p_user_id);
        acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                               p_expense_user_group_id  => v_expense_user_group_id,
                                                               p_expense_report_type_id => v_expense_report_type_id,
                                                               p_currency_code          => v_exp_report_dists.currency_code,
                                                               p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                               p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                               p_period_comparison      => v_period_comparison,
                                                               p_employee_type_id       => v_employee_type_id,
                                                               p_org_unit               => v_exp_report_dists.unit_id,
                                                               --add by Qu yuanyuan
                                                               p_du_id => v_exp_report_dists.dimension6_id);
      
        v_exp_report_accounts.account_id := acc_builder_employee_exp_pkg.get_account;
        IF v_exp_report_accounts.account_id = -1 THEN
          CLOSE cur_line;
          RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
        END IF;
      
        --取默认责任中心
        v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
        IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
          CLOSE cur_line;
          RETURN 'EXP5140_RESP_CENTER_ERROR';
        END IF;
      
        v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
      
        IF v_exp_report_dists.special_invoice = 'Y' THEN
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.sale_amount;
        ELSE
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount;
        END IF;
      
        v_exp_report_accounts.functional_amount_dr := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                            p_amount                  => v_exp_report_accounts.entered_amount_dr,
                                                                            p_batch_id                => p_batch_id,
                                                                            p_company_id              => v_exp_report_dists.company_id,
                                                                            p_exchange_rate_type      => v_exchange_rate_type,
                                                                            p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                            p_exchange_rate           => v_exchange_rate,
                                                                            p_standard_currency       => v_standard_currency);
      
        v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
        v_exp_report_accounts.exchange_rate      := v_exchange_rate;
        v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
        --借费用
        insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                   p_exp_report_header_id     => p_exp_rep_header_id,
                                   p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                   p_description              => v_desc, --modify by wxq 20180418 修改费用凭证借方摘要,,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                   p_company_id               => v_exp_report_dists.company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_exp_report_accounts.account_id,
                                   p_currency_code            => v_exp_report_accounts.currency_code,
                                   p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                   p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                   p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                   p_entered_amount_dr        => v_exp_report_accounts.entered_amount_dr,
                                   p_functional_amount_dr     => v_exp_report_accounts.entered_amount_dr,
                                   p_entered_amount_cr        => '',
                                   p_functional_amount_cr     => '',
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'EMPLOYEE_EXPENSE');
      
        -----------------------------------------------------------------------------------------------------------
        -- 增值税修改  update  by robin 2016-04-14
      
        v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
        v_entered_amount_dr_tax     := nvl(v_exp_report_dists.tax_amount, 0);
        v_functional_amount_dr_tax  := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                             p_amount                  => v_entered_amount_dr_tax,
                                                             p_batch_id                => p_batch_id,
                                                             p_company_id              => v_header_company_id,
                                                             p_exchange_rate_type      => v_exchange_rate_type,
                                                             p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                             p_exchange_rate           => v_exchange_rate,
                                                             p_standard_currency       => v_standard_currency);
      
        --当发票状态为可抵扣且视同专票标识为Y，生成进项税分录
        SELECT e.special_invoice, e.default_invoice_status
          INTO v_special_invoice, v_default_invoice_status
          FROM exp_ygz_invoice_types e
         WHERE e.type_code =
               (SELECT l.invoice_type
                  FROM exp_report_lines l
                 WHERE l.exp_report_line_id =
                       v_exp_report_dists.exp_report_line_id);
      
        BEGIN
          SELECT e.type_code
            INTO v_usage_type_code
            FROM exp_ygz_usage_types e
           WHERE e.type_code =
                 (SELECT l.usage_type
                    FROM exp_report_lines l
                   WHERE l.exp_report_line_id =
                         v_exp_report_dists.exp_report_line_id);
        EXCEPTION
          WHEN no_data_found THEN
            v_usage_type_code := NULL;
        END;
        --待抵扣
        --IF v_default_invoice_status = '20' THEN
        --视同销售
        IF (v_special_invoice = 'Y' AND
           substr(v_exp_report_dists.used_type, 4) = 'DEDUCT') THEN
          --取进项税科目
          acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
          --根据营改增使用的用途代码，失效相应的参数，这里只保留单据类型ID
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => NULL, --v_employee_id,
                                                                 p_expense_user_group_id  => NULL, --v_expense_user_group_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => NULL, --v_exp_report_dists.currency_code, 
                                                                 p_expense_item_id        => NULL, --v_exp_report_dists.expense_item_id,   跳过选择费用科目
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                 p_period_comparison      => NULL, --v_period_comparison,
                                                                 p_employee_type_id       => NULL, --v_employee_type_id,
                                                                 p_org_unit               => NULL, --v_exp_report_dists.unit_id
                                                                 --add by Qu yuanyuan
                                                                 p_du_id => NULL --v_exp_report_dists.dimension6_id
                                                                 );
        
          v_tax_account_id := acc_builder_employee_exp_pkg.get_account;
        
          IF v_tax_account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_dists.company_id);
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          --借
          v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_tax_account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_entered_amount_dr_tax,
                                     p_functional_amount_dr     => v_entered_amount_dr_tax,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_TAX');
        
          /*END IF;
          ELSE*/
          --不可抵扣，系统自动进项转出（发票类型视同专票标识为Y，且搭配的费用用途为TRANSFER_OUT）
        ELSIF (v_special_invoice = 'Y' AND
              substr(v_exp_report_dists.used_type, 4) = 'TRANSFER_OUT') THEN
        
          --取进项税科目
          acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
          --根据营改增使用的用途代码，失效相应的参数，这里只保留单据类型ID
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => NULL, --v_employee_id,
                                                                 p_expense_user_group_id  => NULL, --v_expense_user_group_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => NULL, --v_exp_report_dists.currency_code, 
                                                                 p_expense_item_id        => NULL, --v_exp_report_dists.expense_item_id,   跳过选择费用科目
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                 p_period_comparison      => NULL, --v_period_comparison,
                                                                 p_employee_type_id       => NULL, --v_employee_type_id,
                                                                 p_org_unit               => NULL, --v_exp_report_dists.unit_id
                                                                 --add by Qu yuanyuan
                                                                 p_du_id => NULL --v_exp_report_dists.dimension6_id
                                                                 );
        
          v_tax_account_id := acc_builder_employee_exp_pkg.get_account;
        
          IF v_tax_account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_dists.company_id);
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          --借
          v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_tax_account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_entered_amount_dr_tax,
                                     p_functional_amount_dr     => v_entered_amount_dr_tax,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_TAX');
        
          ---借方--------
          acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                                 p_expense_user_group_id  => v_expense_user_group_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => v_exp_report_dists.currency_code,
                                                                 p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                 p_period_comparison      => v_period_comparison,
                                                                 p_employee_type_id       => v_employee_type_id,
                                                                 p_org_unit               => v_exp_report_dists.unit_id,
                                                                 --add by Qu yuanyuan
                                                                 p_du_id => v_exp_report_dists.dimension6_id);
        
          v_exp_report_accounts.account_id := acc_builder_employee_exp_pkg.get_account;
          IF v_exp_report_accounts.account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          --取默认责任中心
          v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        
          /*v_exp_report_accounts.entered_amount_dr    := v_exp_report_dists.sale_amount;
          v_exp_report_accounts.functional_amount_dr := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                              p_amount                  => v_exp_report_accounts.entered_amount_dr,
                                                                              p_batch_id                => p_batch_id,
                                                                              p_company_id              => v_header_company_id,
                                                                              p_exchange_rate_type      => v_exchange_rate_type,
                                                                              p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                              p_exchange_rate           => v_exchange_rate,
                                                                              p_standard_currency       => v_standard_currency);*/
        
          v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
          v_exp_report_accounts.exchange_rate      := v_exchange_rate;
          v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
        
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_entered_amount_dr_tax,
                                     p_functional_amount_dr     => v_entered_amount_dr_tax,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE');
        
          ----贷方凭证----
          --取进项税科目
          acc_builder_employee_exp_pkg.set_roll_process_id(p_company_id => v_header_company_id,
                                                           p_user_id    => p_user_id);
          --进项转出，这里只保留费用用途ID
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => NULL, --v_employee_id,
                                                                 p_expense_user_group_id  => NULL, --v_expense_user_group_id,
                                                                 p_expense_report_type_id => NULL,
                                                                 p_currency_code          => NULL, --v_exp_report_dists.currency_code, 
                                                                 p_expense_item_id        => NULL, --v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => NULL,
                                                                 p_period_comparison      => NULL, --v_period_comparison,
                                                                 p_employee_type_id       => NULL, --v_employee_type_id,
                                                                 p_org_unit               => NULL, --v_exp_report_dists.unit_id
                                                                 --add by Qu yuanyuan
                                                                 p_du_id           => NULL, --v_exp_report_dists.dimension6_id
                                                                 p_usage_type_code => v_usage_type_code --费用用途id
                                                                 );
        
          v_tax_account_id := acc_builder_employee_exp_pkg.get_roll_account;
        
          IF v_tax_account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_dists.company_id);
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          --贷
          v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_tax_account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => '',
                                     p_functional_amount_dr     => '',
                                     p_entered_amount_cr        => v_entered_amount_dr_tax,
                                     p_functional_amount_cr     => v_entered_amount_dr_tax,
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_TAX');
          --视同销售业务，产生视同销售销项税（费用用途为AS_SALES）
        ELSIF substr(v_exp_report_dists.used_type, 4) = 'AS_SALES' THEN
          ---借方--------
          acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                                 p_expense_user_group_id  => v_expense_user_group_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => v_exp_report_dists.currency_code,
                                                                 p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                 p_period_comparison      => v_period_comparison,
                                                                 p_employee_type_id       => v_employee_type_id,
                                                                 p_org_unit               => v_exp_report_dists.unit_id,
                                                                 --add by Qu yuanyuan
                                                                 p_du_id => v_exp_report_dists.dimension6_id);
        
          v_exp_report_accounts.account_id := acc_builder_employee_exp_pkg.get_account;
          IF v_exp_report_accounts.account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          --取默认责任中心
          v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_dists.company_id);
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        
          v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
          v_exp_report_accounts.exchange_rate      := v_exchange_rate;
          v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
        
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => 0,
                                     p_functional_amount_dr     => 0,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE');
        
          SELECT g.account_id
            INTO v_tax_account_id
            FROM gld_accounts g
           WHERE g.account_code = '2221151011'; --应付税费-应交增值税-销项税额-视同销售
        
          --贷
          v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_tax_account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => '',
                                     p_functional_amount_dr     => '',
                                     p_entered_amount_cr        => 0,
                                     p_functional_amount_cr     => 0,
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_SALES');
        
        END IF;
      
        --费用项目为低值易耗品项目，匹配系统代码中配置费用项目时，添加借贷分录
        BEGIN
          SELECT sv.code_value_name
            INTO v_account_code
            FROM sys_codes s, sys_code_values_vl sv
           WHERE s.code_id = sv.code_id
             AND s.code = 'EMPLOYEE_EXPENSE_LOW_PRICE'
             AND sv.code_value = v_expense_item_code;
        EXCEPTION
          WHEN no_data_found THEN
            NULL;
        END;
      
        IF v_account_code IS NOT NULL THEN
        
          SELECT g.account_id
            INTO v_tax_account_id
            FROM gld_accounts g
           WHERE g.account_code = TRIM(v_account_code);
        
          ---借方--------
        
          --取默认责任中心
          v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_dists.company_id);
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        
          v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
          v_exp_report_accounts.exchange_rate      := v_exchange_rate;
          v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
        
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_tax_account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_exp_report_accounts.entered_amount_dr,
                                     p_functional_amount_dr     => v_exp_report_accounts.entered_amount_dr,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_LOW_PRICE');
        
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_tax_account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => '',
                                     p_functional_amount_dr     => '',
                                     p_entered_amount_cr        => v_exp_report_accounts.entered_amount_dr,
                                     p_functional_amount_cr     => v_exp_report_accounts.entered_amount_dr,
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_LOW_PRICE');
        END IF;
      
        --------------------------------------------end -------------------------------------------------------------                         
      
        ----------------借方 2 -------------
        v_exp_account_desc := v_exp_report_dists.description;
      
        acc_builder_emp_company_ar_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
        acc_builder_emp_company_ar_pkg.create_mapping_conditions(p_company_id             => v_exp_report_dists.company_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => v_exp_report_dists.currency_code,
                                                                 p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id);
      
        v_exp_report_accounts.account_id := acc_builder_emp_company_ar_pkg.get_account;
        IF v_exp_report_accounts.account_id = -1 THEN
          CLOSE cur_line;
          RETURN 'EXP5140_GET_INTERCOMPANY_AR_ACC_ERROR';
        END IF;
      
        --取默认责任中心
        v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
        IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
          CLOSE cur_line;
          RETURN 'EXP5140_RESP_CENTER_ERROR';
        END IF;
      
        v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        IF v_exp_report_dists.special_invoice = 'Y' THEN
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.sale_amount;
        ELSE
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount;
        END IF;
      
        v_exp_report_accounts.functional_amount_dr := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                            p_amount                  => v_exp_report_accounts.entered_amount_dr,
                                                                            p_batch_id                => p_batch_id,
                                                                            p_company_id              => v_exp_report_dists.company_id,
                                                                            p_exchange_rate_type      => v_exchange_rate_type,
                                                                            p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                            p_exchange_rate           => v_exchange_rate,
                                                                            p_standard_currency       => v_standard_currency);
      
        v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
        v_exp_report_accounts.exchange_rate      := v_exchange_rate;
        v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
      
        --借方往来 应收
        insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                   p_exp_report_header_id     => p_exp_rep_header_id,
                                   p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                   p_description              => v_desc,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                   p_company_id               => v_header_company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_exp_report_accounts.account_id,
                                   p_currency_code            => v_exp_report_accounts.currency_code,
                                   p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                   p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                   p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                   p_entered_amount_dr        => v_exp_report_accounts.entered_amount_dr,
                                   p_functional_amount_dr     => v_exp_report_accounts.entered_amount_dr,
                                   p_entered_amount_cr        => '',
                                   p_functional_amount_cr     => '',
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'INTERCOMPANY_AR');
      
        v_exp_account_desc := v_exp_report_dists.description;
      
        acc_builder_emp_company_ap_pkg.set_process_id(v_exp_report_dists.company_id,
                                                      p_user_id);
        acc_builder_emp_company_ap_pkg.create_mapping_conditions(p_company_id => v_exp_report_dists.company_id,
                                                                 -- v_header_company_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => v_exp_report_dists.currency_code,
                                                                 p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id);
      
        v_exp_report_accounts.account_id := acc_builder_emp_company_ap_pkg.get_account;
        IF v_exp_report_accounts.account_id = -1 THEN
          CLOSE cur_line;
          RETURN 'EXP5140_GET_INTERCOMPANY_AP_ACC_ERROR';
        END IF;
      
        v_exp_report_accounts.company_id               := v_exp_report_dists.company_id;
        v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_accounts.company_id);
        IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
          CLOSE cur_line;
          RETURN 'EXP5140_RESP_CENTER_ERROR';
        END IF;
      
        --v_exp_report_accounts.entered_amount_cr := v_exp_report_dists.sale_amount;
      
        IF v_exp_report_dists.special_invoice = 'Y' THEN
          v_exp_report_accounts.entered_amount_cr := v_exp_report_dists.sale_amount;
        ELSE
          v_exp_report_accounts.entered_amount_cr := v_exp_report_dists.report_amount;
        END IF;
      
        v_exp_report_accounts.functional_amount_cr := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                            p_amount                  => v_exp_report_accounts.entered_amount_cr,
                                                                            p_batch_id                => p_batch_id,
                                                                            p_company_id              => v_exp_report_accounts.company_id,
                                                                            p_exchange_rate_type      => v_exchange_rate_type,
                                                                            p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                            p_exchange_rate           => v_exchange_rate,
                                                                            p_standard_currency       => v_standard_currency);
      
        v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
        v_exp_report_accounts.exchange_rate      := v_exchange_rate;
        v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
      
        v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
      
        insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                   p_exp_report_header_id     => p_exp_rep_header_id,
                                   p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                   p_description              => v_desc,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                   p_company_id               => v_exp_report_dists.company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_exp_report_accounts.account_id,
                                   p_currency_code            => v_exp_report_accounts.currency_code,
                                   p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                   p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                   p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                   p_entered_amount_dr        => '',
                                   p_functional_amount_dr     => '',
                                   p_entered_amount_cr        => v_exp_report_accounts.entered_amount_cr,
                                   p_functional_amount_cr     => v_exp_report_accounts.entered_amount_cr,
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'INTERCOMPANY_AP');
      
      END IF;
    END LOOP;
    CLOSE cur_line;
  
    /*报销单报销费用的发票类型若为“视同专票”，校验报销单下“发票号码+代码”的所有报销行合计的发票税额和报销税额是否相等，
    若不相等生成进项转出凭证  借：EMPLOYEE_EXPENSE_10 搭配的科目   贷：2221153099 应付税费-应交增值税-进项转出-其他   
    金额为（差额）发票税额-报销税额*/
    /*    FOR c_invoice IN (SELECT l.invoice_number, l.invoice_code
                        FROM exp_report_lines l
                       WHERE l.exp_report_header_id = p_exp_rep_header_id
                         AND l.invoice_number IS NOT NULL
                         AND l.invoice_code IS NOT NULL
                       GROUP BY l.invoice_number, l.invoice_code) LOOP
      SELECT nvl(SUM(l.tax_amount), 0),
             nvl(SUM(l.invoice_tax_amount_bak), 0)
        INTO v_sum_tax_amount, v_invoice_tax_amount
        FROM exp_report_lines l
       WHERE l.exp_report_header_id = p_exp_rep_header_id
         AND l.invoice_number = c_invoice.invoice_number
         AND l.invoice_code = c_invoice.invoice_code;
    
      SELECT e.special_invoice
        INTO v_special_invoice
        FROM exp_ygz_invoice_types e
       WHERE e.type_code =
             (SELECT l.invoice_type
                FROM exp_report_lines l
               WHERE l.exp_report_line_id =
                     v_exp_report_dists.exp_report_line_id);
    
      IF v_special_invoice = 'Y' THEN
        IF v_sum_tax_amount < v_invoice_tax_amount THEN
          
           SELECT erd.*
           into v_dist
           FROM exp_report_lines l,exp_report_dists erd
           where l.exp_report_header_id =  p_exp_rep_header_id
           and l.exp_report_line_id = erd.exp_report_line_id
           and l.invoice_code =  c_invoice.invoice_code
           and l.invoice_number = c_invoice.invoice_number
           and rownum = 1;
           --转出金额
           v_invoice_ce := v_invoice_tax_amount - v_sum_tax_amount;
        
        END IF;
      END IF;
    
    END LOOP;*/
  
    SELECT COUNT(1)
      INTO v_pmt_length
      FROM exp_report_pmt_schedules ps, exp_report_headers h
     WHERE ps.exp_report_header_id = h.exp_report_header_id
       AND h.exp_report_header_id = p_exp_rep_header_id;
  
    --从计划付款行中创建贷方凭证，科目EMPLOYEE_EXPENSE_CLEARING
    FOR c_pmt_schedules IN (SELECT ps.*, h.currency_code
                              FROM exp_report_pmt_schedules ps,
                                   exp_report_headers       h
                             WHERE ps.exp_report_header_id =
                                   h.exp_report_header_id
                               AND h.exp_report_header_id =
                                   p_exp_rep_header_id) LOOP
    
      v_pmt_count := v_pmt_count + 1;
    
      --删除当前计划付款行生成的贷方凭证
      DELETE FROM exp_report_accounts a
       WHERE a.payment_schedule_line_id =
             c_pmt_schedules.payment_schedule_line_id;
      --摘要取报销单号 update by lyh 2017.8.5
      --v_exp_account_desc := c_pmt_schedules.description;
      v_exp_account_desc := v_exp_report_number;
      v_partner_type_id  := get_partner_type_id(p_partner_category => c_pmt_schedules.payee_category,
                                                p_company_id       => c_pmt_schedules.company_id,
                                                p_partner_id       => c_pmt_schedules.payee_id);
    
      acc_builder_exp_clearing_pkg.set_process_id(v_header_company_id,
                                                  p_user_id);
      --获取付款用途id
      SELECT cpu.usedes_id
        INTO v_usedes_id
        FROM csh_payment_usedes cpu
       WHERE cpu.usedes_code = c_pmt_schedules.usedes;
    
      acc_builder_exp_clearing_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                             p_expense_user_group_id  => v_expense_user_group_id,
                                                             p_expense_report_type_id => v_expense_report_type_id,
                                                             p_currency_code          => v_exp_report_accounts.currency_code,
                                                             p_employee_type_id       => v_employee_type_id,
                                                             p_partner_category       => c_pmt_schedules.payee_category,
                                                             p_partner_type_id        => v_partner_type_id,
                                                             p_partner_id             => c_pmt_schedules.payee_id,
                                                             p_usedes_id              => v_usedes_id);
    
      v_exp_report_accounts.account_id := acc_builder_exp_clearing_pkg.get_account;
      IF v_exp_report_accounts.account_id = -1 THEN
        RETURN 'EXP5140_GET_EXP_CLE_ACC_ERROR';
      END IF;
    
      --v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
      v_exp_report_accounts.responsibility_center_id := g_responsibility_center_id;
      IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
        RETURN 'EXP5140_RESP_CENTER_ERROR';
      END IF;
    
      v_exp_report_accounts.entered_amount_cr := c_pmt_schedules.due_amount;
    
      --Date:2014年7月28日17:05:39
      --Author:ZhouHao
      --Purpose:原报销单贷方金额会根据报销单借方金额调整最后一行贷方的本币金额，避免出现尾差，该逻辑在报销单支付的时候会出现付款凭证与应付凭证金额存在差异的情况，
      --目前修改为报销单的借方的本币金额根据贷方的本币金额调整尾差，避免出现支付存在金额匹配不上的问题
      --------G
      v_exp_report_accounts.functional_amount_cr := get_functional_amount(p_currency_code           => c_pmt_schedules.currency_code,
                                                                          p_amount                  => v_exp_report_accounts.entered_amount_cr,
                                                                          p_batch_id                => p_batch_id,
                                                                          p_company_id              => v_header_company_id,
                                                                          p_exchange_rate_type      => v_exchange_rate_type,
                                                                          p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                          p_exchange_rate           => v_exchange_rate,
                                                                          p_standard_currency       => v_standard_currency);
    
      v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
      v_exp_report_accounts.exchange_rate      := v_exchange_rate;
      v_exp_report_accounts.currency_code      := c_pmt_schedules.currency_code;
    
      v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
      insert_exp_report_accounts_c(p_payment_schedule_line_id => c_pmt_schedules.payment_schedule_line_id,
                                   p_exp_report_header_id     => p_exp_rep_header_id,
                                   p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                   p_description              => v_desc, --modify by wxq 20180418 修改费用凭证借方摘要,,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                   p_company_id               => v_header_company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_exp_report_accounts.account_id,
                                   p_currency_code            => v_exp_report_accounts.currency_code,
                                   p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                   p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                   p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                   p_entered_amount_dr        => '',
                                   p_functional_amount_dr     => '',
                                   p_entered_amount_cr        => v_exp_report_accounts.entered_amount_cr,
                                   p_functional_amount_cr     => v_exp_report_accounts.entered_amount_cr,
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'EMPLOYEE_EXPENSE_CLEARING');
    
    END LOOP;
  
    /*    for c_invoice in (SELECT l.invoice_number, l.invoice_code
                        FROM exp_report_lines l
                       WHERE l.exp_report_header_id = p_exp_rep_header_id
                         and l.invoice_number is not null
                         and l.invoice_code is not null
                       group by l.invoice_number, l.invoice_code) loop
      SELECT nvl(SUM(l.tax_amount), 0),
             nvl(SUM(l.invoice_tax_amount_bak), 0)
        INTO v_sum_tax_amount, v_invoice_tax_amount
        FROM exp_report_lines l
       WHERE l.exp_report_header_id = p_exp_rep_header_id
         and l.invoice_number = c_invoice.invoice_number
         and l.invoice_code = c_invoice.invoice_code;
    
      SELECT e.special_invoice
        INTO v_special_invoice
        FROM exp_ygz_invoice_types e
       WHERE e.type_code =
             (SELECT l.invoice_type
                FROM exp_report_lines l
               WHERE l.exp_report_line_id =
                     v_exp_report_dists.exp_report_line_id);
    
      IF v_special_invoice = 'Y' THEN
        IF v_sum_tax_amount <> v_invoice_tax_amount THEN
          ---借方--------
          acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                                 p_expense_user_group_id  => v_expense_user_group_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => v_exp_report_dists.currency_code,
                                                                 p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                 p_period_comparison      => v_period_comparison,
                                                                 p_employee_type_id       => v_employee_type_id,
                                                                 p_org_unit               => v_exp_report_dists.unit_id,
                                                                 --add by Qu yuanyuan
                                                                 p_du_id => v_exp_report_dists.dimension6_id);
        
          v_exp_report_accounts.account_id := acc_builder_employee_exp_pkg.get_account;
          IF v_exp_report_accounts.account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          --取默认责任中心
          v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_dists.company_id);
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        
          v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
          v_exp_report_accounts.exchange_rate      := v_exchange_rate;
          v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
        
          insert_exp_report_accounts(p_exp_report_dists_id      => '',
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_invoice_tax_amount -
                                                                   v_sum_tax_amount,
                                     p_functional_amount_dr     => v_invoice_tax_amount -
                                                                   v_sum_tax_amount,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE');
        
          SELECT g.account_id
            INTO v_tax_account_id
            FROM gld_accounts g
           WHERE g.account_code = '2221153099'; --应付税费-应交增值税-进项转出-其他
        
          --贷
          v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_tax_account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => '',
                                     p_functional_amount_dr     => '',
                                     p_entered_amount_cr        => v_invoice_tax_amount -
                                                                   v_sum_tax_amount,
                                     p_functional_amount_cr     => v_invoice_tax_amount -
                                                                   v_sum_tax_amount,
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_ROLL_OUT');
        END IF;
      END IF;
    end loop;*/
    --Date:2014年7月28日17:27:04
    --Author:Zhouhao
    --Purpose:报销单凭证生成后，根据报销单借方[EXPLOYEE_EXPENSE]金额总和和报销单贷方[EMPLOYEE_EXPENSE_CLEARING]金额总和的差调整报销单借方金额最大的那行的
    --本币金额
    SELECT (nvl((SELECT SUM(a1.functional_amount_dr)
                  FROM exp_report_accounts a1
                 WHERE a1.exp_report_header_id = p_exp_rep_header_id
                   AND a1.usage_code = 'EMPLOYEE_EXPENSE'),
                0) +
           --Date:2014年10月11日15:27:17
           --Author:ZhouHao
           --Purpose:税金部分可能为空，导致计算差额的时候会导致adjust_amount为null，后面update的时候更新报销单凭证上的本币金额为null
           nvl((SELECT SUM(a1.functional_amount_dr)
                  FROM exp_report_accounts a1
                 WHERE a1.exp_report_header_id = p_exp_rep_header_id
                   AND a1.usage_code = 'EMPLOYEE_EXPENSE_TAX'),
                0)) -
           nvl((SELECT SUM(a1.functional_amount_cr)
                 FROM exp_report_accounts a1
                WHERE a1.exp_report_header_id = p_exp_rep_header_id
                  AND a1.usage_code = 'EMPLOYEE_EXPENSE_CLEARING'),
               0)
      INTO v_adjust_amount
      FROM dual;
  
    SELECT d1.exp_report_dists_id
      INTO v_adjust_exp_dists_id
      FROM exp_report_dists d1, exp_report_lines l1
     WHERE l1.exp_report_header_id = p_exp_rep_header_id
       AND l1.exp_report_line_id = d1.exp_report_line_id
       AND d1.report_functional_amount =
           (SELECT MAX(d2.report_functional_amount)
              FROM exp_report_lines l2, exp_report_dists d2
             WHERE d2.exp_report_line_id = l2.exp_report_line_id
               AND l2.exp_report_header_id = p_exp_rep_header_id)
       AND rownum = 1;
  
    --modify by pqs 20181017
    /*UPDATE exp_report_accounts a
      SET a.functional_amount_dr = a.functional_amount_dr - v_adjust_amount,
          a.functional_amount_cr = a.functional_amount_cr - v_adjust_amount
    WHERE a.exp_report_dists_id = v_adjust_exp_dists_id
      AND a.usage_code = 'EMPLOYEE_EXPENSE';*/
  
    /*************************************************
    -- Author  : MOUSE
    -- Created : 2015年11月25日10:00:16
    -- Ver     : 1.1
    -- Purpose : 报销单类型如果为托收，那么报销单贷方科目取托收科目对应的银行科目
    **************************************************/
    SELECT t.document_page_type
      INTO v_page_type
      FROM exp_report_headers h, exp_expense_report_types t
     WHERE h.exp_report_header_id = p_exp_rep_header_id
       AND h.exp_report_type_id = t.expense_report_type_id;
  
    IF v_page_type = 'COLLECTION' THEN
    
      FOR pmt_lns IN (SELECT s.payment_schedule_line_id,
                             ga.account_id,
                             ga.account_code
                        FROM exp_report_pmt_schedules s,
                             csh_bank_accounts        a,
                             gld_accounts             ga
                       WHERE s.exp_report_header_id = p_exp_rep_header_id
                         AND s.collection_account_id = a.bank_account_id
                         AND a.cash_account_id = ga.account_id) LOOP
      
        FOR account IN (SELECT *
                          FROM exp_report_accounts a
                         WHERE a.payment_schedule_line_id =
                               pmt_lns.payment_schedule_line_id) LOOP
          UPDATE exp_report_accounts a
             SET a.account_id       = pmt_lns.account_id,
                 a.account_segment3 = pmt_lns.account_code
           WHERE a.exp_report_je_line_id = account.exp_report_je_line_id;
        
          UPDATE gl_account_entry e
             SET e.account_id   = pmt_lns.account_id,
                 e.account_code = pmt_lns.account_code,
                 e.segment3     = pmt_lns.account_code
           WHERE e.transaction_type = 'EXP_REPORT'
             AND e.transaction_je_line_id = account.exp_report_je_line_id;
        
          gl_log_pkg.log(p_log_text => '托收报销单贷方凭证，从计付行托收账户带出，凭证行ID为：' ||
                                       account.exp_report_je_line_id ||
                                       '，科目ID为：' || pmt_lns.account_id ||
                                       '，科目代码为:' || pmt_lns.account_code,
                         p_user_id  => p_user_id);
        END LOOP;
      END LOOP;
    END IF;
  
    /*************************************************/
  
    RETURN NULL;
  END create_er_accounts_grcx;

  --=====================================================
  --万联证券报销单创建凭证
  --=====================================================
  FUNCTION create_er_accounts_wlzq(p_exp_rep_header_id NUMBER,
                                   p_journal_date      DATE,
                                   p_user_id           NUMBER,
                                   p_batch_id          NUMBER,
                                   p_period_name       VARCHAR2)
    RETURN VARCHAR2 IS
    CURSOR cur_line(p_rep_header_id NUMBER) IS
      SELECT d.*,
             l.line_number,
             l.tax_type_id,
             l.invoice_type AS line_invoice_type, --modified by HM @2016-04-13 增加发票类型
             ey.special_invoice,
             l.place_to_id,
             l.meetting_name,
             l.special_sales
        FROM exp_report_dists      d,
             exp_report_lines      l,
             exp_ygz_invoice_types ey
       WHERE d.exp_report_line_id = l.exp_report_line_id
         AND l.exp_report_header_id = p_exp_rep_header_id
         AND l.invoice_type = ey.type_code;
  
    v_exp_report_dists    cur_line%ROWTYPE;
    v_exp_report_accounts exp_report_accounts%ROWTYPE;
  
    v_header_company_id      exp_report_headers.company_id %TYPE;
    v_employee_id            exp_report_headers.employee_id %TYPE;
    v_exp_report_number      exp_report_headers.exp_report_number %TYPE;
    v_employee_type_id       exp_employees.employee_type_id%TYPE;
    v_expense_user_group_id  exp_report_headers.expense_user_group_id %TYPE;
    v_expense_report_type_id exp_report_headers.exp_report_type_id %TYPE;
    v_rep_header_desc        exp_report_headers.description %TYPE;
    v_exp_account_desc       exp_report_accounts.description%TYPE;
  
    v_exchange_rate      exp_currency_code_tmp.exchange_rate%TYPE;
    v_exchange_rate_type exp_currency_code_tmp.exchange_rate_type%TYPE;
  
    v_period_comparison    VARCHAR2(30);
    v_dists_period_num     NUMBER;
    v_operation_period_num NUMBER;
    v_standard_currency    VARCHAR2(30); --本位币
    v_partner_type_id      NUMBER;
    v_adjust_exp_dists_id  NUMBER;
    v_adjust_amount        NUMBER;
    v_usedes_id            NUMBER; --付款用途代码id
    v_tax_type_rate        NUMBER; --税率
    v_tax_category         VARCHAR2(30); --税率类别
    v_tax_amount           NUMBER; --税金金额
    v_tax_function_amount  NUMBER; --税金本位币金额
    v_currency_precision   NUMBER;
    v_pmt_count            NUMBER := 0; --计划付款行行数，用于创建贷方凭证的时候做尾差处理
    v_pmt_length           NUMBER;
  
    v_exp_header        exp_report_headers%ROWTYPE;
    v_functional_amount NUMBER;
  
    v_page_type VARCHAR2(30);
  
    e_acc_error EXCEPTION;
    --modified by HM @2016-04-07营改增改动
    v_tax_exp_report_je_line_id NUMBER;
    v_tax_account_id            NUMBER;
    v_entered_amount_dr_tax     NUMBER := 0;
    v_functional_amount_dr_tax  NUMBER := 0;
  
    v_flag       VARCHAR2(1);
    v_company_id NUMBER;
  
    v_usage_type        VARCHAR2(10); --建信人寿 抵扣规则
    v_t3_value          VARCHAR2(10); --T3映射值
    v_line_desc_flag    VARCHAR2(1); --报销类型是否使用行说明 --modify by wxq
    v_employee_name     VARCHAR2(50);
    v_expense_item_name VARCHAR2(50);
    v_place_desc        VARCHAR2(50);
    v_desc              VARCHAR2(200);
    v_desc1             VARCHAR2(200);
    v_line_desc_flag1   VARCHAR2(1);
    v_line_desc         VARCHAR2(200);
    v_company_level     VARCHAR2(50);
    v_company_level2    VARCHAR2(50);
  BEGIN
    SELECT nvl(v.pay_company_id, v.company_id), --修改为头上支付公司15798
           v.employee_id,
           v.expense_user_group_id,
           v.exp_report_type_id,
           v.description,
           v.exp_report_number
      INTO v_header_company_id,
           v_employee_id,
           v_expense_user_group_id,
           v_expense_report_type_id,
           v_rep_header_desc,
           v_exp_report_number
      FROM exp_report_headers v
     WHERE v.exp_report_header_id = p_exp_rep_header_id;
  
    v_exp_report_accounts.period_name := p_period_name;
    v_employee_type_id                := get_employee_type_id(v_employee_id);
  
    OPEN cur_line(p_exp_rep_header_id);
    LOOP
      FETCH cur_line
        INTO v_exp_report_dists;
      EXIT WHEN cur_line%NOTFOUND;
    
      DELETE FROM exp_report_accounts t
       WHERE t.exp_report_dists_id = v_exp_report_dists.exp_report_dists_id;
    
      g_line_number              := v_exp_report_dists.line_number;
      g_exp_report_dists_id      := v_exp_report_dists.exp_report_dists_id;
      g_responsibility_center_id := v_exp_report_dists.responsibility_center_id;
    
      SELECT gc.precision
        INTO v_currency_precision
        FROM gld_currency gc
       WHERE gc.currency_code = v_exp_report_dists.currency_code;
    
      IF v_exp_report_dists.tax_type_id IS NOT NULL THEN
        BEGIN
          SELECT c.tax_type_rate, c.tax_category
            INTO v_tax_type_rate, v_tax_category
            FROM fnd_tax_type_codes c
           WHERE c.tax_type_id = v_exp_report_dists.tax_type_id;
        EXCEPTION
          WHEN no_data_found THEN
            CLOSE cur_line;
            RETURN 'EXP5140_EXP_ACCOUNTS_TAX_ERROR';
        END;
      END IF;
    
      --modify by wxq 
      /*
       i.  如果未勾选需要加行说明，则凭证行取值规则为：报销人+‘报’+目的地+费用项目+会议（培训）名称。
      ii.  如果勾选了需要加行说明，则凭证行取值规则为：报销人+‘报’+目的地+费用项目+会议（培训）名称+行说明
      */
      SELECT t.line_desc_flag
        INTO v_line_desc_flag
        FROM exp_expense_types t
       WHERE t.expense_type_id = v_exp_report_dists.expense_type_id;
    
      SELECT e.name
        INTO v_employee_name
        FROM exp_employees e
       WHERE e.employee_id = v_employee_id;
    
      SELECT ei.description
        INTO v_expense_item_name
        FROM exp_expense_items_vl ei
       WHERE ei.expense_item_id = v_exp_report_dists.expense_item_id;
      BEGIN
        SELECT p.place_desc
          INTO v_place_desc
          FROM exp_policy_places_vl p
         WHERE p.place_id = v_exp_report_dists.place_to_id;
      EXCEPTION
        WHEN no_data_found THEN
          v_place_desc := '';
      END;
      v_desc := v_employee_name || '报' || v_place_desc ||
                v_expense_item_name /*|| v_exp_report_dists.meetting_name*/
       ;
      IF v_line_desc_flag = 'Y' THEN
        v_desc := v_desc || v_exp_report_dists.description;
      
      END IF;
    
      SELECT v_employee_name || '报' ||
             (SELECT p.place_desc
                FROM exp_policy_places_vl p
               WHERE p.place_id = l.place_to_id) ||
             (SELECT ei.description
                FROM exp_expense_items_vl ei
               WHERE ei.expense_item_id = l.expense_item_id) /* ||
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       l.meetting_name*/,
             (SELECT t.line_desc_flag
                FROM exp_expense_types t
               WHERE t.expense_type_id = l.expense_type_id),
             l.description
        INTO v_desc1, v_line_desc_flag1, v_line_desc
        FROM exp_report_lines l
       WHERE l.exp_report_header_id = p_exp_rep_header_id
         AND rownum = 1;
    
      IF v_line_desc_flag1 = 'Y' THEN
        v_desc1 := v_desc1 || v_line_desc;
      
      END IF;
    
      IF v_exp_report_dists.company_id = v_header_company_id THEN
        --分配行公司 = 报销单头公司
        v_standard_currency := gld_common_pkg.get_company_currency_code(v_header_company_id);
        ----------------借方 -------------
        -- 摘要 取报销单头说明
        --v_exp_account_desc := v_rep_header_desc;
      
        v_exp_account_desc := v_exp_report_dists.description;
      
        --业务期间
        v_dists_period_num := gld_common_pkg.get_gld_internal_period_num(v_header_company_id,
                                                                         v_exp_report_dists.period_name);
        --审核期间
        v_operation_period_num := gld_common_pkg.get_gld_internal_period_num(v_header_company_id,
                                                                             p_period_name);
        IF v_dists_period_num > v_operation_period_num THEN
          v_period_comparison := 'EARLIER';
        ELSIF v_dists_period_num = v_operation_period_num THEN
          v_period_comparison := 'IN';
        ELSE
          v_period_comparison := 'LATER';
        END IF;
      
        ---借方--------
        acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                    p_user_id    => p_user_id);
        acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                               p_expense_user_group_id  => v_expense_user_group_id,
                                                               p_expense_report_type_id => v_expense_report_type_id,
                                                               p_currency_code          => v_exp_report_dists.currency_code,
                                                               p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                               p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                               p_period_comparison      => v_period_comparison,
                                                               p_employee_type_id       => v_employee_type_id,
                                                               p_org_unit               => v_exp_report_dists.unit_id,
                                                               --add by Qu yuanyuan
                                                               p_du_id => v_exp_report_dists.dimension6_id);
      
        v_exp_report_accounts.account_id := acc_builder_employee_exp_pkg.get_account;
        IF v_exp_report_accounts.account_id = -1 THEN
          CLOSE cur_line;
          RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
        END IF;
      
        --取默认责任中心
        -- v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
        v_exp_report_accounts.responsibility_center_id := v_exp_report_dists.responsibility_center_id;
        IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
          CLOSE cur_line;
          RETURN 'EXP5140_RESP_CENTER_ERROR';
        END IF;
      
        v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
      
        --v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount;
      
        /*        IF v_exp_report_dists.line_invoice_type IS NULL THEN
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount;
        ELSIF v_exp_report_dists.line_invoice_type != '20' AND
              v_exp_report_dists.line_invoice_type != '70' THEN
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.sale_amount;
        
        ELSE
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount -
                                                     nvl(v_exp_report_dists.tax_amount,
                                                         0);
        END IF;*/
      
        IF v_exp_report_dists.special_invoice = 'Y' THEN
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount -
                                                     nvl(v_exp_report_dists.tax_amount,
                                                         0);
        ELSE
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount;
        END IF;
      
        v_exp_report_accounts.functional_amount_dr := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                            p_amount                  => v_exp_report_accounts.entered_amount_dr,
                                                                            p_batch_id                => p_batch_id,
                                                                            p_company_id              => v_header_company_id,
                                                                            p_exchange_rate_type      => v_exchange_rate_type,
                                                                            p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                            p_exchange_rate           => v_exchange_rate,
                                                                            p_standard_currency       => v_standard_currency);
      
        v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
        v_exp_report_accounts.exchange_rate      := v_exchange_rate;
        v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
      
        insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                   p_exp_report_header_id     => p_exp_rep_header_id,
                                   p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                   p_description              => v_desc, --modify by wxq 20180418 修改费用凭证借方摘要,,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                   p_company_id               => v_header_company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_exp_report_accounts.account_id,
                                   p_currency_code            => v_exp_report_accounts.currency_code,
                                   p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                   p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                   p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                   p_entered_amount_dr        => v_exp_report_accounts.entered_amount_dr,
                                   p_functional_amount_dr     => v_exp_report_accounts.functional_amount_dr,
                                   p_entered_amount_cr        => '',
                                   p_functional_amount_cr     => '',
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'EMPLOYEE_EXPENSE');
      
        -----------------------------------------------------------------------------------------------------------
        -- 增值税修改  update  by robin 2016-04-14
      
        v_entered_amount_dr_tax    := nvl(v_exp_report_dists.tax_amount, 0);
        v_functional_amount_dr_tax := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                            p_amount                  => v_entered_amount_dr_tax,
                                                            p_batch_id                => p_batch_id,
                                                            p_company_id              => v_header_company_id,
                                                            p_exchange_rate_type      => v_exchange_rate_type,
                                                            p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                            p_exchange_rate           => v_exchange_rate,
                                                            p_standard_currency       => v_standard_currency);
      
        --启用条件：行发票类型是专票
        --update by lyh 
        --根据发票类型表的视同专票标识判断是专票还是普票
      
        IF v_exp_report_dists.special_invoice = 'Y' THEN
          /* --取进项税科目
          acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
          --根据营改增使用的用途代码，失效相应的参数，这里只保留单据类型ID
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => NULL, --v_employee_id,
                                                                 p_expense_user_group_id  => NULL, --v_expense_user_group_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => NULL, --v_exp_report_dists.currency_code, 
                                                                 p_expense_item_id        => NULL, --v_exp_report_dists.expense_item_id,   跳过选择费用科目
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                 p_period_comparison      => NULL, --v_period_comparison,
                                                                 p_employee_type_id       => NULL, --v_employee_type_id,
                                                                 p_org_unit               => NULL, --v_exp_report_dists.unit_id
                                                                 --add by Qu yuanyuan
                                                                 p_du_id => NULL --v_exp_report_dists.dimension6_id
                                                                 );
          
          v_tax_account_id := acc_builder_employee_exp_pkg.get_account;*/
        
          --取自报销单进项分类对应进项税转出核算科目 modify by wxq 20180411
        
          v_tax_account_id := get_account_by_vat_in(v_exp_report_dists.input_tax_structure_detail);
        
          IF v_tax_account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          --modify by wxq  抵扣规则为“不动产抵扣” 20180413
          IF v_exp_report_dists.used_type = 'YT005' THEN
            --借：进项税（行税额*60%） 科目取自进项分类对应科目
            v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
            insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                       p_exp_report_header_id     => p_exp_rep_header_id,
                                       p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                       p_description              => v_desc,
                                       p_journal_date             => p_journal_date,
                                       p_period_name              => v_exp_report_accounts.period_name,
                                       p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                       p_company_id               => v_header_company_id,
                                       p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                       p_account_id               => v_tax_account_id,
                                       p_currency_code            => v_exp_report_accounts.currency_code,
                                       p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                       p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                       p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                       p_entered_amount_dr        => v_entered_amount_dr_tax * 0.6,
                                       p_functional_amount_dr     => v_functional_amount_dr_tax * 0.6,
                                       p_entered_amount_cr        => '',
                                       p_functional_amount_cr     => '',
                                       p_user_id                  => p_user_id,
                                       p_gld_interface_flag       => 'N',
                                       p_usage_code               => 'EMPLOYEE_EXPENSE');
          
            --借：待结转进项税（行税额*40%）  科目取待抵扣科目 20243214
            BEGIN
              v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
              insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                         p_exp_report_header_id     => p_exp_rep_header_id,
                                         p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                         p_description              => v_desc,
                                         p_journal_date             => p_journal_date,
                                         p_period_name              => v_exp_report_accounts.period_name,
                                         p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                         p_company_id               => v_header_company_id,
                                         p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                         p_account_id               => v_tax_account_id,
                                         p_currency_code            => v_exp_report_accounts.currency_code,
                                         p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                         p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                         p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                         p_entered_amount_dr        => v_entered_amount_dr_tax * 0.4,
                                         p_functional_amount_dr     => v_functional_amount_dr_tax * 0.4,
                                         p_entered_amount_cr        => '',
                                         p_functional_amount_cr     => '',
                                         p_user_id                  => p_user_id,
                                         p_gld_interface_flag       => 'N',
                                         p_usage_code               => 'EMPLOYEE_EXPENSE');
            
              SELECT g.account_id
                INTO v_tax_account_id
                FROM gld_accounts g
               WHERE g.account_code = '20243214';
              UPDATE exp_report_accounts a
                 SET a.account_id       = v_tax_account_id,
                     a.account_segment3 = '20243214'
               WHERE a.exp_report_je_line_id = v_tax_exp_report_je_line_id;
            EXCEPTION
              WHEN no_data_found THEN
                v_tax_account_id := -1;
            END;
            IF v_tax_account_id = -1 THEN
              CLOSE cur_line;
              RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
            END IF;
          
            --updated by liyuhang 2018.4.12  组合抵扣拆分处理
          ELSIF (v_exp_report_dists.used_type = 'YT004') THEN
            --组合抵扣
            IF (v_exp_report_dists.adjusted_partial_deductions > 0) THEN
              SELECT et.t3_value
                INTO v_t3_value
                FROM exp_ygz_usage_types et
               WHERE et.type_code = 'YT002';
            
              v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
              insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                         p_exp_report_header_id     => p_exp_rep_header_id,
                                         p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                         p_description              => v_desc,
                                         p_journal_date             => p_journal_date,
                                         p_period_name              => v_exp_report_accounts.period_name,
                                         p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                         p_company_id               => v_header_company_id,
                                         p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                         p_account_id               => v_tax_account_id,
                                         p_currency_code            => v_exp_report_accounts.currency_code,
                                         p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                         p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                         p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                         p_entered_amount_dr        => v_exp_report_dists.adjusted_partial_deductions,
                                         p_functional_amount_dr     => v_exp_report_dists.adjusted_partial_deductions,
                                         p_entered_amount_cr        => '',
                                         p_functional_amount_cr     => '',
                                         p_user_id                  => p_user_id,
                                         p_gld_interface_flag       => 'N',
                                         p_usage_code               => 'EMPLOYEE_EXPENSE');
              UPDATE exp_report_accounts ea
                 SET ea.account_segment7 = v_t3_value
               WHERE ea.exp_report_je_line_id = v_tax_exp_report_je_line_id;
            END IF;
          
            IF (v_exp_report_dists.adjusted_full_deductions > 0) THEN
              SELECT et.t3_value
                INTO v_t3_value
                FROM exp_ygz_usage_types et
               WHERE et.type_code = 'YT001';
              v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
              insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                         p_exp_report_header_id     => p_exp_rep_header_id,
                                         p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                         p_description              => v_desc,
                                         p_journal_date             => p_journal_date,
                                         p_period_name              => v_exp_report_accounts.period_name,
                                         p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                         p_company_id               => v_header_company_id,
                                         p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                         p_account_id               => v_tax_account_id,
                                         p_currency_code            => v_exp_report_accounts.currency_code,
                                         p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                         p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                         p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                         p_entered_amount_dr        => v_exp_report_dists.adjusted_full_deductions,
                                         p_functional_amount_dr     => v_exp_report_dists.adjusted_full_deductions,
                                         p_entered_amount_cr        => '',
                                         p_functional_amount_cr     => '',
                                         p_user_id                  => p_user_id,
                                         p_gld_interface_flag       => 'N',
                                         p_usage_code               => 'EMPLOYEE_EXPENSE');
              UPDATE exp_report_accounts ea
                 SET ea.account_segment7 = v_t3_value
               WHERE ea.exp_report_je_line_id = v_tax_exp_report_je_line_id;
            END IF;
          
            IF (v_exp_report_dists.adjustable_tax_deductible > 0) THEN
              SELECT et.t3_value
                INTO v_t3_value
                FROM exp_ygz_usage_types et
               WHERE et.type_code = 'YT003';
              v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
              insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                         p_exp_report_header_id     => p_exp_rep_header_id,
                                         p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                         p_description              => v_desc,
                                         p_journal_date             => p_journal_date,
                                         p_period_name              => v_exp_report_accounts.period_name,
                                         p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                         p_company_id               => v_header_company_id,
                                         p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                         p_account_id               => v_tax_account_id,
                                         p_currency_code            => v_exp_report_accounts.currency_code,
                                         p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                         p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                         p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                         p_entered_amount_dr        => v_exp_report_dists.adjustable_tax_deductible,
                                         p_functional_amount_dr     => v_exp_report_dists.adjustable_tax_deductible,
                                         p_entered_amount_cr        => '',
                                         p_functional_amount_cr     => '',
                                         p_user_id                  => p_user_id,
                                         p_gld_interface_flag       => 'N',
                                         p_usage_code               => 'EMPLOYEE_EXPENSE');
              UPDATE exp_report_accounts ea
                 SET ea.account_segment7 = v_t3_value
               WHERE ea.exp_report_je_line_id = v_tax_exp_report_je_line_id;
            END IF;
          ELSE
            v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
            insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                       p_exp_report_header_id     => p_exp_rep_header_id,
                                       p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                       p_description              => v_desc,
                                       p_journal_date             => p_journal_date,
                                       p_period_name              => v_exp_report_accounts.period_name,
                                       p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                       p_company_id               => v_header_company_id,
                                       p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                       p_account_id               => v_tax_account_id,
                                       p_currency_code            => v_exp_report_accounts.currency_code,
                                       p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                       p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                       p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                       p_entered_amount_dr        => v_entered_amount_dr_tax, --税额
                                       p_functional_amount_dr     => v_functional_amount_dr_tax,
                                       p_entered_amount_cr        => '',
                                       p_functional_amount_cr     => '',
                                       p_user_id                  => p_user_id,
                                       p_gld_interface_flag       => 'N',
                                       p_usage_code               => 'EMPLOYEE_EXPENSE');
          END IF;
        END IF;
        ---------------------------------------------------------------------------------------------------------                            
      ELSE
        --分配行公司 <> 报销单头公司
        v_standard_currency := gld_common_pkg.get_company_currency_code(v_header_company_id);
      
        ----------------借方 1  -------------
        -- 摘要 取分配行说明
        v_exp_account_desc := v_exp_report_dists.description;
      
        --业务期间
        v_dists_period_num := gld_common_pkg.get_gld_internal_period_num(v_exp_report_dists.company_id,
                                                                         v_exp_report_dists.period_name);
        --审核期间
        v_operation_period_num := gld_common_pkg.get_gld_internal_period_num(v_exp_report_dists.company_id,
                                                                             p_period_name);
        IF v_dists_period_num > v_operation_period_num THEN
          v_period_comparison := 'EARLIER';
        ELSIF v_dists_period_num = v_operation_period_num THEN
          v_period_comparison := 'IN';
        ELSE
          v_period_comparison := 'LATER';
        END IF;
      
        ----借方------
        acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_exp_report_dists.company_id,
                                                    p_user_id    => p_user_id);
        acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                               p_expense_user_group_id  => v_expense_user_group_id,
                                                               p_expense_report_type_id => v_expense_report_type_id,
                                                               p_currency_code          => v_exp_report_dists.currency_code,
                                                               p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                               p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                               p_period_comparison      => v_period_comparison,
                                                               p_employee_type_id       => v_employee_type_id,
                                                               p_org_unit               => v_exp_report_dists.unit_id,
                                                               --add by Qu yuanyuan
                                                               p_du_id => v_exp_report_dists.dimension6_id);
      
        v_exp_report_accounts.account_id := acc_builder_employee_exp_pkg.get_account;
        IF v_exp_report_accounts.account_id = -1 THEN
          CLOSE cur_line;
          RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
        END IF;
      
        --取默认责任中心
        -- v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
        v_exp_report_accounts.responsibility_center_id := v_exp_report_dists.responsibility_center_id;
        IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
          CLOSE cur_line;
          RETURN 'EXP5140_RESP_CENTER_ERROR';
        END IF;
      
        v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
      
        --v_exp_report_accounts.entered_amount_dr    := v_exp_report_dists.report_amount;
      
        /*   IF v_exp_report_dists.line_invoice_type IS NULL THEN
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount;
        ELSIF v_exp_report_dists.line_invoice_type != '20' AND
              v_exp_report_dists.line_invoice_type != '70' THEN
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.sale_amount;
        
        ELSE
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount -
                                                     nvl(v_exp_report_dists.tax_amount,
                                                         0);
        END IF;*/
      
        IF v_exp_report_dists.special_invoice = 'Y' THEN
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount -
                                                     nvl(v_exp_report_dists.tax_amount,
                                                         0);
        ELSE
          v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount;
        END IF;
      
        v_exp_report_accounts.functional_amount_dr := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                            p_amount                  => v_exp_report_accounts.entered_amount_dr,
                                                                            p_batch_id                => p_batch_id,
                                                                            p_company_id              => v_exp_report_dists.company_id,
                                                                            p_exchange_rate_type      => v_exchange_rate_type,
                                                                            p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                            p_exchange_rate           => v_exchange_rate,
                                                                            p_standard_currency       => v_standard_currency);
      
        v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
        v_exp_report_accounts.exchange_rate      := v_exchange_rate;
        v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
        --借费用
        insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                   p_exp_report_header_id     => p_exp_rep_header_id,
                                   p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                   p_description              => v_desc, --modify by wxq 20180418 修改费用凭证借方摘要,,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                   p_company_id               => v_exp_report_dists.company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_exp_report_accounts.account_id,
                                   p_currency_code            => v_exp_report_accounts.currency_code,
                                   p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                   p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                   p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                   p_entered_amount_dr        => v_exp_report_accounts.entered_amount_dr,
                                   p_functional_amount_dr     => v_exp_report_accounts.functional_amount_dr,
                                   p_entered_amount_cr        => '',
                                   p_functional_amount_cr     => '',
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'EMPLOYEE_EXPENSE');
      
        -----------------------------------------------------------------------------------------------------------
        -- 增值税修改  update  by robin 2016-04-14
      
        v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
        v_entered_amount_dr_tax     := nvl(v_exp_report_dists.tax_amount, 0);
        v_functional_amount_dr_tax  := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                             p_amount                  => v_entered_amount_dr_tax,
                                                             p_batch_id                => p_batch_id,
                                                             p_company_id              => v_header_company_id,
                                                             p_exchange_rate_type      => v_exchange_rate_type,
                                                             p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                             p_exchange_rate           => v_exchange_rate,
                                                             p_standard_currency       => v_standard_currency);
      
        --启用条件：行发票类型是专票
        IF v_exp_report_dists.special_invoice = 'Y' THEN
          /* --取进项税科目
          acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
          --根据营改增使用的用途代码，失效相应的参数，这里只保留单据类型ID
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => NULL, --v_employee_id,
                                                                 p_expense_user_group_id  => NULL, --v_expense_user_group_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => NULL, --v_exp_report_dists.currency_code, 
                                                                 p_expense_item_id        => NULL, --v_exp_report_dists.expense_item_id,   跳过选择费用科目
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                 p_period_comparison      => NULL, --v_period_comparison,
                                                                 p_employee_type_id       => NULL, --v_employee_type_id,
                                                                 p_org_unit               => NULL, --v_exp_report_dists.unit_id
                                                                 --add by Qu yuanyuan
                                                                 p_du_id => NULL --v_exp_report_dists.dimension6_id
                                                                 );
          
          v_tax_account_id := acc_builder_employee_exp_pkg.get_account;*/
        
          --取自报销单进项分类对应进项税转出核算科目 modify by wxq 20180411
          v_tax_account_id := get_account_by_vat_in(v_exp_report_dists.input_tax_structure_detail);
        
          IF v_tax_account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          --专票借费用
          --modify by wxq  抵扣规则为“不动产抵扣” 20180413
          IF v_exp_report_dists.used_type = 'YT005' THEN
            --借：进项税（行税额*60%） 科目取自进项分类对应科目
            v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
            insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                       p_exp_report_header_id     => p_exp_rep_header_id,
                                       p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                       p_description              => v_desc,
                                       p_journal_date             => p_journal_date,
                                       p_period_name              => v_exp_report_accounts.period_name,
                                       p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                       p_company_id               => v_header_company_id,
                                       p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                       p_account_id               => v_tax_account_id,
                                       p_currency_code            => v_exp_report_accounts.currency_code,
                                       p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                       p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                       p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                       p_entered_amount_dr        => v_entered_amount_dr_tax * 0.6,
                                       p_functional_amount_dr     => v_functional_amount_dr_tax * 0.6,
                                       p_entered_amount_cr        => '',
                                       p_functional_amount_cr     => '',
                                       p_user_id                  => p_user_id,
                                       p_gld_interface_flag       => 'N',
                                       p_usage_code               => 'EMPLOYEE_EXPENSE');
          
            --借：待结转进项税（行税额*40%）  科目取待抵扣科目 20243214
            BEGIN
              SELECT g.account_id
                INTO v_tax_account_id
                FROM gld_accounts g
               WHERE g.account_code = '20243214';
            EXCEPTION
              WHEN no_data_found THEN
                v_tax_account_id := -1;
            END;
            IF v_tax_account_id = -1 THEN
              CLOSE cur_line;
              RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
            END IF;
            v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
            insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                       p_exp_report_header_id     => p_exp_rep_header_id,
                                       p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                       p_description              => v_desc,
                                       p_journal_date             => p_journal_date,
                                       p_period_name              => v_exp_report_accounts.period_name,
                                       p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                       p_company_id               => v_header_company_id,
                                       p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                       p_account_id               => v_tax_account_id,
                                       p_currency_code            => v_exp_report_accounts.currency_code,
                                       p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                       p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                       p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                       p_entered_amount_dr        => v_entered_amount_dr_tax * 0.4,
                                       p_functional_amount_dr     => v_functional_amount_dr_tax * 0.4,
                                       p_entered_amount_cr        => '',
                                       p_functional_amount_cr     => '',
                                       p_user_id                  => p_user_id,
                                       p_gld_interface_flag       => 'N',
                                       p_usage_code               => 'EMPLOYEE_EXPENSE');
          
            --updated by liyuhang 2018.4.12  组合抵扣拆分处理
          ELSIF (v_exp_report_dists.used_type = 'YT004') THEN
            --组合抵扣
            IF (v_exp_report_dists.adjusted_partial_deductions > 0) THEN
              SELECT et.t3_value
                INTO v_t3_value
                FROM exp_ygz_usage_types et
               WHERE et.type_code = 'YT002';
              insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                         p_exp_report_header_id     => p_exp_rep_header_id,
                                         p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                         p_description              => v_desc,
                                         p_journal_date             => p_journal_date,
                                         p_period_name              => v_exp_report_accounts.period_name,
                                         p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                         p_company_id               => v_exp_report_dists.company_id,
                                         p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                         p_account_id               => v_tax_account_id,
                                         p_currency_code            => v_exp_report_accounts.currency_code,
                                         p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                         p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                         p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                         p_entered_amount_dr        => v_exp_report_dists.adjusted_partial_deductions,
                                         p_functional_amount_dr     => v_exp_report_dists.adjusted_partial_deductions,
                                         p_entered_amount_cr        => '',
                                         p_functional_amount_cr     => '',
                                         p_user_id                  => p_user_id,
                                         p_gld_interface_flag       => 'N',
                                         p_usage_code               => 'EMPLOYEE_EXPENSE');
              UPDATE exp_report_accounts ea
                 SET ea.account_segment7 = v_t3_value
               WHERE ea.exp_report_je_line_id = v_tax_exp_report_je_line_id;
            END IF;
          
            IF (v_exp_report_dists.adjusted_full_deductions > 0) THEN
              SELECT et.t3_value
                INTO v_t3_value
                FROM exp_ygz_usage_types et
               WHERE et.type_code = 'YT001';
              insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                         p_exp_report_header_id     => p_exp_rep_header_id,
                                         p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                         p_description              => v_desc,
                                         p_journal_date             => p_journal_date,
                                         p_period_name              => v_exp_report_accounts.period_name,
                                         p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                         p_company_id               => v_exp_report_dists.company_id,
                                         p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                         p_account_id               => v_tax_account_id,
                                         p_currency_code            => v_exp_report_accounts.currency_code,
                                         p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                         p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                         p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                         p_entered_amount_dr        => v_exp_report_dists.adjusted_full_deductions,
                                         p_functional_amount_dr     => v_exp_report_dists.adjusted_full_deductions,
                                         p_entered_amount_cr        => '',
                                         p_functional_amount_cr     => '',
                                         p_user_id                  => p_user_id,
                                         p_gld_interface_flag       => 'N',
                                         p_usage_code               => 'EMPLOYEE_EXPENSE');
              UPDATE exp_report_accounts ea
                 SET ea.account_segment7 = v_t3_value
               WHERE ea.exp_report_je_line_id = v_tax_exp_report_je_line_id;
            END IF;
          
            IF (v_exp_report_dists.adjustable_tax_deductible > 0) THEN
              SELECT et.t3_value
                INTO v_t3_value
                FROM exp_ygz_usage_types et
               WHERE et.type_code = 'YT003';
              insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                         p_exp_report_header_id     => p_exp_rep_header_id,
                                         p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                         p_description              => v_desc,
                                         p_journal_date             => p_journal_date,
                                         p_period_name              => v_exp_report_accounts.period_name,
                                         p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                         p_company_id               => v_exp_report_dists.company_id,
                                         p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                         p_account_id               => v_tax_account_id,
                                         p_currency_code            => v_exp_report_accounts.currency_code,
                                         p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                         p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                         p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                         p_entered_amount_dr        => v_exp_report_dists.adjustable_tax_deductible,
                                         p_functional_amount_dr     => v_exp_report_dists.adjustable_tax_deductible,
                                         p_entered_amount_cr        => '',
                                         p_functional_amount_cr     => '',
                                         p_user_id                  => p_user_id,
                                         p_gld_interface_flag       => 'N',
                                         p_usage_code               => 'EMPLOYEE_EXPENSE');
              UPDATE exp_report_accounts ea
                 SET ea.account_segment7 = v_t3_value
               WHERE ea.exp_report_je_line_id = v_tax_exp_report_je_line_id;
            END IF;
          ELSE
            insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                       p_exp_report_header_id     => p_exp_rep_header_id,
                                       p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                       p_description              => v_desc,
                                       p_journal_date             => p_journal_date,
                                       p_period_name              => v_exp_report_accounts.period_name,
                                       p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                       p_company_id               => v_header_company_id,
                                       p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                       p_account_id               => v_tax_account_id,
                                       p_currency_code            => v_exp_report_accounts.currency_code,
                                       p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                       p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                       p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                       p_entered_amount_dr        => v_entered_amount_dr_tax, --税额
                                       p_functional_amount_dr     => v_functional_amount_dr_tax,
                                       p_entered_amount_cr        => '',
                                       p_functional_amount_cr     => '',
                                       p_user_id                  => p_user_id,
                                       p_gld_interface_flag       => 'N',
                                       p_usage_code               => 'EMPLOYEE_EXPENSE');
          END IF;
        END IF;
        --------------------------------------------end -------------------------------------------------------------                         
      
        ----------------借方 2 -------------
        -- 摘要 取报销单头说明
        --v_exp_account_desc := v_rep_header_desc;
        BEGIN
          --修改逻辑 当支付公司和行公司都为分公司时，产生总公司往来
          SELECT fl.company_level_code
            INTO v_company_level
            FROM fnd_company_levels fl
           WHERE fl.company_level_id =
                 (SELECT fc.company_level_id
                    FROM fnd_companies fc
                   WHERE fc.company_id = v_header_company_id);
          SELECT fl.company_level_code
            INTO v_company_level2
            FROM fnd_company_levels fl
           WHERE fl.company_level_id =
                 (SELECT fc.company_level_id
                    FROM fnd_companies fc
                   WHERE fc.company_id = v_exp_report_dists.company_id);
          IF v_company_level = '20' AND v_company_level2 = '20' THEN
            v_flag := 'N';
          END IF;
          /*SELECT 'Y'
           INTO v_flag
           FROM fnd_companies f
          WHERE f.company_id IN
                (v_header_company_id, v_exp_report_dists.company_id)
            AND f.company_code = '8600000000';*/
        EXCEPTION
          WHEN no_data_found THEN
            v_flag := 'N';
        END;
        v_exp_account_desc := v_exp_report_dists.description;
      
        acc_builder_emp_company_ar_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
        acc_builder_emp_company_ar_pkg.create_mapping_conditions(p_company_id             => v_exp_report_dists.company_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => v_exp_report_dists.currency_code,
                                                                 p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id);
      
        v_exp_report_accounts.account_id := acc_builder_emp_company_ar_pkg.get_account;
        IF v_exp_report_accounts.account_id = -1 THEN
          CLOSE cur_line;
          RETURN 'EXP5140_GET_INTERCOMPANY_AR_ACC_ERROR';
        END IF;
      
        --取默认责任中心
        v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
        IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
          CLOSE cur_line;
          RETURN 'EXP5140_RESP_CENTER_ERROR';
        END IF;
      
        v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        v_exp_report_accounts.entered_amount_dr     := v_exp_report_dists.report_amount -
                                                       nvl(v_exp_report_dists.tax_amount,
                                                           0);
        v_exp_report_accounts.functional_amount_dr  := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                             p_amount                  => v_exp_report_accounts.entered_amount_dr,
                                                                             p_batch_id                => p_batch_id,
                                                                             p_company_id              => v_exp_report_dists.company_id,
                                                                             p_exchange_rate_type      => v_exchange_rate_type,
                                                                             p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                             p_exchange_rate           => v_exchange_rate,
                                                                             p_standard_currency       => v_standard_currency);
      
        v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
        v_exp_report_accounts.exchange_rate      := v_exchange_rate;
        v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
        /*IF (v_flag = 'N') THEN*/
        --借方往来 应收
        --updated by liyuhang 2018.4.10
        --由原来头公司变为行公司
        /*insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_exp_report_dists.company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_exp_report_accounts.entered_amount_dr,
                                     p_functional_amount_dr     => v_exp_report_accounts.functional_amount_dr,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'INTERCOMPANY_AR');
        ELSE*/
        insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                   p_exp_report_header_id     => p_exp_rep_header_id,
                                   p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                   p_description              => v_desc,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                   p_company_id               => v_header_company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_exp_report_accounts.account_id,
                                   p_currency_code            => v_exp_report_accounts.currency_code,
                                   p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                   p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                   p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                   p_entered_amount_dr        => v_exp_report_accounts.entered_amount_dr,
                                   p_functional_amount_dr     => v_exp_report_accounts.functional_amount_dr,
                                   p_entered_amount_cr        => '',
                                   p_functional_amount_cr     => '',
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'INTERCOMPANY_AR');
        /* END IF;*/
      
        v_exp_account_desc := v_exp_report_dists.description;
      
        acc_builder_emp_company_ap_pkg.set_process_id(v_exp_report_dists.company_id,
                                                      p_user_id);
        acc_builder_emp_company_ap_pkg.create_mapping_conditions(p_company_id => v_exp_report_dists.company_id,
                                                                 -- v_header_company_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => v_exp_report_dists.currency_code,
                                                                 p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id);
      
        v_exp_report_accounts.account_id := acc_builder_emp_company_ap_pkg.get_account;
        IF v_exp_report_accounts.account_id = -1 THEN
          CLOSE cur_line;
          RETURN 'EXP5140_GET_INTERCOMPANY_AP_ACC_ERROR';
        END IF;
      
        v_exp_report_accounts.company_id               := v_exp_report_dists.company_id;
        v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_accounts.company_id);
        IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
          CLOSE cur_line;
          RETURN 'EXP5140_RESP_CENTER_ERROR';
        END IF;
      
        v_exp_report_accounts.entered_amount_cr := v_exp_report_dists.report_amount -
                                                   nvl(v_exp_report_dists.tax_amount,
                                                       0);
      
        v_exp_report_accounts.functional_amount_cr := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                            p_amount                  => v_exp_report_accounts.entered_amount_cr,
                                                                            p_batch_id                => p_batch_id,
                                                                            p_company_id              => v_exp_report_accounts.company_id,
                                                                            p_exchange_rate_type      => v_exchange_rate_type,
                                                                            p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                            p_exchange_rate           => v_exchange_rate,
                                                                            p_standard_currency       => v_standard_currency);
      
        v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
        v_exp_report_accounts.exchange_rate      := v_exchange_rate;
        v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
      
        v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
      
        /*IF (v_flag = 'N') THEN*/
        --贷往来
        --updated by liyuhang 2018.4.10
        --由原来行公司变为头公司
        /*insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_desc1,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => '',
                                     p_functional_amount_dr     => '',
                                     p_entered_amount_cr        => v_exp_report_accounts.entered_amount_cr,
                                     p_functional_amount_cr     => v_exp_report_accounts.functional_amount_cr,
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'INTERCOMPANY_AP');
        ELSE*/
        insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                   p_exp_report_header_id     => p_exp_rep_header_id,
                                   p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                   p_description              => v_desc1,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                   p_company_id               => v_exp_report_dists.company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_exp_report_accounts.account_id,
                                   p_currency_code            => v_exp_report_accounts.currency_code,
                                   p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                   p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                   p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                   p_entered_amount_dr        => '',
                                   p_functional_amount_dr     => '',
                                   p_entered_amount_cr        => v_exp_report_accounts.entered_amount_cr,
                                   p_functional_amount_cr     => v_exp_report_accounts.functional_amount_cr,
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'INTERCOMPANY_AP');
        /* END IF;*/
        ------------------------------------------added by liyuhang 2018.4.10-------------------------------------------------
        ------------------------------------------如果头公司或行公司b不包含总公司，新增两行凭证-------------------------------
        ------------------------------------开始------------------------------------------------------
        IF (v_flag = 'N') THEN
          SELECT f.company_id
            INTO v_company_id
            FROM fnd_companies f
           WHERE f.company_code = '8600000000';
          v_exp_account_desc := v_exp_report_dists.description;
        
          acc_builder_emp_company_ar_pkg.set_process_id(p_company_id => v_header_company_id,
                                                        p_user_id    => p_user_id);
          acc_builder_emp_company_ar_pkg.create_mapping_conditions(p_company_id             => v_exp_report_dists.company_id,
                                                                   p_expense_report_type_id => v_expense_report_type_id,
                                                                   p_currency_code          => v_exp_report_dists.currency_code,
                                                                   p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                   p_expense_type_id        => v_exp_report_dists.expense_type_id);
        
          v_exp_report_accounts.account_id := acc_builder_emp_company_ar_pkg.get_account;
          IF v_exp_report_accounts.account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_INTERCOMPANY_AR_ACC_ERROR';
          END IF;
        
          --取默认责任中心
          v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
          v_exp_report_accounts.entered_amount_dr     := v_exp_report_dists.report_amount;
          v_exp_report_accounts.functional_amount_dr  := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                               p_amount                  => v_exp_report_accounts.entered_amount_dr,
                                                                               p_batch_id                => p_batch_id,
                                                                               p_company_id              => v_exp_report_dists.company_id,
                                                                               p_exchange_rate_type      => v_exchange_rate_type,
                                                                               p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                               p_exchange_rate           => v_exchange_rate,
                                                                               p_standard_currency       => v_standard_currency);
        
          v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
          v_exp_report_accounts.exchange_rate      := v_exchange_rate;
          v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
          --借方往来 应收
          --updated by liyuhang 2018.4.10
        
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_exp_report_accounts.entered_amount_dr,
                                     p_functional_amount_dr     => v_exp_report_accounts.functional_amount_dr,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'INTERCOMPANY_AR');
        
          v_exp_account_desc := v_exp_report_dists.description;
        
          acc_builder_emp_company_ap_pkg.set_process_id(v_exp_report_dists.company_id,
                                                        p_user_id);
          acc_builder_emp_company_ap_pkg.create_mapping_conditions(p_company_id => v_exp_report_dists.company_id,
                                                                   --                                                                                v_header_company_id,
                                                                   p_expense_report_type_id => v_expense_report_type_id,
                                                                   p_currency_code          => v_exp_report_dists.currency_code,
                                                                   p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                   p_expense_type_id        => v_exp_report_dists.expense_type_id);
        
          v_exp_report_accounts.account_id := acc_builder_emp_company_ap_pkg.get_account;
          IF v_exp_report_accounts.account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_INTERCOMPANY_AP_ACC_ERROR';
          END IF;
        
          v_exp_report_accounts.company_id               := v_exp_report_dists.company_id;
          v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_accounts.company_id);
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          v_exp_report_accounts.entered_amount_cr := v_exp_report_dists.report_amount;
        
          v_exp_report_accounts.functional_amount_cr := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                              p_amount                  => v_exp_report_accounts.entered_amount_cr,
                                                                              p_batch_id                => p_batch_id,
                                                                              p_company_id              => v_exp_report_accounts.company_id,
                                                                              p_exchange_rate_type      => v_exchange_rate_type,
                                                                              p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                              p_exchange_rate           => v_exchange_rate,
                                                                              p_standard_currency       => v_standard_currency);
        
          v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
          v_exp_report_accounts.exchange_rate      := v_exchange_rate;
          v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
        
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
          --贷往来
          --updated by liyuhang 2018.4.10
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_desc1,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => '',
                                     p_functional_amount_dr     => '',
                                     p_entered_amount_cr        => v_exp_report_accounts.entered_amount_cr,
                                     p_functional_amount_cr     => v_exp_report_accounts.functional_amount_cr,
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'INTERCOMPANY_AP');
        
        END IF;
        ------------------------------------------------------lyh end---------------------------------------------
      
      END IF;
    END LOOP;
    CLOSE cur_line;
  
    SELECT COUNT(1)
      INTO v_pmt_length
      FROM exp_report_pmt_schedules ps, exp_report_headers h
     WHERE ps.exp_report_header_id = h.exp_report_header_id
       AND h.exp_report_header_id = p_exp_rep_header_id;
  
    --从计划付款行中创建贷方凭证，科目EMPLOYEE_EXPENSE_CLEARING
    FOR c_pmt_schedules IN (SELECT ps.*, h.currency_code
                              FROM exp_report_pmt_schedules ps,
                                   exp_report_headers       h
                             WHERE ps.exp_report_header_id =
                                   h.exp_report_header_id
                               AND h.exp_report_header_id =
                                   p_exp_rep_header_id) LOOP
    
      v_pmt_count := v_pmt_count + 1;
    
      --删除当前计划付款行生成的贷方凭证
      DELETE FROM exp_report_accounts a
       WHERE a.payment_schedule_line_id =
             c_pmt_schedules.payment_schedule_line_id;
      --摘要取报销单号 update by lyh 2017.8.5
      --v_exp_account_desc := c_pmt_schedules.description;
      v_exp_account_desc := v_exp_report_number;
      v_partner_type_id  := get_partner_type_id(p_partner_category => c_pmt_schedules.payee_category,
                                                p_company_id       => c_pmt_schedules.company_id,
                                                p_partner_id       => c_pmt_schedules.payee_id);
    
      acc_builder_exp_clearing_pkg.set_process_id(v_header_company_id,
                                                  p_user_id);
      --获取付款用途id
      SELECT cpu.usedes_id
        INTO v_usedes_id
        FROM csh_payment_usedes cpu
       WHERE cpu.usedes_code = c_pmt_schedules.usedes;
    
      acc_builder_exp_clearing_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                             p_expense_user_group_id  => v_expense_user_group_id,
                                                             p_expense_report_type_id => v_expense_report_type_id,
                                                             p_currency_code          => v_exp_report_accounts.currency_code,
                                                             p_employee_type_id       => v_employee_type_id,
                                                             p_partner_category       => c_pmt_schedules.payee_category,
                                                             p_partner_type_id        => v_partner_type_id,
                                                             p_partner_id             => c_pmt_schedules.payee_id,
                                                             p_usedes_id              => v_usedes_id);
    
      v_exp_report_accounts.account_id := acc_builder_exp_clearing_pkg.get_account;
      IF v_exp_report_accounts.account_id = -1 THEN
        RETURN 'EXP5140_GET_EXP_CLE_ACC_ERROR';
      END IF;
    
      --v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
      v_exp_report_accounts.responsibility_center_id := g_responsibility_center_id;
      IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
        RETURN 'EXP5140_RESP_CENTER_ERROR';
      END IF;
    
      v_exp_report_accounts.entered_amount_cr := c_pmt_schedules.due_amount;
    
      --Date:2014年7月28日17:05:39
      --Author:ZhouHao
      --Purpose:原报销单贷方金额会根据报销单借方金额调整最后一行贷方的本币金额，避免出现尾差，该逻辑在报销单支付的时候会出现付款凭证与应付凭证金额存在差异的情况，
      --目前修改为报销单的借方的本币金额根据贷方的本币金额调整尾差，避免出现支付存在金额匹配不上的问题
      --------G
      v_exp_report_accounts.functional_amount_cr := get_functional_amount(p_currency_code           => c_pmt_schedules.currency_code,
                                                                          p_amount                  => v_exp_report_accounts.entered_amount_cr,
                                                                          p_batch_id                => p_batch_id,
                                                                          p_company_id              => v_header_company_id,
                                                                          p_exchange_rate_type      => v_exchange_rate_type,
                                                                          p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                          p_exchange_rate           => v_exchange_rate,
                                                                          p_standard_currency       => v_standard_currency);
    
      v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
      v_exp_report_accounts.exchange_rate      := v_exchange_rate;
      v_exp_report_accounts.currency_code      := c_pmt_schedules.currency_code;
      /*from here
      select *
        into v_exp_header
        from exp_report_headers h
       where h.exp_report_header_id = c_pmt_schedules.exp_report_header_id;
      
      v_exp_report_accounts.exchange_rate_type := v_exp_header.exchange_rate_type;
      v_exp_report_accounts.exchange_rate      := v_exp_header.exchange_rate;
      v_exp_report_accounts.currency_code := c_pmt_schedules.currency_code;
      
      if v_exp_report_accounts.exchange_rate_type = 'DIRECT QUOTATION' then
        v_functional_amount := v_exp_report_accounts.entered_amount_cr *
                               v_exp_report_accounts.exchange_rate;
      elsif v_exp_report_accounts.exchange_rate_type = 'INDIRECT QUOTATION' then
        v_functional_amount := v_exp_report_accounts.entered_amount_cr *
                               (1 / v_exp_report_accounts.exchange_rate);
      else
        v_functional_amount := v_exp_report_accounts.entered_amount_cr *
                               v_exp_report_accounts.exchange_rate;
      end if;
      
      v_exp_report_accounts.functional_amount_cr := fnd_format_mask_pkg.get_gld_amount(p_currency_code   => gld_common_pkg.get_company_currency_code(p_company_id => v_exp_header.company_id),
                                                                                       p_amount          => v_functional_amount,
                                                                                       p_set_of_books_id => gld_common_pkg.get_set_of_books_id(p_comany_id => v_exp_header.company_id));
      *end here*/
      v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
      insert_exp_report_accounts_c(p_payment_schedule_line_id => c_pmt_schedules.payment_schedule_line_id,
                                   p_exp_report_header_id     => p_exp_rep_header_id,
                                   p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                   p_description              => v_desc1, --modify by wxq 20180418 修改费用凭证借方摘要,,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                   p_company_id               => v_header_company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_exp_report_accounts.account_id,
                                   p_currency_code            => v_exp_report_accounts.currency_code,
                                   p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                   p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                   p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                   p_entered_amount_dr        => '',
                                   p_functional_amount_dr     => '',
                                   p_entered_amount_cr        => v_exp_report_accounts.entered_amount_cr,
                                   p_functional_amount_cr     => v_exp_report_accounts.functional_amount_cr,
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'EMPLOYEE_EXPENSE_CLEARING');
      --==========如果计划付款行的用途是培训类机票，则在增加一借一贷凭证 add by Shen Jinan 20180227 START==========
      IF c_pmt_schedules.usedes = 'PTB' THEN
        --增加借方，和上面的贷方一样 start
        v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        insert_exp_report_accounts(p_exp_report_dists_id      => g_exp_report_dists_id,
                                   p_exp_report_header_id     => p_exp_rep_header_id,
                                   p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                   p_description              => v_exp_account_desc,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                   p_company_id               => v_header_company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_exp_report_accounts.account_id,
                                   p_currency_code            => v_exp_report_accounts.currency_code,
                                   p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                   p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                   p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                   p_entered_amount_dr        => v_exp_report_accounts.entered_amount_cr, --税额
                                   p_functional_amount_dr     => v_exp_report_accounts.functional_amount_cr,
                                   p_entered_amount_cr        => '',
                                   p_functional_amount_cr     => '',
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'EMPLOYEE_EXPENSE');
        --增加借方，和上面的贷方一样 end
      
        --增加贷方,搭配固定的科目 应收账款-预付款项-业务运营 start
        --获取科目id
      
        SELECT g.account_id
          INTO v_exp_report_accounts.account_id
          FROM gld_accounts g
         WHERE g.account_code = '1122010300';
        IF v_exp_report_accounts.account_id = -1 THEN
          RETURN 'EXP5140_GET_EXP_CLE_ACC_ERROR';
        END IF;
      
        --获取成本中心ID
        v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
        IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
          RETURN 'EXP5140_RESP_CENTER_ERROR';
        END IF;
        v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        insert_exp_report_accounts_c(p_payment_schedule_line_id => c_pmt_schedules.payment_schedule_line_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_desc1,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => '',
                                     p_functional_amount_dr     => '',
                                     p_entered_amount_cr        => v_exp_report_accounts.entered_amount_cr,
                                     p_functional_amount_cr     => v_exp_report_accounts.functional_amount_cr,
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_CLEARING');
        --增加贷方 end
      END IF;
    
    --==========如果计划付款行的用途是培训类机票，则在增加一借一贷凭证 add by Shen Jinan 20180227 END==========
    
    END LOOP;
  
    --Date:2014年7月28日17:27:04
    --Author:Zhouhao
    --Purpose:报销单凭证生成后，根据报销单借方[EXPLOYEE_EXPENSE]金额总和和报销单贷方[EMPLOYEE_EXPENSE_CLEARING]金额总和的差调整报销单借方金额最大的那行的
    --本币金额
    SELECT (nvl((SELECT SUM(a1.functional_amount_dr)
                  FROM exp_report_accounts a1
                 WHERE a1.exp_report_header_id = p_exp_rep_header_id
                   AND a1.usage_code = 'EMPLOYEE_EXPENSE'),
                0) +
           --Date:2014年10月11日15:27:17
           --Author:ZhouHao
           --Purpose:税金部分可能为空，导致计算差额的时候会导致adjust_amount为null，后面update的时候更新报销单凭证上的本币金额为null
           nvl((SELECT SUM(a1.functional_amount_dr)
                  FROM exp_report_accounts a1
                 WHERE a1.exp_report_header_id = p_exp_rep_header_id
                   AND a1.usage_code = 'EMPLOYEE_EXPENSE_TAX'),
                0)) -
           nvl((SELECT SUM(a1.functional_amount_cr)
                 FROM exp_report_accounts a1
                WHERE a1.exp_report_header_id = p_exp_rep_header_id
                  AND a1.usage_code = 'EMPLOYEE_EXPENSE_CLEARING'),
               0)
      INTO v_adjust_amount
      FROM dual;
  
    SELECT d1.exp_report_dists_id
      INTO v_adjust_exp_dists_id
      FROM exp_report_dists d1, exp_report_lines l1
     WHERE l1.exp_report_header_id = p_exp_rep_header_id
       AND l1.exp_report_line_id = d1.exp_report_line_id
       AND d1.report_functional_amount =
           (SELECT MAX(d2.report_functional_amount)
              FROM exp_report_lines l2, exp_report_dists d2
             WHERE d2.exp_report_line_id = l2.exp_report_line_id
               AND l2.exp_report_header_id = p_exp_rep_header_id)
       AND rownum = 1;
  
    UPDATE exp_report_accounts a
       SET a.functional_amount_dr = a.functional_amount_dr - v_adjust_amount,
           a.functional_amount_cr = a.functional_amount_cr - v_adjust_amount
     WHERE a.exp_report_dists_id = v_adjust_exp_dists_id
       AND a.usage_code = 'EMPLOYEE_EXPENSE';
  
    /*************************************************
    -- Author  : MOUSE
    -- Created : 2015年11月25日10:00:16
    -- Ver     : 1.1
    -- Purpose : 报销单类型如果为托收，那么报销单贷方科目取托收科目对应的银行科目
    **************************************************/
    SELECT t.document_page_type
      INTO v_page_type
      FROM exp_report_headers h, exp_expense_report_types t
     WHERE h.exp_report_header_id = p_exp_rep_header_id
       AND h.exp_report_type_id = t.expense_report_type_id;
  
    IF v_page_type = 'COLLECTION' THEN
    
      FOR pmt_lns IN (SELECT s.payment_schedule_line_id,
                             ga.account_id,
                             ga.account_code
                        FROM exp_report_pmt_schedules s,
                             csh_bank_accounts        a,
                             gld_accounts             ga
                       WHERE s.exp_report_header_id = p_exp_rep_header_id
                         AND s.collection_account_id = a.bank_account_id
                         AND a.cash_account_id = ga.account_id) LOOP
      
        FOR account IN (SELECT *
                          FROM exp_report_accounts a
                         WHERE a.payment_schedule_line_id =
                               pmt_lns.payment_schedule_line_id) LOOP
          UPDATE exp_report_accounts a
             SET a.account_id       = pmt_lns.account_id,
                 a.account_segment3 = pmt_lns.account_code
           WHERE a.exp_report_je_line_id = account.exp_report_je_line_id;
        
          UPDATE gl_account_entry e
             SET e.account_id   = pmt_lns.account_id,
                 e.account_code = pmt_lns.account_code,
                 e.segment3     = pmt_lns.account_code
           WHERE e.transaction_type = 'EXP_REPORT'
             AND e.transaction_je_line_id = account.exp_report_je_line_id;
        
          gl_log_pkg.log(p_log_text => '托收报销单贷方凭证，从计付行托收账户带出，凭证行ID为：' ||
                                       account.exp_report_je_line_id ||
                                       '，科目ID为：' || pmt_lns.account_id ||
                                       '，科目代码为:' || pmt_lns.account_code,
                         p_user_id  => p_user_id);
        END LOOP;
      END LOOP;
    END IF;
  
    /*************************************************/
  
    RETURN NULL;
  END create_er_accounts_wlzq;

  /**-----------------------------------------
  -- 费用报销单提交时,预生成凭证
  -- 校验CCID
  ------------------------------------------*/
  PROCEDURE pre_create_er_accounts(p_exp_rep_header_id NUMBER,
                                   p_user_id           NUMBER) IS
    v_batch_id             NUMBER := get_batch_id;
    v_result               VARCHAR2(200);
    v_amortization_flag    VARCHAR2(2);
    v_write_off_je_line_id NUMBER;
    v_account_id           NUMBER;
  BEGIN
    INSERT INTO exp_currency_code_tmp
      (batch_id, currency_code, exchange_rate, creation_date)
    VALUES
      (v_batch_id, 'CNY', 1, SYSDATE);
  
    v_result := create_er_accounts_grcx(p_exp_rep_header_id => p_exp_rep_header_id,
                                        p_journal_date      => trunc(SYSDATE),
                                        p_user_id           => p_user_id,
                                        p_batch_id          => v_batch_id,
                                        p_period_name       => to_char(SYSDATE,
                                                                       'yyyy-mm'));
  
    --modify by pqs 提交时，预生成凭证
    SELECT h.amortization_flag
      INTO v_amortization_flag
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_rep_header_id;
  
    IF v_result IS NULL THEN
      --IF v_amortization_flag = 'Y' THEN
      --待摊
      v_result := create_exp_amortization_acc(p_exp_report_header_id => p_exp_rep_header_id,
                                              p_user_id              => p_user_id);
      --END IF;
    END IF;
  
    --IF v_result IS NULL THEN
    UPDATE exp_report_headers t
       SET t.je_creation_status = 'SUCCESS',
           t.last_updated_by    = p_user_id,
           t.last_update_date   = SYSDATE,
           t.amortization_flag  = v_amortization_flag
     WHERE t.exp_report_header_id = p_exp_rep_header_id;
  
    UPDATE exp_report_accounts_tmp t
       SET t.success_flag = 'Y'
     WHERE t.batch_id = v_batch_id
       AND t.expense_report_header_id = p_exp_rep_header_id;
    --commit;
    /*ELSE
    error_log(sys_message_pkg.get_string(v_err_code));
    RAISE e_create_accounts_error;*/
    --END IF;
  
    --创建报销单历史
    /*insert_exp_document_histories(p_document_type  => c_exp_report,
    p_document_id    => p_exp_rep_header_id,
    p_operation_code => exp_document_history_pkg.c_create_je, --'CREATE_JE',
    p_user_id        => p_user_id,
    p_operation_time => SYSDATE,
    p_description    => '');*/
  
    BEGIN
      SELECT t.account_id
        INTO v_account_id
        FROM exp_report_accounts t
       WHERE t.exp_report_header_id = p_exp_rep_header_id
         AND t.functional_amount_cr IS NOT NULL;
    
      SELECT cwoa.write_off_je_line_id
        INTO v_write_off_je_line_id
        FROM csh_write_off_accounts cwoa
       WHERE cwoa.write_off_je_line_id =
             (SELECT cwoa.write_off_je_line_id
                FROM csh_write_off_accounts cwoa
               WHERE cwoa.write_off_id =
                     (SELECT cwo.write_off_id
                        FROM csh_write_off cwo
                       WHERE cwo.document_line_id =
                             (SELECT erps.payment_schedule_line_id
                                FROM exp_report_pmt_schedules erps
                               WHERE erps.payment_schedule_line_id =
                                     (SELECT era.payment_schedule_line_id
                                        FROM exp_report_accounts era
                                       WHERE era.exp_report_je_line_id =
                                             (SELECT tmp.exp_report_je_line_id
                                                FROM exp_report_accounts tmp
                                               WHERE tmp.exp_report_header_id =
                                                     p_exp_rep_header_id
                                                 AND tmp.functional_amount_cr IS NOT NULL)
                                         AND era.functional_amount_cr IS NOT NULL)))
                 AND cwoa.functional_amount_dr IS NOT NULL);
    
      IF v_write_off_je_line_id IS NOT NULL AND v_account_id IS NOT NULL THEN
        UPDATE csh_write_off_accounts cwoa
           SET cwoa.account_id = v_account_id
         WHERE cwoa.write_off_je_line_id = v_write_off_je_line_id
           AND cwoa.functional_amount_dr IS NOT NULL;
      END IF;
    
    EXCEPTION
      WHEN OTHERS THEN
        NULL;
    END;
  
  END pre_create_er_accounts;

  FUNCTION create_exp_report_accounts(p_exp_rep_header_id NUMBER,
                                      p_journal_date      DATE,
                                      p_user_id           NUMBER,
                                      p_batch_id          NUMBER,
                                      p_period_name       VARCHAR2)
    RETURN VARCHAR2 IS
    CURSOR cur_line(p_rep_header_id NUMBER) IS
      SELECT d.*,
             l.line_number,
             l.tax_type_id,
             l.invoice_type AS line_invoice_type --modified by HM @2016-04-13 增加发票类型
        FROM exp_report_dists d, exp_report_lines l
       WHERE d.exp_report_line_id = l.exp_report_line_id
         AND l.exp_report_header_id = p_exp_rep_header_id;
  
    v_exp_report_dists    cur_line%ROWTYPE;
    v_exp_report_accounts exp_report_accounts%ROWTYPE;
  
    v_header_company_id      exp_report_headers.company_id %TYPE;
    v_employee_id            exp_report_headers.employee_id %TYPE;
    v_employee_type_id       exp_employees.employee_type_id%TYPE;
    v_expense_user_group_id  exp_report_headers.expense_user_group_id %TYPE;
    v_expense_report_type_id exp_report_headers.exp_report_type_id %TYPE;
    v_rep_header_desc        exp_report_headers.description %TYPE;
    v_exp_account_desc       exp_report_accounts.description%TYPE;
  
    v_exchange_rate      exp_currency_code_tmp.exchange_rate%TYPE;
    v_exchange_rate_type exp_currency_code_tmp.exchange_rate_type%TYPE;
  
    v_period_comparison    VARCHAR2(30);
    v_dists_period_num     NUMBER;
    v_operation_period_num NUMBER;
    v_standard_currency    VARCHAR2(30); --本位币
    v_partner_type_id      NUMBER;
    v_adjust_exp_dists_id  NUMBER;
    v_adjust_amount        NUMBER;
    v_usedes_id            NUMBER; --付款用途代码id
    v_tax_type_rate        NUMBER; --税率
    v_tax_category         VARCHAR2(30); --税率类别
    v_tax_amount           NUMBER; --税金金额
    v_tax_function_amount  NUMBER; --税金本位币金额
    v_currency_precision   NUMBER;
    v_pmt_count            NUMBER := 0; --计划付款行行数，用于创建贷方凭证的时候做尾差处理
    v_pmt_length           NUMBER;
  
    v_exp_header        exp_report_headers%ROWTYPE;
    v_functional_amount NUMBER;
  
    v_page_type VARCHAR2(30);
  
    e_acc_error EXCEPTION;
    --modified by HM @2016-04-07营改增改动
    v_tax_exp_report_je_line_id NUMBER;
    v_tax_account_id            NUMBER;
    v_entered_amount_dr_tax     NUMBER := 0;
    v_functional_amount_dr_tax  NUMBER := 0;
  BEGIN
    SELECT v.company_id,
           v.employee_id,
           v.expense_user_group_id,
           v.exp_report_type_id,
           v.description
      INTO v_header_company_id,
           v_employee_id,
           v_expense_user_group_id,
           v_expense_report_type_id,
           v_rep_header_desc
      FROM exp_report_headers v
     WHERE v.exp_report_header_id = p_exp_rep_header_id;
  
    v_exp_report_accounts.period_name := p_period_name;
    v_employee_type_id                := get_employee_type_id(v_employee_id);
  
    OPEN cur_line(p_exp_rep_header_id);
    LOOP
      FETCH cur_line
        INTO v_exp_report_dists;
      EXIT WHEN cur_line%NOTFOUND;
      DELETE FROM exp_report_accounts t
       WHERE t.exp_report_dists_id = v_exp_report_dists.exp_report_dists_id;
    
      g_line_number         := v_exp_report_dists.line_number;
      g_exp_report_dists_id := v_exp_report_dists.exp_report_dists_id;
    
      SELECT gc.precision
        INTO v_currency_precision
        FROM gld_currency gc
       WHERE gc.currency_code = v_exp_report_dists.currency_code;
    
      IF v_exp_report_dists.tax_type_id IS NOT NULL THEN
        BEGIN
          SELECT c.tax_type_rate, c.tax_category
            INTO v_tax_type_rate, v_tax_category
            FROM fnd_tax_type_codes c
           WHERE c.tax_type_id = v_exp_report_dists.tax_type_id;
        EXCEPTION
          WHEN no_data_found THEN
            CLOSE cur_line;
            RETURN 'EXP5140_EXP_ACCOUNTS_TAX_ERROR';
        END;
      END IF;
    
      IF v_exp_report_dists.company_id = v_header_company_id THEN
        --分配行公司 = 报销单头公司
        v_standard_currency := gld_common_pkg.get_company_currency_code(v_header_company_id);
        ----------------借方 -------------
        -- 摘要 取报销单头说明
        --v_exp_account_desc := v_rep_header_desc;
      
        v_exp_account_desc := v_exp_report_dists.description;
      
        --业务期间
        v_dists_period_num := gld_common_pkg.get_gld_internal_period_num(v_header_company_id,
                                                                         v_exp_report_dists.period_name);
        --审核期间
        v_operation_period_num := gld_common_pkg.get_gld_internal_period_num(v_header_company_id,
                                                                             p_period_name);
        IF v_dists_period_num > v_operation_period_num THEN
          v_period_comparison := 'EARLIER';
        ELSIF v_dists_period_num = v_operation_period_num THEN
          v_period_comparison := 'IN';
        ELSE
          v_period_comparison := 'LATER';
        END IF;
      
        --如果当前税率类型不为空且当前税率不为空，则产生税金凭证，并且费用凭证金额为行金额-税金金额
        IF v_exp_report_dists.tax_type_id IS NOT NULL AND
           v_tax_type_rate IS NOT NULL THEN
        
          acc_builder_emp_exp_tax_pkg.set_process_id(p_company_id => v_header_company_id,
                                                     p_user_id    => p_user_id);
          acc_builder_emp_exp_tax_pkg.create_mapping_conditions(p_tax_type_id            => v_exp_report_dists.tax_type_id,
                                                                p_expense_report_type_id => v_expense_report_type_id);
        
          v_exp_report_accounts.account_id := acc_builder_emp_exp_tax_pkg.get_account;
          IF v_exp_report_accounts.account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_TAX_ACC_ERROR';
          END IF;
        
          --取默认责任中心
          -- v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
          v_exp_report_accounts.responsibility_center_id := v_exp_report_dists.responsibility_center_id;
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          --获取税金凭证行ID，本币金额，原币金额
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
          --modified 根据税率类别生成不同的税金
          IF v_tax_category = 'TAX_INCLUSIVE_PRICE' THEN
            v_tax_amount := fnd_format_mask_pkg.get_gld_amount(p_currency_code   => v_exp_report_dists.currency_code,
                                                               p_amount          => v_exp_report_dists.report_amount *
                                                                                    v_tax_type_rate,
                                                               p_set_of_books_id => gld_common_pkg.get_set_of_books_id(p_comany_id => v_exp_report_dists.company_id));
          ELSIF v_tax_category = 'TAX_EXCLUSIVE_PRICE' THEN
            v_tax_amount := fnd_format_mask_pkg.get_gld_amount(p_currency_code   => v_exp_report_dists.currency_code,
                                                               p_amount          => (v_exp_report_dists.report_amount / (1 +
                                                                                    v_tax_type_rate)) *
                                                                                    v_tax_type_rate,
                                                               p_set_of_books_id => gld_common_pkg.get_set_of_books_id(p_comany_id => v_exp_report_dists.company_id));
          END IF;
        
          v_tax_function_amount := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                         p_amount                  => v_tax_amount,
                                                         p_batch_id                => p_batch_id,
                                                         p_company_id              => v_header_company_id,
                                                         p_exchange_rate_type      => v_exchange_rate_type,
                                                         p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                         p_exchange_rate           => v_exchange_rate,
                                                         p_standard_currency       => v_standard_currency);
        
          v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
          v_exp_report_accounts.exchange_rate      := v_exchange_rate;
          v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
        
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_exp_account_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_tax_amount,
                                     p_functional_amount_dr     => v_tax_function_amount,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_TAX');
        
          --获取费用凭证行ID，本币金额，原币金额 ，其中金额部分使用费用总金额 - 税金金额和费用本币总金额 - 税金本币总金额方式获取
        
          acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                                 p_expense_user_group_id  => v_expense_user_group_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => v_exp_report_dists.currency_code,
                                                                 p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                 p_period_comparison      => v_period_comparison,
                                                                 p_employee_type_id       => v_employee_type_id,
                                                                 p_org_unit               => v_exp_report_dists.unit_id,
                                                                 --add by Qu yuanyuan
                                                                 p_du_id => v_exp_report_dists.dimension6_id);
        
          v_exp_report_accounts.account_id := acc_builder_employee_exp_pkg.get_account;
          IF v_exp_report_accounts.account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          --取默认责任中心
          -- v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
          v_exp_report_accounts.responsibility_center_id := v_exp_report_dists.responsibility_center_id;
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        
          v_exp_report_accounts.entered_amount_dr    := v_exp_report_dists.report_amount -
                                                        v_tax_amount;
          v_exp_report_accounts.functional_amount_dr := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                              p_amount                  => v_exp_report_dists.report_amount,
                                                                              p_batch_id                => p_batch_id,
                                                                              p_company_id              => v_header_company_id,
                                                                              p_exchange_rate_type      => v_exchange_rate_type,
                                                                              p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                              p_exchange_rate           => v_exchange_rate,
                                                                              p_standard_currency       => v_standard_currency) -
                                                        v_tax_function_amount;
        
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_exp_account_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_exp_report_accounts.entered_amount_dr,
                                     p_functional_amount_dr     => v_exp_report_accounts.functional_amount_dr,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE');
        ELSE
          ---借方--------
          acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                                 p_expense_user_group_id  => v_expense_user_group_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => v_exp_report_dists.currency_code,
                                                                 p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                 p_period_comparison      => v_period_comparison,
                                                                 p_employee_type_id       => v_employee_type_id,
                                                                 p_org_unit               => v_exp_report_dists.unit_id,
                                                                 --add by Qu yuanyuan
                                                                 p_du_id => v_exp_report_dists.dimension6_id);
        
          v_exp_report_accounts.account_id := acc_builder_employee_exp_pkg.get_account;
          IF v_exp_report_accounts.account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          --取默认责任中心
          -- v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
          v_exp_report_accounts.responsibility_center_id := v_exp_report_dists.responsibility_center_id;
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        
          --v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount;
        
          IF v_exp_report_dists.line_invoice_type IS NULL THEN
            v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount;
          ELSIF v_exp_report_dists.line_invoice_type != '20' AND
                v_exp_report_dists.line_invoice_type != '70' THEN
            v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.sale_amount;
          
          ELSE
            v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount -
                                                       nvl(v_exp_report_dists.tax_amount,
                                                           0);
          END IF;
        
          v_exp_report_accounts.functional_amount_dr := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                              p_amount                  => v_exp_report_accounts.entered_amount_dr,
                                                                              p_batch_id                => p_batch_id,
                                                                              p_company_id              => v_header_company_id,
                                                                              p_exchange_rate_type      => v_exchange_rate_type,
                                                                              p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                              p_exchange_rate           => v_exchange_rate,
                                                                              p_standard_currency       => v_standard_currency);
        
          v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
          v_exp_report_accounts.exchange_rate      := v_exchange_rate;
          v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
        
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_exp_account_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_header_company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_exp_report_accounts.entered_amount_dr,
                                     p_functional_amount_dr     => v_exp_report_accounts.functional_amount_dr,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE');
        
          -----------------------------------------------------------------------------------------------------------
          -- 增值税修改  update  by robin 2016-04-14
        
          v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
          v_entered_amount_dr_tax     := nvl(v_exp_report_dists.tax_amount,
                                             0);
          v_functional_amount_dr_tax  := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                               p_amount                  => v_entered_amount_dr_tax,
                                                               p_batch_id                => p_batch_id,
                                                               p_company_id              => v_header_company_id,
                                                               p_exchange_rate_type      => v_exchange_rate_type,
                                                               p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                               p_exchange_rate           => v_exchange_rate,
                                                               p_standard_currency       => v_standard_currency);
        
          --启用条件：行发票类型是专票
          --update by lyh 
          --根据发票类型表的视同专票标识判断是专票还是普票
        
          IF v_exp_report_dists.line_invoice_type != 'FPLX002' AND
             v_exp_report_dists.line_invoice_type != 'FPLX003' THEN
            --取进项税科目
            acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                        p_user_id    => p_user_id);
            --根据营改增使用的用途代码，失效相应的参数，这里只保留单据类型ID
            acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => NULL, --v_employee_id,
                                                                   p_expense_user_group_id  => NULL, --v_expense_user_group_id,
                                                                   p_expense_report_type_id => v_expense_report_type_id,
                                                                   p_currency_code          => NULL, --v_exp_report_dists.currency_code, 
                                                                   p_expense_item_id        => NULL, --v_exp_report_dists.expense_item_id,   跳过选择费用科目
                                                                   p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                   p_period_comparison      => NULL, --v_period_comparison,
                                                                   p_employee_type_id       => NULL, --v_employee_type_id,
                                                                   p_org_unit               => NULL, --v_exp_report_dists.unit_id
                                                                   --add by Qu yuanyuan
                                                                   p_du_id => NULL --v_exp_report_dists.dimension6_id
                                                                   );
          
            v_tax_account_id := acc_builder_employee_exp_pkg.get_account;
            IF v_tax_account_id = -1 THEN
              CLOSE cur_line;
              RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
            END IF;
          
            insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                       p_exp_report_header_id     => p_exp_rep_header_id,
                                       p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                       p_description              => v_exp_account_desc,
                                       p_journal_date             => p_journal_date,
                                       p_period_name              => v_exp_report_accounts.period_name,
                                       p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                       p_company_id               => v_header_company_id,
                                       p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                       p_account_id               => v_tax_account_id,
                                       p_currency_code            => v_exp_report_accounts.currency_code,
                                       p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                       p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                       p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                       p_entered_amount_dr        => v_entered_amount_dr_tax, --税额
                                       p_functional_amount_dr     => v_functional_amount_dr_tax,
                                       p_entered_amount_cr        => '',
                                       p_functional_amount_cr     => '',
                                       p_user_id                  => p_user_id,
                                       p_gld_interface_flag       => 'N',
                                       p_usage_code               => 'EMPLOYEE_EXPENSE');
          END IF;
          ---------------------------------------------------------------------------------------------------------                            
        END IF;
      ELSE
        --分配行公司 <> 报销单头公司
        v_standard_currency := gld_common_pkg.get_company_currency_code(v_header_company_id);
      
        ----------------借方 1  -------------
        -- 摘要 取分配行说明
        v_exp_account_desc := v_exp_report_dists.description;
      
        --业务期间
        v_dists_period_num := gld_common_pkg.get_gld_internal_period_num(v_exp_report_dists.company_id,
                                                                         v_exp_report_dists.period_name);
        --审核期间
        v_operation_period_num := gld_common_pkg.get_gld_internal_period_num(v_exp_report_dists.company_id,
                                                                             p_period_name);
        IF v_dists_period_num > v_operation_period_num THEN
          v_period_comparison := 'EARLIER';
        ELSIF v_dists_period_num = v_operation_period_num THEN
          v_period_comparison := 'IN';
        ELSE
          v_period_comparison := 'LATER';
        END IF;
      
        --如果当前税率类型不为空且当前税率不为空，则产生税金凭证，并且费用凭证金额为行金额-税金金额
        IF v_exp_report_dists.tax_type_id IS NOT NULL AND
           v_tax_type_rate IS NOT NULL THEN
        
          acc_builder_emp_exp_tax_pkg.set_process_id(p_company_id => v_exp_report_dists.company_id,
                                                     p_user_id    => p_user_id);
          acc_builder_emp_exp_tax_pkg.create_mapping_conditions(p_tax_type_id            => v_exp_report_dists.tax_type_id,
                                                                p_expense_report_type_id => v_expense_report_type_id);
        
          v_exp_report_accounts.account_id := acc_builder_emp_exp_tax_pkg.get_account;
          IF v_exp_report_accounts.account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_TAX_ACC_ERROR';
          END IF;
        
          --取默认责任中心
          -- v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
          v_exp_report_accounts.responsibility_center_id := v_exp_report_dists.responsibility_center_id;
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          --获取税金凭证行ID，本币金额，原币金额
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
          v_tax_amount                                := fnd_format_mask_pkg.get_gld_amount(p_currency_code   => v_exp_report_dists.currency_code,
                                                                                            p_amount          => v_exp_report_dists.report_amount *
                                                                                                                 v_tax_type_rate,
                                                                                            p_set_of_books_id => gld_common_pkg.get_set_of_books_id(p_comany_id => v_exp_report_dists.company_id));
        
          v_tax_function_amount := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                         p_amount                  => v_tax_amount,
                                                         p_batch_id                => p_batch_id,
                                                         p_company_id              => v_exp_report_dists.company_id,
                                                         p_exchange_rate_type      => v_exchange_rate_type,
                                                         p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                         p_exchange_rate           => v_exchange_rate,
                                                         p_standard_currency       => v_standard_currency);
        
          v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
          v_exp_report_accounts.exchange_rate      := v_exchange_rate;
          v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
        
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_exp_account_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_exp_report_dists.company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_tax_amount,
                                     p_functional_amount_dr     => v_tax_function_amount,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE_TAX');
        
          --获取费用凭证行ID，本币金额，原币金额 ，其中金额部分使用费用总金额 - 税金金额和费用本币总金额 - 税金本币总金额方式获取
        
          acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_exp_report_dists.company_id,
                                                      p_user_id    => p_user_id);
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                                 p_expense_user_group_id  => v_expense_user_group_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => v_exp_report_dists.currency_code,
                                                                 p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                 p_period_comparison      => v_period_comparison,
                                                                 p_employee_type_id       => v_employee_type_id,
                                                                 p_org_unit               => v_exp_report_dists.unit_id,
                                                                 --add by Qu yuanyuan
                                                                 p_du_id => v_exp_report_dists.dimension6_id);
        
          v_exp_report_accounts.account_id := acc_builder_employee_exp_pkg.get_account;
          IF v_exp_report_accounts.account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          --取默认责任中心
          -- v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
          v_exp_report_accounts.responsibility_center_id := v_exp_report_dists.responsibility_center_id;
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
          v_exp_report_accounts.entered_amount_dr     := v_exp_report_dists.report_amount -
                                                         v_tax_amount;
          v_exp_report_accounts.functional_amount_dr  := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                               p_amount                  => v_exp_report_dists.report_amount,
                                                                               p_batch_id                => p_batch_id,
                                                                               p_company_id              => v_exp_report_dists.company_id,
                                                                               p_exchange_rate_type      => v_exchange_rate_type,
                                                                               p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                               p_exchange_rate           => v_exchange_rate,
                                                                               p_standard_currency       => v_standard_currency) -
                                                         v_tax_function_amount;
        
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_exp_account_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_exp_report_dists.company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_exp_report_accounts.entered_amount_dr,
                                     p_functional_amount_dr     => v_exp_report_accounts.functional_amount_dr,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE');
        ELSE
          ----借方------
          acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_exp_report_dists.company_id,
                                                      p_user_id    => p_user_id);
          acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                                 p_expense_user_group_id  => v_expense_user_group_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => v_exp_report_dists.currency_code,
                                                                 p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                 p_period_comparison      => v_period_comparison,
                                                                 p_employee_type_id       => v_employee_type_id,
                                                                 p_org_unit               => v_exp_report_dists.unit_id,
                                                                 --add by Qu yuanyuan
                                                                 p_du_id => v_exp_report_dists.dimension6_id);
        
          v_exp_report_accounts.account_id := acc_builder_employee_exp_pkg.get_account;
          IF v_exp_report_accounts.account_id = -1 THEN
            CLOSE cur_line;
            RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
          END IF;
        
          --取默认责任中心
          -- v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
          v_exp_report_accounts.responsibility_center_id := v_exp_report_dists.responsibility_center_id;
          IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
            CLOSE cur_line;
            RETURN 'EXP5140_RESP_CENTER_ERROR';
          END IF;
        
          v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        
          --v_exp_report_accounts.entered_amount_dr    := v_exp_report_dists.report_amount;
        
          IF v_exp_report_dists.line_invoice_type IS NULL THEN
            v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount;
          ELSIF v_exp_report_dists.line_invoice_type != '20' AND
                v_exp_report_dists.line_invoice_type != '70' THEN
            v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.sale_amount;
          
          ELSE
            v_exp_report_accounts.entered_amount_dr := v_exp_report_dists.report_amount -
                                                       nvl(v_exp_report_dists.tax_amount,
                                                           0);
          END IF;
        
          v_exp_report_accounts.functional_amount_dr := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                              p_amount                  => v_exp_report_accounts.entered_amount_dr,
                                                                              p_batch_id                => p_batch_id,
                                                                              p_company_id              => v_exp_report_dists.company_id,
                                                                              p_exchange_rate_type      => v_exchange_rate_type,
                                                                              p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                              p_exchange_rate           => v_exchange_rate,
                                                                              p_standard_currency       => v_standard_currency);
        
          v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
          v_exp_report_accounts.exchange_rate      := v_exchange_rate;
          v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
        
          insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                     p_exp_report_header_id     => p_exp_rep_header_id,
                                     p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                     p_description              => v_exp_account_desc,
                                     p_journal_date             => p_journal_date,
                                     p_period_name              => v_exp_report_accounts.period_name,
                                     p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                     p_company_id               => v_exp_report_dists.company_id,
                                     p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                     p_account_id               => v_exp_report_accounts.account_id,
                                     p_currency_code            => v_exp_report_accounts.currency_code,
                                     p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                     p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                     p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                     p_entered_amount_dr        => v_exp_report_accounts.entered_amount_dr,
                                     p_functional_amount_dr     => v_exp_report_accounts.functional_amount_dr,
                                     p_entered_amount_cr        => '',
                                     p_functional_amount_cr     => '',
                                     p_user_id                  => p_user_id,
                                     p_gld_interface_flag       => 'N',
                                     p_usage_code               => 'EMPLOYEE_EXPENSE');
        
          -----------------------------------------------------------------------------------------------------------
          -- 增值税修改  update  by robin 2016-04-14
        
          v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
          v_entered_amount_dr_tax     := nvl(v_exp_report_dists.tax_amount,
                                             0);
          v_functional_amount_dr_tax  := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                               p_amount                  => v_entered_amount_dr_tax,
                                                               p_batch_id                => p_batch_id,
                                                               p_company_id              => v_header_company_id,
                                                               p_exchange_rate_type      => v_exchange_rate_type,
                                                               p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                               p_exchange_rate           => v_exchange_rate,
                                                               p_standard_currency       => v_standard_currency);
        
          --启用条件：行发票类型是专票
          IF v_exp_report_dists.line_invoice_type != '20' AND
             v_exp_report_dists.line_invoice_type != '70' THEN
            --取进项税科目
            acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                        p_user_id    => p_user_id);
            --根据营改增使用的用途代码，失效相应的参数，这里只保留单据类型ID
            acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => NULL, --v_employee_id,
                                                                   p_expense_user_group_id  => NULL, --v_expense_user_group_id,
                                                                   p_expense_report_type_id => v_expense_report_type_id,
                                                                   p_currency_code          => NULL, --v_exp_report_dists.currency_code, 
                                                                   p_expense_item_id        => NULL, --v_exp_report_dists.expense_item_id,   跳过选择费用科目
                                                                   p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                                   p_period_comparison      => NULL, --v_period_comparison,
                                                                   p_employee_type_id       => NULL, --v_employee_type_id,
                                                                   p_org_unit               => NULL, --v_exp_report_dists.unit_id
                                                                   --add by Qu yuanyuan
                                                                   p_du_id => NULL --v_exp_report_dists.dimension6_id
                                                                   );
          
            v_tax_account_id := acc_builder_employee_exp_pkg.get_account;
            IF v_tax_account_id = -1 THEN
              CLOSE cur_line;
              RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
            END IF;
          
            insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                       p_exp_report_header_id     => p_exp_rep_header_id,
                                       p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                       p_description              => v_exp_account_desc,
                                       p_journal_date             => p_journal_date,
                                       p_period_name              => v_exp_report_accounts.period_name,
                                       p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                       p_company_id               => v_exp_report_dists.company_id,
                                       p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                       p_account_id               => v_tax_account_id,
                                       p_currency_code            => v_exp_report_accounts.currency_code,
                                       p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                       p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                       p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                       p_entered_amount_dr        => v_entered_amount_dr_tax, --税额
                                       p_functional_amount_dr     => v_functional_amount_dr_tax,
                                       p_entered_amount_cr        => '',
                                       p_functional_amount_cr     => '',
                                       p_user_id                  => p_user_id,
                                       p_gld_interface_flag       => 'N',
                                       p_usage_code               => 'EMPLOYEE_EXPENSE');
          END IF;
          --------------------------------------------end -------------------------------------------------------------                         
        
        END IF;
      
        ----------------借方 2 -------------
        -- 摘要 取报销单头说明
        --v_exp_account_desc := v_rep_header_desc;
        v_exp_account_desc := v_exp_report_dists.description;
      
        acc_builder_emp_company_ar_pkg.set_process_id(p_company_id => v_header_company_id,
                                                      p_user_id    => p_user_id);
        acc_builder_emp_company_ar_pkg.create_mapping_conditions(p_company_id             => v_exp_report_dists.company_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => v_exp_report_dists.currency_code,
                                                                 p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id);
      
        v_exp_report_accounts.account_id := acc_builder_emp_company_ar_pkg.get_account;
        IF v_exp_report_accounts.account_id = -1 THEN
          CLOSE cur_line;
          RETURN 'EXP5140_GET_INTERCOMPANY_AR_ACC_ERROR';
        END IF;
      
        --取默认责任中心
        v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
        IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
          CLOSE cur_line;
          RETURN 'EXP5140_RESP_CENTER_ERROR';
        END IF;
      
        v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        v_exp_report_accounts.entered_amount_dr     := v_exp_report_dists.report_amount;
        v_exp_report_accounts.functional_amount_dr  := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                             p_amount                  => v_exp_report_accounts.entered_amount_dr,
                                                                             p_batch_id                => p_batch_id,
                                                                             p_company_id              => v_exp_report_dists.company_id,
                                                                             p_exchange_rate_type      => v_exchange_rate_type,
                                                                             p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                             p_exchange_rate           => v_exchange_rate,
                                                                             p_standard_currency       => v_standard_currency);
      
        v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
        v_exp_report_accounts.exchange_rate      := v_exchange_rate;
        v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
      
        insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                   p_exp_report_header_id     => p_exp_rep_header_id,
                                   p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                   p_description              => v_exp_account_desc,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                   p_company_id               => v_header_company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_exp_report_accounts.account_id,
                                   p_currency_code            => v_exp_report_accounts.currency_code,
                                   p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                   p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                   p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                   p_entered_amount_dr        => v_exp_report_accounts.entered_amount_dr,
                                   p_functional_amount_dr     => v_exp_report_accounts.functional_amount_dr,
                                   p_entered_amount_cr        => '',
                                   p_functional_amount_cr     => '',
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'INTERCOMPANY_AR');
      
        v_exp_account_desc := v_exp_report_dists.description;
      
        acc_builder_emp_company_ap_pkg.set_process_id(v_exp_report_dists.company_id,
                                                      p_user_id);
        acc_builder_emp_company_ap_pkg.create_mapping_conditions(p_company_id             => v_header_company_id,
                                                                 p_expense_report_type_id => v_expense_report_type_id,
                                                                 p_currency_code          => v_exp_report_dists.currency_code,
                                                                 p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                                 p_expense_type_id        => v_exp_report_dists.expense_type_id);
      
        v_exp_report_accounts.account_id := acc_builder_emp_company_ap_pkg.get_account;
        IF v_exp_report_accounts.account_id = -1 THEN
          CLOSE cur_line;
          RETURN 'EXP5140_GET_INTERCOMPANY_AP_ACC_ERROR';
        END IF;
        v_exp_report_accounts.company_id               := v_exp_report_dists.company_id;
        v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_exp_report_accounts.company_id);
        IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
          CLOSE cur_line;
          RETURN 'EXP5140_RESP_CENTER_ERROR';
        END IF;
      
        v_exp_report_accounts.entered_amount_cr := v_exp_report_dists.report_amount;
      
        v_exp_report_accounts.functional_amount_cr := get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                            p_amount                  => v_exp_report_accounts.entered_amount_cr,
                                                                            p_batch_id                => p_batch_id,
                                                                            p_company_id              => v_exp_report_accounts.company_id,
                                                                            p_exchange_rate_type      => v_exchange_rate_type,
                                                                            p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                            p_exchange_rate           => v_exchange_rate,
                                                                            p_standard_currency       => v_standard_currency);
      
        v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
        v_exp_report_accounts.exchange_rate      := v_exchange_rate;
        v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;
      
        v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
        insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                   p_exp_report_header_id     => p_exp_rep_header_id,
                                   p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                   p_description              => v_exp_account_desc,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                   p_company_id               => v_exp_report_accounts.company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_exp_report_accounts.account_id,
                                   p_currency_code            => v_exp_report_accounts.currency_code,
                                   p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                   p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                   p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                   p_entered_amount_dr        => '',
                                   p_functional_amount_dr     => '',
                                   p_entered_amount_cr        => v_exp_report_accounts.entered_amount_cr,
                                   p_functional_amount_cr     => v_exp_report_accounts.functional_amount_cr,
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'INTERCOMPANY_AP');
      
      END IF;
    
    END LOOP;
    CLOSE cur_line;
  
    SELECT COUNT(1)
      INTO v_pmt_length
      FROM exp_report_pmt_schedules ps, exp_report_headers h
     WHERE ps.exp_report_header_id = h.exp_report_header_id
       AND h.exp_report_header_id = p_exp_rep_header_id;
  
    --从计划付款行中创建贷方凭证，科目EMPLOYEE_EXPENSE_CLEARING
    FOR c_pmt_schedules IN (SELECT ps.*, h.currency_code
                              FROM exp_report_pmt_schedules ps,
                                   exp_report_headers       h
                             WHERE ps.exp_report_header_id =
                                   h.exp_report_header_id
                               AND h.exp_report_header_id =
                                   p_exp_rep_header_id) LOOP
    
      v_pmt_count := v_pmt_count + 1;
    
      --删除当前计划付款行生成的贷方凭证
      DELETE FROM exp_report_accounts a
       WHERE a.payment_schedule_line_id =
             c_pmt_schedules.payment_schedule_line_id;
    
      v_exp_account_desc := c_pmt_schedules.description;
      v_partner_type_id  := get_partner_type_id(p_partner_category => c_pmt_schedules.payee_category,
                                                p_company_id       => c_pmt_schedules.company_id,
                                                p_partner_id       => c_pmt_schedules.payee_id);
    
      acc_builder_exp_clearing_pkg.set_process_id(v_header_company_id,
                                                  p_user_id);
      --获取付款用途id
      SELECT cpu.usedes_id
        INTO v_usedes_id
        FROM csh_payment_usedes cpu
       WHERE cpu.usedes_code = c_pmt_schedules.usedes;
    
      acc_builder_exp_clearing_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                             p_expense_user_group_id  => v_expense_user_group_id,
                                                             p_expense_report_type_id => v_expense_report_type_id,
                                                             p_currency_code          => v_exp_report_accounts.currency_code,
                                                             p_employee_type_id       => v_employee_type_id,
                                                             p_partner_category       => c_pmt_schedules.payee_category,
                                                             p_partner_type_id        => v_partner_type_id,
                                                             p_partner_id             => c_pmt_schedules.payee_id,
                                                             p_usedes_id              => v_usedes_id);
    
      v_exp_report_accounts.account_id := acc_builder_exp_clearing_pkg.get_account;
      IF v_exp_report_accounts.account_id = -1 THEN
        RETURN 'EXP5140_GET_EXP_CLE_ACC_ERROR';
      END IF;
      --v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
      v_exp_report_accounts.responsibility_center_id := v_exp_report_dists.responsibility_center_id;
      IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
        RETURN 'EXP5140_RESP_CENTER_ERROR';
      END IF;
    
      v_exp_report_accounts.entered_amount_cr := c_pmt_schedules.due_amount;
    
      --Date:2014年7月28日17:05:39
      --Author:ZhouHao
      --Purpose:原报销单贷方金额会根据报销单借方金额调整最后一行贷方的本币金额，避免出现尾差，该逻辑在报销单支付的时候会出现付款凭证与应付凭证金额存在差异的情况，
      --目前修改为报销单的借方的本币金额根据贷方的本币金额调整尾差，避免出现支付存在金额匹配不上的问题
      --------G
      v_exp_report_accounts.functional_amount_cr := get_functional_amount(p_currency_code           => c_pmt_schedules.currency_code,
                                                                          p_amount                  => v_exp_report_accounts.entered_amount_cr,
                                                                          p_batch_id                => p_batch_id,
                                                                          p_company_id              => v_header_company_id,
                                                                          p_exchange_rate_type      => v_exchange_rate_type,
                                                                          p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                          p_exchange_rate           => v_exchange_rate,
                                                                          p_standard_currency       => v_standard_currency);
    
      v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
      v_exp_report_accounts.exchange_rate      := v_exchange_rate;
      v_exp_report_accounts.currency_code      := c_pmt_schedules.currency_code;
      /*from here
      select *
        into v_exp_header
        from exp_report_headers h
       where h.exp_report_header_id = c_pmt_schedules.exp_report_header_id;
      
      v_exp_report_accounts.exchange_rate_type := v_exp_header.exchange_rate_type;
      v_exp_report_accounts.exchange_rate      := v_exp_header.exchange_rate;
      v_exp_report_accounts.currency_code := c_pmt_schedules.currency_code;
      
      if v_exp_report_accounts.exchange_rate_type = 'DIRECT QUOTATION' then
        v_functional_amount := v_exp_report_accounts.entered_amount_cr *
                               v_exp_report_accounts.exchange_rate;
      elsif v_exp_report_accounts.exchange_rate_type = 'INDIRECT QUOTATION' then
        v_functional_amount := v_exp_report_accounts.entered_amount_cr *
                               (1 / v_exp_report_accounts.exchange_rate);
      else
        v_functional_amount := v_exp_report_accounts.entered_amount_cr *
                               v_exp_report_accounts.exchange_rate;
      end if;
      
      v_exp_report_accounts.functional_amount_cr := fnd_format_mask_pkg.get_gld_amount(p_currency_code   => gld_common_pkg.get_company_currency_code(p_company_id => v_exp_header.company_id),
                                                                                       p_amount          => v_functional_amount,
                                                                                       p_set_of_books_id => gld_common_pkg.get_set_of_books_id(p_comany_id => v_exp_header.company_id));
      *end here*/
      v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
      insert_exp_report_accounts_c(p_payment_schedule_line_id => c_pmt_schedules.payment_schedule_line_id,
                                   p_exp_report_header_id     => p_exp_rep_header_id,
                                   p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                   p_description              => v_exp_account_desc,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => 'EXPENSE_REPORT_AUDIT',
                                   p_company_id               => v_header_company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_exp_report_accounts.account_id,
                                   p_currency_code            => v_exp_report_accounts.currency_code,
                                   p_exchange_rate_type       => v_exp_report_accounts.exchange_rate_type,
                                   p_exchange_rate_quotation  => v_exp_report_accounts.exchange_rate_quotation,
                                   p_exchange_rate            => v_exp_report_accounts.exchange_rate,
                                   p_entered_amount_dr        => '',
                                   p_functional_amount_dr     => '',
                                   p_entered_amount_cr        => v_exp_report_accounts.entered_amount_cr,
                                   p_functional_amount_cr     => v_exp_report_accounts.functional_amount_cr,
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'EMPLOYEE_EXPENSE_CLEARING');
    
    END LOOP;
  
    --Date:2014年7月28日17:27:04
    --Author:Zhouhao
    --Purpose:报销单凭证生成后，根据报销单借方[EXPLOYEE_EXPENSE]金额总和和报销单贷方[EMPLOYEE_EXPENSE_CLEARING]金额总和的差调整报销单借方金额最大的那行的
    --本币金额
    SELECT (nvl((SELECT SUM(a1.functional_amount_dr)
                  FROM exp_report_accounts a1
                 WHERE a1.exp_report_header_id = p_exp_rep_header_id
                   AND a1.usage_code = 'EMPLOYEE_EXPENSE'),
                0) +
           --Date:2014年10月11日15:27:17
           --Author:ZhouHao
           --Purpose:税金部分可能为空，导致计算差额的时候会导致adjust_amount为null，后面update的时候更新报销单凭证上的本币金额为null
           nvl((SELECT SUM(a1.functional_amount_dr)
                  FROM exp_report_accounts a1
                 WHERE a1.exp_report_header_id = p_exp_rep_header_id
                   AND a1.usage_code = 'EMPLOYEE_EXPENSE_TAX'),
                0)) -
           nvl((SELECT SUM(a1.functional_amount_cr)
                 FROM exp_report_accounts a1
                WHERE a1.exp_report_header_id = p_exp_rep_header_id
                  AND a1.usage_code = 'EMPLOYEE_EXPENSE_CLEARING'),
               0)
      INTO v_adjust_amount
      FROM dual;
  
    SELECT d1.exp_report_dists_id
      INTO v_adjust_exp_dists_id
      FROM exp_report_dists d1, exp_report_lines l1
     WHERE l1.exp_report_header_id = p_exp_rep_header_id
       AND l1.exp_report_line_id = d1.exp_report_line_id
       AND d1.report_functional_amount =
           (SELECT MAX(d2.report_functional_amount)
              FROM exp_report_lines l2, exp_report_dists d2
             WHERE d2.exp_report_line_id = l2.exp_report_line_id
               AND l2.exp_report_header_id = p_exp_rep_header_id)
       AND rownum = 1;
  
    UPDATE exp_report_accounts a
       SET a.functional_amount_dr = a.functional_amount_dr - v_adjust_amount,
           a.functional_amount_cr = a.functional_amount_cr - v_adjust_amount
     WHERE a.exp_report_dists_id = v_adjust_exp_dists_id
       AND a.usage_code = 'EMPLOYEE_EXPENSE';
  
    /*************************************************
    -- Author  : MOUSE
    -- Created : 2015年11月25日10:00:16
    -- Ver     : 1.1
    -- Purpose : 报销单类型如果为托收，那么报销单贷方科目取托收科目对应的银行科目
    **************************************************/
    SELECT t.document_page_type
      INTO v_page_type
      FROM exp_report_headers h, exp_expense_report_types t
     WHERE h.exp_report_header_id = p_exp_rep_header_id
       AND h.exp_report_type_id = t.expense_report_type_id;
  
    IF v_page_type = 'COLLECTION' THEN
    
      FOR pmt_lns IN (SELECT s.payment_schedule_line_id,
                             ga.account_id,
                             ga.account_code
                        FROM exp_report_pmt_schedules s,
                             csh_bank_accounts        a,
                             gld_accounts             ga
                       WHERE s.exp_report_header_id = p_exp_rep_header_id
                         AND s.collection_account_id = a.bank_account_id
                         AND a.cash_account_id = ga.account_id) LOOP
      
        FOR account IN (SELECT *
                          FROM exp_report_accounts a
                         WHERE a.payment_schedule_line_id =
                               pmt_lns.payment_schedule_line_id) LOOP
          UPDATE exp_report_accounts a
             SET a.account_id       = pmt_lns.account_id,
                 a.account_segment3 = pmt_lns.account_code
           WHERE a.exp_report_je_line_id = account.exp_report_je_line_id;
        
          UPDATE gl_account_entry e
             SET e.account_id   = pmt_lns.account_id,
                 e.account_code = pmt_lns.account_code,
                 e.segment3     = pmt_lns.account_code
           WHERE e.transaction_type = 'EXP_REPORT'
             AND e.transaction_je_line_id = account.exp_report_je_line_id;
        
          gl_log_pkg.log(p_log_text => '托收报销单贷方凭证，从计付行托收账户带出，凭证行ID为：' ||
                                       account.exp_report_je_line_id ||
                                       '，科目ID为：' || pmt_lns.account_id ||
                                       '，科目代码为:' || pmt_lns.account_code,
                         p_user_id  => p_user_id);
        END LOOP;
      END LOOP;
    END IF;
  
    /*************************************************/
  
    RETURN NULL;
  END create_exp_report_accounts;

  --获取期间第一天
  FUNCTION get_period_first_date(p_company_id  NUMBER,
                                 p_period_name VARCHAR2) RETURN DATE IS
  
    v_first_date DATE;
  BEGIN
    SELECT v.start_date
      INTO v_first_date
      FROM gld_periods v
     WHERE v.adjustment_flag = 'N'
       AND v.period_set_code =
           (SELECT b.period_set_code
              FROM gld_set_of_books b
             WHERE b.set_of_books_id =
                   gld_common_pkg.get_set_of_books_id(p_company_id))
       AND v.period_name = p_period_name;
    RETURN v_first_date;
  
  EXCEPTION
    WHEN no_data_found THEN
      RETURN NULL;
  END get_period_first_date;

  --待摊
  FUNCTION create_exp_amortization_acc(p_exp_report_header_id NUMBER,
                                       p_user_id              NUMBER)
    RETURN VARCHAR2 IS
    CURSOR cur_dists IS
      SELECT d.currency_code,
             d.expense_item_id,
             d.expense_type_id,
             d.company_id            dist_company_id,
             d.period_name,
             d.exp_report_dists_id,
             h.company_id            header_company_id,
             h.employee_id           header_employee_id,
             h.expense_user_group_id,
             h.exp_report_type_id,
             d.unit_id,
             d.dimension6_id
        FROM exp_report_dists d, exp_report_lines l, exp_report_headers h
       WHERE d.exp_report_line_id = l.exp_report_line_id
         AND l.exp_report_header_id = h.exp_report_header_id
         AND l.exp_report_header_id = p_exp_report_header_id
         AND EXISTS
       (SELECT *
                FROM exp_report_accounts a, exp_amortization_accounts ea
               WHERE a.exp_report_dists_id = d.exp_report_dists_id
                 AND a.entered_amount_dr IS NOT NULL --待摊科目只在借方
                 AND a.account_id = ea.account_id
                 AND ea.enabled_flag = 'Y'
                 AND ea.set_of_books_id =
                     gld_common_pkg.get_set_of_books_id(d.company_id));
    v_dists cur_dists%ROWTYPE;
  
    CURSOR cur_amortization_acc(p_exp_report_dists_id NUMBER) IS
      SELECT a.exp_report_je_line_id
        FROM exp_report_accounts a, exp_amortization_accounts ea
       WHERE a.exp_report_dists_id = p_exp_report_dists_id
         AND a.entered_amount_dr IS NOT NULL --待摊科目只在借方
         AND a.account_id = ea.account_id
         AND ea.enabled_flag = 'Y'
         AND ea.set_of_books_id =
             gld_common_pkg.get_set_of_books_id(a.company_id);
  
    v_first_date            DATE;
    v_employee_type_id      NUMBER;
    v_account_id            NUMBER;
    v_segment2              VARCHAR2(200);
    v_segment3              VARCHAR2(200);
    v_exp_report_je_line_id NUMBER;
    v_segment6              VARCHAR2(200);
    v_segment7              VARCHAR2(200);
  BEGIN
    OPEN cur_dists;
    LOOP
      FETCH cur_dists
        INTO v_dists;
      EXIT WHEN cur_dists%NOTFOUND;
      v_first_date := get_period_first_date(p_company_id  => v_dists.dist_company_id,
                                            p_period_name => v_dists.period_name);
    
      --找到待摊科目
      OPEN cur_amortization_acc(v_dists.exp_report_dists_id);
      LOOP
        FETCH cur_amortization_acc
          INTO v_exp_report_je_line_id;
        EXIT WHEN cur_amortization_acc%NOTFOUND;
      
        --借方科目
        v_employee_type_id := get_employee_type_id(v_dists.header_employee_id);
        acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_dists.header_company_id,
                                                    p_user_id    => p_user_id);
        acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => v_dists.header_employee_id,
                                                               p_expense_user_group_id  => v_dists.expense_user_group_id,
                                                               p_expense_report_type_id => v_dists.exp_report_type_id,
                                                               p_currency_code          => v_dists.currency_code,
                                                               p_expense_item_id        => v_dists.expense_item_id,
                                                               p_expense_type_id        => v_dists.expense_type_id,
                                                               p_period_comparison      => 'IN',
                                                               p_employee_type_id       => v_employee_type_id,
                                                               p_org_unit               => v_dists.unit_id,
                                                               --add by Qu yuanyuan
                                                               p_du_id => v_dists.dimension6_id);
      
        v_account_id := acc_builder_employee_exp_pkg.get_account;
        IF v_account_id = -1 THEN
          CLOSE cur_amortization_acc;
          CLOSE cur_dists;
          RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
        END IF;
      
        SELECT a.account_code
          INTO v_segment3
          FROM gld_accounts a
         WHERE a.account_id = v_account_id;
      
        SELECT nvl((SELECT fc.responsibility_center_code
                     FROM fnd_responsibility_centers fc
                    WHERE fc.responsibility_center_id =
                          d.responsibility_center_id),
                   'NULL'),
               nvl((SELECT dv.dimension_value_code
                     FROM fnd_dimension_values dv
                    WHERE dv.dimension_value_id = d.dimension2_id),
                   'NULL'),
               nvl((SELECT dv.dimension_value_code
                     FROM fnd_dimension_values dv
                    WHERE dv.dimension_value_id = d.dimension3_id),
                   'NULL')
          INTO v_segment2, v_segment6, v_segment7
          FROM exp_report_dists d, exp_report_accounts a
         WHERE d.exp_report_dists_id = a.exp_report_dists_id
           AND a.exp_report_je_line_id = v_exp_report_je_line_id;
      
        INSERT INTO exp_report_accounts
          (exp_report_dists_id,
           exp_report_je_line_id,
           description,
           journal_date,
           period_name,
           source_code,
           company_id,
           company_segment,
           responsibility_center_id,
           account_id,
           account_segment1,
           account_segment2,
           account_segment3,
           account_segment4,
           account_segment5,
           account_segment6,
           account_segment7,
           account_segment8,
           account_segment9,
           account_segment10,
           account_segment11,
           account_segment12,
           account_segment13,
           account_segment14,
           account_segment15,
           account_segment16,
           account_segment17,
           account_segment18,
           account_segment19,
           account_segment20,
           dimension1_id,
           dimension2_id,
           dimension3_id,
           dimension4_id,
           dimension5_id,
           dimension6_id,
           dimension7_id,
           dimension8_id,
           dimension9_id,
           dimension10_id,
           currency_code,
           exchange_rate_type,
           exchange_rate_quotation,
           exchange_rate,
           entered_amount_dr,
           entered_amount_cr,
           functional_amount_dr,
           functional_amount_cr,
           gld_interface_flag,
           created_by,
           creation_date,
           last_updated_by,
           last_update_date,
           exp_report_header_id,
           usage_code)
          SELECT exp_report_dists_id,
                 get_exp_report_je_line_id,
                 description,
                 v_first_date,
                 v_dists.period_name,
                 source_code,
                 company_id,
                 company_segment,
                 responsibility_center_id,
                 v_account_id,
                 account_segment1,
                 v_segment2,
                 v_segment3,
                 account_segment4,
                 account_segment5,
                 v_segment6,
                 v_segment7,
                 account_segment8,
                 account_segment9,
                 account_segment10,
                 account_segment11,
                 account_segment12,
                 account_segment13,
                 account_segment14,
                 account_segment15,
                 account_segment16,
                 account_segment17,
                 account_segment18,
                 account_segment19,
                 account_segment20,
                 dimension1_id,
                 dimension2_id,
                 dimension3_id,
                 dimension4_id,
                 dimension5_id,
                 dimension6_id,
                 dimension7_id,
                 dimension8_id,
                 dimension9_id,
                 dimension10_id,
                 currency_code,
                 exchange_rate_type,
                 exchange_rate_quotation,
                 exchange_rate,
                 entered_amount_dr,
                 entered_amount_cr,
                 functional_amount_dr,
                 functional_amount_cr,
                 gld_interface_flag,
                 p_user_id,
                 SYSDATE,
                 p_user_id,
                 SYSDATE,
                 er.exp_report_header_id,
                 'EXPENSE_AMORTIZATION_DR' -- 20181115修改 'EXPENSE_AMORTIZATION_DR'
            FROM exp_report_accounts er
           WHERE er.exp_report_je_line_id = v_exp_report_je_line_id;
      
        update exp_report_accounts t
           set (t.account_segment3,
                t.account_segment4,
                t.account_segment5,
                t.account_segment6,
                t.account_segment7,
                t.account_segment8,
                t.account_segment9,
                t.account_segment10,
                t.account_segment11,
                t.account_segment12,
                t.account_segment13,
                t.account_segment14,
                t.account_segment15,
                t.account_segment16,
                t.account_segment17,
                t.account_segment18,
                t.account_segment19,
                t.account_segment20) =
               (select a.account_segment3,
                       a.account_segment4,
                       a.account_segment5,
                       a.account_segment6,
                       a.account_segment7,
                       a.account_segment8,
                       a.account_segment9,
                       a.account_segment10,
                       a.account_segment11,
                       a.account_segment12,
                       a.account_segment13,
                       a.account_segment14,
                       a.account_segment15,
                       a.account_segment16,
                       a.account_segment17,
                       a.account_segment18,
                       a.account_segment19,
                       a.account_segment20
                  from exp_report_accounts a
                 where a.exp_report_header_id = p_exp_report_header_id
                   and a.account_id = t.account_id
                   and a.usage_code = 'EMPLOYEE_EXPENSE'
                   and rownum = 1)
        
         where t.usage_code = 'EXPENSE_AMORTIZATION_DR'
           and t.exp_report_header_id = p_exp_report_header_id;
      
        --贷方科目
        INSERT INTO exp_report_accounts
          (exp_report_dists_id,
           exp_report_je_line_id,
           description,
           journal_date,
           period_name,
           source_code,
           company_id,
           company_segment,
           responsibility_center_id,
           account_id,
           account_segment1,
           account_segment2,
           account_segment3,
           account_segment4,
           account_segment5,
           account_segment6,
           account_segment7,
           account_segment8,
           account_segment9,
           account_segment10,
           account_segment11,
           account_segment12,
           account_segment13,
           account_segment14,
           account_segment15,
           account_segment16,
           account_segment17,
           account_segment18,
           account_segment19,
           account_segment20,
           dimension1_id,
           dimension2_id,
           dimension3_id,
           dimension4_id,
           dimension5_id,
           dimension6_id,
           dimension7_id,
           dimension8_id,
           dimension9_id,
           dimension10_id,
           currency_code,
           exchange_rate_type,
           exchange_rate_quotation,
           exchange_rate,
           entered_amount_dr,
           entered_amount_cr,
           functional_amount_dr,
           functional_amount_cr,
           gld_interface_flag,
           created_by,
           creation_date,
           last_updated_by,
           last_update_date,
           exp_report_header_id,
           usage_code)
          SELECT exp_report_dists_id,
                 get_exp_report_je_line_id,
                 description,
                 v_first_date,
                 v_dists.period_name,
                 source_code,
                 company_id,
                 company_segment,
                 responsibility_center_id,
                 account_id,
                 account_segment1,
                 account_segment2,
                 account_segment3,
                 account_segment4,
                 account_segment5,
                 --摊销凭证产品段赋值为0
                 'NULL',
                 --摊销凭证渠道段赋值为0
                 'NULL',
                 account_segment8,
                 account_segment9,
                 account_segment10,
                 account_segment11,
                 account_segment12,
                 account_segment13,
                 account_segment14,
                 account_segment15,
                 account_segment16,
                 account_segment17,
                 account_segment18,
                 account_segment19,
                 account_segment20,
                 dimension1_id,
                 dimension2_id,
                 dimension3_id,
                 dimension4_id,
                 dimension5_id,
                 dimension6_id,
                 dimension7_id,
                 dimension8_id,
                 dimension9_id,
                 dimension10_id,
                 currency_code,
                 exchange_rate_type,
                 exchange_rate_quotation,
                 exchange_rate,
                 '', --entered_amount_dr,
                 entered_amount_dr, --entered_amount_cr,
                 '', --functional_amount_dr,
                 functional_amount_dr, --functional_amount_cr,
                 gld_interface_flag,
                 p_user_id,
                 SYSDATE,
                 p_user_id,
                 SYSDATE,
                 er.exp_report_header_id,
                 'EXPENSE_AMORTIZATION_CR'
            FROM exp_report_accounts er
           WHERE er.exp_report_je_line_id = v_exp_report_je_line_id;
      
        --更新原凭证行产品段渠道段段值为0
        UPDATE exp_report_accounts a
           SET a.account_segment6 = 'NULL', a.account_segment7 = 'NULL'
         WHERE a.exp_report_je_line_id = v_exp_report_je_line_id;
      
        EXIT; --目前待摊科目只当做存在一条处理
      END LOOP;
      CLOSE cur_amortization_acc;
    
    END LOOP;
    CLOSE cur_dists;
    RETURN NULL;
  END create_exp_amortization_acc;

  --开始创建报销凭证
  PROCEDURE create_expense_report_account(p_batch_id     NUMBER,
                                          p_journal_date DATE,
                                          p_company_id   NUMBER,
                                          p_user_id      NUMBER,
                                          p_wfl_flag     VARCHAR DEFAULT NULL) IS
    v_count                NUMBER;
    v_write_off_je_line_id NUMBER;
    v_account_id           NUMBER;
    v_err_code             sys_messages.message_code%TYPE;
  
    v_period_name          exp_report_accounts.period_name%TYPE;
    v_exp_report_header_id exp_report_headers.exp_report_header_id%TYPE;
    v_exp_report_number    exp_report_headers.exp_report_number%TYPE;
    v_amortization_flag    exp_report_headers.amortization_flag%TYPE;
  
    CURSOR cur_headers IS
      SELECT h.exp_report_header_id,
             h.exp_report_number,
             t.amortization_flag
        FROM exp_report_headers h, exp_report_accounts_tmp t
       WHERE t.expense_report_header_id = h.exp_report_header_id
         AND t.batch_id = p_batch_id
         AND h.report_status IN ('COMPLETELY_APPROVED',
                                 decode(p_wfl_flag, 'Y', 'SUBMITTED', NULL),
                                 'REJECTED') --已全部审批
         AND (h.audit_flag IS NULL OR h.audit_flag = 'N');
  
    e_need_exchange_rate    EXCEPTION;
    e_create_accounts_error EXCEPTION;
  BEGIN
    g_batch_id := p_batch_id;
    g_user_id  := p_user_id;
    delete_error_log;
  
    SELECT COUNT(1)
      INTO v_count
      FROM exp_currency_code_tmp t
     WHERE (t.exchange_rate IS NULL OR t.exchange_rate_quotation IS NULL)
       AND t.batch_id = p_batch_id
       AND t.currency_code <>
           gld_common_pkg.get_company_currency_code(p_company_id);
    IF v_count > 0 THEN
      RAISE e_need_exchange_rate;
    END IF;
  
    v_period_name := gld_common_pkg.get_gld_period_name(p_company_id => p_company_id,
                                                        p_date       => p_journal_date);
  
    OPEN cur_headers;
    LOOP
      FETCH cur_headers
        INTO v_exp_report_header_id,
             v_exp_report_number,
             v_amortization_flag;
      EXIT WHEN cur_headers%NOTFOUND;
    
      g_exp_report_number   := v_exp_report_number;
      g_operation_code      := 'AUDIT';
      g_line_number         := '';
      g_exp_report_dists_id := '';
    
      BEGIN
        --锁定记录
        SELECT exp_report_header_id
          INTO v_exp_report_header_id
          FROM exp_report_headers h
         WHERE h.exp_report_header_id = v_exp_report_header_id
           AND h.report_status IN ('COMPLETELY_APPROVED',
                                   decode(p_wfl_flag, 'Y', 'SUBMITTED', NULL),
                                   'REJECTED')
           AND (h.audit_flag IS NULL OR h.audit_flag = 'N')
           FOR UPDATE NOWAIT;
      
        /*  v_err_code := create_exp_report_accounts(p_exp_rep_header_id => v_exp_report_header_id,
        p_journal_date      => p_journal_date,
        p_user_id           => p_user_id,
        p_batch_id          => p_batch_id,
        p_period_name       => v_period_name);*/
        /*v_err_code := create_er_accounts_wlzq(p_exp_rep_header_id => v_exp_report_header_id,
        p_journal_date      => p_journal_date,
        p_user_id           => p_user_id,
        p_batch_id          => p_batch_id,
        p_period_name       => v_period_name);*/
      
        v_err_code := create_er_accounts_grcx(p_exp_rep_header_id => v_exp_report_header_id,
                                              p_journal_date      => p_journal_date,
                                              p_user_id           => p_user_id,
                                              p_batch_id          => p_batch_id,
                                              p_period_name       => v_period_name);
      
        IF v_err_code IS NULL THEN
          --IF v_amortization_flag = 'Y' THEN
          --待摊
          v_err_code := create_exp_amortization_acc(p_exp_report_header_id => v_exp_report_header_id,
                                                    p_user_id              => p_user_id);
          --END IF;
        END IF;
      
        IF v_err_code IS NULL THEN
          UPDATE exp_report_headers t
             SET t.je_creation_status = 'SUCCESS',
                 t.last_updated_by    = p_user_id,
                 t.last_update_date   = SYSDATE,
                 t.amortization_flag  = v_amortization_flag
           WHERE t.exp_report_header_id = v_exp_report_header_id;
        
          UPDATE exp_report_accounts_tmp t
             SET t.success_flag = 'Y'
           WHERE t.batch_id = p_batch_id
             AND t.expense_report_header_id = v_exp_report_header_id;
          --commit;
        
        ELSE
          error_log(sys_message_pkg.get_string(v_err_code));
          RAISE e_create_accounts_error;
        END IF;
      
        --创建报销单历史
        /*insert_exp_document_histories(p_document_type  => c_exp_report,
        p_document_id    => v_exp_report_header_id,
        p_operation_code => exp_document_history_pkg.c_create_je, --'CREATE_JE',
        p_user_id        => p_user_id,
        p_operation_time => SYSDATE,
        p_description    => '');*/
      
        BEGIN
          SELECT t.account_id
            INTO v_account_id
            FROM exp_report_accounts t
           WHERE t.exp_report_header_id = v_exp_report_header_id
             AND t.functional_amount_cr IS NOT NULL;
        
          SELECT cwoa.write_off_je_line_id
            INTO v_write_off_je_line_id
            FROM csh_write_off_accounts cwoa
           WHERE cwoa.write_off_je_line_id =
                 (SELECT cwoa.write_off_je_line_id
                    FROM csh_write_off_accounts cwoa
                   WHERE cwoa.write_off_id =
                         (SELECT cwo.write_off_id
                            FROM csh_write_off cwo
                           WHERE cwo.document_line_id =
                                 (SELECT erps.payment_schedule_line_id
                                    FROM exp_report_pmt_schedules erps
                                   WHERE erps.payment_schedule_line_id =
                                         (SELECT era.payment_schedule_line_id
                                            FROM exp_report_accounts era
                                           WHERE era.exp_report_je_line_id =
                                                 (SELECT tmp.exp_report_je_line_id
                                                    FROM exp_report_accounts tmp
                                                   WHERE tmp.exp_report_header_id =
                                                         v_exp_report_header_id
                                                     AND tmp.functional_amount_cr IS NOT NULL)
                                             AND era.functional_amount_cr IS NOT NULL)))
                     AND cwoa.functional_amount_dr IS NOT NULL);
        
          IF v_write_off_je_line_id IS NOT NULL AND
             v_account_id IS NOT NULL THEN
            UPDATE csh_write_off_accounts cwoa
               SET cwoa.account_id = v_account_id
             WHERE cwoa.write_off_je_line_id = v_write_off_je_line_id
               AND cwoa.functional_amount_dr IS NOT NULL;
          END IF;
        
        EXCEPTION
          WHEN OTHERS THEN
            NULL;
        END;
      
      EXCEPTION
        WHEN no_data_found THEN
          NULL;
        WHEN e_lock_table THEN
          error_log(sys_message_pkg.get_string('EXP5140_CONCURRENT_ERROR'));
      END;
    
    END LOOP;
    CLOSE cur_headers;
  
  EXCEPTION
    WHEN e_create_accounts_error THEN
      IF cur_headers%ISOPEN THEN
        CLOSE cur_headers;
      END IF;
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => v_err_code,
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'create_expense_report_account');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_need_exchange_rate THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP5140_NEED_EXCHANGE_RATE',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'create_expense_report_account');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      IF cur_headers%ISOPEN THEN
        CLOSE cur_headers;
      END IF;
    
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'create_expense_report_account');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END create_expense_report_account;

  --删除报销凭证(复核)
  PROCEDURE delete_exp_report_rec_accounts(p_exp_report_header_id NUMBER,
                                           p_user_id              NUMBER) IS
    v_exp_report_header_id NUMBER;
  BEGIN
    SELECT exp_report_header_id
      INTO v_exp_report_header_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id
       AND h.report_status = 'COMPLETELY_APPROVED'
       AND h.audit_flag = 'R'
       FOR UPDATE NOWAIT;
  
    UPDATE exp_report_headers h
       SET h.je_creation_status = 'N', h.audit_flag = 'N'
     WHERE h.exp_report_header_id = p_exp_report_header_id;
  
    /*DELETE FROM exp_report_accounts a
    WHERE a.exp_report_dists_id IN
          (SELECT exp_report_dists_id
             FROM exp_report_dists d
            WHERE d.exp_report_line_id IN
                  (SELECT l.exp_report_line_id
                     FROM exp_report_lines l
                    WHERE l.exp_report_header_id = p_exp_report_header_id));*/
  
    DELETE FROM exp_report_accounts a
     WHERE a.exp_report_header_id = p_exp_report_header_id;
    --创建报销单历史
    insert_exp_document_histories(p_document_type  => c_exp_report,
                                  p_document_id    => p_exp_report_header_id,
                                  p_operation_code => exp_document_history_pkg.c_delete_je, --'DELETE_JE',
                                  p_user_id        => p_user_id,
                                  p_operation_time => SYSDATE,
                                  p_description    => '');
  EXCEPTION
    WHEN no_data_found THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_DELETE_ACCOUNT_STATUS_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'EXP_REPORT_PKG',
                                                      p_procedure_function_name => 'DELETE_EXP_REPORT_ACCOUNTS');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END;

  --删除报销凭证
  PROCEDURE delete_exp_report_accounts(p_exp_report_header_id NUMBER,
                                       p_user_id              NUMBER) IS
    v_exp_report_header_id NUMBER;
  BEGIN
    SELECT exp_report_header_id
      INTO v_exp_report_header_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id
       AND h.report_status = 'COMPLETELY_APPROVED'
       AND h.audit_flag = 'N'
       FOR UPDATE NOWAIT;
  
    UPDATE exp_report_headers h
       SET h.je_creation_status = 'N'
     WHERE h.exp_report_header_id = p_exp_report_header_id;
  
    DELETE FROM exp_report_accounts a
     WHERE a.exp_report_header_id = p_exp_report_header_id;
    --创建报销单历史
    insert_exp_document_histories(p_document_type  => c_exp_report,
                                  p_document_id    => p_exp_report_header_id,
                                  p_operation_code => exp_document_history_pkg.c_delete_je, --'DELETE_JE',
                                  p_user_id        => p_user_id,
                                  p_operation_time => SYSDATE,
                                  p_description    => '');
  EXCEPTION
    WHEN no_data_found THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_DELETE_ACCOUNT_STATUS_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'EXP_REPORT_PKG',
                                                      p_procedure_function_name => 'DELETE_EXP_REPORT_ACCOUNTS');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END;

  /*PROCEDURE delete_exp_report_rec_accounts(p_exp_report_header_id NUMBER,
                                       p_user_id              NUMBER) IS
    v_exp_report_header_id NUMBER;
  BEGIN
    SELECT exp_report_header_id
      INTO v_exp_report_header_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id
       AND h.report_status = 'COMPLETELY_APPROVED'
       AND h.audit_flag = 'N'
       FOR UPDATE NOWAIT;
  
    UPDATE exp_report_headers h
       SET h.je_creation_status = 'N'
     WHERE h.exp_report_header_id = p_exp_report_header_id;
  
    \*DELETE FROM exp_report_accounts a
    WHERE a.exp_report_dists_id IN
          (SELECT exp_report_dists_id
             FROM exp_report_dists d
            WHERE d.exp_report_line_id IN
                  (SELECT l.exp_report_line_id
                     FROM exp_report_lines l
                    WHERE l.exp_report_header_id = p_exp_report_header_id));*\
  
    DELETE FROM exp_report_accounts a
     WHERE a.exp_report_header_id = p_exp_report_header_id;
    --创建报销单历史
    insert_exp_document_histories(p_document_type  => c_exp_report,
                                  p_document_id    => p_exp_report_header_id,
                                  p_operation_code => exp_document_history_pkg.c_delete_je, --'DELETE_JE',
                                  p_user_id        => p_user_id,
                                  p_operation_time => SYSDATE,
                                  p_description    => '');
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_CODING_RULE_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'EXP_REPORT_PKG',
                                                      p_procedure_function_name => 'DELETE_EXP_REPORT_ACCOUNTS');
  
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END;*/

  PROCEDURE reverse_exp_rep_pay_accounts(p_old_report_schedule_id NUMBER,
                                         p_new_report_schedule_id NUMBER,
                                         p_new_head_id            NUMBER,
                                         p_old_report_head_id     NUMBER,
                                         p_user_id                NUMBER,
                                         p_period_name            VARCHAR2,
                                         p_reverse_date           DATE) IS
    CURSOR cur_accounts IS
      SELECT *
        FROM exp_report_accounts a
       WHERE a.payment_schedule_line_id = p_old_report_schedule_id
         AND a.exp_report_header_id = p_old_report_head_id
       ORDER BY a.exp_report_je_line_id;
    v_exp_report_accounts   exp_report_accounts%ROWTYPE;
    v_exp_report_je_line_id exp_report_accounts.exp_report_je_line_id%TYPE;
  
    v_reverse_period_name         VARCHAR2(30);
    v_reverse_date                DATE;
    v_internal_period_num         NUMBER;
    v_reverse_internal_period_num NUMBER;
  
  BEGIN
  
    OPEN cur_accounts;
    LOOP
      FETCH cur_accounts
        INTO v_exp_report_accounts;
      EXIT WHEN cur_accounts%NOTFOUND;
    
      --Modify By Alan Lee for Mantis 0026606, 2009-10-09
      --原凭证期间
      v_internal_period_num := gld_common_pkg.get_gld_internal_period_num(p_company_id  => v_exp_report_accounts.company_id,
                                                                          p_period_name => v_exp_report_accounts.period_name);
    
      --反冲期间
      v_reverse_internal_period_num := gld_common_pkg.get_gld_internal_period_num(p_company_id  => v_exp_report_accounts.company_id,
                                                                                  p_period_name => p_period_name);
    
      --当原凭证期间>反冲期间时， 反冲凭证取“原凭证期间”
      IF v_internal_period_num > v_reverse_internal_period_num THEN
        v_reverse_period_name := v_exp_report_accounts.period_name;
        v_reverse_date        := v_exp_report_accounts.journal_date;
      ELSIF v_internal_period_num <= v_reverse_internal_period_num THEN
        --当原凭证期间<=反冲期间时，反冲凭证取“反冲期间”；
        v_reverse_period_name := p_period_name;
        v_reverse_date        := p_reverse_date;
      END IF;
    
      v_exp_report_je_line_id := exp_report_pkg.get_exp_report_je_line_id;
    
      INSERT INTO exp_report_accounts
        (exp_report_dists_id,
         exp_report_je_line_id,
         description,
         journal_date,
         period_name,
         source_code,
         company_id,
         company_segment,
         responsibility_center_id,
         account_id,
         account_segment1,
         account_segment2,
         account_segment3,
         account_segment4,
         account_segment5,
         account_segment6,
         account_segment7,
         account_segment8,
         account_segment9,
         account_segment10,
         account_segment11,
         account_segment12,
         account_segment13,
         account_segment14,
         account_segment15,
         account_segment16,
         account_segment17,
         account_segment18,
         account_segment19,
         account_segment20,
         dimension1_id,
         dimension2_id,
         dimension3_id,
         dimension4_id,
         dimension5_id,
         dimension6_id,
         dimension7_id,
         dimension8_id,
         dimension9_id,
         dimension10_id,
         currency_code,
         exchange_rate_type,
         exchange_rate_quotation,
         exchange_rate,
         entered_amount_dr,
         entered_amount_cr,
         functional_amount_dr,
         functional_amount_cr,
         gld_interface_flag,
         created_by,
         creation_date,
         last_updated_by,
         last_update_date,
         usage_code,
         payment_schedule_line_id,
         exp_report_header_id)
      VALUES
        ('',
         v_exp_report_je_line_id, --EXP_REPORT_JE_LINE_ID
         v_exp_report_accounts.description,
         v_reverse_date, --JOURNAL_DATE              ,
         v_reverse_period_name, --PERIOD_NAME
         v_exp_report_accounts.source_code,
         v_exp_report_accounts.company_id,
         v_exp_report_accounts.company_segment,
         v_exp_report_accounts.responsibility_center_id,
         v_exp_report_accounts.account_id,
         v_exp_report_accounts.account_segment1,
         v_exp_report_accounts.account_segment2,
         v_exp_report_accounts.account_segment3,
         v_exp_report_accounts.account_segment4,
         v_exp_report_accounts.account_segment5,
         v_exp_report_accounts.account_segment6,
         v_exp_report_accounts.account_segment7,
         v_exp_report_accounts.account_segment8,
         v_exp_report_accounts.account_segment9,
         v_exp_report_accounts.account_segment10,
         v_exp_report_accounts.account_segment11,
         v_exp_report_accounts.account_segment12,
         v_exp_report_accounts.account_segment13,
         v_exp_report_accounts.account_segment14,
         v_exp_report_accounts.account_segment15,
         v_exp_report_accounts.account_segment16,
         v_exp_report_accounts.account_segment17,
         v_exp_report_accounts.account_segment18,
         v_exp_report_accounts.account_segment19,
         v_exp_report_accounts.account_segment20,
         v_exp_report_accounts.dimension1_id,
         v_exp_report_accounts.dimension2_id,
         v_exp_report_accounts.dimension3_id,
         v_exp_report_accounts.dimension4_id,
         v_exp_report_accounts.dimension5_id,
         v_exp_report_accounts.dimension6_id,
         v_exp_report_accounts.dimension7_id,
         v_exp_report_accounts.dimension8_id,
         v_exp_report_accounts.dimension9_id,
         v_exp_report_accounts.dimension10_id,
         v_exp_report_accounts.currency_code,
         v_exp_report_accounts.exchange_rate_type,
         v_exp_report_accounts.exchange_rate_quotation,
         v_exp_report_accounts.exchange_rate,
         -v_exp_report_accounts.entered_amount_dr,
         -v_exp_report_accounts.entered_amount_cr,
         -v_exp_report_accounts.functional_amount_dr,
         -v_exp_report_accounts.functional_amount_cr,
         'P', --GLD_INTERFACE_FLAG
         p_user_id,
         SYSDATE,
         p_user_id,
         SYSDATE,
         v_exp_report_accounts.usage_code,
         p_new_report_schedule_id,
         p_new_head_id);
    
      --反冲生成凭证后，调用预置事件
      exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_CREATE_ACCOUNTS_RESERVE',
                                      p_document_id      => p_new_report_schedule_id,
                                      p_document_line_id => v_exp_report_je_line_id,
                                      p_source_module    => c_exp_report,
                                      p_event_type       => 'EXP_REPORT_CREATE_ACCOUNTS_RESERVE',
                                      p_user_id          => p_user_id);
    END LOOP;
    CLOSE cur_accounts;
  END reverse_exp_rep_pay_accounts;

  PROCEDURE reverse_exp_report_accounts(p_old_report_dists_id NUMBER,
                                        p_new_report_dists_id NUMBER,
                                        p_new_head_id         NUMBER,
                                        p_old_report_head_id  NUMBER,
                                        p_user_id             NUMBER,
                                        p_period_name         VARCHAR2,
                                        p_reverse_date        DATE) IS
  
    --Modify By ldd，修改借方凭证生成时插入头id
    CURSOR cur_accounts IS
      SELECT *
        FROM exp_report_accounts a
       WHERE a.exp_report_dists_id = p_old_report_dists_id
         AND a.exp_report_header_id = p_old_report_head_id
       ORDER BY a.exp_report_je_line_id;
    v_exp_report_accounts   exp_report_accounts%ROWTYPE;
    v_exp_report_je_line_id exp_report_accounts.exp_report_je_line_id%TYPE;
  
    v_reverse_period_name         VARCHAR2(30);
    v_reverse_date                DATE;
    v_internal_period_num         NUMBER;
    v_reverse_internal_period_num NUMBER;
  
  BEGIN
  
    OPEN cur_accounts;
    LOOP
      FETCH cur_accounts
        INTO v_exp_report_accounts;
      EXIT WHEN cur_accounts%NOTFOUND;
    
      --Modify By Alan Lee for Mantis 0026606, 2009-10-09
      --原凭证期间
      v_internal_period_num := gld_common_pkg.get_gld_internal_period_num(p_company_id  => v_exp_report_accounts.company_id,
                                                                          p_period_name => v_exp_report_accounts.period_name);
    
      --反冲期间
      v_reverse_internal_period_num := gld_common_pkg.get_gld_internal_period_num(p_company_id  => v_exp_report_accounts.company_id,
                                                                                  p_period_name => p_period_name);
    
      --当原凭证期间>反冲期间时， 反冲凭证取“原凭证期间”
      IF v_internal_period_num > v_reverse_internal_period_num THEN
        v_reverse_period_name := v_exp_report_accounts.period_name;
        v_reverse_date        := v_exp_report_accounts.journal_date;
      ELSIF v_internal_period_num <= v_reverse_internal_period_num THEN
        --当原凭证期间<=反冲期间时，反冲凭证取“反冲期间”；
        v_reverse_period_name := p_period_name;
        v_reverse_date        := p_reverse_date;
      END IF;
    
      v_exp_report_je_line_id := exp_report_pkg.get_exp_report_je_line_id;
    
      INSERT INTO exp_report_accounts
        (exp_report_dists_id,
         exp_report_je_line_id,
         description,
         journal_date,
         period_name,
         source_code,
         company_id,
         company_segment,
         responsibility_center_id,
         account_id,
         account_segment1,
         account_segment2,
         account_segment3,
         account_segment4,
         account_segment5,
         account_segment6,
         account_segment7,
         account_segment8,
         account_segment9,
         account_segment10,
         account_segment11,
         account_segment12,
         account_segment13,
         account_segment14,
         account_segment15,
         account_segment16,
         account_segment17,
         account_segment18,
         account_segment19,
         account_segment20,
         dimension1_id,
         dimension2_id,
         dimension3_id,
         dimension4_id,
         dimension5_id,
         dimension6_id,
         dimension7_id,
         dimension8_id,
         dimension9_id,
         dimension10_id,
         currency_code,
         exchange_rate_type,
         exchange_rate_quotation,
         exchange_rate,
         entered_amount_dr,
         entered_amount_cr,
         functional_amount_dr,
         functional_amount_cr,
         gld_interface_flag,
         created_by,
         creation_date,
         last_updated_by,
         last_update_date,
         usage_code,
         exp_report_header_id,
         je_category_code)
      VALUES
        (p_new_report_dists_id,
         v_exp_report_je_line_id, --EXP_REPORT_JE_LINE_ID
         v_exp_report_accounts.description,
         v_reverse_date, --JOURNAL_DATE              ,
         v_reverse_period_name, --PERIOD_NAME
         v_exp_report_accounts.source_code,
         v_exp_report_accounts.company_id,
         v_exp_report_accounts.company_segment,
         v_exp_report_accounts.responsibility_center_id,
         v_exp_report_accounts.account_id,
         v_exp_report_accounts.account_segment1,
         v_exp_report_accounts.account_segment2,
         v_exp_report_accounts.account_segment3,
         v_exp_report_accounts.account_segment4,
         v_exp_report_accounts.account_segment5,
         v_exp_report_accounts.account_segment6,
         v_exp_report_accounts.account_segment7,
         v_exp_report_accounts.account_segment8,
         v_exp_report_accounts.account_segment9,
         v_exp_report_accounts.account_segment10,
         v_exp_report_accounts.account_segment11,
         v_exp_report_accounts.account_segment12,
         v_exp_report_accounts.account_segment13,
         v_exp_report_accounts.account_segment14,
         v_exp_report_accounts.account_segment15,
         v_exp_report_accounts.account_segment16,
         v_exp_report_accounts.account_segment17,
         v_exp_report_accounts.account_segment18,
         v_exp_report_accounts.account_segment19,
         v_exp_report_accounts.account_segment20,
         v_exp_report_accounts.dimension1_id,
         v_exp_report_accounts.dimension2_id,
         v_exp_report_accounts.dimension3_id,
         v_exp_report_accounts.dimension4_id,
         v_exp_report_accounts.dimension5_id,
         v_exp_report_accounts.dimension6_id,
         v_exp_report_accounts.dimension7_id,
         v_exp_report_accounts.dimension8_id,
         v_exp_report_accounts.dimension9_id,
         v_exp_report_accounts.dimension10_id,
         v_exp_report_accounts.currency_code,
         v_exp_report_accounts.exchange_rate_type,
         v_exp_report_accounts.exchange_rate_quotation,
         v_exp_report_accounts.exchange_rate,
         -v_exp_report_accounts.entered_amount_dr,
         -v_exp_report_accounts.entered_amount_cr,
         -v_exp_report_accounts.functional_amount_dr,
         -v_exp_report_accounts.functional_amount_cr,
         'P', --GLD_INTERFACE_FLAG
         p_user_id,
         SYSDATE,
         p_user_id,
         SYSDATE,
         v_exp_report_accounts.usage_code,
         p_new_head_id,
         v_exp_report_accounts.je_category_code);
    
      --反冲生成凭证后，调用预置事件
      exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_CREATE_ACCOUNTS_RESERVE',
                                      p_document_id      => p_new_report_dists_id,
                                      p_document_line_id => v_exp_report_je_line_id,
                                      p_source_module    => c_exp_report,
                                      p_event_type       => 'EXP_REPORT_CREATE_ACCOUNTS_RESERVE',
                                      p_user_id          => p_user_id);
    END LOOP;
    CLOSE cur_accounts;
  END reverse_exp_report_accounts;

  PROCEDURE reverse_released_exp_req_dists(p_exp_report_dists_id NUMBER,
                                           p_amount              NUMBER,
                                           p_functional_amount   NUMBER,
                                           p_quantity            NUMBER,
                                           p_user_id             NUMBER) IS
    v_exp_requisition_dist_id NUMBER;
    v_budget_reserve_line_id  NUMBER;
  BEGIN
    SELECT r.exp_requisition_dist_id
      INTO v_exp_requisition_dist_id
      FROM exp_requisition_release r
     WHERE r.document_type = c_exp_report
       AND r.document_dist_id = p_exp_report_dists_id
       AND rownum = 1;
  
    FOR v_req_dists IN (SELECT *
                          FROM exp_requisition_dists d
                         WHERE d.exp_requisition_dists_id =
                               v_exp_requisition_dist_id) LOOP
      IF v_req_dists.budget_item_id IS NOT NULL THEN
        bgt_budget_reserves_pkg.insert_bgt_budget_reserves(p_reserve_company_id        => v_req_dists.company_id,
                                                           p_reserve_operation_unit_id => v_req_dists.operation_unit_id,
                                                           p_bgt_org_id                => bgt_common_pkg.get_bgt_org_id(v_req_dists.company_id),
                                                           p_period_name               => v_req_dists.period_name,
                                                           p_business_type             => 'EXP_REQUISITION',
                                                           p_document_id               => exp_requisition_pkg.get_document_id(v_req_dists.exp_requisition_line_id),
                                                           p_document_line_id          => v_req_dists.exp_requisition_dists_id,
                                                           p_currency                  => v_req_dists.currency_code,
                                                           p_budget_item_id            => v_req_dists.budget_item_id,
                                                           p_responsibility_center_id  => v_req_dists.responsibility_center_id,
                                                           p_exchange_rate_type        => v_req_dists.exchange_rate_type,
                                                           p_exchange_rate_quotation   => v_req_dists.exchange_rate_quotation,
                                                           p_exchange_rate             => v_req_dists.exchange_rate,
                                                           p_amount                    => p_amount,
                                                           p_functional_amount         => p_functional_amount,
                                                           p_quantity                  => p_quantity,
                                                           p_uom                       => v_req_dists.primary_uom,
                                                           p_company_id                => v_req_dists.company_id,
                                                           p_operation_unit_id         => v_req_dists.operation_unit_id,
                                                           p_unit_id                   => v_req_dists.unit_id,
                                                           p_position_id               => v_req_dists.position_id,
                                                           p_employee_id               => v_req_dists.employee_id,
                                                           p_dimension1_id             => v_req_dists.dimension1_id,
                                                           p_dimension2_id             => v_req_dists.dimension2_id,
                                                           p_dimension3_id             => v_req_dists.dimension3_id,
                                                           p_dimension4_id             => v_req_dists.dimension4_id,
                                                           p_dimension5_id             => v_req_dists.dimension5_id,
                                                           p_dimension6_id             => v_req_dists.dimension6_id,
                                                           p_dimension7_id             => v_req_dists.dimension7_id,
                                                           p_dimension8_id             => v_req_dists.dimension8_id,
                                                           p_dimension9_id             => v_req_dists.dimension9_id,
                                                           p_dimension10_id            => v_req_dists.dimension10_id,
                                                           p_created_by                => p_user_id,
                                                           p_budget_reserve_line_id    => v_budget_reserve_line_id,
                                                           p_reserve_flag              => 'R',
                                                           p_status                    => 'P');
      END IF;
    END LOOP;
  
  EXCEPTION
    WHEN no_data_found THEN
      NULL;
  END reverse_released_exp_req_dists;

  --按报销单头id反冲相关的申请单
  PROCEDURE reverse_exp_req_by_header(p_old_rpt_header_id NUMBER,
                                      p_new_rpt_header_id NUMBER,
                                      p_user_id           NUMBER,
                                      p_period_name       VARCHAR2) IS
    --此过程用来处理：exp_requisition_release表中只记下了报销单头id和申请单分配行id的关系时的反冲
  
    v_release_id             NUMBER;
    v_budget_reserve_line_id NUMBER;
  BEGIN
  
    FOR cur_release IN (SELECT *
                          FROM exp_requisition_release r
                         WHERE r.document_type = 'EXP_REPORT'
                           AND r.document_id = p_old_rpt_header_id
                           AND r.document_line_id IS NULL
                           AND r.document_dist_id IS NULL) LOOP
    
      v_release_id := exp_requisitions_release_pkg.get_exp_req_release_id;
      INSERT INTO exp_requisition_release
        (release_id,
         exp_requisition_header_id,
         exp_requisition_line_id,
         exp_requisition_dist_id,
         company_id,
         operation_unit_id,
         document_type,
         document_id,
         document_line_id,
         document_dist_id,
         req_release_amount,
         doc_release_amount,
         req_release_quantity,
         req_release_uom,
         doc_release_quantity,
         doc_release_uom,
         created_by,
         creation_date,
         last_updated_by,
         last_update_date)
      VALUES
        (v_release_id,
         cur_release.exp_requisition_header_id,
         cur_release.exp_requisition_line_id,
         cur_release.exp_requisition_dist_id,
         cur_release.company_id,
         cur_release.operation_unit_id,
         cur_release.document_type,
         p_new_rpt_header_id, --document_id,
         NULL, --document_line_id,
         NULL, --document_dist_id,
         -1 * cur_release.req_release_amount,
         -1 * cur_release.doc_release_amount,
         -1 * cur_release.req_release_quantity,
         cur_release.req_release_uom,
         -1 * cur_release.doc_release_quantity,
         cur_release.doc_release_uom,
         p_user_id,
         SYSDATE,
         p_user_id,
         SYSDATE);
    
      --更新申请单的已的报销金额、已报销数量、报销状态
      exp_requisitions_release_pkg.set_requisition_dists_release(p_exp_requisition_dist_id => cur_release.exp_requisition_dist_id,
                                                                 p_user_id                 => p_user_id);
    
      --生成负数预算保留
      FOR v_budget IN (SELECT *
                         FROM bgt_budget_reserves t
                        WHERE t.business_type = 'EXP_REQUISITION'
                          AND t.document_id =
                              cur_release.exp_requisition_header_id
                          AND t.document_line_id =
                              cur_release.exp_requisition_dist_id
                          AND t.release_id = cur_release.release_id) LOOP
        bgt_budget_reserves_pkg.insert_bgt_budget_reserves(p_reserve_company_id        => v_budget.reserve_company_id,
                                                           p_reserve_operation_unit_id => v_budget.reserve_operation_unit_id,
                                                           p_bgt_org_id                => v_budget.bgt_org_id,
                                                           p_period_name               => /*p_period_name, --*/ v_budget.period_name,
                                                           p_business_type             => v_budget.business_type,
                                                           p_reserve_flag              => v_budget.reserve_flag,
                                                           p_status                    => v_budget.status,
                                                           p_document_id               => v_budget.document_id,
                                                           p_document_line_id          => v_budget.document_line_id,
                                                           p_currency                  => v_budget.currency,
                                                           p_budget_item_id            => v_budget.budget_item_id,
                                                           p_responsibility_center_id  => v_budget.responsibility_center_id,
                                                           p_exchange_rate_type        => v_budget.exchange_rate_type,
                                                           p_exchange_rate_quotation   => v_budget.exchange_rate_quotation,
                                                           p_exchange_rate             => v_budget.exchange_rate,
                                                           p_amount                    => -1 *
                                                                                          v_budget.amount,
                                                           p_functional_amount         => -1 *
                                                                                          v_budget.functional_amount,
                                                           p_quantity                  => -1 *
                                                                                          v_budget.quantity,
                                                           p_uom                       => v_budget.uom,
                                                           p_company_id                => v_budget.company_id,
                                                           p_operation_unit_id         => v_budget.operation_unit_id,
                                                           p_unit_id                   => v_budget.unit_id,
                                                           p_position_id               => v_budget.position_id,
                                                           p_employee_id               => v_budget.employee_id,
                                                           p_dimension1_id             => v_budget.dimension1_id,
                                                           p_dimension2_id             => v_budget.dimension2_id,
                                                           p_dimension3_id             => v_budget.dimension3_id,
                                                           p_dimension4_id             => v_budget.dimension4_id,
                                                           p_dimension5_id             => v_budget.dimension5_id,
                                                           p_dimension6_id             => v_budget.dimension6_id,
                                                           p_dimension7_id             => v_budget.dimension7_id,
                                                           p_dimension8_id             => v_budget.dimension8_id,
                                                           p_dimension9_id             => v_budget.dimension9_id,
                                                           p_dimension10_id            => v_budget.dimension10_id,
                                                           p_created_by                => p_user_id,
                                                           p_release_id                => v_release_id,
                                                           p_budget_reserve_line_id    => v_budget_reserve_line_id,
                                                           p_source_type               => '');
      END LOOP;
    
    END LOOP;
  END reverse_exp_req_by_header;

  --反冲相关的申请单
  PROCEDURE reverse_exp_requisitions(p_old_rpt_header_id NUMBER,
                                     p_old_rpt_line_id   NUMBER,
                                     p_old_rpt_dist_id   NUMBER,
                                     p_new_rpt_header_id NUMBER,
                                     p_new_rpt_line_id   NUMBER,
                                     p_new_rpt_dist_id   NUMBER,
                                     p_user_id           NUMBER,
                                     p_period_name       VARCHAR2) IS
    v_release_id             NUMBER;
    v_budget_reserve_line_id NUMBER;
    v_period_name            VARCHAR2(30);
  BEGIN
    --for mantis :0028970
    --当报销单分配行相关联的报销单申请行状态不为关闭时，才反冲
    FOR cur_release IN (SELECT *
                          FROM exp_requisition_release r
                         WHERE r.document_type = 'EXP_REPORT'
                           AND r.document_id = p_old_rpt_header_id
                           AND r.document_line_id = p_old_rpt_line_id
                           AND r.document_dist_id = p_old_rpt_dist_id
                           AND EXISTS
                         (SELECT 1
                                  FROM exp_requisition_dists qd
                                 WHERE qd.exp_requisition_dists_id =
                                       r.exp_requisition_dist_id
                                   AND nvl(qd.close_flag, 'N') <> 'Y')) LOOP
    
      v_release_id := exp_requisitions_release_pkg.get_exp_req_release_id;
      INSERT INTO exp_requisition_release
        (release_id,
         exp_requisition_header_id,
         exp_requisition_line_id,
         exp_requisition_dist_id,
         company_id,
         operation_unit_id,
         document_type,
         document_id,
         document_line_id,
         document_dist_id,
         req_release_amount,
         doc_release_amount,
         req_release_quantity,
         req_release_uom,
         doc_release_quantity,
         doc_release_uom,
         created_by,
         creation_date,
         last_updated_by,
         last_update_date)
      VALUES
        (v_release_id,
         cur_release.exp_requisition_header_id,
         cur_release.exp_requisition_line_id,
         cur_release.exp_requisition_dist_id,
         cur_release.company_id,
         cur_release.operation_unit_id,
         cur_release.document_type,
         p_new_rpt_header_id, --document_id,
         p_new_rpt_line_id, --document_line_id,
         p_new_rpt_dist_id, --document_dist_id,
         -1 * cur_release.req_release_amount,
         -1 * cur_release.doc_release_amount,
         -1 * cur_release.req_release_quantity,
         cur_release.req_release_uom,
         -1 * cur_release.doc_release_quantity,
         cur_release.doc_release_uom,
         p_user_id,
         SYSDATE,
         p_user_id,
         SYSDATE);
    
      --更新申请单的已的报销金额、已报销数量、报销状态
      exp_requisitions_release_pkg.set_requisition_dists_release(p_exp_requisition_dist_id => cur_release.exp_requisition_dist_id,
                                                                 p_user_id                 => p_user_id);
    
      --生成负数预算保留
      FOR v_budget IN (SELECT *
                         FROM bgt_budget_reserves t
                        WHERE t.business_type = 'EXP_REQUISITION'
                          AND t.document_id =
                              cur_release.exp_requisition_header_id
                          AND t.document_line_id =
                              cur_release.exp_requisition_dist_id
                          AND t.release_id = cur_release.release_id) LOOP
      
        --Mantis:0030639: 通过系统参数去控制报销单反冲时影响预算的期间
        IF sys_parameter_pkg.value('BGT_REVERSE_ORIGINAL_PERIOD',
                                   '',
                                   '',
                                   v_budget.reserve_company_id) = 'Y' THEN
          v_period_name := v_budget.period_name;
        ELSE
          v_period_name := p_period_name;
        END IF;
      
        bgt_budget_reserves_pkg.insert_bgt_budget_reserves(p_reserve_company_id        => v_budget.reserve_company_id,
                                                           p_reserve_operation_unit_id => v_budget.reserve_operation_unit_id,
                                                           p_bgt_org_id                => v_budget.bgt_org_id,
                                                           p_period_name               => v_period_name,
                                                           p_business_type             => v_budget.business_type,
                                                           p_reserve_flag              => v_budget.reserve_flag,
                                                           p_status                    => v_budget.status,
                                                           p_document_id               => v_budget.document_id,
                                                           p_document_line_id          => v_budget.document_line_id,
                                                           p_currency                  => v_budget.currency,
                                                           p_budget_item_id            => v_budget.budget_item_id,
                                                           p_responsibility_center_id  => v_budget.responsibility_center_id,
                                                           p_exchange_rate_type        => v_budget.exchange_rate_type,
                                                           p_exchange_rate_quotation   => v_budget.exchange_rate_quotation,
                                                           p_exchange_rate             => v_budget.exchange_rate,
                                                           p_amount                    => -1 *
                                                                                          v_budget.amount,
                                                           p_functional_amount         => -1 *
                                                                                          v_budget.functional_amount,
                                                           p_quantity                  => -1 *
                                                                                          v_budget.quantity,
                                                           p_uom                       => v_budget.uom,
                                                           p_company_id                => v_budget.company_id,
                                                           p_operation_unit_id         => v_budget.operation_unit_id,
                                                           p_unit_id                   => v_budget.unit_id,
                                                           p_position_id               => v_budget.position_id,
                                                           p_employee_id               => v_budget.employee_id,
                                                           p_dimension1_id             => v_budget.dimension1_id,
                                                           p_dimension2_id             => v_budget.dimension2_id,
                                                           p_dimension3_id             => v_budget.dimension3_id,
                                                           p_dimension4_id             => v_budget.dimension4_id,
                                                           p_dimension5_id             => v_budget.dimension5_id,
                                                           p_dimension6_id             => v_budget.dimension6_id,
                                                           p_dimension7_id             => v_budget.dimension7_id,
                                                           p_dimension8_id             => v_budget.dimension8_id,
                                                           p_dimension9_id             => v_budget.dimension9_id,
                                                           p_dimension10_id            => v_budget.dimension10_id,
                                                           p_created_by                => p_user_id,
                                                           p_release_id                => v_release_id,
                                                           p_budget_reserve_line_id    => v_budget_reserve_line_id,
                                                           p_source_type               => '');
      END LOOP;
    
    END LOOP;
  END reverse_exp_requisitions;

  FUNCTION get_budget_reserve_status(p_exp_report_header_id NUMBER)
    RETURN VARCHAR2 IS
    v_budget_reserve_status VARCHAR2(30);
  BEGIN
    SELECT r.status
      INTO v_budget_reserve_status
      FROM bgt_budget_reserves r
     WHERE r.business_type = c_exp_report
       AND r.document_id = p_exp_report_header_id
       AND rownum = 1;
  
    RETURN v_budget_reserve_status;
  
  END get_budget_reserve_status;

  FUNCTION budget_reserve_exists(p_exp_report_header_id NUMBER)
    RETURN VARCHAR2 IS
    v_exists VARCHAR2(1);
  BEGIN
    SELECT 'Y'
      INTO v_exists
      FROM bgt_budget_reserves r
     WHERE r.business_type = c_exp_report
       AND r.document_id = p_exp_report_header_id
       AND rownum = 1;
    RETURN v_exists;
  EXCEPTION
    WHEN no_data_found THEN
      RETURN 'N';
  END budget_reserve_exists;

  PROCEDURE reverse_exp_report_dists(p_old_report_header_id NUMBER,
                                     p_old_report_line_id   NUMBER,
                                     p_new_report_line_id   NUMBER,
                                     p_reverse_date         DATE,
                                     p_period_name          VARCHAR2,
                                     p_user_id              NUMBER,
                                     p_new_header_id        NUMBER) IS
    CURSOR cur_dists IS
      SELECT *
        FROM exp_report_dists d
       WHERE d.exp_report_line_id = p_old_report_line_id
       ORDER BY d.exp_report_dists_id;
    v_exp_report_dists    exp_report_dists%ROWTYPE;
    v_exp_report_dists_id exp_report_dists.exp_report_dists_id%TYPE;
  
    v_budget_reserve_line_id NUMBER;
    v_budget_reserve_status  VARCHAR2(30);
    v_period_name            VARCHAR2(30);
  BEGIN
    OPEN cur_dists;
    LOOP
      FETCH cur_dists
        INTO v_exp_report_dists;
      EXIT WHEN cur_dists%NOTFOUND;
    
      v_exp_report_dists_id := exp_report_pkg.get_exp_report_dists_id;
      INSERT INTO exp_report_dists
        (exp_report_line_id,
         exp_report_dists_id,
         description,
         period_name,
         currency_code,
         exchange_rate_type,
         exchange_rate_quotation,
         exchange_rate,
         expense_type_id,
         expense_item_id,
         budget_item_id,
         price,
         primary_quantity,
         primary_uom,
         secondary_quantity,
         secondary_uom,
         report_amount,
         report_functional_amount,
         company_id,
         operation_unit_id,
         unit_id,
         position_id,
         responsibility_center_id,
         employee_id,
         payee_category,
         payee_id,
         partner_id,
         payment_flag,
         report_status,
         audit_flag,
         audit_date,
         attachment_num,
         dimension1_id,
         dimension2_id,
         dimension3_id,
         dimension4_id,
         dimension5_id,
         dimension6_id,
         dimension7_id,
         dimension8_id,
         dimension9_id,
         dimension10_id,
         exceed_budget_strategy,
         close_flag,
         close_date,
         created_by,
         creation_date,
         last_updated_by,
         last_update_date,
         tax_amount,
         sale_amount,
         tax_rate,
         used_type,
         input_tax_structure_detail,
         deduction_rules,
         adjusted_full_deductions,
         adjusted_partial_deductions,
         adjustable_tax_deductible,
         invoice_amount,
         invoice_tax_amount,
         associated_oasign)
      VALUES
        (p_new_report_line_id,
         v_exp_report_dists_id,
         v_exp_report_dists.description,
         v_exp_report_dists.period_name,
         v_exp_report_dists.currency_code,
         v_exp_report_dists.exchange_rate_type,
         v_exp_report_dists.exchange_rate_quotation,
         v_exp_report_dists.exchange_rate,
         v_exp_report_dists.expense_type_id,
         v_exp_report_dists.expense_item_id,
         v_exp_report_dists.budget_item_id,
         v_exp_report_dists.price,
         -1 * v_exp_report_dists.primary_quantity,
         v_exp_report_dists.primary_uom,
         v_exp_report_dists.secondary_quantity,
         v_exp_report_dists.secondary_uom,
         -1 * v_exp_report_dists.report_amount,
         -1 * v_exp_report_dists.report_functional_amount,
         v_exp_report_dists.company_id,
         v_exp_report_dists.operation_unit_id,
         v_exp_report_dists.unit_id,
         v_exp_report_dists.position_id,
         v_exp_report_dists.responsibility_center_id,
         v_exp_report_dists.employee_id,
         v_exp_report_dists.payee_category,
         v_exp_report_dists.payee_id,
         v_exp_report_dists.partner_id,
         v_exp_report_dists.payment_flag,
         v_exp_report_dists.report_status,
         v_exp_report_dists.audit_flag,
         p_reverse_date,
         '', --ATTACHMENT_NUM
         v_exp_report_dists.dimension1_id,
         v_exp_report_dists.dimension2_id,
         v_exp_report_dists.dimension3_id,
         v_exp_report_dists.dimension4_id,
         v_exp_report_dists.dimension5_id,
         v_exp_report_dists.dimension6_id,
         v_exp_report_dists.dimension7_id,
         v_exp_report_dists.dimension8_id,
         v_exp_report_dists.dimension9_id,
         v_exp_report_dists.dimension10_id,
         v_exp_report_dists.exceed_budget_strategy,
         v_exp_report_dists.close_flag,
         v_exp_report_dists.close_date,
         p_user_id,
         SYSDATE,
         p_user_id,
         SYSDATE,
         v_exp_report_dists.tax_amount * -1,
         v_exp_report_dists.sale_amount * -1,
         v_exp_report_dists.tax_rate,
         v_exp_report_dists.used_type,
         v_exp_report_dists.input_tax_structure_detail,
         v_exp_report_dists.deduction_rules,
         v_exp_report_dists.adjusted_full_deductions,
         v_exp_report_dists.adjusted_partial_deductions,
         v_exp_report_dists.adjustable_tax_deductible,
         v_exp_report_dists.invoice_amount,
         v_exp_report_dists.invoice_tax_amount,
         v_exp_report_dists.associated_oasign);
    
      --原报销单一条bgt_budget_reserves记录都没有,则反冲报销单也不插bgt_budget_reserves
      IF budget_reserve_exists(p_old_report_header_id) = 'Y' THEN
        --插预算保留表
      
        --Mantis:0030639: 通过系统参数去控制报销单反冲时影响预算的期间
        IF v_exp_report_dists.budget_item_id IS NOT NULL THEN
          IF sys_parameter_pkg.value('BGT_REVERSE_ORIGINAL_PERIOD',
                                     '',
                                     '',
                                     v_exp_report_dists.company_id) = 'Y' THEN
            v_period_name := v_exp_report_dists.period_name;
          ELSE
            v_period_name := p_period_name;
          END IF;
        
          --“调整”类型的报销单不占预算
          --if get_report_tye_adjustment(get_exp_report_type_id(p_new_header_id)) = 'N' then
          v_budget_reserve_status := get_budget_reserve_status(p_old_report_header_id);
          bgt_budget_reserves_pkg.insert_bgt_budget_reserves(p_reserve_company_id        => v_exp_report_dists.company_id,
                                                             p_reserve_operation_unit_id => v_exp_report_dists.operation_unit_id,
                                                             p_bgt_org_id                => bgt_common_pkg.get_bgt_org_id(v_exp_report_dists.company_id),
                                                             p_period_name               => v_period_name,
                                                             p_business_type             => c_exp_report,
                                                             p_document_id               => p_new_header_id,
                                                             p_document_line_id          => v_exp_report_dists_id,
                                                             p_currency                  => v_exp_report_dists.currency_code,
                                                             p_budget_item_id            => v_exp_report_dists.budget_item_id,
                                                             p_responsibility_center_id  => v_exp_report_dists.responsibility_center_id,
                                                             p_exchange_rate_type        => v_exp_report_dists.exchange_rate_type,
                                                             p_exchange_rate_quotation   => v_exp_report_dists.exchange_rate_quotation,
                                                             p_exchange_rate             => v_exp_report_dists.exchange_rate,
                                                             p_amount                    => -1 *
                                                                                            v_exp_report_dists.report_amount,
                                                             p_functional_amount         => -1 *
                                                                                            v_exp_report_dists.report_functional_amount,
                                                             /*p_amount                 => -1 *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              v_exp_report_dists.sale_amount,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  p_functio
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           nal_amount      => -1 *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              v_exp_report_dists.sale_amount,*/
                                                             p_quantity               => -1 *
                                                                                         v_exp_report_dists.primary_quantity,
                                                             p_uom                    => v_exp_report_dists.primary_uom,
                                                             p_company_id             => v_exp_report_dists.company_id,
                                                             p_operation_unit_id      => v_exp_report_dists.operation_unit_id,
                                                             p_unit_id                => v_exp_report_dists.unit_id,
                                                             p_position_id            => v_exp_report_dists.position_id,
                                                             p_employee_id            => v_exp_report_dists.employee_id,
                                                             p_dimension1_id          => v_exp_report_dists.dimension1_id,
                                                             p_dimension2_id          => v_exp_report_dists.dimension2_id,
                                                             p_dimension3_id          => v_exp_report_dists.dimension3_id,
                                                             p_dimension4_id          => v_exp_report_dists.dimension4_id,
                                                             p_dimension5_id          => v_exp_report_dists.dimension5_id,
                                                             p_dimension6_id          => v_exp_report_dists.dimension6_id,
                                                             p_dimension7_id          => v_exp_report_dists.dimension7_id,
                                                             p_dimension8_id          => v_exp_report_dists.dimension8_id,
                                                             p_dimension9_id          => v_exp_report_dists.dimension9_id,
                                                             p_dimension10_id         => v_exp_report_dists.dimension10_id,
                                                             p_created_by             => p_user_id,
                                                             p_budget_reserve_line_id => v_budget_reserve_line_id,
                                                             p_reserve_flag           => 'U',
                                                             p_status                 => v_budget_reserve_status);
          -- end if;
        END IF;
      END IF;
    
      --反冲相关的申请单
      reverse_exp_requisitions(p_old_rpt_header_id => p_old_report_header_id,
                               p_old_rpt_line_id   => p_old_report_line_id,
                               p_old_rpt_dist_id   => v_exp_report_dists.exp_report_dists_id,
                               p_new_rpt_header_id => p_new_header_id,
                               p_new_rpt_line_id   => p_new_report_line_id,
                               p_new_rpt_dist_id   => v_exp_report_dists_id,
                               p_user_id           => p_user_id,
                               p_period_name       => p_period_name);
    
      --若是申请单下达的，则需要插申请单行的预算保留表
      /*reverse_released_exp_req_dists(p_exp_report_dists_id => v_exp_report_dists.exp_report_dists_id,
      p_amount              => v_exp_report_dists.report_amount,
      p_functional_amount   => v_exp_report_dists.report_functional_amount,
      p_quantity            => v_exp_report_dists.primary_quantity,
      p_user_id             => p_user_id);*/
    
      --反冲报销单凭证
      reverse_exp_report_accounts(p_old_report_dists_id => v_exp_report_dists.exp_report_dists_id,
                                  p_new_report_dists_id => v_exp_report_dists_id,
                                  p_new_head_id         => p_new_header_id,
                                  p_old_report_head_id  => p_old_report_header_id,
                                  p_user_id             => p_user_id,
                                  p_period_name         => p_period_name,
                                  p_reverse_date        => p_reverse_date);
    END LOOP;
    CLOSE cur_dists;
  END reverse_exp_report_dists;

  PROCEDURE reverse_exp_report_objects(p_old_header_id NUMBER,
                                       p_new_header_id NUMBER,
                                       p_old_line_id   NUMBER,
                                       p_new_line_id   NUMBER,
                                       p_user_id       NUMBER) IS
  BEGIN
    INSERT INTO exp_report_objects
      (exp_report_header_id,
       exp_report_line_id,
       expense_object_type_id,
       expense_object_id,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date,
       expense_object_desc)
      SELECT p_new_header_id,
             p_new_line_id,
             expense_object_type_id,
             expense_object_id,
             p_user_id,
             SYSDATE,
             p_user_id,
             SYSDATE,
             expense_object_desc
        FROM exp_report_objects o
       WHERE o.exp_report_header_id = p_old_header_id
         AND (o.exp_report_line_id = p_old_line_id OR
             (exp_report_line_id IS NULL AND p_old_line_id IS NULL));
  END reverse_exp_report_objects;

  PROCEDURE reverse_con_contracts_relation(p_old_exp_rpt_header_id NUMBER,
                                           p_old_exp_rpt_line_id   NUMBER,
                                           p_new_exp_rpt_header_id NUMBER,
                                           p_new_exp_rpt_line_id   NUMBER,
                                           p_user_id               NUMBER) IS
  BEGIN
    INSERT INTO con_document_flows
      (document_type,
       document_id,
       document_line_id,
       source_document_type,
       source_document_id,
       source_document_line_id,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date)
      SELECT document_type,
             document_id,
             document_line_id,
             source_document_type,
             p_new_exp_rpt_header_id,
             p_new_exp_rpt_line_id,
             p_user_id,
             SYSDATE,
             p_user_id,
             SYSDATE
        FROM con_document_flows cc
       WHERE cc.document_type = 'CON_CONTRACT'
         AND cc.source_document_type = 'EXP_REPORT_LINES'
         AND cc.source_document_id = p_old_exp_rpt_header_id
         AND cc.source_document_line_id = p_old_exp_rpt_line_id;
  END reverse_con_contracts_relation;

  PROCEDURE reverse_expense_report_lines(p_old_header_id NUMBER,
                                         p_new_header_id NUMBER,
                                         p_user_id       NUMBER,
                                         p_reverse_date  DATE,
                                         p_period_name   VARCHAR2) IS
    CURSOR c_line IS
      SELECT *
        FROM exp_report_lines t
       WHERE t.exp_report_header_id = p_old_header_id
       ORDER BY t.exp_report_line_id;
  
    v_lines                  exp_report_lines%ROWTYPE;
    v_new_exp_report_line_id NUMBER;
  
  BEGIN
    OPEN c_line;
    LOOP
      FETCH c_line
        INTO v_lines;
      EXIT WHEN c_line%NOTFOUND;
    
      v_new_exp_report_line_id := exp_report_pkg.get_exp_report_line_id;
    
      -----插入报销单行
      INSERT INTO exp_report_lines
        (exp_report_header_id,
         exp_report_line_id,
         line_number,
         city,
         description,
         date_from,
         date_to,
         period_name,
         currency_code,
         exchange_rate_type,
         exchange_rate_quotation,
         exchange_rate,
         expense_type_id,
         expense_item_id,
         budget_item_id,
         price,
         primary_quantity,
         primary_uom,
         secondary_quantity,
         secondary_uom,
         report_amount,
         report_functional_amount,
         distribution_set_id,
         company_id,
         operation_unit_id,
         unit_id,
         position_id,
         responsibility_center_id,
         employee_id,
         payee_category,
         payee_id,
         partner_id,
         payment_flag,
         report_status,
         audit_flag,
         audit_date,
         write_off_status,
         write_off_comleted_date,
         attachment_num,
         dimension1_id,
         dimension2_id,
         dimension3_id,
         dimension4_id,
         dimension5_id,
         dimension6_id,
         dimension7_id,
         dimension8_id,
         dimension9_id,
         dimension10_id,
         created_by,
         creation_date,
         last_updated_by,
         last_update_date,
         tax_amount,
         sale_amount,
         tax_rate)
      VALUES
        (p_new_header_id,
         v_new_exp_report_line_id,
         v_lines.line_number,
         v_lines.city,
         v_lines.description,
         v_lines.date_from,
         v_lines.date_to,
         v_lines.period_name,
         v_lines.currency_code,
         v_lines.exchange_rate_type,
         v_lines.exchange_rate_quotation,
         v_lines.exchange_rate,
         v_lines.expense_type_id,
         v_lines.expense_item_id,
         v_lines.budget_item_id,
         v_lines.price,
         -v_lines.primary_quantity,
         v_lines.primary_uom,
         -v_lines.secondary_quantity,
         v_lines.secondary_uom,
         -v_lines.report_amount,
         -v_lines.report_functional_amount,
         v_lines.distribution_set_id,
         v_lines.company_id,
         v_lines.operation_unit_id,
         v_lines.unit_id,
         v_lines.position_id,
         v_lines.responsibility_center_id,
         v_lines.employee_id,
         v_lines.payee_category,
         v_lines.payee_id,
         v_lines.partner_id,
         v_lines.payment_flag,
         v_lines.report_status,
         v_lines.audit_flag,
         p_reverse_date, --AUDIT_DATE     反冲日期
         v_lines.write_off_status,
         v_lines.write_off_comleted_date,
         decode(v_lines.attachment_num, NULL, NULL, 0), --ATTACHMENT_NUM
         v_lines.dimension1_id,
         v_lines.dimension2_id,
         v_lines.dimension3_id,
         v_lines.dimension4_id,
         v_lines.dimension5_id,
         v_lines.dimension6_id,
         v_lines.dimension7_id,
         v_lines.dimension8_id,
         v_lines.dimension9_id,
         v_lines.dimension10_id,
         p_user_id,
         SYSDATE,
         p_user_id,
         SYSDATE,
         v_lines.tax_amount * -1,
         v_lines.sale_amount * -1,
         v_lines.tax_rate);
    
      --反冲分配行
      reverse_exp_report_dists(p_old_report_header_id => p_old_header_id,
                               p_old_report_line_id   => v_lines.exp_report_line_id,
                               p_new_report_line_id   => v_new_exp_report_line_id,
                               p_reverse_date         => p_reverse_date,
                               p_period_name          => p_period_name,
                               p_user_id              => p_user_id,
                               p_new_header_id        => p_new_header_id);
    
      --插入报销单行费用对象
      reverse_exp_report_objects(p_old_header_id => p_old_header_id,
                                 p_new_header_id => p_new_header_id,
                                 p_old_line_id   => v_lines.exp_report_line_id,
                                 p_new_line_id   => v_new_exp_report_line_id,
                                 p_user_id       => p_user_id);
    
      --反冲时，关联合同 Mantis 0027114
      reverse_con_contracts_relation(p_old_exp_rpt_header_id => p_old_header_id,
                                     p_old_exp_rpt_line_id   => v_lines.exp_report_line_id,
                                     p_new_exp_rpt_header_id => p_new_header_id,
                                     p_new_exp_rpt_line_id   => v_new_exp_report_line_id,
                                     p_user_id               => p_user_id);
    
    END LOOP;
    CLOSE c_line;
  END reverse_expense_report_lines;

  PROCEDURE reverse_exp_report_headers(p_old_report_header_id NUMBER,
                                       p_new_report_header_id NUMBER,
                                       p_exp_report_number    VARCHAR2,
                                       p_user_id              NUMBER,
                                       p_reverse_date         DATE,
                                       p_period_name          VARCHAR2) IS
  BEGIN
    INSERT INTO exp_report_headers v
      (exp_report_header_id,
       company_id,
       operation_unit_id,
       exp_report_number,
       exp_report_barcode,
       employee_id,
       position_id,
       unit_id,
       payee_category,
       payee_id,
       exp_report_type_id,
       expense_user_group_id,
       currency_code,
       exchange_rate_type,
       exchange_rate_quotation,
       exchange_rate,
       report_date,
       period_name,
       report_status,
       je_creation_status,
       audit_flag,
       audit_date,
       gld_interface_flag,
       attachment_num,
       description,
       write_off_status,
       write_off_completed_date,
       reversed_flag,
       source_exp_rep_header_id,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date,
       source_type,
       amortization_flag)
      SELECT p_new_report_header_id,
             company_id,
             operation_unit_id,
             p_exp_report_number,
             exp_report_barcode,
             employee_id,
             position_id,
             unit_id,
             payee_category,
             payee_id,
             exp_report_type_id,
             expense_user_group_id,
             currency_code,
             exchange_rate_type,
             exchange_rate_quotation,
             exchange_rate,
             p_reverse_date,
             p_period_name,
             report_status,
             je_creation_status,
             audit_flag,
             p_reverse_date,
             'P', --gld_interface_flag
             decode(t.attachment_num, NULL, NULL, 0), --attachment_num,
             description,
             write_off_status,
             write_off_completed_date,
             'R',
             p_old_report_header_id,
             p_user_id,
             SYSDATE,
             p_user_id,
             SYSDATE,
             source_type,
             t.amortization_flag
        FROM exp_report_headers t
       WHERE t.exp_report_header_id = p_old_report_header_id;
  END reverse_exp_report_headers;

  PROCEDURE reverse_report_pmt_schedules(p_old_report_header_id NUMBER,
                                         p_new_report_header_id NUMBER,
                                         p_user_id              NUMBER,
                                         p_reverse_date         DATE,
                                         p_period_name          VARCHAR2) IS
    v_pmt_schedule_line_id NUMBER;
  BEGIN
    FOR v_pmt_lines IN (SELECT *
                          FROM exp_report_pmt_schedules s
                         WHERE s.exp_report_header_id =
                               p_old_report_header_id) LOOP
      v_pmt_schedule_line_id := exp_report_pkg.get_payment_schedule_line_id;
      INSERT INTO exp_report_pmt_schedules
        (exp_report_header_id,
         payment_schedule_line_id,
         description,
         currency,
         payee_category,
         payee_id,
         account_number,
         account_name,
         payment_type_id,
         schedule_start_date,
         schedule_due_date,
         due_amount,
         created_by,
         creation_date,
         last_updated_by,
         last_update_date,
         company_id,
         schedule_line_number)
      VALUES
        (p_new_report_header_id,
         v_pmt_schedule_line_id,
         v_pmt_lines.description,
         v_pmt_lines.currency,
         v_pmt_lines.payee_category,
         v_pmt_lines.payee_id,
         v_pmt_lines.account_number,
         v_pmt_lines.account_name,
         v_pmt_lines.payment_type_id,
         v_pmt_lines.schedule_start_date,
         v_pmt_lines.schedule_due_date,
         -1 * v_pmt_lines.due_amount,
         p_user_id,
         SYSDATE,
         p_user_id,
         SYSDATE,
         v_pmt_lines.company_id,
         v_pmt_lines.schedule_line_number);
    
      --创建合同关系
      INSERT INTO con_document_flows
        (document_type,
         document_id,
         document_line_id,
         source_document_type,
         source_document_id,
         source_document_line_id,
         created_by,
         creation_date,
         last_updated_by,
         last_update_date)
        SELECT document_type,
               document_id,
               document_line_id,
               source_document_type,
               p_new_report_header_id, -- source_document_id,
               v_pmt_schedule_line_id, --source_document_line_id,
               p_user_id,
               SYSDATE,
               p_user_id,
               SYSDATE
          FROM con_document_flows d
         WHERE d.document_type = 'CON_CONTRACT'
           AND d.source_document_type = 'EXP_REPORT_PMT_SCHEDULES'
           AND d.source_document_id = p_old_report_header_id
           AND d.source_document_line_id =
               v_pmt_lines.payment_schedule_line_id;
    
      --add by ldd 由计划付款行生成贷方凭证
      --反冲报销单凭证
      reverse_exp_rep_pay_accounts(p_old_report_schedule_id => v_pmt_lines.payment_schedule_line_id,
                                   p_new_report_schedule_id => v_pmt_schedule_line_id,
                                   p_new_head_id            => p_new_report_header_id,
                                   p_old_report_head_id     => p_old_report_header_id,
                                   p_user_id                => p_user_id,
                                   p_period_name            => p_period_name,
                                   p_reverse_date           => p_reverse_date);
    END LOOP;
  END reverse_report_pmt_schedules;

  PROCEDURE reverse_report_objects_layouts(p_old_header_id NUMBER,
                                           p_new_header_id NUMBER,
                                           p_user_id       NUMBER) IS
  BEGIN
    INSERT INTO exp_report_objects_layouts
      (exp_report_header_id,
       layout_position,
       layout_priority,
       expense_object_type_id,
       default_object_id,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date)
      SELECT p_new_header_id,
             layout_position,
             layout_priority,
             expense_object_type_id,
             default_object_id,
             p_user_id,
             SYSDATE,
             p_user_id,
             SYSDATE
        FROM exp_report_objects_layouts ol
       WHERE ol.exp_report_header_id = p_old_header_id;
  
  END reverse_report_objects_layouts;

  PROCEDURE reverse_rep_dimension_layouts(p_old_header_id NUMBER,
                                          p_new_header_id NUMBER,
                                          p_user_id       NUMBER) IS
  BEGIN
    INSERT INTO exp_rep_dimension_layouts
      (exp_report_header_id,
       layout_position,
       layout_priority,
       dimension_id,
       default_dim_value_id,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date)
      SELECT p_new_header_id,
             layout_position,
             layout_priority,
             dimension_id,
             default_dim_value_id,
             p_user_id,
             SYSDATE,
             p_user_id,
             SYSDATE
        FROM exp_rep_dimension_layouts d
       WHERE d.exp_report_header_id = p_old_header_id;
  END reverse_rep_dimension_layouts;

  --反冲报销单
  PROCEDURE reverse_expense_report(p_exp_report_header_id NUMBER,
                                   p_reverse_date         DATE,
                                   p_user_id              NUMBER,
                                   p_company_id           NUMBER) IS
    v_period_name           gld_period_status.period_name%TYPE;
    v_reversed_flag         exp_report_headers.reversed_flag%TYPE;
    v_write_off_status      exp_report_headers.write_off_status%TYPE;
    v_exp_report_type_id    exp_report_headers.exp_report_type_id%TYPE;
    v_new_exp_report_number exp_report_headers.exp_report_number%TYPE;
    v_operation_unit_id     exp_report_headers.operation_unit_id%TYPE;
    v_payment_datastatus    VARCHAR2(10);
  
    v_new_exp_report_header_id NUMBER;
  
    e_reverse_date_error     EXCEPTION;
    e_reverse_flag_error     EXCEPTION;
    e_write_off_status_error EXCEPTION;
    e_doc_number_error       EXCEPTION;
    e_pay_sent_error         EXCEPTION;
    e_pay_success_error      EXCEPTION;
    e_pay_error_error        EXCEPTION;
    e_pay_refund_error       EXCEPTION;
  
    v_count NUMBER;
  BEGIN
  
    /*************************************************
    -- Author  : MOUSE
    -- Created : 2015/12/1 22:06:14
    -- Ver     : 1.1
    -- Purpose : 报销单反冲时检查是否存在正在处理中的资金系统接口
    **************************************************/
    FOR pmt_info_lns IN (SELECT *
                           FROM cux_payment_doc_info i
                          WHERE i.document_id = p_exp_report_header_id
                            AND i.document_category = 'EXP_REPORT') LOOP
      IF pmt_info_lns.datastatus = '0' THEN
        --如果当前存在未传送资金的接口数据，备份并删除info和interface数据
        INSERT INTO cux_payment_interface_his h
          SELECT *
            FROM cux_payment_interface pi
           WHERE pi.id = pmt_info_lns.interface_id;
      
        DELETE FROM cux_payment_interface pi
         WHERE pi.id = pmt_info_lns.interface_id;
      
        INSERT INTO cux_payment_doc_info_his
          SELECT *
            FROM cux_payment_doc_info di
           WHERE di.info_id = pmt_info_lns.info_id;
      
        DELETE FROM cux_payment_doc_info di
         WHERE di.info_id = pmt_info_lns.info_id;
      ELSIF pmt_info_lns.datastatus IN ('1', '2', '3') THEN
        --如果当前存在已传送资金的接口数据，但是还未处理，提示错误信息，不允许反冲
        RAISE e_pay_sent_error;
      ELSIF pmt_info_lns.datastatus IN ('4', '7') THEN
        --如果当前存在支付失败，需要提示：支付失败，请先
        RAISE e_pay_error_error;
      ELSIF pmt_info_lns.datastatus = '5' THEN
        --如果当前存在支付成功，需要提示：已支付成功，首先进行付款反冲
        RAISE e_pay_success_error;
      ELSIF pmt_info_lns.datastatus = '7' THEN
        --如果当前存在支付退票，需要提示：支付退票，请先确认支付退票
        RAISE e_pay_refund_error;
      END IF;
    END LOOP;
  
    SELECT t.reversed_flag,
           t.write_off_status,
           t.exp_report_type_id,
           t.operation_unit_id
      INTO v_reversed_flag,
           v_write_off_status,
           v_exp_report_type_id,
           v_operation_unit_id
      FROM exp_report_headers t
     WHERE t.exp_report_header_id = p_exp_report_header_id
       FOR UPDATE NOWAIT;
  
    IF v_reversed_flag IS NOT NULL THEN
      RAISE e_reverse_flag_error;
    END IF;
  
    IF v_write_off_status != 'N' THEN
      RAISE e_write_off_status_error;
    END IF;
  
    v_period_name := gld_common_pkg.get_gld_period_name(p_company_id => p_company_id,
                                                        p_date       => p_reverse_date);
    IF v_period_name IS NULL THEN
      RAISE e_reverse_date_error;
    END IF;
  
    -----插入报销单头
    v_new_exp_report_header_id := exp_report_pkg.get_exp_report_header_id;
    v_new_exp_report_number    := exp_report_pkg.get_exp_report_number(p_document_type     => v_exp_report_type_id,
                                                                       p_company_id        => p_company_id,
                                                                       p_operation_unit_id => v_operation_unit_id,
                                                                       p_operation_date    => p_reverse_date,
                                                                       p_created_by        => p_user_id);
    IF v_new_exp_report_number = fnd_code_rule_pkg.c_error THEN
      RAISE e_doc_number_error;
    END IF;
  
    reverse_exp_report_headers(p_old_report_header_id => p_exp_report_header_id,
                               p_new_report_header_id => v_new_exp_report_header_id,
                               p_exp_report_number    => v_new_exp_report_number,
                               p_user_id              => p_user_id,
                               p_reverse_date         => p_reverse_date,
                               p_period_name          => v_period_name);
  
    ---------反冲行
    reverse_expense_report_lines(p_old_header_id => p_exp_report_header_id,
                                 p_new_header_id => v_new_exp_report_header_id,
                                 p_user_id       => p_user_id,
                                 p_reverse_date  => p_reverse_date,
                                 p_period_name   => v_period_name);
  
    --插入报销单计划付款行
    reverse_report_pmt_schedules(p_old_report_header_id => p_exp_report_header_id,
                                 p_new_report_header_id => v_new_exp_report_header_id,
                                 p_user_id              => p_user_id,
                                 --add by ldd
                                 p_reverse_date => p_reverse_date,
                                 p_period_name  => v_period_name);
  
    --插入报销单头费用对象
    reverse_exp_report_objects(p_old_header_id => p_exp_report_header_id,
                               p_new_header_id => v_new_exp_report_header_id,
                               p_old_line_id   => NULL,
                               p_new_line_id   => NULL,
                               p_user_id       => p_user_id);
  
    --插入报销单费用对象布局
    reverse_report_objects_layouts(p_old_header_id => p_exp_report_header_id,
                                   p_new_header_id => v_new_exp_report_header_id,
                                   p_user_id       => p_user_id);
  
    --插入报销单维度局面
    reverse_rep_dimension_layouts(p_old_header_id => p_exp_report_header_id,
                                  p_new_header_id => v_new_exp_report_header_id,
                                  p_user_id       => p_user_id);
  
    --插入反冲报销单历史
    insert_exp_document_histories(p_document_type  => c_exp_report,
                                  p_document_id    => v_new_exp_report_header_id,
                                  p_operation_code => exp_document_history_pkg.c_generate, --'GENERATE',
                                  p_user_id        => p_user_id,
                                  p_operation_time => SYSDATE,
                                  p_description    => '');
  
    insert_exp_document_histories(p_document_type  => c_exp_report,
                                  p_document_id    => v_new_exp_report_header_id,
                                  p_operation_code => exp_document_history_pkg.c_audit, --'AUDIT',
                                  p_user_id        => p_user_id,
                                  p_operation_time => SYSDATE,
                                  p_description    => '');
  
    --插入被反冲报销单的历史
    insert_exp_document_histories(p_document_type  => c_exp_report,
                                  p_document_id    => p_exp_report_header_id,
                                  p_operation_code => exp_document_history_pkg.c_reverse, --'REVERSED',
                                  p_user_id        => p_user_id,
                                  p_operation_time => SYSDATE,
                                  p_description    => '');
  
    --按报销单头反冲相关申请行
    reverse_exp_req_by_header(p_old_rpt_header_id => p_exp_report_header_id,
                              p_new_rpt_header_id => v_new_exp_report_header_id,
                              p_user_id           => p_user_id,
                              p_period_name       => v_period_name);
  
    UPDATE exp_report_headers t
       SET t.reversed_flag    = 'W',
           t.last_updated_by  = p_user_id,
           t.last_update_date = SYSDATE
     WHERE t.exp_report_header_id = p_exp_report_header_id;
  
    --反冲报销单事件
    exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_REVERSE',
                                    p_document_id      => v_new_exp_report_header_id,
                                    p_document_line_id => '',
                                    p_source_module    => c_exp_report,
                                    p_event_type       => 'EXP_REPORT_REVERSE',
                                    p_user_id          => p_user_id);
  
    -- 万联证券填写来源单据编号
    UPDATE gl_account_entry gae
       SET gae.attribute12 = v_new_exp_report_number
     WHERE gae.transaction_type = 'EXP_REPORT'
       AND gae.transaction_header_id = v_new_exp_report_header_id;
  
    -- 如果未支付,传送状态改为暂挂
    UPDATE gl_account_entry gae
       SET gae.imported_flag = 'G'
     WHERE gae.transaction_type = 'EXP_REPORT'
       AND gae.transaction_header_id = v_new_exp_report_header_id
       AND EXISTS
     (SELECT 1
              FROM gl_account_entry gae
             WHERE gae.transaction_type = 'EXP_REPORT'
               AND gae.transaction_header_id = p_exp_report_header_id
               AND gae.imported_flag = 'G');
  
  EXCEPTION
    WHEN e_pay_sent_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '当前单据已经传送资金接口，请等待资金系统处理完毕！',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'reverse_expense_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_pay_success_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '当前单据已经支付成功，请先反冲付款事务！',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'reverse_expense_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_pay_error_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '当前单据支付失败，请进入《失败数据确认》功能进行确认！',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'reverse_expense_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_pay_refund_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '当前单据已经支付退票，请进入《退票数据确认》功能进行确认！',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'reverse_expense_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    
    WHEN e_doc_number_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_CODING_RULE_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'reverse_expense_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_reverse_date_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP5150_REVERSE_DATE_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'reverse_expense_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_write_off_status_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP5150_WRITE_OFF_STATUS_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'reverse_expense_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_reverse_flag_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP5150_REVERSE_FLAG_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'reverse_expense_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_lock_table THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP5140_CONCURRENT_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'reverse_expense_report');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'reverse_expense_report');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END reverse_expense_report;

  --历史记录
  PROCEDURE insert_exp_document_histories(p_document_type  VARCHAR2,
                                          p_document_id    NUMBER,
                                          p_operation_code VARCHAR2,
                                          p_user_id        NUMBER,
                                          p_operation_time DATE,
                                          p_description    VARCHAR2) IS
  
  BEGIN
    exp_document_history_pkg.insert_exp_document_histories(p_document_type  => p_document_type,
                                                           p_document_id    => p_document_id,
                                                           p_operation_code => p_operation_code,
                                                           p_user_id        => p_user_id,
                                                           p_operation_time => p_operation_time,
                                                           p_description    => p_description);
  END insert_exp_document_histories;

  --报销单，指定申请单分配行
  PROCEDURE create_manual_exp_req_relation(p_exp_req_dist_id    NUMBER,
                                           p_exp_report_line_id NUMBER,
                                           p_user_id            NUMBER) IS
    v_exp_report_dist_id NUMBER;
    v_release_id         NUMBER;
  
    --v_exp_req_header_id number;
    --v_exp_req_line_id   number;
  
    v_report_amount    exp_report_lines.report_amount%TYPE;
    v_primary_quantity exp_report_lines.primary_quantity%TYPE;
    v_primary_uom      exp_report_lines.primary_uom%TYPE;
  BEGIN
    IF p_exp_req_dist_id IS NULL THEN
      RETURN;
    END IF;
  
    SELECT exp_report_dists_id
      INTO v_exp_report_dist_id
      FROM exp_report_dists d
     WHERE d.exp_report_line_id = p_exp_report_line_id;
  
    SELECT l.report_amount, l.primary_quantity, l.primary_uom
      INTO v_report_amount, v_primary_quantity, v_primary_uom
      FROM exp_report_lines l
     WHERE l.exp_report_line_id = p_exp_report_line_id;
  
    exp_requisitions_release_pkg.insert_exp_requisition_release(p_exp_requisition_dist_id => p_exp_req_dist_id,
                                                                p_document_type           => c_exp_report,
                                                                p_document_dist_id        => v_exp_report_dist_id,
                                                                p_req_release_amount      => v_report_amount,
                                                                p_req_release_quantity    => v_primary_quantity,
                                                                p_req_release_uom         => v_primary_uom,
                                                                p_user_id                 => p_user_id,
                                                                p_release_id              => v_release_id);
  
  EXCEPTION
    WHEN too_many_rows THEN
      NULL;
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'create_manual_exp_req_relation');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END create_manual_exp_req_relation;

  --====报销单，指定差旅计划分配行
  --====add by  fanqihua
  --====20150723
  PROCEDURE create_manual_exp_tp_relation(p_exp_tp_dist_id     NUMBER,
                                          p_exp_report_line_id NUMBER,
                                          p_user_id            NUMBER) IS
    v_exp_report_dist_id NUMBER;
    v_release_id         NUMBER;
  
    v_report_amount    exp_report_lines.report_amount%TYPE;
    v_primary_quantity exp_report_lines.primary_quantity%TYPE;
    v_primary_uom      exp_report_lines.primary_uom%TYPE;
  BEGIN
    IF p_exp_tp_dist_id IS NULL THEN
      RETURN;
    END IF;
  
    SELECT exp_report_dists_id
      INTO v_exp_report_dist_id
      FROM exp_report_dists d
     WHERE d.exp_report_line_id = p_exp_report_line_id;
  
    SELECT l.report_amount, l.primary_quantity, l.primary_uom
      INTO v_report_amount, v_primary_quantity, v_primary_uom
      FROM exp_report_lines l
     WHERE l.exp_report_line_id = p_exp_report_line_id;
  
    exp_travel_plan_release_pkg.insert_exp_tp_release(p_exp_tp_dist_id       => p_exp_tp_dist_id,
                                                      p_document_type        => c_exp_report,
                                                      p_document_dist_id     => v_exp_report_dist_id,
                                                      p_req_release_amount   => v_report_amount,
                                                      p_req_release_quantity => v_primary_quantity,
                                                      p_req_release_uom      => v_primary_uom,
                                                      p_user_id              => p_user_id,
                                                      p_release_id           => v_release_id);
  
  EXCEPTION
    WHEN too_many_rows THEN
      NULL;
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'create_manual_exp_tp_relation');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END create_manual_exp_tp_relation;

  /*************************************************
  -- Author  : majianjian
  -- Created : 2015/3/25 10:52:48
  -- Ver     : 1.1
  -- Purpose : 获取差旅计划总的下达数量和下达金额
  **************************************************/
  PROCEDURE get_tra_plan_total_rls_amt_qty(p_travel_plan_header_id IN NUMBER,
                                           p_travel_plan_line_id   IN NUMBER,
                                           p_release_amount        OUT NUMBER,
                                           p_release_quantity      OUT NUMBER) IS
  
  BEGIN
    SELECT nvl(SUM(nvl(l.report_amount, 0)), 0),
           nvl(SUM(nvl(l.primary_quantity, 0)), 0)
      INTO p_release_amount, p_release_quantity
      FROM exp_report_lines l, exp_report_travel_lines tl
     WHERE l.exp_report_line_id = tl.exp_report_line_id
       AND tl.travel_plan_line_id = p_travel_plan_line_id;
  END;

  /*************************************************
  -- Author  : majianjian
  -- Created : 2015/3/25 10:05:28
  -- Ver     : 1.1
  -- Purpose : 差旅计划预算释放
  **************************************************/
  PROCEDURE travel_plan_reserves_release(p_travel_plan_line_id IN NUMBER,
                                         p_exp_report_line_id  IN NUMBER,
                                         p_user_id             IN NUMBER) IS
    v_primary_quantity         NUMBER;
    v_primary_uom              NUMBER;
    v_report_amount            NUMBER;
    v_functional_amount        NUMBER;
    v_period_name              VARCHAR2(30);
    v_travel_plan_line         exp_travel_plan_lines%ROWTYPE;
    v_travel_plan_header       exp_travel_plan_headers%ROWTYPE;
    v_total_release_amount     NUMBER;
    v_total_release_quantity   NUMBER;
    v_current_release_amount   NUMBER;
    v_current_release_quantity NUMBER;
    v_bgt_reserve_amount       NUMBER;
    v_bgt_reserve_quantity     NUMBER;
    v_budget_reserve_line_id   NUMBER;
  BEGIN
    IF p_travel_plan_line_id IS NULL THEN
      RETURN;
    END IF;
  
    SELECT l.*
      INTO v_travel_plan_line
      FROM exp_travel_plan_lines l
     WHERE l.travel_plan_line_id = p_travel_plan_line_id;
  
    SELECT *
      INTO v_travel_plan_header
      FROM exp_travel_plan_headers h
     WHERE h.travel_plan_header_id =
           v_travel_plan_line.travel_plan_header_id;
  
    -- 获取报销单行上的单价、数量、单位信息
    SELECT l.primary_quantity,
           l.primary_uom,
           l.period_name,
           l.report_amount
      INTO v_primary_quantity,
           v_primary_uom,
           v_period_name,
           v_report_amount
      FROM exp_report_lines l
     WHERE l.exp_report_line_id = p_exp_report_line_id;
  
    -- 获取当前差旅计划行总下达数量和下达金额
    get_tra_plan_total_rls_amt_qty(v_travel_plan_header.travel_plan_header_id,
                                   v_travel_plan_line.travel_plan_line_id,
                                   v_total_release_amount,
                                   v_total_release_quantity);
  
    --累计保留表中金额、数量
    exp_travel_plan_pkg.get_budget_reserves_balance(p_travel_plan_header_id => v_travel_plan_header.travel_plan_header_id,
                                                    p_travel_plan_line_id   => v_travel_plan_line.travel_plan_line_id,
                                                    p_release_amount        => v_bgt_reserve_amount,
                                                    p_release_quantity      => v_bgt_reserve_quantity);
    -- 如果总的下达金额不超过行金额，则照常释放，否则，只能释放掉差旅计划预算保留余额。数量同理。
    IF v_total_release_amount <=
       nvl(v_travel_plan_line.head_currency_amount, 0) THEN
      v_current_release_amount := -1 * v_report_amount;
    ELSE
      v_current_release_amount := -1 * v_bgt_reserve_amount;
    END IF;
  
    IF v_total_release_quantity <= nvl(v_travel_plan_line.quantity, 0) THEN
      v_current_release_quantity := -1 * v_primary_quantity;
    ELSE
      v_current_release_quantity := -1 * v_bgt_reserve_quantity;
    END IF;
  
    IF v_travel_plan_header.exchange_rate_quotation = 'DIRECT QUOTATION' THEN
      v_functional_amount := v_current_release_amount *
                             v_travel_plan_header.exchange_rate;
    ELSE
      v_functional_amount := v_current_release_amount /
                             v_travel_plan_header.exchange_rate;
    END IF;
  
    -- 插入负数用来释放差旅计划占用的预算。
    bgt_budget_reserves_pkg.insert_bgt_budget_reserves(p_reserve_company_id        => v_travel_plan_line.company_id,
                                                       p_reserve_operation_unit_id => NULL,
                                                       p_bgt_org_id                => bgt_common_pkg.get_bgt_org_id(v_travel_plan_line.company_id),
                                                       p_period_name               => v_period_name,
                                                       p_business_type             => 'EXP_TRAVEL_PLAN',
                                                       p_reserve_flag              => 'R',
                                                       p_status                    => 'N',
                                                       p_document_id               => v_travel_plan_line.travel_plan_header_id,
                                                       p_document_line_id          => v_travel_plan_line.travel_plan_line_id,
                                                       p_currency                  => v_travel_plan_line.currency_code,
                                                       p_budget_item_id            => v_travel_plan_line.budget_item_id,
                                                       p_responsibility_center_id  => v_travel_plan_line.responsibility_center_id,
                                                       p_exchange_rate_type        => v_travel_plan_header.exchange_rate_type,
                                                       p_exchange_rate_quotation   => v_travel_plan_header.exchange_rate_quotation,
                                                       p_exchange_rate             => v_travel_plan_header.exchange_rate,
                                                       p_amount                    => v_current_release_amount,
                                                       p_functional_amount         => v_functional_amount,
                                                       p_quantity                  => v_current_release_quantity,
                                                       p_uom                       => NULL,
                                                       p_company_id                => v_travel_plan_line.company_id,
                                                       p_operation_unit_id         => NULL,
                                                       p_unit_id                   => v_travel_plan_line.unit_id,
                                                       p_position_id               => v_travel_plan_line.position_id,
                                                       p_employee_id               => v_travel_plan_line.employee_id,
                                                       p_dimension1_id             => v_travel_plan_line.dimension1_id,
                                                       p_dimension2_id             => v_travel_plan_line.dimension2_id,
                                                       p_dimension3_id             => v_travel_plan_line.dimension3_id,
                                                       p_dimension4_id             => v_travel_plan_line.dimension4_id,
                                                       p_dimension5_id             => v_travel_plan_line.dimension5_id,
                                                       p_dimension6_id             => v_travel_plan_line.dimension6_id,
                                                       p_dimension7_id             => v_travel_plan_line.dimension7_id,
                                                       p_dimension8_id             => v_travel_plan_line.dimension8_id,
                                                       p_dimension9_id             => v_travel_plan_line.dimension9_id,
                                                       p_dimension10_id            => v_travel_plan_line.dimension10_id,
                                                       p_created_by                => p_user_id,
                                                       p_release_id                => p_exp_report_line_id,
                                                       p_budget_reserve_line_id    => v_budget_reserve_line_id);
  
  END;

  --报销单核销预付款
  PROCEDURE exp_write_off_prepayment(p_session_id               NUMBER,
                                     p_company_id               NUMBER,
                                     p_exp_pmt_schedule_line_id NUMBER,
                                     p_transaction_header_id    NUMBER,
                                     p_write_off_date           DATE,
                                     p_write_off_amount         NUMBER,
                                     p_user_id                  NUMBER) IS
    v_transaction_class   csh_transaction_headers.transaction_class%TYPE;
    v_transaction_line_id csh_transaction_lines.transaction_line_id%TYPE;
    v_unwrite_off_amounte NUMBER;
    e_amount_over EXCEPTION; --本次核销金额超过了未核销金额
    v_exp_report_header_id NUMBER;
    e_payee_diff EXCEPTION; --付款行和借款行的收款方一致
    v_csh_payee          NUMBER;
    v_exp_payee          NUMBER;
    v_csh_payee_category VARCHAR2(10);
    v_exp_payee_category VARCHAR2(10);
  BEGIN
    -- 报销单核销借款时 判断单据状态
    SELECT erps.exp_report_header_id
      INTO v_exp_report_header_id
      FROM exp_report_pmt_schedules erps
     WHERE erps.payment_schedule_line_id = p_exp_pmt_schedule_line_id;
  
    SELECT transaction_class, l.transaction_line_id
      INTO v_transaction_class, v_transaction_line_id
      FROM csh_transaction_headers h, csh_transaction_lines l
     WHERE h.transaction_header_id = p_transaction_header_id
       AND h.transaction_header_id = l.transaction_header_id;
  
    SELECT p.payee_category, p.payee_id
      INTO v_exp_payee_category, v_exp_payee
      FROM exp_report_pmt_schedules p
     WHERE p.payment_schedule_line_id = p_exp_pmt_schedule_line_id;
  
    SELECT l.partner_category, l.partner_id
      INTO v_csh_payee_category, v_csh_payee
      FROM csh_payment_requisition_lns l
     WHERE l.payment_requisition_line_id =
           (SELECT a.payment_requisition_line_id
              FROM csh_payment_requisition_refs a
             WHERE a.csh_transaction_line_id =
                   (SELECT b.transaction_line_id
                      FROM csh_transaction_lines b
                     WHERE b.transaction_header_id =
                           (SELECT c.source_payment_header_id
                              FROM csh_transaction_headers c
                             WHERE c.transaction_header_id =
                                   (SELECT d.transaction_header_id
                                      FROM csh_transaction_lines d
                                     WHERE d.transaction_line_id =
                                           v_transaction_line_id)))
               AND rownum = 1);
    IF v_exp_payee_category <> v_csh_payee_category OR
       v_exp_payee <> v_csh_payee THEN
      RAISE e_payee_diff;
    END IF;
    --IF write_off_check_status(v_exp_report_header_id, p_user_id) = 'Y' THEN
  
    -- Modified by Rick 2017-5-5 20:02:07
    -- 工作流修改页面核销借款
    IF 'Y' = 'Y' THEN
      SELECT (ctl.transaction_amount -
             (SELECT nvl(SUM(cwo.csh_write_off_amount), 0)
                 FROM csh_write_off cwo
                WHERE cwo.csh_transaction_line_id = ctl.transaction_line_id
                  AND cwo.write_off_type = 'PREPAYMENT_EXPENSE_REPORT') -
             (SELECT nvl(SUM(ctl2.transaction_amount), 0)
                 FROM csh_transaction_headers cth1,
                      csh_transaction_lines   ctl1,
                      csh_transaction_headers cth2,
                      csh_transaction_lines   ctl2
                WHERE ctl1.transaction_line_id = ctl.transaction_line_id
                  AND ctl1.transaction_header_id =
                      cth1.transaction_header_id
                  AND cth2.source_header_id = cth1.transaction_header_id
                  AND cth2.transaction_header_id =
                      ctl2.transaction_header_id
                  AND cth2.reversed_flag IS NULL))
        INTO v_unwrite_off_amounte
        FROM csh_transaction_headers cth, csh_transaction_lines ctl
       WHERE cth.transaction_header_id = ctl.transaction_header_id
         AND cth.transaction_header_id = p_transaction_header_id;
    
      IF v_unwrite_off_amounte < p_write_off_amount THEN
        RAISE e_amount_over;
      END IF;
    
      IF p_write_off_amount <= 0 THEN
        RETURN;
      END IF;
    
      DELETE FROM csh_write_off_tmp t
       WHERE t.session_id = p_session_id
         AND t.write_off_type = 'PREPAYMENT_EXPENSE_REPORT';
    
      csh_write_off_pkg.insert_csh_write_off_tmp(p_session_id                  => p_session_id,
                                                 p_write_off_type              => 'PREPAYMENT_EXPENSE_REPORT',
                                                 p_transaction_class           => v_transaction_class,
                                                 p_payment_requisition_line_id => '',
                                                 p_contract_header_id          => '',
                                                 p_payment_schedule_line_id    => p_exp_pmt_schedule_line_id,
                                                 p_write_off_date              => p_write_off_date,
                                                 p_write_off_amount            => p_write_off_amount,
                                                 p_company_id                  => p_company_id,
                                                 p_document_id                 => p_exp_pmt_schedule_line_id,
                                                 p_user_id                     => p_user_id);
      csh_write_off_pkg.execute_csh_trx_write_off(p_session_id            => p_session_id,
                                                  p_transaction_header_id => p_transaction_header_id,
                                                  p_transaction_line_id   => v_transaction_line_id,
                                                  p_user_id               => p_user_id);
    
      --Mantis:[阳光保险费控项目 0027560]: 报销单计划付款行维护功能二开
      --Add by bobo 2009.11.24
      exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_WRITE_OFF_PREPAYMENT',
                                      p_document_id      => p_transaction_header_id,
                                      p_document_line_id => '',
                                      p_source_module    => c_exp_report,
                                      p_event_type       => 'EXP_REPORT_WRITE_OFF_PREPAYMENT',
                                      p_user_id          => p_user_id);
    
      --创建成功删除临时表数据
      DELETE FROM csh_write_off_tmp t
       WHERE t.session_id = p_session_id
         AND t.write_off_type = 'PREPAYMENT_EXPENSE_REPORT';
    END IF;
  EXCEPTION
    WHEN e_payee_diff THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '报销单付款行收款方与选择的借款单收款方不一致，不能核销。',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'EXP_REPORT_PKG',
                                                     p_procedure_function_name => 'exp_write_off_prepayment');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_amount_over THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_AMOUNT_OVER_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'EXP_REPORT_PKG',
                                                      p_procedure_function_name => 'exp_write_off_prepayment');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
    
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'exp_write_off_prepayment');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END exp_write_off_prepayment;

  FUNCTION exists_unwrite_off_amount(p_exp_report_header_id NUMBER,
                                     p_user_id              NUMBER)
    RETURN VARCHAR2 IS
    v_write_off_status   VARCHAR2(30);
    v_unwrite_off_amount NUMBER;
  BEGIN
    SELECT h.write_off_status
      INTO v_write_off_status
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
    --报销单已完全核销 返回N
    IF v_write_off_status = 'C' THEN
      RETURN 'N';
    END IF;
  
    FOR r_payee_group IN (SELECT s.company_id,
                                 s.payee_category,
                                 s.payee_id,
                                 s.currency
                            FROM exp_report_pmt_schedules s
                           WHERE s.exp_report_header_id =
                                 p_exp_report_header_id
                           GROUP BY s.company_id,
                                    s.payee_category,
                                    s.payee_id,
                                    s.currency) LOOP
      BEGIN
        SELECT SUM((l.transaction_amount -
                   (SELECT nvl(SUM(w.csh_write_off_amount), 0)
                       FROM csh_write_off w
                      WHERE w.csh_transaction_line_id =
                            l.transaction_line_id) -
                   (SELECT nvl(SUM(ctl.transaction_amount), 0)
                       FROM csh_transaction_headers cth,
                            csh_transaction_lines   ctl
                      WHERE cth.transaction_header_id =
                            ctl.transaction_header_id
                        AND cth.source_header_id = h.transaction_header_id
                        AND cth.reversed_flag IS NULL)))
          INTO v_unwrite_off_amount
          FROM csh_transaction_headers h, csh_transaction_lines l
         WHERE h.transaction_header_id = l.transaction_header_id
           AND h.enabled_write_off_flag = 'Y'
           AND h.write_off_flag IN ('Y', 'N')
           AND h.returned_flag IN ('Y', 'N')
           AND h.reversed_flag IS NULL
           AND h.posted_flag = 'Y'
           AND h.transaction_type = 'PREPAYMENT'
           AND l.partner_category = r_payee_group.payee_category
           AND l.partner_id = r_payee_group.payee_id
           AND l.currency_code = r_payee_group.currency
           AND h.company_id = r_payee_group.company_id;
        --存在未核销金额大于零的预付款
        IF v_unwrite_off_amount > 0 THEN
          EXIT;
        END IF;
      EXCEPTION
        WHEN no_data_found THEN
          v_unwrite_off_amount := 0;
      END;
    END LOOP;
    IF v_unwrite_off_amount > 0 THEN
      RETURN 'Y';
    ELSE
      RETURN 'N';
    END IF;
  
    /*select sum((ctl.transaction_amount -
               (select nvl(sum(w.csh_write_off_amount), 0)
                   from csh_write_off w
                  where w.csh_transaction_line_id = l.transaction_line_id
                    and w.write_off_type = 'PREPAYMENT_EXPENSE_REPORT') -
               (select nvl(sum(ctl2.transaction_amount), 0)
                   from csh_transaction_headers cth1,
                        csh_transaction_lines   ctl1,
                        csh_transaction_headers cth2,
                        csh_transaction_lines   ctl2
                  where ctl1.transaction_line_id = ctl.transaction_line_id
                    and ctl1.transaction_header_id = cth1.transaction_header_id
                    and cth2.source_header_id = cth1.transaction_header_id
                    and cth2.transaction_header_id = ctl2.transaction_header_id
                    and cth2.reversed_flag is null))) unwrite_off_amount
      into v_exists_unwrite_off_amount
      from csh_transaction_headers  cth,
           csh_transaction_lines    ctl,
           exp_report_pmt_schedules ers
     where cth.transaction_header_id = ctl.transaction_header_id
       and ctl.partner_category = ers.payee_category
       and ctl.partner_id = ers.payee_id
       and cth.returned_flag in ('N', 'Y')
       and cth.reversed_flag is null
       and cth.company_id = p_company_id
       and ctl.currency_code = ers.currency
       and cth.write_off_flag <> 'C'
       and cth.enabled_write_off_flag = 'Y'
       and cth.posted_flag = 'Y'
       and cth.transaction_type = 'PREPAYMENT'
       and ers.exp_report_header_id = p_exp_report_header_id
       and ctl.transaction_amount -
           (select nvl(sum(cwo.csh_write_off_amount), 0)
              from csh_write_off cwo
             where cwo.csh_transaction_line_id = ctl.transaction_line_id) > 0;
    if (v_exists_unwrite_off_amount = 0) then
      return 'N';
    end if;
    return 'Y';*/
  EXCEPTION
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'exists_unwrite_off_amount');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END exists_unwrite_off_amount;

  --Mantis 0026793: 费用报销单维护-计划付款行-借款核销界面--核销历史TAB增加删除工具按钮
  PROCEDURE delete_csh_write_off(p_write_off_id NUMBER, p_user_id NUMBER) IS
    v_document_id       NUMBER;
    v_csh_trx_line_id   NUMBER;
    v_csh_trx_header_id NUMBER;
    v_transaction_type  VARCHAR2(30);
  BEGIN
    SELECT w.document_header_id, w.csh_transaction_line_id
      INTO v_document_id, v_csh_trx_line_id
      FROM csh_write_off w
     WHERE w.write_off_id = p_write_off_id
       AND w.document_source = 'EXPENSE_REPORT';
  
    IF delete_write_off_check(v_document_id) = 'Y' THEN
      DELETE FROM csh_write_off w WHERE w.write_off_id = p_write_off_id;
    
      DELETE FROM csh_write_off_accounts a
       WHERE a.write_off_id = p_write_off_id;
    
      DELETE FROM gl_account_entry e
       WHERE e.transaction_type = 'CSH_WRITE_OFF'
         AND e.transaction_header_id = p_write_off_id;
    
      csh_write_off_pkg.set_exp_rep_write_off_status(p_exp_report_header_id => v_document_id,
                                                     p_user_id              => p_user_id);
    
      SELECT a.transaction_header_id, a.transaction_type
        INTO v_csh_trx_header_id, v_transaction_type
        FROM csh_transaction_headers a, csh_transaction_lines b
       WHERE a.transaction_header_id = b.transaction_header_id
         AND b.transaction_line_id = v_csh_trx_line_id;
      csh_write_off_pkg.set_csh_trx_write_off_status(p_transaction_header_id => v_csh_trx_header_id,
                                                     p_transaction_line_id   => v_csh_trx_line_id,
                                                     p_transaction_type      => v_transaction_type,
                                                     p_user_id               => p_user_id);
    
      evt_event_core_pkg.fire_event(p_event_name  => 'DELETE_CSH_WRITE_OFF_ACCOUNTS',
                                    p_event_param => p_write_off_id,
                                    p_created_by  => p_user_id);
    END IF;
  EXCEPTION
    WHEN no_data_found THEN
      NULL;
    WHEN e_lock_table THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_LOCK_RECORD_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'delete_csh_write_off');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_delete_error THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_CSH_WRITE_OFF_DELETE_ERROR',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'delete_csh_write_off');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END delete_csh_write_off;

  --报销单提交、反冲、拒绝、回收、时，重置申请单对应的预算保留
  PROCEDURE reset_req_bgt_reserve(p_exp_report_header_id NUMBER,
                                  p_user_id              NUMBER) IS
  BEGIN
    FOR v_release IN (SELECT r.release_id
                        FROM exp_requisition_release r
                       WHERE r.document_type = c_exp_report
                         AND r.document_id = p_exp_report_header_id) LOOP
      exp_requisitions_release_pkg.released_bgt_reserve_balance(p_release_id => v_release.release_id,
                                                                p_user_id    => p_user_id);
    END LOOP;
  END;
  PROCEDURE exp_report_header_save(p_exp_report_header_id        IN OUT NUMBER,
                                   p_exp_report_number           IN OUT VARCHAR2,
                                   p_company_id                  NUMBER,
                                   p_exp_report_barcode          VARCHAR2,
                                   p_employee_id                 NUMBER,
                                   p_position_id                 NUMBER,
                                   p_payee_category              VARCHAR2,
                                   p_payee_id                    NUMBER,
                                   p_exp_report_type_id          NUMBER,
                                   p_expense_user_group_id       NUMBER,
                                   p_currency_code               VARCHAR2,
                                   p_exchange_rate_type          VARCHAR2,
                                   p_exchange_rate_quotation     VARCHAR2,
                                   p_exchange_rate               NUMBER,
                                   p_report_date                 DATE,
                                   p_period_name                 VARCHAR2,
                                   p_report_status               VARCHAR2,
                                   p_gld_interface_flag          VARCHAR2 DEFAULT 'N',
                                   p_attachment_num              NUMBER,
                                   p_description                 VARCHAR2,
                                   p_write_off_status            VARCHAR2 DEFAULT 'N',
                                   p_write_off_completed_date    DATE,
                                   p_reversed_flag               VARCHAR2,
                                   p_source_exp_rep_header_id    NUMBER,
                                   p_created_by                  NUMBER,
                                   p_operation_date              DATE DEFAULT NULL,
                                   p_source_type                 VARCHAR2 DEFAULT 'MANUAL',
                                   p_payment_method_id           NUMBER,
                                   p_vat_special_invoice_include VARCHAR2 DEFAULT NULL,
                                   p_consistent_invoice_amount   VARCHAR2,
                                   p_pay_company_id              VARCHAR2 DEFAULT NULL,
                                   p_contract_header_id          NUMBER DEFAULT NULL,
                                   p_associated_oasign           VARCHAR2 DEFAULT NULL,
                                   p_metting_type_code           VARCHAR2 DEFAULT NULL,
                                   p_special_situation           VARCHAR2 DEFAULT NULL) IS
    v_header_id     NUMBER;
    v_sign_code     VARCHAR2(30);
    v_report_status VARCHAR2(30);
  BEGIN
    IF (p_exp_report_header_id IS NULL OR p_exp_report_header_id = '') THEN
      SELECT exp_report_headers_s.nextval INTO v_header_id FROM dual;
      insert_exp_report_headers(v_header_id,
                                p_company_id,
                                --p_operation_unit_id        number,
                                --p_exp_report_number  varchar2,
                                p_exp_report_barcode,
                                p_employee_id,
                                p_position_id,
                                --p_unit_id                  number,
                                p_payee_category,
                                p_payee_id,
                                p_exp_report_type_id,
                                p_expense_user_group_id,
                                p_currency_code,
                                p_exchange_rate_type,
                                p_exchange_rate_quotation,
                                p_exchange_rate,
                                p_report_date,
                                p_period_name,
                                p_report_status,
                                --p_je_creation_status       varchar2 default 'N',
                                -- p_audit_flag               varchar2 default 'N',
                                --p_audit_date               date,
                                p_gld_interface_flag,
                                p_attachment_num,
                                p_description,
                                p_write_off_status,
                                p_write_off_completed_date,
                                p_reversed_flag,
                                p_source_exp_rep_header_id,
                                p_created_by,
                                p_operation_date,
                                p_source_type,
                                p_payment_method_id,
                                p_vat_special_invoice_include,
                                p_consistent_invoice_amount,
                                p_pay_company_id,
                                p_contract_header_id,
                                p_associated_oasign,
                                p_metting_type_code,
                                p_special_situation);
      SELECT e.exp_report_number
        INTO p_exp_report_number
        FROM exp_report_headers e
       WHERE e.exp_report_header_id = v_header_id;
      p_exp_report_header_id := v_header_id;
    
    ELSE
      SELECT erh.report_status
        INTO v_report_status
        FROM exp_report_headers erh
       WHERE erh.exp_report_header_id = p_exp_report_header_id;
    
      update_exp_report_headers(p_exp_report_header_id,
                                p_exp_report_barcode,
                                p_employee_id,
                                p_position_id,
                                --p_unit_id                  number,
                                p_payee_category,
                                p_payee_id,
                                p_exp_report_type_id,
                                p_expense_user_group_id,
                                p_report_date,
                                p_period_name,
                                --p_report_status,
                                v_report_status,
                                --p_je_creation_status       varchar2,
                                --p_audit_flag               varchar2,
                                --p_audit_date               date,
                                p_gld_interface_flag,
                                p_attachment_num,
                                p_description,
                                p_write_off_status,
                                p_write_off_completed_date,
                                p_reversed_flag,
                                p_source_exp_rep_header_id,
                                p_created_by,
                                p_source_type,
                                p_payment_method_id,
                                p_created_by,
                                p_vat_special_invoice_include,
                                p_consistent_invoice_amount,
                                p_pay_company_id,
                                p_contract_header_id,
                                p_associated_oasign,
                                p_metting_type_code,
                                p_special_situation);
    END IF;
  END;

  PROCEDURE exp_report_header_save(p_exp_report_header_id        IN OUT NUMBER,
                                   p_exp_report_number           IN OUT VARCHAR2,
                                   p_company_id                  NUMBER,
                                   p_exp_report_barcode          VARCHAR2,
                                   p_employee_id                 NUMBER,
                                   p_position_id                 NUMBER,
                                   p_payee_category              VARCHAR2,
                                   p_payee_id                    NUMBER,
                                   p_exp_report_type_id          NUMBER,
                                   p_expense_user_group_id       NUMBER,
                                   p_currency_code               VARCHAR2,
                                   p_exchange_rate_type          VARCHAR2,
                                   p_exchange_rate_quotation     VARCHAR2,
                                   p_exchange_rate               NUMBER,
                                   p_report_date                 DATE,
                                   p_period_name                 VARCHAR2,
                                   p_report_status               VARCHAR2,
                                   p_gld_interface_flag          VARCHAR2 DEFAULT 'N',
                                   p_attachment_num              NUMBER,
                                   p_description                 VARCHAR2,
                                   p_write_off_status            VARCHAR2 DEFAULT 'N',
                                   p_write_off_completed_date    DATE,
                                   p_reversed_flag               VARCHAR2,
                                   p_source_exp_rep_header_id    NUMBER,
                                   p_created_by                  NUMBER,
                                   p_operation_date              DATE DEFAULT NULL,
                                   p_source_type                 VARCHAR2 DEFAULT 'MANUAL',
                                   p_payment_method_id           NUMBER,
                                   p_contract_header_id          NUMBER,
                                   p_eam_asset_id                NUMBER,
                                   p_vat_special_invoice_include VARCHAR2 DEFAULT NULL,
                                   p_consistent_invoice_amount   VARCHAR2,
                                   p_pay_company_id              VARCHAR2 DEFAULT NULL,
                                   p_associated_oasign           VARCHAR2 DEFAULT NULL,
                                   p_sign_id                     NUMBER DEFAULT NULL,
                                   p_metting_type_code           VARCHAR2 DEFAULT NULL,
                                   p_special_situation           VARCHAR2 DEFAULT NULL) IS
    v_sign_code   VARCHAR2(30);
    v_hec_doc_num VARCHAR2(30);
    v_count       NUMBER;
  BEGIN
    exp_report_header_save(p_exp_report_header_id        => p_exp_report_header_id,
                           p_exp_report_number           => p_exp_report_number,
                           p_company_id                  => p_company_id,
                           p_exp_report_barcode          => p_exp_report_barcode,
                           p_employee_id                 => p_employee_id,
                           p_position_id                 => p_position_id,
                           p_payee_category              => p_payee_category,
                           p_payee_id                    => p_payee_id,
                           p_exp_report_type_id          => p_exp_report_type_id,
                           p_expense_user_group_id       => p_expense_user_group_id,
                           p_currency_code               => p_currency_code,
                           p_exchange_rate_type          => p_exchange_rate_type,
                           p_exchange_rate_quotation     => p_exchange_rate_quotation,
                           p_exchange_rate               => p_exchange_rate,
                           p_report_date                 => p_report_date,
                           p_period_name                 => p_period_name,
                           p_report_status               => p_report_status,
                           p_gld_interface_flag          => p_gld_interface_flag,
                           p_attachment_num              => p_attachment_num,
                           p_description                 => p_description,
                           p_write_off_status            => p_write_off_status,
                           p_write_off_completed_date    => p_write_off_completed_date,
                           p_reversed_flag               => p_reversed_flag,
                           p_source_exp_rep_header_id    => p_source_exp_rep_header_id,
                           p_created_by                  => p_created_by,
                           p_operation_date              => p_operation_date,
                           p_source_type                 => p_source_type,
                           p_payment_method_id           => p_payment_method_id,
                           p_vat_special_invoice_include => p_vat_special_invoice_include,
                           p_consistent_invoice_amount   => p_consistent_invoice_amount,
                           p_pay_company_id              => p_pay_company_id,
                           p_contract_header_id          => p_contract_header_id,
                           p_associated_oasign           => p_associated_oasign,
                           p_metting_type_code           => p_metting_type_code,
                           p_special_situation           => p_special_situation);
  
    IF (p_sign_id IS NOT NULL) THEN
    
      BEGIN
        SELECT erh.exp_report_number
          INTO v_hec_doc_num
          FROM con_sign_oa cso, exp_report_headers erh
         WHERE erh.exp_report_header_id = cso.hec_doc_id
           AND cso.sign_id = p_sign_id
           AND erh.exp_report_header_id <> p_exp_report_header_id;
      
        sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '该签报已经创建报销单' ||
                                                                                    v_hec_doc_num ||
                                                                                    ',无需重复创建',
                                                       p_created_by              => p_created_by,
                                                       p_package_name            => 'exp_report_pkg',
                                                       p_procedure_function_name => 'delete_csh_write_off');
        raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                sys_raise_app_error_pkg.g_err_line_id);
      EXCEPTION
        WHEN no_data_found THEN
          NULL;
      END;
    
      UPDATE con_sign_oa cso
         SET cso.hec_doc_id = p_exp_report_header_id
       WHERE cso.sign_id = p_sign_id
      RETURNING cso.sign_code INTO v_sign_code;
    
      SELECT COUNT(1)
        INTO v_count
        FROM cux_oa_exp_ref coe
       WHERE coe.exp_report_header_id = p_exp_report_header_id
         AND coe.sign_code = v_sign_code;
    
      IF (v_count = 0) THEN
        INSERT INTO cux_oa_exp_ref
          (cux_oa_exp_ref_id,
           exp_report_header_id,
           sign_code,
           created_by,
           creation_date,
           last_updated_by,
           last_update_date,
           sign_id)
        VALUES
          (cux_oa_exp_ref_s.nextval,
           p_exp_report_header_id,
           v_sign_code,
           p_created_by,
           SYSDATE,
           p_created_by,
           SYSDATE,
           p_sign_id);
      END IF;
    
      --发送报文给OA，设为已办
      cux_oa_interface_pkg.sign_set_todo_done_oa(p_sign_id);
    
    END IF;
  END;

  /*************************************************
  -- Author  : MOUSE
  -- Created : 2015/2/11 19:11:48
  -- Ver     : 1.1
  -- Purpose : 报销单差旅行插入
  -- In Para :
        p_exp_report_line_id          报销单行ID
        p_travel_plan_line_id         差旅行ID
        p_travel_line_category        差旅行类别（TRANSPORTATION,ACCOMMODATION,OTHER）
        p_transportation              交通工具
        p_departure_place             出发地
        p_departure_place_id          出发地ID
        p_departure_date              出发日期
        p_arrival_place               到达地
        p_arrival_place_id            到达地ID
        p_arrival_date                到达日期
        p_accommodation_date_from     住宿日期从
        p_accommodation_date_to       住宿日期到
        p_accommodation_days          住宿天数
        p_user_id                     操作用户
  **************************************************/
  PROCEDURE insert_exp_report_travel_lines(p_exp_report_line_id      NUMBER,
                                           p_travel_plan_line_id     NUMBER,
                                           p_travel_line_category    VARCHAR2,
                                           p_transportation          VARCHAR2,
                                           p_departure_place         VARCHAR2,
                                           p_departure_place_id      NUMBER,
                                           p_departure_date          DATE,
                                           p_arrival_place           VARCHAR2,
                                           p_arrival_place_id        NUMBER,
                                           p_arrival_date            DATE,
                                           p_accommodation_date_from DATE,
                                           p_accommodation_date_to   DATE,
                                           p_accommodation_days      NUMBER,
                                           p_user_id                 NUMBER) IS
  BEGIN
    INSERT INTO exp_report_travel_lines l
      (exp_report_line_id,
       travel_plan_line_id,
       travel_line_category,
       transportation,
       departure_place,
       departure_place_id,
       departure_date,
       arrival_place,
       arrival_place_id,
       arrival_date,
       accommodation_date_from,
       accommodation_date_to,
       accommodation_days,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date)
    VALUES
      (p_exp_report_line_id,
       p_travel_plan_line_id,
       p_travel_line_category,
       p_transportation,
       p_departure_place,
       p_departure_place_id,
       p_departure_date,
       p_arrival_place,
       p_arrival_place_id,
       p_arrival_date,
       p_accommodation_date_from,
       p_accommodation_date_to,
       p_accommodation_days,
       p_user_id,
       SYSDATE,
       p_user_id,
       SYSDATE);
  EXCEPTION
    WHEN dup_val_on_index THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_TRAVEL_LINE_ID_DUP',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'insert_exp_report_travel_lines');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => SQLERRM ||
                                                                                  dbms_utility.format_error_backtrace,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'insert_exp_report_travel_lines');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END insert_exp_report_travel_lines;

  /*************************************************
  -- Author  : MOUSE
  -- Created : 2015/2/11 19:11:48
  -- Ver     : 1.1
  -- Purpose : 报销单差旅行更新
  -- In Para :
        p_exp_report_line_id          报销单行ID
        p_travel_plan_line_id         差旅行ID
        p_travel_line_category        差旅行类别（TRANSPORTATION,ACCOMMODATION,OTHER）
        p_transportation              交通工具
        p_departure_place             出发地
        p_departure_place_id          出发地ID
        p_departure_date              出发日期
        p_arrival_place               到达地
        p_arrival_place_id            到达地ID
        p_arrival_date                到达日期
        p_accommodation_date_from     住宿日期从
        p_accommodation_date_to       住宿日期到
        p_accommodation_days          住宿天数
        p_user_id                     操作用户
  **************************************************/
  PROCEDURE update_exp_report_travel_lines(p_exp_report_line_id      NUMBER,
                                           p_travel_plan_line_id     NUMBER,
                                           p_travel_line_category    VARCHAR2,
                                           p_transportation          VARCHAR2,
                                           p_departure_place         VARCHAR2,
                                           p_departure_place_id      NUMBER,
                                           p_departure_date          DATE,
                                           p_arrival_place           VARCHAR2,
                                           p_arrival_place_id        NUMBER,
                                           p_arrival_date            DATE,
                                           p_accommodation_date_from DATE,
                                           p_accommodation_date_to   DATE,
                                           p_accommodation_days      NUMBER,
                                           p_user_id                 NUMBER) IS
  BEGIN
    UPDATE exp_report_travel_lines l
       SET l.travel_plan_line_id     = p_travel_plan_line_id,
           l.travel_line_category    = p_travel_line_category,
           l.transportation          = p_transportation,
           l.departure_place         = p_departure_place,
           l.departure_place_id      = p_departure_place_id,
           l.departure_date          = p_departure_date,
           l.arrival_place           = p_arrival_place,
           l.arrival_place_id        = p_arrival_place_id,
           l.arrival_date            = p_arrival_date,
           l.accommodation_date_from = p_accommodation_date_from,
           l.accommodation_date_to   = p_accommodation_date_to,
           l.accommodation_days      = p_accommodation_days,
           l.last_updated_by         = p_user_id,
           l.last_update_date        = SYSDATE
     WHERE l.exp_report_line_id = p_exp_report_line_id;
  EXCEPTION
    WHEN dup_val_on_index THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP_REP_TRAVEL_LINE_ID_DUP',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'insert_exp_report_travel_lines');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => SQLERRM ||
                                                                                  dbms_utility.format_error_backtrace,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'insert_exp_report_travel_lines');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END update_exp_report_travel_lines;
  --add by Qu yuanyuan 2015-11-25 报销单工作流审批页面调整计划付款行付款用途
  PROCEDURE update_exp_pmt_adjust_payment(p_exp_report_header_id     NUMBER,
                                          p_payment_schedule_line_id NUMBER,
                                          p_payment_type_id          NUMBER,
                                          p_gather_flag              VARCHAR2,
                                          p_user_id                  NUMBER,
                                          p_usedes_code              VARCHAR2 DEFAULT NULL) IS
  BEGIN
    UPDATE exp_report_pmt_schedules p
       SET p.payment_type_id  = p_payment_type_id,
           p.gather_flag      = p_gather_flag,
           p.last_updated_by  = p_user_id,
           p.usedes           = p_usedes_code,
           p.last_update_date = SYSDATE
     WHERE p.exp_report_header_id = p_exp_report_header_id
       AND p.payment_schedule_line_id = p_payment_schedule_line_id;
  END update_exp_pmt_adjust_payment;
  --end by Qu yuanyuan 2015-11-25

  /*************************************************
  -- Author  : MOUSE
  -- Created : 2015/12/7 14:37:19
  -- Ver     : 1.1
  -- Purpose : 验证报销单对应的合同金额是否超出合同的资金计划金额
  **************************************************/
  FUNCTION get_con_line_amount(p_exp_report_header_id NUMBER,
                               p_pmt_line_id          NUMBER) RETURN NUMBER IS
  
    v_con_header_id       NUMBER;
    v_con_pmt_line_id     NUMBER;
    v_con_pmt_line_amount NUMBER;
    v_csh_pay_amount      NUMBER;
    v_exp_rep_amount      NUMBER;
    v_pre_trans_write_off csh_write_off%ROWTYPE;
    v_left_amount         NUMBER := 0;
  BEGIN
    BEGIN
      SELECT f.document_id, f.document_line_id
        INTO v_con_header_id, v_con_pmt_line_id
        FROM con_document_flows f
       WHERE f.source_document_type = 'EXP_REPORT_PMT_SCHEDULES'
         AND f.source_document_line_id = p_pmt_line_id;
    EXCEPTION
      WHEN no_data_found THEN
        RETURN v_left_amount;
    END;
  
    IF v_con_header_id IS NOT NULL AND v_con_pmt_line_id IS NOT NULL THEN
      SELECT nvl(s.amount, 0)
        INTO v_con_pmt_line_amount
        FROM con_payment_schedules s
       WHERE s.payment_schedule_line_id = v_con_pmt_line_id;
    
      v_csh_pay_amount := 0;
    
      --计算借款单关联该合同资金计划行的金额
      FOR pay_req_lns IN (SELECT *
                            FROM con_document_flows df
                           WHERE df.source_document_type =
                                 'CSH_PAYMENT_REQUISITION_LNS'
                             AND df.document_line_id = v_con_pmt_line_id) LOOP
      
        FOR pre_trans_write_off IN (SELECT nvl(SUM(amount), 0) AS payed_amount,
                                           MIN(write_off_id) AS write_off_id,
                                           r.csh_transaction_line_id
                                      FROM csh_payment_requisition_refs r
                                     WHERE r.payment_requisition_line_id =
                                           pay_req_lns.source_document_line_id
                                     GROUP BY r.csh_transaction_line_id) LOOP
        
          --根据付款事务获取借款单的已付金额
          v_csh_pay_amount := v_csh_pay_amount +
                              pre_trans_write_off.payed_amount;
        
          --找到核销记录，用于查找预付款事务
          SELECT *
            INTO v_pre_trans_write_off
            FROM csh_write_off wo
           WHERE wo.write_off_id = pre_trans_write_off.write_off_id;
        
          --根据预付款事务，找到核销金额，并从已付金额中减去核销金额
          SELECT v_csh_pay_amount - nvl(SUM(csh_write_off_amount), 0)
            INTO v_csh_pay_amount
            FROM csh_write_off wo
           WHERE wo.csh_transaction_line_id =
                 v_pre_trans_write_off.source_csh_trx_line_id
             AND wo.write_off_type = 'PREPAYMENT_EXPENSE_REPORT';
        
        END LOOP;
      END LOOP;
    
      --查找当前报销单行关联该合同计划行的金额
      SELECT nvl(SUM(s.due_amount), 0)
        INTO v_exp_rep_amount
        FROM exp_report_pmt_schedules s,
             con_document_flows       df,
             exp_report_headers       h
       WHERE df.source_document_type = 'EXP_REPORT_PMT_SCHEDULES'
         AND df.document_line_id = v_con_pmt_line_id
         AND df.source_document_line_id = s.payment_schedule_line_id
         AND h.exp_report_header_id = s.exp_report_header_id
         AND (h.report_status IN ('SUBMITTED', 'COMPLETELY_APPROVED') OR
             h.exp_report_header_id = p_exp_report_header_id);
    
      v_left_amount := v_con_pmt_line_amount - v_csh_pay_amount -
                       v_exp_rep_amount;
    
    END IF;
  
    RETURN v_left_amount;
  END get_con_line_amount;

  /*************************************************
  -- Author  : MOUSE
  -- Created : 2015/12/7 14:37:19
  -- Ver     : 1.1
  -- Purpose : 验证报销单对应的合同金额是否超出合同的资金计划金额
  **************************************************/
  FUNCTION get_con_amount(p_exp_report_header_id NUMBER,
                          p_pmt_line_id          NUMBER) RETURN NUMBER IS
  
    v_con_header_id       NUMBER;
    v_con_amount          NUMBER;
    v_csh_pay_amount      NUMBER;
    v_exp_rep_amount      NUMBER;
    v_pre_trans_write_off csh_write_off%ROWTYPE;
    v_left_amount         NUMBER := 0;
  BEGIN
    BEGIN
      SELECT f.document_id
        INTO v_con_header_id
        FROM con_document_flows f
       WHERE f.source_document_type = 'EXP_REPORT_PMT_SCHEDULES'
         AND f.source_document_line_id = p_pmt_line_id;
    EXCEPTION
      WHEN no_data_found THEN
        RETURN v_left_amount;
    END;
  
    IF v_con_header_id IS NOT NULL THEN
      SELECT nvl(SUM(s.amount), 0)
        INTO v_con_amount
        FROM con_payment_schedules s
       WHERE s.contract_header_id = v_con_header_id;
    
      v_csh_pay_amount := 0;
    
      --计算借款单关联该合同资金计划行的金额
      FOR pay_req_lns IN (SELECT *
                            FROM con_document_flows df
                           WHERE df.source_document_type =
                                 'CSH_PAYMENT_REQUISITION_LNS'
                             AND df.document_id = v_con_header_id) LOOP
      
        FOR pre_trans_write_off IN (SELECT nvl(SUM(amount), 0) AS payed_amount,
                                           MIN(write_off_id) AS write_off_id,
                                           r.csh_transaction_line_id
                                      FROM csh_payment_requisition_refs r
                                     WHERE r.payment_requisition_line_id =
                                           pay_req_lns.source_document_line_id
                                     GROUP BY r.csh_transaction_line_id) LOOP
        
          --根据付款事务获取借款单的已付金额
          v_csh_pay_amount := v_csh_pay_amount +
                              pre_trans_write_off.payed_amount;
        
          --找到核销记录，用于查找预付款事务
          SELECT *
            INTO v_pre_trans_write_off
            FROM csh_write_off wo
           WHERE wo.write_off_id = pre_trans_write_off.write_off_id;
        
          --根据预付款事务，找到核销金额，并从已付金额中减去核销金额
          SELECT v_csh_pay_amount - nvl(SUM(csh_write_off_amount), 0)
            INTO v_csh_pay_amount
            FROM csh_write_off wo
           WHERE wo.csh_transaction_line_id =
                 v_pre_trans_write_off.source_csh_trx_line_id
             AND wo.write_off_type = 'PREPAYMENT_EXPENSE_REPORT';
        
        END LOOP;
      END LOOP;
    
      --查找当前报销单行关联该合同计划行的金额
      SELECT nvl(SUM(s.due_amount), 0)
        INTO v_exp_rep_amount
        FROM exp_report_pmt_schedules s,
             con_document_flows       df,
             exp_report_headers       h
       WHERE df.source_document_type = 'EXP_REPORT_PMT_SCHEDULES'
         AND df.document_id = v_con_header_id
         AND df.source_document_id = s.exp_report_header_id
         AND h.exp_report_header_id = s.exp_report_header_id
         AND df.document_line_id = s.payment_schedule_line_id
         AND (h.report_status IN ('SUBMITTED', 'COMPLETELY_APPROVED') OR
             h.exp_report_header_id = p_exp_report_header_id);
    
      v_left_amount := v_con_amount - v_csh_pay_amount - v_exp_rep_amount;
    
    END IF;
  
    RETURN v_left_amount;
  END get_con_amount;

  /*************************************************
  -- Author  : MOUSE
  -- Created : 2015/12/7 14:37:19
  -- Ver     : 1.1
  -- Purpose : 验证报销单对应的合同金额是否超出合同的资金计划金额
  **************************************************/
  PROCEDURE validate_con_amount(p_exp_report_header_id NUMBER) IS
    v_con_left_amount      NUMBER;
    v_con_line_left_amount NUMBER;
    v_contract_type_code   VARCHAR2(30);
  BEGIN
  
    FOR pmt_lns IN (SELECT *
                      FROM exp_report_pmt_schedules s
                     WHERE s.exp_report_header_id = p_exp_report_header_id) LOOP
      BEGIN
        SELECT v.contract_type_code
          INTO v_contract_type_code
          FROM con_contract_type_dists_v t, con_contract_types_vl v
         WHERE v.contract_type_id = t.contract_type_id
           AND t.company_id = pmt_lns.company_id
           AND t.enabled_flag = 'Y'
           AND t.contract_type_id =
               (SELECT cch.contract_type_id
                  FROM con_document_flows cf, con_contract_headers cch
                 WHERE cch.contract_header_id = cf.document_id
                   and cf.document_type = 'CON_CONTRACT'
                   AND cf.source_document_type = 'EXP_REPORT_PMT_SCHEDULES'
                   AND cf.source_document_line_id =
                       pmt_lns.payment_schedule_line_id);
      EXCEPTION
        WHEN no_data_found THEN
          NULL;
      END;
      --如果合同类型是HT002,则不校验合同金额
      IF v_contract_type_code <> 'HT002' THEN
        v_con_line_left_amount := get_con_line_amount(p_exp_report_header_id => pmt_lns.exp_report_header_id,
                                                      p_pmt_line_id          => pmt_lns.payment_schedule_line_id);
      
        v_con_left_amount := get_con_amount(p_exp_report_header_id => pmt_lns.exp_report_header_id,
                                            p_pmt_line_id          => pmt_lns.payment_schedule_line_id);
      
        IF NOT (v_con_line_left_amount >= 0 AND v_con_left_amount >= 0) THEN
          RAISE e_con_amount_error;
        END IF;
      END IF;
    END LOOP;
  
  END validate_con_amount;

  /*************************************************
  -- Author  : MOUSE
  -- Created : 2015/12/7 18:46:18
  -- Ver     : 1.1
  -- Purpose : 验证报销关联的申请关联的借款是否已经支付，如果未支付，则可能存在报销与借款重复支付的风险，不允许提交
  **************************************************/
  PROCEDURE validate_req_ref_pay_req(p_exp_report_header_id NUMBER) IS
    v_transaction_line_id NUMBER;
    v_amount              NUMBER;
  BEGIN
    FOR req_hds IN (SELECT exp_requisition_header_id
                      FROM exp_requisition_release r
                     WHERE r.document_id = p_exp_report_header_id
                       AND r.document_type = 'EXP_REPORT'
                     GROUP BY r.exp_requisition_header_id) LOOP
      FOR pay_reqs IN (SELECT l.*
                         FROM csh_payment_requisition_hds h,
                              csh_payment_requisition_lns l
                        WHERE h.source_type = 'EXP_REQUISITION'
                          AND h.expense_requisition_header_id =
                              req_hds.exp_requisition_header_id
                          AND h.payment_requisition_header_id =
                              l.payment_requisition_header_id
                          AND h.reversed_flag IS NULL) LOOP
        /*************************************************
                                 -- Author  : MOUSE
                                 -- Created : 2015/12/28 9:46:53
                                 -- Ver     : 1.1
                                 -- Purpose : 增加借款单是否反冲的判断，被反冲的报销单无需支付
        **************************************************/
        SELECT nvl(SUM(amount), 0)
          INTO v_amount
          FROM csh_payment_requisition_refs r
         WHERE r.payment_requisition_line_id =
               pay_reqs.payment_requisition_line_id;
        IF v_amount = 0 THEN
          RAISE e_req_ref_pay_req_error;
        END IF;
      END LOOP;
    END LOOP;
  
  EXCEPTION
    WHEN no_data_found THEN
      RAISE e_req_ref_pay_req_error;
  END validate_req_ref_pay_req;

  /*************************************************
  -- Author  : HM
  -- Created : 2016/05/20 14:04:09
  -- Ver     : 1.0
  -- Purpose : 营改增――报销单复核校验，只有报销单所有行发票认证状态为无需认证和已认证，才可以复核通过
  **************************************************/
  FUNCTION exp_report_recheck_check_vms(p_exp_report_header_id NUMBER)
    RETURN VARCHAR2 IS
  BEGIN
    /*FOR c_line IN (SELECT l.invoice_status
                     FROM exp_report_lines l, exp_report_headers h
                    WHERE l.exp_report_header_id = h.exp_report_header_id
                      AND h.exp_report_header_id = p_exp_report_header_id
                      AND h.vat_special_invoice_include = 'Y') LOOP
      IF c_line.invoice_status NOT IN ('10', '30') THEN
        RETURN '报销单行发票状态必须是已认证或者无需认证才能通过复核！';
      END IF;
    END LOOP;*/
    RETURN NULL;
  END;

  /*************************************************
  -- Author  : HM
  -- Created : 2016/11/1 11:55:09
  -- Purpose : 提交费用报销单校验 
  **************************************************/
  PROCEDURE submit_exp_report_check(p_exp_report_header_id NUMBER,
                                    p_user_id              NUMBER) IS
    v_exists                      CHAR(1) := 'N';
    v_line_number                 NUMBER;
    v_resp_code                   VARCHAR2(50);
    v_vat_special_invoice_include VARCHAR2(1);
    v_vat_sp_count                NUMBER := 0;
    v_invoice_number              exp_report_lines.invoice_number%TYPE;
    v_invoice_code                exp_report_lines.invoice_code%TYPE;
    v_invoice_date_limit          NUMBER := 0;
  
    e_unit_resp_error        EXCEPTION;
    e_no_vat_flag_error      EXCEPTION;
    e_vat_flag_error         EXCEPTION;
    e_invoice_not_only_error EXCEPTION; --发票不唯一
    e_invoice_date_error     EXCEPTION; --发票过久
  BEGIN
    --头校验
    SELECT h.vat_special_invoice_include
      INTO v_vat_special_invoice_include
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
    --行校验
    FOR c_line IN (SELECT l.*,
                          (SELECT yit.special_invoice
                             FROM exp_ygz_invoice_types yit
                            WHERE yit.type_code = l.invoice_type) special_invoice
                     FROM exp_report_lines l
                    WHERE l.exp_report_header_id = p_exp_report_header_id
                    ORDER BY l.line_number) LOOP
      v_line_number := c_line.line_number;
      /*select frc.responsibility_center_code
        into v_resp_code
        from fnd_responsibility_centers frc
       where frc.responsibility_center_id = c_line.responsibility_center_id;
      --成本中心为默认的不校验
      begin
        if v_resp_code <> '0' then
          select distinct 'Y'
            into v_exists
            from exp_org_unit u
           where u.unit_id = c_line.unit_id
             and u.responsibility_center_id =
                 c_line.responsibility_center_id
             and u.company_id = c_line.company_id;
        end if;
      exception
        when no_data_found then
          raise e_unit_resp_error;
      end;*/
      --modified by HM @2016-04-11 营改增校验
      -- 1.如果报销单行上存在发票类型是“增值税专用发票”则含专票勾必须打上
    
      IF c_line.special_invoice = 'Y' THEN
        IF v_vat_special_invoice_include = 'N' THEN
          RAISE e_no_vat_flag_error;
        END IF;
      END IF;
    
      -- 3.有发票编号和发票代码相同的行时，我们认为这是引用同一张发票
      -- 这时如果发票日期必须一致，否则报错
      FOR c_line_other IN (SELECT *
                             FROM exp_report_lines l
                            WHERE l.exp_report_header_id =
                                  p_exp_report_header_id
                              AND l.line_number > c_line.line_number) LOOP
        v_invoice_number := c_line_other.invoice_number;
        v_invoice_code   := c_line_other.invoice_code;
        IF c_line.invoice_number = v_invoice_number AND
           c_line.invoice_code = v_invoice_code THEN
          IF c_line.invoice_date <> c_line_other.invoice_date THEN
            RAISE e_invoice_not_only_error;
          END IF;
        END IF;
      END LOOP;
    
      -- 4.如果专票行发票日期与当前提交日期相差超过指定天数，不允许提交
      v_invoice_date_limit := nvl(sys_parameter_pkg.value('VAT_DATE_LIMIT'),
                                  0);
      v_invoice_number     := c_line.invoice_number;
      v_invoice_code       := c_line.invoice_code;
      --IF trunc(c_line.invoice_date) + v_invoice_date_limit < trunc(SYSDATE) AND
      IF trunc(c_line.invoice_date) > trunc(SYSDATE) AND
         c_line.special_invoice = 'Y' THEN
        RAISE e_invoice_date_error;
      END IF;
    END LOOP;
  
    -- 2.如果报销单行上不存在发票类型是“增值税专用发票”，则含专票的勾必须不打
    /*SELECT COUNT(1)
      INTO v_vat_sp_count
      FROM exp_report_lines l
     WHERE l.exp_report_header_id = p_exp_report_header_id
       AND EXISTS (SELECT 1
              FROM exp_ygz_invoice_types yit
             WHERE yit.special_invoice = 'Y'
               AND yit.type_code = l.invoice_type);
    
    IF v_vat_sp_count = 0 AND v_vat_special_invoice_include = 'Y' THEN
      RAISE e_vat_flag_error;
    END IF;*/
  
  EXCEPTION
    WHEN e_unit_resp_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '行号为【' ||
                                                                                  v_line_number ||
                                                                                  '】的记录预算责任部门与成本中心不匹配，请联系财务部林B',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'submit_exp_report_check');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_no_vat_flag_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '该单据为含专票报销单，请确认并修改',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'submit_exp_report_check');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_vat_flag_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '该单据为含专票报销单，请确认并修改',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'submit_exp_report_check');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_invoice_not_only_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '同一张发票请输入相同的发票日期。' ||
                                                                                  ',发票编号[' ||
                                                                                  v_invoice_number ||
                                                                                  '],发票代码[' ||
                                                                                  v_invoice_code || ']',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'submit_exp_report_check');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_invoice_date_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '由于开票日期大于当前日期' || ',
                                                                                  不能进行抵扣' ||
                                                                                  ',发票编号[' ||
                                                                                  v_invoice_number ||
                                                                                  '],发票代码[' ||
                                                                                  v_invoice_code || ']',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'submit_exp_report_check');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'submit_exp_report_check');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END;

  PROCEDURE insert_exp_report_accounts_rt(p_exp_report_dists_id      NUMBER,
                                          p_exp_report_header_id     NUMBER,
                                          p_exp_report_je_line_id    NUMBER,
                                          p_description              VARCHAR2,
                                          p_journal_date             DATE,
                                          p_period_name              VARCHAR2,
                                          p_source_code              VARCHAR2,
                                          p_company_id               NUMBER,
                                          p_company_segment          VARCHAR2 DEFAULT NULL,
                                          p_responsibility_center_id NUMBER,
                                          p_account_id               NUMBER,
                                          p_account_segment1         VARCHAR2 DEFAULT NULL,
                                          p_account_segment2         VARCHAR2 DEFAULT NULL,
                                          p_account_segment3         VARCHAR2 DEFAULT NULL,
                                          p_account_segment4         VARCHAR2 DEFAULT NULL,
                                          p_account_segment5         VARCHAR2 DEFAULT NULL,
                                          p_account_segment6         VARCHAR2 DEFAULT NULL,
                                          p_account_segment7         VARCHAR2 DEFAULT NULL,
                                          p_account_segment8         VARCHAR2 DEFAULT NULL,
                                          p_account_segment9         VARCHAR2 DEFAULT NULL,
                                          p_account_segment10        VARCHAR2 DEFAULT NULL,
                                          p_dimension1_id            NUMBER DEFAULT NULL,
                                          p_dimension2_id            NUMBER DEFAULT NULL,
                                          p_dimension3_id            NUMBER DEFAULT NULL,
                                          p_dimension4_id            NUMBER DEFAULT NULL,
                                          p_dimension5_id            NUMBER DEFAULT NULL,
                                          p_dimension6_id            NUMBER DEFAULT NULL,
                                          p_dimension7_id            NUMBER DEFAULT NULL,
                                          p_dimension8_id            NUMBER DEFAULT NULL,
                                          p_dimension9_id            NUMBER DEFAULT NULL,
                                          p_dimension10_id           NUMBER DEFAULT NULL,
                                          p_currency_code            VARCHAR2,
                                          p_exchange_rate_type       VARCHAR2,
                                          p_exchange_rate_quotation  VARCHAR2,
                                          p_exchange_rate            NUMBER,
                                          p_entered_amount_dr        NUMBER,
                                          p_entered_amount_cr        NUMBER,
                                          p_functional_amount_dr     NUMBER,
                                          p_functional_amount_cr     NUMBER,
                                          p_gld_interface_flag       VARCHAR2,
                                          p_user_id                  NUMBER,
                                          p_usage_code               VARCHAR2) IS
  BEGIN
    INSERT INTO exp_report_accounts
      (exp_report_dists_id,
       exp_report_header_id,
       exp_report_je_line_id,
       description,
       journal_date,
       period_name,
       source_code,
       company_id,
       company_segment,
       responsibility_center_id,
       account_id,
       account_segment1,
       account_segment2,
       account_segment3,
       account_segment4,
       account_segment5,
       account_segment6,
       account_segment7,
       account_segment8,
       account_segment9,
       account_segment10,
       dimension1_id,
       dimension2_id,
       dimension3_id,
       dimension4_id,
       dimension5_id,
       dimension6_id,
       dimension7_id,
       dimension8_id,
       dimension9_id,
       dimension10_id,
       currency_code,
       exchange_rate_type,
       exchange_rate_quotation,
       exchange_rate,
       entered_amount_dr,
       entered_amount_cr,
       functional_amount_dr,
       functional_amount_cr,
       gld_interface_flag,
       created_by,
       creation_date,
       last_updated_by,
       last_update_date,
       usage_code)
    VALUES
      (p_exp_report_dists_id,
       p_exp_report_header_id,
       p_exp_report_je_line_id,
       p_description,
       p_journal_date,
       p_period_name,
       p_source_code,
       p_company_id,
       p_company_segment,
       p_responsibility_center_id,
       p_account_id,
       p_account_segment1,
       p_account_segment2,
       p_account_segment3,
       p_account_segment4,
       p_account_segment5,
       p_account_segment6,
       p_account_segment7,
       p_account_segment8,
       p_account_segment9,
       p_account_segment10,
       p_dimension1_id,
       p_dimension2_id,
       p_dimension3_id,
       p_dimension4_id,
       p_dimension5_id,
       p_dimension6_id,
       p_dimension7_id,
       p_dimension8_id,
       p_dimension9_id,
       p_dimension10_id,
       p_currency_code,
       p_exchange_rate_type,
       p_exchange_rate_quotation,
       p_exchange_rate,
       p_entered_amount_dr,
       p_entered_amount_cr,
       p_functional_amount_dr,
       p_functional_amount_cr,
       p_gld_interface_flag,
       p_user_id,
       SYSDATE,
       p_user_id,
       SYSDATE,
       p_usage_code);
  
    --生成凭证后，插入预置事件
  
    /* exp_evt_pkg.fire_workflow_event(p_event_name       => 'EXP_REPORT_CREATE_RT_ACCOUNTS',
    p_document_id      => p_exp_report_dists_id,
    p_document_line_id => p_exp_report_je_line_id,
    p_source_module    => gl_account_segment_pkg.g_rule_type_ygz_roll_out,
    p_event_type       => 'EXP_REPORT_CREATE_RT_ACCOUNTS',
    p_user_id          => p_user_id);*/
  END insert_exp_report_accounts_rt;

  --added by HM @2016-04-22 报销单生成凭证――营改增转出
  FUNCTION create_exp_report_accounts_rt(p_exp_rep_line_id NUMBER,
                                         p_journal_date    DATE,
                                         p_user_id         NUMBER,
                                         p_period_name     VARCHAR2)
    RETURN VARCHAR2 IS
    CURSOR cur_line(p_rep_line_id NUMBER) IS
      SELECT d.*,
             l.line_number,
             l.roll_out_amount, --转出比例
             --l.invoice_number, --发票编号
             l.usage_type, --用途类型
             --l.invoice_type, --发票类型
             --l.equal_sale_flag, --视同销售标志
             --l.equal_sale_tax --视同销售税率
             'N' equal_sale_flag,
             0.1 equal_sale_tax,
             l.place_to_id,
             l.meetting_name
        FROM exp_report_dists d, exp_report_lines l
       WHERE d.exp_report_line_id = l.exp_report_line_id
         AND l.exp_report_line_id = p_rep_line_id;
  
    v_exp_report_dists    cur_line%ROWTYPE;
    v_exp_report_accounts exp_report_accounts%ROWTYPE;
  
    v_exp_report_header_id   exp_report_headers.exp_report_header_id%TYPE;
    v_header_company_id      exp_report_headers.company_id %TYPE;
    v_employee_id            exp_report_headers.employee_id %TYPE;
    v_employee_type_id       exp_employees.employee_type_id%TYPE;
    v_expense_user_group_id  exp_report_headers.expense_user_group_id %TYPE;
    v_expense_report_type_id exp_report_headers.exp_report_type_id %TYPE;
    v_rep_header_desc        exp_report_headers.description %TYPE;
    v_exp_account_desc       exp_report_accounts.description%TYPE;
  
    v_exchange_rate      exp_currency_code_tmp.exchange_rate%TYPE;
    v_exchange_rate_type exp_currency_code_tmp.exchange_rate_type%TYPE;
  
    v_period_comparison    VARCHAR2(30);
    v_dists_period_num     NUMBER;
    v_operation_period_num NUMBER;
    v_standard_currency    VARCHAR2(30); --本位币
    v_partner_type_id      NUMBER;
  
    v_usedes_id NUMBER; --付款用途代码id
  
    vv_company_id      NUMBER;
    vv_expense_type_id NUMBER;
    --modified by HM @2016-04-07营改增改动
    v_tax_exp_report_je_line_id NUMBER;
    v_tax_account_id            NUMBER;
    v_entered_amount_dr_tax     NUMBER := 0;
    v_functional_amount_dr_tax  NUMBER := 0;
    v_account_code              VARCHAR2(30);
  
    v_usage_type        VARCHAR2(10); --建信人寿 抵扣规则
    v_t3_value          VARCHAR2(10); --T3映射值
    v_line_desc_flag    VARCHAR2(1); --报销类型是否使用行说明 --modify by wxq
    v_employee_name     VARCHAR2(50);
    v_expense_item_name VARCHAR2(50);
    v_place_desc        VARCHAR2(50);
    v_desc              VARCHAR2(200);
  BEGIN
  
    SELECT v.company_id,
           v.employee_id,
           v.expense_user_group_id,
           v.exp_report_type_id,
           v.description,
           v.exp_report_header_id
      INTO v_header_company_id,
           v_employee_id,
           v_expense_user_group_id,
           v_expense_report_type_id,
           v_rep_header_desc,
           v_exp_report_header_id
      FROM exp_report_headers v
     WHERE v.exp_report_header_id =
           (SELECT l.exp_report_header_id
              FROM exp_report_lines l
             WHERE l.exp_report_line_id = p_exp_rep_line_id);
  
    v_exp_report_accounts.period_name := p_period_name;
    v_employee_type_id                := get_employee_type_id(v_employee_id);
  
    OPEN cur_line(p_exp_rep_line_id);
    LOOP
      FETCH cur_line
        INTO v_exp_report_dists;
      EXIT WHEN cur_line%NOTFOUND;
    
      DELETE FROM exp_report_accounts t
       WHERE t.exp_report_dists_id = v_exp_report_dists.exp_report_dists_id
         AND t.source_code = 'EXPENSE_REPORT_ROLL_OUT';
    
      g_line_number         := v_exp_report_dists.line_number;
      g_exp_report_dists_id := v_exp_report_dists.exp_report_dists_id;
    
      --跨公司 成本中心修改 add by liangying 
      BEGIN
        SELECT c.company_id
          INTO vv_company_id
          FROM fnd_responsibility_centers_vl t, fnd_companies_vl c
         WHERE nvl(t.summary_flag, 'N') = 'N'
           AND t.company_id = c.company_id
           AND SYSDATE BETWEEN nvl(t.start_date_active, SYSDATE) AND
               nvl(t.end_date_active, SYSDATE)
           AND t.responsibility_center_id =
               v_exp_report_dists.responsibility_center_id;
      
        v_exp_report_dists.company_id := vv_company_id;
      
      EXCEPTION
        WHEN no_data_found THEN
          NULL;
      END;
    
      BEGIN
      
        SELECT f.expense_type_id
          INTO vv_expense_type_id
          FROM exp_expense_types f
         WHERE f.company_id = v_exp_report_dists.company_id
           AND f.expense_type_code =
               (SELECT t.expense_type_code
                  FROM exp_expense_types t
                 WHERE t.expense_type_id =
                       v_exp_report_dists.expense_type_id);
      
        v_exp_report_dists.expense_type_id := vv_expense_type_id;
      EXCEPTION
        WHEN no_data_found THEN
          NULL;
      END;
    
      ----------------借方 -------------
      v_standard_currency := gld_common_pkg.get_company_currency_code(v_exp_report_dists.company_id);
      -- 摘要
      v_exp_account_desc := v_exp_report_dists.description;
      --modify by liyuhang
    
      --i.  如果未勾选需要加行说明，则凭证行取值规则为：报销人+‘报’+目的地+费用项目+会议（培训）名称。
      --ii.  如果勾选了需要加行说明，则凭证行取值规则为：报销人+‘报’+目的地+费用项目+会议（培训）名称+行说明
    
      SELECT t.line_desc_flag
        INTO v_line_desc_flag
        FROM exp_expense_types t
       WHERE t.expense_type_id = v_exp_report_dists.expense_type_id;
    
      SELECT e.name
        INTO v_employee_name
        FROM exp_employees e
       WHERE e.employee_id = v_employee_id;
    
      SELECT ei.description
        INTO v_expense_item_name
        FROM exp_expense_items_vl ei
       WHERE ei.expense_item_id = v_exp_report_dists.expense_item_id;
      BEGIN
        SELECT p.place_desc
          INTO v_place_desc
          FROM exp_policy_places_vl p
         WHERE p.place_id = v_exp_report_dists.place_to_id;
      EXCEPTION
        WHEN no_data_found THEN
          v_place_desc := '';
      END;
      v_desc := v_employee_name || '报' || v_place_desc ||
                v_expense_item_name || v_exp_report_dists.meetting_name;
      IF v_line_desc_flag = 'Y' THEN
        v_desc := v_desc || v_exp_report_dists.description;
      END IF;
    
      v_exp_account_desc := v_desc;
      -------------------------------END----------------------------------------------
    
      --业务期间
      v_dists_period_num := gld_common_pkg.get_gld_internal_period_num(v_exp_report_dists.company_id,
                                                                       v_exp_report_dists.period_name);
      --审核期间
      v_operation_period_num := gld_common_pkg.get_gld_internal_period_num(v_exp_report_dists.company_id,
                                                                           p_period_name);
      IF v_dists_period_num > v_operation_period_num THEN
        v_period_comparison := 'EARLIER';
      ELSIF v_dists_period_num = v_operation_period_num THEN
        v_period_comparison := 'IN';
      ELSE
        v_period_comparison := 'LATER';
      END IF;
      acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_exp_report_dists.company_id,
                                                  p_user_id    => p_user_id);
      acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => v_employee_id,
                                                             p_expense_user_group_id  => v_expense_user_group_id,
                                                             p_expense_report_type_id => NULL, --v_expense_report_type_id,
                                                             p_currency_code          => v_exp_report_dists.currency_code,
                                                             p_expense_item_id        => v_exp_report_dists.expense_item_id,
                                                             p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                             p_period_comparison      => v_period_comparison,
                                                             p_employee_type_id       => v_employee_type_id,
                                                             p_org_unit               => v_exp_report_dists.unit_id,
                                                             p_du_id                  => v_exp_report_dists.dimension6_id);
    
      v_exp_report_accounts.account_id := acc_builder_employee_exp_pkg.get_account;
      IF v_exp_report_accounts.account_id = -1 THEN
        CLOSE cur_line;
        RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
      END IF;
    
      --取默认责任中心
      -- v_exp_report_accounts.responsibility_center_id := get_responsibility_center_id(v_header_company_id);
      v_exp_report_accounts.responsibility_center_id := v_exp_report_dists.responsibility_center_id;
      IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
        CLOSE cur_line;
        RETURN 'EXP5140_RESP_CENTER_ERROR';
      END IF;
    
      v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
      --modified by HM @2016-04-06 营改增：金额取：转出金额
      v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
      v_entered_amount_dr_tax     := nvl(v_exp_report_dists.roll_out_amount,
                                         0);
    
      v_functional_amount_dr_tax :=  /*get_functional_amount(p_currency_code           => v_exp_report_dists.currency_code,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          p_amount                  => v_entered_amount_dr_tax,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          p_batch_id                => p_batch_id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          p_company_id              => v_header_company_id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          p_exchange_rate_type      => v_exchange_rate_type,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          p_exchange_rate_quotation => v_exp_report_accounts.exchange_rate_quotation,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          p_exchange_rate           => v_exchange_rate,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          p_standard_currency       => v_standard_currency)*/
       v_entered_amount_dr_tax;
    
      /*v_exp_report_accounts.exchange_rate_type := v_exchange_rate_type;
      v_exp_report_accounts.exchange_rate      := v_exchange_rate;
      v_exp_report_accounts.currency_code      := v_exp_report_dists.currency_code;*/
    
      insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                 p_exp_report_header_id     => v_exp_report_header_id,
                                 p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                 p_description              => v_exp_account_desc,
                                 p_journal_date             => p_journal_date,
                                 p_period_name              => v_exp_report_accounts.period_name,
                                 p_source_code              => c_exp_report_rt_account_sc,
                                 p_company_id               => v_header_company_id,
                                 p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                 p_account_id               => v_exp_report_accounts.account_id,
                                 p_currency_code            => 'CNY', --v_exp_report_accounts.currency_code,
                                 p_exchange_rate_type       => NULL, --v_exp_report_accounts.exchange_rate_type,
                                 p_exchange_rate_quotation  => NULL, --v_exp_report_accounts.exchange_rate_quotation,
                                 p_exchange_rate            => 1, --v_exp_report_accounts.exchange_rate,
                                 p_entered_amount_dr        => v_entered_amount_dr_tax, --v_exp_report_accounts.entered_amount_dr,
                                 p_functional_amount_dr     => v_functional_amount_dr_tax, --v_exp_report_accounts.functional_amount_dr,
                                 p_entered_amount_cr        => '',
                                 p_functional_amount_cr     => '',
                                 p_user_id                  => p_user_id,
                                 p_gld_interface_flag       => 'N',
                                 p_usage_code               => 'EMPLOYEE_EXPENSE');
    
      /* insert_exp_report_accounts_rt(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
      p_exp_report_header_id     => v_exp_report_header_id,
      p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
      p_description              => v_exp_account_desc,
      p_journal_date             => p_journal_date,
      p_period_name              => v_exp_report_accounts.period_name,
      p_source_code              => 'EXPENSE_REPORT_ROLL_OUT',
      p_company_id               => v_exp_report_dists.company_id,
      p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
      p_account_id               => v_exp_report_accounts.account_id,
      p_currency_code            => 'CNY', --v_exp_report_accounts.currency_code,
      p_exchange_rate_type       => NULL, --v_exp_report_accounts.exchange_rate_type,
      p_exchange_rate_quotation  => NULL, --v_exp_report_accounts.exchange_rate_quotation,
      p_exchange_rate            => 1, --v_exp_report_accounts.exchange_rate,
      p_entered_amount_dr        => v_entered_amount_dr_tax, --v_exp_report_accounts.entered_amount_dr,
      p_functional_amount_dr     => v_functional_amount_dr_tax, --v_exp_report_accounts.functional_amount_dr,
      p_entered_amount_cr        => '',
      p_functional_amount_cr     => '',
      p_user_id                  => p_user_id,
      p_gld_interface_flag       => 'N',
      p_usage_code               => 'EMPLOYEE_EXPENSE');*/
    
      ------------------------------贷方--------------------------------
      -- 摘要
      --v_exp_account_desc := v_exp_report_dists.description;
    
      --if nvl(v_exp_report_dists.equal_sale_flag, 'N') = 'Y' then
      /* acc_builder_emp_exp_ds_pkg.set_process_id(v_exp_report_dists.company_id,
                                                p_user_id);
      
      acc_builder_emp_exp_ds_pkg.create_mapping_conditions(p_expense_item_id => v_exp_report_dists.expense_item_id,
                                                           p_expense_type_id => v_exp_report_dists.expense_type_id,
                                                           p_invoice_type    => v_exp_report_dists.invoice_type,
                                                           p_ds_tax_rate     => to_char(v_exp_report_dists.equal_sale_tax,
                                                                                        'FM0.99'),
                                                           p_usage_type      => v_exp_report_dists.usage_type);
      
      v_exp_report_accounts.account_id := acc_builder_emp_exp_ds_pkg.get_account;
      
      IF v_exp_report_accounts.account_id = -1 THEN
        RETURN 'EXP5140_GET_EXP_DS_ACC_ERROR';
      END IF;*/
      --else
    
      --Modified by Rick
      -- 根据用途类型获取科目
      /* acc_builder_emp_exp_rt_pkg.set_process_id(v_exp_report_dists.company_id,
                                                p_user_id);
      acc_builder_emp_exp_rt_pkg.create_mapping_conditions(p_usage_code => v_exp_report_dists.usage_type);
      
      v_exp_report_accounts.account_id := acc_builder_emp_exp_rt_pkg.get_account;*/
    
      --取自报销单进项分类对应进项税转出核算科目 modify by wxq 20180409
      v_exp_report_accounts.account_id := get_account_by_vat_out(v_exp_report_dists.input_tax_structure_detail);
      IF v_exp_report_accounts.account_id = -1 THEN
        RETURN 'EXP5140_GET_EXP_RT_ACC_ERROR';
      END IF;
      --end if;
    
      v_exp_report_accounts.responsibility_center_id := v_exp_report_dists.responsibility_center_id;
      IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
        RETURN 'EXP5140_RESP_CENTER_ERROR';
      END IF;
    
      v_exp_report_accounts.entered_amount_cr := nvl(v_exp_report_dists.roll_out_amount,
                                                     0);
    
      v_exp_report_accounts.functional_amount_cr := v_exp_report_accounts.entered_amount_cr;
    
      v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
    
      insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                 p_exp_report_header_id     => v_exp_report_header_id,
                                 p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                 p_description              => v_exp_account_desc,
                                 p_journal_date             => p_journal_date,
                                 p_period_name              => v_exp_report_accounts.period_name,
                                 p_source_code              => c_exp_report_rt_account_sc,
                                 p_company_id               => v_exp_report_dists.company_id,
                                 p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                 p_account_id               => v_exp_report_accounts.account_id,
                                 p_currency_code            => 'CNY', --v_exp_report_accounts.currency_code,
                                 p_exchange_rate_type       => NULL, --v_exp_report_accounts.exchange_rate_type,
                                 p_exchange_rate_quotation  => NULL, --v_exp_report_accounts.exchange_rate_quotation,
                                 p_exchange_rate            => 1, --v_exp_report_accounts.exchange_rate,
                                 p_entered_amount_dr        => NULL,
                                 p_functional_amount_dr     => NULL,
                                 p_entered_amount_cr        => v_exp_report_accounts.entered_amount_cr,
                                 p_functional_amount_cr     => v_exp_report_accounts.functional_amount_cr,
                                 p_user_id                  => p_user_id,
                                 p_gld_interface_flag       => 'N',
                                 p_usage_code               => 'EMPLOYEE_EXPENSE_ROLL_OUT');
    
      --进项税转出凭证（发票金额与报销金额不符的部分）
      IF v_exp_report_dists.invoice_amount IS NOT NULL AND
         v_exp_report_dists.report_amount <>
         v_exp_report_dists.invoice_amount THEN
        -----------------借方-------------------------
        v_tax_exp_report_je_line_id := get_exp_report_je_line_id;
        v_entered_amount_dr_tax     := nvl(v_exp_report_dists.invoice_tax_amount -
                                           v_exp_report_dists.tax_amount,
                                           0);
        v_functional_amount_dr_tax  := v_entered_amount_dr_tax;
      
        /* --取进项税科目
        acc_builder_employee_exp_pkg.set_process_id(p_company_id => v_header_company_id,
                                                    p_user_id    => p_user_id);
        --根据营改增使用的用途代码，失效相应的参数，这里只保留单据类型ID
        acc_builder_employee_exp_pkg.create_mapping_conditions(p_employee_id            => NULL, --v_employee_id,
                                                               p_expense_user_group_id  => NULL, --v_expense_user_group_id,
                                                               p_expense_report_type_id => v_expense_report_type_id,
                                                               p_currency_code          => NULL, --v_exp_report_dists.currency_code, 
                                                               p_expense_item_id        => NULL, --v_exp_report_dists.expense_item_id,   跳过选择费用科目
                                                               p_expense_type_id        => v_exp_report_dists.expense_type_id,
                                                               p_period_comparison      => NULL, --v_period_comparison,
                                                               p_employee_type_id       => NULL, --v_employee_type_id,
                                                               p_org_unit               => NULL, --v_exp_report_dists.unit_id
                                                               --add by Qu yuanyuan
                                                               p_du_id => NULL --v_exp_report_dists.dimension6_id
                                                               );
        
        v_tax_account_id := acc_builder_employee_exp_pkg.get_account;*/
      
        --取自报销单进项分类对应进项税核算科目 modify by wxq 20180409
        v_tax_account_id := get_account_by_vat_in(v_exp_report_dists.input_tax_structure_detail);
        IF v_tax_account_id = -1 THEN
          CLOSE cur_line;
          RETURN 'EXP5140_GET_EMPLOYEE_EXPENSE_ACC_ERROR';
        END IF;
      
        insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                   p_exp_report_header_id     => v_exp_report_header_id,
                                   p_exp_report_je_line_id    => v_tax_exp_report_je_line_id,
                                   p_description              => v_exp_account_desc,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => c_exp_report_rt_account_sc,
                                   p_company_id               => v_header_company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_tax_account_id,
                                   p_currency_code            => 'CNY',
                                   p_exchange_rate_type       => NULL,
                                   p_exchange_rate_quotation  => NULL,
                                   p_exchange_rate            => 1,
                                   p_entered_amount_dr        => v_entered_amount_dr_tax, --发票税额与报销单行税额差额
                                   p_functional_amount_dr     => v_functional_amount_dr_tax,
                                   p_entered_amount_cr        => '',
                                   p_functional_amount_cr     => '',
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'EMPLOYEE_EXPENSE');
      
        ------------------贷方------------------------
        /*  acc_builder_emp_exp_rt_pkg.set_process_id(v_exp_report_dists.company_id,
                                                  p_user_id);
        acc_builder_emp_exp_rt_pkg.create_mapping_conditions(p_usage_code => v_exp_report_dists.usage_type);
        
        v_exp_report_accounts.account_id := acc_builder_emp_exp_rt_pkg.get_account;*/
      
        --取自报销单进项分类对应进项税转出核算科目 modify by wxq 20180409
        v_exp_report_accounts.account_id := get_account_by_vat_out(v_exp_report_dists.input_tax_structure_detail);
      
        IF v_exp_report_accounts.account_id = -1 THEN
          RETURN 'EXP5140_GET_EXP_RT_ACC_ERROR';
        END IF;
        --end if;
      
        v_exp_report_accounts.responsibility_center_id := v_exp_report_dists.responsibility_center_id;
        IF v_exp_report_accounts.responsibility_center_id IS NULL THEN
          RETURN 'EXP5140_RESP_CENTER_ERROR';
        END IF;
      
        v_exp_report_accounts.entered_amount_cr := nvl(v_exp_report_dists.invoice_tax_amount -
                                                       v_exp_report_dists.tax_amount,
                                                       0);
      
        v_exp_report_accounts.functional_amount_cr := v_exp_report_accounts.entered_amount_cr;
      
        v_exp_report_accounts.exp_report_je_line_id := get_exp_report_je_line_id;
      
        insert_exp_report_accounts(p_exp_report_dists_id      => v_exp_report_dists.exp_report_dists_id,
                                   p_exp_report_header_id     => v_exp_report_header_id,
                                   p_exp_report_je_line_id    => v_exp_report_accounts.exp_report_je_line_id,
                                   p_description              => v_exp_account_desc,
                                   p_journal_date             => p_journal_date,
                                   p_period_name              => v_exp_report_accounts.period_name,
                                   p_source_code              => c_exp_report_rt_account_sc,
                                   p_company_id               => v_exp_report_dists.company_id,
                                   p_responsibility_center_id => v_exp_report_accounts.responsibility_center_id,
                                   p_account_id               => v_exp_report_accounts.account_id,
                                   p_currency_code            => 'CNY', --v_exp_report_accounts.currency_code,
                                   p_exchange_rate_type       => NULL, --v_exp_report_accounts.exchange_rate_type,
                                   p_exchange_rate_quotation  => NULL, --v_exp_report_accounts.exchange_rate_quotation,
                                   p_exchange_rate            => 1, --v_exp_report_accounts.exchange_rate,
                                   p_entered_amount_dr        => NULL,
                                   p_functional_amount_dr     => NULL,
                                   p_entered_amount_cr        => v_exp_report_accounts.entered_amount_cr,
                                   p_functional_amount_cr     => v_exp_report_accounts.functional_amount_cr,
                                   p_user_id                  => p_user_id,
                                   p_gld_interface_flag       => 'N',
                                   p_usage_code               => 'EMPLOYEE_EXPENSE_ROLL_OUT');
      
      END IF;
    END LOOP;
  
    RETURN NULL;
  END;

  /*************************************************
  -- Author  : HM
  -- Created : 2016/12/5 17:49:01
  -- Purpose : 开始创建报销转出凭证
  **************************************************/
  PROCEDURE create_expense_report_acc_rt(p_exp_report_line_id NUMBER,
                                         --p_batch_id     NUMBER,
                                         p_journal_date DATE,
                                         p_company_id   NUMBER,
                                         p_user_id      NUMBER) IS
    v_count    NUMBER;
    v_err_code sys_messages.message_code%TYPE;
  
    v_period_name          exp_report_accounts.period_name%TYPE;
    v_exp_report_header_id exp_report_headers.exp_report_header_id%TYPE;
    v_exp_report_line_id   exp_report_lines.exp_report_line_id%TYPE;
    v_exp_report_number    exp_report_headers.exp_report_number%TYPE;
    v_amortization_flag    exp_report_headers.amortization_flag%TYPE;
    v_roll_out_amount      exp_report_lines.roll_out_amount%TYPE;
    v_usage_type           exp_report_lines.usage_type%TYPE;
  
    /*CURSOR cur_headers IS
    SELECT h.exp_report_header_id,
           h.exp_report_number,
           t.amortization_flag
      FROM exp_report_headers h, exp_report_accounts_tmp t
     WHERE t.expense_report_header_id = h.exp_report_header_id
       AND t.batch_id = p_batch_id
       AND h.report_status = 'COMPLETELY_APPROVED' --已全部审批
       AND h.audit_flag = 'Y';*/
  
    e_need_exchange_rate    EXCEPTION;
    e_create_accounts_error EXCEPTION;
    e_roll_out_zero_error   EXCEPTION;
  BEGIN
    g_batch_id := exp_report_pkg.get_batch_id;
    g_user_id  := p_user_id;
    delete_error_log;
  
    /*SELECT COUNT(1)
      INTO v_count
      FROM exp_currency_code_tmp t
     WHERE (t.exchange_rate IS NULL OR t.exchange_rate_quotation IS NULL)
       AND t.batch_id = p_batch_id
       AND t.currency_code <>
           gld_common_pkg.get_company_currency_code(p_company_id);
    IF v_count > 0 THEN
      RAISE e_need_exchange_rate;
    END IF;*/
  
    v_period_name := gld_common_pkg.get_gld_period_name(p_company_id => p_company_id,
                                                        p_date       => p_journal_date);
    --校验是否取到期间
    IF v_period_name IS NULL THEN
      v_err_code := 'EAM0910_PERIOD_NOT_OPEN_ERROR';
      RAISE e_create_accounts_error;
    END IF;
  
    /*OPEN cur_headers;
    LOOP
      FETCH cur_headers
        INTO v_exp_report_header_id,
             v_exp_report_number,
             v_amortization_flag;
      EXIT WHEN cur_headers%NOTFOUND;*/
    SELECT h.exp_report_header_id, h.exp_report_number, h.amortization_flag
      INTO v_exp_report_header_id, v_exp_report_number, v_amortization_flag
      FROM exp_report_headers h, exp_report_lines l
     WHERE h.exp_report_header_id = l.exp_report_header_id
       AND l.exp_report_line_id = p_exp_report_line_id;
  
    g_exp_report_number   := v_exp_report_number;
    g_operation_code      := 'ROLL_OUT';
    g_line_number         := '';
    g_exp_report_dists_id := '';
  
    BEGIN
      --锁定记录
      SELECT l.exp_report_line_id, l.roll_out_amount, l.usage_type
        INTO v_exp_report_line_id, v_roll_out_amount, v_usage_type
        FROM exp_report_lines l
       WHERE l.exp_report_line_id = p_exp_report_line_id
         AND l.exp_report_header_id =
             (SELECT h.exp_report_header_id
                FROM exp_report_headers h
               WHERE h.exp_report_header_id = v_exp_report_header_id
                 AND h.report_status = 'COMPLETELY_APPROVED' --已全部审批
                 AND h.audit_flag = 'Y')
         FOR UPDATE NOWAIT;
    
      /*IF v_roll_out_amount = 0 AND v_usage_type <> 'YT001' THEN
        RAISE e_roll_out_zero_error;
      END IF;*/
    
      v_err_code := create_exp_report_accounts_rt(p_exp_rep_line_id => v_exp_report_line_id,
                                                  p_journal_date    => p_journal_date,
                                                  p_user_id         => p_user_id,
                                                  --p_batch_id           => p_batch_id,
                                                  p_period_name => v_period_name);
    
      /*IF v_err_code IS NULL THEN
        IF v_amortization_flag = 'Y' THEN
          --待摊
          v_err_code := create_exp_amortization_acc(p_exp_report_header_id => v_exp_report_header_id,
                                                    p_user_id              => p_user_id);
        END IF;
      END IF;*/
    
      IF v_err_code IS NULL THEN
        /* UPDATE exp_report_accounts_tmp t
          SET t.success_flag = 'Y'
        WHERE t.batch_id = p_batch_id
          AND t.expense_report_header_id = v_exp_report_header_id;*/
        NULL;
        --commit;
      
      ELSE
        error_log(sys_message_pkg.get_string(v_err_code));
        RAISE e_create_accounts_error;
      END IF;
    
      --创建报销单历史
      insert_exp_document_histories(p_document_type  => c_exp_report,
                                    p_document_id    => v_exp_report_header_id,
                                    p_operation_code => exp_document_history_pkg.c_create_je, --'CREATE_JE',
                                    p_user_id        => p_user_id,
                                    p_operation_time => SYSDATE,
                                    p_description    => '创建营改增报销单转出凭证，行号：' ||
                                                        g_line_number);
    
    EXCEPTION
      WHEN no_data_found THEN
        NULL;
      WHEN e_lock_table THEN
        error_log(sys_message_pkg.get_string('EXP5140_CONCURRENT_ERROR'));
    END;
    /*END LOOP;
    CLOSE cur_headers;*/
  
  EXCEPTION
    WHEN e_create_accounts_error THEN
      /*IF cur_headers%ISOPEN THEN
        CLOSE cur_headers;
      END IF;*/
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => v_err_code,
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'create_exp_report_account_rt');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_need_exchange_rate THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP5140_NEED_EXCHANGE_RATE',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'create_exp_report_account_rt');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_roll_out_zero_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '转出比例为0的报销行不允许创建凭证！',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'create_exp_report_account_rt');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      /*IF cur_headers%ISOPEN THEN
        CLOSE cur_headers;
      END IF;*/
    
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'create_exp_report_account_rt');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END create_expense_report_acc_rt;

  PROCEDURE exp_report_roll_out_submit(p_exp_report_line_id NUMBER,
                                       p_user_id            NUMBER) IS
    v_roll_out_amount exp_report_lines.roll_out_amount%TYPE;
    v_usage_type      exp_report_lines.usage_type%TYPE;
    v_count           NUMBER;
    v_audit_flag      exp_report_headers.audit_flag%TYPE;
    e_je_creation_first EXCEPTION;
    e_audit_flag_error  EXCEPTION;
  BEGIN
  
    SELECT l.roll_out_amount, l.usage_type
      INTO v_roll_out_amount, v_usage_type
      FROM exp_report_lines l
     WHERE l.exp_report_line_id = p_exp_report_line_id
       FOR UPDATE NOWAIT;
    SELECT nvl(erh.audit_flag, 'N')
      INTO v_audit_flag
      FROM exp_report_headers erh, exp_report_lines erl
     WHERE erh.exp_report_header_id = erl.exp_report_header_id
       AND erl.exp_report_line_id = p_exp_report_line_id;
    IF v_audit_flag = 'N' THEN
      RAISE e_audit_flag_error;
    END IF;
  
    SELECT COUNT(1)
      INTO v_count
      FROM exp_report_accounts era
     WHERE era.exp_report_dists_id IN
           (SELECT d.exp_report_dists_id
              FROM exp_report_dists d
             WHERE d.exp_report_line_id = p_exp_report_line_id)
       AND era.source_code = c_exp_report_rt_account_sc;
  
    IF v_count = 0 THEN
      RAISE e_je_creation_first;
    END IF;
    IF v_usage_type = 'YT004' THEN
      UPDATE exp_report_lines l
         SET l.usage_status    = 'P', --提交
             l.roll_out_amount = l.roll_out_amount + l.invoice_tax_amount -
                                 l.tax_amount,
             --转出金额
             l.last_updated_by  = p_user_id,
             l.last_update_date = SYSDATE
       WHERE l.exp_report_line_id = p_exp_report_line_id;
    ELSE
      UPDATE exp_report_lines l
         SET l.usage_status     = 'P', --提交
             l.roll_out_amount  = l.roll_out_amount + l.invoice_tax_amount -
                                  l.tax_amount, --转出金额
             l.last_updated_by  = p_user_id,
             l.last_update_date = SYSDATE
       WHERE l.exp_report_line_id = p_exp_report_line_id;
    END IF;
  EXCEPTION
    WHEN e_je_creation_first THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '请先创建凭证!',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'exp_report_roll_out_submit');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_audit_flag_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '只可对已审核复核的报销单进行转出！',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'exp_report_roll_out_submit');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    
  END exp_report_roll_out_submit;

  /*************************************************
  -- Author  : HM
  -- Created : 2016/12/5 17:49:01
  -- Purpose : 报销单转出
  **************************************************/
  PROCEDURE exp_report_roll_out(p_exp_report_line_id NUMBER,
                                p_user_id            NUMBER,
                                p_roll_out_per       NUMBER DEFAULT NULL) IS
    v_audit_flag         exp_report_headers.audit_flag%TYPE;
    v_count              NUMBER;
    v_exp_report_line_id exp_report_lines.exp_report_line_id%TYPE;
    v_roll_out_amount    exp_report_lines.roll_out_amount%TYPE;
    v_usage_type         exp_report_lines.usage_type%TYPE;
  
    e_roll_out_amount_error EXCEPTION;
    e_audit_flag_error      EXCEPTION;
    e_je_creation_first     EXCEPTION;
  BEGIN
  
    SELECT l.exp_report_line_id, l.roll_out_amount, l.usage_type
      INTO v_exp_report_line_id, v_roll_out_amount, v_usage_type
      FROM exp_report_lines l
     WHERE l.exp_report_line_id = p_exp_report_line_id
       FOR UPDATE NOWAIT;
  
    SELECT nvl(erh.audit_flag, 'N')
      INTO v_audit_flag
      FROM exp_report_headers erh, exp_report_lines erl
     WHERE erh.exp_report_header_id = erl.exp_report_header_id
       AND erl.exp_report_line_id = p_exp_report_line_id;
  
    IF v_audit_flag = 'N' THEN
      RAISE e_audit_flag_error;
    END IF;
  
    UPDATE exp_report_lines l
       SET l.usage_status     = 'P', --处理中
           l.last_updated_by  = p_user_id,
           l.last_update_date = SYSDATE,
           l.roll_out_amount  = round((l.tax_amount * (p_roll_out_per / 100)),
                                      2)
     WHERE l.exp_report_line_id = v_exp_report_line_id;
  EXCEPTION
    WHEN e_je_creation_first THEN
      sys_raise_app_error_pkg.raise_user_define_error(p_message_code            => 'EXP5140_JE_CREATION_FIRST',
                                                      p_created_by              => p_user_id,
                                                      p_package_name            => 'exp_report_pkg',
                                                      p_procedure_function_name => 'exp_report_roll_out');
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_audit_flag_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '只可对已审核复核的报销单进行转出！',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'exp_report_roll_out');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'exp_report_roll_out');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END exp_report_roll_out;

  /*************************************************
  -- Author  : HM
  -- Created : 2016/12/5 17:49:01
  -- Purpose : 报销单转出金额保存
  **************************************************/
  PROCEDURE exp_report_roll_out_save(p_exp_report_line_id NUMBER,
                                     p_roll_out_per       NUMBER, --转出金额
                                     p_user_id            NUMBER) IS
    v_usage_type VARCHAR2(30);
  BEGIN
    SELECT l.usage_type
      INTO v_usage_type
      FROM exp_report_lines l
     WHERE l.exp_report_line_id = p_exp_report_line_id;
    IF v_usage_type = 'YT004' THEN
      UPDATE exp_report_lines l
         SET l.roll_out_amount = round(adjusted_partial_deductions *
                                       (nvl(p_roll_out_per, 0) / 100),
                                       2) + adjustable_tax_deductible,
             --转出金额
             l.last_updated_by  = p_user_id,
             l.last_update_date = SYSDATE
       WHERE l.exp_report_line_id = p_exp_report_line_id;
    ELSE
      UPDATE exp_report_lines l
         SET l.roll_out_amount  = round(tax_amount * (p_roll_out_per / 100),
                                        2), --转出金额
             l.last_updated_by  = p_user_id,
             l.last_update_date = SYSDATE
       WHERE l.exp_report_line_id = p_exp_report_line_id;
    END IF;
  
  END exp_report_roll_out_save;

  /*************************************************
  -- Author  : HM
  -- Created : 2016/12/5 17:49:01
  -- Purpose : 报销单转出复核
  **************************************************/
  PROCEDURE exp_report_roll_out_recheck(p_exp_report_line_id NUMBER,
                                        p_roll_out_status    VARCHAR2, --复核意见：Y:同意，N:拒绝
                                        p_user_id            NUMBER) IS
    v_audit_flag   exp_report_headers.audit_flag%TYPE;
    v_usage_status exp_report_lines.usage_status%TYPE;
  
    e_roll_out_status_error EXCEPTION;
    e_audit_flag_error      EXCEPTION;
    e_recheck_status_error  EXCEPTION;
  
    v_exp_report_header_id exp_report_headers.exp_report_header_id%TYPE;
    v_exp_report_number    exp_report_headers.exp_report_number%TYPE;
  
    v_company_code        VARCHAR2(30);
    v_bgt_budget_reserves bgt_budget_reserves %ROWTYPE;
  BEGIN
  
    SELECT nvl(erh.audit_flag, 'N'),
           erl.usage_status,
           erh.exp_report_number
      INTO v_audit_flag, v_usage_status, v_exp_report_number
      FROM exp_report_headers erh, exp_report_lines erl
     WHERE erh.exp_report_header_id = erl.exp_report_header_id
       AND erl.exp_report_line_id = p_exp_report_line_id
       FOR UPDATE NOWAIT;
  
    IF v_usage_status <> 'P' THEN
      RAISE e_recheck_status_error;
    ELSIF v_audit_flag = 'N' THEN
      RAISE e_audit_flag_error;
    ELSIF p_roll_out_status <> 'Y' AND p_roll_out_status <> 'N' THEN
      RAISE e_roll_out_status_error;
    END IF;
  
    --同意
    IF p_roll_out_status = 'Y' THEN
      UPDATE exp_report_lines l
         SET l.usage_status     = 'Y', --已处理
             l.last_updated_by  = p_user_id,
             l.last_update_date = SYSDATE
       WHERE l.exp_report_line_id = p_exp_report_line_id;
    
      UPDATE exp_report_accounts era
         SET era.gld_interface_flag = csh_write_off_pkg.c_gld_interface_flag_p,
             era.last_updated_by    = p_user_id,
             era.last_update_date   = SYSDATE
       WHERE era.exp_report_dists_id IN
             (SELECT d.exp_report_dists_id
                FROM exp_report_dists d
               WHERE d.exp_report_line_id = p_exp_report_line_id)
         AND era.source_code = c_exp_report_rt_account_sc;
    
      --生成分录
      FOR c1 IN (SELECT *
                   FROM exp_report_accounts era
                  WHERE era.exp_report_dists_id IN
                        (SELECT d.exp_report_dists_id
                           FROM exp_report_dists d
                          WHERE d.exp_report_line_id = p_exp_report_line_id)
                    AND era.source_code = c_exp_report_rt_account_sc) LOOP
        gl_account_entry_pkg.je_gl_account_entry(p_rule_type  => gl_account_segment_pkg.g_rule_type_exp_report,
                                                 p_je_line_id => c1.exp_report_je_line_id,
                                                 p_user_id    => p_user_id);
      
        UPDATE gl_account_entry gae
           SET gae.attribute12 = v_exp_report_number
         WHERE gae.transaction_je_line_id = c1.exp_report_je_line_id
           AND gae.transaction_type =
               gl_account_segment_pkg.g_rule_type_exp_report;
      END LOOP;
      --建信人寿
      --added by lyh 2018.3.26
      --对于报销单行抵扣规则为“部分抵扣”的，预算保留表插入一行负数记录（金额为税额*
      --（1-转出比例）。当公司为总公司时，预算科目为999999；当公司非总公司时，预算科目
      --为报销单行费用项目对应的预算科目）；
      FOR cur_lines IN (SELECT l.company_id,
                               l.exp_report_line_id,
                               h.exp_report_header_id,
                               d.exp_report_dists_id,
                               l.usage_type,
                               l.budget_item_id,
                               l.tax_amount,
                               l.roll_out_amount,
                               l.adjusted_full_deductions,
                               l.adjusted_partial_deductions
                          FROM exp_report_lines   l,
                               exp_report_dists   d,
                               exp_report_headers h
                         WHERE h.exp_report_header_id =
                               l.exp_report_header_id
                           AND l.exp_report_line_id = d.exp_report_line_id
                           AND l.exp_report_line_id = p_exp_report_line_id) LOOP
        IF cur_lines.usage_type = 'YT002' OR cur_lines.usage_type = 'YT004' THEN
          SELECT br.*
            INTO v_bgt_budget_reserves
            FROM bgt_budget_reserves br
           WHERE br.document_id = cur_lines.exp_report_header_id
             AND br.document_line_id = cur_lines.exp_report_dists_id;
          SELECT bgt_budget_reserves_s.nextval
            INTO v_bgt_budget_reserves.budget_reserve_line_id
            FROM dual;
          SELECT f.company_code
            INTO v_company_code
            FROM fnd_companies f
           WHERE f.company_id = cur_lines.company_id;
          IF v_company_code = '8600000000' THEN
            SELECT t.budget_item_id
              INTO v_bgt_budget_reserves.budget_item_id
              FROM bgt_budget_items t
             WHERE t.budget_item_code = '999999';
          END IF;
          IF cur_lines.usage_type = 'YT002' THEN
            v_bgt_budget_reserves.amount            := -1 *
                                                       (cur_lines.tax_amount -
                                                       cur_lines.roll_out_amount);
            v_bgt_budget_reserves.functional_amount := -1 *
                                                       (cur_lines.tax_amount -
                                                       cur_lines.roll_out_amount);
            INSERT INTO bgt_budget_reserves VALUES v_bgt_budget_reserves;
          ELSIF cur_lines.usage_type = 'YT004' THEN
            IF cur_lines.adjusted_full_deductions > 0 OR
               cur_lines.adjusted_partial_deductions > 0 THEN
            
              v_bgt_budget_reserves.amount := -1 *
                                              (cur_lines.tax_amount -
                                              cur_lines.roll_out_amount);
            
              v_bgt_budget_reserves.functional_amount := -1 *
                                                         (cur_lines.tax_amount -
                                                         cur_lines.roll_out_amount);
              INSERT INTO bgt_budget_reserves VALUES v_bgt_budget_reserves;
            END IF;
          END IF;
        END IF;
      END LOOP;
      --拒绝
    ELSIF p_roll_out_status = 'N' THEN
      UPDATE exp_report_lines l
         SET --l.roll_out_amount  = null,
                l.usage_status = 'N', --未处理
             l.last_updated_by  = p_user_id,
             l.last_update_date = SYSDATE
       WHERE l.exp_report_line_id = p_exp_report_line_id;
    
      --modified by HM @2016-08-12 删除转出凭证
      DELETE FROM exp_report_accounts t
       WHERE t.exp_report_dists_id IN
             (SELECT d.exp_report_dists_id
                FROM exp_report_dists d
               WHERE d.exp_report_line_id = p_exp_report_line_id)
         AND t.source_code = 'EXPENSE_REPORT_ROLL_OUT';
    END IF;
  EXCEPTION
    WHEN e_recheck_status_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '只能复核转出状态为处理中的单据！',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'exp_report_roll_out_recheck');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_audit_flag_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '只可对已审核复核的报销单进行转出复核！',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'exp_report_roll_out_recheck');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_roll_out_status_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '复核状态错误，请联系系统管理员！',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'exp_report_roll_out_recheck');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'exp_report_roll_out_recheck');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END exp_report_roll_out_recheck;
  --合同维护的供应商，在保存后，如果公司级供应商中没有，则分配,并插入维护表
  PROCEDURE insert_exp_report_vender(p_payee_id   NUMBER,
                                     p_company_id NUMBER,
                                     p_user_id    NUMBER) IS
    v_pur_system_venders pur_system_venders%ROWTYPE;
    v_count              NUMBER;
    v_unit_id            NUMBER;
  BEGIN
    SELECT *
      INTO v_pur_system_venders
      FROM pur_system_venders p
     WHERE p.vender_id = p_payee_id;
  
    SELECT COUNT(1)
      INTO v_count
      FROM pur_company_venders pv
     WHERE pv.vender_id = v_pur_system_venders.vender_id
       AND pv.company_id = p_company_id;
    IF (v_count = 0) THEN
      pur_system_venders_pkg.assign_pur_company_venders(p_company_id           => p_company_id,
                                                        p_vender_id            => p_payee_id,
                                                        p_payment_term_id      => v_pur_system_venders.payment_term_id,
                                                        p_payment_method       => v_pur_system_venders.payment_method,
                                                        p_currency_code        => v_pur_system_venders.currency_code,
                                                        p_tax_type_id          => v_pur_system_venders.tax_type_id,
                                                        p_approved_vender_flag => v_pur_system_venders.approved_vender_flag,
                                                        p_enabled_flag         => v_pur_system_venders.enabled_flag,
                                                        p_created_by           => v_pur_system_venders.created_by);
    END IF;
    --added by lyh  2017.7.19
    --合同维护的供应商，在保存后，如果合同维护表没有，则插入
  
    SELECT eu.unit_id
      INTO v_unit_id
      FROM exp_employee_assigns sa,
           exp_org_unit_vl      eu,
           exp_org_position_vl  ep,
           sys_user             su,
           exp_employees        ee
     WHERE sa.employee_id = ee.employee_id
       AND sa.company_id = p_company_id
       AND sa.primary_position_flag = 'Y'
       AND eu.unit_id = ep.unit_id
       AND sa.position_id = ep.position_id
       AND ee.employee_id = su.employee_id
       AND su.user_id = p_user_id;
  
    SELECT COUNT(1)
      INTO v_count
      FROM pur_wlzq_venders pv
     WHERE pv.vender_code = v_pur_system_venders.vender_code
       AND pv.unit_id = v_unit_id;
  
    IF (v_count = 0) THEN
      --INSERT INTO pur_wlzq ;
      INSERT INTO pur_wlzq_venders
        (vender_id,
         vender_code,
         vender_type_id,
         description_id,
         address,
         artificial_person,
         tax_id_number,
         bank_branch_code,
         bank_account_code,
         payment_term_id,
         payment_method,
         currency_code,
         tax_type_id,
         tax_number,
         approved_vender_flag,
         enabled_flag,
         created_by,
         creation_date,
         last_updated_by,
         last_update_date,
         company_id,
         unit_id)
      VALUES
        (pur_wlzq_venders_s.nextval,
         v_pur_system_venders.vender_code,
         v_pur_system_venders.vender_type_id,
         v_pur_system_venders.description_id,
         v_pur_system_venders.address,
         v_pur_system_venders.artificial_person,
         v_pur_system_venders.tax_id_number,
         v_pur_system_venders.bank_branch_code,
         v_pur_system_venders.bank_account_code,
         v_pur_system_venders.payment_term_id,
         v_pur_system_venders.payment_method,
         v_pur_system_venders.currency_code,
         v_pur_system_venders.tax_type_id,
         v_pur_system_venders.tax_id_number,
         v_pur_system_venders.approved_vender_flag,
         v_pur_system_venders.enabled_flag,
         p_user_id,
         SYSDATE,
         p_user_id,
         SYSDATE,
         p_company_id,
         v_unit_id);
    END IF;
  END;

  PROCEDURE invoice_number_check(p_exp_report_header_id NUMBER,
                                 p_user_id              NUMBER,
                                 p_invoice_number       OUT VARCHAR2,
                                 p_exp_report_number    OUT VARCHAR2) IS
    v_number              NUMBER; --发票最后两位数
    v_f_number            VARCHAR2(30);
    v_la_number           NUMBER;
    v_ld_number           NUMBER;
    v_length              NUMBER;
    v_count               NUMBER;
    v_invoice_numer       VARCHAR(30);
    v_new_invoice_numer_a NUMBER;
    v_new_invoice_numer_d NUMBER;
    v_exp_report_number   VARCHAR(500);
    e_invoice_exception EXCEPTION;
  BEGIN
    --raise e_invoice_exception;
    FOR cur_invoices IN (SELECT h.exp_report_number,
                                l.invoice_number,
                                l.invoice_type
                           FROM exp_report_headers h, exp_report_lines l
                          WHERE h.exp_report_header_id =
                                l.exp_report_header_id
                            AND nvl(h.reversed_flag, '-1') <> 'R' --红冲单据排除
                            AND l.exp_report_header_id =
                                p_exp_report_header_id
                            AND l.invoice_type IN ('INV003', 'INV002')) LOOP
      BEGIN
        v_count := 0;
        SELECT length(cur_invoices.invoice_number) INTO v_length FROM dual;
        v_f_number := substr(cur_invoices.invoice_number, 0, v_length - 2);
        --v_number   := to_number(substr(cur_invoices.invoice_number, -2, 2));
        v_number := to_number(cur_invoices.invoice_number);
        --上一位连号数
        v_number    := v_number + 1;
        v_la_number := v_number;
        /*IF (v_number >= 10) THEN
          v_la_number := v_number;
        ELSE
          v_la_number := '0' || v_number;
        END IF;*/
        --下一位连号数
        v_number    := v_number - 2;
        v_ld_number := v_number;
        /*IF (v_number >= 10) THEN
          v_ld_number := v_number;
        ELSE
          v_ld_number := '0' || v_number;
        END IF;*/
        --v_new_invoice_numer_a := v_f_number || v_la_number;
        --v_new_invoice_numer_d := v_f_number || v_ld_number;
        SELECT COUNT(1)
          INTO v_count
          FROM exp_report_lines l
         WHERE to_number(l.invoice_number) IN (v_la_number, v_ld_number)
           AND l.invoice_type = cur_invoices.invoice_type;
        IF (v_count > 0) THEN
          FOR cur_numbe IN (SELECT eh.exp_report_number
                              FROM exp_report_headers eh,
                                   exp_report_lines   el
                             WHERE eh.exp_report_header_id =
                                   el.exp_report_header_id
                               AND to_number(el.invoice_number) IN
                                   (v_la_number, v_ld_number)
                               AND el.invoice_type =
                                   cur_invoices.invoice_type) LOOP
          
            v_exp_report_number := v_exp_report_number || ',' ||
                                   cur_numbe.exp_report_number;
            /*SELECT eh.exp_report_number
             INTO v_exp_report_number
             FROM exp_report_headers eh, exp_report_lines el
            WHERE eh.exp_report_header_id = el.exp_report_header_id
              AND el.invoice_number IN
                  (v_new_invoice_numer_a, v_new_invoice_numer_d)
              AND rownum = 1;*/
          END LOOP;
          RAISE e_invoice_exception;
        END IF;
      EXCEPTION
        WHEN e_invoice_exception THEN
          p_invoice_number    := cur_invoices.invoice_number;
          p_exp_report_number := substr(v_exp_report_number,
                                        2,
                                        length(v_exp_report_number));
          /*sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '该报销单发票号码' ||
                                                                                      cur_invoices.invoice_number ||
                                                                                      '与报销单' ||
                                                                                      v_exp_report_number ||
                                                                                      '发票号码连号,单据不允许提交！',
                                                         p_created_by              => p_user_id,
                                                         p_package_name            => 'exp_expense_items_pkg',
                                                         p_procedure_function_name => 'insert_all_company_exp_items');
          
          raise_application_error(sys_raise_app_error_pkg.c_error_number,
                                  sys_raise_app_error_pkg.g_err_line_id);*/
      END;
    END LOOP;
  END;
  PROCEDURE save_exp_invoice_authentic(p_exp_report_header_id        NUMBER,
                                       p_exp_report_line_id          NUMBER,
                                       p_usage_type                  VARCHAR2,
                                       p_adjusted_full_deductions    NUMBER,
                                       p_adjusted_partial_deductions NUMBER,
                                       p_adjustable_tax_deductible   NUMBER,
                                       p_input_tax_struc_detail      VARCHAR2,
                                       p_invoice_status              VARCHAR2,
                                       p_deductions_remark           VARCHAR2,
                                       p_user_id                     NUMBER) IS
  BEGIN
    UPDATE exp_report_lines l
       SET l.usage_type                  = p_usage_type,
           l.adjusted_full_deductions    = p_adjusted_full_deductions,
           l.adjusted_partial_deductions = p_adjusted_partial_deductions,
           l.adjustable_tax_deductible   = p_adjustable_tax_deductible,
           l.input_tax_structure_detail  = p_input_tax_struc_detail,
           l.invoice_status              = p_invoice_status,
           l.deductions_remark           = p_deductions_remark,
           l.last_update_date            = SYSDATE,
           l.last_updated_by             = p_user_id
     WHERE l.exp_report_line_id = p_exp_report_line_id;
  
    UPDATE exp_report_dists d
       SET d.used_type                   = p_usage_type,
           d.adjusted_full_deductions    = p_adjusted_full_deductions,
           d.adjusted_partial_deductions = p_adjusted_partial_deductions,
           d.adjustable_tax_deductible   = p_adjustable_tax_deductible,
           d.input_tax_structure_detail  = p_input_tax_struc_detail,
           d.invoice_status              = p_invoice_status,
           d.last_update_date            = SYSDATE,
           d.last_updated_by             = p_user_id
     WHERE d.exp_report_line_id = p_exp_report_line_id;
  END;
  PROCEDURE confirm_deductions(p_exp_report_header_id NUMBER,
                               p_exp_report_line_id   NUMBER,
                               p_user_id              NUMBER) IS
  BEGIN
    UPDATE exp_report_lines l
       SET l.confirm_deductions = 'Y',
           l.deductions_time    = SYSDATE,
           l.last_update_date   = SYSDATE,
           l.last_updated_by    = p_user_id
     WHERE l.exp_report_line_id = p_exp_report_line_id;
  END;
  PROCEDURE cancel_deductions(p_exp_report_header_id NUMBER,
                              p_exp_report_line_id   NUMBER,
                              p_user_id              NUMBER) IS
    v_usage_status VARCHAR2(10);
    usage_status_error EXCEPTION;
  BEGIN
    SELECT l.usage_status
      INTO v_usage_status
      FROM exp_report_lines l
     WHERE l.exp_report_line_id = p_exp_report_line_id;
    IF v_usage_status <> 'Y' THEN
      UPDATE exp_report_lines l
         SET l.confirm_deductions = 'N',
             l.deductions_time    = SYSDATE,
             l.last_update_date   = SYSDATE,
             l.last_updated_by    = p_user_id
       WHERE l.exp_report_line_id = p_exp_report_line_id;
    ELSE
      RAISE usage_status_error;
    END IF;
  EXCEPTION
    WHEN usage_status_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '已转出的无法取消抵扣！',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'update_header_dynamic');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END;
  --发票验真拒绝 
  PROCEDURE reject_exp_invoice_authentic(p_exp_report_header_id NUMBER,
                                         p_exp_report_line_id   NUMBER,
                                         p_user_id              NUMBER) IS
  
    v_document_number VARCHAR2(30);
    v_instance_id     NUMBER;
    v_report_status   VARCHAR2(30);
    v_audit_date      DATE;
    v_audit_flag      VARCHAR2(1);
  BEGIN
    SELECT h.exp_report_number, h.report_status, h.audit_date, h.audit_flag
      INTO v_document_number, v_report_status, v_audit_date, v_audit_flag
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
  
    UPDATE exp_report_lines l
       SET l.invoice_status = '40'
     WHERE l.exp_report_line_id = p_exp_report_line_id;
  
    --报销单正处于提交状态，拒绝时修改状态为拒绝，并结束工作流
  
    IF v_report_status = 'SUBMITTED' THEN
      /*update exp_report_headers h
        set h.report_status = 'REJECTED'
      where h.exp_report_header_id = p_exp_report_header_id;*/
      BEGIN
        SELECT i.instance_id
          INTO v_instance_id
          FROM wfl_workflow_instance i
         WHERE i.document_number = v_document_number;
      EXCEPTION
        WHEN OTHERS THEN
          NULL;
      END;
      wfl_core_pkg.workflow_end(p_instance_id => v_instance_id,
                                p_status      => -1,
                                p_user_id     => p_user_id);
    END IF;
    --报销单正处于已审批状态，拒绝时修改状态为拒绝
    IF v_report_status = 'COMPLETELY_APPROVED' THEN
      audit_reject_expense_report(p_expense_report_header_id => p_exp_report_header_id,
                                  p_user_id                  => p_user_id,
                                  p_description              => '发票验真失败');
    END IF;
  
  END;
  PROCEDURE exp_report_roll_out_usage_save(p_exp_report_line_id          NUMBER,
                                           p_usage_type                  VARCHAR2,
                                           p_adjusted_full_deductions    NUMBER,
                                           p_adjusted_partial_deductions NUMBER,
                                           p_adjustable_tax_deductible   NUMBER,
                                           p_user_id                     NUMBER) IS
  BEGIN
    UPDATE exp_report_lines l
       SET l.usage_type                  = p_usage_type,
           l.adjusted_full_deductions    = p_adjusted_full_deductions,
           l.adjusted_partial_deductions = p_adjusted_partial_deductions,
           l.adjustable_tax_deductible   = p_adjustable_tax_deductible,
           l.last_update_date            = SYSDATE,
           l.last_updated_by             = p_user_id
     WHERE l.exp_report_line_id = p_exp_report_line_id;
  
    UPDATE exp_report_dists d
       SET d.used_type                   = p_usage_type,
           d.adjusted_full_deductions    = p_adjusted_full_deductions,
           d.adjusted_partial_deductions = p_adjusted_partial_deductions,
           d.adjustable_tax_deductible   = p_adjustable_tax_deductible,
           d.last_update_date            = SYSDATE,
           d.last_updated_by             = p_user_id
     WHERE d.exp_report_line_id = p_exp_report_line_id;
  
    DELETE FROM exp_report_accounts t
     WHERE EXISTS (SELECT 1
              FROM exp_report_dists d
             WHERE d.exp_report_line_id = p_exp_report_line_id
               AND d.exp_report_dists_id = t.exp_report_dists_id)
       AND t.source_code = 'EXPENSE_REPORT_ROLL_OUT';
  END;
  --更新头字段关联交易
  PROCEDURE update_header_dynamic(p_exp_report_header_id NUMBER,
                                  p_dynamic_id           NUMBER,
                                  p_user_id              NUMBER) IS
    v_number NUMBER; --校验是否已经存在凭证
    e_accounts EXCEPTION; --保存头字段时，校验凭证是是否已经删除  
  BEGIN
    --校验是否已经存在凭证
    SELECT COUNT(*)
      INTO v_number
      FROM exp_report_accounts a
     WHERE a.exp_report_header_id = p_exp_report_header_id;
    IF v_number > 0 THEN
      RAISE e_accounts;
    END IF;
    --更新维值
    UPDATE exp_report_lines l
       SET l.dimension2_id    = p_dynamic_id,
           l.last_updated_by  = p_user_id,
           l.last_update_date = SYSDATE
     WHERE l.exp_report_header_id = p_exp_report_header_id;
  EXCEPTION
    WHEN e_accounts THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '请先删除原有凭证再保存！',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'update_header_dynamic');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'update_header_dynamic');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END;

  --申请单可用金额 modify by wxq 20180425
  FUNCTION amount_check(p_exp_requisition_line_id NUMBER,
                        p_exp_report_header_id    NUMBER) RETURN NUMBER IS
    v_requisition_amount    NUMBER; --申请单行金额
    v_requisition_line_num  NUMBER; --申请单行号
    v_requisition_header_id NUMBER; --申请单头id
    v_report_amount         NUMBER; --关联申请单的报销单行金额
    v_csh_payment_amount    NUMBER; --关联申请单的借款单行金额
  
    v_return_amount    NUMBER; --关联申请单的借款单关联还款单的还款金额  
    v_write_off_amount NUMBER; --关联申请单的报销单被核销金额
    v_amount           NUMBER; --返回申请单的可用额
  
    v_requisiton_number VARCHAR2(30);
    v_report_number     VARCHAR2(30);
  
  BEGIN
    --获得申请单行金额
    SELECT erl.requisition_functional_amount,
           erl.line_number,
           erl.exp_requisition_header_id
      INTO v_requisition_amount,
           v_requisition_line_num,
           v_requisition_header_id
      FROM exp_requisition_lines erl
     WHERE erl.exp_requisition_line_id = p_exp_requisition_line_id;
  
    BEGIN
      v_report_amount := 0;
      --获得关联申请单的报销单行金额
      FOR i IN (SELECT erl.report_functional_amount
                  FROM exp_report_lines erl, exp_report_headers erh
                
                 WHERE erl.exp_report_header_id = erh.exp_report_header_id
                   AND erh.exp_report_header_id <> p_exp_report_header_id
                   AND erh.report_status IN
                       ('COMPLETELY_APPROVED', 'SUBMITTED')
                      --关联申请单
                   AND EXISTS
                 (SELECT 1
                          FROM exp_requisition_release err
                         WHERE err.document_type = 'EXP_REPORT'
                           AND err.document_id = erl.exp_report_header_id
                           AND err.document_line_id = erl.exp_report_line_id
                           AND err.exp_requisition_line_id =
                               p_exp_requisition_line_id)) LOOP
        v_report_amount := v_report_amount + i.report_functional_amount;
      END LOOP;
    EXCEPTION
      WHEN OTHERS THEN
        NULL;
    END;
  
    --获得关联申请单的借款单行金额
    --3种状态占预算：SUBMITTED、APPROVED、CLOSED
    BEGIN
      v_csh_payment_amount := 0;
      FOR i IN (SELECT cprl.amount
                  FROM csh_payment_requisition_lns cprl,
                       csh_payment_requisition_hds cprh
                 WHERE cprh.payment_requisition_header_id =
                       cprl.payment_requisition_header_id
                   AND cprl.ref_document_id = v_requisition_header_id
                   AND cprh.status IN ('SUBMITTED', 'APPROVED', 'CLOSED')) LOOP
        v_csh_payment_amount := i.amount + v_csh_payment_amount;
      END LOOP;
    
    EXCEPTION
      WHEN OTHERS THEN
        NULL;
    END;
  
    --关联申请单的报销单被核销金额
    BEGIN
      v_write_off_amount := 0;
      FOR i IN (SELECT cwo.document_write_off_amount
                  FROM csh_write_off            cwo,
                       exp_report_headers       erh,
                       exp_report_lines         erl,
                       exp_report_pmt_schedules erps
                 WHERE cwo.document_source = 'EXPENSE_REPORT'
                   AND cwo.write_off_type = 'PREPAYMENT_EXPENSE_REPORT'
                   AND cwo.document_header_id = erh.exp_report_header_id
                   AND cwo.document_line_id = erps.payment_schedule_line_id
                   AND erl.exp_report_header_id = erh.exp_report_header_id
                   AND erps.exp_report_header_id = erh.exp_report_header_id
                      --关联申请单
                   AND EXISTS
                 (SELECT 1
                          FROM exp_requisition_release err
                         WHERE err.document_type = 'EXP_REPORT'
                           AND err.document_id = erl.exp_report_header_id
                           AND err.document_line_id = erl.exp_report_line_id
                           AND err.exp_requisition_line_id =
                               p_exp_requisition_line_id)) LOOP
        v_write_off_amount := v_write_off_amount +
                              i.document_write_off_amount;
      END LOOP;
    EXCEPTION
      WHEN OTHERS THEN
        NULL;
    END;
  
    --关联申请单的借款单关联还款单的还款金额  
    BEGIN
      v_return_amount := 0;
    
      FOR i IN (SELECT cl.amount
                  FROM csh_repayment_register_hds  crr,
                       csh_repayment_register_lns  cl,
                       csh_payment_requisition_lns cprl
                 WHERE crr.register_header_id = cl.register_header_id
                   AND crr.repayment_status = 'COMPLETELY_APPROVED'
                   AND crr.audit_flag = 'Y'
                   AND cl.requisition_line_id =
                       cprl.payment_requisition_line_id
                   AND cprl.ref_document_id IS NOT NULL
                   AND cprl.ref_document_id = v_requisition_header_id) LOOP
        v_return_amount := v_return_amount + i.amount;
      END LOOP;
    EXCEPTION
      WHEN OTHERS THEN
        NULL;
    END;
  
    /*申请单行金额-关联申请单的报销单行金额-关联申请单单的借款单行金额+关联申请单的报销单被核销金额+
    关联申请单的借款单关联还款单的还款金额*/
  
    v_amount := v_requisition_amount - v_report_amount -
                v_csh_payment_amount + v_write_off_amount + v_return_amount;
    RETURN v_amount;
  END;

  FUNCTION exp_req_amount_check(p_exp_report_header_id NUMBER)
    RETURN VARCHAR2 IS
    v_req_amount NUMBER := 0;
    v_exp_amount NUMBER := 0;
    v_flag       VARCHAR2(1) := 'N';
  BEGIN
    SELECT SUM(l.report_amount)
      INTO v_exp_amount
      FROM exp_report_lines l
     WHERE l.exp_report_header_id = p_exp_report_header_id;
    FOR c_req_line_id IN (SELECT el.exp_requisition_line_id
                            FROM exp_requisition_headers eh,
                                 exp_requisition_lines   el
                           WHERE eh.exp_requisition_header_id =
                                 el.exp_requisition_header_id
                             AND EXISTS
                           (SELECT 1
                                    FROM exp_requisition_release r
                                   WHERE r.document_id =
                                         p_exp_report_header_id
                                     AND r.document_type = 'EXP_REPORT'
                                     AND r.exp_requisition_line_id =
                                         el.exp_requisition_line_id)) LOOP
      v_req_amount := v_req_amount +
                      amount_check(p_exp_requisition_line_id => c_req_line_id.exp_requisition_line_id,
                                   p_exp_report_header_id    => p_exp_report_header_id);
    END LOOP;
  
    IF v_exp_amount > v_req_amount THEN
      v_flag := 'Y';
    END IF;
    RETURN v_flag;
  END;

  PROCEDURE tax_audit(p_exp_report_header_id NUMBER,
                      p_exp_report_line_id   NUMBER,
                      p_user_id              NUMBER) IS
    v_line_number NUMBER;
  BEGIN
    UPDATE exp_report_lines l
       SET l.tax_audit_flag   = 'Y',
           l.tax_audit_date   = SYSDATE,
           l.last_update_date = SYSDATE,
           l.last_updated_by  = p_user_id
     WHERE l.exp_report_line_id = p_exp_report_line_id;
  
    SELECT l.line_number
      INTO v_line_number
      FROM exp_report_lines l
     WHERE l.exp_report_line_id = p_exp_report_line_id;
  
    --插入报销单历史  
    insert_exp_document_histories(p_document_type  => c_exp_report,
                                  p_document_id    => p_exp_report_header_id,
                                  p_operation_code => exp_document_history_pkg.c_tax_audit, --'TAX_AUDIT',
                                  p_user_id        => p_user_id,
                                  p_operation_time => SYSDATE,
                                  p_description    => '行号：' || v_line_number);
  END;

  --add by lqy 
  --根据接口需要，在行保存还有行更新的时候都会执行这个存储过程，
  --在创建完一行计划划款行以后，便不再新建，每次保存或者更新报销单行的时候，都更新计划付款行的金额

  --是否重建计划付款行
  PROCEDURE create_exp_rep_pmt_schd_intf(p_exp_report_header_id NUMBER,
                                         p_created_by           NUMBER) IS
    v_exp_report_head          exp_report_headers%ROWTYPE;
    v_line_amount              NUMBER;
    v_usedes_code              VARCHAR2(20);
    v_bank_code                VARCHAR2(20);
    v_bank_name                VARCHAR2(200);
    v_bank_location_code       VARCHAR2(20);
    v_bank_location_name       VARCHAR2(200);
    v_province_code            VARCHAR2(20);
    v_province_name            VARCHAR2(200);
    v_city_code                VARCHAR2(20);
    v_city_name                VARCHAR2(200);
    v_account_number           VARCHAR2(50);
    v_account_name             VARCHAR2(200);
    v_payment_schedule_line_id NUMBER;
    v_write_off_count          NUMBER := 0;
  
    v_count            NUMBER;
    v_contract_id      NUMBER;
    v_document_line_id NUMBER;
    v_line_count       NUMBER;
    v_adjustment_flag  VARCHAR2(3);
  
    c_cur_usedes_code       VARCHAR2(30);
    c_cur_currency_code     VARCHAR2(30);
    c_cur_payee_category    VARCHAR2(30);
    c_cur_payee_id          NUMBER;
    c_cur_payment_method_id NUMBER;
    c_cur_report_date       DATE;
    c_cur_company_id        NUMBER;
    v_amount                NUMBER;
  
    CURSOR cur_rec IS
      SELECT cdf.document_id,
             cdf.document_line_id,
             SUM(erl.report_amount) rep_amount,
             get_schedule_usedes_code(p_exp_report_header_id,
                                      erl.expense_item_id) c_cur_usedes_code
        FROM con_document_flows cdf, exp_report_lines erl
       WHERE erl.exp_report_header_id = p_exp_report_header_id
         AND erl.exp_report_header_id = cdf.source_document_id(+)
         AND erl.exp_report_line_id = cdf.source_document_line_id(+)
         AND cdf.document_type(+) = 'CON_CONTRACT'
         AND cdf.source_document_type(+) = 'EXP_REPORT_LINES'
       GROUP BY cdf.document_id,
                cdf.document_line_id,
                get_schedule_usedes_code(p_exp_report_header_id,
                                         erl.expense_item_id);
  
  BEGIN
  
    --add wgf 2012/12/25
    SELECT COUNT(1)
      INTO v_count
      FROM exp_report_pmt_schedules erps
     WHERE erps.exp_report_header_id = p_exp_report_header_id;
  
    IF v_count = 1 THEN
      SELECT COUNT(*)
        INTO v_write_off_count
        FROM exp_report_pmt_schedules erps, csh_write_off cwo
       WHERE erps.exp_report_header_id = p_exp_report_header_id
         AND cwo.document_line_id = erps.payment_schedule_line_id;
    END IF;
  
    --add wgf 2013/1/24 是否调整单，是则不创建
    BEGIN
      SELECT eert.adjustment_flag
        INTO v_adjustment_flag
        FROM exp_report_headers erh, exp_expense_report_types eert
       WHERE erh.exp_report_header_id = p_exp_report_header_id
         AND erh.exp_report_type_id = eert.expense_report_type_id;
    EXCEPTION
      WHEN OTHERS THEN
        v_adjustment_flag := 'N';
    END;
  
    --按合同、合同资金计划分组
    SELECT COUNT(1)
      INTO v_line_count
      FROM (SELECT cdf.document_id, cdf.document_line_id
              FROM exp_report_lines erl, con_document_flows cdf
             WHERE erl.exp_report_header_id = p_exp_report_header_id
               AND erl.exp_report_header_id = cdf.source_document_id(+)
               AND erl.exp_report_line_id = cdf.source_document_line_id(+)
               AND cdf.document_type(+) = 'CON_CONTRACT'
               AND cdf.source_document_type(+) = 'EXP_REPORT_LINES'
             GROUP BY cdf.document_id, cdf.document_line_id);
  
    /*  FOR c_cur IN (SELECT u.usedes_code, h.*
     FROM csh_payment_usedes         u,
          exp_rep_ref_payment_usedes e,
          exp_report_headers         h
    WHERE u.usedes_id = e.usedes_id
      AND e.expense_report_type_id = h.exp_report_type_id
      AND h.exp_report_header_id = p_exp_report_header_id
      AND e.primary_flag = 'Y'
      AND NOT EXISTS
    (SELECT p.payment_schedule_line_id
             FROM exp_report_pmt_schedules p
            WHERE p.exp_report_header_id =
                  p_exp_report_header_id)) LOOP*/
    --add by sqh
  
    SELECT h.currency_code,
           h.payee_category,
           h.payee_id,
           h.payment_method_id,
           h.report_date,
           h.company_id
      INTO c_cur_currency_code,
           c_cur_payee_category,
           c_cur_payee_id,
           c_cur_payment_method_id,
           c_cur_report_date,
           c_cur_company_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
    /* and not exists
    (select p.payment_schedule_line_id
             from exp_report_pmt_schedules p
            where p.exp_report_header_id = p_exp_report_header_id);*/
  
    --20130312 add 异常
    BEGIN
      --  IF c_cur.payee_category = 'VENDER' THEN
      IF c_cur_payee_category = 'VENDER' THEN
        SELECT v.bank_code,
               v.bank_name,
               v.bank_location_code,
               v.bank_location,
               v.province_code,
               v.province_name,
               v.city_code,
               v.city_name,
               v.account_number,
               v.account_name
          INTO v_bank_code,
               v_bank_name,
               v_bank_location_code,
               v_bank_location_name,
               v_province_code,
               v_province_name,
               v_city_code,
               v_city_name,
               v_account_number,
               v_account_name
          FROM pur_vender_accounts v
         WHERE v.vender_id = c_cur_payee_id
              -- c_cur.payee_id
           AND v.primary_flag = 'Y'
           AND v.enabled_flag = 'Y';
        -- ELSIF c_cur.payee_category = 'EMPLOYEE' THEN
      ELSIF c_cur_payee_category = 'EMPLOYEE' THEN
        SELECT v.bank_code,
               v.bank_name,
               v.bank_location_code,
               v.bank_location,
               v.province_code,
               v.province_name,
               v.city_code,
               v.city_name,
               v.account_number,
               v.account_name
          INTO v_bank_code,
               v_bank_name,
               v_bank_location_code,
               v_bank_location_name,
               v_province_code,
               v_province_name,
               v_city_code,
               v_city_name,
               v_account_number,
               v_account_name
          FROM exp_employee_accounts v
         WHERE v.employee_id = c_cur_payee_id --c_cur.payee_id
           AND v.primary_flag = 'Y'
           AND v.enabled_flag = 'Y';
      ELSE
        SELECT v.bank_code,
               v.bank_name,
               v.bank_location_code,
               v.bank_location,
               v.province_code,
               v.province_name,
               v.city_code,
               v.city_name,
               v.account_number,
               v.account_name
          INTO v_bank_code,
               v_bank_name,
               v_bank_location_code,
               v_bank_location_name,
               v_province_code,
               v_province_name,
               v_city_code,
               v_city_name,
               v_account_number,
               v_account_name
          FROM ord_customer_accounts v
         WHERE v.customer_id = c_cur_payee_id -- c_cur.payee_id
           AND v.primary_flag = 'Y'
           AND v.enabled_flag = 'Y';
      END IF;
    EXCEPTION
      WHEN OTHERS THEN
        NULL;
    END;
  
    /* SELECT SUM(e.report_amount)
     INTO v_line_amount
     FROM exp_report_lines e
    WHERE e.exp_report_header_id = p_exp_report_header_id;*/
    IF v_count = 0 AND v_adjustment_flag = 'N' THEN
      --add wgf 2012/12/24 报销单行若有合同则计划付款行带出
      FOR l_rec IN cur_rec LOOP
      
        insert_rep_pmt_schedules(v_payment_schedule_line_id,
                                 p_exp_report_header_id,
                                 NULL,
                                 c_cur_currency_code,
                                 c_cur_payee_category,
                                 c_cur_payee_id,
                                 --modify by zhaofan 20160818 客户要求，默认不带出付款对象、账号等Start
                                 --add by HJ
                                 v_account_number,
                                 v_account_name,
                                 --modify by zhaofan 20160818 客户要求，默认不带出付款对象、账号等End
                                 c_cur_payment_method_id,
                                 c_cur_report_date,
                                 c_cur_report_date,
                                 l_rec.rep_amount, --add 2012/12/25
                                 v_bank_code,
                                 v_bank_name,
                                 v_bank_location_code,
                                 v_bank_location_name,
                                 v_province_code,
                                 v_province_name,
                                 v_city_code,
                                 v_city_name,
                                 l_rec.c_cur_usedes_code,
                                 --add 2012/12/25
                                 l_rec.document_id,
                                 l_rec.document_line_id,
                                 p_created_by,
                                 c_cur_company_id,
                                 --frozen_flag默认为不冻结
                                 'N',
                                 NULL,
                                 1);
      END LOOP;
    ELSIF v_count > 0 AND v_adjustment_flag = 'N' AND v_count < 2 AND
          v_write_off_count = 0 THEN
      --遍历当前单据所有的行，计算出所有行的总金额
      SELECT SUM(nvl(l.report_amount, 0))
        INTO v_amount
        FROM exp_report_lines l
       WHERE l.exp_report_header_id = p_exp_report_header_id;
      --更新计划付款行上面的金额，与所有行的金额保持一致
      UPDATE exp_report_pmt_schedules erps
         SET erps.due_amount       = v_amount,
             erps.last_updated_by  = p_created_by,
             erps.last_update_date = SYSDATE
       WHERE erps.exp_report_header_id = p_exp_report_header_id;
    END IF;
    -- END LOOP;
  
    --add wgf 2012/12/26
    --当报销单行按合同、合同资金计划分组后如为一行，且属于该报销单计划付款行也只有一行时更新金额
    IF v_count = 1 AND v_line_count = 1 AND v_adjustment_flag = 'N' THEN
      UPDATE exp_report_pmt_schedules erps
         SET erps.due_amount      =
             (SELECT SUM(nvl(erl.report_amount, 0))
                FROM exp_report_lines erl
               WHERE erl.exp_report_header_id = p_exp_report_header_id),
             erps.last_updated_by  = p_created_by,
             erps.last_update_date = SYSDATE
       WHERE erps.exp_report_header_id = p_exp_report_header_id;
    END IF;
  
    --若付款计划有一条，且按合同、合同资金计划分组后得到的行数>=2时
    IF v_count = 1 AND v_line_count >= 2 AND v_adjustment_flag = 'N' THEN
      BEGIN
        SELECT cdf.document_id, cdf.document_line_id
          INTO v_contract_id, v_document_line_id
          FROM con_document_flows cdf, exp_report_pmt_schedules ers
         WHERE ers.exp_report_header_id = p_exp_report_header_id
           AND ers.exp_report_header_id = cdf.source_document_id(+)
           AND ers.payment_schedule_line_id =
               cdf.source_document_line_id(+)
           AND cdf.document_type(+) = 'CON_CONTRACT'
           AND cdf.source_document_type(+) = 'EXP_REPORT_PMT_SCHEDULES'
         GROUP BY cdf.document_id, cdf.document_line_id;
      EXCEPTION
        WHEN OTHERS THEN
          v_contract_id      := NULL;
          v_document_line_id := NULL;
      END;
      --add by sqh
      /*begin
        select nvl(u.usedes_code, null)
          into c_cur_usedes_code
          from csh_payment_usedes         u,
               exp_rep_ref_payment_usedes e,
               exp_report_headers         h
         where u.usedes_id = e.usedes_id
           and e.expense_report_type_id = h.exp_report_type_id
           and h.exp_report_header_id = p_exp_report_header_id
           and e.primary_flag = 'Y'
           and not exists
         (select p.payment_schedule_line_id
                  from exp_report_pmt_schedules p
                 where p.exp_report_header_id = p_exp_report_header_id);
      exception
        when others then
          c_cur_usedes_code := null;
          null;
      end;*/
      SELECT h.currency_code,
             h.payee_category,
             h.payee_id,
             h.payment_method_id,
             h.report_date,
             h.company_id
        INTO c_cur_currency_code,
             c_cur_payee_category,
             c_cur_payee_id,
             c_cur_payment_method_id,
             c_cur_report_date,
             c_cur_company_id
        FROM exp_report_headers h
       WHERE h.exp_report_header_id = p_exp_report_header_id
         AND NOT EXISTS
       (SELECT p.payment_schedule_line_id
                FROM exp_report_pmt_schedules p
               WHERE p.exp_report_header_id = p_exp_report_header_id);
    
      IF c_cur_payee_category = 'VENDER' THEN
        SELECT v.bank_code,
               v.bank_name,
               v.bank_location_code,
               v.bank_location,
               v.province_code,
               v.province_name,
               v.city_code,
               v.city_name,
               v.account_number,
               v.account_name
          INTO v_bank_code,
               v_bank_name,
               v_bank_location_code,
               v_bank_location_name,
               v_province_code,
               v_province_name,
               v_city_code,
               v_city_name,
               v_account_number,
               v_account_name
          FROM pur_vender_accounts v
         WHERE v.vender_id = c_cur_payee_id
           AND v.primary_flag = 'Y'
           AND v.enabled_flag = 'Y';
      ELSIF c_cur_payee_category = 'EMPLOYEE' THEN
        SELECT v.bank_code,
               v.bank_name,
               v.bank_location_code,
               v.bank_location,
               v.province_code,
               v.province_name,
               v.city_code,
               v.city_name,
               v.account_number,
               v.account_name
          INTO v_bank_code,
               v_bank_name,
               v_bank_location_code,
               v_bank_location_name,
               v_province_code,
               v_province_name,
               v_city_code,
               v_city_name,
               v_account_number,
               v_account_name
          FROM exp_employee_accounts v
         WHERE v.employee_id = c_cur_payee_id
           AND v.primary_flag = 'Y'
           AND v.enabled_flag = 'Y';
      ELSE
        SELECT v.bank_code,
               v.bank_name,
               v.bank_location_code,
               v.bank_location,
               v.province_code,
               v.province_name,
               v.city_code,
               v.city_name,
               v.account_number,
               v.account_name
          INTO v_bank_code,
               v_bank_name,
               v_bank_location_code,
               v_bank_location_name,
               v_province_code,
               v_province_name,
               v_city_code,
               v_city_name,
               v_account_number,
               v_account_name
          FROM ord_customer_accounts v
         WHERE v.customer_id = c_cur_payee_id
           AND v.primary_flag = 'Y'
           AND v.enabled_flag = 'Y';
      END IF;
      FOR l_rec IN cur_rec LOOP
      
        IF nvl(l_rec.document_id, 0) <> nvl(v_contract_id, 0) OR
           nvl(l_rec.document_line_id, 0) <> nvl(v_document_line_id, 0) THEN
        
          insert_rep_pmt_schedules(v_payment_schedule_line_id,
                                   p_exp_report_header_id,
                                   NULL,
                                   c_cur_currency_code,
                                   c_cur_payee_category,
                                   c_cur_payee_id,
                                   v_account_number,
                                   v_account_name,
                                   c_cur_payment_method_id,
                                   c_cur_report_date,
                                   c_cur_report_date,
                                   l_rec.rep_amount, --add 2012/12/25
                                   v_bank_code,
                                   v_bank_name,
                                   v_bank_location_code,
                                   v_bank_location_name,
                                   v_province_code,
                                   v_province_name,
                                   v_city_code,
                                   v_city_name,
                                   l_rec.c_cur_usedes_code,
                                   --add 2012/12/25
                                   l_rec.document_id,
                                   l_rec.document_line_id,
                                   p_created_by,
                                   c_cur_company_id,
                                   --frozen_flag默认为不冻结
                                   'N',
                                   NULL);
        END IF;
      END LOOP;
      --  END LOOP;
    END IF;
    --and
  
    --重置核销状态
    reset_exp_rpt_write_off_flag(p_exp_report_header_id => p_exp_report_header_id,
                                 p_created_by           => p_created_by);
  EXCEPTION
    WHEN OTHERS THEN
      RETURN;
  END;

  PROCEDURE update_exp_report_headers_intf(p_exp_report_header_id NUMBER,
                                           p_exp_report_barcode   VARCHAR2,
                                           p_employee_id          NUMBER,
                                           --p_position_id          number,
                                           --p_unit_id                  number,
                                           p_payee_category        VARCHAR2,
                                           p_payee_id              NUMBER,
                                           p_exp_report_type_id    NUMBER,
                                           p_expense_user_group_id NUMBER,
                                           p_report_date           DATE,
                                           p_period_name           VARCHAR2,
                                           p_report_status         VARCHAR2,
                                           --p_je_creation_status       varchar2,
                                           --p_audit_flag               varchar2,
                                           --p_audit_date               date,
                                           p_gld_interface_flag       VARCHAR2,
                                           p_attachment_num           NUMBER,
                                           p_description              VARCHAR2,
                                           p_write_off_status         VARCHAR2,
                                           p_write_off_completed_date DATE,
                                           p_reversed_flag            VARCHAR2,
                                           p_source_exp_rep_header_id NUMBER,
                                           p_last_updated_by          NUMBER,
                                           p_source_type              VARCHAR2 DEFAULT 'MANUAL',
                                           p_payment_method_id        NUMBER,
                                           p_user_id                  NUMBER,
                                           p_pay_company_id           VARCHAR2 DEFAULT NULL) IS
    /*v_operation_unit_id exp_report_headers.operation_unit_id%type;
    v_position_id       exp_report_headers.position_id%type;
    v_company_id        exp_report_headers.company_id%type;
    v_unit_id           exp_report_headers.unit_id%type;*/
  
  BEGIN
    IF update_status_check(p_exp_report_header_id, p_last_updated_by) = 'Y' THEN
      /*select company_id
        into v_company_id
        from exp_report_headers
       where exp_report_header_id = p_exp_report_header_id;
      
      exp_requisition_pkg.get_head_employee_info(p_employee_id     => p_employee_id,
                                                 p_company_id      => v_company_id,
                                                 p_operate_unit_id => v_operation_unit_id,
                                                 p_unit_id         => v_unit_id,
                                                 p_position_id     => v_position_id);*/
      --重置现金事务核销状态
      csh_write_off_pkg.set_exp_rep_write_off_status(p_exp_report_header_id => p_exp_report_header_id,
                                                     p_user_id              => p_user_id);
      UPDATE exp_report_headers
         SET exp_report_barcode = p_exp_report_barcode,
             employee_id        = p_employee_id,
             --position_id              = v_position_id,
             --operation_unit_id        = v_operation_unit_id,
             --unit_id                  = v_unit_id,
             payee_category        = p_payee_category,
             payee_id              = p_payee_id,
             exp_report_type_id    = p_exp_report_type_id,
             expense_user_group_id = p_expense_user_group_id,
             report_date           = p_report_date,
             period_name           = p_period_name,
             report_status         = p_report_status,
             --je_creation_status       = p_je_creation_status,
             --audit_flag               = p_audit_flag,
             --audit_date               = p_audit_date,
             gld_interface_flag = p_gld_interface_flag,
             attachment_num     = p_attachment_num,
             description        = p_description,
             --ModifiedBy:ZhouHao
             --Purpose:报销单先进行核销，再保存，会出现核销状态被重置的情况
             --write_off_status         = p_write_off_status,
             --write_off_completed_date = p_write_off_completed_date,
             reversed_flag            = p_reversed_flag,
             source_exp_rep_header_id = p_source_exp_rep_header_id,
             last_updated_by          = p_last_updated_by,
             last_update_date         = SYSDATE,
             source_type              = p_source_type,
             payment_method_id        = p_payment_method_id,
             pay_company_id           = p_pay_company_id
       WHERE exp_report_header_id = p_exp_report_header_id;
    
      --modify wgf 2012/12/28
      /*UPDATE exp_report_pmt_schedules s
        SET s.last_updated_by  = p_last_updated_by,
            s.last_update_date = SYSDATE,
            s.description      = p_description
      WHERE s.exp_report_header_id = p_exp_report_header_id;*/
    END IF;
  
  END update_exp_report_headers_intf;

  PROCEDURE exp_report_header_save_intf(p_exp_report_header_id        IN OUT NUMBER,
                                        p_exp_report_number           IN OUT VARCHAR2,
                                        p_company_id                  NUMBER,
                                        p_exp_report_barcode          VARCHAR2,
                                        p_employee_id                 NUMBER,
                                        p_position_id                 NUMBER,
                                        p_payee_category              VARCHAR2,
                                        p_payee_id                    NUMBER,
                                        p_exp_report_type_id          NUMBER,
                                        p_expense_user_group_id       NUMBER,
                                        p_currency_code               VARCHAR2,
                                        p_exchange_rate_type          VARCHAR2,
                                        p_exchange_rate_quotation     VARCHAR2,
                                        p_exchange_rate               NUMBER,
                                        p_report_date                 DATE,
                                        p_period_name                 VARCHAR2,
                                        p_report_status               VARCHAR2,
                                        p_gld_interface_flag          VARCHAR2 DEFAULT 'N',
                                        p_attachment_num              NUMBER,
                                        p_description                 VARCHAR2,
                                        p_write_off_status            VARCHAR2 DEFAULT 'N',
                                        p_write_off_completed_date    DATE,
                                        p_reversed_flag               VARCHAR2,
                                        p_source_exp_rep_header_id    NUMBER,
                                        p_created_by                  NUMBER,
                                        p_operation_date              DATE DEFAULT NULL,
                                        p_source_type                 VARCHAR2 DEFAULT 'MANUAL',
                                        p_payment_method_id           NUMBER,
                                        p_contract_header_id          NUMBER,
                                        p_eam_asset_id                NUMBER,
                                        p_vat_special_invoice_include VARCHAR2 DEFAULT NULL,
                                        p_create_type                 VARCHAR2 DEFAULT NULL,
                                        p_related_transactions        NUMBER,
                                        p_meeting_type_id             VARCHAR2 DEFAULT NULL,
                                        p_pay_company_id              VARCHAR2 DEFAULT NULL) IS
    v_header_id         NUMBER;
    v_metting_type_code VARCHAR2(30);
  BEGIN
  
    --会议类型
    IF p_meeting_type_id IS NOT NULL THEN
      SELECT sv.code_value
        INTO v_metting_type_code
        FROM sys_codes s, sys_code_values sv, fnd_descriptions f
       WHERE s.code_id = sv.code_id
         AND s.code = 'MEETING_TYPE'
         AND sv.code_value_id = p_meeting_type_id
         AND sv.code_value_name_id = f.description_id
         AND f.language = 'ZHS';
    END IF;
  
    IF (p_exp_report_header_id IS NULL OR p_exp_report_header_id = '') THEN
      SELECT exp_report_headers_s.nextval INTO v_header_id FROM dual;
      insert_exp_report_headers(v_header_id,
                                p_company_id,
                                --p_operation_unit_id        number,
                                --p_exp_report_number  varchar2,
                                p_exp_report_barcode,
                                p_employee_id,
                                p_position_id,
                                --p_unit_id                  number,
                                p_payee_category,
                                p_payee_id,
                                p_exp_report_type_id,
                                p_expense_user_group_id,
                                p_currency_code,
                                p_exchange_rate_type,
                                p_exchange_rate_quotation,
                                p_exchange_rate,
                                p_report_date,
                                p_period_name,
                                p_report_status,
                                --p_je_creation_status       varchar2 default 'N',
                                -- p_audit_flag               varchar2 default 'N',
                                --p_audit_date               date,
                                p_gld_interface_flag,
                                p_attachment_num,
                                p_description,
                                p_write_off_status,
                                p_write_off_completed_date,
                                p_reversed_flag,
                                p_source_exp_rep_header_id,
                                p_created_by,
                                p_operation_date,
                                p_source_type,
                                p_payment_method_id,
                                p_vat_special_invoice_include,
                                'N',
                                p_pay_company_id);
      --app头表关联交易
      UPDATE exp_report_headers h
         SET h.related_transactions = p_related_transactions,
             h.metting_type_code    = v_metting_type_code,
             h.contract_header_id   = p_contract_header_id,
             h.create_type          = p_create_type
       WHERE h.exp_report_header_id = v_header_id;
    
      SELECT e.exp_report_number
        INTO p_exp_report_number
        FROM exp_report_headers e
       WHERE e.exp_report_header_id = v_header_id;
      p_exp_report_header_id := v_header_id;
    ELSE
      update_exp_report_headers_intf(p_exp_report_header_id,
                                     p_exp_report_barcode,
                                     p_employee_id,
                                     --p_position_id          number,
                                     --p_unit_id                  number,
                                     p_payee_category,
                                     p_payee_id,
                                     p_exp_report_type_id,
                                     p_expense_user_group_id,
                                     p_report_date,
                                     p_period_name,
                                     p_report_status,
                                     --p_je_creation_status       varchar2,
                                     --p_audit_flag               varchar2,
                                     --p_audit_date               date,
                                     p_gld_interface_flag,
                                     p_attachment_num,
                                     p_description,
                                     p_write_off_status,
                                     p_write_off_completed_date,
                                     p_reversed_flag,
                                     p_source_exp_rep_header_id,
                                     p_created_by,
                                     p_source_type,
                                     p_payment_method_id,
                                     p_created_by,
                                     p_pay_company_id);
      --app头表关联交易
      UPDATE exp_report_headers h
         SET h.related_transactions = p_related_transactions,
             h.metting_type_code    = v_metting_type_code,
             h.contract_header_id   = p_contract_header_id,
             h.create_type          = p_create_type
       WHERE h.exp_report_header_id = p_exp_report_header_id;
    END IF;
  END;

  --app插入和更新计划付款行 mody by lqy-20180504
  PROCEDURE save_rep_pmt_schedules_intf(p_payment_schedule_line_id IN OUT NUMBER,
                                        p_exp_report_header_id     NUMBER,
                                        p_description              VARCHAR2,
                                        p_currency                 VARCHAR2,
                                        p_payee_category           VARCHAR2,
                                        p_payee_id                 NUMBER,
                                        p_account_number           VARCHAR2,
                                        p_account_name             VARCHAR2,
                                        p_payment_type_id          NUMBER,
                                        p_schedule_start_date      DATE,
                                        p_schedule_due_date        DATE,
                                        p_due_amount               NUMBER,
                                        p_bank_code                VARCHAR2,
                                        p_bank_name                VARCHAR2,
                                        p_bank_location_code       VARCHAR2,
                                        p_bank_location            VARCHAR2,
                                        p_province_code            VARCHAR2,
                                        p_province_name            VARCHAR2,
                                        p_city_code                VARCHAR2,
                                        p_city_name                VARCHAR2,
                                        p_usedes                   VARCHAR2, --付款用途代码
                                        p_document_id              NUMBER,
                                        p_document_line_id         NUMBER,
                                        p_user_id                  NUMBER,
                                        p_company_id               NUMBER,
                                        --modify 增加是否冻结字段
                                        p_frozen_flag VARCHAR2,
                                        --modify by Qu yuanyuan 增加托收账户字段
                                        p_collection_account_id NUMBER,
                                        p_gather_flag           VARCHAR2 DEFAULT 1) IS
    v_report_date DATE;
    c_schedule_due_date_error EXCEPTION;
  BEGIN
    SELECT h.report_date
      INTO v_report_date
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
    IF v_report_date > p_schedule_due_date THEN
      RAISE c_schedule_due_date_error;
    END IF;
  
    IF (p_payment_schedule_line_id IS NULL OR
       p_payment_schedule_line_id = '') THEN
      insert_rep_pmt_schedules(p_payment_schedule_line_id,
                               p_exp_report_header_id,
                               p_description,
                               p_currency,
                               p_payee_category,
                               p_payee_id,
                               p_account_number,
                               p_account_name,
                               p_payment_type_id,
                               p_schedule_start_date,
                               p_schedule_due_date,
                               p_due_amount,
                               p_bank_code,
                               p_bank_name,
                               p_bank_location_code,
                               p_bank_location,
                               p_province_code,
                               p_province_name,
                               p_city_code,
                               p_city_name,
                               p_usedes, --付款用途代码
                               p_document_id,
                               p_document_line_id,
                               p_user_id,
                               p_company_id,
                               --modify 增加是否冻结字段
                               p_frozen_flag,
                               --modify by Qu yuanyuan 增加托收账户字段
                               p_collection_account_id,
                               p_gather_flag);
    ELSE
      update_exp_rep_pmt_schedules(p_exp_report_header_id,
                                   p_payment_schedule_line_id,
                                   p_schedule_start_date,
                                   p_schedule_due_date,
                                   p_payee_category,
                                   p_payee_id,
                                   p_due_amount,
                                   p_account_number,
                                   p_account_name,
                                   p_payment_type_id,
                                   p_bank_code,
                                   p_bank_name,
                                   p_bank_location_code,
                                   p_bank_location,
                                   p_province_code,
                                   p_province_name,
                                   p_city_code,
                                   p_city_name,
                                   p_usedes,
                                   p_document_id,
                                   p_document_line_id,
                                   p_user_id,
                                   --modify 修改操作时的frozen_flag
                                   p_frozen_flag,
                                   --add wgf 2012/12/28
                                   p_description,
                                   --modify by Qu yuanyuan 增加托收账户字段
                                   p_collection_account_id,
                                   p_gather_flag);
    END IF;
  EXCEPTION
    WHEN c_schedule_due_date_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '计划付款日期不能小于报销日期',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'save_rep_pmt_schedules_intf');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'save_rep_pmt_schedules_intf');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END save_rep_pmt_schedules_intf;

  --校验报销单行机构是否有效  add by lqy@20180508
  PROCEDURE check_exp_report_lines_company(p_exp_report_header_id NUMBER,
                                           p_user_id              NUMBER) IS
    e_company_invalid_error EXCEPTION; --机构无效异常  
    v_count        NUMBER;
    v_company_code VARCHAR2(32); --机构代码
  BEGIN
    BEGIN
      SELECT COUNT(*), fc.company_code
        INTO v_count, v_company_code
        FROM exp_report_lines erl, fnd_companies fc
       WHERE erl.company_id = fc.company_id
         AND (fc.start_date_active > SYSDATE OR
             fc.end_date_active < SYSDATE)
         AND erl.exp_report_header_id = p_exp_report_header_id
       GROUP BY fc.company_code;
    EXCEPTION
      WHEN no_data_found THEN
        v_count := 0;
    END;
    IF v_count > 0 THEN
      RAISE e_company_invalid_error;
    END IF;
  EXCEPTION
    WHEN e_company_invalid_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => v_company_code ||
                                                                                  '机构已失效，请修改',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'check_exp_report_lines_company');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'check_exp_report_lines_company');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END;

  --校验电子发票是否重复   add by lqy@20180508                                   
  PROCEDURE check_elec_invoice_repeat(p_exp_report_header_id NUMBER,
                                      p_user_id              NUMBER) IS
    e_elec_invoice_repeat_error EXCEPTION; --电子发票重复 
    v_invoice_number    VARCHAR2(50);
    v_exp_report_number VARCHAR2(30);
    v_count             NUMBER;
    v_invoice_code      VARCHAR2(50);
  BEGIN
    FOR cur_lines IN (SELECT DISTINCT erl.invoice_number
                        FROM exp_report_lines erl
                       WHERE erl.exp_report_header_id =
                             p_exp_report_header_id) LOOP
      FOR cur_lines1 IN (SELECT DISTINCT erl.invoice_code
                           FROM exp_report_lines erl
                          WHERE erl.exp_report_header_id =
                                p_exp_report_header_id) LOOP
        BEGIN
          SELECT COUNT(*),
                 erl.invoice_number,
                 erh.exp_report_number,
                 erl.invoice_code
            INTO v_count,
                 v_invoice_number,
                 v_exp_report_number,
                 v_invoice_code
            FROM exp_report_lines      erl,
                 exp_report_headers    erh,
                 exp_ygz_invoice_types eyit
           WHERE erl.exp_report_header_id <> p_exp_report_header_id
             AND erl.exp_report_header_id = erh.exp_report_header_id
             AND erl.invoice_type = eyit.type_code
             AND eyit.einvoice_flag = 'Y'
             AND nvl(erh.reversed_flag, '1') <> 'W'
             AND erl.invoice_number = cur_lines.invoice_number
             AND erl.invoice_code = cur_lines1.invoice_code
             AND rownum = 1
           GROUP BY erl.invoice_number,
                    erh.exp_report_number,
                    erl.invoice_code;
        EXCEPTION
          WHEN no_data_found THEN
            v_count := 0;
        END;
        IF v_count > 0 THEN
          RAISE e_elec_invoice_repeat_error;
        END IF;
      END LOOP;
    END LOOP;
  EXCEPTION
    WHEN e_elec_invoice_repeat_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '发票号码' ||
                                                                                  v_invoice_number ||
                                                                                  '发票代码' ||
                                                                                  v_invoice_code ||
                                                                                  '已在单据' ||
                                                                                  v_exp_report_number ||
                                                                                  '报销过，请更换发票',
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'check_elec_invoice_repeat');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_user_id,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'check_elec_invoice_repeat');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END;

  --add by lqy
  --报销单行保存更新 for app
  PROCEDURE save_exp_rep_lines_intf(p_exp_report_header_id     NUMBER,
                                    p_line_number              NUMBER,
                                    p_city                     VARCHAR2,
                                    p_description              VARCHAR2,
                                    p_date_from                DATE,
                                    p_date_to                  DATE,
                                    p_period_name              VARCHAR2,
                                    p_currency_code            VARCHAR2,
                                    p_exchange_rate_type       VARCHAR2,
                                    p_exchange_rate_quotation  VARCHAR2,
                                    p_exchange_rate            NUMBER,
                                    p_expense_type_id          NUMBER,
                                    p_expense_item_id          NUMBER,
                                    p_budget_item_id           NUMBER,
                                    p_price                    NUMBER,
                                    p_primary_quantity         NUMBER,
                                    p_primary_uom              VARCHAR2,
                                    p_secondary_quantity       NUMBER,
                                    p_secondary_uom            VARCHAR2,
                                    p_report_amount            NUMBER,
                                    p_report_functional_amount NUMBER,
                                    p_distribution_set_id      NUMBER,
                                    p_company_id               NUMBER,
                                    p_unit_id                  NUMBER,
                                    p_position_id              NUMBER,
                                    p_responsibility_center_id NUMBER,
                                    p_employee_id              NUMBER,
                                    p_payee_category           VARCHAR2,
                                    p_payee_id                 NUMBER,
                                    p_partner_id               NUMBER,
                                    p_payment_flag             VARCHAR2,
                                    p_report_status            VARCHAR2,
                                    p_write_off_status         VARCHAR2,
                                    p_write_off_comleted_date  DATE,
                                    p_attachment_num           NUMBER,
                                    p_dimension1_id            NUMBER,
                                    p_dimension2_id            NUMBER,
                                    p_dimension3_id            NUMBER,
                                    p_dimension4_id            NUMBER,
                                    p_dimension5_id            NUMBER,
                                    p_dimension6_id            NUMBER,
                                    p_dimension7_id            NUMBER,
                                    p_dimension8_id            NUMBER,
                                    p_dimension9_id            NUMBER,
                                    p_dimension10_id           NUMBER,
                                    p_account_name             VARCHAR2,
                                    p_account_number           VARCHAR2,
                                    p_payment_type_id          NUMBER,
                                    p_payment_type             VARCHAR2,
                                    p_created_by               NUMBER,
                                    p_exp_report_line_id       IN OUT NUMBER,
                                    p_place_type_id            NUMBER,
                                    p_place_id                 NUMBER,
                                    p_tax_type_id              NUMBER,
                                    --更新部分添加字段
                                    p_last_updated_by            NUMBER,
                                    p_contract_header_id         NUMBER,
                                    p_payment_schedule_line_id   NUMBER,
                                    p_transportation             IN VARCHAR2 DEFAULT NULL,
                                    p_place_to_id                IN NUMBER DEFAULT NULL,
                                    p_invoice_type               VARCHAR2 DEFAULT NULL,
                                    p_special_invoice            VARCHAR2 DEFAULT NULL,
                                    p_invoice_number             VARCHAR2 DEFAULT NULL,
                                    p_invoice_status             VARCHAR2 DEFAULT NULL,
                                    p_tax_amount                 NUMBER DEFAULT NULL,
                                    p_sale_amount                NUMBER DEFAULT NULL,
                                    p_tax_rate                   NUMBER DEFAULT NULL,
                                    p_usage_type                 VARCHAR2 DEFAULT NULL,
                                    p_invoice_code               VARCHAR2 DEFAULT NULL,
                                    p_invoice_date               DATE DEFAULT NULL,
                                    p_input_tax_structure_detail VARCHAR2 DEFAULT NULL,
                                    --add by HJ
                                    p_income_period_from DATE DEFAULT NULL,
                                    p_income_period_to   DATE DEFAULT NULL,
                                    --SYX begin3
                                    p_vat_invoice_type VARCHAR2 DEFAULT NULL,
                                    --SYX end3
                                    p_exp_company_id         NUMBER DEFAULT NULL,
                                    p_special_sales          VARCHAR2 DEFAULT NULL,
                                    p_invoice_sum_amount     NUMBER DEFAULT NULL,
                                    p_invoice_tax_amount_bak NUMBER DEFAULT NULL,
                                    p_person_number          NUMBER DEFAULT NULL,
                                    p_day_number             NUMBER DEFAULT NULL,
                                    p_average_cost           NUMBER DEFAULT NULL,
                                    p_employee_levels_id     NUMBER DEFAULT NULL) IS
    v_apply_condition NUMBER;
    v_report_amount   NUMBER;
    e_report_amount_error EXCEPTION;
    v_tax_rate1     NUMBER;
    v_tax_rate2     NUMBER;
    v_tax_rate3     NUMBER;
    v_tax_rate4     NUMBER;
    v_dimension2_id NUMBER;
    e_tax_rate_error EXCEPTION;
  BEGIN
    SELECT nvl(tv.apply_condition, 0)
      INTO v_apply_condition
      FROM exp_expense_report_types_vl tv, exp_report_headers h
     WHERE tv.expense_report_type_id = h.exp_report_type_id
       AND h.exp_report_header_id = p_exp_report_header_id;
    SELECT nvl(SUM(l.report_amount), 0)
      INTO v_report_amount
      FROM exp_report_lines l
     WHERE l.exp_report_header_id = p_exp_report_header_id;
  
    IF v_apply_condition <> 0 THEN
      IF v_report_amount >= v_apply_condition THEN
        RAISE e_report_amount_error;
      END IF;
    END IF;
  
    IF p_special_invoice = 'Y' THEN
      IF p_sale_amount = 0 OR p_sale_amount IS NULL THEN
        v_tax_rate1 := 0;
      ELSE
        v_tax_rate1 := round(to_number(p_tax_amount) /
                             to_number(p_sale_amount),
                             3);
      END IF;
      v_tax_rate2 := v_tax_rate1 * 100;
      v_tax_rate3 := p_tax_rate - 0.2;
      v_tax_rate4 := p_tax_rate + 0.2;
      /*  if v_tax_rate2 < v_tax_rate3 or v_tax_rate2 > v_tax_rate4 then
        raise e_tax_rate_error;
      end if;*/
    END IF;
  
    SELECT h.related_transactions
      INTO v_dimension2_id
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
  
    IF (p_exp_report_line_id IS NULL OR p_exp_report_line_id = '') THEN
      insert_exp_report_lines(p_exp_report_header_id,
                              p_line_number,
                              p_city,
                              p_description,
                              p_date_from,
                              p_date_to,
                              p_period_name,
                              p_currency_code,
                              p_exchange_rate_type,
                              p_exchange_rate_quotation,
                              p_exchange_rate,
                              p_expense_type_id,
                              p_expense_item_id,
                              p_budget_item_id,
                              p_price,
                              p_primary_quantity,
                              p_primary_uom,
                              p_secondary_quantity,
                              p_secondary_uom,
                              p_report_amount,
                              p_report_functional_amount,
                              p_distribution_set_id,
                              p_company_id,
                              p_unit_id,
                              p_position_id,
                              p_responsibility_center_id,
                              p_employee_id,
                              p_payee_category,
                              p_payee_id,
                              p_partner_id,
                              p_payment_flag,
                              p_report_status,
                              p_write_off_status,
                              p_write_off_comleted_date,
                              p_attachment_num,
                              p_dimension1_id,
                              v_dimension2_id,
                              p_dimension3_id,
                              p_dimension4_id,
                              p_dimension5_id,
                              p_dimension6_id,
                              p_dimension7_id,
                              p_dimension8_id,
                              p_dimension9_id,
                              p_dimension10_id,
                              p_account_name,
                              p_account_number,
                              p_payment_type_id,
                              p_payment_type,
                              p_created_by,
                              p_exp_report_line_id,
                              p_place_type_id,
                              p_place_id,
                              p_tax_type_id,
                              p_transportation,
                              p_place_to_id,
                              p_invoice_type,
                              p_invoice_number,
                              p_invoice_status,
                              nvl(p_tax_amount, 0),
                              nvl(p_sale_amount, 0),
                              p_tax_rate,
                              p_usage_type,
                              p_invoice_code,
                              p_invoice_date,
                              p_input_tax_structure_detail,
                              --p_income_period_from,
                              --p_income_period_to,
                              --p_vat_invoice_type
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              p_exp_company_id,
                              p_special_sales,
                              p_invoice_sum_amount,
                              p_invoice_tax_amount_bak,
                              p_person_number,
                              p_day_number,
                              p_average_cost,
                              p_employee_levels_id);
    ELSE
      update_exp_report_lines(p_exp_report_line_id,
                              p_exp_report_header_id,
                              p_line_number,
                              p_city,
                              p_description,
                              p_date_from,
                              p_date_to,
                              p_expense_type_id,
                              p_expense_item_id,
                              p_budget_item_id,
                              p_price,
                              p_primary_quantity,
                              p_primary_uom,
                              p_secondary_quantity,
                              p_secondary_uom,
                              p_report_amount,
                              p_report_functional_amount,
                              p_distribution_set_id,
                              p_company_id,
                              p_unit_id,
                              p_position_id,
                              p_responsibility_center_id,
                              p_employee_id,
                              p_payee_category,
                              p_payee_id,
                              p_partner_id,
                              p_payment_flag,
                              p_attachment_num,
                              p_dimension1_id,
                              v_dimension2_id,
                              p_dimension3_id,
                              p_dimension4_id,
                              p_dimension5_id,
                              p_dimension6_id,
                              p_dimension7_id,
                              p_dimension8_id,
                              p_dimension9_id,
                              p_dimension10_id,
                              p_account_name,
                              p_account_number,
                              p_payment_type_id,
                              p_payment_type,
                              p_last_updated_by,
                              p_exchange_rate,
                              p_currency_code,
                              p_period_name,
                              p_exchange_rate_type,
                              p_exchange_rate_quotation,
                              p_place_type_id,
                              p_place_id,
                              p_contract_header_id,
                              p_payment_schedule_line_id,
                              p_tax_type_id,
                              p_transportation,
                              p_place_to_id,
                              p_invoice_type,
                              p_invoice_number,
                              p_invoice_status,
                              nvl(p_tax_amount, 0),
                              nvl(p_sale_amount, 0),
                              p_tax_rate,
                              p_usage_type,
                              p_invoice_code,
                              p_invoice_date,
                              p_input_tax_structure_detail,
                              --p_income_period_from,
                              --p_income_period_to,
                              --p_vat_invoice_type
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              p_exp_company_id,
                              p_special_sales,
                              p_invoice_sum_amount,
                              p_invoice_tax_amount_bak,
                              p_person_number,
                              p_day_number,
                              p_average_cost,
                              p_employee_levels_id);
    END IF;
  EXCEPTION
    WHEN e_report_amount_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '报销金额超过' ||
                                                                                  v_apply_condition ||
                                                                                  '请从申请单创建报销单',
                                                     p_created_by              => p_last_updated_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'save_exp_rep_lines_intf');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN e_tax_rate_error THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => '发票税率维护错误，请修改',
                                                     p_created_by              => p_last_updated_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'save_exp_rep_lines_intf');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
    WHEN OTHERS THEN
      sys_raise_app_error_pkg.raise_sys_others_error(p_message                 => dbms_utility.format_error_backtrace || ' ' ||
                                                                                  SQLERRM,
                                                     p_created_by              => p_last_updated_by,
                                                     p_package_name            => 'exp_report_pkg',
                                                     p_procedure_function_name => 'save_exp_rep_lines_intf');
    
      raise_application_error(sys_raise_app_error_pkg.c_error_number,
                              sys_raise_app_error_pkg.g_err_line_id);
  END save_exp_rep_lines_intf;

  PROCEDURE create_exp_report_from_req(p_exp_requisition_dists_id NUMBER,
                                       p_exp_requisition_line_id  NUMBER,
                                       p_exp_report_header_id     NUMBER,
                                       p_user_id                  NUMBER) IS
    v_payment_method           VARCHAR2(100);
    v_payment_method_id        NUMBER;
    v_period_name              VARCHAR2(100);
    v_payment_flag             VARCHAR2(100);
    v_exp_report_line_id       NUMBER;
    v_exp_requisition_dists_id NUMBER;
    v_line_number              NUMBER;
    v_invoice_type             VARCHAR2(20);
    CURSOR cur_invoic_type IS
      SELECT eyit.einvoice_flag   einvoice_flag,
             eyit.special_invoice special_invoice
        FROM exp_report_lines l, exp_ygz_invoice_types eyit
       WHERE l.invoice_type = eyit.type_code
         AND l.exp_report_header_id = p_exp_report_header_id;
    CURSOR req_data IS
      SELECT (nvl(d.requisition_amount, 0) - nvl(d.released_amount, 0)) report_amount,
             (CASE
               WHEN d.primary_quantity > d.released_quantity THEN
                d.primary_quantity - d.released_quantity
               ELSE
                1
             END) primary_quantity,
             (nvl(d.requisition_amount, 0) - nvl(d.released_amount, 0)) /
             (CASE
               WHEN d.primary_quantity > d.released_quantity THEN
                d.primary_quantity - d.released_quantity
               ELSE
                1
             END) price,
             d.expense_type_id,
             d.company_id,
             d.unit_id,
             d.position_id,
             (SELECT iv.expense_item_id
                FROM exp_expense_items_vl iv
               WHERE iv.req_item_id = l.exp_req_item_id
                 AND rownum = 1) expense_item_id,
             nvl(d.requisition_functional_amount, 0) -
             nvl(d.released_functional_amount, 0) report_functional_amount,
             d.dimension1_id e1,
             (SELECT er.default_dim_value_id
                FROM exp_rep_ref_dimensions  er,
                     fnd_dimension_values_vl fdv,
                     fnd_dimensions_vl       fv
               WHERE er.dimension_id = fv.dimension_id
                 AND er.default_dim_value_id = fdv.dimension_value_id(+)
                 AND er.layout_position = 'DOCUMENTS_LINE'
                 AND expense_report_type_id =
                     (SELECT h.exp_report_type_id
                        FROM exp_report_headers h
                       WHERE h.exp_report_header_id = p_exp_report_header_id)
                 AND fv.dimension_sequence = 2) e2,
             (SELECT er.default_dim_value_id
                FROM exp_rep_ref_dimensions  er,
                     fnd_dimension_values_vl fdv,
                     fnd_dimensions_vl       fv
               WHERE er.dimension_id = fv.dimension_id
                 AND er.default_dim_value_id = fdv.dimension_value_id(+)
                 AND er.layout_position = 'DOCUMENTS_LINE'
                 AND expense_report_type_id =
                     (SELECT h.exp_report_type_id
                        FROM exp_report_headers h
                       WHERE h.exp_report_header_id = p_exp_report_header_id)
                 AND fv.dimension_sequence = 3) e3,
             d.dimension4_id e4,
             d.dimension5_id e5,
             d.dimension6_id e6,
             d.dimension7_id e7,
             d.dimension8_id e8,
             d.dimension9_id e9,
             d.dimension10_id e10,
             ('报销' ||
             (SELECT ev.description
                 FROM exp_expense_items_vl ev, exp_company_expense_items ei
                WHERE ev.req_item_id = l.exp_req_item_id
                  AND ei.expense_item_id = ev.expense_item_id
                  AND ei.enabled_flag = 'Y'
                  AND rownum = 1) ||
             (nvl(d.requisition_amount, 0) - nvl(d.released_amount, 0)) || '元') description,
             d.currency_code,
             d.period_name,
             d.exchange_rate_type,
             d.exchange_rate_quotation,
             d.exchange_rate,
             d.responsibility_center_id,
             d.employee_id,
             l.date_from,
             l.date_to,
             l.place_id,
             l.place_type_id,
             l.place_to_id,
             (SELECT vvt.place_desc
                FROM exp_policy_places_vl vvt
               WHERE vvt.place_id = l.place_id) place_from,
             (SELECT vvtl.description
                FROM exp_policy_place_types_vl vvtl
               WHERE vvtl.place_type_id = l.place_type_id) place_type,
             (SELECT vvt.place_desc
                FROM exp_policy_places_vl vvt
               WHERE vvt.place_id = l.place_to_id) place_to
        FROM exp_requisition_dists d, exp_requisition_lines l
       WHERE l.exp_requisition_line_id = d.exp_requisition_line_id
         AND l.exp_requisition_line_id = p_exp_requisition_line_id;
  
  BEGIN
    SELECT nvl(MAX(l.line_number), 0)
      INTO v_line_number
      FROM exp_report_lines l
     WHERE l.exp_report_header_id = p_exp_report_header_id;
    SELECT h.payment_method_id,
           (SELECT description
              FROM csh_payment_methods_vl vv
             WHERE vv.payment_method_id = h.payment_method_id) exp_report_payment_method,
           h.period_name,
           (SELECT tv.payment_flag
              FROM exp_expense_report_types_vl tv
             WHERE tv.expense_report_type_id = h.exp_report_type_id) payment_flag
      INTO v_payment_method_id,
           v_payment_method,
           v_period_name,
           v_payment_flag
      FROM exp_report_headers h
     WHERE h.exp_report_header_id = p_exp_report_header_id;
  
    FOR c_req_data IN req_data LOOP
      insert_exp_report_lines(p_exp_report_header_id,
                              (v_line_number + 10),
                              NULL,
                              c_req_data.description,
                              c_req_data.date_from,
                              c_req_data.date_to,
                              v_period_name,
                              c_req_data.currency_code,
                              c_req_data.exchange_rate_type,
                              c_req_data.exchange_rate_quotation,
                              c_req_data.exchange_rate,
                              c_req_data.expense_type_id,
                              c_req_data.expense_item_id,
                              NULL,
                              c_req_data.price,
                              c_req_data.primary_quantity,
                              NULL,
                              NULL,
                              NULL,
                              c_req_data.report_amount,
                              c_req_data.report_functional_amount,
                              NULL,
                              c_req_data.company_id,
                              c_req_data.unit_id,
                              c_req_data.position_id,
                              c_req_data.responsibility_center_id,
                              c_req_data.employee_id,
                              NULL,
                              NULL,
                              NULL,
                              v_payment_flag,
                              'GENERATE',
                              'N',
                              NULL,
                              NULL,
                              c_req_data.e1,
                              c_req_data.e2,
                              c_req_data.e3,
                              c_req_data.e4,
                              c_req_data.e5,
                              c_req_data.e6,
                              c_req_data.e7,
                              c_req_data.e8,
                              c_req_data.e9,
                              c_req_data.e10,
                              NULL,
                              NULL,
                              v_payment_method_id,
                              v_payment_method,
                              p_user_id,
                              v_exp_report_line_id,
                              c_req_data.place_type_id,
                              c_req_data.place_id,
                              NULL,
                              NULL,
                              c_req_data.place_to_id,
                              '08',
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL,
                              NULL);
      exp_report_pkg.create_manual_exp_req_relation(p_exp_requisition_dists_id,
                                                    v_exp_report_line_id,
                                                    p_user_id);
    END LOOP;
    exp_report_pkg.resert_exp_rep_line_number(p_exp_report_header_id,
                                              p_user_id);
    exp_report_pkg.create_exp_rep_pmt_schd_intf(p_exp_report_header_id,
                                                p_user_id);
    exp_report_pkg.check_exp_report_lines_company(p_exp_report_header_id,
                                                  p_user_id);
    exp_report_pkg.check_elec_invoice_repeat(p_exp_report_header_id,
                                             p_user_id);
    FOR v_invoice_type IN cur_invoic_type LOOP
      IF v_invoice_type.einvoice_flag = 'Y' OR
         v_invoice_type.special_invoice = 'Y' THEN
        UPDATE exp_report_headers h
           SET h.vat_special_invoice_include = 'Y'
         WHERE h.exp_report_header_id = p_exp_report_header_id;
        RETURN;
      END IF;
      UPDATE exp_report_headers h
         SET h.vat_special_invoice_include = 'N'
       WHERE h.exp_report_header_id = p_exp_report_header_id;
    END LOOP;
  END;
  FUNCTION exp_write_off_amount_check(p_exp_report_header_id NUMBER)
    RETURN VARCHAR2 IS
    v_report_amount   NUMBER;
    v_write_of_amount NUMBER;
    v_flag            VARCHAR2(1);
  BEGIN
  
    SELECT SUM(report_functional_amount)
      INTO v_report_amount
      FROM exp_report_lines
     WHERE exp_report_header_id = p_exp_report_header_id
     GROUP BY exp_report_header_id;
  
    SELECT nvl(SUM(w.csh_write_off_amount), 0)
      INTO v_write_of_amount
      FROM csh_write_off w
     WHERE w.document_source = 'EXPENSE_REPORT'
       AND w.document_header_id = p_exp_report_header_id
       AND w.write_off_type = 'PREPAYMENT_EXPENSE_REPORT';
  
    IF v_report_amount > v_write_of_amount THEN
      v_flag := 'Y';
    ELSE
      v_flag := 'N';
    END IF;
  
    RETURN v_flag;
  
  END exp_write_off_amount_check;
END exp_report_pkg;
/
