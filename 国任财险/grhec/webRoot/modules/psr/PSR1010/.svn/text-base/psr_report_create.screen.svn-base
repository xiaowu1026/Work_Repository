<?xml version="1.0" encoding="UTF-8"?>
<a:screen xmlns:a="http://www.aurora-framework.org/application" trace="true">
    <a:init-procedure>
        <a:model-query fetchAll="true" model="basic.hls_sys_time_default_value" rootPath="default_value_path"/>
        <a:model-query autoCount="false" defaultwhereclause="default_table_flag=&apos;Y&apos;" fetchAll="true" model="psr.PSR1010.psr_base_tables" rootPath="default_table"/>
        <a:model-query defaultWhereClause="report_header_id=${/parameter/@report_header_id}" fetchAll="true" model="psr.PSR1010.psr_report_fields" rootPath="fields"/>
        <a:model-query defaultWhereClause="t.layout_code=&apos;RPT_CATALOG_&apos;||${/parameter/@report_header_id}" fetchAll="true" model="psr.PSR1010.psr_report_column_query" rootPath="select_parameter_path"/>
        <a:model-query defaultWhereClause="t.layout_code=&apos;RPT_CATALOG&apos; and not exists(select 1 from hls_doc_layout_config hdlc where hdlc.layout_code=&apos;RPT_CATALOG_&apos;||${/parameter/@report_header_id} and hdlc.tab_code=hdlc.layout_code and hdlc.column_name=d.column_name)" fetchAll="true" model="psr.PSR1010.psr_report_column_query" rootPath="category_parameter_path"/>
    </a:init-procedure>
    <a:view>
        <div/>
        <a:link id="psr_report_datarelation" url="${/request/@context_path}/modules/psr/PSR1010/psr_report_datarelation.screen"/>
        <a:link id="psr_report_field_selection" url="${/request/@context_path}/modules/psr/PSR1010/psr_report_field_selection.screen"/>
        <a:link id="psr_report_add_expression" url="${/request/@context_path}/modules/psr/PSR1010/psr_report_add_expression.screen"/>
        <a:link id="psr_report_field_editor" url="${/request/@context_path}/modules/psr/PSR1010/psr_report_field_editor.screen"/>
        <a:link id="psr_report_add_condition" url="${/request/@context_path}/modules/psr/PSR1010/psr_report_add_condition.screen"/>
        <a:link id="psr_report_save" url="${/request/@context_path}/modules/psr/PSR1010/psr_report_save.svc"/>
        <a:link id="psr_report_create" url="${/request/@context_path}/modules/psr/PSR1010/psr_report_create.screen"/>
        <a:link id="psr_report_test" url="${/request/@context_path}/modules/psr/PSR1010/psr_report_test.svc"/>
        <a:link id="psr_report_parameter_preview_create_dynamic" url="${/request/@context_path}/modules/psr/PSR1020/psr_report_parameter_preview_dynamic.screen"/>
        <a:link id="psr_report_preview_create_link" url="${/request/@context_path}/modules/psr/PSR1010/psr_report_preview.screen"/>
        <a:link id="psr_report_output_create" url="${/request/@context_path}/modules/psr/PSR1010/psr_report_output.svc"/>
        <a:link id="psr_report_table_selection_link" url="${/request/@context_path}/modules/psr/PSR1040/psr_report_base_table_selection.screen"/>
        <a:link id="psr_report_field_style_link" url="${/request/@context_path}/modules/psr/PSR1010/psr_report_field_style.screen"/>
        <a:link id="psr_report_parameter_create_dynamic" url="${/request/@context_path}/modules/psr/PSR1020/psr_report_parameter_dynamic.screen"/>
        <style><![CDATA[
        	.item-btn-icon div{
        	    padding-left:26px;
        	}
        ]]></style>
        <script><![CDATA[
            var step = 0;
            var styles_data = [];
            var current_index = 0;
            var forward_index = 0;
            
            //删除
            
            
            function delFunction(index, dataSetName) {
                var dataSet = $(dataSetName);
                var record = dataSet.find('line_number', index);
                dataSet.remove(record);
            }
            
            function step_0NextStep() {
                var headers_ds = $('psr_report_headers_ds');
                var record = headers_ds.getAt(0);
                var report_type = typeof(record.get('report_type')) == 'undefined' ? 0 : record.get('report_type');
            
                if (report_type == 0 || report_type == '') {
                    Aurora.showMessage('提示', '请确认报表类型！');
                } else {
                    nextStep();
                }
            }
            
            function step_1NextStep() {
                var tables_ds = $('psr_report_tables_ds'),
                    headers_ds = $('psr_report_headers_ds'),
                    header_record = headers_ds.getCurrentRecord();
                var fieldRecords = tables_ds.getAll();
                //var report_type = typeof(record.get('report_type')) == 'undefined' ? 0 : record.get('report_type');
                var fieldLength = fieldRecords.length;
                if (fieldLength < 1 && !header_record.get('sql_statement')) {
                    Aurora.showMessage('提示', '请添加数据源！');
            
                    //nodeDetailTempUnLockScreen();
                } else {
                    if (header_record.get('report_type') == 'USERDEFINE_REPORT') {
                        nextStep();
                        nextStep();
                    }
                    nextStep();
                }
            }
            
            function step_3NextStep() {
                var headers_ds = $('psr_report_headers_ds');
                var record = headers_ds.getAt(0);
                var report_type = typeof(record.get('report_type')) == 'undefined' ? 0 : record.get('report_type');
            
                if (report_type == 'CONDITION_REPORT') {
                    nextStep();
                    nextStep();
                } else {
                    nextStep();
                }
            }
            
            function step_4NextStep() {
                var groups_ds = $('psr_report_groups_ds');
                var orders_ds = $('psr_report_orders_ds');
                if (dataSetValidate(groups_ds) && dataSetValidate(orders_ds)) {
                    nextStep();
                }
            }
            
            function step_5UpStep() {
                var headers_ds = $('psr_report_headers_ds');
                var record = headers_ds.getAt(0);
                var report_type = typeof(record.get('report_type')) == 'undefined' ? 0 : record.get('report_type');
                if (report_type == 'CONDITION_REPORT') {
                    upStep();
                    upStep();
                } else if (report_type == 'USERDEFINE_REPORT') {
                    upStep();
                    upStep();
                    upStep();
                } else {
                    upStep();
                }
            }
            
            //下一步
            
            function nextStep() {
                var stepTabPanel = $('step');
            
                step = step + 1;
                // stepTabPanel.setEnabled(step);
                stepTabPanel.selectTab(step);
                // stepTabPanel.setDisabled(step - 1);
            }
            //上一步
            
            function upStep() {
                var stepTabPanel = $('step');
            
                step = step - 1;
                // stepTabPanel.setEnabled(step);
                stepTabPanel.selectTab(step);
                // stepTabPanel.setDisabled(step + 1);
            
            }
            //取消
            
            function cancelFun() {
                Aurora.showConfirm('提示', '确定取消？', function okFun() {
                    window.location.href = $('psr_report_create').getUrl();
                }, function canFun() {});
            }
            
            
            //保存
            
            function saveFun() {
                Aurora.showConfirm('提示', '确定保存？', function okFun() {
                    $('saveFun_id').disable();
                    nodeDetailTempLockScreen();
                    var headers_ds = $('psr_report_headers_ds');
                    var tables_ds = $('psr_report_tables_ds');
                    var fields_ds = $('psr_report_fields_ds');
                    var fieldRecords = fields_ds.getAll();
                    var fieldLength = fieldRecords.length;
                    var conditions_ds = $('psr_report_conditions_ds');
                    var groups_ds = $('psr_report_groups_ds');
                    var orders_ds = $('psr_report_orders_ds');
                    var aut_trx_user_report_ds = $('aut_trx_user_report_ds');
                    var psr_report_layout_select_ds = $('psr_report_layout_select_ds');
            
            
                    if (dataSetValidate(headers_ds)) {
            
                        if (fieldLength < 1) {
                            Aurora.showMessage('提示', '请添加显示字段！');
            
                            var stepTabPanel = $('step');
                            step = 2;
                            // stepTabPanel.setEnabled(step);
                            stepTabPanel.selectTab(step);
                            // stepTabPanel.setDisabled(5);
            
                            $('saveFun_id').enable();
                            nodeDetailTempUnLockScreen();
                        } else {
                            var header_record = headers_ds.getAt(0);
                            var tmp = [];
                            for (var i = 0;i < styles_data.length;i++) {
                                tmp[i] = styles_data[i];
                            }
                            var parameter_records = $('psr_report_layout_select_ds').getAll();
                            var parameter_flag;
                            if (parameter_records.length != 0) {
                                parameter_flag = 'Y';
                            } else {
                                parameter_flag = 'N';
                            }
                            var synchronization_flag;
                            if (header_record.get('unsynchronization_flag') == 'Y') {
                                synchronization_flag = 'N';
                            } else {
                                synchronization_flag = 'Y';
                            }
                            Aurora.request({
                                url: $('psr_report_save').getUrl(),
                                para: {
                                    report_header_id: header_record.get('report_header_id'),
                                    report_header_name: header_record.get('report_header_name'),
                                    parameter_flag: parameter_flag,
                                    synchronization_flag: synchronization_flag,
                                    layout_code: header_record.get('layout_code'),
                                    report_header_description: header_record.get('report_header_description'),
                                    view_range: header_record.get('view_range'),
                                    report_type: header_record.get('report_type'),
                                    sql_statement: header_record.get('sql_statement'),
                                    fixed_time_flag: header_record.get('fixed_time_flag'),
                                    start_date: header_record.get('start_date'),
                                    push_cycle: header_record.get('push_cycle'),
                                    other_report_flag: header_record.get('other_report_flag'),
                                    other_report_header_id: header_record.get('other_report_header_id'),
                                    tables: tables_ds.getJsonData(),
                                    fields: fields_ds.getJsonData(),
                                    conditions: conditions_ds.getJsonData(),
                                    groups: groups_ds.getJsonData(),
                                    orders: orders_ds.getJsonData(),
                                    aut_trx_report: aut_trx_user_report_ds.getJsonData(),
                                    layout_detail: psr_report_layout_select_ds.getJsonData(),
                                    styles: tmp
                                },
                                success: function(res) {
                                    var report_header_id = res.result.report_header_id;
                                    allQuery(report_header_id, 'Y');
                                    document.getElementById("other_button_id").style.display = "";
                                    document.getElementById("sql_statement_id").style.display = "";
                                    $('saveFun_id').enable();
                                    nodeDetailTempUnLockScreen();
                                },
                                error: function() {
                                    $('saveFun_id').enable();
                                    document.getElementById("other_button_id").style.display = "none";
                                    document.getElementById("sql_statement_id").style.display = "none";
                                    nodeDetailTempUnLockScreen();
                                }
                            });
            
                        }
                    } else {
                        $('saveFun_id').enable();
                    }
            
                });
            }
            
            //数据验证
            
            function dataSetValidate(dataSet) {
                var validate = dataSet.validate();
                return validate;
            }
            //设置行号
            
            function setLineNumber(dataSet, record, index) {
                var records = dataSet.getAll();
                var number = 0;
                if (records.length > 0) {
                    for (var i = 0;i < records.length;i++) {
                        number = (i + 1) * 10;
                        records[i].set('line_number', number);
                    }
                } else {
                    number = index * 10;
                    record.set('line_number', number);
                }
            }
            //字段行号
            
            function report_groups_setLineNumber(dataSet, record, index) {
                var records = dataSet.getAll();
                var number = 0;
                if (records.length > 0) {
                    for (var i = 0;i < records.length;i++) {
                        number = (i + 1);
                        records[i].set('line_number', number);
                    }
                } else {
                    number = index;
                    record.set('line_number', number);
                }
            }
            
            //数据显示
            
            function tableNameFun(value, record, name) {
                var table_name = record.get('table_name');
                var line_number = record.get('line_number');
                var table_description = record.get('table_description');
                var table_alias = record.get('table_alias');
                return '<a href="javascript:fieldSelectionFun(' + line_number + ')">' + table_name + '-' + table_description + '</a>';
            }
            
            //报表显示字段选择
            
            function fieldSelectionFun(line_number) {
                new Aurora.Window({
                    id: 'report_field_selection_win',
                    closeable: false,
                    url: $('psr_report_field_selection').getUrl() + '?line_number=' + line_number,
                    title: '字段选择',
                    height: 450,
                    width: 480
                });
            }
            
            //关联表
            
            function addTableFun(value, record, name) {
            
                var datarelation_ds = $('psr_report_tables_ds');
                var index = datarelation_ds.indexOf(record);
                return '<a href="javascript:addTableFunction(' + index + ')">关联</a>';
            }
            
            function addTableFunction(index) {
            
                new Aurora.Window({
                    id: 'report_datarelation_win',
                    closeable: false,
                    url: $('psr_report_datarelation').getUrl() + '?index=' + index,
                    title: '表关联',
                    height: 425,
                    width: 480
                });
            }
            //去关联表
            
            function delTableFun(value, record, name) {
                var table_name = record.get('table_name');
                var line_number = record.get('line_number');
                if (line_number == 10) {
                    return '';
                }
                return '<a href="javascript:delTableFunction(\'' + line_number + '\')">删除</a>';
            }
            
            function delTableFunction(line_number) {
                Aurora.showConfirm('提示', '是否删除？', function okFun() {
                    var report_tables_ds = $('psr_report_tables_ds');
                    var record = report_tables_ds.find('line_number', line_number);
                    var table_name = record.get('table_name');
                    var table_alias = record.get('table_alias');
                    //移除显示字段
            
                    var report_fields_ds = $('psr_report_fields_ds');
                    var report_fields_selection_ds = $('psr_report_fields_selection_ds');
                    var report_conditions_ds = $('psr_report_conditions_ds');
                    var report_groups_ds = $('psr_report_groups_ds');
                    var report_orders_ds = $('psr_report_orders_ds');
            
            
            
                    batchDelFunction(table_alias, 'field_name', report_orders_ds);
                    batchDelFunction(table_alias, 'field_name', report_groups_ds);
                    batchDelFunction(table_alias, 'field_1', report_conditions_ds);
                    batchDelFunction(table_alias, 'field_2', report_conditions_ds);
                    batchDelFunction(table_alias, 'field_name', report_fields_selection_ds);
                    batchDelFunction(table_alias, 'field_name', report_fields_ds);
            
            
                    //移除显示
                    report_tables_ds.remove(record);
                });
            
            }
            
            //清除 表 相关 字段
            
            function batchDelFunction(table_alias, name, dataSet) {
                var records = dataSet.getAll();
                var length = records.length;
                var del_ds = $('psr_report_del_ds');
                var index, field_name;
            
                for (var j = 0;j < length;j++) {
            
                    var record = records[j];
                    field_name = record.get(name);
                    index = field_name.indexOf('.');
                    if (table_alias == field_name.substring(0, index)) {
                        del_ds.add(new Aurora.Record({
                            line_number: record.get('line_number')
                        }));
                    }
                }
            
            
                var dRecords = del_ds.getAll();
                for (var i = 0;i < dRecords.length;i++) {
                    dataSet.remove(dataSet.find('line_number', dRecords[i].get('line_number')));
                }
                del_ds.removeAll();
            
            }
            
            
            
            function test() {
                Aurora.showMessage('提示', '开发中...');
            }
            
            //字段编辑  编辑
            
            
            function fieldEditorFun(value, record, name) {
                var dataSet = $('psr_report_fields_ds');
                var index = record.get('line_number'); //indexOf(record);
                var field_category = record.get('field_category');
                if (field_category == 'FIELD') {
                    return '<a href="javascript:fieldEditorFunction(' + index + ')">编辑</a>';
                } else {
                    return '<a href="javascript:editorExpressionFunction(' + index + ')">编辑</a>';
                }
            }
            
            function fieldEditorFunction(index) {
                new Aurora.Window({
                    id: 'report_field_editor_win',
                    closeable: false,
                    url: $('psr_report_field_editor').getUrl() + '?index=' + index,
                    title: '字段编辑',
                    height: 250,
                    width: 480
                });
            }
            
            //编辑表达式
            
            function editorExpressionFunction(index) {
                new Aurora.Window({
                    id: 'report_add_expression_win',
                    closeable: false,
                    url: $('psr_report_add_expression').getUrl() + '?index=' + index,
                    title: '编辑表达式',
                    height: 300,
                    width: 480
                });
            }
            
            //排序
            
            
            // function fieldSeqencingFun(value, record, name) {
            // var dataSet = $('psr_report_fields_ds');
            // var index = dataSet.indexOf(record);
            // return "<a href='javascript:upFun(" + index + ",\"psr_report_fields_ds\")'>上移</a>&nbsp;&nbsp;<a href='javascript:downFun(" + index + ",\"psr_report_fields_ds\")'>下移</a>";
            // }
            
            function fieldDownFun() {
                var dataSet = $('psr_report_fields_ds');
                var record = dataSet.getCurrentRecord();
                var index = dataSet.indexOf(record);
            
                downFun(index, 'psr_report_fields_ds');
            }
            
            function fieldUpFun() {
                var dataSet = $('psr_report_fields_ds');
                var record = dataSet.getCurrentRecord();
                var index = dataSet.indexOf(record);
            
                upFun(index, 'psr_report_fields_ds');
            }
            
            // function groupSeqencingFun(value, record, name) {
            // var dataSet = $('psr_report_groups_ds');
            // var index = dataSet.indexOf(record);
            // return "<a href='javascript:upFun(" + index + ",\"psr_report_groups_ds\")'>上移</a>&nbsp;&nbsp;<a href='javascript:downFun(" + index + ",\"psr_report_groups_ds\")'>下移</a>";
            // }
            
            function groupDownFun() {
                var dataSet = $('psr_report_groups_ds');
                var record = dataSet.getCurrentRecord();
                var index = dataSet.indexOf(record);
            
                downFun(index, 'psr_report_groups_ds');
            }
            
            function groupUpFun() {
                var dataSet = $('psr_report_groups_ds');
                var record = dataSet.getCurrentRecord();
                var index = dataSet.indexOf(record);
            
                upFun(index, 'psr_report_groups_ds');
            }
            
            // function orderSeqencingFun(value, record, name) {
            // var dataSet = $('psr_report_orders_ds');
            // var index = dataSet.indexOf(record);
            // return "<a href='javascript:upFun(" + index + ",\"psr_report_orders_ds\")'>上移</a>&nbsp;&nbsp;<a href='javascript:downFun(" + index + ",\"psr_report_orders_ds\")'>下移</a>";
            // }
            
            function orderDownFun() {
                var dataSet = $('psr_report_orders_ds');
                var record = dataSet.getCurrentRecord();
                var index = dataSet.indexOf(record);
            
                downFun(index, 'psr_report_orders_ds');
            }
            
            function orderUpFun() {
                var dataSet = $('psr_report_orders_ds');
                var record = dataSet.getCurrentRecord();
                var index = dataSet.indexOf(record);
            
                upFun(index, 'psr_report_orders_ds');
            }
            
            
            //下移
            
            function downFun(index, name) {
                var dataSet = $(name);
                var record = dataSet.getAt(index);
                var nextIndex = index + 1;
                var nextRecord = dataSet.getAt(nextIndex);
                recordsexchange(record, nextRecord, name);
                dataSet.next();
                dataSet.select(nextRecord);
                setLineNumber(dataSet, record, index);
            }
            
            //上移
            
            function upFun(index, name) {
                var dataSet = $(name);
                var record = dataSet.getAt(index);
                var preIndex = index - 1;
                var preRecord = dataSet.getAt(preIndex);
                recordsexchange(record, preRecord, name);
                dataSet.pre();
            
                dataSet.select(preRecord);
                setLineNumber(dataSet, record, index);
            }
            
            // 数据交换
            
            function recordsexchange(r1, r2, name) {
                var newRecord;
                if (name == 'psr_report_fields_ds') {
                    newRecord = new Aurora.Record({
                        report_field_id: r1.get('report_field_id'),
                        line_number: r1.get('line_number'),
                        report_header_id: r1.get('report_header_id'),
                        table_name: r1.get('table_name'),
                        field_name: r1.get('field_name'),
                        report_fields_dis: r1.get('report_fields_dis'),
                        field_description: r1.get('field_description'),
                        field_description_dis: r1.get('field_description_dis'),
                        field_type: r1.get('field_type'),
                        field_type_dis: r1.get('field_type_dis'),
                        field_size: r1.get('field_size'),
                        field_decimal: r1.get('field_decimal'),
                        field_category: r1.get('field_category'),
                        field_category_dis: r1.get('field_category_dis'),
                        statistics_type: r1.get('statistics_type'),
                        subtotal_type: r1.get('subtotal_type'),
                        aggregate_function_flag: r1.get('aggregate_function_flag')
            
                    });
            
                } else if (name == 'psr_report_groups_ds') {
                    newRecord = new Aurora.Record({
                        report_group_id: r1.get('report_group_id'),
                        line_number: r1.get('line_number'),
                        report_header_id: r1.get('report_header_id'),
                        table_name: r1.get('table_name'),
                        field_name: r1.get('field_name'),
                        field_description: r1.get('field_description'),
                        field_line_number: r1.get('field_line_number'),
                        group_description: r1.get('group_description')
                    });
                } else if (name == 'psr_report_orders_ds') {
                    newRecord = new Aurora.Record({
                        report_order_id: r1.get('report_order_id'),
                        line_number: r1.get('line_number'),
                        report_header_id: r1.get('report_header_id'),
                        table_name: r1.get('table_name'),
                        field_name: r1.get('field_name'),
                        field_description: r1.get('field_description')
            
                    });
                }
                r1.setObject(r2.data);
                r2.setObject(newRecord.data);
            }
            
            //字段编辑 删除
            
            
            function fieldSDelFun(value, record, name) {
            
                var dataSet = $('psr_report_fields_selection_ds');
                var field_name = record.get('field_name'); //dataSet.indexOf(record);
                return '<a href="javascript:fieldSDelFunction(\'' + field_name + '\')">删除</a>';
            }
            
            function fieldDelFun(value, record, name) {
                var dataSet = $('psr_report_fields_ds');
                var index = record.get('line_number'); //dataSet.indexOf(record);
                return '<a href="javascript:fieldDelFunction(' + index + ')">删除</a>';
            }
            
            function fieldDelFunction(index) {
                var dataSet = $('psr_report_fields_selection_ds');
                var ds2 = $('psr_styles_ds');
            
                var record = dataSet.find('line_number', index); //getAt(index);
                var record2 = ds2.find('line_number', index);
            
                dataSet.remove(record);
                ds2.remove(record2);
            
            }
            
            //字段删除
            
            function fieldSDelFunction(field_name) {
                var dataSet_s = $('psr_report_fields_selection_ds');
                var dataSet = $('psr_report_fields_ds');
                var record = dataSet_s.find('field_name', field_name); //getAt(index);
                var report_field_id = record.get('report_field_id');
                dataSet_s.remove(record);
                if (report_field_id) {
                    dataSet.remove(dataSet.find('report_field_id', record.get('report_field_id')));
                } else {
                    dataSet.remove(dataSet_s.find('report_fields_dis', record.get('report_fields_dis')));
                }
            }
            
            function fieldsDisFun(value, record, name) {
                return record.get('field_name');
            }
            
            //添加表达式
            
            function addExpression() {
                new Aurora.Window({
                    id: 'report_add_expression_win',
                    closeable: false,
                    url: $('psr_report_add_expression').getUrl(),
                    title: '添加表达式',
                    height: 300,
                    width: 480
                });
            }
            
            //新增条件  编辑
            
            function conditionsEditorFun(value, record, name) {
                var editor_flag = record.get('editor_flag');
                if (editor_flag == 'N') {
                    return '';
                }
                var dataSet = $('psr_report_conditions_ds');
                var index = record.get('line_number'); //dataSet.indexOf(record);
                return '<a href="javascript:conditionsEditorFunction(' + index + ')">编辑</a>';
            }
            
            function conditionsEditorFunction(index) {
                var head_record = $('psr_report_headers_ds').getCurrentRecord();
                new Aurora.Window({
                    id: 'report_add_condition_win',
                    closeable: false,
                    url: $('psr_report_add_condition').getUrl(),
                    params: {
                        layout_code: head_record.get('layout_code'),
                        index: index
                    },
                    title: '添加标准',
                    height: 350,
                    width: 480
                });
            }
            
            //新增条件  删除
            
            function conditionsDelFun(value, record, name) {
                var editor_flag = record.get('editor_flag');
                if (editor_flag == 'N') {
                    return '';
                }
                var dataSet = $('psr_report_conditions_ds');
                var index = record.get('line_number');
                return '<a href="javascript:conditionsDelFunction(' + index + ')">删除</a>';
            }
            
            function conditionsDelFunction(index) {
                var dataSet = $('psr_report_conditions_ds');
                var record = dataSet.find('line_number', index); //getAt(index);
                dataSet.remove(record);
            }
            
            //新增条件  添加
            
            function addConditionFun() {
                var record = $('psr_report_headers_ds').getCurrentRecord();
                var layout_code = record.get('layout_code');
                new Aurora.Window({
                    id: 'report_add_condition_win',
                    closeable: false,
                    url: $('psr_report_add_condition').getUrl(),
                    params: {
                        layout_code: layout_code
                    },
                    title: '添加条件',
                    height: 350,
                    width: 480
                });
            }
            
            //逻辑编辑
            
            function editorFun(record, name) {
                var editor_flag = record.get('editor_flag');
                if (editor_flag == 'N') {
                    return '';
                } else {
                    return 'comboBoxEditor';
                }
            
            }
            
            //记录
            
            function previewFun(value, record, name) {
                return '<a href="javascript:test1()" >预览</a>';
            }
            
            function runFun(value, record, name) {
                return '<a href="javascript:test1()" >运行</a>';
            }
            
            function test1() {
                Aurora.showMessage('提示', '开发中...');
            }
            
            function reportHeaderAddFun(dataSet, record, index) {
                setLineNumber(dataSet, record, index);
                record.set('report_creation_date', new Date());
            }
            
            function set_user_define_style(record, name, value) {
                if (name == 'report_type') {
                    var sql_statement_field = record.getField('sql_statement');
                    if (value == 'USERDEFINE_REPORT') {
                        sql_statement_field.setReadOnly(false);
                        sql_statement_field.setRequired(true);
                        Ext.get('userdefine_sql_id').setStyle('display', '');
                        Ext.get('ref_table_id').setStyle('display', 'none');
                        Ext.get('step_3').setStyle('display', 'none');
                        Ext.get('step_4').setStyle('display', 'none');
                        $('selectTableFun_id').setVisible(false);
                        $('addFieldFun_id').setVisible(true);
                        $('clearFieldsFun_id').setVisible(true);
                    } else {
                        sql_statement_field.setReadOnly(true);
                        sql_statement_field.setRequired(false);
                        Ext.get('userdefine_sql_id').setStyle('display', 'none');
                        Ext.get('ref_table_id').setStyle('display', '');
                        Ext.get('step_3').setStyle('display', '');
                        Ext.get('step_4').setStyle('display', '');
                        $('selectTableFun_id').setVisible(true);
                        $('addFieldFun_id').setVisible(false);
                        $('clearFieldsFun_id').setVisible(true);
                    }
                }
            }
            
            //报表头数据更新
            
            function reportHeaderUpdateFun(ataSet, record, name, value, oldvalue) {
                if (name == 'fixed_time_flag') {
                    if (value == 'Y') {
                        record.getField('start_date').setReadOnly(false);
                        record.getField('start_date').setRequired(true);
            
                        record.getField('push_cycle_dis').setReadOnly(false);
                        record.getField('push_cycle_dis').setRequired(true);
                    } else {
                        record.getField('start_date').setReadOnly(true);
                        record.getField('start_date').setRequired(false);
            
                        record.getField('push_cycle_dis').setReadOnly(true);
                        record.getField('push_cycle_dis').setRequired(false);
                    }
                } else if (name == 'other_report_flag') {
                    if (value == 'Y') {
                        record.getField('other_report_header_name').setReadOnly(false);
                        record.getField('other_report_header_name').setRequired(true);
                    } else {
                        record.getField('other_report_header_name').setReadOnly(true);
                        record.getField('other_report_header_name').setRequired(false);
                    }
                } else if (name == 'layout_code') {
                    $('psr_report_layout_ds').setQueryParameter('layout_code', value);
                    $('psr_report_layout_ds').query();
                } else if (name == 'report_type') {
                    set_user_define_style(record, name, value);
                }
            }
            
            
            
            function reportHeaderLoadFun(dataSet) {
                function isExitsFunction(funcName) {
                    if (typeof(funcName) == "function") {
                        return true;
                    } else {
                        return false;
                    }
                }
                // if (isExitsFunction(nodeDetailTempUnLockScreen)) {
                // nodeDetailTempUnLockScreen();
                // }
                var record = dataSet.getAt(0);
                // set_user_define_style(record, 'report_type', record.get('report_type'));
                var other_report_flag = record.get('other_report_flag');
                if (other_report_flag == 'Y') {
                    record.getField('other_report_header_name').setReadOnly(false);
                    record.getField('other_report_header_name').setRequired(true);
                }
            
                var fixed_time_flag = record.get('fixed_time_flag');
                if (fixed_time_flag == 'Y') {
                    record.getField('start_date').setReadOnly(false);
                    record.getField('start_date').setRequired(true);
            
                    record.getField('push_cycle_dis').setReadOnly(false);
                    record.getField('push_cycle_dis').setRequired(true);
                }
            }
            
            // Aurora.onReady(function() {
            // var record = $('psr_report_headers_ds').getCurrentRecord();
            // set_user_define_style(record, 'report_type', record.get('report_type'));
            // });
            
            //报表头编辑
            
            
            function reportHeaderEditorFun(value, record, name) {
                return '<a href="javascript:reportHeaderEditorFunction()" >编辑</a>';
            }
            
            function reportHeaderEditorFunction() {
                var stepTabPanel = $('step');
                step = step;
                stepTabPanel.setDisabled(step);
                stepTabPanel.setEnabled(0);
                stepTabPanel.selectTab(0);
                step = 0;
            }
            
            //添加分组
            
            
            function addGroupFun() {
                //必须指定统计列
                var fieldDataSet = $('psr_report_fields_ds');
                var records = fieldDataSet.getAll();
                var flag = false;
                for (var i = 0;i < records.length;i++) {
                    var record = records[i];
                    var subtotal_type = typeof(record.get('subtotal_type')) == 'undefined' ? 0 : record.get('subtotal_type');
                    if (subtotal_type != 0 || subtotal_type != 'NULL') {
                        flag = true;
                        break;
                    }
                }
            
                if (flag) {
                    var dataSet = $('psr_report_groups_ds');
                    dataSet.create();
                } else {
                    Aurora.showMessage('提示', '请选择需要统计的列！');
                }
            }
            //添加分组
            
            
            function addOrderFun() {
                var dataSet = $('psr_report_orders_ds');
                dataSet.create();
            }
            
            function groupDelFun(value, record, name) {
                var dataSet = $('psr_report_groups_ds');
                var index = record.get('line_number'); //dataSet.indexOf(record);
                return '<a href="javascript:delFunction(' + index + ',\'psr_report_groups_ds\')">删除</a>';
            }
            
            function orderDelFun(value, record, name) {
                var dataSet = $('psr_report_orders_ds');
                var index = record.get('line_number'); //dataSet.indexOf(record);
                return '<a href="javascript:delFunction(' + index + ',\'psr_report_orders_ds\')">删除</a>';
            }
            //清空显示字段
            
            function clearFieldsFun() {
                Aurora.showConfirm('提示', '确定清空？', function okFun() {
                    var dataSet = $('psr_report_fields_selection_ds');
                    var records = dataSet.getAll();
                    for (var i = 0;i < records.length;i++) {
                        if (records[i].get('report_field_id')) {
                            record = $('psr_report_fields_ds').find('report_field_id', records[i].get('report_field_id'));
                        } else {
                            record = $('psr_report_fields_ds').find('report_fields_dis', records[i].get('report_fields_dis'));
                        }
                        $('psr_report_fields_ds').remove(record);
                    }
                    var headers_ds = $('psr_report_headers_ds');
                    var headerRecord = headers_ds.getAt(0);
                    headerRecord.set('sql_statement', '');
                    $('psr_report_groups_ds').removeAll();
                    $('psr_report_orders_ds').removeAll();
                    dataSet.removeAll();
                });
            }
            
            function addFieldFun() {
                $('psr_report_fields_selection_grid_id').showEditorByRecord($('psr_report_fields_selection_ds').create());
            }
            
            
            function on_psr_report_fields_selection_ds_update(ds, record, name, value, old_value) {
                var report_fields_ds = $('psr_report_fields_ds');
                var style_ds = $('psr_styles_ds');
                var current_report_field_record = report_fields_ds.find('line_number', record.get('line_number'));
                var current_style_record = style_ds.find('line_number', record.get('line_number'));
                if (name == 'report_fields_dis') {
                    record.set('field_name', value);
                }
                if (name == 'field_description') {
                    record.set('field_description_dis', value);
                }
                if (current_report_field_record) {
                    current_report_field_record.set(name, value);
                }
                if (current_style_record) {
                    current_style_record.set(name, value);
                }
            }
            
            function set_record_data() {
                for (var name in record.data) {
                    report_fields_record.set(name, record.get(name));
                }
            }
            
            function on_psr_report_fields_selection_ds_add(ds, record, index) {
                setLineNumber(ds, record, index);
                record.set('field_category', 'FIELD');
                record.set('field_category_dis', '字段');
                var report_fields_ds = $('psr_report_fields_ds');
                var style_ds = $('psr_styles_ds');
                report_fields_ds.create(Ext.apply({}, record.data));
                style_ds.create(Ext.apply({}, record.data));
            }
            
            //选择基表
            
            function selectTableFun() {
                new Aurora.Window({
                    id: 'psr_report_table_selection_win',
                    url: $('psr_report_table_selection_link').getUrl(),
                    title: '选择基表',
                    height: 480,
                    width: 510
                });
            }
            
            //报表关联
            
            function reportHeadersRelation() {
                var dataSet = $('psr_report_headers_relation_ds');
                dataSet.create();
            }
            
            function formatDate(value, record, name) {
                return Aurora.formatDate(value, record, name).substr(0, 10);
            }
            
            function goQueryFun() {
                window.location.href = '${/request/@context_path}/modules/psr/PSR1020/psr_report_query.screen';
            }
            
            
            //字段变更
            
            
            function fieldUpdateFun(ataSet, record, name, value, oldvalue) {
                if (name == 'line_number') {
                    var groupDataSet = $('psr_report_groups_ds');
                    var groupRecords = groupDataSet.getAll();
                    if (groupRecords.length > 0) {
                        var gRecord = groupDataSet.find('field_name', record.get('field_name'));
                        if (gRecord === null) {
            
                           } else {
                            var field_name = typeof(gRecord.get('field_name')) == 'undefined' ? 0 : gRecord.get('field_name');
                            if (field_name == record.get('field_name')) {
                                gRecord.set('field_line_number', value);
                            }
                        }
                    }
                }
            }
            
            //
            
            function fieldLoadFun(dataSet) {
                var groups_ds = $('psr_report_groups_ds');
                var orders_ds = $('psr_report_orders_ds');
                var headers_ds = $('psr_report_headers_ds');
                var record = headers_ds.getCurrentRecord();
                //var report_header_id = '${/parameter/@report_header_id}';
                var report_header_id = record.get('report_header_id');
                groups_ds.setQueryParameter('report_header_id', report_header_id);
                orders_ds.setQueryParameter('report_header_id', report_header_id);
            
                groups_ds.query();
                orders_ds.query();
            
            }
            
            //
            // function webTest(){
            
            // var data = {};
            // data['details'] = [];
            
            // for (var i = 0;i < 5;i++) {
            // var detailData = {
            // log_text: '数据：'+i
            // };
            // data['details'].push(detailData);
            // }
            // Aurora.request({
            // url: $('psr_report_test').getUrl(),
            // para: data,
            // success: function() {
            
            // }
            // });
            // }
            //预览
            
            function outputPreview_create(record_id) {
                var record = $('psr_report_headers_ds').getCurrentRecord();
                var report_header_id = record.get('report_header_id'),
                    layout_code = record.get('layout_code'),
                    width = record.get('width'),
                    height = record.get('height');
                var fullScreen = true;
                if (width && height) {
                    fullScreen = false;
                }
                if (layout_code) {
                    new Aurora.Window({
                        url: $('psr_report_parameter_preview_create_dynamic').getUrl(),
                        title: '选择预览参数',
                        params: {
                            winid: 'psr_report_parameter_preview_create_dynamic_winid',
                            report_header_id: report_header_id,
                            layout_code: layout_code,
                            create_flag: 'Y'
                        },
                        id: 'psr_report_parameter_preview_create_dynamic_winid',
                        fullScreen: fullScreen,
                        width: width,
                        height: height,
                        draggable: true
                    });
                } else {
                    finnal_outputpreview_create({
                        report_header_id: report_header_id
                    });
                }
            }
            
            function finnal_outputpreview_create(params) {
                params['winid'] = 'psr_report_preview_create_screen';
                new Aurora.Window({
                    url: $('psr_report_preview_create_link').getUrl(),
                    params: params,
                    id: 'psr_report_preview_create_screen',
                    fullScreen: true
                });
            }
            
            function synchronization_ajax_download_deal_create(report_id, path, name) {
                var file_path = path;
                var file_name_desc = name;
                file_path = file_path.replace(/\\/g, '/');
                var index = file_path.lastIndexOf('/');
                index = index + 1;
                var fileName = file_path.substring(index);
                if (!file_name_desc) {
                    file_name_desc = fileName;
                }
                var download_url = '${/request/@context_path}/task_report/download?report_id=' + report_id + '&fileName=' + fileName + '&fileNameDesc=' + file_name_desc;
                Aurora.post(download_url);
            }
            
            function synchronization_ajax_report_create(params) {
                if (params['synchronization_flag'] == 'Y') {
                    if (params['winid']) {
                        Aurora.Masker.mask($(params['winid']).wrap, '${l:HLS.EXECUTING}');
                    }
                    Ext.Ajax.request({
                        url: $('psr_report_output_create').getUrl(),
                        params: {
                            _request_data: Ext.util.JSON.encode({
                                parameter: params
                            })
                        },
                        success: function(res) {
                            var obj = eval('(' + res.responseText + ')');
                            synchronization_ajax_download_deal_create(obj.result.report_id, obj.result.file_path, obj.result.file_name);
                            if (params['winid']) {
                                Aurora.Masker.unmask($(params['winid']).wrap);
                            }
                        }
                    });
                } else {
                    Aurora.request({
                        url: $('psr_report_output_create').getUrl(),
                        para: params,
                        success: function(res) {
                            Aurora.showMessage('${l:HLS.PROMPT}', '文件生成中，请稍后查看任务列表');
                        },
                        scope: this
                    });
                }
            }
            //运行
            
            function outputFun_create() {
                var record = $('psr_report_headers_ds').getCurrentRecord();
                var report_header_id = record.get('report_header_id'),
                    layout_code = record.get('layout_code'),
                    width = record.get('width'),
                    height = record.get('height'),
                    unsynchronization_flag = record.get('unsynchronization_flag'),
                    synchronization_flag;
                var fullScreen = true;
                if (width && height) {
                    fullScreen = false;
                }
                if (unsynchronization_flag == 'Y') {
                    synchronization_flag = 'N';
                } else {
                    synchronization_flag = 'Y';
                }
                if (layout_code) {
                    new Aurora.Window({
                        url: $('psr_report_parameter_create_dynamic').getUrl(),
                        title: '选择运行参数',
                        params: {
                            winid: 'psr_report_parameter_create_dynamic_winid',
                            report_header_id: report_header_id,
                            layout_code: layout_code,
                            synchronization_flag: synchronization_flag,
                            function_code: 'PSR1020',
                            create_flag: 'Y'
                        },
                        id: 'psr_report_parameter_create_dynamic_winid',
                        fullScreen: fullScreen,
                        width: width,
                        height: height,
                        draggable: true
                    });
                } else {
                    synchronization_ajax_report_create({
                        report_header_id: report_header_id,
                        layout_code: layout_code,
                        synchronization_flag: synchronization_flag
                    });
                }
            }
            
            function Fields_afterremoveFun(ds) {
                var dataSet = $('psr_report_fields_selection_ds');
                var report_header_id = ds.getAt(0).get('report_header_id');
                dataSet.setQueryParameter('report_header_id', report_header_id);
                dataSet.setQueryParameter('field_category', 'FIELD');
                dataSet.query();
            }
            
            function headerRender(value, record, name) {
                if (value != null) {
                    return '已设置';
                } else {
                    return '';
                }
            }
            
            function cellRender(value, record, name) {
                if (value != null) {
                    return '已设置';
                } else {
                    return '';
                }
            }
            
            function setTitleBatch() {
                var records = $('psr_styles_ds').getSelected();
                if (!records.length) {
                    Aurora.showMessage('${l:HLS.PROMPT}', '请先选择批量设置的行！');
                    return;
                }
                new Aurora.Window({
                    id: 'titleStyle',
                    url: $('psr_report_field_style_link').getUrl(),
                    params: {
                        grid_id: '1',
                        batch_flag: 'Y',
                        winid: 'titleStyle'
                    },
                    title: '表头样式批量设置',
                    fullScreen:true
                });
            }
            
            function setCellBatch() {
                var records = $('psr_styles_ds').getSelected();
                if (!records.length) {
                    Aurora.showMessage('${l:HLS.PROMPT}', '请先选择批量设置的行！');
                    return;
                }
                new Aurora.Window({
                    id: 'titleStyle',
                    url: $('psr_report_field_style_link').getUrl(),
                    params: {
                        grid_id: '2',
                        batch_flag: 'Y',
                        winid: 'titleStyle'
                    },
                    title: '单元格样式批量设置',
                    fullScreen:true
                });
            }
            
            function fields_selection_grid_editorfunction(record, name) {
                var head_record = $('psr_report_headers_ds').getCurrentRecord();
                if (!head_record) {
                    return '';
                }
                if (head_record.get('report_type') == 'USERDEFINE_REPORT') {
                    if (name == 'field_type_dis') {
                        return 'fields_selection_grid_combobox_id';
                    } else if (name == 'report_fields_dis') {
                        return 'fields_selection_grid_textfield_upper_id';
                    } else {
                        return 'fields_selection_grid_textfield_id';
                    }
                } else {
                    return '';
                }
            }
            
            function on_tabpannel_select(tab, index) {
                step = index;
            }
            
            function layout_parameter_right() {
                var psr_report_layout_ds = $('psr_report_layout_ds'),
                    psr_report_layout_select_ds = $('psr_report_layout_select_ds');
                var records = psr_report_layout_ds.getSelected();
                if (records.length > 0) {
                    for (var i = 0;i < records.length;i++) {
                        var record = records[i];
                        var select_record = psr_report_layout_select_ds.find('column_name', record.get('column_name'));
                        if (!select_record) {
                            psr_report_layout_ds.removeLocal(record);
                            psr_report_layout_select_ds.create(Ext.apply({}, record.data));
                            i = i - 1;
                        }
                    }
                } else {
                    return;
                }
            }
            
            function layout_parameter_left() {
                var psr_report_layout_ds = $('psr_report_layout_ds'),
                    psr_report_layout_select_ds = $('psr_report_layout_select_ds');
                var records = psr_report_layout_select_ds.getSelected();
                if (records.length > 0) {
                    for (var i = 0;i < records.length;i++) {
                        var record = records[i];
                        var select_record = psr_report_layout_ds.find('column_name', record.get('column_name'));
                        if (!select_record) {
                            psr_report_layout_ds.create(Ext.apply({}, record.data));
                            psr_report_layout_select_ds.removeLocal(record);
                            i = i - 1;
                        }
                    }
                } else {
                    return;
                }
            }
            
            function aut_trx_report_record(record) {
                var header_record = $('psr_report_headers_ds').getCurrentRecord();
                if (header_record) {
                    record.set('trx_id', header_record.get('report_header_id'));
                    record.set('trx_category', 'CONFIG_REPORT');
                    record.set('trx_number', header_record.get('report_header_name'));
                    record.set('trx_name', header_record.get('report_header_description'));
                }
            }
            
            function aut_trx_user_report_ds_add(ds, record, index) {
                aut_trx_report_record(record);
            }
            
            function aut_trx_user_report_ds_load(ds) {
                // var records = ds.getAll();
                // for (var i = 0;i < records.length;i++) {
                // var record = records[i];
                // aut_trx_report_record(record);
                // }
            }
            
            function psr1010lovFunction(record, name) {
                if (record.isNew) {
                    return 'psr1010_grid_lov';
                } else {
                    return '';
                }
            }
            
            function aut_trx_user_report_ds_query(ds, qpara) {
                var header_record = $('psr_report_headers_ds').getCurrentRecord();
                if (header_record) {
                    qpara['report_header_id'] = header_record.get('report_header_id');
                }
            }
        ]]></script>
        <a:dataSets>
            <a:dataSet id="leftBracket_ds">
                <a:datas>
                    <a:record code_value=" " code_value_name=" "/>
                    <a:record code_value="(" code_value_name="("/>
                </a:datas>
            </a:dataSet>
            <a:dataSet id="rightBracket_ds">
                <a:datas>
                    <a:record code_value=" " code_value_name=" "/>
                    <a:record code_value=")" code_value_name=")"/>
                </a:datas>
            </a:dataSet>
            <a:dataSet id="psr_view_range_code_ds" lookupCode="PSR_VIEW_RANGE_CODE"/>
            <a:dataSet id="psr_report_type_code_ds" lookupCode="PSR_REPORT_TYPE_CODE"/>
            <a:dataSet id="psr_field_type_code_ds" lookupCode="PSR_FIELD_TYPE_CODE"/>
            <a:dataSet id="psr_condition_type_code_ds" lookupCode="PSR_CONDITION_TYPE_CODE"/>
            <a:dataSet id="psr_field_1_category_code_ds" lookupCode="PSR_FIELD_1_CATEGORY_CODE"/>
            <a:dataSet id="psr_field_2_category_code_ds" lookupCode="PSR_FIELD_2_CATEGORY_CODE"/>
            <a:dataSet id="psr_logic_code_ds" lookupCode="PSR_LOGIC_CODE"/>
            <a:dataSet id="psr_parenthesis_code_ds" lookupCode="PSR_PARENTHESIS_CODE"/>
            <a:dataSet id="psr_field_category_code_ds" lookupCode="PSR_FIELD_CATEGORY_CODE"/>
            <a:dataSet id="psr_table_join_code_ds" lookupCode="PSR_TABLE_JOIN_CODE"/>
            <a:dataSet id="psr_field_order_code_ds" lookupCode="PSR_FIELD_ORDER_CODE"/>
            <a:dataSet id="psr_report_push_cycle_code_ds" lookupCode="PSR_REPORT_PUSH_CYCLE_CODE"/>
            <a:dataSet id="psr_subtotal_type_code_ds" lookupCode="PSR_SUBTOTAL_TYPE_CODE"/>
            <a:dataSet id="psr_statistics_type_code_ds" lookupCode="PSR_STATISTICS_TYPE_CODE"/>
            <a:dataSet id="report_list_ds" model="psr.PSR1010.psr_report_headers" queryUrl="${/request/@context_path}/autocrud/psr.PSR1010.psr_report_headers/query?report_type=&apos;CONDITION_REPORT&apos;"/>
            <a:dataSet id="psr_report_headers_ds" loadData="true" model="psr.PSR1010.psr_report_headers">
                <a:fields>
                    <a:field name="report_header_name" defaultValue="新建未保存报表" required="true"/>
                    <a:field name="report_header_description" defaultValue="新建未保存报表" required="true"/>
                    <a:field name="view_range" defaultValue="PRIVATE"/>
                    <a:field name="view_range_dis" defaultValue="私有" displayField="code_value_name" options="psr_view_range_code_ds" required="true" returnField="view_range" valueField="code_value"/>
                    <a:field name="report_type_dis" displayField="code_value_name" options="psr_report_type_code_ds" required="true" returnField="report_type" valueField="code_value"/>
                    <a:field name="fixed_time_flag" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
                    <a:field name="unsynchronization_flag" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
                    <a:field name="other_report_flag" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
                    <a:field name="other_report_header_name" displayField="report_header_name" options="report_list_ds" returnField="other_report_header_id" valueField="report_header_name">
                        <a:mapping>
                            <a:map from="report_header_id" to="other_report_header_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="push_cycle_dis" displayField="code_value_name" options="psr_report_push_cycle_code_ds" returnField="push_cycle" valueField="code_value"/>
                    <a:field name="sql_statement" readOnly="true"/>
                    <a:field name="layout_code"/>
                    <a:field name="layout_code_desc" autoComplete="true" autoCompleteField="layout_code" lovGridHeight="300" lovHeight="460" lovLabelWidth="100" lovService="psr.PSR1010.psr_report_layout_query" lovWidth="530" prompt="参数描述" title="参数描述">
                        <a:mapping>
                            <a:map from="layout_code" to="layout_code"/>
                            <a:map from="description" to="layout_code_desc"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="validation_sql"/>
                </a:fields>
                <a:events>
                    <a:event name="add" handler="reportHeaderAddFun"/>
                    <a:event name="update" handler="reportHeaderUpdateFun"/>
                    <a:event name="load" handler="reportHeaderLoadFun"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="psr_report_tables_ds" fetchAll="true" model="psr.PSR1010.psr_report_tables">
                <a:fields>
                    <a:field name="table_name"/>
                    <a:field name="table_description"/>
                    <a:field name="table_alias"/>
                </a:fields>
                <a:events>
                    <a:event name="add" handler="setLineNumber"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="tmp_ds">
                <a:datas dataSource="/model/fields"/>
            </a:dataSet>
            <a:dataSet id="psr_styles_ds" selectable="true">
                <a:fields>
                    <a:field name="header_style_name" lovAutoQuery="true" lovGridHeight="290" lovHeight="510" lovUrl="${/request/@context_path}/modules/psr/PSR1010/psr_report_field_style.screen?grid_id=1" lovWidth="700" prompt="表头样式" title="表头样式">
                        <a:mapping>
                            <a:map from="header_style" to="header_style"/>
                            <a:map from="header_style_name" to="header_style_name"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="header_style"/>
                    <a:field name="cell_style_name" lovAutoQuery="true" lovGridHeight="290" lovHeight="510" lovUrl="${/request/@context_path}/modules/psr/PSR1010/psr_report_field_style.screen?grid_id=2" lovWidth="700" prompt="单元格样式" title="单元格样式">
                        <a:mapping>
                            <a:map from="cell_style" to="cell_style"/>
                            <a:map from="cell_style_name" to="cell_style_name"/>
                        </a:mapping>
                    </a:field>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="psr_report_fields_ds" fetchAll="true" model="psr.PSR1010.psr_report_fields">
                <a:fields>
                    <a:field name="number_allowformat" checkedValue="Y" defaultValue="Y" uncheckedValue="N"/>
                    <a:field name="field_category_dis" displayField="code_value_name" options="psr_field_category_code_ds" returnField="field_category" valueField="code_value"/>
                    <a:field name="field_type_dis" displayField="code_value_name" options="psr_field_type_code_ds" required="true" returnField="field_type" valueField="code_value"/>
                    <a:field name="subtotal_type_dis" displayField="code_value_name" options="psr_subtotal_type_code_ds" required="true" returnField="subtotal_type" valueField="code_value"/>
                    <a:field name="statistics_type_dis" displayField="code_value_name" options="psr_statistics_type_code_ds" required="true" returnField="statistics_type" valueField="code_value"/>
                </a:fields>
                <a:events>
                    <a:event name="add" handler="setLineNumber"/>
                    <a:event name="update" handler="fieldUpdateFun"/>
                    <a:event name="load" handler="fieldLoadFun"/>
                    <a:event name="afterremove" handler="Fields_afterremoveFun"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="psr_report_fields_selection_ds" fetchAll="true" model="psr.PSR1010.psr_report_fields">
                <a:fields>
                    <a:field name="field_category_dis" displayField="code_value_name" options="psr_field_category_code_ds" returnField="field_category" valueField="code_value"/>
                    <a:field name="field_type_dis" displayField="code_value_name" options="psr_field_type_code_ds" required="true" returnField="field_type" valueField="code_value"/>
                    <a:field name="statistics_type_dis" displayField="code_value_name" options="psr_statistics_type_code_ds" returnField="statistics_type" valueField="code_value"/>
                </a:fields>
                <a:events>
                    <a:event name="add" handler="on_psr_report_fields_selection_ds_add"/>
                    <a:event name="update" handler="on_psr_report_fields_selection_ds_update"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="psr_report_conditions_ds" fetchAll="true" model="psr.PSR1010.psr_report_conditions">
                <a:fields>
                    <a:field name="condition_type_dis" displayField="code_value_name" options="psr_condition_type_code_ds" returnField="condition_type" valueField="code_value"/>
                    <a:field name="logic_dis" displayField="code_value_name" options="psr_logic_code_ds" returnField="logic" valueField="code_value"/>
                    <a:field name="left_parenthesis_dis" displayField="code_value_name" options="leftBracket_ds" returnField="left_parenthesis" valueField="code_value"/>
                    <a:field name="right_parenthesis_dis" displayField="code_value_name" options="rightBracket_ds" returnField="right_parenthesis" valueField="code_value"/>
                    <a:field name="field_1_category_dis" displayField="code_value_name" options="psr_field_1_category_code_ds" required="true" returnField="field_1_category" valueField="code_value"/>
                    <a:field name="field_2_category_dis" displayField="code_value_name" options="psr_field_2_category_code_ds" required="true" returnField="field_2_category" valueField="code_value"/>
                </a:fields>
                <a:events>
                    <a:event name="add" handler="setLineNumber"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="psr_report_groups_ds" fetchAll="true" model="psr.PSR1010.psr_report_groups">
                <a:fields>
                    <a:field name="field_name" displayField="field_name" options="psr_report_fields_ds" required="true" returnField="field_name" valueField="field_name">
                        <a:mapping>
                            <a:map from="table_name" to="table_name"/>
                            <a:map from="line_number" to="field_line_number"/>
                        </a:mapping>
                    </a:field>
                </a:fields>
                <a:events>
                    <a:event name="add" handler="report_groups_setLineNumber"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="psr_report_orders_ds" fetchAll="true" model="psr.PSR1010.psr_report_orders">
                <a:fields>
                    <a:field name="field_name" displayField="field_name" options="psr_report_fields_ds" required="true" returnField="field_name" valueField="field_name">
                        <a:mapping>
                            <a:map from="table_name" to="table_name"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="order_code" defaultValue="ASC"/>
                    <a:field name="order_code_dis" defaultValue="升序" displayField="code_value_name" options="psr_field_order_code_ds" required="true" returnField="order_code" valueField="code_value"/>
                </a:fields>
                <a:events>
                    <a:event name="add" handler="setLineNumber"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="psr_report_del_ds"/>
            <a:dataSet id="psr_report_layout_ds" pageSize="1000" selectable="true">
                <a:datas dataSource="/model/category_parameter_path"/>
            </a:dataSet>
            <a:dataSet id="psr_report_layout_select_ds" pageSize="1000" selectable="true">
                <a:datas dataSource="/model/select_parameter_path"/>
            </a:dataSet>
            <a:dataSet id="aut_trx_user_report_ds" autoPageSize="true" autoQuery="true" model="aut.AUT103.aut_trx_user_authorize" queryUrl="${/request/@context_path}/autocrud/psr.PSR1010.aut_trx_user_report_query/query" selectable="true">
                <a:fields>
                    <a:field name="trx_category"/>
                    <a:field name="trx_category_desc"/>
                    <a:field name="trx_id"/>
                    <a:field name="trx_name"/>
                    <a:field name="trx_number"/>
                    <a:field name="user_id" required="true"/>
                    <a:field name="user_desc" autoComplete="true" lovGridHeight="350" lovHeight="550" lovService="basic.sys_user_for_lov" lovWidth="550" prompt="AUT_TRX_USER_AUTHORIZE.USER_ID" required="true" title="AUT_TRX_USER_AUTHORIZE.USER_ID">
                        <a:mapping>
                            <a:map from="description" to="user_desc"/>
                            <a:map from="employee_name" to="user_employee_name"/>
                            <a:map from="user_id" to="user_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="user_employee_name"/>
                    <a:field name="start_date" defaultValue="${/model/default_value_path/record/@now_time}" required="true"/>
                    <a:field name="end_date" defaultValue="${/model/default_value_path/record/@never_date}"/>
                </a:fields>
                <a:events>
                    <a:event name="add" handler="aut_trx_user_report_ds_add"/>
                    <a:event name="query" handler="aut_trx_user_report_ds_query"/>
                </a:events>
            </a:dataSet>
        </a:dataSets>
        <a:screenBody>
            <!-- <a:fieldSet height="540" marginHeight="50" marginWidth="50" title="报表新建" width="900"/> -->
            <a:hBox>
                <a:tabPanel id="step" marginHeight="60" marginWidth="40">
                    <a:tabs>
                        <a:tab id="step_0" disabled="false" prompt="报表类型" selected="true" width="60">
                            <a:form column="1" marginWidth="60" style="margin-left:5px;margin-top:5px;" title="报表类型">
                                <a:hBox labelWidth="80">
                                    <a:label name="report_header_name" bindTarget="psr_report_headers_ds" prompt="报表名称" width="150"/>
                                    <a:label name="report_header_description" bindTarget="psr_report_headers_ds" prompt="描述" width="150"/>
                                </a:hBox>
                            </a:form>
                            <a:hBox style="margin-left:5px;margin-top:5px;">
                                <a:button click="cancelFun" text="取消"/>
                                <a:button click="step_0NextStep" text="下一步"/>
                            </a:hBox>
                            <a:fieldSet height="100" marginWidth="60" style="margin-left:5px;margin-top:5px;" title="报表类型" width="300">
                                <a:comboBox name="report_type_dis" bindTarget="psr_report_headers_ds" prompt="报表类型" width="200"/>
                            </a:fieldSet>
                        </a:tab>
                        <a:tab id="step_1" disabled="false" prompt="输入参数" width="60">
                            <a:form column="1" marginWidth="60" style="margin-left:5px;margin-top:5px;" title="报表类型">
                                <a:hBox labelWidth="80">
                                    <a:label name="report_header_name" bindTarget="psr_report_headers_ds" prompt="报表名称" width="150"/>
                                    <a:label name="report_header_description" bindTarget="psr_report_headers_ds" prompt="描述" width="150"/>
                                </a:hBox>
                            </a:form>
                            <a:hBox style="margin-left:5px;margin-top:5px;">
                                <a:button click="upStep" text="上一步"/>
                                <a:button click="nextStep" text="下一步"/>
                                <a:label width="50"/>
                                <!-- <a:button click="queryLayout" text="查询"/> -->
                            </a:hBox>
                            <a:form name="parmater_form" labelWidth="100" marginWidth="60" style="margin-left:5px;margin-top:5px;" title="具体参数">
                                <a:box column="3" width="812">
                                    <a:vBox>
                                        <div style="font-size:20px;"><![CDATA[参数库]]></div>
                                        <a:grid bindTarget="psr_report_layout_ds" marginHeight="380" navBar="true" width="400">
                                            <a:columns>
                                                <a:column name="column_name" prompt="参数代码" width="150"/>
                                                <a:column name="prompt" prompt="参数描述" width="200"/>
                                            </a:columns>
                                        </a:grid>
                                    </a:vBox>
                                    <a:vBox style="margin-top:100px;">
                                        <a:button click="layout_parameter_right" height="50" icon="${/request/@context_path}/images/arrow_right.png" width="80"/>
                                        <a:button click="layout_parameter_left" height="50" icon="${/request/@context_path}/images/arrow_left.png" width="80"/>
                                    </a:vBox>
                                    <a:vBox>
                                        <div style="font-size:20px;"><![CDATA[已选参数]]></div>
                                        <a:grid bindTarget="psr_report_layout_select_ds" marginHeight="380" navBar="true" width="400">
                                            <a:columns>
                                                <a:column name="column_name" prompt="参数代码" width="150"/>
                                                <a:column name="prompt" prompt="参数描述" width="200"/>
                                            </a:columns>
                                        </a:grid>
                                    </a:vBox>
                                </a:box>
                            </a:form>
                        </a:tab>
                        <a:tab id="step_2" disabled="false" prompt="数据来源" selected="false" width="60">
                            <a:form column="1" marginWidth="60" style="margin-left:5px;margin-top:5px;" title="数据来源">
                                <a:hBox labelWidth="80">
                                    <a:label name="report_header_name" bindTarget="psr_report_headers_ds" prompt="报表名称" width="150"/>
                                    <a:label name="report_header_description" bindTarget="psr_report_headers_ds" prompt="描述" width="150"/>
                                </a:hBox>
                            </a:form>
                            <a:hBox style="margin-left:5px;margin-top:5px;">
                                <a:button click="upStep" text="上一步"/>
                                <a:button click="step_1NextStep" text="下一步"/>
                                <a:label width="50"/>
                                <a:button id="selectTableFun_id" click="selectTableFun" style="display:none" text="选择基表"/>
                                <a:button id="clearFieldsFun_id" click="clearFieldsFun" style="display:none" text="清空字段"/>
                                <a:button id="addFieldFun_id" click="addFieldFun" style="display:none" text="新增字段"/>
                                <!-- <a:button click="webTest" text="测试"/> -->
                            </a:hBox>
                            <a:hBox style="margin-left:-5px;margin-top:5px;">
                                <a:fieldSet id="userdefine_sql_id" style="display:none;" title="自定义sql">
                                    <a:form column="1" labelSeparator=" ">
                                        <a:textArea name="sql_statement" bindTarget="psr_report_headers_ds" height="290" prompt=" " width="450"/>
                                    </a:form>
                                </a:fieldSet>
                                <a:fieldSet id="ref_table_id" style="display:none;" title="关联表">
                                    <a:grid bindTarget="psr_report_tables_ds" height="310" width="450">
                                        <a:columns>
                                            <!-- <a:column name="line_number" prompt="序号" align="center"  renderer="lineNumberFun" width="35"/> -->
                                            <a:column name="dis" align="center" prompt="表名-描述" renderer="tableNameFun" width="285"/>
                                            <a:column name="table_alias" align="center" prompt="别名" width="50"/>
                                            <a:column name="add" align="center" prompt="关联" renderer="addTableFun" width="50"/>
                                            <a:column name="del" align="center" prompt="删除" renderer="delTableFun" width="45"/>
                                        </a:columns>
                                    </a:grid>
                                </a:fieldSet>
                                <a:fieldSet title="显示字段">
                                    <a:grid id="psr_report_fields_selection_grid_id" bindTarget="psr_report_fields_selection_ds" height="310" width="550">
                                        <a:columns>
                                            <a:column name="line_number" align="center" prompt="序号" width="35"/>
                                            <a:column name="report_fields_dis" editorFunction="fields_selection_grid_editorfunction" prompt="字段" renderer="fieldsDisFun" width="100"/>
                                            <a:column name="field_type_dis" align="center" editorFunction="fields_selection_grid_editorfunction" prompt="字段类型" width="60"/>
                                            <a:column name="field_description" align="right" editorFunction="fields_selection_grid_editorfunction" prompt="描述" width="175"/>
                                            <a:column name="statistics_type_dis" align="center" editor="fields_selection_grid_combobox_id" prompt="统计类型" width="100"/>
                                            <a:column name="field_del" align="center" prompt="删除" renderer="fieldSDelFun" width="45"/>
                                        </a:columns>
                                        <a:editors>
                                            <a:textField id="fields_selection_grid_textfield_upper_id" typeCase="UPPER"/>
                                            <a:textField id="fields_selection_grid_textfield_id"/>
                                            <a:comboBox id="fields_selection_grid_combobox_id"/>
                                        </a:editors>
                                    </a:grid>
                                </a:fieldSet>
                            </a:hBox>
                        </a:tab>
                        <a:tab id="step_3" disabled="false" prompt="新增条件" tabStyle="display:none" width="60">
                            <a:form column="1" marginWidth="60" style="margin-left:5px;margin-top:5px;" title="新增条件">
                                <a:hBox labelWidth="80">
                                    <a:label name="report_header_name" bindTarget="psr_report_headers_ds" prompt="报表名称" width="150"/>
                                    <a:label name="report_header_description" bindTarget="psr_report_headers_ds" prompt="描述" width="150"/>
                                </a:hBox>
                            </a:form>
                            <a:hBox style="margin-left:5px;margin-top:5px;">
                                <a:button click="upStep" text="上一步"/>
                                <a:button click="step_3NextStep" text="下一步"/>
                                <a:label width="50"/>
                            </a:hBox>
                            <a:fieldSet marginWidth="60" style="margin-left:5px;margin-top:5px;" title="条件列表">
                                <a:hBox>
                                    <a:button click="addConditionFun" text="添加条件"/>
                                </a:hBox>
                                <a:table bindTarget="psr_report_conditions_ds" height="300" width="870">
                                    <a:columns>
                                        <a:column name="line_number" align="center" prompt="序号" width="35"/>
                                        <a:column name="logic_dis" align="center" editorFunction="editorFun" prompt="逻辑" width="120"/>
                                        <a:column name="left_parenthesis_dis" align="center" editorFunction="editorFun" prompt="左括号" width="60"/>
                                        <a:column name="field_1" align="center" prompt="表达式1" width="150"/>
                                        <a:column name="condition_type_dis" align="center" prompt="条件类型" width="60"/>
                                        <a:column name="field_2" align="center" prompt="表达式2" width="150"/>
                                        <a:column name="right_parenthesis_dis" align="center" editorFunction="editorFun" prompt="右括号" width="60"/>
                                        <a:column name="conditions_editor" align="center" prompt="编辑" renderer="conditionsEditorFun" width="60"/>
                                        <a:column name="conditions_del" align="center" prompt="删除" renderer="conditionsDelFun" width="60"/>
                                    </a:columns>
                                    <a:editors>
                                        <a:comboBox id="comboBoxEditor"/>
                                    </a:editors>
                                </a:table>
                            </a:fieldSet>
                        </a:tab>
                        <a:tab id="step_4" disabled="false" prompt="分组排序" tabStyle="display:none" width="60">
                            <a:form column="1" marginWidth="65" style="margin-left:5px;margin-top:5px;" title="分组排序">
                                <a:hBox labelWidth="80">
                                    <a:label name="report_header_name" bindTarget="psr_report_headers_ds" prompt="报表名称" width="150"/>
                                    <a:label name="report_header_description" bindTarget="psr_report_headers_ds" prompt="描述" width="150"/>
                                </a:hBox>
                            </a:form>
                            <a:hBox style="margin-left:5px;margin-top:5px;">
                                <a:button click="upStep" text="上一步"/>
                                <a:button click="step_4NextStep" text="下一步"/>
                                <a:label width="50"/>
                            </a:hBox>
                            <a:fieldSet marginWidth="60" style="margin-left:5px;margin-top:5px;" title="分组列表">
                                <a:hBox>
                                    <a:button click="addGroupFun" text="添加分组"/>
                                    <a:button click="groupUpFun" text="上移"/>
                                    <a:button click="groupDownFun" text="下移"/>
                                </a:hBox>
                                <a:table bindTarget="psr_report_groups_ds" height="300" marginWidth="60" width="870">
                                    <a:columns>
                                        <a:column name="line_number" align="center" prompt="序号" width="35"/>
                                        <a:column name="field_name" align="center" editor="groupComboBoxEditor" prompt="分组字段" width="120"/>
                                        <a:column name="group_description" align="center" editor="groupTextEditor" prompt="分组描述" width="120"/>
                                        <!-- <a:column name="field_seqencing" align="center" prompt="分组排序" renderer="groupSeqencingFun" width="120"/> -->
                                        <a:column name="group_del" align="center" prompt="删除" renderer="groupDelFun" width="120"/>
                                    </a:columns>
                                    <a:editors>
                                        <a:textField id="groupTextEditor"/>
                                        <a:comboBox id="groupComboBoxEditor"/>
                                    </a:editors>
                                </a:table>
                            </a:fieldSet>
                            <a:hBox height="50"/>
                            <a:fieldSet marginWidth="60" style="margin-left:5px;margin-top:5px;" title="排序列表">
                                <a:hBox>
                                    <a:button click="addOrderFun" text="添加排序"/>
                                    <a:button click="orderUpFun" text="上移"/>
                                    <a:button click="orderDownFun" text="下移"/>
                                </a:hBox>
                                <a:table bindTarget="psr_report_orders_ds" height="300" marginWidth="60" width="870">
                                    <!-- <a:toolBar >
                                    	<a:button type="add" />
                                    </a:toolBar> -->
                                    <a:columns>
                                        <a:column name="line_number" align="center" prompt="序号" width="35"/>
                                        <a:column name="field_name" align="center" editor="orderComboBoxEditor" prompt="排序字段" width="120"/>
                                        <a:column name="order_code_dis" align="center" editor="orderComboBoxEditor" prompt="排序方式" width="120"/>
                                        <!-- <a:column name="field_seqencing" align="center" prompt="排序" renderer="orderSeqencingFun" width="120"/> -->
                                        <a:column name="order_del" align="center" prompt="删除" renderer="orderDelFun" width="120"/>
                                    </a:columns>
                                    <a:editors>
                                        <a:comboBox id="orderComboBoxEditor"/>
                                    </a:editors>
                                </a:table>
                            </a:fieldSet>
                        </a:tab>
                        <a:tab id="step_5" disabled="false" prompt="输出样式" width="60">
                            <a:form column="1" marginWidth="65" style="margin-left:5px;margin-top:5px;" title="输出样式">
                                <a:hBox labelWidth="80">
                                    <a:label name="report_header_name" bindTarget="psr_report_headers_ds" prompt="报表名称" width="150"/>
                                    <a:label name="report_header_description" bindTarget="psr_report_headers_ds" prompt="描述" width="150"/>
                                </a:hBox>
                            </a:form>
                            <a:hBox style="margin-left:5px;margin-top:5px;">
                                <a:button click="step_5UpStep" text="上一步"/>
                                <a:button click="nextStep" text="下一步"/>
                                <a:label width="50"/>
                            </a:hBox>
                            <a:fieldSet style="margin-left:5px;margin-top:5px;" title="字段列表">
                                <!-- <a:hBox>
                                    <a:button click="addExpression" text="添加表达式"/>
                                    <a:button click="fieldUpFun" text="上移"/>
                                    <a:button click="fieldDownFun" text="下移"/>
                                </a:hBox> -->
                                <a:hBox>
                                    <a:button click="setTitleBatch" text="批量设置表头样式"/>
                                    <a:button click="setCellBatch" text="批量设置单元格样式"/>
                                </a:hBox>
                                <a:table id="psr_styles_table_id" bindTarget="psr_styles_ds" height="300" marginWidth="60" width="870">
                                    <!--  <a:columns>
                                        <a:column name="line_number" align="center" prompt="序号" width="35"/>
                                        <a:column name="field_name" align="center" prompt="字段" width="120"/>
                                        <a:column name="field_description" align="center" prompt="字段描述" width="120"/>
                                        <a:column name="field_description_dis" align="center" prompt="显示描述" width="120"/>
                                        <a:column name="field_type" align="center" prompt="数据类型" width="120"/>
                                        <a:column name="field_category_dis" align="center" prompt="字段类别" width="120"/>
                                        <a:column name="field_editor" align="center" prompt="编辑" renderer="fieldEditorFun" width="60"/>
                                        <a:column name="number_allowformat" editor="report_fields_chk" prompt="是否千分位" width="70"/>
                                        <a:column name="header_style" editor="psr_sheet_lov" renderer="headerRender" width="80"/>
                                        <a:column name="field_del" align="center" prompt="删除" renderer="fieldDelFun" width="60"/>
                                    </a:columns> -->
                                    <a:columns>
                                        <a:column name="line_number" align="center" prompt="序号" width="35"/>
                                        <a:column name="field_name" align="center" prompt="字段" width="120"/>
                                        <a:column name="field_description" align="center" prompt="字段描述" width="120"/>
                                        <a:column name="field_type" align="center" prompt="数据类型" width="120"/>
                                        <a:column name="header_style_name" editor="psr_sheet_lov" width="80"/>
                                        <a:column name="cell_style_name" editor="psr_sheet_lov" width="80"/>
                                        <a:column name="field_del" align="center" prompt="删除" renderer="fieldDelFun" width="60"/>
                                    </a:columns>
                                    <a:editors>
                                        <a:checkBox id="report_fields_chk"/>
                                        <a:lov id="psr_sheet_lov"/>
                                    </a:editors>
                                </a:table>
                            </a:fieldSet>
                        </a:tab>
                        <a:tab id="step_6" disabled="false" prompt="报表授权" width="60">
                            <a:form column="1" marginWidth="65" style="margin-left:5px;margin-top:5px;" title="报表类型">
                                <a:hBox labelWidth="80">
                                    <a:label name="report_header_name" bindTarget="psr_report_headers_ds" prompt="报表名称" width="150"/>
                                    <a:label name="report_header_description" bindTarget="psr_report_headers_ds" prompt="描述" width="150"/>
                                </a:hBox>
                            </a:form>
                            <a:hBox style="margin-left:5px;margin-top:5px;">
                                <a:button click="upStep" text="上一步"/>
                                <a:button click="nextStep" text="下一步"/>
                            </a:hBox>
                            <a:grid id="aut_trx_user_report_grid" bindTarget="aut_trx_user_report_ds" marginHeight="290" marginWidth="57" navBar="true" style="margin-left:5px;margin-top:5px;">
                                <a:toolBar>
                                    <a:button type="add"/>
                                    <a:button type="delete"/>
                                </a:toolBar>
                                <a:columns>
                                    <!-- <a:column name="trx_category_desc" prompt="AUT103.TRX_CATEGORY" width="120"/> -->
                                    <a:column name="trx_number" prompt="数据编号" width="120"/>
                                    <a:column name="trx_name" prompt="名称" width="150"/>
                                    <a:column name="trx_id" align="center" prompt="数据ID" width="100"/>
                                    <a:column name="user_desc" editorFunction="psr1010lovFunction" prompt="授权用户" width="100"/>
                                    <a:column name="user_employee_name" prompt="姓名"/>
                                    <a:column name="start_date" editor="psr1010_datepicker_lov" prompt="起始日期" renderer="Aurora.formatDate"/>
                                    <a:column name="end_date" editor="psr1010_datepicker_lov" prompt="结束日期" renderer="Aurora.formatDate"/>
                                </a:columns>
                                <a:editors>
                                    <a:lov id="psr1010_grid_lov"/>
                                    <a:datePicker id="psr1010_datepicker_lov"/>
                                </a:editors>
                            </a:grid>
                        </a:tab>
                        <a:tab id="step_7" disabled="false" prompt="保存报表" width="60">
                            <a:form column="1" marginWidth="65" style="margin-left:5px;margin-top:5px;" title="保存报表">
                                <a:hBox labelWidth="80">
                                    <a:label name="report_header_name" bindTarget="psr_report_headers_ds" prompt="报表名称" width="150"/>
                                    <a:label name="report_header_description" bindTarget="psr_report_headers_ds" prompt="描述" width="150"/>
                                </a:hBox>
                            </a:form>
                            <a:hBox style="margin-left:5px;margin-top:5px;">
                                <a:button click="upStep" text="上一步"/>
                                <a:button id="saveFun_id" click="saveFun" text="保存"/>
                                <a:label width="50"/>
                                <div id="other_button_id">
                                    <a:hBox>
                                        <a:button click="outputPreview_create" text="预览"/>
                                        <a:button click="outputFun_create" text="运行"/>
                                        <a:button click="goQueryFun" text="报表查询页"/>
                                    </a:hBox>
                                </div>
                            </a:hBox>
                            <a:hBox height="50"/>
                            <a:hBox style="margin-left:5px;margin-top:5px;">
                                <a:vBox labelWidth="150">
                                    <a:textField name="report_header_name" bindTarget="psr_report_headers_ds" prompt="报表名称" width="200"/>
                                    <a:textField name="report_header_description" bindTarget="psr_report_headers_ds" prompt="报表描述" width="200"/>
                                    <a:comboBox name="view_range_dis" bindTarget="psr_report_headers_ds" prompt="查看范围" width="200"/>
                                    <a:checkBox name="unsynchronization_flag" bindTarget="psr_report_headers_ds" prompt="后台运行"/>
                                    <a:checkBox name="fixed_time_flag" bindTarget="psr_report_headers_ds" prompt="是否定时"/>
                                    <a:comboBox name="push_cycle_dis" bindTarget="psr_report_headers_ds" prompt="推送周期" readOnly="true" width="200"/>
                                    <a:datePicker name="start_date" bindTarget="psr_report_headers_ds" prompt="开始日期" readOnly="true" width="200"/>
                                    <a:checkBox name="other_report_flag" bindTarget="psr_report_headers_ds" prompt="关联报表"/>
                                    <a:comboBox name="other_report_header_name" bindTarget="psr_report_headers_ds" prompt="条件报表" readOnly="true" width="200"/>
                                </a:vBox>
                                <a:vBox width="50"/>
                                <div id="sql_statement_id">
                                    <a:fieldSet title="SQL预览">
                                        <a:vBox labelWidth="150">
                                            <a:textArea name="sql_statement" bindTarget="psr_report_headers_ds" height="180" prompt="" width="300"/>
                                        </a:vBox>
                                    </a:fieldSet>
                                </div>
                            </a:hBox>
                        </a:tab>
                    </a:tabs>
                    <a:events>
                        <a:event name="select" handler="on_tabpannel_select"/>
                    </a:events>
                </a:tabPanel>
            </a:hBox>
        </a:screenBody>
        <script><![CDATA[
            //进入页面查询，锁屏
            
            function nodeDetailTempLockScreen() {
                Aurora.Masker.mask(Ext.getBody(), '正在加载..');
            }
            
            //进入页面查询，解锁
            
            function nodeDetailTempUnLockScreen() {
                Aurora.Masker.unmask(Ext.getBody());
            }
            
            
            function allQuery(report_header_id, success_flag) {
                var headers_ds = $('psr_report_headers_ds');
                var tables_ds = $('psr_report_tables_ds');
                var fields_ds = $('psr_report_fields_ds');
                var fields_selection_ds = $('psr_report_fields_selection_ds');
                var conditions_ds = $('psr_report_conditions_ds');
                // var groups_ds = $('psr_report_groups_ds');
                // var orders_ds = $('psr_report_orders_ds');
                var report_list_ds = $('report_list_ds');
                var style_ds = $('psr_styles_ds');
                var tmp_ds = $('tmp_ds');
                var records_line = tmp_ds.getAll();
            
                headers_ds.setQueryUrl('${/request/@context_path}/autocrud/psr.PSR1010.psr_report_headers_query/query');
            
                headers_ds.setQueryParameter('report_header_id', report_header_id);
                tables_ds.setQueryParameter('report_header_id', report_header_id);
                fields_ds.setQueryParameter('report_header_id', report_header_id);
                fields_selection_ds.setQueryParameter('report_header_id', report_header_id);
                fields_selection_ds.setQueryParameter('field_category', 'FIELD');
                conditions_ds.setQueryParameter('report_header_id', report_header_id);
                // groups_ds.setQueryParameter('report_header_id', report_header_id);
                // orders_ds.setQueryParameter('report_header_id', report_header_id);
                report_list_ds.setQueryParameter('report_type', 'CONDITION_REPORT');
                if (success_flag == 'Y') {
                    headers_ds.query();
                }
                tables_ds.query();
                fields_ds.query();
                fields_selection_ds.query();
                for (var k = 0;k < records_line.length;k++) {
                    style_ds.add(records_line[k]);
                }
                conditions_ds.query();
                // groups_ds.query();
                // orders_ds.query();
                report_list_ds.query();
            }
            
            function init() {
                nodeDetailTempLockScreen();
                document.getElementById("other_button_id").style.display = "none";
                document.getElementById("sql_statement_id").style.display = "none";
            
                var report_header_id = '${/parameter/@report_header_id}';
                //添加默认  表信息
                if (report_header_id) {
                    document.getElementById("other_button_id").style.display = "";
                    document.getElementById("sql_statement_id").style.display = "";
                    allQuery(report_header_id);
                } else {
                    var headers_ds = $('psr_report_headers_ds');
                    var headerRecord = new Aurora.Record({
                        report_header_name: '新建未保存报表',
                        report_header_description: '新建未保存报表',
                        view_range: 'PRIVATE',
                        view_range_dis: '私有'
                    });
            
                    // headers_ds.add(headerRecord);
                    //修改直接新增record逻辑，gaoyang
                    if (!headers_ds.getCurrentRecord()) {
                        headers_ds.add(headerRecord);
                    }
            
                    /* var dataSet = $('psr_report_tables_ds');
                     var record = new Aurora.Record({
                     table_name: '${/model/default_table/record/@table_name}',
                     table_description: '${/model/default_table/record/@table_description}',
                     table_alias: 'A',
                     default_table_flag: '${/model/default_table/record/@default_table_flag}'
                     });
                     dataSet.add(record); */
            
                    var report_list_ds = $('report_list_ds');
                    report_list_ds.setQueryParameter('report_type', 'CONDITION_REPORT');
                    report_list_ds.query();
            
                }
                nodeDetailTempUnLockScreen();
            }
            Aurora.onReady(init);
        ]]></script>
    </a:view>
</a:screen>
